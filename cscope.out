cscope 15 $HOME/github/skynet               0001236032
	@3rd/lpeg/lpcap.c

6 
	~"lua.h
"

7 
	~"Ïuxlib.h
"

9 
	~"Íÿp.h
"

10 
	~"Íty³s.h
"

13 
	#ÿ±y³
(
ÿp
è((ÿp)->
kšd
)

	)

15 
	#isşo£ÿp
(
ÿp
è(
	`ÿ±y³
(ÿpè=ğ
Cşo£
)

	)

17 
	#şo£addr
(
c
è((c)->
s
 + (c)->
siz
 - 1)

	)

19 
	#isfuÎÿp
(
ÿp
è((ÿp)->
siz
 !ğ0)

	)

21 
	#g‘äomkbË
(
cs
,
v
è
	`lua_¿wg‘i
((cs)->
L
, 
	`kbËidx
((cs)->
±İ
), v)

	)

23 
	#pushluav®
(
cs
è
	`g‘äomkbË
(cs, (cs)->
ÿp
->
idx
)

	)

31 
	$upd©eÿche
 (
C­S‹
 *
cs
, 
v
) {

32 
idx
 = 
cs
->
±İ
 + 1;

33 ià(
v
 !ğ
cs
->
v®ueÿched
) {

34 
	`g‘äomkbË
(
cs
, 
v
);

35 
	`lua_»¶aû
(
cs
->
L
, 
idx
);

36 
cs
->
v®ueÿched
 = 
v
;

38  
idx
;

39 
	}
}

42 
pushÿ±u»
 (
C­S‹
 *
cs
);

49 
C­tu»
 *
	$fšdİ’
 (
C­tu»
 *
ÿp
) {

50 
n
 = 0;

52 
ÿp
--;

53 ià(
	`isşo£ÿp
(
ÿp
)è
n
++;

54 ià(!
	`isfuÎÿp
(
ÿp
))

55 ià(
n
-- =ğ0è 
ÿp
;

57 
	}
}

63 
	$Ãxtÿp
 (
C­S‹
 *
cs
) {

64 
C­tu»
 *
ÿp
 = 
cs
->cap;

65 ià(!
	`isfuÎÿp
(
ÿp
)) {

66 
n
 = 0;

68 
ÿp
++;

69 ià(
	`isşo£ÿp
(
ÿp
)) {

70 ià(
n
-- == 0) ;

72 ià(!
	`isfuÎÿp
(
ÿp
)è
n
++;

75 
cs
->
ÿp
 = cap + 1;

76 
	}
}

86 
	$pushÃ¡edv®ues
 (
C­S‹
 *
cs
, 
addexŒa
) {

87 
C­tu»
 *
co
 = 
cs
->
ÿp
;

88 ià(
	`isfuÎÿp
(
cs
->
ÿp
++)) {

89 
	`lua_pushl¡ršg
(
cs
->
L
, 
co
->
s
, co->
siz
 - 1);

93 
n
 = 0;

94 !
	`isşo£ÿp
(
cs
->
ÿp
))

95 
n
 +ğ
	`pushÿ±u»
(
cs
);

96 ià(
addexŒa
 || 
n
 == 0) {

97 
	`lua_pushl¡ršg
(
cs
->
L
, 
co
->
s
, cs->
ÿp
->s - co->s);

98 
n
++;

100 
cs
->
ÿp
++;

101  
n
;

103 
	}
}

109 
	$pushÚ’e¡edv®ue
 (
C­S‹
 *
cs
) {

110 
n
 = 
	`pushÃ¡edv®ues
(
cs
, 0);

111 ià(
n
 > 1)

112 
	`lua_pİ
(
cs
->
L
, 
n
 - 1);

113 
	}
}

120 
C­tu»
 *
	$fšdback
 (
C­S‹
 *
cs
, 
C­tu»
 *
ÿp
) {

121 
lua_S‹
 *
L
 = 
cs
->L;

122 
ÿp
-- > 
cs
->
oÿp
) {

123 ià(
	`isşo£ÿp
(
ÿp
))

124 
ÿp
 = 
	`fšdİ’
(cap);

125 ià(!
	`isfuÎÿp
(
ÿp
))

127 ià(
	`ÿ±y³
(
ÿp
è=ğ
Cgroup
) {

128 
	`g‘äomkbË
(
cs
, 
ÿp
->
idx
);

129 ià(
	`Í_equ®
(
L
, -2, -1)) {

130 
	`lua_pİ
(
L
, 2);

131  
ÿp
;

133 
	`lua_pİ
(
L
, 1);

136 
	`luaL_”rÜ
(
L
, "back„eã»nû '%s'‚Ù found", 
	`lua_to¡ršg
(L, -1));

137  
NULL
;

138 
	}
}

144 
	$back»fÿp
 (
C­S‹
 *
cs
) {

145 
n
;

146 
C­tu»
 *
cu¼
 = 
cs
->
ÿp
;

147 
	`pushluav®
(
cs
);

148 
cs
->
ÿp
 = 
	`fšdback
(cs, 
cu¼
);

149 
n
 = 
	`pushÃ¡edv®ues
(
cs
, 0);

150 
cs
->
ÿp
 = 
cu¼
 + 1;

151  
n
;

152 
	}
}

159 
	$bËÿp
 (
C­S‹
 *
cs
) {

160 
lua_S‹
 *
L
 = 
cs
->L;

161 
n
 = 0;

162 
	`lua_ÃwbË
(
L
);

163 ià(
	`isfuÎÿp
(
cs
->
ÿp
++))

165 !
	`isşo£ÿp
(
cs
->
ÿp
)) {

166 ià(
	`ÿ±y³
(
cs
->
ÿp
è=ğ
Cgroup
 && cs->ÿp->
idx
 != 0) {

167 
	`pushluav®
(
cs
);

168 
	`pushÚ’e¡edv®ue
(
cs
);

169 
	`lua_£‰abË
(
L
, -3);

172 
i
;

173 
k
 = 
	`pushÿ±u»
(
cs
);

174 
i
 = 
k
; i > 0; i--)

175 
	`lua_¿w£ti
(
L
, -(
i
 + 1), 
n
 + i);

176 
n
 +ğ
k
;

179 
cs
->
ÿp
++;

181 
	}
}

187 
	$qu”yÿp
 (
C­S‹
 *
cs
) {

188 
idx
 = 
cs
->
ÿp
->idx;

189 
	`pushÚ’e¡edv®ue
(
cs
);

190 
	`lua_g‘bË
(
cs
->
L
, 
	`upd©eÿche
(cs, 
idx
));

191 ià(!
	`lua_i¢
(
cs
->
L
, -1))

194 
	`lua_pİ
(
cs
->
L
, 1);

197 
	}
}

203 
	$fŞdÿp
 (
C­S‹
 *
cs
) {

204 
n
;

205 
lua_S‹
 *
L
 = 
cs
->L;

206 
idx
 = 
cs
->
ÿp
->idx;

207 ià(
	`isfuÎÿp
(
cs
->
ÿp
++) ||

208 
	`isşo£ÿp
(
cs
->
ÿp
) ||

209 (
n
 = 
	`pushÿ±u»
(
cs
)) == 0)

210  
	`luaL_”rÜ
(
L
, "no initial value for fold capture");

211 ià(
n
 > 1)

212 
	`lua_pİ
(
L
, 
n
 - 1);

213 !
	`isşo£ÿp
(
cs
->
ÿp
)) {

214 
	`lua_pushv®ue
(
L
, 
	`upd©eÿche
(
cs
, 
idx
));

215 
	`lua_š£¹
(
L
, -2);

216 
n
 = 
	`pushÿ±u»
(
cs
);

217 
	`lua_ÿÎ
(
L
, 
n
 + 1, 1);

219 
cs
->
ÿp
++;

221 
	}
}

227 
	$funùiÚÿp
 (
C­S‹
 *
cs
) {

228 
n
;

229 
tİ
 = 
	`lua_g‘tİ
(
cs
->
L
);

230 
	`pushluav®
(
cs
);

231 
n
 = 
	`pushÃ¡edv®ues
(
cs
, 0);

232 
	`lua_ÿÎ
(
cs
->
L
, 
n
, 
LUA_MULTRET
);

233  
	`lua_g‘tİ
(
cs
->
L
è- 
tİ
;

234 
	}
}

240 
	$numÿp
 (
C­S‹
 *
cs
) {

241 
idx
 = 
cs
->
ÿp
->idx;

242 ià(
idx
 == 0) {

243 
	`Ãxtÿp
(
cs
);

247 
n
 = 
	`pushÃ¡edv®ues
(
cs
, 0);

248 ià(
n
 < 
idx
)

249  
	`luaL_”rÜ
(
cs
->
L
, "nØÿ±u» '%d'", 
idx
);

251 
	`lua_pushv®ue
(
cs
->
L
, -(
n
 - 
idx
 + 1));

252 
	`lua_»¶aû
(
cs
->
L
, -(
n
 + 1));

253 
	`lua_pİ
(
cs
->
L
, 
n
 - 1);

257 
	}
}

264 
	$fšddynÿp
 (
C­tu»
 *
ÿp
, C­tu» *
Ï¡
) {

265 ; 
ÿp
 < 
Ï¡
; cap++) {

266 ià(
ÿp
->
kšd
 =ğ
CruÁime
)

267  
ÿp
->
idx
;

270 
	}
}

278 
	$ruÁimeÿp
 (
C­S‹
 *
cs
, 
C­tu»
 *
şo£
, cÚ¡ *
s
, *
»m
) {

279 
n
, 
id
;

280 
lua_S‹
 *
L
 = 
cs
->L;

281 
Ùİ
 = 
	`lua_g‘tİ
(
L
);

282 
C­tu»
 *
İ’
 = 
	`fšdİ’
(
şo£
);

283 
	`as£¹
(
	`ÿ±y³
(
İ’
è=ğ
Cgroup
);

284 
id
 = 
	`fšddynÿp
(
İ’
, 
şo£
);

285 
şo£
->
kšd
 = 
Cşo£
;

286 
şo£
->
s
 = s;

287 
cs
->
ÿp
 = 
İ’
; cs->
v®ueÿched
 = 0;

288 
	`luaL_check¡ack
(
L
, 4, "too many„untime captures");

289 
	`pushluav®
(
cs
);

290 
	`lua_pushv®ue
(
L
, 
SUBJIDX
);

291 
	`lua_pushš‹g”
(
L
, 
s
 - 
cs
->s + 1);

292 
n
 = 
	`pushÃ¡edv®ues
(
cs
, 0);

293 
	`lua_ÿÎ
(
L
, 
n
 + 2, 
LUA_MULTRET
);

294 ià(
id
 > 0) {

295 
i
;

296 
i
 = 
id
; i <ğ
Ùİ
; i++)

297 
	`lua_»move
(
L
, 
id
);

298 *
»m
 = 
Ùİ
 - 
id
 + 1;

301 *
»m
 = 0;

302  
şo£
 - 
İ’
;

303 
	}
}

311 
	sSŒAux
 {

312 
	mis¡ršg
;

314 
C­tu»
 *
	mı
;

316 cÚ¡ *
	ms
;

317 cÚ¡ *
	me
;

318 } 
	ms
;

319 } 
	mu
;

320 } 
	tSŒAux
;

322 
	#MAXSTRCAPS
 10

	)

330 
	$g‘¡rÿps
 (
C­S‹
 *
cs
, 
SŒAux
 *
ıs
, 
n
) {

331 
k
 = 
n
++;

332 
ıs
[
k
].
is¡ršg
 = 1;

333 
ıs
[
k
].
u
.
s
. ğ
cs
->
ÿp
->s;

334 ià(!
	`isfuÎÿp
(
cs
->
ÿp
++)) {

335 !
	`isşo£ÿp
(
cs
->
ÿp
)) {

336 ià(
n
 >ğ
MAXSTRCAPS
)

337 
	`Ãxtÿp
(
cs
);

338 ià(
	`ÿ±y³
(
cs
->
ÿp
è=ğ
Csim¶e
)

339 
n
 = 
	`g‘¡rÿps
(
cs
, 
ıs
,‚);

341 
ıs
[
n
].
is¡ršg
 = 0;

342 
ıs
[
n
].
u
.
ı
 = 
cs
->
ÿp
;

343 
	`Ãxtÿp
(
cs
);

344 
n
++;

347 
cs
->
ÿp
++;

349 
ıs
[
k
].
u
.
s
.
e
 = 
	`şo£addr
(
cs
->
ÿp
 - 1);

350  
n
;

351 
	}
}

357 
addÚe¡ršg
 (
luaL_Bufãr
 *
b
, 
C­S‹
 *
cs
, cÚ¡ *
wh©
);

364 
	$¡ršgÿp
 (
luaL_Bufãr
 *
b
, 
C­S‹
 *
cs
) {

365 
SŒAux
 
ıs
[
MAXSTRCAPS
];

366 
n
;

367 
size_t
 
Ën
, 
i
;

368 cÚ¡ *
fmt
;

369 
fmt
 = 
	`lua_tŞ¡ršg
(
cs
->
L
, 
	`upd©eÿche
(cs, cs->
ÿp
->
idx
), &
Ën
);

370 
n
 = 
	`g‘¡rÿps
(
cs
, 
ıs
, 0) - 1;

371 
i
 = 0; i < 
Ën
; i++) {

372 ià(
fmt
[
i
] != '%')

373 
	`luaL_addch¬
(
b
, 
fmt
[
i
]);

374 ià(
fmt
[++
i
] < '0' || fmt[i] > '9')

375 
	`luaL_addch¬
(
b
, 
fmt
[
i
]);

377 
l
 = 
fmt
[
i
] - '0';

378 ià(
l
 > 
n
)

379 
	`luaL_”rÜ
(
cs
->
L
, "šv®id c­tu» index (%d)", 
l
);

380 ià(
ıs
[
l
].
is¡ršg
)

381 
	`luaL_addl¡ršg
(
b
, 
ıs
[
l
].
u
.
s
.s, cps[l].u.s.
e
 - cps[l].u.s.s);

383 
C­tu»
 *
cu¼
 = 
cs
->
ÿp
;

384 
cs
->
ÿp
 = 
ıs
[
l
].
u
.
ı
;

385 ià(!
	`addÚe¡ršg
(
b
, 
cs
, "capture"))

386 
	`luaL_”rÜ
(
cs
->
L
, "nØv®ue š c­tu» index %d", 
l
);

387 
cs
->
ÿp
 = 
cu¼
;

391 
	}
}

397 
	$sub¡ÿp
 (
luaL_Bufãr
 *
b
, 
C­S‹
 *
cs
) {

398 cÚ¡ *
cu¼
 = 
cs
->
ÿp
->
s
;

399 ià(
	`isfuÎÿp
(
cs
->
ÿp
))

400 
	`luaL_addl¡ršg
(
b
, 
cu¼
, 
cs
->
ÿp
->
siz
 - 1);

402 
cs
->
ÿp
++;

403 !
	`isşo£ÿp
(
cs
->
ÿp
)) {

404 cÚ¡ *
Ãxt
 = 
cs
->
ÿp
->
s
;

405 
	`luaL_addl¡ršg
(
b
, 
cu¼
, 
Ãxt
 - curr);

406 ià(
	`addÚe¡ršg
(
b
, 
cs
, "replacement"))

407 
cu¼
 = 
	`şo£addr
(
cs
->
ÿp
 - 1);

409 
cu¼
 = 
Ãxt
;

411 
	`luaL_addl¡ršg
(
b
, 
cu¼
, 
cs
->
ÿp
->
s
 - curr);

413 
cs
->
ÿp
++;

414 
	}
}

421 
	$addÚe¡ršg
 (
luaL_Bufãr
 *
b
, 
C­S‹
 *
cs
, cÚ¡ *
wh©
) {

422 
	`ÿ±y³
(
cs
->
ÿp
)) {

423 
C¡ršg
:

424 
	`¡ršgÿp
(
b
, 
cs
);

426 
Csub¡
:

427 
	`sub¡ÿp
(
b
, 
cs
);

430 
lua_S‹
 *
L
 = 
cs
->L;

431 
n
 = 
	`pushÿ±u»
(
cs
);

432 ià(
n
 > 0) {

433 ià(
n
 > 1è
	`lua_pİ
(
L
,‚ - 1);

434 ià(!
	`lua_is¡ršg
(
L
, -1))

435 
	`luaL_”rÜ
(
L
, "šv®id % v®u× %s)", 
wh©
, 
	`luaL_ty³Çme
(L, -1));

436 
	`luaL_addv®ue
(
b
);

438  
n
;

441 
	}
}

448 
	$pushÿ±u»
 (
C­S‹
 *
cs
) {

449 
lua_S‹
 *
L
 = 
cs
->L;

450 
	`luaL_check¡ack
(
L
, 4, "too many captures");

451 
	`ÿ±y³
(
cs
->
ÿp
)) {

452 
Cpos™iÚ
: {

453 
	`lua_pushš‹g”
(
L
, 
cs
->
ÿp
->
s
 - cs->s + 1);

454 
cs
->
ÿp
++;

457 
CcÚ¡
: {

458 
	`pushluav®
(
cs
);

459 
cs
->
ÿp
++;

462 
C¬g
: {

463 
¬g
 = (
cs
->
ÿp
++)->
idx
;

464 ià(
¬g
 + 
FIXEDARGS
 > 
cs
->
±İ
)

465  
	`luaL_”rÜ
(
L
, "»ã»nûØab£ÁƒxŒ¨¬gum’ˆ#%d", 
¬g
);

466 
	`lua_pushv®ue
(
L
, 
¬g
 + 
FIXEDARGS
);

469 
Csim¶e
: {

470 
k
 = 
	`pushÃ¡edv®ues
(
cs
, 1);

471 
	`lua_š£¹
(
L
, -
k
);

472  
k
;

474 
CruÁime
: {

475 
	`lua_pushv®ue
(
L
, (
cs
->
ÿp
++)->
idx
);

478 
C¡ršg
: {

479 
luaL_Bufãr
 
b
;

480 
	`luaL_buffš™
(
L
, &
b
);

481 
	`¡ršgÿp
(&
b
, 
cs
);

482 
	`luaL_push»suÉ
(&
b
);

485 
Csub¡
: {

486 
luaL_Bufãr
 
b
;

487 
	`luaL_buffš™
(
L
, &
b
);

488 
	`sub¡ÿp
(&
b
, 
cs
);

489 
	`luaL_push»suÉ
(&
b
);

492 
Cgroup
: {

493 ià(
cs
->
ÿp
->
idx
 == 0)

494  
	`pushÃ¡edv®ues
(
cs
, 0);

496 
	`Ãxtÿp
(
cs
);

500 
Cback»f
:  
	`back»fÿp
(
cs
);

501 
CbË
:  
	`bËÿp
(
cs
);

502 
CfunùiÚ
:  
	`funùiÚÿp
(
cs
);

503 
Cnum
:  
	`numÿp
(
cs
);

504 
Cqu”y
:  
	`qu”yÿp
(
cs
);

505 
CfŞd
:  
	`fŞdÿp
(
cs
);

506 : 
	`as£¹
(0);  0;

508 
	}
}

519 
	$g‘ÿ±u»s
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
r
, 
±İ
) {

520 
C­tu»
 *
ÿ±u»
 = (C­tu» *)
	`lua_tou£rd©a
(
L
, 
	`ÿ¶i¡idx
(
±İ
));

521 
n
 = 0;

522 ià(!
	`isşo£ÿp
(
ÿ±u»
)) {

523 
C­S‹
 
cs
;

524 
cs
.
oÿp
 = cs.
ÿp
 = 
ÿ±u»
; cs.
L
 = L;

525 
cs
.
s
 = s; cs.
v®ueÿched
 = 0; cs.
±İ
 =…top;

527 
n
 +ğ
	`pushÿ±u»
(&
cs
);

528 } !
	`isşo£ÿp
(
cs
.
ÿp
));

530 ià(
n
 == 0) {

531 
	`lua_pushš‹g”
(
L
, 
r
 - 
s
 + 1);

532 
n
 = 1;

534  
n
;

535 
	}
}

	@3rd/lpeg/lpcap.h

5 #ià!
defšed
(
Íÿp_h
)

6 
	#Íÿp_h


	)

9 
	~"Íty³s.h
"

13 
	eC­Kšd
 {

14 
	mCşo£
,

15 
	mCpos™iÚ
,

16 
	mCcÚ¡
,

17 
	mCback»f
,

18 
	mC¬g
,

19 
	mCsim¶e
,

20 
	mCbË
,

21 
	mCfunùiÚ
,

22 
	mCqu”y
,

23 
	mC¡ršg
,

24 
	mCnum
,

25 
	mCsub¡
,

26 
	mCfŞd
,

27 
	mCruÁime
,

28 
	mCgroup


29 } 
	tC­Kšd
;

32 
	sC­tu»
 {

33 cÚ¡ *
	ms
;

34 
	midx
;

35 
by‹
 
	mkšd
;

36 
by‹
 
	msiz
;

37 } 
	tC­tu»
;

40 
	sC­S‹
 {

41 
C­tu»
 *
	mÿp
;

42 
C­tu»
 *
	moÿp
;

43 
lua_S‹
 *
	mL
;

44 
	m±İ
;

45 cÚ¡ *
	ms
;

46 
	mv®ueÿched
;

47 } 
	tC­S‹
;

50 
ruÁimeÿp
 (
C­S‹
 *
cs
, 
C­tu»
 *
şo£
, cÚ¡ *
s
, *
»m
);

51 
g‘ÿ±u»s
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
r
, 
±İ
);

52 
fšddynÿp
 (
C­tu»
 *
ÿp
, C­tu» *
Ï¡
);

	@3rd/lpeg/lpcode.c

6 
	~<lim™s.h
>

9 
	~"lua.h
"

10 
	~"Ïuxlib.h
"

12 
	~"Íty³s.h
"

13 
	~"Ícode.h
"

17 
	#NOINST
 -1

	)

21 cÚ¡ 
Ch¬£t
 
	gfuÎ£t_
 =

27 cÚ¡ 
Ch¬£t
 *
	gfuÎ£t
 = &
fuÎ£t_
;

41 
Opcode
 
	$ch¬£‰y³
 (cÚ¡ 
by‹
 *
cs
, *
c
) {

42 
couÁ
 = 0;

43 
i
;

44 
ÿndid©e
 = -1;

45 
i
 = 0; i < 
CHARSETSIZE
; i++) {

46 
b
 = 
cs
[
i
];

47 ià(
b
 == 0) {

48 ià(
couÁ
 > 1)

49  
IS‘
;

52 ià(
b
 == 0xFF) {

53 ià(
couÁ
 < (
i
 * 
BITSPERCHAR
))

54  
IS‘
;

55 
couÁ
 +ğ
BITSPERCHAR
;

57 ià((
b
 & (b - 1)) == 0) {

58 ià(
couÁ
 > 0)

59  
IS‘
;

61 
couÁ
++;

62 
ÿndid©e
 = 
i
;

65  
IS‘
;

67 
couÁ
) {

68 0:  
IFa
;

70 
b
 = 
cs
[
ÿndid©e
];

71 *
c
 = 
ÿndid©e
 * 
BITSPERCHAR
;

72 ià((
b
 & 0xF0è!ğ0è{ *
c
 += 4; b >>= 4; }

73 ià((
b
 & 0x0Cè!ğ0è{ *
c
 += 2; b >>= 2; }

74 ià((
b
 & 0x02è!ğ0è{ *
c
 += 1; }

75  
ICh¬
;

78 
	`as£¹
(
couÁ
 =ğ
CHARSETSIZE
 * 
BITSPERCHAR
);

79  
IAny
;

82 
	}
}

88 
	$cs_com¶em’t
 (
Ch¬£t
 *
cs
) {

89 
	`loİ£t
(
i
, 
cs
->cs[i] = ~cs->cs[i]);

90 
	}
}

92 
	$cs_equ®
 (cÚ¡ 
by‹
 *
cs1
, cÚ¡ by‹ *
cs2
) {

93 
	`loİ£t
(
i
, ià(
cs1
[i] !ğ
cs2
[i])  0);

95 
	}
}

97 
	$cs_disjošt
 (cÚ¡ 
Ch¬£t
 *
cs1
, cÚ¡ Ch¬£ˆ*
cs2
) {

98 
	`loİ£t
(
i
, ià((
cs1
->
cs
[i] & 
cs2
->cs[i]) != 0)  0;)

100 
	}
}

107 
	$toch¬£t
 (
TT»e
 *
Œ“
, 
Ch¬£t
 *
cs
) {

108 
Œ“
->
g
) {

109 
TS‘
: {

110 
	`loİ£t
(
i
, 
cs
->cs[i] = 
	`Œ“bufãr
(
Œ“
)[i]);

113 
TCh¬
: {

114 
	`as£¹
(0 <ğ
Œ“
->
u
.
n
 &&»e->u.À<ğ
UCHAR_MAX
);

115 
	`loİ£t
(
i
, 
cs
->cs[i] = 0);

116 
	`£tch¬
(
cs
->cs, 
Œ“
->
u
.
n
);

119 
TAny
: {

120 
	`loİ£t
(
i
, 
cs
->cs[i] = 0xFF);

125 
	}
}

133 
ÿÎ»cursive
 (
TT»e
 *
Œ“
, 
f
 (TT»*
t
), 
def
) {

134 
	gkey
 = 
Œ“
->
key
;

135 
as£¹
(
Œ“
->
g
 =ğ
TC®l
);

136 
as£¹
(
sib2
(
Œ“
)->
g
 =ğ
TRuË
);

137 ià(
	gkey
 == 0)

138  
def
;

140 
	g»suÉ
;

141 
	gŒ“
->
	gkey
 = 0;

142 
	g»suÉ
 = 
f
(
sib2
(
Œ“
));

143 
	gŒ“
->
	gkey
 = 
key
;

144  
	g»suÉ
;

152 
	$hasÿ±u»s
 (
TT»e
 *
Œ“
) {

153 
ÿÎ
:

154 
Œ“
->
g
) {

155 
TC­tu»
: 
TRunTime
:

157 
TC®l
:

158  
	`ÿÎ»cursive
(
Œ“
, 
hasÿ±u»s
, 0);

159 
TRuË
:

160 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

161 
TO³nC®l
: 
	`as£¹
(0);

163 
numsiblšgs
[
Œ“
->
g
]) {

165 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

167 ià(
	`hasÿ±u»s
(
	`sib1
(
Œ“
)))

170 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

171 : 
	`as£¹
(
numsiblšgs
[
Œ“
->
g
] == 0);  0;

175 
	}
}

196 
	$checkaux
 (
TT»e
 *
Œ“
, 
´ed
) {

197 
ÿÎ
:

198 
Œ“
->
g
) {

199 
TCh¬
: 
TS‘
: 
TAny
:

200 
TF®£
: 
TO³nC®l
:

202 
TR•
: 
TTrue
:

204 
TNÙ
: 
TBehšd
:

205 ià(
´ed
 =ğ
PEnoç
)  0;

207 
TAnd
:

208 ià(
´ed
 =ğ
PEnuÎabË
)  1;

210 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

211 
TRunTime
:

212 ià(
´ed
 =ğ
PEnoç
)  0;

214 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

215 
TSeq
:

216 ià(!
	`checkaux
(
	`sib1
(
Œ“
), 
´ed
))  0;

218 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

219 
TChoiû
:

220 ià(
	`checkaux
(
	`sib2
(
Œ“
), 
´ed
))  1;

222 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

223 
TC­tu»
: 
TG¿mm¬
: 
TRuË
:

225 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

226 
TC®l
:

227 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

228 : 
	`as£¹
(0);  0;

230 
	}
}

236 
	$fixedËn
 (
TT»e
 *
Œ“
) {

237 
Ën
 = 0;

238 
ÿÎ
:

239 
Œ“
->
g
) {

240 
TCh¬
: 
TS‘
: 
TAny
:

241  
Ën
 + 1;

242 
TF®£
: 
TTrue
: 
TNÙ
: 
TAnd
: 
TBehšd
:

243  
Ën
;

244 
TR•
: 
TRunTime
: 
TO³nC®l
:

246 
TC­tu»
: 
TRuË
: 
TG¿mm¬
:

248 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

249 
TC®l
: {

250 
n1
 = 
	`ÿÎ»cursive
(
Œ“
, 
fixedËn
, -1);

251 ià(
n1
 < 0)

254  
Ën
 + 
n1
;

256 
TSeq
: {

257 
n1
 = 
	`fixedËn
(
	`sib1
(
Œ“
));

258 ià(
n1
 < 0)

261 
Ën
 +ğ
n1
; 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

263 
TChoiû
: {

264 
n1
 = 
	`fixedËn
(
	`sib1
(
Œ“
));

265 
n2
 = 
	`fixedËn
(
	`sib2
(
Œ“
));

266 ià(
n1
 !ğ
n2
 ||‚1 < 0)

269  
Ën
 + 
n1
;

271 : 
	`as£¹
(0);  0;

273 
	}
}

294 
	$g‘fœ¡
 (
TT»e
 *
Œ“
, cÚ¡ 
Ch¬£t
 *
fŞlow
, Ch¬£ˆ*
fœ¡£t
) {

295 
ÿÎ
:

296 
Œ“
->
g
) {

297 
TCh¬
: 
TS‘
: 
TAny
: {

298 
	`toch¬£t
(
Œ“
, 
fœ¡£t
);

301 
TTrue
: {

302 
	`loİ£t
(
i
, 
fœ¡£t
->
cs
[i] = 
fŞlow
->cs[i]);

305 
TF®£
: {

306 
	`loİ£t
(
i
, 
fœ¡£t
->
cs
[i] = 0);

309 
TChoiû
: {

310 
Ch¬£t
 
c§ux
;

311 
e1
 = 
	`g‘fœ¡
(
	`sib1
(
Œ“
), 
fŞlow
, 
fœ¡£t
);

312 
e2
 = 
	`g‘fœ¡
(
	`sib2
(
Œ“
), 
fŞlow
, &
c§ux
);

313 
	`loİ£t
(
i
, 
fœ¡£t
->
cs
[i] |ğ
c§ux
.cs[i]);

314  
e1
 | 
e2
;

316 
TSeq
: {

317 ià(!
	`nuÎabË
(
	`sib1
(
Œ“
))) {

320 
Œ“
 = 
	`sib1
Ñ»e); 
fŞlow
 = 
fuÎ£t
; 
ÿÎ
;

323 
Ch¬£t
 
c§ux
;

324 
e2
 = 
	`g‘fœ¡
(
	`sib2
(
Œ“
), 
fŞlow
, &
c§ux
);

325 
e1
 = 
	`g‘fœ¡
(
	`sib1
(
Œ“
), &
c§ux
, 
fœ¡£t
);

326 ià(
e1
 == 0)  0;

327 ià((
e1
 | 
e2
) & 2)

329  
e2
;

332 
TR•
: {

333 
	`g‘fœ¡
(
	`sib1
(
Œ“
), 
fŞlow
, 
fœ¡£t
);

334 
	`loİ£t
(
i
, 
fœ¡£t
->
cs
[i] |ğ
fŞlow
->cs[i]);

337 
TC­tu»
: 
TG¿mm¬
: 
TRuË
: {

339 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

341 
TRunTime
: {

342 
e
 = 
	`g‘fœ¡
(
	`sib1
(
Œ“
), 
fuÎ£t
, 
fœ¡£t
);

343 ià(
e
)  2;

346 
TC®l
: {

348 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

350 
TAnd
: {

351 
e
 = 
	`g‘fœ¡
(
	`sib1
(
Œ“
), 
fŞlow
, 
fœ¡£t
);

352 
	`loİ£t
(
i
, 
fœ¡£t
->
cs
[i] &ğ
fŞlow
->cs[i]);

353  
e
;

355 
TNÙ
: {

356 ià(
	`toch¬£t
(
	`sib1
(
Œ“
), 
fœ¡£t
)) {

357 
	`cs_com¶em’t
(
fœ¡£t
);

362 
TBehšd
: {

364 
e
 = 
	`g‘fœ¡
(
	`sib1
(
Œ“
), 
fŞlow
, 
fœ¡£t
);

365 
	`loİ£t
(
i
, 
fœ¡£t
->
cs
[i] = 
fŞlow
->cs[i]);

366  
e
 | 1;

368 : 
	`as£¹
(0);  0;

370 
	}
}

377 
	$h—dç
 (
TT»e
 *
Œ“
) {

378 
ÿÎ
:

379 
Œ“
->
g
) {

380 
TCh¬
: 
TS‘
: 
TAny
: 
TF®£
:

382 
TTrue
: 
TR•
: 
TRunTime
: 
TNÙ
:

383 
TBehšd
:

385 
TC­tu»
: 
TG¿mm¬
: 
TRuË
: 
TAnd
:

386 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

387 
TC®l
:

388 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

389 
TSeq
:

390 ià(!
	`noç
(
	`sib2
(
Œ“
)))  0;

392 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

393 
TChoiû
:

394 ià(!
	`h—dç
(
	`sib1
(
Œ“
)))  0;

396 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

397 : 
	`as£¹
(0);  0;

399 
	}
}

407 
	$ÃedfŞlow
 (
TT»e
 *
Œ“
) {

408 
ÿÎ
:

409 
Œ“
->
g
) {

410 
TCh¬
: 
TS‘
: 
TAny
:

411 
TF®£
: 
TTrue
: 
TAnd
: 
TNÙ
:

412 
TRunTime
: 
TG¿mm¬
: 
TC®l
: 
TBehšd
:

414 
TChoiû
: 
TR•
:

416 
TC­tu»
:

417 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

418 
TSeq
:

419 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

420 : 
	`as£¹
(0);  0;

422 
	}
}

438 
	$sizei
 (cÚ¡ 
In¡ruùiÚ
 *
i
) {

439 (
Opcode
)
i
->i.
code
) {

440 
IS‘
: 
IS·n
:  
CHARSETINSTSIZE
;

441 
ITe¡S‘
:  
CHARSETINSTSIZE
 + 1;

442 
ITe¡Ch¬
: 
ITe¡Any
: 
IChoiû
: 
IJmp
: 
IC®l
:

443 
IO³nC®l
: 
IComm™
: 
IP¬tŸlComm™
: 
IBackComm™
:

447 
	}
}

453 
	sCompeS‹
 {

454 
P©‹º
 *
	mp
;

455 
	mncode
;

456 
lua_S‹
 *
	mL
;

457 } 
	tCompeS‹
;

467 
codeg’
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
, 
İt
, 
‰
,

468 cÚ¡ 
Ch¬£t
 *
æ
);

471 
	$»®loccode
 (
lua_S‹
 *
L
, 
P©‹º
 *
p
, 
nsize
) {

472 *
ud
;

473 
lua_AÎoc
 
f
 = 
	`lua_g‘®locf
(
L
, &
ud
);

474 *
Ãwblock
 = 
	`f
(
ud
, 
p
->
code
,…->
codesize
 * (
In¡ruùiÚ
),

475 
nsize
 * (
In¡ruùiÚ
));

476 ià(
Ãwblock
 =ğ
NULL
 && 
nsize
 > 0)

477 
	`luaL_”rÜ
(
L
, "notƒnough memory");

478 
p
->
code
 = (
In¡ruùiÚ
 *)
Ãwblock
;

479 
p
->
codesize
 = 
nsize
;

480 
	}
}

483 
	$Ãxtš¡ruùiÚ
 (
CompeS‹
 *
comp¡
) {

484 
size
 = 
comp¡
->
p
->
codesize
;

485 ià(
comp¡
->
ncode
 >ğ
size
)

486 
	`»®loccode
(
comp¡
->
L
, comp¡->
p
, 
size
 * 2);

487  
comp¡
->
ncode
++;

488 
	}
}

491 
	#g‘š¡r
(
cs
,
i
è((cs)->
p
->
code
[i])

	)

494 
	$addš¡ruùiÚ
 (
CompeS‹
 *
comp¡
, 
Opcode
 
İ
, 
aux
) {

495 
i
 = 
	`Ãxtš¡ruùiÚ
(
comp¡
);

496 
	`g‘š¡r
(
comp¡
, 
i
).i.
code
 = 
İ
;

497 
	`g‘š¡r
(
comp¡
, 
i
).i.
aux
 =‡ux;

498  
i
;

499 
	}
}

505 
	$addoff£tš¡
 (
CompeS‹
 *
comp¡
, 
Opcode
 
İ
) {

506 
i
 = 
	`addš¡ruùiÚ
(
comp¡
, 
İ
, 0);

507 
	`addš¡ruùiÚ
(
comp¡
, (
Opcode
)0, 0);

508 
	`as£¹
(
İ
 =ğ
ITe¡S‘
 || 
	`sizei
(&
	`g‘š¡r
(
comp¡
, 
i
)) == 2);

509  
i
;

510 
	}
}

516 
	$£toff£t
 (
CompeS‹
 *
comp¡
, 
š¡ruùiÚ
, 
off£t
) {

517 
	`g‘š¡r
(
comp¡
, 
š¡ruùiÚ
 + 1).
off£t
 = offset;

518 
	}
}

527 
	$addš¡ÿp
 (
CompeS‹
 *
comp¡
, 
Opcode
 
İ
, 
ÿp
, 
key
,

528 
aux
) {

529 
i
 = 
	`addš¡ruùiÚ
(
comp¡
, 
İ
, 
	`joškšdoff
(
ÿp
, 
aux
));

530 
	`g‘š¡r
(
comp¡
, 
i
).i.
key
 = key;

531  
i
;

532 
	}
}

535 
	#g‘h”e
(
comp¡
è((comp¡)->
ncode
)

	)

537 
	#rg‘
(
code
,
i
è((iè+ code[˜+ 1].
off£t
)

	)

543 
	$jum±Ùh”e
 (
CompeS‹
 *
comp¡
, 
š¡ruùiÚ
, 
rg‘
) {

544 ià(
š¡ruùiÚ
 >= 0)

545 
	`£toff£t
(
comp¡
, 
š¡ruùiÚ
, 
rg‘
 - instruction);

546 
	}
}

552 
	$jum±oh”e
 (
CompeS‹
 *
comp¡
, 
š¡ruùiÚ
) {

553 
	`jum±Ùh”e
(
comp¡
, 
š¡ruùiÚ
, 
	`g‘h”e
(compst));

554 
	}
}

561 
	$codech¬
 (
CompeS‹
 *
comp¡
, 
c
, 
‰
) {

562 ià(
‰
 >ğ0 && 
	`g‘š¡r
(
comp¡
,t).
i
.
code
 =ğ
ITe¡Ch¬
 &&

563 
	`g‘š¡r
(
comp¡
, 
‰
).
i
.
aux
 =ğ
c
)

564 
	`addš¡ruùiÚ
(
comp¡
, 
IAny
, 0);

566 
	`addš¡ruùiÚ
(
comp¡
, 
ICh¬
, 
c
);

567 
	}
}

573 
	$addch¬£t
 (
CompeS‹
 *
comp¡
, cÚ¡ 
by‹
 *
cs
) {

574 
p
 = 
	`g‘h”e
(
comp¡
);

575 
i
;

576 
i
 = 0; i < ()
CHARSETINSTSIZE
 - 1; i++)

577 
	`Ãxtš¡ruùiÚ
(
comp¡
);

579 
	`loİ£t
(
j
, 
	`g‘š¡r
(
comp¡
, 
p
).
buff
[j] = 
cs
[j]);

580 
	}
}

588 
	$codech¬£t
 (
CompeS‹
 *
comp¡
, cÚ¡ 
by‹
 *
cs
, 
‰
) {

589 
c
 = 0;

590 
Opcode
 
İ
 = 
	`ch¬£‰y³
(
cs
, &
c
);

591 
İ
) {

592 
ICh¬
: 
	`codech¬
(
comp¡
, 
c
, 
‰
); ;

593 
IS‘
: {

594 ià(
‰
 >ğ0 && 
	`g‘š¡r
(
comp¡
,t).
i
.
code
 =ğ
ITe¡S‘
 &&

595 
	`cs_equ®
(
cs
, 
	`g‘š¡r
(
comp¡
, 
‰
 + 2).
buff
))

596 
	`addš¡ruùiÚ
(
comp¡
, 
IAny
, 0);

598 
	`addš¡ruùiÚ
(
comp¡
, 
IS‘
, 0);

599 
	`addch¬£t
(
comp¡
, 
cs
);

603 : 
	`addš¡ruùiÚ
(
comp¡
, 
İ
, 
c
); ;

605 
	}
}

614 
	$cod‘e¡£t
 (
CompeS‹
 *
comp¡
, 
Ch¬£t
 *
cs
, 
e
) {

615 ià(
e
è 
NOINST
;

617 
c
 = 0;

618 
Opcode
 
İ
 = 
	`ch¬£‰y³
(
cs
->cs, &
c
);

619 
İ
) {

620 
IFa
:  
	`addoff£tš¡
(
comp¡
, 
IJmp
);

621 
IAny
:  
	`addoff£tš¡
(
comp¡
, 
ITe¡Any
);

622 
ICh¬
: {

623 
i
 = 
	`addoff£tš¡
(
comp¡
, 
ITe¡Ch¬
);

624 
	`g‘š¡r
(
comp¡
, 
i
).i.
aux
 = 
c
;

625  
i
;

627 
IS‘
: {

628 
i
 = 
	`addoff£tš¡
(
comp¡
, 
ITe¡S‘
);

629 
	`addch¬£t
(
comp¡
, 
cs
->cs);

630  
i
;

632 : 
	`as£¹
(0);  0;

635 
	}
}

641 
	$fš®rg‘
 (
In¡ruùiÚ
 *
code
, 
i
) {

642 
code
[
i
].i.cod=ğ
IJmp
)

643 
i
 = 
	`rg‘
(
code
, i);

644  
i
;

645 
	}
}

651 
	$fš®Ïb–
 (
In¡ruùiÚ
 *
code
, 
i
) {

652  
	`fš®rg‘
(
code
, 
	`rg‘
(code, 
i
));

653 
	}
}

659 
	$codebehšd
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
) {

660 ià(
Œ“
->
u
.
n
 > 0)

661 
	`addš¡ruùiÚ
(
comp¡
, 
IBehšd
, 
Œ“
->
u
.
n
);

662 
	`codeg’
(
comp¡
, 
	`sib1
(
Œ“
), 0, 
NOINST
, 
fuÎ£t
);

663 
	}
}

677 
	$codechoiû
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
p1
, TT»*
p2
, 
İt
,

678 cÚ¡ 
Ch¬£t
 *
æ
) {

679 
em±yp2
 = (
p2
->
g
 =ğ
TTrue
);

680 
Ch¬£t
 
cs1
, 
cs2
;

681 
e1
 = 
	`g‘fœ¡
(
p1
, 
fuÎ£t
, &
cs1
);

682 ià(
	`h—dç
(
p1
) ||

683 (!
e1
 && (
	`g‘fœ¡
(
p2
, 
æ
, &
cs2
), 
	`cs_disjošt
(&
cs1
, &cs2)))) {

685 
‹¡
 = 
	`cod‘e¡£t
(
comp¡
, &
cs1
, 0);

686 
jmp
 = 
NOINST
;

687 
	`codeg’
(
comp¡
, 
p1
, 0, 
‹¡
, 
æ
);

688 ià(!
em±yp2
)

689 
jmp
 = 
	`addoff£tš¡
(
comp¡
, 
IJmp
);

690 
	`jum±oh”e
(
comp¡
, 
‹¡
);

691 
	`codeg’
(
comp¡
, 
p2
, 
İt
, 
NOINST
, 
æ
);

692 
	`jum±oh”e
(
comp¡
, 
jmp
);

694 ià(
İt
 && 
em±yp2
) {

696 
	`jum±oh”e
(
comp¡
, 
	`addoff£tš¡
(comp¡, 
IP¬tŸlComm™
));

697 
	`codeg’
(
comp¡
, 
p1
, 1, 
NOINST
, 
fuÎ£t
);

702 
pcomm™
;

703 
‹¡
 = 
	`cod‘e¡£t
(
comp¡
, &
cs1
, 
e1
);

704 
pchoiû
 = 
	`addoff£tš¡
(
comp¡
, 
IChoiû
);

705 
	`codeg’
(
comp¡
, 
p1
, 
em±yp2
, 
‹¡
, 
fuÎ£t
);

706 
pcomm™
 = 
	`addoff£tš¡
(
comp¡
, 
IComm™
);

707 
	`jum±oh”e
(
comp¡
, 
pchoiû
);

708 
	`jum±oh”e
(
comp¡
, 
‹¡
);

709 
	`codeg’
(
comp¡
, 
p2
, 
İt
, 
NOINST
, 
æ
);

710 
	`jum±oh”e
(
comp¡
, 
pcomm™
);

712 
	}
}

720 
	$cod—nd
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
, 
‰
) {

721 
n
 = 
	`fixedËn
(
Œ“
);

722 ià(
n
 >ğ0 &&‚ <ğ
MAXBEHIND
 && !
	`hasÿ±u»s
(
Œ“
)) {

723 
	`codeg’
(
comp¡
, 
Œ“
, 0, 
‰
, 
fuÎ£t
);

724 ià(
n
 > 0)

725 
	`addš¡ruùiÚ
(
comp¡
, 
IBehšd
, 
n
);

728 
pcomm™
;

729 
pchoiû
 = 
	`addoff£tš¡
(
comp¡
, 
IChoiû
);

730 
	`codeg’
(
comp¡
, 
Œ“
, 0, 
‰
, 
fuÎ£t
);

731 
pcomm™
 = 
	`addoff£tš¡
(
comp¡
, 
IBackComm™
);

732 
	`jum±oh”e
(
comp¡
, 
pchoiû
);

733 
	`addš¡ruùiÚ
(
comp¡
, 
IFa
, 0);

734 
	`jum±oh”e
(
comp¡
, 
pcomm™
);

736 
	}
}

745 
	$codeÿ±u»
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
, 
‰
,

746 cÚ¡ 
Ch¬£t
 *
æ
) {

747 
Ën
 = 
	`fixedËn
(
	`sib1
(
Œ“
));

748 ià(
Ën
 >ğ0 &&†’ <ğ
MAXOFF
 && !
	`hasÿ±u»s
(
	`sib1
(
Œ“
))) {

749 
	`codeg’
(
comp¡
, 
	`sib1
(
Œ“
), 0, 
‰
, 
æ
);

750 
	`addš¡ÿp
(
comp¡
, 
IFuÎC­tu»
, 
Œ“
->
ÿp
,»e->
key
, 
Ën
);

753 
	`addš¡ÿp
(
comp¡
, 
IO³nC­tu»
, 
Œ“
->
ÿp
,»e->
key
, 0);

754 
	`codeg’
(
comp¡
, 
	`sib1
(
Œ“
), 0, 
‰
, 
æ
);

755 
	`addš¡ÿp
(
comp¡
, 
IClo£C­tu»
, 
Cşo£
, 0, 0);

757 
	}
}

760 
	$cod”uÁime
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
, 
‰
) {

761 
	`addš¡ÿp
(
comp¡
, 
IO³nC­tu»
, 
Cgroup
, 
Œ“
->
key
, 0);

762 
	`codeg’
(
comp¡
, 
	`sib1
(
Œ“
), 0, 
‰
, 
fuÎ£t
);

763 
	`addš¡ÿp
(
comp¡
, 
IClo£RunTime
, 
Cşo£
, 0, 0);

764 
	}
}

777 
	$cod”•
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
, 
İt
,

778 cÚ¡ 
Ch¬£t
 *
æ
) {

779 
Ch¬£t
 
¡
;

780 ià(
	`toch¬£t
(
Œ“
, &
¡
)) {

781 
	`addš¡ruùiÚ
(
comp¡
, 
IS·n
, 0);

782 
	`addch¬£t
(
comp¡
, 
¡
.
cs
);

785 
e1
 = 
	`g‘fœ¡
(
Œ“
, 
fuÎ£t
, &
¡
);

786 ià(
	`h—dç
(
Œ“
è|| (!
e1
 && 
	`cs_disjošt
(&
¡
, 
æ
))) {

788 
jmp
;

789 
‹¡
 = 
	`cod‘e¡£t
(
comp¡
, &
¡
, 0);

790 
	`codeg’
(
comp¡
, 
Œ“
, 0, 
‹¡
, 
fuÎ£t
);

791 
jmp
 = 
	`addoff£tš¡
(
comp¡
, 
IJmp
);

792 
	`jum±oh”e
(
comp¡
, 
‹¡
);

793 
	`jum±Ùh”e
(
comp¡
, 
jmp
, 
‹¡
);

798 
comm™
, 
l2
;

799 
‹¡
 = 
	`cod‘e¡£t
(
comp¡
, &
¡
, 
e1
);

800 
pchoiû
 = 
NOINST
;

801 ià(
İt
)

802 
	`jum±oh”e
(
comp¡
, 
	`addoff£tš¡
(comp¡, 
IP¬tŸlComm™
));

804 
pchoiû
 = 
	`addoff£tš¡
(
comp¡
, 
IChoiû
);

805 
l2
 = 
	`g‘h”e
(
comp¡
);

806 
	`codeg’
(
comp¡
, 
Œ“
, 0, 
NOINST
, 
fuÎ£t
);

807 
comm™
 = 
	`addoff£tš¡
(
comp¡
, 
IP¬tŸlComm™
);

808 
	`jum±Ùh”e
(
comp¡
, 
comm™
, 
l2
);

809 
	`jum±oh”e
(
comp¡
, 
pchoiû
);

810 
	`jum±oh”e
(
comp¡
, 
‹¡
);

813 
	}
}

823 
	$cod’Ù
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
) {

824 
Ch¬£t
 
¡
;

825 
e
 = 
	`g‘fœ¡
(
Œ“
, 
fuÎ£t
, &
¡
);

826 
‹¡
 = 
	`cod‘e¡£t
(
comp¡
, &
¡
, 
e
);

827 ià(
	`h—dç
(
Œ“
))

828 
	`addš¡ruùiÚ
(
comp¡
, 
IFa
, 0);

831 
pchoiû
 = 
	`addoff£tš¡
(
comp¡
, 
IChoiû
);

832 
	`codeg’
(
comp¡
, 
Œ“
, 0, 
NOINST
, 
fuÎ£t
);

833 
	`addš¡ruùiÚ
(
comp¡
, 
IFaTwiû
, 0);

834 
	`jum±oh”e
(
comp¡
, 
pchoiû
);

836 
	`jum±oh”e
(
comp¡
, 
‹¡
);

837 
	}
}

844 
	$cÜ»ùÿÎs
 (
CompeS‹
 *
comp¡
, *
pos™iÚs
,

845 
äom
, 
to
) {

846 
i
;

847 
In¡ruùiÚ
 *
code
 = 
comp¡
->
p
->code;

848 
i
 = 
äom
; i < 
to
; i +ğ
	`sizei
(&
code
[i])) {

849 ià(
code
[
i
].i.cod=ğ
IO³nC®l
) {

850 
n
 = 
code
[
i
].i.
key
;

851 
ruË
 = 
pos™iÚs
[
n
];

852 
	`as£¹
(
ruË
 =ğ
äom
 || 
code
[ruË - 1].
i
.cod=ğ
IR‘
);

853 ià(
code
[
	`fš®rg‘
(code, 
i
 + 2)].i.cod=ğ
IR‘
)

854 
code
[
i
].i.codğ
IJmp
;

856 
code
[
i
].i.codğ
IC®l
;

857 
	`jum±Ùh”e
(
comp¡
, 
i
, 
ruË
);

860 
	`as£¹
(
i
 =ğ
to
);

861 
	}
}

868 
	$codeg¿mm¬
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
g¿mm¬
) {

869 
pos™iÚs
[
MAXRULES
];

870 
ruËnumb”
 = 0;

871 
TT»e
 *
ruË
;

872 
fœ¡ÿÎ
 = 
	`addoff£tš¡
(
comp¡
, 
IC®l
);

873 
jum±Ûnd
 = 
	`addoff£tš¡
(
comp¡
, 
IJmp
);

874 
¡¬t
 = 
	`g‘h”e
(
comp¡
);

875 
	`jum±oh”e
(
comp¡
, 
fœ¡ÿÎ
);

876 
ruË
 = 
	`sib1
(
g¿mm¬
);„uË->
g
 =ğ
TRuË
;„uË = 
	`sib2
(rule)) {

877 
pos™iÚs
[
ruËnumb”
++] = 
	`g‘h”e
(
comp¡
);

878 
	`codeg’
(
comp¡
, 
	`sib1
(
ruË
), 0, 
NOINST
, 
fuÎ£t
);

879 
	`addš¡ruùiÚ
(
comp¡
, 
IR‘
, 0);

881 
	`as£¹
(
ruË
->
g
 =ğ
TTrue
);

882 
	`jum±oh”e
(
comp¡
, 
jum±Ûnd
);

883 
	`cÜ»ùÿÎs
(
comp¡
, 
pos™iÚs
, 
¡¬t
, 
	`g‘h”e
(compst));

884 
	}
}

887 
	$codeÿÎ
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
ÿÎ
) {

888 
c
 = 
	`addoff£tš¡
(
comp¡
, 
IO³nC®l
);

889 
	`g‘š¡r
(
comp¡
, 
c
).
i
.
key
 = 
	`sib2
(
ÿÎ
)->
ÿp
;

890 
	`as£¹
(
	`sib2
(
ÿÎ
)->
g
 =ğ
TRuË
);

891 
	}
}

899 
	$code£q1
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
p1
, TT»*
p2
,

900 
‰
, cÚ¡ 
Ch¬£t
 *
æ
) {

901 ià(
	`ÃedfŞlow
(
p1
)) {

902 
Ch¬£t
 
æ1
;

903 
	`g‘fœ¡
(
p2
, 
æ
, &
æ1
);

904 
	`codeg’
(
comp¡
, 
p1
, 0, 
‰
, &
æ1
);

907 
	`codeg’
(
comp¡
, 
p1
, 0, 
‰
, 
fuÎ£t
);

908 ià(
	`fixedËn
(
p1
) != 0)

909  
NOINST
;

910  
‰
;

911 
	}
}

919 
	$codeg’
 (
CompeS‹
 *
comp¡
, 
TT»e
 *
Œ“
, 
İt
, 
‰
,

920 cÚ¡ 
Ch¬£t
 *
æ
) {

921 
ÿÎ
:

922 
Œ“
->
g
) {

923 
TCh¬
: 
	`codech¬
(
comp¡
, 
Œ“
->
u
.
n
, 
‰
); ;

924 
TAny
: 
	`addš¡ruùiÚ
(
comp¡
, 
IAny
, 0); ;

925 
TS‘
: 
	`codech¬£t
(
comp¡
, 
	`Œ“bufãr
(
Œ“
), 
‰
); ;

926 
TTrue
: ;

927 
TF®£
: 
	`addš¡ruùiÚ
(
comp¡
, 
IFa
, 0); ;

928 
TChoiû
: 
	`codechoiû
(
comp¡
, 
	`sib1
(
Œ“
), 
	`sib2
Ñ»e), 
İt
, 
æ
); ;

929 
TR•
: 
	`cod”•
(
comp¡
, 
	`sib1
(
Œ“
), 
İt
, 
æ
); ;

930 
TBehšd
: 
	`codebehšd
(
comp¡
, 
Œ“
); ;

931 
TNÙ
: 
	`cod’Ù
(
comp¡
, 
	`sib1
(
Œ“
)); ;

932 
TAnd
: 
	`cod—nd
(
comp¡
, 
	`sib1
(
Œ“
), 
‰
); ;

933 
TC­tu»
: 
	`codeÿ±u»
(
comp¡
, 
Œ“
, 
‰
, 
æ
); ;

934 
TRunTime
: 
	`cod”uÁime
(
comp¡
, 
Œ“
, 
‰
); ;

935 
TG¿mm¬
: 
	`codeg¿mm¬
(
comp¡
, 
Œ“
); ;

936 
TC®l
: 
	`codeÿÎ
(
comp¡
, 
Œ“
); ;

937 
TSeq
: {

938 
‰
 = 
	`code£q1
(
comp¡
, 
	`sib1
(
Œ“
), 
	`sib2
Ñ»e),t, 
æ
);

940 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

942 : 
	`as£¹
(0);

944 
	}
}

956 
	$³•hŞe
 (
CompeS‹
 *
comp¡
) {

957 
In¡ruùiÚ
 *
code
 = 
comp¡
->
p
->code;

958 
i
;

959 
i
 = 0; i < 
comp¡
->
ncode
; i +ğ
	`sizei
(&
code
[i])) {

960 
»do
:

961 
code
[
i
].i.code) {

962 
IChoiû
: 
IC®l
: 
IComm™
: 
IP¬tŸlComm™
:

963 
IBackComm™
: 
ITe¡Ch¬
: 
ITe¡S‘
:

964 
ITe¡Any
: {

965 
	`jum±Ùh”e
(
comp¡
, 
i
, 
	`fš®Ïb–
(
code
, i));

968 
IJmp
: {

969 
á
 = 
	`fš®rg‘
(
code
, 
i
);

970 
code
[
á
].
i
.code) {

971 
IR‘
: 
IFa
: 
IFaTwiû
:

972 
IEnd
: {

973 
code
[
i
] = code[
á
];

974 
code
[
i
 + 1].i.codğ
IAny
;

977 
IComm™
: 
IP¬tŸlComm™
:

978 
IBackComm™
: {

979 
fá
 = 
	`fš®Ïb–
(
code
, 
á
);

980 
code
[
i
] = code[
á
];

981 
	`jum±Ùh”e
(
comp¡
, 
i
, 
fá
);

982 
»do
;

985 
	`jum±Ùh”e
(
comp¡
, 
i
, 
á
);

994 
	`as£¹
(
code
[
i
 - 1].i.cod=ğ
IEnd
);

995 
	}
}

1001 
In¡ruùiÚ
 *
	$compe
 (
lua_S‹
 *
L
, 
P©‹º
 *
p
) {

1002 
CompeS‹
 
comp¡
;

1003 
comp¡
.
p
 =…; comp¡.
ncode
 = 0; comp¡.
L
 = L;

1004 
	`»®loccode
(
L
, 
p
, 2);

1005 
	`codeg’
(&
comp¡
, 
p
->
Œ“
, 0, 
NOINST
, 
fuÎ£t
);

1006 
	`addš¡ruùiÚ
(&
comp¡
, 
IEnd
, 0);

1007 
	`»®loccode
(
L
, 
p
, 
comp¡
.
ncode
);

1008 
	`³•hŞe
(&
comp¡
);

1009  
p
->
code
;

1010 
	}
}

	@3rd/lpeg/lpcode.h

5 #ià!
defšed
(
Ícode_h
)

6 
	#Ícode_h


	)

8 
	~"lua.h
"

10 
	~"Íty³s.h
"

11 
	~"ÍŒ“.h
"

12 
	~"Ívm.h
"

14 
toch¬£t
 (
TT»e
 *
Œ“
, 
Ch¬£t
 *
cs
);

15 
checkaux
 (
TT»e
 *
Œ“
, 
´ed
);

16 
fixedËn
 (
TT»e
 *
Œ“
);

17 
hasÿ±u»s
 (
TT»e
 *
Œ“
);

18 
Í_gc
 (
lua_S‹
 *
L
);

19 
In¡ruùiÚ
 *
compe
 (
lua_S‹
 *
L
, 
P©‹º
 *
p
);

20 
»®loccode
 (
lua_S‹
 *
L
, 
P©‹º
 *
p
, 
nsize
);

21 
sizei
 (cÚ¡ 
In¡ruùiÚ
 *
i
);

24 
	#PEnuÎabË
 0

	)

25 
	#PEnoç
 1

	)

30 
	#noç
(
t
è
	`checkaux
Ñ, 
PEnoç
)

	)

36 
	#nuÎabË
(
t
è
	`checkaux
Ñ, 
PEnuÎabË
)

	)

	@3rd/lpeg/lpprint.c

6 
	~<ùy³.h
>

7 
	~<lim™s.h
>

8 
	~<¡dio.h
>

11 
	~"Íty³s.h
"

12 
	~"Í´št.h
"

13 
	~"Ícode.h
"

16 #ià
defšed
(
LPEG_DEBUG
)

25 
	$´štch¬£t
 (cÚ¡ 
by‹
 *
¡
) {

26 
i
;

27 
	`´štf
("[");

28 
i
 = 0; i <ğ
UCHAR_MAX
; i++) {

29 
fœ¡
 = 
i
;

30 
	`‹¡ch¬
(
¡
, 
i
è&& i <ğ
UCHAR_MAX
) i++;

31 ià(
i
 - 1 =ğ
fœ¡
)

32 
	`´štf
("(%02x)", 
fœ¡
);

33 ià(
i
 - 1 > 
fœ¡
)

34 
	`´štf
("(%02x-%02x)", 
fœ¡
, 
i
 - 1);

36 
	`´štf
("]");

37 
	}
}

40 cÚ¡ *
	$ÿpkšd
 (
kšd
) {

41 cÚ¡ *cÚ¡ 
modes
[] = {

46  
modes
[
kšd
];

47 
	}
}

50 
	$´štjmp
 (cÚ¡ 
In¡ruùiÚ
 *
İ
, cÚ¡ In¡ruùiÚ *
p
) {

51 
	`´štf
("-> %d", ()(
p
 + (°+ 1)->
off£t
 - 
İ
));

52 
	}
}

55 
	$´štš¡
 (cÚ¡ 
In¡ruùiÚ
 *
İ
, cÚ¡ In¡ruùiÚ *
p
) {

56 cÚ¡ *cÚ¡ 
Çmes
[] = {

65 
	`´štf
("%02ld: % ", ()(
p
 - 
İ
), 
Çmes
[p->
i
.
code
]);

66 (
Opcode
)
p
->
i
.
code
) {

67 
ICh¬
: {

68 
	`´štf
("'%c'", 
p
->
i
.
aux
);

71 
ITe¡Ch¬
: {

72 
	`´štf
("'%c'", 
p
->
i
.
aux
); 
	`´štjmp
(
İ
,…);

75 
IFuÎC­tu»
: {

76 
	`´štf
("%s (size = %d) (idx = %d)",

77 
	`ÿpkšd
(
	`g‘kšd
(
p
)), 
	`g‘off
Õ),…->
i
.
key
);

80 
IO³nC­tu»
: {

81 
	`´štf
("% (idx = %d)", 
	`ÿpkšd
(
	`g‘kšd
(
p
)),…->
i
.
key
);

84 
IS‘
: {

85 
	`´štch¬£t
((
p
+1)->
buff
);

88 
ITe¡S‘
: {

89 
	`´štch¬£t
((
p
+2)->
buff
); 
	`´štjmp
(
İ
,…);

92 
IS·n
: {

93 
	`´štch¬£t
((
p
+1)->
buff
);

96 
IO³nC®l
: {

97 
	`´štf
("-> %d", (
p
 + 1)->
off£t
);

100 
IBehšd
: {

101 
	`´štf
("%d", 
p
->
i
.
aux
);

104 
IJmp
: 
IC®l
: 
IComm™
: 
IChoiû
:

105 
IP¬tŸlComm™
: 
IBackComm™
: 
ITe¡Any
: {

106 
	`´štjmp
(
İ
, 
p
);

111 
	`´štf
("\n");

112 
	}
}

115 
	$´š©t
 (
In¡ruùiÚ
 *
p
, 
n
) {

116 
In¡ruùiÚ
 *
İ
 = 
p
;

117 
p
 < 
İ
 + 
n
) {

118 
	`´štš¡
(
İ
, 
p
);

119 
p
 +ğ
	`sizei
(p);

121 
	}
}

124 #ià
defšed
(
LPEG_DEBUG
)

125 
	$´štÿp
 (
C­tu»
 *
ÿp
) {

126 
	`´štf
("%s (idx: %d - size: %d) -> %p\n",

127 
	`ÿpkšd
(
ÿp
->
kšd
), c­->
idx
, c­->
siz
, c­->
s
);

128 
	}
}

131 
	$´štÿ¶i¡
 (
C­tu»
 *
ÿp
, C­tu» *
lim™
) {

132 
	`´štf
(">======\n");

133 ; 
ÿp
->
s
 && (
lim™
 =ğ
NULL
 || cap <†imit); cap++)

134 
	`´štÿp
(
ÿp
);

135 
	`´štf
("=======\n");

136 
	}
}

148 cÚ¡ *
	ggÇmes
[] = {

160 
	$´š‰»e
 (
TT»e
 *
Œ“
, 
id’t
) {

161 
i
;

162 
i
 = 0; i < 
id’t
; i++è
	`´štf
(" ");

163 
	`´štf
("%s", 
gÇmes
[
Œ“
->
g
]);

164 
Œ“
->
g
) {

165 
TCh¬
: {

166 
c
 = 
Œ“
->
u
.
n
;

167 ià(
	`i¥ršt
(
c
))

168 
	`´štf
(" '%c'\n", 
c
);

170 
	`´štf
(" (%02X)\n", 
c
);

173 
TS‘
: {

174 
	`´štch¬£t
(
	`Œ“bufãr
(
Œ“
));

175 
	`´štf
("\n");

178 
TO³nC®l
: 
TC®l
: {

179 
	`as£¹
(
	`sib2
(
Œ“
)->
g
 =ğ
TRuË
);

180 
	`´štf
(" key: %d (ruË: %d)\n", 
Œ“
->
key
, 
	`sib2
Ñ»e)->
ÿp
);

183 
TBehšd
: {

184 
	`´štf
(" %d\n", 
Œ“
->
u
.
n
);

185 
	`´š‰»e
(
	`sib1
(
Œ“
), 
id’t
 + 2);

188 
TC­tu»
: {

189 
	`´štf
(" kšd: '%s' key: %d\n", 
	`ÿpkšd
(
Œ“
->
ÿp
),»e->
key
);

190 
	`´š‰»e
(
	`sib1
(
Œ“
), 
id’t
 + 2);

193 
TRuË
: {

194 
	`´štf
("‚: %d key: %d\n", 
Œ“
->
ÿp
,»e->
key
);

195 
	`´š‰»e
(
	`sib1
(
Œ“
), 
id’t
 + 2);

198 
TG¿mm¬
: {

199 
TT»e
 *
ruË
 = 
	`sib1
(
Œ“
);

200 
	`´štf
(" %d\n", 
Œ“
->
u
.
n
);

201 
i
 = 0; i < 
Œ“
->
u
.
n
; i++) {

202 
	`´š‰»e
(
ruË
, 
id’t
 + 2);

203 
ruË
 = 
	`sib2
(rule);

205 
	`as£¹
(
ruË
->
g
 =ğ
TTrue
);

209 
sibs
 = 
numsiblšgs
[
Œ“
->
g
];

210 
	`´štf
("\n");

211 ià(
sibs
 >= 1) {

212 
	`´š‰»e
(
	`sib1
(
Œ“
), 
id’t
 + 2);

213 ià(
sibs
 >= 2)

214 
	`´š‰»e
(
	`sib2
(
Œ“
), 
id’t
 + 2);

219 
	}
}

222 
	$´štkbË
 (
lua_S‹
 *
L
, 
idx
) {

223 
n
, 
i
;

224 
	`lua_g‘u£rv®ue
(
L
, 
idx
);

225 ià(
	`lua_i¢
(
L
, -1))

227 
n
 = 
	`lua_¿wËn
(
L
, -1);

228 
	`´štf
("[");

229 
i
 = 1; i <ğ
n
; i++) {

230 
	`´štf
("%d = ", 
i
);

231 
	`lua_¿wg‘i
(
L
, -1, 
i
);

232 ià(
	`lua_is¡ršg
(
L
, -1))

233 
	`´štf
("%  ", 
	`lua_to¡ršg
(
L
, -1));

235 
	`´štf
("%  ", 
	`lua_ty³Çme
(
L
, 
	`lua_ty³
(L, -1)));

236 
	`lua_pİ
(
L
, 1);

238 
	`´štf
("]\n");

240 
	}
}

	@3rd/lpeg/lpprint.h

6 #ià!
defšed
(
Í´št_h
)

7 
	#Í´št_h


	)

10 
	~"ÍŒ“.h
"

11 
	~"Ívm.h
"

14 #ià
defšed
(
LPEG_DEBUG
)

16 
´š©t
 (
In¡ruùiÚ
 *
p
, 
n
);

17 
´š‰»e
 (
TT»e
 *
Œ“
, 
id’t
);

18 
´štkbË
 (
lua_S‹
 *
L
, 
idx
);

19 
´štch¬£t
 (cÚ¡ 
by‹
 *
¡
);

20 
´štÿ¶i¡
 (
C­tu»
 *
ÿp
, C­tu» *
lim™
);

21 
´štš¡
 (cÚ¡ 
In¡ruùiÚ
 *
İ
, cÚ¡ In¡ruùiÚ *
p
);

25 
	#´štkbË
(
L
,
idx
) \

26 
	`luaL_”rÜ
(
L
, "funùiÚ oÆy im¶em’‹d iÀdebug mode")

	)

27 
	#´š‰»e
(
Œ“
,
i
) \

28 
	`luaL_”rÜ
(
L
, "funùiÚ oÆy im¶em’‹d iÀdebug mode")

	)

29 
	#´š©t
(
p
,
n
) \

30 
	`luaL_”rÜ
(
L
, "funùiÚ oÆy im¶em’‹d iÀdebug mode")

	)

	@3rd/lpeg/lptree.c

6 
	~<ùy³.h
>

7 
	~<lim™s.h
>

8 
	~<¡ršg.h
>

11 
	~"lua.h
"

12 
	~"Ïuxlib.h
"

14 
	~"Íty³s.h
"

15 
	~"Íÿp.h
"

16 
	~"Ícode.h
"

17 
	~"Í´št.h
"

18 
	~"ÍŒ“.h
"

22 cÚ¡ 
by‹
 
	gnumsiblšgs
[] = {

34 
TT»e
 *
Ãwg¿mm¬
 (
lua_S‹
 *
L
, 
¬g
);

40 cÚ¡ *
	$v®2¡r
 (
lua_S‹
 *
L
, 
idx
) {

41 cÚ¡ *
k
 = 
	`lua_to¡ršg
(
L
, 
idx
);

42 ià(
k
 !ğ
NULL
)

43  
	`lua_pushf¡ršg
(
L
, "%s", 
k
);

45  
	`lua_pushf¡ršg
(
L
, "× %s)", 
	`luaL_ty³Çme
(L, 
idx
));

46 
	}
}

54 
	$fixÚeÿÎ
 (
lua_S‹
 *
L
, 
po¡abË
, 
TT»e
 *
g
, TT»*
t
) {

55 
n
;

56 
	`lua_¿wg‘i
(
L
, -1, 
t
->
key
);

57 
	`lua_g‘bË
(
L
, 
po¡abË
);

58 
n
 = 
	`lua_tÚumb”
(
L
, -1);

59 
	`lua_pİ
(
L
, 1);

60 ià(
n
 == 0) {

61 
	`lua_¿wg‘i
(
L
, -1, 
t
->
key
);

62 
	`luaL_”rÜ
(
L
, "ruË '%s' undefšed iÀgiv’ g¿mm¬", 
	`v®2¡r
(L, -1));

64 
t
->
g
 = 
TC®l
;

65 
t
->
u
.
ps
 = 
n
 - (ˆ- 
g
);

66 
	`as£¹
(
	`sib2
(
t
)->
g
 =ğ
TRuË
);

67 
	`sib2
(
t
)->
key
 =->key;

68 
	}
}

78 
	$cÜ»ùassocŸtiv™y
 (
TT»e
 *
Œ“
) {

79 
TT»e
 *
t1
 = 
	`sib1
(
Œ“
);

80 
	`as£¹
(
Œ“
->
g
 =ğ
TChoiû
 ||»e->g =ğ
TSeq
);

81 
t1
->
g
 =ğ
Œ“
->tag) {

82 
n1size
 = 
Œ“
->
u
.
ps
 - 1;

83 
n11size
 = 
t1
->
u
.
ps
 - 1;

84 
n12size
 = 
n1size
 - 
n11size
 - 1;

85 
	`memmove
(
	`sib1
(
Œ“
), sib1(
t1
), 
n11size
 * (
TT»e
));

86 
Œ“
->
u
.
ps
 = 
n11size
 + 1;

87 
	`sib2
(
Œ“
)->
g
 =ree->tag;

88 
	`sib2
(
Œ“
)->
u
.
ps
 = 
n12size
 + 1;

90 
	}
}

100 
	$fš®fix
 (
lua_S‹
 *
L
, 
po¡abË
, 
TT»e
 *
g
, TT»*
t
) {

101 
ÿÎ
:

102 
t
->
g
) {

103 
TG¿mm¬
:

105 
TO³nC®l
: {

106 ià(
g
 !ğ
NULL
)

107 
	`fixÚeÿÎ
(
L
, 
po¡abË
, 
g
, 
t
);

109 
	`lua_¿wg‘i
(
L
, -1, 
t
->
key
);

110 
	`luaL_”rÜ
(
L
, "ruË '%s' u£d outsid¨g¿mm¬", 
	`v®2¡r
(L, -1));

114 
TSeq
: 
TChoiû
:

115 
	`cÜ»ùassocŸtiv™y
(
t
);

118 
numsiblšgs
[
t
->
g
]) {

120 
t
 = 
	`sib1
Ñ); 
ÿÎ
;

122 
	`fš®fix
(
L
, 
po¡abË
, 
g
, 
	`sib1
(
t
));

123 
t
 = 
	`sib2
Ñ); 
ÿÎ
;

124 : 
	`as£¹
(
numsiblšgs
[
t
->
g
] == 0); ;

126 
	}
}

147 
	$ÃwkbË
 (
lua_S‹
 *
L
, 
n
) {

148 
	`lua_ü—‹bË
(
L
, 
n
, 0);

149 
	`lua_£tu£rv®ue
(
L
, -2);

150 
	}
}

159 
	$addtokbË
 (
lua_S‹
 *
L
, 
idx
) {

160 ià(
	`lua_i¢
(
L
, 
idx
))

163 
n
;

164 
	`lua_g‘u£rv®ue
(
L
, -1);

165 
n
 = 
	`lua_¿wËn
(
L
, -1);

166 ià(
n
 >ğ
USHRT_MAX
)

167 
	`luaL_”rÜ
(
L
, "too many Lua values in…attern");

168 
	`lua_pushv®ue
(
L
, 
idx
);

169 
	`lua_¿w£ti
(
L
, -2, ++
n
);

170 
	`lua_pİ
(
L
, 1);

171  
n
;

173 
	}
}

182 
	$kbËËn
 (
lua_S‹
 *
L
, 
idx
) {

183 ià(!
	`lua_i¡abË
(
L
, 
idx
))  0;

184  
	`lua_¿wËn
(
L
, 
idx
);

185 
	}
}

194 
	$cÚÿ‰abË
 (
lua_S‹
 *
L
, 
idx1
, 
idx2
) {

195 
i
;

196 
n1
 = 
	`kbËËn
(
L
, 
idx1
);

197 
n2
 = 
	`kbËËn
(
L
, 
idx2
);

198 ià(
n1
 + 
n2
 > 
USHRT_MAX
)

199 
	`luaL_”rÜ
(
L
, "too many Lua values in…attern");

200 ià(
n1
 == 0)  0;

201 
i
 = 1; i <ğ
n1
; i++) {

202 
	`lua_¿wg‘i
(
L
, 
idx1
, 
i
);

203 
	`lua_¿w£ti
(
L
, 
idx2
 - 1, 
n2
 + 
i
);

205  
n2
;

206 
	}
}

214 
	$cÜ»ùkeys
 (
TT»e
 *
Œ“
, 
n
) {

215 ià(
n
 == 0) ;

216 
ÿÎ
:

217 
Œ“
->
g
) {

218 
TO³nC®l
: 
TC®l
: 
TRunTime
: 
TRuË
: {

219 ià(
Œ“
->
key
 > 0)

220 
Œ“
->
key
 +ğ
n
;

223 
TC­tu»
: {

224 ià(
Œ“
->
key
 > 0 &&»e->
ÿp
 !ğ
C¬g
 &&»e->ÿ°!ğ
Cnum
)

225 
Œ“
->
key
 +ğ
n
;

230 
numsiblšgs
[
Œ“
->
g
]) {

232 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

234 
	`cÜ»ùkeys
(
	`sib1
(
Œ“
), 
n
);

235 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

236 : 
	`as£¹
(
numsiblšgs
[
Œ“
->
g
] == 0); ;

238 
	}
}

245 
	$joškbËs
 (
lua_S‹
 *
L
, 
p1
, 
TT»e
 *
t2
, 
p2
) {

246 
n1
, 
n2
;

247 
	`lua_g‘u£rv®ue
(
L
, 
p1
);

248 
	`lua_g‘u£rv®ue
(
L
, 
p2
);

249 
n1
 = 
	`kbËËn
(
L
, -2);

250 
n2
 = 
	`kbËËn
(
L
, -1);

251 ià(
n1
 =ğ0 && 
n2
 == 0)

252 
	`lua_pİ
(
L
, 2);

253 ià(
n2
 =ğ0 || 
	`Í_equ®
(
L
, -2, -1)) {

254 
	`lua_pİ
(
L
, 1);

255 
	`lua_£tu£rv®ue
(
L
, -2);

257 ià(
n1
 == 0) {

258 
	`lua_£tu£rv®ue
(
L
, -3);

259 
	`lua_pİ
(
L
, 1);

262 
	`lua_ü—‹bË
(
L
, 
n1
 + 
n2
, 0);

264 
	`cÚÿ‰abË
(
L
, -3, -1);

265 
	`cÚÿ‰abË
(
L
, -2, -1);

266 
	`lua_£tu£rv®ue
(
L
, -4);

267 
	`lua_pİ
(
L
, 2);

268 
	`cÜ»ùkeys
(
t2
, 
n1
);

270 
	}
}

276 
	$cİykbË
 (
lua_S‹
 *
L
, 
idx
) {

277 
	`lua_g‘u£rv®ue
(
L
, 
idx
);

278 
	`lua_£tu£rv®ue
(
L
, -2);

279 
	}
}

287 
	$m”gekbË
 (
lua_S‹
 *
L
, 
idx
, 
TT»e
 *
¡»e
) {

288 
n
;

289 
	`lua_g‘u£rv®ue
(
L
, -1);

290 
	`lua_g‘u£rv®ue
(
L
, 
idx
);

291 
n
 = 
	`cÚÿ‰abË
(
L
, -1, -2);

292 
	`lua_pİ
(
L
, 2);

293 
	`cÜ»ùkeys
(
¡»e
, 
n
);

294 
	}
}

302 
	$addtÚewkbË
 (
lua_S‹
 *
L
, 
p
, 
idx
) {

303 
	`ÃwkbË
(
L
, 1);

304 ià(
p
)

305 
	`m”gekbË
(
L
, 
p
, 
NULL
);

306  
	`addtokbË
(
L
, 
idx
);

307 
	}
}

321 
	$‹¡·‰”n
 (
lua_S‹
 *
L
, 
idx
) {

322 ià(
	`lua_tou£rd©a
(
L
, 
idx
)) {

323 ià(
	`lua_g‘m‘©abË
(
L
, 
idx
)) {

324 
	`luaL_g‘m‘©abË
(
L
, 
PATTERN_T
);

325 ià(
	`lua_¿wequ®
(
L
, -1, -2)) {

326 
	`lua_pİ
(
L
, 2);

332 
	}
}

335 
P©‹º
 *
	$g‘·‰”n
 (
lua_S‹
 *
L
, 
idx
) {

336  (
P©‹º
 *)
	`luaL_checkud©a
(
L
, 
idx
, 
PATTERN_T
);

337 
	}
}

340 
	$g‘size
 (
lua_S‹
 *
L
, 
idx
) {

341  (
	`lua_¿wËn
(
L
, 
idx
è- (
P©‹º
)è/ (
TT»e
) + 1;

342 
	}
}

345 
TT»e
 *
	$g‘Œ“
 (
lua_S‹
 *
L
, 
idx
, *
Ën
) {

346 
P©‹º
 *
p
 = 
	`g‘·‰”n
(
L
, 
idx
);

347 ià(
Ën
)

348 *
Ën
 = 
	`g‘size
(
L
, 
idx
);

349  
p
->
Œ“
;

350 
	}
}

358 
TT»e
 *
	$ÃwŒ“
 (
lua_S‹
 *
L
, 
Ën
) {

359 
size_t
 
size
 = (
Ën
 - 1è* (
TT»e
è+ (
P©‹º
);

360 
P©‹º
 *
p
 = (P©‹º *)
	`lua_Ãwu£rd©a
(
L
, 
size
);

361 
	`luaL_g‘m‘©abË
(
L
, 
PATTERN_T
);

362 
	`lua_pushv®ue
(
L
, -1);

363 
	`lua_£tu£rv®ue
(
L
, -3);

364 
	`lua_£tm‘©abË
(
L
, -2);

365 
p
->
code
 = 
NULL
;…->
codesize
 = 0;

366  
p
->
Œ“
;

367 
	}
}

370 
TT»e
 *
	$ÃwËaf
 (
lua_S‹
 *
L
, 
g
) {

371 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, 1);

372 
Œ“
->
g
 =ag;

373  
Œ“
;

374 
	}
}

377 
TT»e
 *
	$Ãwch¬£t
 (
lua_S‹
 *
L
) {

378 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, 
	`by‹s2¦Ùs
(
CHARSETSIZE
) + 1);

379 
Œ“
->
g
 = 
TS‘
;

380 
	`loİ£t
(
i
, 
	`Œ“bufãr
(
Œ“
)[i] = 0);

381  
Œ“
;

382 
	}
}

389 
TT»e
 *
	$£qaux
 (
TT»e
 *
Œ“
, TT»*
sib
, 
sibsize
) {

390 
Œ“
->
g
 = 
TSeq
;»e->
u
.
ps
 = 
sibsize
 + 1;

391 
	`memıy
(
	`sib1
(
Œ“
), 
sib
, 
sibsize
 * (
TT»e
));

392  
	`sib2
(
Œ“
);

393 
	}
}

401 
	$fl£q
 (
TT»e
 *
Œ“
, 
g
, 
n
, cÚ¡ *
s
) {

402 
i
;

403 
i
 = 0; i < 
n
 - 1; i++) {

404 
Œ“
->
g
 = 
TSeq
;»e->
u
.
ps
 = 2;

405 
	`sib1
(
Œ“
)->
g
 =ag;

406 
	`sib1
(
Œ“
)->
u
.
n
 = 
s
 ? (
by‹
)s[
i
] : 0;

407 
Œ“
 = 
	`sib2
(tree);

409 
Œ“
->
g
 =ag;

410 
Œ“
->
u
.
n
 = 
s
 ? (
by‹
)s[
i
] : 0;

411 
	}
}

419 
TT»e
 *
	$numŒ“
 (
lua_S‹
 *
L
, 
n
) {

420 ià(
n
 == 0)

421  
	`ÃwËaf
(
L
, 
TTrue
);

423 
TT»e
 *
Œ“
, *
nd
;

424 ià(
n
 > 0)

425 
Œ“
 = 
nd
 = 
	`ÃwŒ“
(
L
, 2 * 
n
 - 1);

427 
n
 = -n;

428 
Œ“
 = 
	`ÃwŒ“
(
L
, 2 * 
n
);

429 
Œ“
->
g
 = 
TNÙ
;

430 
nd
 = 
	`sib1
(
Œ“
);

432 
	`fl£q
(
nd
, 
TAny
, 
n
, 
NULL
);

433  
Œ“
;

435 
	}
}

441 
TT»e
 *
	$g‘·‰
 (
lua_S‹
 *
L
, 
idx
, *
Ën
) {

442 
TT»e
 *
Œ“
;

443 
	`lua_ty³
(
L
, 
idx
)) {

444 
LUA_TSTRING
: {

445 
size_t
 
¦’
;

446 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
idx
, &
¦’
);

447 ià(
¦’
 == 0)

448 
Œ“
 = 
	`ÃwËaf
(
L
, 
TTrue
);

450 
Œ“
 = 
	`ÃwŒ“
(
L
, 2 * (
¦’
 - 1) + 1);

451 
	`fl£q
(
Œ“
, 
TCh¬
, 
¦’
, 
s
);

455 
LUA_TNUMBER
: {

456 
n
 = 
	`lua_toš‹g”
(
L
, 
idx
);

457 
Œ“
 = 
	`numŒ“
(
L
, 
n
);

460 
LUA_TBOOLEAN
: {

461 
Œ“
 = (
	`lua_toboŞ—n
(
L
, 
idx
è? 
	`ÃwËaf
(L, 
TTrue
è:‚ewËaf(L, 
TF®£
));

464 
LUA_TTABLE
: {

465 
Œ“
 = 
	`Ãwg¿mm¬
(
L
, 
idx
);

468 
LUA_TFUNCTION
: {

469 
Œ“
 = 
	`ÃwŒ“
(
L
, 2);

470 
Œ“
->
g
 = 
TRunTime
;

471 
Œ“
->
key
 = 
	`addtÚewkbË
(
L
, 0, 
idx
);

472 
	`sib1
(
Œ“
)->
g
 = 
TTrue
;

476  
	`g‘Œ“
(
L
, 
idx
, 
Ën
);

479 
	`lua_»¶aû
(
L
, 
idx
);

480 ià(
Ën
)

481 *
Ën
 = 
	`g‘size
(
L
, 
idx
);

482  
Œ“
;

483 
	}
}

490 
TT»e
 *
	$ÃwroÙ1sib
 (
lua_S‹
 *
L
, 
g
) {

491 
s1
;

492 
TT»e
 *
Œ“1
 = 
	`g‘·‰
(
L
, 1, &
s1
);

493 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, 1 + 
s1
);

494 
Œ“
->
g
 =ag;

495 
	`memıy
(
	`sib1
(
Œ“
), 
Œ“1
, 
s1
 * (
TT»e
));

496 
	`cİykbË
(
L
, 1);

497  
Œ“
;

498 
	}
}

505 
TT»e
 *
	$ÃwroÙ2sib
 (
lua_S‹
 *
L
, 
g
) {

506 
s1
, 
s2
;

507 
TT»e
 *
Œ“1
 = 
	`g‘·‰
(
L
, 1, &
s1
);

508 
TT»e
 *
Œ“2
 = 
	`g‘·‰
(
L
, 2, &
s2
);

509 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, 1 + 
s1
 + 
s2
);

510 
Œ“
->
g
 =ag;

511 
Œ“
->
u
.
ps
 = 1 + 
s1
;

512 
	`memıy
(
	`sib1
(
Œ“
), 
Œ“1
, 
s1
 * (
TT»e
));

513 
	`memıy
(
	`sib2
(
Œ“
), 
Œ“2
, 
s2
 * (
TT»e
));

514 
	`joškbËs
(
L
, 1, 
	`sib2
(
Œ“
), 2);

515  
Œ“
;

516 
	}
}

519 
	$Í_P
 (
lua_S‹
 *
L
) {

520 
	`luaL_checkªy
(
L
, 1);

521 
	`g‘·‰
(
L
, 1, 
NULL
);

522 
	`lua_£‰İ
(
L
, 1);

524 
	}
}

532 
	$Í_£q
 (
lua_S‹
 *
L
) {

533 
TT»e
 *
Œ“1
 = 
	`g‘·‰
(
L
, 1, 
NULL
);

534 
TT»e
 *
Œ“2
 = 
	`g‘·‰
(
L
, 2, 
NULL
);

535 ià(
Œ“1
->
g
 =ğ
TF®£
 || 
Œ“2
->g =ğ
TTrue
)

536 
	`lua_pushv®ue
(
L
, 1);

537 ià(
Œ“1
->
g
 =ğ
TTrue
)

538 
	`lua_pushv®ue
(
L
, 2);

540 
	`ÃwroÙ2sib
(
L
, 
TSeq
);

542 
	}
}

551 
	$Í_choiû
 (
lua_S‹
 *
L
) {

552 
Ch¬£t
 
¡1
, 
¡2
;

553 
TT»e
 *
t1
 = 
	`g‘·‰
(
L
, 1, 
NULL
);

554 
TT»e
 *
t2
 = 
	`g‘·‰
(
L
, 2, 
NULL
);

555 ià(
	`toch¬£t
(
t1
, &
¡1
è&&och¬£t(
t2
, &
¡2
)) {

556 
TT»e
 *
t
 = 
	`Ãwch¬£t
(
L
);

557 
	`loİ£t
(
i
, 
	`Œ“bufãr
(
t
)[i] = 
¡1
.
cs
[i] | 
¡2
.cs[i]);

559 ià(
	`noç
(
t1
è|| 
t2
->
g
 =ğ
TF®£
)

560 
	`lua_pushv®ue
(
L
, 1);

561 ià(
t1
->
g
 =ğ
TF®£
)

562 
	`lua_pushv®ue
(
L
, 2);

564 
	`ÃwroÙ2sib
(
L
, 
TChoiû
);

566 
	}
}

572 
	$Í_¡¬
 (
lua_S‹
 *
L
) {

573 
size1
;

574 
n
 = ()
	`luaL_checkš‹g”
(
L
, 2);

575 
TT»e
 *
Œ“1
 = 
	`g‘·‰
(
L
, 1, &
size1
);

576 ià(
n
 >= 0) {

577 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, (
n
 + 1è* (
size1
 + 1));

578 ià(
	`nuÎabË
(
Œ“1
))

579 
	`luaL_”rÜ
(
L
, "loop body may‡cceptƒmpty string");

580 
n
--)

581 
Œ“
 = 
	`£qaux
Ñ»e, 
Œ“1
, 
size1
);

582 
Œ“
->
g
 = 
TR•
;

583 
	`memıy
(
	`sib1
(
Œ“
), 
Œ“1
, 
size1
 * (
TT»e
));

586 
TT»e
 *
Œ“
;

587 
n
 = -n;

589 
Œ“
 = 
	`ÃwŒ“
(
L
, 
n
 * (
size1
 + 3) - 1);

590 ; 
n
 > 1;‚--) {

591 
Œ“
->
g
 = 
TChoiû
;»e->
u
.
ps
 = 
n
 * (
size1
 + 3) - 2;

592 
	`sib2
(
Œ“
)->
g
 = 
TTrue
;

593 
Œ“
 = 
	`sib1
(tree);

594 
Œ“
 = 
	`£qaux
Ñ»e, 
Œ“1
, 
size1
);

596 
Œ“
->
g
 = 
TChoiû
;»e->
u
.
ps
 = 
size1
 + 1;

597 
	`sib2
(
Œ“
)->
g
 = 
TTrue
;

598 
	`memıy
(
	`sib1
(
Œ“
), 
Œ“1
, 
size1
 * (
TT»e
));

600 
	`cİykbË
(
L
, 1);

602 
	}
}

608 
	$Í_ªd
 (
lua_S‹
 *
L
) {

609 
	`ÃwroÙ1sib
(
L
, 
TAnd
);

611 
	}
}

617 
	$Í_nÙ
 (
lua_S‹
 *
L
) {

618 
	`ÃwroÙ1sib
(
L
, 
TNÙ
);

620 
	}
}

627 
	$Í_sub
 (
lua_S‹
 *
L
) {

628 
Ch¬£t
 
¡1
, 
¡2
;

629 
s1
, 
s2
;

630 
TT»e
 *
t1
 = 
	`g‘·‰
(
L
, 1, &
s1
);

631 
TT»e
 *
t2
 = 
	`g‘·‰
(
L
, 2, &
s2
);

632 ià(
	`toch¬£t
(
t1
, &
¡1
è&&och¬£t(
t2
, &
¡2
)) {

633 
TT»e
 *
t
 = 
	`Ãwch¬£t
(
L
);

634 
	`loİ£t
(
i
, 
	`Œ“bufãr
(
t
)[i] = 
¡1
.
cs
[i] & ~
¡2
.cs[i]);

637 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, 2 + 
s1
 + 
s2
);

638 
Œ“
->
g
 = 
TSeq
;

639 
Œ“
->
u
.
ps
 = 2 + 
s2
;

640 
	`sib1
(
Œ“
)->
g
 = 
TNÙ
;

641 
	`memıy
(
	`sib1
(sib1(
Œ“
)), 
t2
, 
s2
 * (
TT»e
));

642 
	`memıy
(
	`sib2
(
Œ“
), 
t1
, 
s1
 * (
TT»e
));

643 
	`joškbËs
(
L
, 1, 
	`sib1
(
Œ“
), 2);

646 
	}
}

649 
	$Í_£t
 (
lua_S‹
 *
L
) {

650 
size_t
 
l
;

651 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

652 
TT»e
 *
Œ“
 = 
	`Ãwch¬£t
(
L
);

653 
l
--) {

654 
	`£tch¬
(
	`Œ“bufãr
(
Œ“
), (
by‹
)(*
s
));

655 
s
++;

658 
	}
}

661 
	$Í_¿nge
 (
lua_S‹
 *
L
) {

662 
¬g
;

663 
tİ
 = 
	`lua_g‘tİ
(
L
);

664 
TT»e
 *
Œ“
 = 
	`Ãwch¬£t
(
L
);

665 
¬g
 = 1;‡rg <ğ
tİ
;‡rg++) {

666 
c
;

667 
size_t
 
l
;

668 cÚ¡ *
r
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
l
);

669 
	`luaL_¬gcheck
(
L
, 
l
 =ğ2, 
¬g
, "range must havewo characters");

670 
c
 = (
by‹
)
r
[0]; c <= (byte)r[1]; c++)

671 
	`£tch¬
(
	`Œ“bufãr
(
Œ“
), 
c
);

674 
	}
}

680 
	$Í_behšd
 (
lua_S‹
 *
L
) {

681 
TT»e
 *
Œ“
;

682 
TT»e
 *
Œ“1
 = 
	`g‘·‰
(
L
, 1, 
NULL
);

683 
n
 = 
	`fixedËn
(
Œ“1
);

684 
	`luaL_¬gcheck
(
L
, 
n
 >= 0, 1, "pattern may‚ot have fixed†ength");

685 
	`luaL_¬gcheck
(
L
, !
	`hasÿ±u»s
(
Œ“1
), 1, "pattern have captures");

686 
	`luaL_¬gcheck
(
L
, 
n
 <ğ
MAXBEHIND
, 1, "patternoo†ongo†ook behind");

687 
Œ“
 = 
	`ÃwroÙ1sib
(
L
, 
TBehšd
);

688 
Œ“
->
u
.
n
 =‚;

690 
	}
}

696 
	$Í_V
 (
lua_S‹
 *
L
) {

697 
TT»e
 *
Œ“
 = 
	`ÃwËaf
(
L
, 
TO³nC®l
);

698 
	`luaL_¬gcheck
(
L
, !
	`lua_i¢ÚeÜn
(L, 1), 1, "non-nil valueƒxpected");

699 
Œ“
->
key
 = 
	`addtÚewkbË
(
L
, 0, 1);

701 
	}
}

709 
	$ÿ±u»_aux
 (
lua_S‹
 *
L
, 
ÿp
, 
Ïb–idx
) {

710 
TT»e
 *
Œ“
 = 
	`ÃwroÙ1sib
(
L
, 
TC­tu»
);

711 
Œ“
->
ÿp
 = cap;

712 
Œ“
->
key
 = (
Ïb–idx
 =ğ0è? 0 : 
	`addtÚewkbË
(
L
, 1,†abelidx);

714 
	}
}

720 
TT»e
 *
	$auxem±yÿp
 (
TT»e
 *
Œ“
, 
ÿp
) {

721 
Œ“
->
g
 = 
TC­tu»
;

722 
Œ“
->
ÿp
 = cap;

723 
	`sib1
(
Œ“
)->
g
 = 
TTrue
;

724  
Œ“
;

725 
	}
}

731 
TT»e
 *
	$Ãwem±yÿp
 (
lua_S‹
 *
L
, 
ÿp
) {

732  
	`auxem±yÿp
(
	`ÃwŒ“
(
L
, 2), 
ÿp
);

733 
	}
}

739 
TT»e
 *
	$Ãwem±yÿpkey
 (
lua_S‹
 *
L
, 
ÿp
, 
idx
) {

740 
TT»e
 *
Œ“
 = 
	`auxem±yÿp
(
	`ÃwŒ“
(
L
, 2), 
ÿp
);

741 
Œ“
->
key
 = 
	`addtÚewkbË
(
L
, 0, 
idx
);

742  
Œ“
;

743 
	}
}

750 
	$Í_divÿ±u»
 (
lua_S‹
 *
L
) {

751 
	`lua_ty³
(
L
, 2)) {

752 
LUA_TFUNCTION
:  
	`ÿ±u»_aux
(
L
, 
CfunùiÚ
, 2);

753 
LUA_TTABLE
:  
	`ÿ±u»_aux
(
L
, 
Cqu”y
, 2);

754 
LUA_TSTRING
:  
	`ÿ±u»_aux
(
L
, 
C¡ršg
, 2);

755 
LUA_TNUMBER
: {

756 
n
 = 
	`lua_toš‹g”
(
L
, 2);

757 
TT»e
 *
Œ“
 = 
	`ÃwroÙ1sib
(
L
, 
TC­tu»
);

758 
	`luaL_¬gcheck
(
L
, 0 <ğ
n
 &&‚ <ğ
SHRT_MAX
, 1, "invalid‚umber");

759 
Œ“
->
ÿp
 = 
Cnum
;

760 
Œ“
->
key
 = 
n
;

763 :  
	`luaL_¬g”rÜ
(
L
, 2, "invalid„eplacement value");

765 
	}
}

768 
	$Í_sub¡ÿ±u»
 (
lua_S‹
 *
L
) {

769  
	`ÿ±u»_aux
(
L
, 
Csub¡
, 0);

770 
	}
}

773 
	$Í_bËÿ±u»
 (
lua_S‹
 *
L
) {

774  
	`ÿ±u»_aux
(
L
, 
CbË
, 0);

775 
	}
}

778 
	$Í_groupÿ±u»
 (
lua_S‹
 *
L
) {

779 ià(
	`lua_i¢ÚeÜn
(
L
, 2))

780  
	`ÿ±u»_aux
(
L
, 
Cgroup
, 0);

782  
	`ÿ±u»_aux
(
L
, 
Cgroup
, 2);

783 
	}
}

786 
	$Í_fŞdÿ±u»
 (
lua_S‹
 *
L
) {

787 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

788  
	`ÿ±u»_aux
(
L
, 
CfŞd
, 2);

789 
	}
}

792 
	$Í_sim¶eÿ±u»
 (
lua_S‹
 *
L
) {

793  
	`ÿ±u»_aux
(
L
, 
Csim¶e
, 0);

794 
	}
}

797 
	$Í_posÿ±u»
 (
lua_S‹
 *
L
) {

798 
	`Ãwem±yÿp
(
L
, 
Cpos™iÚ
);

800 
	}
}

803 
	$Í_¬gÿ±u»
 (
lua_S‹
 *
L
) {

804 
n
 = ()
	`luaL_checkš‹g”
(
L
, 1);

805 
TT»e
 *
Œ“
 = 
	`Ãwem±yÿp
(
L
, 
C¬g
);

806 
Œ“
->
key
 = 
n
;

807 
	`luaL_¬gcheck
(
L
, 0 < 
n
 &&‚ <ğ
SHRT_MAX
, 1, "invalid‡rgument index");

809 
	}
}

812 
	$Í_back»f
 (
lua_S‹
 *
L
) {

813 
	`luaL_checkªy
(
L
, 1);

814 
	`Ãwem±yÿpkey
(
L
, 
Cback»f
, 1);

816 
	}
}

822 
	$Í_cÚ¡ÿ±u»
 (
lua_S‹
 *
L
) {

823 
i
;

824 
n
 = 
	`lua_g‘tİ
(
L
);

825 ià(
n
 == 0)

826 
	`ÃwËaf
(
L
, 
TTrue
);

827 ià(
n
 == 1)

828 
	`Ãwem±yÿpkey
(
L
, 
CcÚ¡
, 1);

830 
TT»e
 *
Œ“
 = 
	`ÃwŒ“
(
L
, 1 + 3 * (
n
 - 1) + 2);

831 
	`ÃwkbË
(
L
, 
n
);

832 
Œ“
->
g
 = 
TC­tu»
;

833 
Œ“
->
ÿp
 = 
Cgroup
;

834 
Œ“
->
key
 = 0;

835 
Œ“
 = 
	`sib1
(tree);

836 
i
 = 1; i <ğ
n
 - 1; i++) {

837 
Œ“
->
g
 = 
TSeq
;

838 
Œ“
->
u
.
ps
 = 3;

839 
	`auxem±yÿp
(
	`sib1
(
Œ“
), 
CcÚ¡
);

840 
	`sib1
(
Œ“
)->
key
 = 
	`addtokbË
(
L
, 
i
);

841 
Œ“
 = 
	`sib2
(tree);

843 
	`auxem±yÿp
(
Œ“
, 
CcÚ¡
);

844 
Œ“
->
key
 = 
	`addtokbË
(
L
, 
i
);

847 
	}
}

850 
	$Í_m©chtime
 (
lua_S‹
 *
L
) {

851 
TT»e
 *
Œ“
;

852 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

853 
Œ“
 = 
	`ÃwroÙ1sib
(
L
, 
TRunTime
);

854 
Œ“
->
key
 = 
	`addtÚewkbË
(
L
, 1, 2);

856 
	}
}

872 
	$g‘fœ¡ruË
 (
lua_S‹
 *
L
, 
¬g
, 
po¡ab
) {

873 
	`lua_¿wg‘i
(
L
, 
¬g
, 1);

874 ià(
	`lua_is¡ršg
(
L
, -1)) {

875 
	`lua_pushv®ue
(
L
, -1);

876 
	`lua_g‘bË
(
L
, 
¬g
);

879 
	`lua_pushš‹g”
(
L
, 1);

880 
	`lua_š£¹
(
L
, -2);

882 ià(!
	`‹¡·‰”n
(
L
, -1)) {

883 ià(
	`lua_i¢
(
L
, -1))

884 
	`luaL_”rÜ
(
L
, "grammar has‚o initial„ule");

886 
	`luaL_”rÜ
(
L
, "š™ŸÈruË '%s' i nÙ‡…©‹º", 
	`lua_to¡ršg
(L, -2));

888 
	`lua_pushv®ue
(
L
, -2);

889 
	`lua_pushš‹g”
(
L
, 1);

890 
	`lua_£‰abË
(
L
, 
po¡ab
);

891 
	}
}

901 
	$cŞËùruËs
 (
lua_S‹
 *
L
, 
¬g
, *
tÙ®size
) {

902 
n
 = 1;

903 
po¡ab
 = 
	`lua_g‘tİ
(
L
) + 1;

904 
size
;

905 
	`lua_ÃwbË
(
L
);

906 
	`g‘fœ¡ruË
(
L
, 
¬g
, 
po¡ab
);

907 
size
 = 2 + 
	`g‘size
(
L
, 
po¡ab
 + 2);

908 
	`lua_pushn
(
L
);

909 
	`lua_Ãxt
(
L
, 
¬g
) != 0) {

910 ià(
	`lua_tÚumb”
(
L
, -2) == 1 ||

911 
	`Í_equ®
(
L
, -2, 
po¡ab
 + 1)) {

912 
	`lua_pİ
(
L
, 1);

915 ià(!
	`‹¡·‰”n
(
L
, -1))

916 
	`luaL_”rÜ
(
L
, "ruË '%s' i nÙ‡…©‹º", 
	`v®2¡r
(L, -2));

917 
	`luaL_check¡ack
(
L
, 
LUA_MINSTACK
, "grammar hasoo many„ules");

918 
	`lua_pushv®ue
(
L
, -2);

919 
	`lua_pushš‹g”
(
L
, 
size
);

920 
	`lua_£‰abË
(
L
, 
po¡ab
);

921 
size
 +ğ1 + 
	`g‘size
(
L
, -1);

922 
	`lua_pushv®ue
(
L
, -2);

923 
n
++;

925 *
tÙ®size
 = 
size
 + 1;

926  
n
;

927 
	}
}

930 
	$budg¿mm¬
 (
lua_S‹
 *
L
, 
TT»e
 *
g¿mm¬
, 
äuË
, 
n
) {

931 
i
;

932 
TT»e
 *
nd
 = 
	`sib1
(
g¿mm¬
);

933 
i
 = 0; i < 
n
; i++) {

934 
ridx
 = 
äuË
 + 2*
i
 + 1;

935 
ruËsize
;

936 
TT»e
 *
º
 = 
	`g‘Œ“
(
L
, 
ridx
, &
ruËsize
);

937 
nd
->
g
 = 
TRuË
;

938 
nd
->
key
 = 0;

939 
nd
->
ÿp
 = 
i
;

940 
nd
->
u
.
ps
 = 
ruËsize
 + 1;

941 
	`memıy
(
	`sib1
(
nd
), 
º
, 
ruËsize
 * (
TT»e
));

942 
	`m”gekbË
(
L
, 
ridx
, 
	`sib1
(
nd
));

943 
nd
 = 
	`sib2
(nd);

945 
nd
->
g
 = 
TTrue
;

946 
	}
}

952 
	$checkloİs
 (
TT»e
 *
Œ“
) {

953 
ÿÎ
:

954 ià(
Œ“
->
g
 =ğ
TR•
 && 
	`nuÎabË
(
	`sib1
(tree)))

956 ià(
Œ“
->
g
 =ğ
TG¿mm¬
)

959 
numsiblšgs
[
Œ“
->
g
]) {

961 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

963 ià(
	`checkloİs
(
	`sib1
(
Œ“
)))  1;

965 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

966 : 
	`as£¹
(
numsiblšgs
[
Œ“
->
g
] == 0);  0;

969 
	}
}

977 
	$v”ify”rÜ
 (
lua_S‹
 *
L
, *
·s£d
, 
Åas£d
) {

978 
i
, 
j
;

979 
i
 = 
Åas£d
 - 1; i >= 0; i--) {

980 
j
 = 
i
 - 1; j >= 0; j--) {

981 ià(
·s£d
[
i
] =ğ·s£d[
j
]) {

982 
	`lua_¿wg‘i
(
L
, -1, 
·s£d
[
i
]);

983  
	`luaL_”rÜ
(
L
, "ruË '%s' may bËá„ecursive", 
	`v®2¡r
(L, -1));

987  
	`luaL_”rÜ
(
L
, "too many†eft calls in grammar");

988 
	}
}

1002 
	$v”ifyruË
 (
lua_S‹
 *
L
, 
TT»e
 *
Œ“
, *
·s£d
, 
Åas£d
,

1003 
nb
) {

1004 
ÿÎ
:

1005 
Œ“
->
g
) {

1006 
TCh¬
: 
TS‘
: 
TAny
:

1007 
TF®£
:

1008  
nb
;

1009 
TTrue
:

1010 
TBehšd
:

1012 
TNÙ
: 
TAnd
: 
TR•
:

1014 
Œ“
 = 
	`sib1
Ñ»e); 
nb
 = 1; 
ÿÎ
;

1015 
TC­tu»
: 
TRunTime
:

1017 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

1018 
TC®l
:

1020 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

1021 
TSeq
:

1022 ià(!
	`v”ifyruË
(
L
, 
	`sib1
(
Œ“
), 
·s£d
, 
Åas£d
, 0))

1023  
nb
;

1025 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

1026 
TChoiû
:

1027 
nb
 = 
	`v”ifyruË
(
L
, 
	`sib1
(
Œ“
), 
·s£d
, 
Åas£d
,‚b);

1029 
Œ“
 = 
	`sib2
Ñ»e); 
ÿÎ
;

1030 
TRuË
:

1031 ià(
Åas£d
 >ğ
MAXRULES
)

1032  
	`v”ify”rÜ
(
L
, 
·s£d
, 
Åas£d
);

1034 
·s£d
[
Åas£d
++] = 
Œ“
->
key
;

1036 
Œ“
 = 
	`sib1
Ñ»e); 
ÿÎ
;

1038 
TG¿mm¬
:

1039  
	`nuÎabË
(
Œ“
);

1040 : 
	`as£¹
(0);  0;

1042 
	}
}

1045 
	$v”ifyg¿mm¬
 (
lua_S‹
 *
L
, 
TT»e
 *
g¿mm¬
) {

1046 
·s£d
[
MAXRULES
];

1047 
TT»e
 *
ruË
;

1049 
ruË
 = 
	`sib1
(
g¿mm¬
);„uË->
g
 =ğ
TRuË
;„uË = 
	`sib2
(rule)) {

1050 ià(
ruË
->
key
 == 0) ;

1051 
	`v”ifyruË
(
L
, 
	`sib1
(
ruË
), 
·s£d
, 0, 0);

1053 
	`as£¹
(
ruË
->
g
 =ğ
TTrue
);

1055 
ruË
 = 
	`sib1
(
g¿mm¬
);„uË->
g
 =ğ
TRuË
;„uË = 
	`sib2
(rule)) {

1056 ià(
ruË
->
key
 == 0) ;

1057 ià(
	`checkloİs
(
	`sib1
(
ruË
))) {

1058 
	`lua_¿wg‘i
(
L
, -1, 
ruË
->
key
);

1059 
	`luaL_”rÜ
(
L
, "em±y†oİ iÀruË '%s'", 
	`v®2¡r
(L, -1));

1062 
	`as£¹
(
ruË
->
g
 =ğ
TTrue
);

1063 
	}
}

1069 
	$š™ŸÌuËÇme
 (
lua_S‹
 *
L
, 
TT»e
 *
g¿mm¬
, 
äuË
) {

1070 ià(
	`sib1
(
g¿mm¬
)->
key
 == 0) {

1071 
n
 = 
	`lua_¿wËn
(
L
, -1) + 1;

1072 
	`lua_pushv®ue
(
L
, 
äuË
);

1073 
	`lua_¿w£ti
(
L
, -2, 
n
);

1074 
	`sib1
(
g¿mm¬
)->
key
 = 
n
;

1076 
	}
}

1079 
TT»e
 *
	$Ãwg¿mm¬
 (
lua_S‹
 *
L
, 
¬g
) {

1080 
Œ“size
;

1081 
äuË
 = 
	`lua_g‘tİ
(
L
) + 2;

1082 
n
 = 
	`cŞËùruËs
(
L
, 
¬g
, &
Œ“size
);

1083 
TT»e
 *
g
 = 
	`ÃwŒ“
(
L
, 
Œ“size
);

1084 
	`luaL_¬gcheck
(
L
, 
n
 <ğ
MAXRULES
, 
¬g
, "grammar hasoo many„ules");

1085 
g
->
g
 = 
TG¿mm¬
; g->
u
.
n
 =‚;

1086 
	`lua_ÃwbË
(
L
);

1087 
	`lua_£tu£rv®ue
(
L
, -2);

1088 
	`budg¿mm¬
(
L
, 
g
, 
äuË
, 
n
);

1089 
	`lua_g‘u£rv®ue
(
L
, -1);

1090 
	`fš®fix
(
L
, 
äuË
 - 1, 
g
, 
	`sib1
(g));

1091 
	`š™ŸÌuËÇme
(
L
, 
g
, 
äuË
);

1092 
	`v”ifyg¿mm¬
(
L
, 
g
);

1093 
	`lua_pİ
(
L
, 1);

1094 
	`lua_š£¹
(
L
, -(
n
 * 2 + 2));

1095 
	`lua_pİ
(
L
, 
n
 * 2 + 1);

1096  
g
;

1097 
	}
}

1102 
In¡ruùiÚ
 *
	$´•compe
 (
lua_S‹
 *
L
, 
P©‹º
 *
p
, 
idx
) {

1103 
	`lua_g‘u£rv®ue
(
L
, 
idx
);

1104 
	`fš®fix
(
L
, 0, 
NULL
, 
p
->
Œ“
);

1105 
	`lua_pİ
(
L
, 1);

1106  
	`compe
(
L
, 
p
);

1107 
	}
}

1110 
	$Í_´š‰»e
 (
lua_S‹
 *
L
) {

1111 
TT»e
 *
Œ“
 = 
	`g‘·‰
(
L
, 1, 
NULL
);

1112 
c
 = 
	`lua_toboŞ—n
(
L
, 2);

1113 ià(
c
) {

1114 
	`lua_g‘u£rv®ue
(
L
, 1);

1115 
	`fš®fix
(
L
, 0, 
NULL
, 
Œ“
);

1116 
	`lua_pİ
(
L
, 1);

1118 
	`´štkbË
(
L
, 1);

1119 
	`´š‰»e
(
Œ“
, 0);

1121 
	}
}

1124 
	$Í_´štcode
 (
lua_S‹
 *
L
) {

1125 
P©‹º
 *
p
 = 
	`g‘·‰”n
(
L
, 1);

1126 
	`´štkbË
(
L
, 1);

1127 ià(
p
->
code
 =ğ
NULL
)

1128 
	`´•compe
(
L
, 
p
, 1);

1129 
	`´š©t
(
p
->
code
,…->
codesize
);

1131 
	}
}

1138 
size_t
 
	$š™pos™iÚ
 (
lua_S‹
 *
L
, 
size_t
 
Ën
) {

1139 
lua_IÁeg”
 
ii
 = 
	`luaL_İtš‹g”
(
L
, 3, 1);

1140 ià(
ii
 > 0) {

1141 ià((
size_t
)
ii
 <ğ
Ën
)

1142  (
size_t
)
ii
 - 1;

1143  
Ën
;

1146 ià((
size_t
)(-
ii
è<ğ
Ën
)

1147  
Ën
 - ((
size_t
)(-
ii
));

1150 
	}
}

1156 
	$Í_m©ch
 (
lua_S‹
 *
L
) {

1157 
C­tu»
 
ÿ±u»
[
INITCAPSIZE
];

1158 cÚ¡ *
r
;

1159 
size_t
 
l
;

1160 
P©‹º
 *
p
 = (
	`g‘·‰
(
L
, 1, 
NULL
), 
	`g‘·‰”n
(L, 1));

1161 
In¡ruùiÚ
 *
code
 = (
p
->cod!ğ
NULL
è?…->cod: 
	`´•compe
(
L
,…, 1);

1162 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
SUBJIDX
, &
l
);

1163 
size_t
 
i
 = 
	`š™pos™iÚ
(
L
, 
l
);

1164 
±İ
 = 
	`lua_g‘tİ
(
L
);

1165 
	`lua_pushn
(
L
);

1166 
	`lua_pushlightu£rd©a
(
L
, 
ÿ±u»
);

1167 
	`lua_g‘u£rv®ue
(
L
, 1);

1168 
r
 = 
	`m©ch
(
L
, 
s
, s + 
i
, s + 
l
, 
code
, 
ÿ±u»
, 
±İ
);

1169 ià(
r
 =ğ
NULL
) {

1170 
	`lua_pushn
(
L
);

1173  
	`g‘ÿ±u»s
(
L
, 
s
, 
r
, 
±İ
);

1174 
	}
}

1185 
	#MAXLIM
 (
INT_MAX
 / 100)

	)

1187 
	$Í_£tmax
 (
lua_S‹
 *
L
) {

1188 
lua_IÁeg”
 
lim
 = 
	`luaL_checkš‹g”
(
L
, 1);

1189 
	`luaL_¬gcheck
(
L
, 0 < 
lim
 &&†im <ğ
MAXLIM
, 1, "out of„ange");

1190 
	`lua_£‰İ
(
L
, 1);

1191 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
MAXSTACKIDX
);

1193 
	}
}

1196 
	$Í_v”siÚ
 (
lua_S‹
 *
L
) {

1197 
	`lua_push¡ršg
(
L
, 
VERSION
);

1199 
	}
}

1202 
	$Í_ty³
 (
lua_S‹
 *
L
) {

1203 ià(
	`‹¡·‰”n
(
L
, 1))

1204 
	`lua_pushl™”®
(
L
, "pattern");

1206 
	`lua_pushn
(
L
);

1208 
	}
}

1211 
	$Í_gc
 (
lua_S‹
 *
L
) {

1212 
P©‹º
 *
p
 = 
	`g‘·‰”n
(
L
, 1);

1213 
	`»®loccode
(
L
, 
p
, 0);

1215 
	}
}

1218 
ü—‹ÿt
 (
lua_S‹
 *
L
, cÚ¡ *
ÿŠame
, (
ÿtf
) ()) {

1219 
TT»e
 *
t
 = 
	`Ãwch¬£t
(
L
);

1220 
i
;

1221 
i
 = 0; i <ğ
UCHAR_MAX
; i++)

1222 ià(
	`ÿtf
(
i
)è
	`£tch¬
(
	`Œ“bufãr
(
t
), i);

1223 
	`lua_£tf›ld
(
L
, -2, 
ÿŠame
);

1224 
	}
}

1227 
	$Í_loÿË
 (
lua_S‹
 *
L
) {

1228 ià(
	`lua_i¢ÚeÜn
(
L
, 1)) {

1229 
	`lua_£‰İ
(
L
, 0);

1230 
	`lua_ü—‹bË
(
L
, 0, 12);

1233 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

1234 
	`lua_£‰İ
(
L
, 1);

1236 
	`ü—‹ÿt
(
L
, "®num", 
i§Êum
);

1237 
	`ü—‹ÿt
(
L
, "®pha", 
i§Íha
);

1238 
	`ü—‹ÿt
(
L
, "úŒl", 
isúŒl
);

1239 
	`ü—‹ÿt
(
L
, "dig™", 
isdig™
);

1240 
	`ü—‹ÿt
(
L
, "g¿ph", 
isg¿ph
);

1241 
	`ü—‹ÿt
(
L
, "low”", 
i¦ow”
);

1242 
	`ü—‹ÿt
(
L
, "´št", 
i¥ršt
);

1243 
	`ü—‹ÿt
(
L
, "punù", 
i¥unù
);

1244 
	`ü—‹ÿt
(
L
, "¥aû", 
is¥aû
);

1245 
	`ü—‹ÿt
(
L
, "uµ”", 
isuµ”
);

1246 
	`ü—‹ÿt
(
L
, "xdig™", 
isxdig™
);

1248 
	}
}

1251 
luaL_Reg
 
	g·‰»g
[] = {

1252 {"±»e", 
Í_´š‰»e
},

1253 {"pcode", 
Í_´štcode
},

1254 {"m©ch", 
Í_m©ch
},

1255 {"B", 
Í_behšd
},

1256 {"V", 
Í_V
},

1257 {"C", 
Í_sim¶eÿ±u»
},

1258 {"Cc", 
Í_cÚ¡ÿ±u»
},

1259 {"Cmt", 
Í_m©chtime
},

1260 {"Cb", 
Í_back»f
},

1261 {"C¬g", 
Í_¬gÿ±u»
},

1262 {"Cp", 
Í_posÿ±u»
},

1263 {"Cs", 
Í_sub¡ÿ±u»
},

1264 {"Ct", 
Í_bËÿ±u»
},

1265 {"Cf", 
Í_fŞdÿ±u»
},

1266 {"Cg", 
Í_groupÿ±u»
},

1267 {"P", 
Í_P
},

1268 {"S", 
Í_£t
},

1269 {"R", 
Í_¿nge
},

1270 {"loÿË", 
Í_loÿË
},

1271 {"v”siÚ", 
Í_v”siÚ
},

1272 {"£tmax¡ack", 
Í_£tmax
},

1273 {"ty³", 
Í_ty³
},

1274 {
NULL
, NULL}

1278 
luaL_Reg
 
	gm‘¬eg
[] = {

1279 {"__mul", 
Í_£q
},

1280 {"__add", 
Í_choiû
},

1281 {"__pow", 
Í_¡¬
},

1282 {"__gc", 
Í_gc
},

1283 {"__Ën", 
Í_ªd
},

1284 {"__div", 
Í_divÿ±u»
},

1285 {"__unm", 
Í_nÙ
},

1286 {"__sub", 
Í_sub
},

1287 {
NULL
, NULL}

1291 
luaİ’_Íeg
 (
lua_S‹
 *
L
);

1292 
	$luaİ’_Íeg
 (
lua_S‹
 *
L
) {

1293 
	`luaL_Ãwm‘©abË
(
L
, 
PATTERN_T
);

1294 
	`lua_pushnumb”
(
L
, 
MAXBACK
);

1295 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
MAXSTACKIDX
);

1296 
	`luaL_£tfuncs
(
L
, 
m‘¬eg
, 0);

1297 
	`luaL_Ãwlib
(
L
, 
·‰»g
);

1298 
	`lua_pushv®ue
(
L
, -1);

1299 
	`lua_£tf›ld
(
L
, -3, "__index");

1301 
	}
}

	@3rd/lpeg/lptree.h

5 #ià!
defšed
(
ÍŒ“_h
)

6 
	#ÍŒ“_h


	)

9 
	~"Íty³s.h
"

15 
	eTTag
 {

16 
	mTCh¬
 = 0,

17 
	mTS‘
,

18 
	mTAny
,

19 
	mTTrue
,

20 
	mTF®£
,

21 
	mTR•
,

22 
	mTSeq
,

23 
	mTChoiû
,

24 
	mTNÙ
,

25 
	mTAnd
,

26 
	mTC®l
,

27 
	mTO³nC®l
,

28 
	mTRuË
,

31 
	mTG¿mm¬
,

32 
	mTBehšd
,

33 
	mTC­tu»
,

36 
	mTRunTime


38 } 
	tTTag
;

47 
	sTT»e
 {

48 
by‹
 
	mg
;

49 
by‹
 
	mÿp
;

50 
	mkey
;

52 
	mps
;

53 
	mn
;

54 } 
	mu
;

55 } 
	tTT»e
;

62 
	sP©‹º
 {

63 
In¡ruùiÚ
 *
	mcode
;

64 
	mcodesize
;

65 
TT»e
 
	mŒ“
[1];

66 } 
	tP©‹º
;

70 cÚ¡ 
by‹
 
numsiblšgs
[];

73 
	#sib1
(
t
è(Ñè+ 1)

	)

74 
	#sib2
(
t
è(Ñè+ (t)->
u
.
ps
)

	)

	@3rd/lpeg/lptypes.h

8 #ià!
defšed
(
Íty³s_h
)

9 
	#Íty³s_h


	)

12 #ià!
defšed
(
LPEG_DEBUG
)

13 
	#NDEBUG


	)

16 
	~<as£¹.h
>

17 
	~<lim™s.h
>

19 
	~"lua.h
"

22 
	#VERSION
 "1.0.1"

	)

25 
	#PATTERN_T
 "Íeg-·‰”n"

	)

26 
	#MAXSTACKIDX
 "Íeg-max¡ack"

	)

32 #ià(
LUA_VERSION_NUM
 == 501)

34 
	#Í_equ®
 
lua_equ®


	)

36 
	#lua_g‘u£rv®ue
 
lua_g‘ãnv


	)

37 
	#lua_£tu£rv®ue
 
lua_£tãnv


	)

39 
	#lua_¿wËn
 
lua_objËn


	)

41 
	#luaL_£tfuncs
(
L
,
f
,
n
è
	`luaL_»gi¡”
(L,
NULL
,f)

	)

42 
	#luaL_Ãwlib
(
L
,
f
è
	`luaL_»gi¡”
(L,"Íeg",f)

	)

47 #ià!
defšed
(
Í_equ®
)

48 
	#Í_equ®
(
L
,
idx1
,
idx2
è
	`lua_com·»
(L,(idx1),(idx2),
LUA_OPEQ
)

	)

53 #ià!
defšed
(
MAXBACK
)

54 
	#MAXBACK
 400

	)

59 #ià!
defšed
(
MAXRULES
)

60 
	#MAXRULES
 250

	)

66 
	#INITCAPSIZE
 32

	)

70 
	#SUBJIDX
 2

	)

73 
	#FIXEDARGS
 3

	)

76 
	#ÿ¶i¡idx
(
±İ
è(Õtİè+ 2)

	)

79 
	#kbËidx
(
±İ
è(Õtİè+ 3)

	)

82 
	#¡ackidx
(
±İ
è(Õtİè+ 4)

	)

86 
	tby‹
;

89 
	#BITSPERCHAR
 8

	)

91 
	#CHARSETSIZE
 ((
UCHAR_MAX
/
BITSPERCHAR
è+ 1)

	)

95 
	sCh¬£t
 {

96 
by‹
 
	mcs
[
CHARSETSIZE
];

97 } 
	tCh¬£t
;

101 
	#loİ£t
(
v
,
b
è{ v; v = 0; v < 
CHARSETSIZE
; v++è{b;} }

	)

104 
	#Œ“bufãr
(
t
è((
by‹
 *)(Ñè+ 1))

	)

107 
	#by‹s2¦Ùs
(
n
è((Òè- 1è/ (
TT»e
è+ 1)

	)

110 
	#£tch¬
(
cs
,
b
è((cs)[(bè>> 3] |ğ(1 << ((bè& 7)))

	)

117 
	#g‘kšd
(
İ
è((İ)->
i
.
aux
 & 0xF)

	)

118 
	#g‘off
(
İ
è(((İ)->
i
.
aux
 >> 4è& 0xF)

	)

119 
	#joškšdoff
(
k
,
o
è((kè| ((oè<< 4))

	)

121 
	#MAXOFF
 0xF

	)

122 
	#MAXAUX
 0xFF

	)

126 
	#MAXBEHIND
 
MAXAUX


	)

130 
	#MAXPATTSIZE
 (
SHRT_MAX
 - 10)

	)

134 
	#š¡size
(
l
è((Öè+ (
In¡ruùiÚ
è- 1)/(In¡ruùiÚè+ 1)

	)

138 
	#CHARSETINSTSIZE
 
	`š¡size
(
CHARSETSIZE
)

	)

141 
	#funcš¡size
(
p
è(Õ)->
i
.
aux
 + 2)

	)

145 
	#‹¡ch¬
(
¡
,
c
è((()(¡)[((cè>> 3)] & (1 << ((cè& 7))))

	)

	@3rd/lpeg/lpvm.c

6 
	~<lim™s.h
>

7 
	~<¡ršg.h
>

10 
	~"lua.h
"

11 
	~"Ïuxlib.h
"

13 
	~"Íÿp.h
"

14 
	~"Íty³s.h
"

15 
	~"Ívm.h
"

16 
	~"Í´št.h
"

20 #ià!
defšed
(
INITBACK
)

21 
	#INITBACK
 
MAXBACK


	)

25 
	#g‘off£t
(
p
è((Õè+ 1)->
off£t
)

	)

27 cÚ¡ 
In¡ruùiÚ
 
	ggiveup
 = {{
IGiveup
, 0, 0}};

37 
	sSck
 {

38 cÚ¡ *
	ms
;

39 cÚ¡ 
In¡ruùiÚ
 *
	mp
;

40 
	mÿ¶ev–
;

41 } 
	tSck
;

44 
	#g‘¡ackba£
(
L
, 
±İ
è((
Sck
 *)
	`lua_tou£rd©a
(L, 
	`¡ackidx
Õtİ)))

	)

51 
C­tu»
 *
	$doubËÿp
 (
lua_S‹
 *
L
, 
C­tu»
 *
ÿp
, 
ÿ±İ
,

52 
n
, 
±İ
) {

53 
C­tu»
 *
Ãwc
;

54 ià(
ÿ±İ
 >ğ
INT_MAX
/(()(
C­tu»
) * 2))

55 
	`luaL_”rÜ
(
L
, "too many captures");

56 
Ãwc
 = (
C­tu»
 *)
	`lua_Ãwu£rd©a
(
L
, 
ÿ±İ
 * 2 * (Capture));

57 
	`memıy
(
Ãwc
, 
ÿp
, (
ÿ±İ
 - 
n
è* (
C­tu»
));

58 
	`lua_»¶aû
(
L
, 
	`ÿ¶i¡idx
(
±İ
));

59  
Ãwc
;

60 
	}
}

66 
Sck
 *
	$doubË¡ack
 (
lua_S‹
 *
L
, 
Sck
 **
¡acklim™
, 
±İ
) {

67 
Sck
 *
¡ack
 = 
	`g‘¡ackba£
(
L
, 
±İ
);

68 
Sck
 *
Ãw¡ack
;

69 
n
 = *
¡acklim™
 - 
¡ack
;

70 
max
, 
Ãwn
;

71 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
MAXSTACKIDX
);

72 
max
 = 
	`lua_toš‹g”
(
L
, -1);

73 
	`lua_pİ
(
L
, 1);

74 ià(
n
 >ğ
max
)

75 
	`luaL_”rÜ
(
L
, "backŒack sck ov”æow (cu¼’ˆlim™ i %d)", 
max
);

76 
Ãwn
 = 2 * 
n
;

77 ià(
Ãwn
 > 
max
)‚ewn = max;

78 
Ãw¡ack
 = (
Sck
 *)
	`lua_Ãwu£rd©a
(
L
, 
Ãwn
 * (Stack));

79 
	`memıy
(
Ãw¡ack
, 
¡ack
, 
n
 * (
Sck
));

80 
	`lua_»¶aû
(
L
, 
	`¡ackidx
(
±İ
));

81 *
¡acklim™
 = 
Ãw¡ack
 + 
Ãwn
;

82  
Ãw¡ack
 + 
n
;

83 
	}
}

93 
	$»sdynÿ±u»s
 (
lua_S‹
 *
L
, 
ä
, 
cu¼
, 
lim™
) {

94 
lua_IÁeg”
 
»s
;

95 ià(!
	`lua_toboŞ—n
(
L
, 
ä
)) {

96 
	`lua_£‰İ
(
L
, 
ä
 - 1);

99 ià(
	`lua_isboŞ—n
(
L
, 
ä
))

100 
»s
 = 
cu¼
;

102 
»s
 = 
	`lua_toš‹g”
(
L
, 
ä
) - 1;

103 ià(
»s
 < 
cu¼
 ||„e > 
lim™
)

104 
	`luaL_”rÜ
(
L
, "invalid…osition„eturned by match-time capture");

106 
	`lua_»move
(
L
, 
ä
);

107  
»s
;

108 
	}
}

116 
	$adddynÿ±u»s
 (cÚ¡ *
s
, 
C­tu»
 *
ba£
, 
n
, 
fd
) {

117 
i
;

118 
ba£
[0].
kšd
 = 
Cgroup
;

119 
ba£
[0].
siz
 = 0;

120 
ba£
[0].
idx
 = 0;

121 
i
 = 1; i <ğ
n
; i++) {

122 
ba£
[
i
].
kšd
 = 
CruÁime
;

123 
ba£
[
i
].
siz
 = 1;

124 
ba£
[
i
].
idx
 = 
fd
 + i - 1;

125 
ba£
[
i
].
s
 = s;

127 
ba£
[
i
].
kšd
 = 
Cşo£
;

128 
ba£
[
i
].
siz
 = 1;

129 
ba£
[
i
].
s
 = s;

130 
	}
}

136 
	$»movedynÿp
 (
lua_S‹
 *
L
, 
C­tu»
 *
ÿ±u»
,

137 
Ëv–
, 
Ï¡
) {

138 
id
 = 
	`fšddynÿp
(
ÿ±u»
 + 
Ëv–
, c­tu» + 
Ï¡
);

139 
tİ
 = 
	`lua_g‘tİ
(
L
);

140 ià(
id
 == 0)  0;

141 
	`lua_£‰İ
(
L
, 
id
 - 1);

142  
tİ
 - 
id
 + 1;

143 
	}
}

149 cÚ¡ *
	$m©ch
 (
lua_S‹
 *
L
, cÚ¡ *
o
, cÚ¡ *
s
, cÚ¡ *
e
,

150 
In¡ruùiÚ
 *
İ
, 
C­tu»
 *
ÿ±u»
, 
±İ
) {

151 
Sck
 
¡ackba£
[
INITBACK
];

152 
Sck
 *
¡acklim™
 = 
¡ackba£
 + 
INITBACK
;

153 
Sck
 *
¡ack
 = 
¡ackba£
;

154 
ÿpsize
 = 
INITCAPSIZE
;

155 
ÿ±İ
 = 0;

156 
ndynÿp
 = 0;

157 cÚ¡ 
In¡ruùiÚ
 *
p
 = 
İ
;

158 
¡ack
->
p
 = &
giveup
; sck->
s
 = s; sck->
ÿ¶ev–
 = 0; stack++;

159 
	`lua_pushlightu£rd©a
(
L
, 
¡ackba£
);

161 #ià
	`defšed
(
DEBUG
)

162 
	`´štf
("-------------------------------------\n");

163 
	`´štÿ¶i¡
(
ÿ±u»
, c­tu» + 
ÿ±İ
);

164 
	`´štf
("s: |%s| stck:%d, dyncaps:%d, caps:%d ",

165 
s
, ()(
¡ack
 - 
	`g‘¡ackba£
(
L
, 
±İ
)), 
ndynÿp
, 
ÿ±İ
);

166 
	`´štš¡
(
İ
, 
p
);

168 
	`as£¹
(
	`¡ackidx
(
±İ
è+ 
ndynÿp
 =ğ
	`lua_g‘tİ
(
L
è&&‚dynÿ°<ğ
ÿ±İ
);

169 (
Opcode
)
p
->
i
.
code
) {

170 
IEnd
: {

171 
	`as£¹
(
¡ack
 =ğ
	`g‘¡ackba£
(
L
, 
±İ
) + 1);

172 
ÿ±u»
[
ÿ±İ
].
kšd
 = 
Cşo£
;

173 
ÿ±u»
[
ÿ±İ
].
s
 = 
NULL
;

174  
s
;

176 
IGiveup
: {

177 
	`as£¹
(
¡ack
 =ğ
	`g‘¡ackba£
(
L
, 
±İ
));

178  
NULL
;

180 
IR‘
: {

181 
	`as£¹
(
¡ack
 > 
	`g‘¡ackba£
(
L
, 
±İ
è&& (¡ack - 1)->
s
 =ğ
NULL
);

182 
p
 = (--
¡ack
)->p;

185 
IAny
: {

186 ià(
s
 < 
e
è{ 
p
++; s++; }

187 
ç
;

190 
ITe¡Any
: {

191 ià(
s
 < 
e
è
p
 += 2;

192 
p
 +ğ
	`g‘off£t
(p);

195 
ICh¬
: {

196 ià((
by‹
)*
s
 =ğ
p
->
i
.
aux
 && s < 
e
) {…++; s++; }

197 
ç
;

200 
ITe¡Ch¬
: {

201 ià((
by‹
)*
s
 =ğ
p
->
i
.
aux
 && s < 
e
)… += 2;

202 
p
 +ğ
	`g‘off£t
(p);

205 
IS‘
: {

206 
c
 = (
by‹
)*
s
;

207 ià(
	`‹¡ch¬
((
p
+1)->
buff
, 
c
è&& 
s
 < 
e
)

208 { 
p
 +ğ
CHARSETINSTSIZE
; 
s
++; }

209 
ç
;

212 
ITe¡S‘
: {

213 
c
 = (
by‹
)*
s
;

214 ià(
	`‹¡ch¬
((
p
 + 2)->
buff
, 
c
è&& 
s
 < 
e
)

215 
p
 +ğ1 + 
CHARSETINSTSIZE
;

216 
p
 +ğ
	`g‘off£t
(p);

219 
IBehšd
: {

220 
n
 = 
p
->
i
.
aux
;

221 ià(
n
 > 
s
 - 
o
è
ç
;

222 
s
 -ğ
n
; 
p
++;

225 
IS·n
: {

226 ; 
s
 < 
e
; s++) {

227 
c
 = (
by‹
)*
s
;

228 ià(!
	`‹¡ch¬
((
p
+1)->
buff
, 
c
)) ;

230 
p
 +ğ
CHARSETINSTSIZE
;

233 
IJmp
: {

234 
p
 +ğ
	`g‘off£t
(p);

237 
IChoiû
: {

238 ià(
¡ack
 =ğ
¡acklim™
)

239 
¡ack
 = 
	`doubË¡ack
(
L
, &
¡acklim™
, 
±İ
);

240 
¡ack
->
p
 =… + 
	`g‘off£t
(p);

241 
¡ack
->
s
 = s;

242 
¡ack
->
ÿ¶ev–
 = 
ÿ±İ
;

243 
¡ack
++;

244 
p
 += 2;

247 
IC®l
: {

248 ià(
¡ack
 =ğ
¡acklim™
)

249 
¡ack
 = 
	`doubË¡ack
(
L
, &
¡acklim™
, 
±İ
);

250 
¡ack
->
s
 = 
NULL
;

251 
¡ack
->
p
 =… + 2;

252 
¡ack
++;

253 
p
 +ğ
	`g‘off£t
(p);

256 
IComm™
: {

257 
	`as£¹
(
¡ack
 > 
	`g‘¡ackba£
(
L
, 
±İ
è&& (¡ack - 1)->
s
 !ğ
NULL
);

258 
¡ack
--;

259 
p
 +ğ
	`g‘off£t
(p);

262 
IP¬tŸlComm™
: {

263 
	`as£¹
(
¡ack
 > 
	`g‘¡ackba£
(
L
, 
±İ
è&& (¡ack - 1)->
s
 !ğ
NULL
);

264 (
¡ack
 - 1)->
s
 = s;

265 (
¡ack
 - 1)->
ÿ¶ev–
 = 
ÿ±İ
;

266 
p
 +ğ
	`g‘off£t
(p);

269 
IBackComm™
: {

270 
	`as£¹
(
¡ack
 > 
	`g‘¡ackba£
(
L
, 
±İ
è&& (¡ack - 1)->
s
 !ğ
NULL
);

271 
s
 = (--
¡ack
)->s;

272 
ÿ±İ
 = 
¡ack
->
ÿ¶ev–
;

273 
p
 +ğ
	`g‘off£t
(p);

276 
IFaTwiû
:

277 
	`as£¹
(
¡ack
 > 
	`g‘¡ackba£
(
L
, 
±İ
));

278 
¡ack
--;

280 
IFa
:

281 
ç
: {

283 
	`as£¹
(
¡ack
 > 
	`g‘¡ackba£
(
L
, 
±İ
));

284 
s
 = (--
¡ack
)->s;

285 } 
s
 =ğ
NULL
);

286 ià(
ndynÿp
 > 0)

287 
ndynÿp
 -ğ
	`»movedynÿp
(
L
, 
ÿ±u»
, 
¡ack
->
ÿ¶ev–
, 
ÿ±İ
);

288 
ÿ±İ
 = 
¡ack
->
ÿ¶ev–
;

289 
p
 = 
¡ack
->p;

290 #ià
	`defšed
(
DEBUG
)

291 
	`´štf
("**FAIL**\n");

295 
IClo£RunTime
: {

296 
C­S‹
 
cs
;

297 
»m
, 
»s
, 
n
;

298 
ä
 = 
	`lua_g‘tİ
(
L
) + 1;

299 
cs
.
s
 = 
o
; cs.
L
 = L; cs.
oÿp
 = 
ÿ±u»
; cs.
±İ
 =…top;

300 
n
 = 
	`ruÁimeÿp
(&
cs
, 
ÿ±u»
 + 
ÿ±İ
, 
s
, &
»m
);

301 
ÿ±İ
 -ğ
n
;

302 
ndynÿp
 -ğ
»m
;

303 
ä
 -ğ
»m
;

304 
»s
 = 
	`»sdynÿ±u»s
(
L
, 
ä
, 
s
 - 
o
, 
e
 - o);

305 ià(
»s
 == -1)

306 
ç
;

307 
s
 = 
o
 + 
»s
;

308 
n
 = 
	`lua_g‘tİ
(
L
è- 
ä
 + 1;

309 
ndynÿp
 +ğ
n
;

310 ià(
n
 > 0) {

311 ià(
ä
 + 
n
 >ğ
SHRT_MAX
)

312 
	`luaL_”rÜ
(
L
, "too many„esults in match-time capture");

313 ià((
ÿ±İ
 +ğ
n
 + 2è>ğ
ÿpsize
) {

314 
ÿ±u»
 = 
	`doubËÿp
(
L
, c­tu», 
ÿ±İ
, 
n
 + 2, 
±İ
);

315 
ÿpsize
 = 2 * 
ÿ±İ
;

318 
	`adddynÿ±u»s
(
s
, 
ÿ±u»
 + 
ÿ±İ
 - 
n
 - 2,‚, 
ä
);

320 
p
++;

323 
IClo£C­tu»
: {

324 cÚ¡ *
s1
 = 
s
;

325 
	`as£¹
(
ÿ±İ
 > 0);

327 ià(
ÿ±u»
[
ÿ±İ
 - 1].
siz
 == 0 &&

328 
s1
 - 
ÿ±u»
[
ÿ±İ
 - 1].
s
 < 
UCHAR_MAX
) {

329 
ÿ±u»
[
ÿ±İ
 - 1].
siz
 = 
s1
 - c­tu»[ÿ±İ - 1].
s
 + 1;

330 
p
++;

334 
ÿ±u»
[
ÿ±İ
].
siz
 = 1;

335 
ÿ±u»
[
ÿ±İ
].
s
 = s;

336 
pushÿ±u»
;

339 
IO³nC­tu»
:

340 
ÿ±u»
[
ÿ±İ
].
siz
 = 0;

341 
ÿ±u»
[
ÿ±İ
].
s
 = s;

342 
pushÿ±u»
;

343 
IFuÎC­tu»
:

344 
ÿ±u»
[
ÿ±İ
].
siz
 = 
	`g‘off
(
p
) + 1;

345 
ÿ±u»
[
ÿ±İ
].
s
 = s - 
	`g‘off
(
p
);

347 
pushÿ±u»
: {

348 
ÿ±u»
[
ÿ±İ
].
idx
 = 
p
->
i
.
key
;

349 
ÿ±u»
[
ÿ±İ
].
kšd
 = 
	`g‘kšd
(
p
);

350 ià(++
ÿ±İ
 >ğ
ÿpsize
) {

351 
ÿ±u»
 = 
	`doubËÿp
(
L
, c­tu», 
ÿ±İ
, 0, 
±İ
);

352 
ÿpsize
 = 2 * 
ÿ±İ
;

354 
p
++;

357 : 
	`as£¹
(0);  
NULL
;

360 
	}
}

	@3rd/lpeg/lpvm.h

5 #ià!
defšed
(
Ívm_h
)

6 
	#Ívm_h


	)

8 
	~"Íÿp.h
"

12 
	eOpcode
 {

13 
	mIAny
,

14 
	mICh¬
,

15 
	mIS‘
,

16 
	mITe¡Any
,

17 
	mITe¡Ch¬
,

18 
	mITe¡S‘
,

19 
	mIS·n
,

20 
	mIBehšd
,

21 
	mIR‘
,

22 
	mIEnd
,

23 
	mIChoiû
,

24 
	mIJmp
,

25 
	mIC®l
,

26 
	mIO³nC®l
,

27 
	mIComm™
,

28 
	mIP¬tŸlComm™
,

29 
	mIBackComm™
,

30 
	mIFaTwiû
,

31 
	mIFa
,

32 
	mIGiveup
,

33 
	mIFuÎC­tu»
,

34 
	mIO³nC­tu»
,

35 
	mIClo£C­tu»
,

36 
	mIClo£RunTime


37 } 
	tOpcode
;

41 
	uIn¡ruùiÚ
 {

42 
	sIn¡
 {

43 
by‹
 
	mcode
;

44 
by‹
 
	maux
;

45 
	mkey
;

46 } 
	mi
;

47 
	moff£t
;

48 
by‹
 
	mbuff
[1];

49 } 
	tIn¡ruùiÚ
;

52 
´š©t
 (
In¡ruùiÚ
 *
p
, 
n
);

53 cÚ¡ *
m©ch
 (
lua_S‹
 *
L
, cÚ¡ *
o
, cÚ¡ *
s
, cÚ¡ *
e
,

54 
In¡ruùiÚ
 *
İ
, 
C­tu»
 *
ÿ±u»
, 
±İ
);

	@3rd/lua-md5/compat-5.2.c

1 
	~"lua.h
"

2 
	~"Ïuxlib.h
"

3 
	~"com·t-5.2.h
"

5 #ià!
defšed
 
LUA_VERSION_NUM
 || LUA_VERSION_NUM==501

9 
	$luaL_£tfuncs
 (
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

10 
	`luaL_check¡ack
(
L
, 
nup
+1, "too many upvalues");

11 ; 
l
->
Çme
 !ğ
NULL
;†++) {

12 
i
;

13 
	`lua_push¡ršg
(
L
, 
l
->
Çme
);

14 
i
 = 0; i < 
nup
; i++)

15 
	`lua_pushv®ue
(
L
, -(
nup
 + 1));

16 
	`lua_pushcşosu»
(
L
, 
l
->
func
, 
nup
);

17 
	`lua_£‰abË
(
L
, -(
nup
 + 3));

19 
	`lua_pİ
(
L
, 
nup
);

20 
	}
}

	@3rd/lua-md5/compat-5.2.h

1 #ià!
defšed
 
LUA_VERSION_NUM


3 
	#luaL_Reg
 
luaL_»g


	)

5 
	#luaL_addch¬
(
B
,
c
) \

6 (()((
B
)->
p
 < ((B)->
bufãr
+
LUAL_BUFFERSIZE
è|| 
	`luaL_´•bufãr
(B)), \

7 (*(
B
)->
p
++ = ()(
c
)))

	)

10 #ià
LUA_VERSION_NUM
==501

12 
	#lua_¿wËn
 
lua_objËn


	)

15 
luaL_£tfuncs
 (
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
);

	@3rd/lua-md5/md5.c

8 
	~<¡ršg.h
>

10 
	~"md5.h
"

13 
	#WORD
 32

	)

14 
	#MASK
 0xFFFFFFFF

	)

15 #ià
__STDC_VERSION__
 >= 199901L

16 
	~<¡dšt.h
>

17 
ušt32_t
 
	tWORD32
;

19 
	tWORD32
;

30 
md5
 (cÚ¡ *
mes§ge
, 
Ën
, *
ouut
);

38 
	#rÙ©e
(
D
, 
num
è(D<<numè| (D>>(
WORD
-num))

	)

41 
	#F
(
x
, 
y
, 
z
è(((xè& (y)è| ((~(x)è& (z)))

	)

42 
	#G
(
x
, 
y
, 
z
è(((xè& (z)è| ((yè& (~(z))))

	)

43 
	#H
(
x
, 
y
, 
z
è((xè^ (yè^ (z))

	)

44 
	#I
(
x
, 
y
, 
z
è((yè^ ((xè| (~(z))))

	)

48 cÚ¡ 
WORD32
 
	gT
[64]={

68 
	$wÜd32toby‹s
 (cÚ¡ 
WORD32
 *
šput
, *
ouut
) {

69 
j
 = 0;

70 
j
<4*4) {

71 
WORD32
 
v
 = *
šput
++;

72 
ouut
[
j
++] = ()(
v
 & 0xff); v >>= 8;

73 
ouut
[
j
++] = ()(
v
 & 0xff); v >>= 8;

74 
ouut
[
j
++] = ()(
v
 & 0xff); v >>= 8;

75 
ouut
[
j
++] = ()(
v
 & 0xff);

77 
	}
}

80 
	$šic_dige¡
(
WORD32
 *
d
) {

81 
d
[0] = 0x67452301;

82 
d
[1] = 0xEFCDAB89;

83 
d
[2] = 0x98BADCFE;

84 
d
[3] = 0x10325476;

85 
	}
}

89 
	$dige¡
(cÚ¡ 
WORD32
 *
m
, WORD32 *
d
) {

90 
j
;

92 
j
=0; j<4*4; j+=4) {

93 
d
[0] = d[0]+ 
	`F
(d[1], d[2], d[3])+ 
m
[
j
] + 
T
[j]; d[0]=
	`rÙ©e
(d[0], 7);

94 
d
[0]+=d[1];

95 
d
[3] = d[3]+ 
	`F
(d[0], d[1], d[2])+ 
m
[(
j
)+1] + 
T
[j+1]; d[3]=
	`rÙ©e
(d[3], 12);

96 
d
[3]+=d[0];

97 
d
[2] = d[2]+ 
	`F
(d[3], d[0], d[1])+ 
m
[(
j
)+2] + 
T
[j+2]; d[2]=
	`rÙ©e
(d[2], 17);

98 
d
[2]+=d[3];

99 
d
[1] = d[1]+ 
	`F
(d[2], d[3], d[0])+ 
m
[(
j
)+3] + 
T
[j+3]; d[1]=
	`rÙ©e
(d[1], 22);

100 
d
[1]+=d[2];

103 
j
=0; j<4*4; j+=4) {

104 
d
[0] = d[0]+ 
	`G
(d[1], d[2], d[3])+ 
m
[(5*
j
+1)&0x0f] + 
T
[(j-1)+17];

105 
d
[0] = 
	`rÙ©e
(d[0],5);

106 
d
[0]+=d[1];

107 
d
[3] = d[3]+ 
	`G
(d[0], d[1], d[2])+ 
m
[((5*(
j
+1)+1)&0x0f)] + 
T
[(j+0)+17];

108 
d
[3] = 
	`rÙ©e
(d[3], 9);

109 
d
[3]+=d[0];

110 
d
[2] = d[2]+ 
	`G
(d[3], d[0], d[1])+ 
m
[((5*(
j
+2)+1)&0x0f)] + 
T
[(j+1)+17];

111 
d
[2] = 
	`rÙ©e
(d[2], 14);

112 
d
[2]+=d[3];

113 
d
[1] = d[1]+ 
	`G
(d[2], d[3], d[0])+ 
m
[((5*(
j
+3)+1)&0x0f)] + 
T
[(j+2)+17];

114 
d
[1] = 
	`rÙ©e
(d[1], 20);

115 
d
[1]+=d[2];

118 
j
=0; j<4*4; j+=4) {

119 
d
[0] = d[0]+ 
	`H
(d[1], d[2], d[3])+ 
m
[(3*
j
+5)&0x0f] + 
T
[(j-1)+33];

120 
d
[0] = 
	`rÙ©e
(d[0], 4);

121 
d
[0]+=d[1];

122 
d
[3] = d[3]+ 
	`H
(d[0], d[1], d[2])+ 
m
[(3*(
j
+1)+5)&0x0f] + 
T
[(j+0)+33];

123 
d
[3] = 
	`rÙ©e
(d[3], 11);

124 
d
[3]+=d[0];

125 
d
[2] = d[2]+ 
	`H
(d[3], d[0], d[1])+ 
m
[(3*(
j
+2)+5)&0x0f] + 
T
[(j+1)+33];

126 
d
[2] = 
	`rÙ©e
(d[2], 16);

127 
d
[2]+=d[3];

128 
d
[1] = d[1]+ 
	`H
(d[2], d[3], d[0])+ 
m
[(3*(
j
+3)+5)&0x0f] + 
T
[(j+2)+33];

129 
d
[1] = 
	`rÙ©e
(d[1], 23);

130 
d
[1]+=d[2];

133 
j
=0; j<4*4; j+=4) {

134 
d
[0] = d[0]+ 
	`I
(d[1], d[2], d[3])+ 
m
[(7*
j
)&0x0f] + 
T
[(j-1)+49];

135 
d
[0] = 
	`rÙ©e
(d[0], 6);

136 
d
[0]+=d[1];

137 
d
[3] = d[3]+ 
	`I
(d[0], d[1], d[2])+ 
m
[(7*(
j
+1))&0x0f] + 
T
[(j+0)+49];

138 
d
[3] = 
	`rÙ©e
(d[3], 10);

139 
d
[3]+=d[0];

140 
d
[2] = d[2]+ 
	`I
(d[3], d[0], d[1])+ 
m
[(7*(
j
+2))&0x0f] + 
T
[(j+1)+49];

141 
d
[2] = 
	`rÙ©e
(d[2], 15);

142 
d
[2]+=d[3];

143 
d
[1] = d[1]+ 
	`I
(d[2], d[3], d[0])+ 
m
[(7*(
j
+3))&0x0f] + 
T
[(j+2)+49];

144 
d
[1] = 
	`rÙ©e
(d[1], 21);

145 
d
[1]+=d[2];

147 
	}
}

150 
	$by‹¡owÜd32
 (
WORD32
 *
x
, cÚ¡ *
±
) {

151 
i
;

152 
i
=0; i<16; i++) {

153 
j
=
i
*4;

154 
x
[
i
] = (((
WORD32
)()
±
[
j
+3] << 8 |

155 (
WORD32
)()
±
[
j
+2]) << 8 |

156 (
WORD32
)()
±
[
j
+1]) << 8 |

157 (
WORD32
)()
±
[
j
];

160 
	}
}

163 
	$put_Ëngth
(
WORD32
 *
x
, 
Ën
) {

165 
x
[14] = (
WORD32
)((
Ën
<<3è& 
MASK
);

166 
x
[15] = (
WORD32
)(
Ën
>>(32-3) & 0x7);

167 
	}
}

176 
	$cÚv”‹
 (
WORD32
 *
x
, cÚ¡ *
±
, 
num
, 
Şd_¡©us
) {

177 
Ãw_¡©us
 = 0;

178 
buff
[64];

179 ià(
num
<64) {

180 
	`memıy
(
buff
, 
±
, 
num
);

181 
	`mem£t
(
buff
+
num
, 0, 64-num);

182 ià(
Şd_¡©us
 == 0)

183 
buff
[
num
] = '\200';

184 
Ãw_¡©us
 = 1;

185 
±
 = 
buff
;

187 
	`by‹¡owÜd32
(
x
, 
±
);

188 ià(
num
 <= (64 - 9))

189 
Ãw_¡©us
 = 2;

190  
Ãw_¡©us
;

191 
	}
}

195 
	$md5
 (cÚ¡ *
mes§ge
, 
Ën
, *
ouut
) {

196 
WORD32
 
d
[4];

197 
¡©us
 = 0;

198 
i
 = 0;

199 
	`šic_dige¡
(
d
);

200 
¡©us
 != 2) {

201 
WORD32
 
d_Şd
[4];

202 
WORD32
 
wbuff
[16];

203 
numby‹s
 = (
Ën
-
i
 >= 64) ? 64 :†en-i;

205 
d_Şd
[0]=
d
[0]; d_old[1]=d[1]; d_old[2]=d[2]; d_old[3]=d[3];

206 
¡©us
 = 
	`cÚv”‹
(
wbuff
, 
mes§ge
+
i
, 
numby‹s
, status);

207 ià(
¡©us
 =ğ2è
	`put_Ëngth
(
wbuff
, 
Ën
);

208 
	`dige¡
(
wbuff
, 
d
);

209 
d
[0]+=
d_Şd
[0]; d[1]+=d_old[1]; d[2]+=d_old[2]; d[3]+=d_old[3];

210 
i
 +ğ
numby‹s
;

212 
	`wÜd32toby‹s
(
d
, 
ouut
);

213 
	}
}

	@3rd/lua-md5/md5.h

8 #iâdeà
md5_h


9 
	#md5_h


	)

11 
	~<lua.h
>

14 
	#HASHSIZE
 16

	)

16 
md5
 (cÚ¡ *
mes§ge
, 
Ën
, *
ouut
);

17 
luaİ’_md5_cÜe
 (
lua_S‹
 *
L
);

	@3rd/lua-md5/md5lib.c

8 
	~<¡dlib.h
>

9 
	~<¡ršg.h
>

10 
	~<time.h
>

12 
	~<lua.h
>

13 
	~<Ïuxlib.h
>

15 
	~"md5.h
"

16 
	~"com·t-5.2.h
"

24 
	$lmd5
 (
lua_S‹
 *
L
) {

25 
buff
[16];

26 
size_t
 
l
;

27 cÚ¡ *
mes§ge
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

28 
	`md5
(
mes§ge
, 
l
, 
buff
);

29 
	`lua_pushl¡ršg
(
L
, 
buff
, 16L);

31 
	}
}

41 
	$ex_Ü
 (
lua_S‹
 *
L
) {

42 
size_t
 
l1
, 
l2
;

43 cÚ¡ *
s1
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l1
);

44 cÚ¡ *
s2
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
l2
);

45 
luaL_Bufãr
 
b
;

46 
	`luaL_¬gcheck
Ğ
L
, 
l1
 =ğ
l2
, 2, "lengths must beƒqual" );

47 
	`luaL_buffš™
(
L
, &
b
);

48 
l1
--è
	`luaL_addch¬
(&
b
, (*
s1
++)^(*
s2
++));

49 
	`luaL_push»suÉ
(&
b
);

51 
	}
}

54 
	$check£ed
 (
lua_S‹
 *
L
) {

55 ià(
	`lua_i¢Úe
(
L
, 3)) {

56 
time_t
 
tm
 = 
	`time
(
NULL
);

57 
	`lua_pushl¡ršg
(
L
, (*)&
tm
, (tm));

59 
	}
}

62 
	#MAXKEY
 256

	)

63 
	#BLOCKSIZE
 16

	)

67 
	$š™block
 (
lua_S‹
 *
L
, cÚ¡ *
£ed
, 
l£ed
, *
block
) {

68 
size_t
 
lkey
;

69 cÚ¡ *
key
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
lkey
);

70 ià(
lkey
 > 
MAXKEY
)

71 
	`luaL_”rÜ
(
L
, "keyoØlÚg (> %d)", 
MAXKEY
);

72 
	`mem£t
(
block
, 0, 
BLOCKSIZE
);

73 
	`memıy
(
block
, 
£ed
, 
l£ed
);

74 
	`memıy
(
block
+
BLOCKSIZE
, 
key
, 
lkey
);

75  ()
lkey
+
BLOCKSIZE
;

76 
	}
}

79 
	$code¡»am
 (
lua_S‹
 *
L
, cÚ¡ *
msg
, 
size_t
 
lmsg
,

80 *
block
, 
lblock
) {

81 
luaL_Bufãr
 
b
;

82 
	`luaL_buffš™
(
L
, &
b
);

83 
lmsg
 > 0) {

84 
code
[
BLOCKSIZE
];

85 
i
;

86 
	`md5
(
block
, 
lblock
, 
code
);

87 
i
=0; i<
BLOCKSIZE
 && 
lmsg
 > 0; i++,†msg--)

88 
code
[
i
] ^ğ*
msg
++;

89 
	`luaL_addl¡ršg
(&
b
, 
code
, 
i
);

90 
	`memıy
(
block
, 
code
, 
i
);

92 
	`luaL_push»suÉ
(&
b
);

93 
	}
}

96 
	$decode¡»am
 (
lua_S‹
 *
L
, cÚ¡ *
cyph”
, 
size_t
 
lcyph”
,

97 *
block
, 
lblock
) {

98 
luaL_Bufãr
 
b
;

99 
	`luaL_buffš™
(
L
, &
b
);

100 
lcyph”
 > 0) {

101 
code
[
BLOCKSIZE
];

102 
i
;

103 
	`md5
(
block
, 
lblock
, 
code
);

104 
i
=0; i<
BLOCKSIZE
 && 
lcyph”
 > 0; i++,†cypher--)

105 
code
[
i
] ^ğ*
cyph”
++;

106 
	`luaL_addl¡ršg
(&
b
, 
code
, 
i
);

107 
	`memıy
(
block
, 
cyph”
-
i
, i);

109 
	`luaL_push»suÉ
(&
b
);

110 
	}
}

123 
	$üy±
 (
lua_S‹
 *
L
) {

124 
size_t
 
lmsg
;

125 cÚ¡ *
msg
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
lmsg
);

126 
size_t
 
l£ed
;

127 cÚ¡ *
£ed
;

128 
lblock
;

129 
block
[
BLOCKSIZE
+
MAXKEY
];

130 
	`check£ed
(
L
);

131 
£ed
 = 
	`luaL_checkl¡ršg
(
L
, 3, &
l£ed
);

132 ià(
l£ed
 > 
BLOCKSIZE
)

133 
	`luaL_”rÜ
(
L
, "£edoØlÚg (> %d)", 
BLOCKSIZE
);

135 
block
[0] = ()
l£ed
;

136 
	`memıy
(
block
+1, 
£ed
, 
l£ed
);

137 
	`lua_pushl¡ršg
(
L
, 
block
, 
l£ed
+1);

138 
lblock
 = 
	`š™block
(
L
, 
£ed
, 
l£ed
, 
block
);

139 
	`code¡»am
(
L
, 
msg
, 
lmsg
, 
block
, 
lblock
);

140 
	`lua_cÚÿt
(
L
, 2);

142 
	}
}

153 
	$deüy±
 (
lua_S‹
 *
L
) {

154 
size_t
 
lcyph”‹xt
;

155 cÚ¡ *
cyph”‹xt
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
lcyph”‹xt
);

156 
size_t
 
l£ed
 = 
cyph”‹xt
[0];

157 cÚ¡ *
£ed
 = 
cyph”‹xt
+1;

158 
lblock
;

159 
block
[
BLOCKSIZE
+
MAXKEY
];

160 
	`luaL_¬gcheck
(
L
, 
lcyph”‹xt
 >ğ
l£ed
+1 &&†£ed <ğ
BLOCKSIZE
, 1,

162 
cyph”‹xt
 +ğ
l£ed
+1;

163 
lcyph”‹xt
 -ğ
l£ed
+1;

164 
lblock
 = 
	`š™block
(
L
, 
£ed
, 
l£ed
, 
block
);

165 
	`decode¡»am
(
L
, 
cyph”‹xt
, 
lcyph”‹xt
, 
block
, 
lblock
);

167 
	}
}

173 
	$£t_šfo
 (
lua_S‹
 *
L
) {

174 
	`lua_pushl™”®
 (
L
, "_COPYRIGHT");

175 
	`lua_pushl™”®
 (
L
, "Copyright (C) 2003-2013 PUC-Rio");

176 
	`lua_£‰abË
 (
L
, -3);

177 
	`lua_pushl™”®
 (
L
, "_DESCRIPTION");

178 
	`lua_pushl™”®
 (
L
, "Basic cryptographic facilities");

179 
	`lua_£‰abË
 (
L
, -3);

180 
	`lua_pushl™”®
 (
L
, "_VERSION");

181 
	`lua_pushl™”®
 (
L
, "MD5 1.2");

182 
	`lua_£‰abË
 (
L
, -3);

183 
	}
}

186 
luaL_Reg
 
	gmd5lib
[] = {

187 {"sum", 
lmd5
},

188 {"exÜ", 
ex_Ü
},

189 {"üy±", 
üy±
},

190 {"deüy±", 
deüy±
},

191 {
NULL
, NULL}

195 
	$luaİ’_md5_cÜe
 (
lua_S‹
 *
L
) {

196 
	`lua_ÃwbË
(
L
);

197 
	`luaL_£tfuncs
(
L
, 
md5lib
, 0);

198 
	`£t_šfo
 (
L
);

200 
	}
}

	@3rd/lua/lapi.c

7 
	#Ïpi_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡d¬g.h
>

14 
	~<¡ršg.h
>

16 
	~"lua.h
"

18 
	~"Ïpi.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lfunc.h
"

22 
	~"lgc.h
"

23 
	~"lmem.h
"

24 
	~"lobjeù.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

29 
	~"lundump.h
"

30 
	~"lvm.h
"

31 
	~"lfunc.h
"

35 cÚ¡ 
	glua_id’t
[] =

36 "$LuaV”siÚ: " 
LUA_COPYRIGHT
 " $"

37 "$LuaAuthÜs: " 
LUA_AUTHORS
 " $";

41 
	#NONVALIDVALUE
 
	`ÿ¡
(
TV®ue
 *, 
luaO_nobjeù
)

	)

44 
	#isv®id
(
o
è((oè!ğ
luaO_nobjeù
)

	)

47 
	#i¥£udo
(
i
è((iè<ğ
LUA_REGISTRYINDEX
)

	)

50 
	#isupv®ue
(
i
è((iè< 
LUA_REGISTRYINDEX
)

	)

53 
	#is¡ackšdex
(
i
, 
o
è(
	`isv®id
(oè&& !
	`i¥£udo
(i))

	)

55 
	#­i_checkv®idšdex
(
l
,
o
è
	`­i_check
Ö, 
	`isv®id
(o), "šv®id index")

	)

57 
	#­i_check¡ackšdex
(
l
, 
i
, 
o
) \

58 
	`­i_check
(
l
, 
	`is¡ackšdex
(
i
, 
o
), "šdex‚Ù iÀth¡ack")

	)

61 
TV®ue
 *
	$šdex2addr
 (
lua_S‹
 *
L
, 
idx
) {

62 
C®lInfo
 *
ci
 = 
L
->ci;

63 ià(
idx
 > 0) {

64 
TV®ue
 *
o
 = 
ci
->
func
 + 
idx
;

65 
	`­i_check
(
L
, 
idx
 <ğ
ci
->
tİ
 - (ci->
func
 + 1), "unacceptable index");

66 ià(
o
 >ğ
L
->
tİ
è 
NONVALIDVALUE
;

67  
o
;

69 ià(!
	`i¥£udo
(
idx
)) {

70 
	`­i_check
(
L
, 
idx
 !ğ0 && -idx <ğL->
tİ
 - (
ci
->
func
 + 1), "invalid index");

71  
L
->
tİ
 + 
idx
;

73 ià(
idx
 =ğ
LUA_REGISTRYINDEX
)

74  &
	`G
(
L
)->
l_»gi¡ry
;

76 
idx
 = 
LUA_REGISTRYINDEX
 - idx;

77 
	`­i_check
(
L
, 
idx
 <ğ
MAXUPVAL
 + 1, "upvalue indexoo†arge");

78 ià(
	`‰i¦cf
(
ci
->
func
))

79  
NONVALIDVALUE
;

81 
CClosu»
 *
func
 = 
	`şCv®ue
(
ci
->func);

82  (
idx
 <ğ
func
->
nupv®ues
è? &func->
upv®ue
[idx-1] : 
NONVALIDVALUE
;

85 
	}
}

92 
	$grow¡ack
 (
lua_S‹
 *
L
, *
ud
) {

93 
size
 = *(*)
ud
;

94 
	`luaD_grow¡ack
(
L
, 
size
);

95 
	}
}

98 
LUA_API
 
	$lua_check¡ack
 (
lua_S‹
 *
L
, 
n
) {

99 
»s
;

100 
C®lInfo
 *
ci
 = 
L
->ci;

101 
	`lua_lock
(
L
);

102 
	`­i_check
(
L
, 
n
 >= 0, "negative 'n'");

103 ià(
L
->
¡ack_Ï¡
 - L->
tİ
 > 
n
)

104 
»s
 = 1;

106 
šu£
 = 
	`ÿ¡_št
(
L
->
tİ
 - L->
¡ack
è+ 
EXTRA_STACK
;

107 ià(
šu£
 > 
LUAI_MAXSTACK
 - 
n
)

108 
»s
 = 0;

110 
»s
 = (
	`luaD_¿wruÅrÙeùed
(
L
, &
grow¡ack
, &
n
è=ğ
LUA_OK
);

112 ià(
»s
 && 
ci
->
tİ
 < 
L
->tİ + 
n
)

113 
ci
->
tİ
 = 
L
->tİ + 
n
;

114 
	`lua_uÆock
(
L
);

115  
»s
;

116 
	}
}

119 
LUA_API
 
	$lua_xmove
 (
lua_S‹
 *
äom
,†ua_S‹ *
to
, 
n
) {

120 
i
;

121 ià(
äom
 =ğ
to
) ;

122 
	`lua_lock
(
to
);

123 
	`­i_checkÃËms
(
äom
, 
n
);

124 
	`­i_check
(
äom
, 
	`G
(äomè=ğG(
to
), "moving‡mong independent states");

125 
	`­i_check
(
äom
, 
to
->
ci
->
tİ
 -o->tİ >ğ
n
, "stack overflow");

126 
äom
->
tİ
 -ğ
n
;

127 
i
 = 0; i < 
n
; i++) {

128 
	`£tobj2s
(
to
,o->
tİ
, 
äom
->tİ + 
i
);

129 
to
->
tİ
++;

131 
	`lua_uÆock
(
to
);

132 
	}
}

135 
LUA_API
 
lua_CFunùiÚ
 
	$lua_©·nic
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
·nicf
) {

136 
lua_CFunùiÚ
 
Şd
;

137 
	`lua_lock
(
L
);

138 
Şd
 = 
	`G
(
L
)->
·nic
;

139 
	`G
(
L
)->
·nic
 = 
·nicf
;

140 
	`lua_uÆock
(
L
);

141  
Şd
;

142 
	}
}

145 
LUA_API
 cÚ¡ 
lua_Numb”
 *
	$lua_v”siÚ
 (
lua_S‹
 *
L
) {

146 cÚ¡ 
lua_Numb”
 
v”siÚ
 = 
LUA_VERSION_NUM
;

147 ià(
L
 =ğ
NULL
è &
v”siÚ
;

148  
	`G
(
L
)->
v”siÚ
;

149 
	}
}

161 
LUA_API
 
	$lua_absšdex
 (
lua_S‹
 *
L
, 
idx
) {

162  (
idx
 > 0 || 
	`i¥£udo
(idx))

163 ? 
idx


164 : 
	`ÿ¡_št
(
L
->
tİ
 - L->
ci
->
func
è+ 
idx
;

165 
	}
}

168 
LUA_API
 
	$lua_g‘tİ
 (
lua_S‹
 *
L
) {

169  
	`ÿ¡_št
(
L
->
tİ
 - (L->
ci
->
func
 + 1));

170 
	}
}

173 
LUA_API
 
	$lua_£‰İ
 (
lua_S‹
 *
L
, 
idx
) {

174 
StkId
 
func
 = 
L
->
ci
->func;

175 
	`lua_lock
(
L
);

176 ià(
idx
 >= 0) {

177 
	`­i_check
(
L
, 
idx
 <ğL->
¡ack_Ï¡
 - (
func
 + 1), "newopoo†arge");

178 
L
->
tİ
 < (
func
 + 1è+ 
idx
)

179 
	`£Šv®ue
(
L
->
tİ
++);

180 
L
->
tİ
 = (
func
 + 1è+ 
idx
;

183 
	`­i_check
(
L
, -(
idx
+1è<ğ(L->
tİ
 - (
func
 + 1)), "invalid‚ewop");

184 
L
->
tİ
 +ğ
idx
+1;

186 
	`lua_uÆock
(
L
);

187 
	}
}

194 
	$»v”£
 (
lua_S‹
 *
L
, 
StkId
 
äom
, StkId 
to
) {

195 ; 
äom
 < 
to
; from++,o--) {

196 
TV®ue
 
‹mp
;

197 
	`£tobj
(
L
, &
‹mp
, 
äom
);

198 
	`£tobjs2s
(
L
, 
äom
, 
to
);

199 
	`£tobj2s
(
L
, 
to
, &
‹mp
);

201 
	}
}

208 
LUA_API
 
	$lua_rÙ©e
 (
lua_S‹
 *
L
, 
idx
, 
n
) {

209 
StkId
 
p
, 
t
, 
m
;

210 
	`lua_lock
(
L
);

211 
t
 = 
L
->
tİ
 - 1;

212 
p
 = 
	`šdex2addr
(
L
, 
idx
);

213 
	`­i_check¡ackšdex
(
L
, 
idx
, 
p
);

214 
	`­i_check
(
L
, (
n
 >ğ0 ?‚ : -nè<ğ(
t
 - 
p
 + 1), "invalid 'n'");

215 
m
 = (
n
 >ğ0 ? 
t
 -‚ : 
p
 -‚ - 1);

216 
	`»v”£
(
L
, 
p
, 
m
);

217 
	`»v”£
(
L
, 
m
 + 1, 
t
);

218 
	`»v”£
(
L
, 
p
, 
t
);

219 
	`lua_uÆock
(
L
);

220 
	}
}

223 
LUA_API
 
	$lua_cİy
 (
lua_S‹
 *
L
, 
äomidx
, 
toidx
) {

224 
TV®ue
 *
ä
, *
to
;

225 
	`lua_lock
(
L
);

226 
ä
 = 
	`šdex2addr
(
L
, 
äomidx
);

227 
to
 = 
	`šdex2addr
(
L
, 
toidx
);

228 
	`­i_checkv®idšdex
(
L
, 
to
);

229 
	`£tobj
(
L
, 
to
, 
ä
);

230 ià(
	`isupv®ue
(
toidx
))

231 
	`luaC_b¬r›r
(
L
, 
	`şCv®ue
(L->
ci
->
func
), 
ä
);

234 
	`lua_uÆock
(
L
);

235 
	}
}

238 
LUA_API
 
	$lua_pushv®ue
 (
lua_S‹
 *
L
, 
idx
) {

239 
	`lua_lock
(
L
);

240 
	`£tobj2s
(
L
, L->
tİ
, 
	`šdex2addr
(L, 
idx
));

241 
	`­i_šü_tİ
(
L
);

242 
	`lua_uÆock
(
L
);

243 
	}
}

252 
LUA_API
 
	$lua_ty³
 (
lua_S‹
 *
L
, 
idx
) {

253 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

254  (
	`isv®id
(
o
è? 
	`‰nov
(oè: 
LUA_TNONE
);

255 
	}
}

258 
LUA_API
 cÚ¡ *
	$lua_ty³Çme
 (
lua_S‹
 *
L
, 
t
) {

259 
	`UNUSED
(
L
);

260 
	`­i_check
(
L
, 
LUA_TNONE
 <ğ
t
 && < 
LUA_NUMTAGS
, "invalidag");

261  
	`‰y³Çme
(
t
);

262 
	}
}

265 
LUA_API
 
	$lua_iscfunùiÚ
 (
lua_S‹
 *
L
, 
idx
) {

266 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

267  (
	`‰i¦cf
(
o
è|| (
	`‰isCşosu»
(o)));

268 
	}
}

271 
LUA_API
 
	$lua_isš‹g”
 (
lua_S‹
 *
L
, 
idx
) {

272 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

273  
	`‰isš‹g”
(
o
);

274 
	}
}

277 
LUA_API
 
	$lua_i¢umb”
 (
lua_S‹
 *
L
, 
idx
) {

278 
lua_Numb”
 
n
;

279 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

280  
	`tÚumb”
(
o
, &
n
);

281 
	}
}

284 
LUA_API
 
	$lua_is¡ršg
 (
lua_S‹
 *
L
, 
idx
) {

285 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

286  (
	`‰is¡ršg
(
o
è|| 
	`cvt2¡r
(o));

287 
	}
}

290 
LUA_API
 
	$lua_isu£rd©a
 (
lua_S‹
 *
L
, 
idx
) {

291 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

292  (
	`‰isfuÎu£rd©a
(
o
è|| 
	`‰i¦ightu£rd©a
(o));

293 
	}
}

296 
LUA_API
 
	$lua_¿wequ®
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
) {

297 
StkId
 
o1
 = 
	`šdex2addr
(
L
, 
šdex1
);

298 
StkId
 
o2
 = 
	`šdex2addr
(
L
, 
šdex2
);

299  (
	`isv®id
(
o1
è&& isv®id(
o2
)è? 
	`luaV_¿wequ®obj
(o1, o2) : 0;

300 
	}
}

303 
LUA_API
 
	$lua_¬™h
 (
lua_S‹
 *
L
, 
İ
) {

304 
	`lua_lock
(
L
);

305 ià(
İ
 !ğ
LUA_OPUNM
 && o°!ğ
LUA_OPBNOT
)

306 
	`­i_checkÃËms
(
L
, 2);

308 
	`­i_checkÃËms
(
L
, 1);

309 
	`£tobjs2s
(
L
, L->
tİ
, L->top - 1);

310 
	`­i_šü_tİ
(
L
);

313 
	`luaO_¬™h
(
L
, 
İ
, L->
tİ
 - 2, L->top - 1, L->top - 2);

314 
L
->
tİ
--;

315 
	`lua_uÆock
(
L
);

316 
	}
}

319 
LUA_API
 
	$lua_com·»
 (
lua_S‹
 *
L
, 
šdex1
, 
šdex2
, 
İ
) {

320 
StkId
 
o1
, 
o2
;

321 
i
 = 0;

322 
	`lua_lock
(
L
);

323 
o1
 = 
	`šdex2addr
(
L
, 
šdex1
);

324 
o2
 = 
	`šdex2addr
(
L
, 
šdex2
);

325 ià(
	`isv®id
(
o1
è&& isv®id(
o2
)) {

326 
İ
) {

327 
LUA_OPEQ
: 
i
 = 
	`luaV_equ®obj
(
L
, 
o1
, 
o2
); ;

328 
LUA_OPLT
: 
i
 = 
	`luaV_Ës¡hª
(
L
, 
o1
, 
o2
); ;

329 
LUA_OPLE
: 
i
 = 
	`luaV_Ës£qu®
(
L
, 
o1
, 
o2
); ;

330 : 
	`­i_check
(
L
, 0, "invalid option");

333 
	`lua_uÆock
(
L
);

334  
i
;

335 
	}
}

338 
LUA_API
 
size_t
 
	$lua_¡ršgtÚumb”
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

339 
size_t
 
sz
 = 
	`luaO_¡r2num
(
s
, 
L
->
tİ
);

340 ià(
sz
 != 0)

341 
	`­i_šü_tİ
(
L
);

342  
sz
;

343 
	}
}

346 
LUA_API
 
lua_Numb”
 
	$lua_tÚumb”x
 (
lua_S‹
 *
L
, 
idx
, *
pi¢um
) {

347 
lua_Numb”
 
n
;

348 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

349 
i¢um
 = 
	`tÚumb”
(
o
, &
n
);

350 ià(!
i¢um
)

351 
n
 = 0;

352 ià(
pi¢um
è*pi¢um = 
i¢um
;

353  
n
;

354 
	}
}

357 
LUA_API
 
lua_IÁeg”
 
	$lua_toš‹g”x
 (
lua_S‹
 *
L
, 
idx
, *
pi¢um
) {

358 
lua_IÁeg”
 
»s
;

359 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

360 
i¢um
 = 
	`toš‹g”
(
o
, &
»s
);

361 ià(!
i¢um
)

362 
»s
 = 0;

363 ià(
pi¢um
è*pi¢um = 
i¢um
;

364  
»s
;

365 
	}
}

368 
LUA_API
 
	$lua_toboŞ—n
 (
lua_S‹
 *
L
, 
idx
) {

369 cÚ¡ 
TV®ue
 *
o
 = 
	`šdex2addr
(
L
, 
idx
);

370  !
	`l_isçl£
(
o
);

371 
	}
}

374 
LUA_API
 cÚ¡ *
	$lua_tŞ¡ršg
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
) {

375 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

376 ià(!
	`‰is¡ršg
(
o
)) {

377 ià(!
	`cvt2¡r
(
o
)) {

378 ià(
Ën
 !ğ
NULL
) *len = 0;

379  
NULL
;

381 
	`lua_lock
(
L
);

382 
	`luaO_to¡ršg
(
L
, 
o
);

383 
	`luaC_checkGC
(
L
);

384 
o
 = 
	`šdex2addr
(
L
, 
idx
);

385 
	`lua_uÆock
(
L
);

387 ià(
Ën
 !ğ
NULL
)

388 *
Ën
 = 
	`v¦’
(
o
);

389  
	`sv®ue
(
o
);

390 
	}
}

393 
LUA_API
 
size_t
 
	$lua_¿wËn
 (
lua_S‹
 *
L
, 
idx
) {

394 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

395 
	`‰y³
(
o
)) {

396 
LUA_TSHRSTR
:  
	`tsv®ue
(
o
)->
sh¾’
;

397 
LUA_TLNGSTR
:  
	`tsv®ue
(
o
)->
u
.
ÊgËn
;

398 
LUA_TUSERDATA
:  
	`uv®ue
(
o
)->
Ën
;

399 
LUA_TTABLE
:  
	`luaH_g‘n
(
	`hv®ue
(
o
));

402 
	}
}

405 
LUA_API
 
lua_CFunùiÚ
 
	$lua_tocfunùiÚ
 (
lua_S‹
 *
L
, 
idx
) {

406 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

407 ià(
	`‰i¦cf
(
o
)è 
	`fv®ue
(o);

408 ià(
	`‰isCşosu»
(
o
))

409  
	`şCv®ue
(
o
)->
f
;

410  
NULL
;

411 
	}
}

414 
LUA_API
 *
	$lua_tou£rd©a
 (
lua_S‹
 *
L
, 
idx
) {

415 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

416 
	`‰nov
(
o
)) {

417 
LUA_TUSERDATA
:  
	`g‘ud©amem
(
	`uv®ue
(
o
));

418 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
o
);

419 :  
NULL
;

421 
	}
}

424 
LUA_API
 
lua_S‹
 *
	$lua_tÙh»ad
 (
lua_S‹
 *
L
, 
idx
) {

425 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

426  (!
	`‰i¡h»ad
(
o
)è? 
NULL
 : 
	`thv®ue
(o);

427 
	}
}

430 
LUA_API
 cÚ¡ *
	$lua_tİoš‹r
 (
lua_S‹
 *
L
, 
idx
) {

431 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
idx
);

432 
	`‰y³
(
o
)) {

433 
LUA_TTABLE
:  
	`hv®ue
(
o
);

434 
LUA_TLCL
:  
	`şLv®ue
(
o
);

435 
LUA_TCCL
:  
	`şCv®ue
(
o
);

436 
LUA_TLCF
:  
	`ÿ¡
(*, ca¡(
size_t
, 
	`fv®ue
(
o
)));

437 
LUA_TTHREAD
:  
	`thv®ue
(
o
);

438 
LUA_TUSERDATA
:  
	`g‘ud©amem
(
	`uv®ue
(
o
));

439 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
o
);

440 :  
NULL
;

442 
	}
}

451 
LUA_API
 
	$lua_pushn
 (
lua_S‹
 *
L
) {

452 
	`lua_lock
(
L
);

453 
	`£Šv®ue
(
L
->
tİ
);

454 
	`­i_šü_tİ
(
L
);

455 
	`lua_uÆock
(
L
);

456 
	}
}

459 
LUA_API
 
	$lua_pushnumb”
 (
lua_S‹
 *
L
, 
lua_Numb”
 
n
) {

460 
	`lua_lock
(
L
);

461 
	`£tætv®ue
(
L
->
tİ
, 
n
);

462 
	`­i_šü_tİ
(
L
);

463 
	`lua_uÆock
(
L
);

464 
	}
}

467 
LUA_API
 
	$lua_pushš‹g”
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
n
) {

468 
	`lua_lock
(
L
);

469 
	`£tiv®ue
(
L
->
tİ
, 
n
);

470 
	`­i_šü_tİ
(
L
);

471 
	`lua_uÆock
(
L
);

472 
	}
}

480 
LUA_API
 cÚ¡ *
	$lua_pushl¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
, 
size_t
 
Ën
) {

481 
TSŒšg
 *
ts
;

482 
	`lua_lock
(
L
);

483 
ts
 = (
Ën
 =ğ0è? 
	`luaS_Ãw
(
L
, ""è: 
	`luaS_Ãwl¡r
(L, 
s
,†en);

484 
	`£tsv®ue2s
(
L
, L->
tİ
, 
ts
);

485 
	`­i_šü_tİ
(
L
);

486 
	`luaC_checkGC
(
L
);

487 
	`lua_uÆock
(
L
);

488  
	`g‘¡r
(
ts
);

489 
	}
}

492 
LUA_API
 cÚ¡ *
	$lua_push¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

493 
	`lua_lock
(
L
);

494 ià(
s
 =ğ
NULL
)

495 
	`£Šv®ue
(
L
->
tİ
);

497 
TSŒšg
 *
ts
;

498 
ts
 = 
	`luaS_Ãw
(
L
, 
s
);

499 
	`£tsv®ue2s
(
L
, L->
tİ
, 
ts
);

500 
s
 = 
	`g‘¡r
(
ts
);

502 
	`­i_šü_tİ
(
L
);

503 
	`luaC_checkGC
(
L
);

504 
	`lua_uÆock
(
L
);

505  
s
;

506 
	}
}

509 
LUA_API
 cÚ¡ *
	$lua_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
,

510 
va_li¡
 
¬gp
) {

511 cÚ¡ *
»t
;

512 
	`lua_lock
(
L
);

513 
»t
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

514 
	`luaC_checkGC
(
L
);

515 
	`lua_uÆock
(
L
);

516  
»t
;

517 
	}
}

520 
LUA_API
 cÚ¡ *
	$lua_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

521 cÚ¡ *
»t
;

522 
va_li¡
 
¬gp
;

523 
	`lua_lock
(
L
);

524 
	`va_¡¬t
(
¬gp
, 
fmt
);

525 
»t
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

526 
	`va_’d
(
¬gp
);

527 
	`luaC_checkGC
(
L
);

528 
	`lua_uÆock
(
L
);

529  
»t
;

530 
	}
}

533 
LUA_API
 
	$lua_pushcşosu»
 (
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
â
, 
n
) {

534 
	`lua_lock
(
L
);

535 ià(
n
 == 0) {

536 
	`£tfv®ue
(
L
->
tİ
, 
â
);

539 
CClosu»
 *
ş
;

540 
	`­i_checkÃËms
(
L
, 
n
);

541 
	`­i_check
(
L
, 
n
 <ğ
MAXUPVAL
, "upvalue indexoo†arge");

542 
ş
 = 
	`luaF_ÃwCşosu»
(
L
, 
n
);

543 
ş
->
f
 = 
â
;

544 
L
->
tİ
 -ğ
n
;

545 
n
--) {

546 
	`£tobj2n
(
L
, &
ş
->
upv®ue
[
n
], L->
tİ
 +‚);

549 
	`£tşCv®ue
(
L
, L->
tİ
, 
ş
);

551 
	`­i_šü_tİ
(
L
);

552 
	`luaC_checkGC
(
L
);

553 
	`lua_uÆock
(
L
);

554 
	}
}

557 
LUA_API
 
	$lua_pushboŞ—n
 (
lua_S‹
 *
L
, 
b
) {

558 
	`lua_lock
(
L
);

559 
	`£tbv®ue
(
L
->
tİ
, (
b
 != 0));

560 
	`­i_šü_tİ
(
L
);

561 
	`lua_uÆock
(
L
);

562 
	}
}

565 
LUA_API
 
	$lua_pushlightu£rd©a
 (
lua_S‹
 *
L
, *
p
) {

566 
	`lua_lock
(
L
);

567 
	`£v®ue
(
L
->
tİ
, 
p
);

568 
	`­i_šü_tİ
(
L
);

569 
	`lua_uÆock
(
L
);

570 
	}
}

573 
LUA_API
 
	$lua_pushth»ad
 (
lua_S‹
 *
L
) {

574 
	`lua_lock
(
L
);

575 
	`£‰hv®ue
(
L
, L->
tİ
, L);

576 
	`­i_šü_tİ
(
L
);

577 
	`lua_uÆock
(
L
);

578  (
	`G
(
L
)->
mašth»ad
 == L);

579 
	}
}

588 
	$auxg‘¡r
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, cÚ¡ *
k
) {

589 cÚ¡ 
TV®ue
 *
¦Ù
;

590 
TSŒšg
 *
¡r
 = 
	`luaS_Ãw
(
L
, 
k
);

591 ià(
	`luaV_ç¡g‘
(
L
, 
t
, 
¡r
, 
¦Ù
, 
luaH_g‘¡r
)) {

592 
	`£tobj2s
(
L
, L->
tİ
, 
¦Ù
);

593 
	`­i_šü_tİ
(
L
);

596 
	`£tsv®ue2s
(
L
, L->
tİ
, 
¡r
);

597 
	`­i_šü_tİ
(
L
);

598 
	`luaV_fšishg‘
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 1, 
¦Ù
);

600 
	`lua_uÆock
(
L
);

601  
	`‰nov
(
L
->
tİ
 - 1);

602 
	}
}

605 
LUA_API
 
	$lua_g‘glob®
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

606 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

607 
	`lua_lock
(
L
);

608  
	`auxg‘¡r
(
L
, 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
), 
Çme
);

609 
	}
}

612 
LUA_API
 
	$lua_g‘bË
 (
lua_S‹
 *
L
, 
idx
) {

613 
StkId
 
t
;

614 
	`lua_lock
(
L
);

615 
t
 = 
	`šdex2addr
(
L
, 
idx
);

616 
	`luaV_g‘bË
(
L
, 
t
, L->
tİ
 - 1, L->top - 1);

617 
	`lua_uÆock
(
L
);

618  
	`‰nov
(
L
->
tİ
 - 1);

619 
	}
}

622 
LUA_API
 
	$lua_g‘f›ld
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
) {

623 
	`lua_lock
(
L
);

624  
	`auxg‘¡r
(
L
, 
	`šdex2addr
(L, 
idx
), 
k
);

625 
	}
}

628 
LUA_API
 
	$lua_g‘i
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

629 
StkId
 
t
;

630 cÚ¡ 
TV®ue
 *
¦Ù
;

631 
	`lua_lock
(
L
);

632 
t
 = 
	`šdex2addr
(
L
, 
idx
);

633 ià(
	`luaV_ç¡g‘
(
L
, 
t
, 
n
, 
¦Ù
, 
luaH_g‘št
)) {

634 
	`£tobj2s
(
L
, L->
tİ
, 
¦Ù
);

635 
	`­i_šü_tİ
(
L
);

638 
	`£tiv®ue
(
L
->
tİ
, 
n
);

639 
	`­i_šü_tİ
(
L
);

640 
	`luaV_fšishg‘
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 1, 
¦Ù
);

642 
	`lua_uÆock
(
L
);

643  
	`‰nov
(
L
->
tİ
 - 1);

644 
	}
}

647 
LUA_API
 
	$lua_¿wg‘
 (
lua_S‹
 *
L
, 
idx
) {

648 
StkId
 
t
;

649 
	`lua_lock
(
L
);

650 
t
 = 
	`šdex2addr
(
L
, 
idx
);

651 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

652 
	`£tobj2s
(
L
, L->
tİ
 - 1, 
	`luaH_g‘
(
	`hv®ue
(
t
), L->top - 1));

653 
	`lua_uÆock
(
L
);

654  
	`‰nov
(
L
->
tİ
 - 1);

655 
	}
}

658 
LUA_API
 
	$lua_¿wg‘i
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

659 
StkId
 
t
;

660 
	`lua_lock
(
L
);

661 
t
 = 
	`šdex2addr
(
L
, 
idx
);

662 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

663 
	`£tobj2s
(
L
, L->
tİ
, 
	`luaH_g‘št
(
	`hv®ue
(
t
), 
n
));

664 
	`­i_šü_tİ
(
L
);

665 
	`lua_uÆock
(
L
);

666  
	`‰nov
(
L
->
tİ
 - 1);

667 
	}
}

670 
LUA_API
 
	$lua_¿wg‘p
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
) {

671 
StkId
 
t
;

672 
TV®ue
 
k
;

673 
	`lua_lock
(
L
);

674 
t
 = 
	`šdex2addr
(
L
, 
idx
);

675 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

676 
	`£v®ue
(&
k
, 
	`ÿ¡
(*, 
p
));

677 
	`£tobj2s
(
L
, L->
tİ
, 
	`luaH_g‘
(
	`hv®ue
(
t
), &
k
));

678 
	`­i_šü_tİ
(
L
);

679 
	`lua_uÆock
(
L
);

680  
	`‰nov
(
L
->
tİ
 - 1);

681 
	}
}

684 
LUA_API
 
	$lua_ü—‹bË
 (
lua_S‹
 *
L
, 
Ç¼ay
, 
Äec
) {

685 
TabË
 *
t
;

686 
	`lua_lock
(
L
);

687 
t
 = 
	`luaH_Ãw
(
L
);

688 
	`£thv®ue
(
L
, L->
tİ
, 
t
);

689 
	`­i_šü_tİ
(
L
);

690 ià(
Ç¼ay
 > 0 || 
Äec
 > 0)

691 
	`luaH_»size
(
L
, 
t
, 
Ç¼ay
, 
Äec
);

692 
	`luaC_checkGC
(
L
);

693 
	`lua_uÆock
(
L
);

694 
	}
}

697 
LUA_API
 
	$lua_g‘m‘©abË
 (
lua_S‹
 *
L
, 
objšdex
) {

698 cÚ¡ 
TV®ue
 *
obj
;

699 
TabË
 *
mt
;

700 
»s
 = 0;

701 
	`lua_lock
(
L
);

702 
obj
 = 
	`šdex2addr
(
L
, 
objšdex
);

703 
	`‰nov
(
obj
)) {

704 
LUA_TTABLE
:

705 
mt
 = 
	`hv®ue
(
obj
)->
m‘©abË
;

707 
LUA_TUSERDATA
:

708 
mt
 = 
	`uv®ue
(
obj
)->
m‘©abË
;

711 
mt
 = 
	`G
(
L
)->mt[
	`‰nov
(
obj
)];

714 ià(
mt
 !ğ
NULL
) {

715 
	`£thv®ue
(
L
, L->
tİ
, 
mt
);

716 
	`­i_šü_tİ
(
L
);

717 
»s
 = 1;

719 
	`lua_uÆock
(
L
);

720  
»s
;

721 
	}
}

724 
LUA_API
 
	$lua_g‘u£rv®ue
 (
lua_S‹
 *
L
, 
idx
) {

725 
StkId
 
o
;

726 
	`lua_lock
(
L
);

727 
o
 = 
	`šdex2addr
(
L
, 
idx
);

728 
	`­i_check
(
L
, 
	`‰isfuÎu£rd©a
(
o
), "full userdataƒxpected");

729 
	`g‘u£rv®ue
(
L
, 
	`uv®ue
(
o
), L->
tİ
);

730 
	`­i_šü_tİ
(
L
);

731 
	`lua_uÆock
(
L
);

732  
	`‰nov
(
L
->
tİ
 - 1);

733 
	}
}

743 
	$aux£t¡r
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, cÚ¡ *
k
) {

744 cÚ¡ 
TV®ue
 *
¦Ù
;

745 
TSŒšg
 *
¡r
 = 
	`luaS_Ãw
(
L
, 
k
);

746 
	`­i_checkÃËms
(
L
, 1);

747 ià(
	`luaV_ç¡£t
(
L
, 
t
, 
¡r
, 
¦Ù
, 
luaH_g‘¡r
, L->
tİ
 - 1))

748 
L
->
tİ
--;

750 
	`£tsv®ue2s
(
L
, L->
tİ
, 
¡r
);

751 
	`­i_šü_tİ
(
L
);

752 
	`luaV_fšish£t
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 2, 
¦Ù
);

753 
L
->
tİ
 -= 2;

755 
	`lua_uÆock
(
L
);

756 
	}
}

759 
LUA_API
 
	$lua_£tglob®
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

760 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

761 
	`lua_lock
(
L
);

762 
	`aux£t¡r
(
L
, 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
), 
Çme
);

763 
	}
}

766 
LUA_API
 
	$lua_£‰abË
 (
lua_S‹
 *
L
, 
idx
) {

767 
StkId
 
t
;

768 
	`lua_lock
(
L
);

769 
	`­i_checkÃËms
(
L
, 2);

770 
t
 = 
	`šdex2addr
(
L
, 
idx
);

771 
	`luaV_£‰abË
(
L
, 
t
, L->
tİ
 - 2, L->top - 1);

772 
L
->
tİ
 -= 2;

773 
	`lua_uÆock
(
L
);

774 
	}
}

777 
LUA_API
 
	$lua_£tf›ld
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
) {

778 
	`lua_lock
(
L
);

779 
	`aux£t¡r
(
L
, 
	`šdex2addr
(L, 
idx
), 
k
);

780 
	}
}

783 
LUA_API
 
	$lua_£ti
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

784 
StkId
 
t
;

785 cÚ¡ 
TV®ue
 *
¦Ù
;

786 
	`lua_lock
(
L
);

787 
	`­i_checkÃËms
(
L
, 1);

788 
t
 = 
	`šdex2addr
(
L
, 
idx
);

789 ià(
	`luaV_ç¡£t
(
L
, 
t
, 
n
, 
¦Ù
, 
luaH_g‘št
, L->
tİ
 - 1))

790 
L
->
tİ
--;

792 
	`£tiv®ue
(
L
->
tİ
, 
n
);

793 
	`­i_šü_tİ
(
L
);

794 
	`luaV_fšish£t
(
L
, 
t
, L->
tİ
 - 1, L->tİ - 2, 
¦Ù
);

795 
L
->
tİ
 -= 2;

797 
	`lua_uÆock
(
L
);

798 
	}
}

801 
LUA_API
 
	$lua_¿w£t
 (
lua_S‹
 *
L
, 
idx
) {

802 
StkId
 
o
;

803 
TV®ue
 *
¦Ù
;

804 
	`lua_lock
(
L
);

805 
	`­i_checkÃËms
(
L
, 2);

806 
o
 = 
	`šdex2addr
(
L
, 
idx
);

807 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
), "tableƒxpected");

808 
¦Ù
 = 
	`luaH_£t
(
L
, 
	`hv®ue
(
o
), L->
tİ
 - 2);

809 
	`£tobj2t
(
L
, 
¦Ù
, L->
tİ
 - 1);

810 
	`šv®id©eTMÿche
(
	`hv®ue
(
o
));

811 
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
o
), L->
tİ
-1);

812 
L
->
tİ
 -= 2;

813 
	`lua_uÆock
(
L
);

814 
	}
}

817 
LUA_API
 
	$lua_¿w£ti
 (
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
) {

818 
StkId
 
o
;

819 
	`lua_lock
(
L
);

820 
	`­i_checkÃËms
(
L
, 1);

821 
o
 = 
	`šdex2addr
(
L
, 
idx
);

822 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
), "tableƒxpected");

823 
	`luaH_£tšt
(
L
, 
	`hv®ue
(
o
), 
n
, L->
tİ
 - 1);

824 
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
o
), L->
tİ
-1);

825 
L
->
tİ
--;

826 
	`lua_uÆock
(
L
);

827 
	}
}

830 
LUA_API
 
	$lua_¿w£
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
) {

831 
StkId
 
o
;

832 
TV®ue
 
k
, *
¦Ù
;

833 
	`lua_lock
(
L
);

834 
	`­i_checkÃËms
(
L
, 1);

835 
o
 = 
	`šdex2addr
(
L
, 
idx
);

836 
	`­i_check
(
L
, 
	`‰i¡abË
(
o
), "tableƒxpected");

837 
	`£v®ue
(&
k
, 
	`ÿ¡
(*, 
p
));

838 
¦Ù
 = 
	`luaH_£t
(
L
, 
	`hv®ue
(
o
), &
k
);

839 
	`£tobj2t
(
L
, 
¦Ù
, L->
tİ
 - 1);

840 
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
o
), L->
tİ
 - 1);

841 
L
->
tİ
--;

842 
	`lua_uÆock
(
L
);

843 
	}
}

846 
LUA_API
 
	$lua_£tm‘©abË
 (
lua_S‹
 *
L
, 
objšdex
) {

847 
TV®ue
 *
obj
;

848 
TabË
 *
mt
;

849 
	`lua_lock
(
L
);

850 
	`­i_checkÃËms
(
L
, 1);

851 
obj
 = 
	`šdex2addr
(
L
, 
objšdex
);

852 ià(
	`‰i¢
(
L
->
tİ
 - 1))

853 
mt
 = 
NULL
;

855 
	`­i_check
(
L
, 
	`‰i¡abË
(L->
tİ
 - 1), "tableƒxpected");

856 
mt
 = 
	`hv®ue
(
L
->
tİ
 - 1);

858 
	`‰nov
(
obj
)) {

859 
LUA_TTABLE
: {

860 
	`hv®ue
(
obj
)->
m‘©abË
 = 
mt
;

861 ià(
mt
) {

862 
	`luaC_objb¬r›r
(
L
, 
	`gcv®ue
(
obj
), 
mt
);

863 
	`luaC_checkfš®iz”
(
L
, 
	`gcv®ue
(
obj
), 
mt
);

867 
LUA_TUSERDATA
: {

868 
	`uv®ue
(
obj
)->
m‘©abË
 = 
mt
;

869 ià(
mt
) {

870 
	`luaC_objb¬r›r
(
L
, 
	`uv®ue
(
obj
), 
mt
);

871 
	`luaC_checkfš®iz”
(
L
, 
	`gcv®ue
(
obj
), 
mt
);

876 
	`G
(
L
)->
mt
[
	`‰nov
(
obj
)] = mt;

880 
L
->
tİ
--;

881 
	`lua_uÆock
(
L
);

883 
	}
}

886 
LUA_API
 
	$lua_£tu£rv®ue
 (
lua_S‹
 *
L
, 
idx
) {

887 
StkId
 
o
;

888 
	`lua_lock
(
L
);

889 
	`­i_checkÃËms
(
L
, 1);

890 
o
 = 
	`šdex2addr
(
L
, 
idx
);

891 
	`­i_check
(
L
, 
	`‰isfuÎu£rd©a
(
o
), "full userdataƒxpected");

892 
	`£tu£rv®ue
(
L
, 
	`uv®ue
(
o
), L->
tİ
 - 1);

893 
	`luaC_b¬r›r
(
L
, 
	`gcv®ue
(
o
), L->
tİ
 - 1);

894 
L
->
tİ
--;

895 
	`lua_uÆock
(
L
);

896 
	}
}

904 
	#check»suÉs
(
L
,
Ç
,
Ä
) \

905 
	`­i_check
(
L
, (
Ä
è=ğ
LUA_MULTRET
 || (L->
ci
->
tİ
 - L->tİ >ğÒrè- (
Ç
)), \

906 "»suÉ äom funùiÚ ov”æow cu¼’ˆ¡ack size")

	)

909 
LUA_API
 
	$lua_ÿÎk
 (
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
,

910 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
) {

911 
StkId
 
func
;

912 
	`lua_lock
(
L
);

913 
	`­i_check
(
L
, 
k
 =ğ
NULL
 || !
	`isLua
(L->
ci
),

915 
	`­i_checkÃËms
(
L
, 
Çrgs
+1);

916 
	`­i_check
(
L
, L->
¡©us
 =ğ
LUA_OK
, "cannot do calls on‚on-normalhread");

917 
	`check»suÉs
(
L
, 
Çrgs
, 
ÄesuÉs
);

918 
func
 = 
L
->
tİ
 - (
Çrgs
+1);

919 ià(
k
 !ğ
NULL
 && 
L
->
Ây
 == 0) {

920 
L
->
ci
->
u
.
c
.
k
 = k;

921 
L
->
ci
->
u
.
c
.
ùx
 = ctx;

922 
	`luaD_ÿÎ
(
L
, 
func
, 
ÄesuÉs
);

925 
	`luaD_ÿÎnoy›ld
(
L
, 
func
, 
ÄesuÉs
);

926 
	`adju¡»suÉs
(
L
, 
ÄesuÉs
);

927 
	`lua_uÆock
(
L
);

928 
	}
}

935 
	sC®lS
 {

936 
StkId
 
	mfunc
;

937 
	mÄesuÉs
;

941 
	$f_ÿÎ
 (
lua_S‹
 *
L
, *
ud
) {

942 
C®lS
 *
c
 = 
	`ÿ¡
(C®lS *, 
ud
);

943 
	`luaD_ÿÎnoy›ld
(
L
, 
c
->
func
, c->
ÄesuÉs
);

944 
	}
}

948 
LUA_API
 
	$lua_pÿÎk
 (
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
, 
”rfunc
,

949 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
) {

950 
C®lS
 
c
;

951 
¡©us
;

952 
±rdiff_t
 
func
;

953 
	`lua_lock
(
L
);

954 
	`­i_check
(
L
, 
k
 =ğ
NULL
 || !
	`isLua
(L->
ci
),

956 
	`­i_checkÃËms
(
L
, 
Çrgs
+1);

957 
	`­i_check
(
L
, L->
¡©us
 =ğ
LUA_OK
, "cannot do calls on‚on-normalhread");

958 
	`check»suÉs
(
L
, 
Çrgs
, 
ÄesuÉs
);

959 ià(
”rfunc
 == 0)

960 
func
 = 0;

962 
StkId
 
o
 = 
	`šdex2addr
(
L
, 
”rfunc
);

963 
	`­i_check¡ackšdex
(
L
, 
”rfunc
, 
o
);

964 
func
 = 
	`§ve¡ack
(
L
, 
o
);

966 
c
.
func
 = 
L
->
tİ
 - (
Çrgs
+1);

967 ià(
k
 =ğ
NULL
 || 
L
->
Ây
 > 0) {

968 
c
.
ÄesuÉs
 =‚results;

969 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_ÿÎ
, &
c
, 
	`§ve¡ack
(L, c.
func
), func);

972 
C®lInfo
 *
ci
 = 
L
->ci;

973 
ci
->
u
.
c
.
k
 = k;

974 
ci
->
u
.
c
.
ùx
 = ctx;

976 
ci
->
exŒa
 = 
	`§ve¡ack
(
L
, 
c
.
func
);

977 
ci
->
u
.
c
.
Şd_”rfunc
 = 
L
->
”rfunc
;

978 
L
->
”rfunc
 = 
func
;

979 
	`£tßh
(
ci
->
ÿÎ¡©us
, 
L
->
®lowhook
);

980 
ci
->
ÿÎ¡©us
 |ğ
CIST_YPCALL
;

981 
	`luaD_ÿÎ
(
L
, 
c
.
func
, 
ÄesuÉs
);

982 
ci
->
ÿÎ¡©us
 &ğ~
CIST_YPCALL
;

983 
L
->
”rfunc
 = 
ci
->
u
.
c
.
Şd_”rfunc
;

984 
¡©us
 = 
LUA_OK
;

986 
	`adju¡»suÉs
(
L
, 
ÄesuÉs
);

987 
	`lua_uÆock
(
L
);

988  
¡©us
;

989 
	}
}

992 
LUA_API
 
	$lua_lßd
 (
lua_S‹
 *
L
, 
lua_R—d”
 
»ad”
, *
d©a
,

993 cÚ¡ *
chunkÇme
, cÚ¡ *
mode
) {

994 
ZIO
 
z
;

995 
¡©us
;

996 
	`lua_lock
(
L
);

997 ià(!
chunkÇme
) chunkname = "?";

998 
	`luaZ_š™
(
L
, &
z
, 
»ad”
, 
d©a
);

999 
¡©us
 = 
	`luaD_´Ùeùed·r£r
(
L
, &
z
, 
chunkÇme
, 
mode
);

1000 ià(
¡©us
 =ğ
LUA_OK
) {

1001 
LClosu»
 *
f
 = 
	`şLv®ue
(
L
->
tİ
 - 1);

1002 ià(
f
->
nupv®ues
 >= 1) {

1004 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

1005 cÚ¡ 
TV®ue
 *
gt
 = 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
);

1007 
	`£tobj
(
L
, 
f
->
upv®s
[0]->
v
, 
gt
);

1008 
	`luaC_upv®b¬r›r
(
L
, 
f
->
upv®s
[0]);

1011 
	`lua_uÆock
(
L
);

1012  
¡©us
;

1013 
	}
}

1015 
	$şÚ•rÙo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
, cÚ¡ PrÙØ*
¤c
) {

1017 
i
,
n
;

1018 
n
 = 
¤c
->
¥
->
sizek
;

1019 
f
->
k
=
	`luaM_ÃwveùÜ
(
L
,
n
,
TV®ue
);

1020 
i
=0; i<
n
; i++è
	`£Šv®ue
(&
f
->
k
[i]);

1021 
i
=0; i<
n
; i++) {

1022 cÚ¡ 
TV®ue
 *
s
=&
¤c
->
k
[
i
];

1023 
TV®ue
 *
o
=&
f
->
k
[
i
];

1024 ià(
	`‰is¡ršg
(
s
)) {

1025 
TSŒšg
 * 
¡r
 = 
	`luaS_şÚe¡ršg
(
L
,
	`tsv®ue
(
s
));

1026 
	`£tsv®ue2n
(
L
,
o
,
¡r
);

1028 
	`£tobj
(
L
,
o
,
s
);

1031 
n
 = 
¤c
->
¥
->
siz•
;

1032 
f
->
p
=
	`luaM_ÃwveùÜ
(
L
,
n
,
PrÙo
 *);

1033 
i
=0; i<
n
; i++è
f
->
p
[i]=
NULL
;

1034 
i
=0; i<
n
; i++) {

1035 
f
->
p
[
i
]ğ
	`luaF_Ãw´Ùo
(
L
, 
¤c
->p[i]->
¥
);

1036 
	`şÚ•rÙo
(
L
, 
f
->
p
[
i
], 
¤c
->p[i]);

1038 
	}
}

1040 
LUA_API
 
	$lua_şÚefunùiÚ
 (
lua_S‹
 *
L
, cÚ¡ * 
å
) {

1041 
LClosu»
 *
ş
;

1042 
LClosu»
 *
f
 = 
	`ÿ¡
(LClosu» *, 
å
);

1043 
	`lua_lock
(
L
);

1044 ià(
f
->
p
->
¥
->
l_G
 =ğ
	`G
(
L
)) {

1045 
	`£tşLv®ue
(
L
,L->
tİ
,
f
);

1046 
	`­i_šü_tİ
(
L
);

1047 
	`lua_uÆock
(
L
);

1050 
ş
 = 
	`luaF_ÃwLşosu»
(
L
,
f
->
nupv®ues
);

1051 
	`£tşLv®ue
(
L
,L->
tİ
,
ş
);

1052 
	`­i_šü_tİ
(
L
);

1053 
ş
->
p
 = 
	`luaF_Ãw´Ùo
(
L
, 
f
->p->
¥
);

1054 
	`şÚ•rÙo
(
L
, 
ş
->
p
, 
f
->p);

1055 
	`luaF_š™upv®s
(
L
, 
ş
);

1057 ià(
ş
->
nupv®ues
 >= 1) {

1059 
TabË
 *
»g
 = 
	`hv®ue
(&
	`G
(
L
)->
l_»gi¡ry
);

1060 cÚ¡ 
TV®ue
 *
gt
 = 
	`luaH_g‘št
(
»g
, 
LUA_RIDX_GLOBALS
);

1062 
	`£tobj
(
L
, 
ş
->
upv®s
[0]->
v
, 
gt
);

1063 
	`luaC_upv®b¬r›r
(
L
, 
ş
->
upv®s
[0]);

1065 
	`lua_uÆock
(
L
);

1066 
	}
}

1068 
LUA_API
 
	$lua_dump
 (
lua_S‹
 *
L
, 
lua_Wr™”
 
wr™”
, *
d©a
, 
¡r
) {

1069 
¡©us
;

1070 
TV®ue
 *
o
;

1071 
	`lua_lock
(
L
);

1072 
	`­i_checkÃËms
(
L
, 1);

1073 
o
 = 
L
->
tİ
 - 1;

1074 ià(
	`isLfunùiÚ
(
o
))

1075 
¡©us
 = 
	`luaU_dump
(
L
, 
	`g‘´Ùo
(
o
), 
wr™”
, 
d©a
, 
¡r
);

1077 
¡©us
 = 1;

1078 
	`lua_uÆock
(
L
);

1079  
¡©us
;

1080 
	}
}

1083 
LUA_API
 
	$lua_¡©us
 (
lua_S‹
 *
L
) {

1084  
L
->
¡©us
;

1085 
	}
}

1092 
LUA_API
 
	$lua_gc
 (
lua_S‹
 *
L
, 
wh©
, 
d©a
) {

1093 
»s
 = 0;

1094 
glob®_S‹
 *
g
;

1095 
	`lua_lock
(
L
);

1096 
g
 = 
	`G
(
L
);

1097 
wh©
) {

1098 
LUA_GCSTOP
: {

1099 
g
->
güuÂšg
 = 0;

1102 
LUA_GCRESTART
: {

1103 
	`luaE_£tdebt
(
g
, 0);

1104 
g
->
güuÂšg
 = 1;

1107 
LUA_GCCOLLECT
: {

1108 
	`luaC_fuÎgc
(
L
, 0);

1111 
LUA_GCCOUNT
: {

1113 
»s
 = 
	`ÿ¡_št
(
	`g‘tÙ®by‹s
(
g
) >> 10);

1116 
LUA_GCCOUNTB
: {

1117 
»s
 = 
	`ÿ¡_št
(
	`g‘tÙ®by‹s
(
g
) & 0x3ff);

1120 
LUA_GCSTEP
: {

1121 
l_mem
 
debt
 = 1;

1122 
lu_by‹
 
ŞdruÂšg
 = 
g
->
güuÂšg
;

1123 
g
->
güuÂšg
 = 1;

1124 ià(
d©a
 == 0) {

1125 
	`luaE_£tdebt
(
g
, -
GCSTEPSIZE
);

1126 
	`luaC_¡•
(
L
);

1129 
debt
 = 
	`ÿ¡
(
l_mem
, 
d©a
è* 1024 + 
g
->
GCdebt
;

1130 
	`luaE_£tdebt
(
g
, 
debt
);

1131 
	`luaC_checkGC
(
L
);

1133 
g
->
güuÂšg
 = 
ŞdruÂšg
;

1134 ià(
debt
 > 0 && 
g
->
gc¡©e
 =ğ
GCS·u£
)

1135 
»s
 = 1;

1138 
LUA_GCSETPAUSE
: {

1139 
»s
 = 
g
->
gıau£
;

1140 
g
->
gıau£
 = 
d©a
;

1143 
LUA_GCSETSTEPMUL
: {

1144 
»s
 = 
g
->
gc¡•mul
;

1145 ià(
d©a
 < 40) data = 40;

1146 
g
->
gc¡•mul
 = 
d©a
;

1149 
LUA_GCISRUNNING
: {

1150 
»s
 = 
g
->
güuÂšg
;

1153 : 
»s
 = -1;

1155 
	`lua_uÆock
(
L
);

1156  
»s
;

1157 
	}
}

1166 
LUA_API
 
	$lua_”rÜ
 (
lua_S‹
 *
L
) {

1167 
	`lua_lock
(
L
);

1168 
	`­i_checkÃËms
(
L
, 1);

1169 
	`luaG_”rÜmsg
(
L
);

1172 
	}
}

1175 
LUA_API
 
	$lua_Ãxt
 (
lua_S‹
 *
L
, 
idx
) {

1176 
StkId
 
t
;

1177 
mÜe
;

1178 
	`lua_lock
(
L
);

1179 
t
 = 
	`šdex2addr
(
L
, 
idx
);

1180 
	`­i_check
(
L
, 
	`‰i¡abË
(
t
), "tableƒxpected");

1181 
mÜe
 = 
	`luaH_Ãxt
(
L
, 
	`hv®ue
(
t
), L->
tİ
 - 1);

1182 ià(
mÜe
) {

1183 
	`­i_šü_tİ
(
L
);

1186 
L
->
tİ
 -= 1;

1187 
	`lua_uÆock
(
L
);

1188  
mÜe
;

1189 
	}
}

1192 
LUA_API
 
	$lua_cÚÿt
 (
lua_S‹
 *
L
, 
n
) {

1193 
	`lua_lock
(
L
);

1194 
	`­i_checkÃËms
(
L
, 
n
);

1195 ià(
n
 >= 2) {

1196 
	`luaV_cÚÿt
(
L
, 
n
);

1198 ià(
n
 == 0) {

1199 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, "", 0));

1200 
	`­i_šü_tİ
(
L
);

1203 
	`luaC_checkGC
(
L
);

1204 
	`lua_uÆock
(
L
);

1205 
	}
}

1208 
LUA_API
 
	$lua_Ën
 (
lua_S‹
 *
L
, 
idx
) {

1209 
StkId
 
t
;

1210 
	`lua_lock
(
L
);

1211 
t
 = 
	`šdex2addr
(
L
, 
idx
);

1212 
	`luaV_objËn
(
L
, L->
tİ
, 
t
);

1213 
	`­i_šü_tİ
(
L
);

1214 
	`lua_uÆock
(
L
);

1215 
	}
}

1218 
LUA_API
 
lua_AÎoc
 
	$lua_g‘®locf
 (
lua_S‹
 *
L
, **
ud
) {

1219 
lua_AÎoc
 
f
;

1220 
	`lua_lock
(
L
);

1221 ià(
ud
è*ud = 
	`G
(
L
)->ud;

1222 
f
 = 
	`G
(
L
)->
ä—Îoc
;

1223 
	`lua_uÆock
(
L
);

1224  
f
;

1225 
	}
}

1228 
LUA_API
 
	$lua_£Îocf
 (
lua_S‹
 *
L
, 
lua_AÎoc
 
f
, *
ud
) {

1229 
	`lua_lock
(
L
);

1230 
	`G
(
L
)->
ud
 = ud;

1231 
	`G
(
L
)->
ä—Îoc
 = 
f
;

1232 
	`lua_uÆock
(
L
);

1233 
	}
}

1236 
LUA_API
 *
	$lua_Ãwu£rd©a
 (
lua_S‹
 *
L
, 
size_t
 
size
) {

1237 
Ud©a
 *
u
;

1238 
	`lua_lock
(
L
);

1239 
u
 = 
	`luaS_Ãwud©a
(
L
, 
size
);

1240 
	`£tuv®ue
(
L
, L->
tİ
, 
u
);

1241 
	`­i_šü_tİ
(
L
);

1242 
	`luaC_checkGC
(
L
);

1243 
	`lua_uÆock
(
L
);

1244  
	`g‘ud©amem
(
u
);

1245 
	}
}

1249 cÚ¡ *
	$aux_upv®ue
 (
StkId
 
fi
, 
n
, 
TV®ue
 **
v®
,

1250 
CClosu»
 **
owÃr
, 
UpV®
 **
uv
) {

1251 
	`‰y³
(
fi
)) {

1252 
LUA_TCCL
: {

1253 
CClosu»
 *
f
 = 
	`şCv®ue
(
fi
);

1254 ià(!(1 <ğ
n
 &&‚ <ğ
f
->
nupv®ues
)è 
NULL
;

1255 *
v®
 = &
f
->
upv®ue
[
n
-1];

1256 ià(
owÃr
è*owÃ¸ğ
f
;

1259 
LUA_TLCL
: {

1260 
LClosu»
 *
f
 = 
	`şLv®ue
(
fi
);

1261 
TSŒšg
 *
Çme
;

1262 
Sh¬edPrÙo
 *
p
 = 
f
->p->
¥
;

1263 ià(!(1 <ğ
n
 &&‚ <ğ
p
->
sizeupv®ues
)è 
NULL
;

1264 *
v®
 = 
f
->
upv®s
[
n
-1]->
v
;

1265 ià(
uv
è*uv = 
f
->
upv®s
[
n
 - 1];

1266 
Çme
 = 
p
->
upv®ues
[
n
-1].name;

1267  (
Çme
 =ğ
NULL
è? "(*nØÇme)" : 
	`g‘¡r
(name);

1269 :  
NULL
;

1271 
	}
}

1274 
LUA_API
 cÚ¡ *
	$lua_g‘upv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
) {

1275 cÚ¡ *
Çme
;

1276 
TV®ue
 *
v®
 = 
NULL
;

1277 
	`lua_lock
(
L
);

1278 
Çme
 = 
	`aux_upv®ue
(
	`šdex2addr
(
L
, 
funcšdex
), 
n
, &
v®
, 
NULL
, NULL);

1279 ià(
Çme
) {

1280 
	`£tobj2s
(
L
, L->
tİ
, 
v®
);

1281 
	`­i_šü_tİ
(
L
);

1283 
	`lua_uÆock
(
L
);

1284  
Çme
;

1285 
	}
}

1288 
LUA_API
 cÚ¡ *
	$lua_£tupv®ue
 (
lua_S‹
 *
L
, 
funcšdex
, 
n
) {

1289 cÚ¡ *
Çme
;

1290 
TV®ue
 *
v®
 = 
NULL
;

1291 
CClosu»
 *
owÃr
 = 
NULL
;

1292 
UpV®
 *
uv
 = 
NULL
;

1293 
StkId
 
fi
;

1294 
	`lua_lock
(
L
);

1295 
fi
 = 
	`šdex2addr
(
L
, 
funcšdex
);

1296 
	`­i_checkÃËms
(
L
, 1);

1297 
Çme
 = 
	`aux_upv®ue
(
fi
, 
n
, &
v®
, &
owÃr
, &
uv
);

1298 ià(
Çme
) {

1299 
L
->
tİ
--;

1300 
	`£tobj
(
L
, 
v®
, L->
tİ
);

1301 ià(
owÃr
è{ 
	`luaC_b¬r›r
(
L
, owÃr, L->
tİ
); }

1302 ià(
uv
è{ 
	`luaC_upv®b¬r›r
(
L
, uv); }

1304 
	`lua_uÆock
(
L
);

1305  
Çme
;

1306 
	}
}

1309 
UpV®
 **
	$g‘upv®»f
 (
lua_S‹
 *
L
, 
fidx
, 
n
, 
LClosu»
 **
pf
) {

1310 
LClosu»
 *
f
;

1311 
StkId
 
fi
 = 
	`šdex2addr
(
L
, 
fidx
);

1312 
	`­i_check
(
L
, 
	`‰isLşosu»
(
fi
), "Lua functionƒxpected");

1313 
f
 = 
	`şLv®ue
(
fi
);

1314 
	`­i_check
(
L
, (1 <ğ
n
 &&‚ <ğ
f
->
p
->
¥
->
sizeupv®ues
), "invalid upvalue index");

1315 ià(
pf
è*pàğ
f
;

1316  &
f
->
upv®s
[
n
 - 1];

1317 
	}
}

1320 
LUA_API
 *
	$lua_upv®ueid
 (
lua_S‹
 *
L
, 
fidx
, 
n
) {

1321 
StkId
 
fi
 = 
	`šdex2addr
(
L
, 
fidx
);

1322 
	`‰y³
(
fi
)) {

1323 
LUA_TLCL
: {

1324  *
	`g‘upv®»f
(
L
, 
fidx
, 
n
, 
NULL
);

1326 
LUA_TCCL
: {

1327 
CClosu»
 *
f
 = 
	`şCv®ue
(
fi
);

1328 
	`­i_check
(
L
, 1 <ğ
n
 &&‚ <ğ
f
->
nupv®ues
, "invalid upvalue index");

1329  &
f
->
upv®ue
[
n
 - 1];

1332 
	`­i_check
(
L
, 0, "closureƒxpected");

1333  
NULL
;

1336 
	}
}

1339 
LUA_API
 
	$lua_upv®uejoš
 (
lua_S‹
 *
L
, 
fidx1
, 
n1
,

1340 
fidx2
, 
n2
) {

1341 
LClosu»
 *
f1
;

1342 
UpV®
 **
up1
 = 
	`g‘upv®»f
(
L
, 
fidx1
, 
n1
, &
f1
);

1343 
UpV®
 **
up2
 = 
	`g‘upv®»f
(
L
, 
fidx2
, 
n2
, 
NULL
);

1344 
	`luaC_upvdeccouÁ
(
L
, *
up1
);

1345 *
up1
 = *
up2
;

1346 (*
up1
)->
»fcouÁ
++;

1347 ià(
	`upisİ’
(*
up1
)è(*up1)->
u
.
İ’
.
touched
 = 1;

1348 
	`luaC_upv®b¬r›r
(
L
, *
up1
);

1349 
	}
}

	@3rd/lua/lapi.h

7 #iâdeà
Ïpi_h


8 
	#Ïpi_h


	)

11 
	~"Îim™s.h
"

12 
	~"l¡©e.h
"

14 
	#­i_šü_tİ
(
L
è{L->
tİ
++; 
	`­i_check
(L, L->tİ <ğL->
ci
->top, \

15 "¡ack ov”æow");}

	)

17 
	#adju¡»suÉs
(
L
,
Äes
) \

18 { ià((
Äes
è=ğ
LUA_MULTRET
 && 
L
->
ci
->
tİ
 < L->tİèL->ci->tİ = L->tİ; }

	)

20 
	#­i_checkÃËms
(
L
,
n
è
	`­i_check
(L, (nè< (L->
tİ
 - L->
ci
->
func
), \

21 "nÙƒnoughƒËm’t šh¡ack")

	)

	@3rd/lua/lauxlib.c

7 
	#Ïuxlib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<”ºo.h
>

14 
	~<¡d¬g.h
>

15 
	~<¡dio.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

25 
	~"lua.h
"

27 
	~"Ïuxlib.h
"

37 
	#LEVELS1
 10

	)

38 
	#LEVELS2
 11

	)

46 
	$fšdf›ld
 (
lua_S‹
 *
L
, 
objidx
, 
Ëv–
) {

47 ià(
Ëv–
 =ğ0 || !
	`lua_i¡abË
(
L
, -1))

49 
	`lua_pushn
(
L
);

50 
	`lua_Ãxt
(
L
, -2)) {

51 ià(
	`lua_ty³
(
L
, -2è=ğ
LUA_TSTRING
) {

52 ià(
	`lua_¿wequ®
(
L
, 
objidx
, -1)) {

53 
	`lua_pİ
(
L
, 1);

56 ià(
	`fšdf›ld
(
L
, 
objidx
, 
Ëv–
 - 1)) {

57 
	`lua_»move
(
L
, -2);

58 
	`lua_pushl™”®
(
L
, ".");

59 
	`lua_š£¹
(
L
, -2);

60 
	`lua_cÚÿt
(
L
, 3);

64 
	`lua_pİ
(
L
, 1);

67 
	}
}

73 
	$pushglob®funúame
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

74 
tİ
 = 
	`lua_g‘tİ
(
L
);

75 
	`lua_g‘šfo
(
L
, "f", 
¬
);

76 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

77 ià(
	`fšdf›ld
(
L
, 
tİ
 + 1, 2)) {

78 cÚ¡ *
Çme
 = 
	`lua_to¡ršg
(
L
, -1);

79 ià(
	`¡ºcmp
(
Çme
, "_G.", 3) == 0) {

80 
	`lua_push¡ršg
(
L
, 
Çme
 + 3);

81 
	`lua_»move
(
L
, -2);

83 
	`lua_cİy
(
L
, -1, 
tİ
 + 1);

84 
	`lua_pİ
(
L
, 2);

88 
	`lua_£‰İ
(
L
, 
tİ
);

91 
	}
}

94 
	$pushfunúame
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

95 ià(
	`pushglob®funúame
(
L
, 
¬
)) {

96 
	`lua_pushf¡ršg
(
L
, "funùiÚ '%s'", 
	`lua_to¡ršg
(L, -1));

97 
	`lua_»move
(
L
, -2);

99 ià(*
¬
->
Çmewh©
 != '\0')

100 
	`lua_pushf¡ršg
(
L
, "% '%s'", 
¬
->
Çmewh©
,‡r->
Çme
);

101 ià(*
¬
->
wh©
 == 'm')

102 
	`lua_pushl™”®
(
L
, "main chunk");

103 ià(*
¬
->
wh©
 != 'C')

104 
	`lua_pushf¡ršg
(
L
, "funùiÚ <%s:%d>", 
¬
->
shÜt_¤c
,‡r->
lšedefšed
);

106 
	`lua_pushl™”®
(
L
, "?");

107 
	}
}

110 
	$Ï¡Ëv–
 (
lua_S‹
 *
L
) {

111 
lua_Debug
 
¬
;

112 
li
 = 1, 
Ë
 = 1;

114 
	`lua_g‘¡ack
(
L
, 
Ë
, &
¬
)è{ 
li
 =†e;†e *= 2; }

116 
li
 < 
Ë
) {

117 
m
 = (
li
 + 
Ë
)/2;

118 ià(
	`lua_g‘¡ack
(
L
, 
m
, &
¬
)è
li
 = m + 1;

119 
Ë
 = 
m
;

121  
Ë
 - 1;

122 
	}
}

125 
LUALIB_API
 
	$luaL_Œaûback
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
,

126 cÚ¡ *
msg
, 
Ëv–
) {

127 
lua_Debug
 
¬
;

128 
tİ
 = 
	`lua_g‘tİ
(
L
);

129 
Ï¡
 = 
	`Ï¡Ëv–
(
L1
);

130 
n1
 = (
Ï¡
 - 
Ëv–
 > 
LEVELS1
 + 
LEVELS2
) ? LEVELS1 : -1;

131 ià(
msg
)

132 
	`lua_pushf¡ršg
(
L
, "%s\n", 
msg
);

133 
	`luaL_check¡ack
(
L
, 10, 
NULL
);

134 
	`lua_pushl™”®
(
L
, "stackraceback:");

135 
	`lua_g‘¡ack
(
L1
, 
Ëv–
++, &
¬
)) {

136 ià(
n1
-- == 0) {

137 
	`lua_pushl™”®
(
L
, "\n\t...");

138 
Ëv–
 = 
Ï¡
 - 
LEVELS2
 + 1;

141 
	`lua_g‘šfo
(
L1
, "SÊt", &
¬
);

142 
	`lua_pushf¡ršg
(
L
, "\n\t%s:", 
¬
.
shÜt_¤c
);

143 ià(
¬
.
cu¼’še
 > 0)

144 
	`lua_pushf¡ršg
(
L
, "%d:", 
¬
.
cu¼’še
);

145 
	`lua_pushl™”®
(
L
, " in ");

146 
	`pushfunúame
(
L
, &
¬
);

147 ià(
¬
.
i¡aÿÎ
)

148 
	`lua_pushl™”®
(
L
, "\n\t(...tail calls...)");

149 
	`lua_cÚÿt
(
L
, 
	`lua_g‘tİ
(Lè- 
tİ
);

152 
	`lua_cÚÿt
(
L
, 
	`lua_g‘tİ
(Lè- 
tİ
);

153 
	}
}

164 
LUALIB_API
 
	$luaL_¬g”rÜ
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
exŒamsg
) {

165 
lua_Debug
 
¬
;

166 ià(!
	`lua_g‘¡ack
(
L
, 0, &
¬
))

167  
	`luaL_”rÜ
(
L
, "bad‡rgum’ˆ#%d (%s)", 
¬g
, 
exŒamsg
);

168 
	`lua_g‘šfo
(
L
, "n", &
¬
);

169 ià(
	`¡rcmp
(
¬
.
Çmewh©
, "method") == 0) {

170 
¬g
--;

171 ià(
¬g
 == 0)

172  
	`luaL_”rÜ
(
L
, "calling '%s' on bad self (%s)",

173 
¬
.
Çme
, 
exŒamsg
);

175 ià(
¬
.
Çme
 =ğ
NULL
)

176 
¬
.
Çme
 = (
	`pushglob®funúame
(
L
, &¬)è? 
	`lua_to¡ršg
(L, -1) : "?";

177  
	`luaL_”rÜ
(
L
, "bad‡rgument #%do '%s' (%s)",

178 
¬g
, 
¬
.
Çme
, 
exŒamsg
);

179 
	}
}

182 
	$ty³”rÜ
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
Šame
) {

183 cÚ¡ *
msg
;

184 cÚ¡ *
ty³¬g
;

185 ià(
	`luaL_g‘m‘af›ld
(
L
, 
¬g
, "__Çme"è=ğ
LUA_TSTRING
)

186 
ty³¬g
 = 
	`lua_to¡ršg
(
L
, -1);

187 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TLIGHTUSERDATA
)

188 
ty³¬g
 = "light userdata";

190 
ty³¬g
 = 
	`luaL_ty³Çme
(
L
, 
¬g
);

191 
msg
 = 
	`lua_pushf¡ršg
(
L
, "% ex³ùed, gÙ %s", 
Šame
, 
ty³¬g
);

192  
	`luaL_¬g”rÜ
(
L
, 
¬g
, 
msg
);

193 
	}
}

196 
	$g_”rÜ
 (
lua_S‹
 *
L
, 
¬g
, 
g
) {

197 
	`ty³”rÜ
(
L
, 
¬g
, 
	`lua_ty³Çme
(L, 
g
));

198 
	}
}

205 
LUALIB_API
 
	$luaL_wh”e
 (
lua_S‹
 *
L
, 
Ëv–
) {

206 
lua_Debug
 
¬
;

207 ià(
	`lua_g‘¡ack
(
L
, 
Ëv–
, &
¬
)) {

208 
	`lua_g‘šfo
(
L
, "Sl", &
¬
);

209 ià(
¬
.
cu¼’še
 > 0) {

210 
	`lua_pushf¡ršg
(
L
, "%s:%d: ", 
¬
.
shÜt_¤c
,‡r.
cu¼’še
);

214 
	`lua_pushf¡ršg
(
L
, "");

215 
	}
}

223 
LUALIB_API
 
	$luaL_”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

224 
va_li¡
 
¬gp
;

225 
	`va_¡¬t
(
¬gp
, 
fmt
);

226 
	`luaL_wh”e
(
L
, 1);

227 
	`lua_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

228 
	`va_’d
(
¬gp
);

229 
	`lua_cÚÿt
(
L
, 2);

230  
	`lua_”rÜ
(
L
);

231 
	}
}

234 
LUALIB_API
 
	$luaL_f”esuÉ
 (
lua_S‹
 *
L
, 
¡©
, cÚ¡ *
âame
) {

235 
’
 = 
”ºo
;

236 ià(
¡©
) {

237 
	`lua_pushboŞ—n
(
L
, 1);

241 
	`lua_pushn
(
L
);

242 ià(
âame
)

243 
	`lua_pushf¡ršg
(
L
, "%s: %s", 
âame
, 
	`¡»¼Ü
(
’
));

245 
	`lua_push¡ršg
(
L
, 
	`¡»¼Ü
(
’
));

246 
	`lua_pushš‹g”
(
L
, 
’
);

249 
	}
}

252 #ià!
defšed
(
l_š¥eù¡©
)

254 #ià
defšed
(
LUA_USE_POSIX
)

256 
	~<sys/wa™.h
>

261 
	#l_š¥eù¡©
(
¡©
,
wh©
) \

262 ià(
	`WIFEXITED
(
¡©
)è{ sˆğ
	`WEXITSTATUS
(stat); } \

263 ià(
	`WIFSIGNALED
(
¡©
)è{ sˆğ
	`WTERMSIG
(¡©); 
wh©
 = "sigÇl"; }

	)

267 
	#l_š¥eù¡©
(
¡©
,
wh©
è

	)

274 
LUALIB_API
 
	$luaL_exeüesuÉ
 (
lua_S‹
 *
L
, 
¡©
) {

275 cÚ¡ *
wh©
 = "exit";

276 ià(
¡©
 == -1)

277  
	`luaL_f”esuÉ
(
L
, 0, 
NULL
);

279 
	`l_š¥eù¡©
(
¡©
, 
wh©
);

280 ià(*
wh©
 =ğ'e' && 
¡©
 == 0)

281 
	`lua_pushboŞ—n
(
L
, 1);

283 
	`lua_pushn
(
L
);

284 
	`lua_push¡ršg
(
L
, 
wh©
);

285 
	`lua_pushš‹g”
(
L
, 
¡©
);

288 
	}
}

299 
LUALIB_API
 
	$luaL_Ãwm‘©abË
 (
lua_S‹
 *
L
, cÚ¡ *
Šame
) {

300 ià(
	`luaL_g‘m‘©abË
(
L
, 
Šame
è!ğ
LUA_TNIL
)

302 
	`lua_pİ
(
L
, 1);

303 
	`lua_ü—‹bË
(
L
, 0, 2);

304 
	`lua_push¡ršg
(
L
, 
Šame
);

305 
	`lua_£tf›ld
(
L
, -2, "__name");

306 
	`lua_pushv®ue
(
L
, -1);

307 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
Šame
);

309 
	}
}

312 
LUALIB_API
 
	$luaL_£tm‘©abË
 (
lua_S‹
 *
L
, cÚ¡ *
Šame
) {

313 
	`luaL_g‘m‘©abË
(
L
, 
Šame
);

314 
	`lua_£tm‘©abË
(
L
, -2);

315 
	}
}

318 
LUALIB_API
 *
	$luaL_‹¡ud©a
 (
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
) {

319 *
p
 = 
	`lua_tou£rd©a
(
L
, 
ud
);

320 ià(
p
 !ğ
NULL
) {

321 ià(
	`lua_g‘m‘©abË
(
L
, 
ud
)) {

322 
	`luaL_g‘m‘©abË
(
L
, 
Šame
);

323 ià(!
	`lua_¿wequ®
(
L
, -1, -2))

324 
p
 = 
NULL
;

325 
	`lua_pİ
(
L
, 2);

326  
p
;

329  
NULL
;

330 
	}
}

333 
LUALIB_API
 *
	$luaL_checkud©a
 (
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
) {

334 *
p
 = 
	`luaL_‹¡ud©a
(
L
, 
ud
, 
Šame
);

335 ià(
p
 =ğ
NULL
è
	`ty³”rÜ
(
L
, 
ud
, 
Šame
);

336  
p
;

337 
	}
}

348 
LUALIB_API
 
	$luaL_checkİtiÚ
 (
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
def
,

349 cÚ¡ *cÚ¡ 
l¡
[]) {

350 cÚ¡ *
Çme
 = (
def
è? 
	`luaL_İt¡ršg
(
L
, 
¬g
, def) :

351 
	`luaL_check¡ršg
(
L
, 
¬g
);

352 
i
;

353 
i
=0; 
l¡
[i]; i++)

354 ià(
	`¡rcmp
(
l¡
[
i
], 
Çme
) == 0)

355  
i
;

356  
	`luaL_¬g”rÜ
(
L
, 
¬g
,

357 
	`lua_pushf¡ršg
(
L
, "šv®id o±iÚ '%s'", 
Çme
));

358 
	}
}

368 
LUALIB_API
 
	$luaL_check¡ack
 (
lua_S‹
 *
L
, 
¥aû
, cÚ¡ *
msg
) {

369 ià(!
	`lua_check¡ack
(
L
, 
¥aû
)) {

370 ià(
msg
)

371 
	`luaL_”rÜ
(
L
, "¡ack ov”æow (%s)", 
msg
);

373 
	`luaL_”rÜ
(
L
, "stack overflow");

375 
	}
}

378 
LUALIB_API
 
	$luaL_checkty³
 (
lua_S‹
 *
L
, 
¬g
, 
t
) {

379 ià(
	`lua_ty³
(
L
, 
¬g
è!ğ
t
)

380 
	`g_”rÜ
(
L
, 
¬g
, 
t
);

381 
	}
}

384 
LUALIB_API
 
	$luaL_checkªy
 (
lua_S‹
 *
L
, 
¬g
) {

385 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TNONE
)

386 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "valueƒxpected");

387 
	}
}

390 
LUALIB_API
 cÚ¡ *
	$luaL_checkl¡ršg
 (
lua_S‹
 *
L
, 
¬g
, 
size_t
 *
Ën
) {

391 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
¬g
, 
Ën
);

392 ià(!
s
è
	`g_”rÜ
(
L
, 
¬g
, 
LUA_TSTRING
);

393  
s
;

394 
	}
}

397 
LUALIB_API
 cÚ¡ *
	$luaL_İ¡ršg
 (
lua_S‹
 *
L
, 
¬g
,

398 cÚ¡ *
def
, 
size_t
 *
Ën
) {

399 ià(
	`lua_i¢ÚeÜn
(
L
, 
¬g
)) {

400 ià(
Ën
)

401 *
Ën
 = (
def
 ? 
	`¡¾’
(def) : 0);

402  
def
;

404  
	`luaL_checkl¡ršg
(
L
, 
¬g
, 
Ën
);

405 
	}
}

408 
LUALIB_API
 
lua_Numb”
 
	$luaL_checknumb”
 (
lua_S‹
 *
L
, 
¬g
) {

409 
i¢um
;

410 
lua_Numb”
 
d
 = 
	`lua_tÚumb”x
(
L
, 
¬g
, &
i¢um
);

411 ià(!
i¢um
)

412 
	`g_”rÜ
(
L
, 
¬g
, 
LUA_TNUMBER
);

413  
d
;

414 
	}
}

417 
LUALIB_API
 
lua_Numb”
 
	$luaL_İŠumb”
 (
lua_S‹
 *
L
, 
¬g
, 
lua_Numb”
 
def
) {

418  
	`luaL_İt
(
L
, 
luaL_checknumb”
, 
¬g
, 
def
);

419 
	}
}

422 
	$š‹¼Ü
 (
lua_S‹
 *
L
, 
¬g
) {

423 ià(
	`lua_i¢umb”
(
L
, 
¬g
))

424 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "number has‚o integer„epresentation");

426 
	`g_”rÜ
(
L
, 
¬g
, 
LUA_TNUMBER
);

427 
	}
}

430 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_checkš‹g”
 (
lua_S‹
 *
L
, 
¬g
) {

431 
i¢um
;

432 
lua_IÁeg”
 
d
 = 
	`lua_toš‹g”x
(
L
, 
¬g
, &
i¢um
);

433 ià(!
i¢um
) {

434 
	`š‹¼Ü
(
L
, 
¬g
);

436  
d
;

437 
	}
}

440 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_İtš‹g”
 (
lua_S‹
 *
L
, 
¬g
,

441 
lua_IÁeg”
 
def
) {

442  
	`luaL_İt
(
L
, 
luaL_checkš‹g”
, 
¬g
, 
def
);

443 
	}
}

455 
	sUBox
 {

456 *
	mbox
;

457 
size_t
 
	mbsize
;

458 } 
	tUBox
;

461 *
	$»sizebox
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 
Ãwsize
) {

462 *
ud
;

463 
lua_AÎoc
 
®locf
 = 
	`lua_g‘®locf
(
L
, &
ud
);

464 
UBox
 *
box
 = (UBox *)
	`lua_tou£rd©a
(
L
, 
idx
);

465 *
‹mp
 = 
	`®locf
(
ud
, 
box
->box, box->
bsize
, 
Ãwsize
);

466 ià(
‹mp
 =ğ
NULL
 && 
Ãwsize
 > 0) {

467 
	`»sizebox
(
L
, 
idx
, 0);

468 
	`luaL_”rÜ
(
L
, "notƒnough memory for buffer‡llocation");

470 
box
->box = 
‹mp
;

471 
box
->
bsize
 = 
Ãwsize
;

472  
‹mp
;

473 
	}
}

476 
	$boxgc
 (
lua_S‹
 *
L
) {

477 
	`»sizebox
(
L
, 1, 0);

479 
	}
}

482 *
	$Ãwbox
 (
lua_S‹
 *
L
, 
size_t
 
Ãwsize
) {

483 
UBox
 *
box
 = (UBox *)
	`lua_Ãwu£rd©a
(
L
, (UBox));

484 
box
->box = 
NULL
;

485 
box
->
bsize
 = 0;

486 ià(
	`luaL_Ãwm‘©abË
(
L
, "LUABOX")) {

487 
	`lua_pushcfunùiÚ
(
L
, 
boxgc
);

488 
	`lua_£tf›ld
(
L
, -2, "__gc");

490 
	`lua_£tm‘©abË
(
L
, -2);

491  
	`»sizebox
(
L
, -1, 
Ãwsize
);

492 
	}
}

499 
	#buffÚ¡ack
(
B
è((B)->
b
 !ğ(B)->
š™b
)

	)

505 
LUALIB_API
 *
	$luaL_´•buffsize
 (
luaL_Bufãr
 *
B
, 
size_t
 
sz
) {

506 
lua_S‹
 *
L
 = 
B
->L;

507 ià(
B
->
size
 - B->
n
 < 
sz
) {

508 *
Ãwbuff
;

509 
size_t
 
Ãwsize
 = 
B
->
size
 * 2;

510 ià(
Ãwsize
 - 
B
->
n
 < 
sz
)

511 
Ãwsize
 = 
B
->
n
 + 
sz
;

512 ià(
Ãwsize
 < 
B
->
n
 ||‚ewsiz- B->À< 
sz
)

513 
	`luaL_”rÜ
(
L
, "bufferoo†arge");

515 ià(
	`buffÚ¡ack
(
B
))

516 
Ãwbuff
 = (*)
	`»sizebox
(
L
, -1, 
Ãwsize
);

518 
Ãwbuff
 = (*)
	`Ãwbox
(
L
, 
Ãwsize
);

519 
	`memıy
(
Ãwbuff
, 
B
->
b
, B->
n
 * ());

521 
B
->
b
 = 
Ãwbuff
;

522 
B
->
size
 = 
Ãwsize
;

524  &
B
->
b
[B->
n
];

525 
	}
}

528 
LUALIB_API
 
	$luaL_addl¡ršg
 (
luaL_Bufãr
 *
B
, cÚ¡ *
s
, 
size_t
 
l
) {

529 ià(
l
 > 0) {

530 *
b
 = 
	`luaL_´•buffsize
(
B
, 
l
);

531 
	`memıy
(
b
, 
s
, 
l
 * ());

532 
	`luaL_addsize
(
B
, 
l
);

534 
	}
}

537 
LUALIB_API
 
	$luaL_add¡ršg
 (
luaL_Bufãr
 *
B
, cÚ¡ *
s
) {

538 
	`luaL_addl¡ršg
(
B
, 
s
, 
	`¡¾’
(s));

539 
	}
}

542 
LUALIB_API
 
	$luaL_push»suÉ
 (
luaL_Bufãr
 *
B
) {

543 
lua_S‹
 *
L
 = 
B
->L;

544 
	`lua_pushl¡ršg
(
L
, 
B
->
b
, B->
n
);

545 ià(
	`buffÚ¡ack
(
B
)) {

546 
	`»sizebox
(
L
, -2, 0);

547 
	`lua_»move
(
L
, -2);

549 
	}
}

552 
LUALIB_API
 
	$luaL_push»suÉsize
 (
luaL_Bufãr
 *
B
, 
size_t
 
sz
) {

553 
	`luaL_addsize
(
B
, 
sz
);

554 
	`luaL_push»suÉ
(
B
);

555 
	}
}

558 
LUALIB_API
 
	$luaL_addv®ue
 (
luaL_Bufãr
 *
B
) {

559 
lua_S‹
 *
L
 = 
B
->L;

560 
size_t
 
l
;

561 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
l
);

562 ià(
	`buffÚ¡ack
(
B
))

563 
	`lua_š£¹
(
L
, -2);

564 
	`luaL_addl¡ršg
(
B
, 
s
, 
l
);

565 
	`lua_»move
(
L
, (
	`buffÚ¡ack
(
B
)) ? -2 : -1);

566 
	}
}

569 
LUALIB_API
 
	$luaL_buffš™
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
) {

570 
B
->
L
 = L;

571 
B
->
b
 = B->
š™b
;

572 
B
->
n
 = 0;

573 
B
->
size
 = 
LUAL_BUFFERSIZE
;

574 
	}
}

577 
LUALIB_API
 *
	$luaL_buffš™size
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
, 
size_t
 
sz
) {

578 
	`luaL_buffš™
(
L
, 
B
);

579  
	`luaL_´•buffsize
(
B
, 
sz
);

580 
	}
}

592 
	#ä“li¡
 0

	)

595 
LUALIB_API
 
	$luaL_»f
 (
lua_S‹
 *
L
, 
t
) {

596 
»f
;

597 ià(
	`lua_i¢
(
L
, -1)) {

598 
	`lua_pİ
(
L
, 1);

599  
LUA_REFNIL
;

601 
t
 = 
	`lua_absšdex
(
L
,);

602 
	`lua_¿wg‘i
(
L
, 
t
, 
ä“li¡
);

603 
»f
 = ()
	`lua_toš‹g”
(
L
, -1);

604 
	`lua_pİ
(
L
, 1);

605 ià(
»f
 != 0) {

606 
	`lua_¿wg‘i
(
L
, 
t
, 
»f
);

607 
	`lua_¿w£ti
(
L
, 
t
, 
ä“li¡
);

610 
»f
 = ()
	`lua_¿wËn
(
L
, 
t
) + 1;

611 
	`lua_¿w£ti
(
L
, 
t
, 
»f
);

612  
»f
;

613 
	}
}

616 
LUALIB_API
 
	$luaL_uÄef
 (
lua_S‹
 *
L
, 
t
, 
»f
) {

617 ià(
»f
 >= 0) {

618 
t
 = 
	`lua_absšdex
(
L
,);

619 
	`lua_¿wg‘i
(
L
, 
t
, 
ä“li¡
);

620 
	`lua_¿w£ti
(
L
, 
t
, 
»f
);

621 
	`lua_pushš‹g”
(
L
, 
»f
);

622 
	`lua_¿w£ti
(
L
, 
t
, 
ä“li¡
);

624 
	}
}

635 
	sLßdF
 {

636 
	mn
;

637 
FILE
 *
	mf
;

638 
	mbuff
[
BUFSIZ
];

639 } 
	tLßdF
;

642 cÚ¡ *
	$g‘F
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

643 
LßdF
 *
lf
 = (LßdF *)
ud
;

644 ()
L
;

645 ià(
lf
->
n
 > 0) {

646 *
size
 = 
lf
->
n
;

647 
lf
->
n
 = 0;

653 ià(
	`ãof
(
lf
->
f
)è 
NULL
;

654 *
size
 = 
	`ä—d
(
lf
->
buff
, 1, Öf->buff),†f->
f
);

656  
lf
->
buff
;

657 
	}
}

660 
	$”rfe
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
âamešdex
) {

661 cÚ¡ *
£¼
 = 
	`¡»¼Ü
(
”ºo
);

662 cÚ¡ *
f’ame
 = 
	`lua_to¡ršg
(
L
, 
âamešdex
) + 1;

663 
	`lua_pushf¡ršg
(
L
, "ÿÂÙ % %s: %s", 
wh©
, 
f’ame
, 
£¼
);

664 
	`lua_»move
(
L
, 
âamešdex
);

665  
LUA_ERRFILE
;

666 
	}
}

669 
	$skBOM
 (
LßdF
 *
lf
) {

670 cÚ¡ *
p
 = "\xEF\xBB\xBF";

671 
c
;

672 
lf
->
n
 = 0;

674 
c
 = 
	`g‘c
(
lf
->
f
);

675 ià(
c
 =ğ
EOF
 || c !ğ*(cÚ¡ *)
p
++)  c;

676 
lf
->
buff
[lf->
n
++] = 
c
;

677 } *
p
 != '\0');

678 
lf
->
n
 = 0;

679  
	`g‘c
(
lf
->
f
);

680 
	}
}

690 
	$skcomm’t
 (
LßdF
 *
lf
, *
ı
) {

691 
c
 = *
ı
 = 
	`skBOM
(
lf
);

692 ià(
c
 == '#') {

694 
c
 = 
	`g‘c
(
lf
->
f
);

695 } 
c
 !ğ
EOF
 && c != '\n');

696 *
ı
 = 
	`g‘c
(
lf
->
f
);

700 
	}
}

703 
	$luaL_lßdfex_
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
,

704 cÚ¡ *
mode
) {

705 
LßdF
 
lf
;

706 
¡©us
, 
»ad¡©us
;

707 
c
;

708 
âamešdex
 = 
	`lua_g‘tİ
(
L
) + 1;

709 ià(
f’ame
 =ğ
NULL
) {

710 
	`lua_pushl™”®
(
L
, "=stdin");

711 
lf
.
f
 = 
¡dš
;

714 
	`lua_pushf¡ršg
(
L
, "@%s", 
f’ame
);

715 
lf
.
f
 = 
	`fİ’
(
f’ame
, "r");

716 ià(
lf
.
f
 =ğ
NULL
è 
	`”rfe
(
L
, "İ’", 
âamešdex
);

718 ià(
	`skcomm’t
(&
lf
, &
c
))

719 
lf
.
buff
[lf.
n
++] = '\n';

720 ià(
c
 =ğ
LUA_SIGNATURE
[0] && 
f’ame
) {

721 
lf
.
f
 = 
	`äeİ’
(
f’ame
, "rb",†f.f);

722 ià(
lf
.
f
 =ğ
NULL
è 
	`”rfe
(
L
, "»İ’", 
âamešdex
);

723 
	`skcomm’t
(&
lf
, &
c
);

725 ià(
c
 !ğ
EOF
)

726 
lf
.
buff
[lf.
n
++] = 
c
;

727 
¡©us
 = 
	`lua_lßd
(
L
, 
g‘F
, &
lf
, 
	`lua_to¡ršg
(L, -1), 
mode
);

728 
»ad¡©us
 = 
	`ã¼Ü
(
lf
.
f
);

729 ià(
f’ame
è
	`fşo£
(
lf
.
f
);

730 ià(
»ad¡©us
) {

731 
	`lua_£‰İ
(
L
, 
âamešdex
);

732  
	`”rfe
(
L
, "»ad", 
âamešdex
);

734 
	`lua_»move
(
L
, 
âamešdex
);

735  
¡©us
;

736 
	}
}

739 
	sLßdS
 {

740 cÚ¡ *
	ms
;

741 
size_t
 
	msize
;

742 } 
	tLßdS
;

745 cÚ¡ *
	$g‘S
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

746 
LßdS
 *
ls
 = (LßdS *)
ud
;

747 ()
L
;

748 ià(
ls
->
size
 =ğ0è 
NULL
;

749 *
size
 = 
ls
->size;

750 
ls
->
size
 = 0;

751  
ls
->
s
;

752 
	}
}

755 
LUALIB_API
 
	$luaL_lßdbufãrx
 (
lua_S‹
 *
L
, cÚ¡ *
buff
, 
size_t
 
size
,

756 cÚ¡ *
Çme
, cÚ¡ *
mode
) {

757 
LßdS
 
ls
;

758 
ls
.
s
 = 
buff
;

759 
ls
.
size
 = size;

760  
	`lua_lßd
(
L
, 
g‘S
, &
ls
, 
Çme
, 
mode
);

761 
	}
}

764 
LUALIB_API
 
	$luaL_lßd¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
) {

765  
	`luaL_lßdbufãr
(
L
, 
s
, 
	`¡¾’
(s), s);

766 
	}
}

772 
LUALIB_API
 
	$luaL_g‘m‘af›ld
 (
lua_S‹
 *
L
, 
obj
, cÚ¡ *
ev’t
) {

773 ià(!
	`lua_g‘m‘©abË
(
L
, 
obj
))

774  
LUA_TNIL
;

776 
‰
;

777 
	`lua_push¡ršg
(
L
, 
ev’t
);

778 
‰
 = 
	`lua_¿wg‘
(
L
, -2);

779 ià(
‰
 =ğ
LUA_TNIL
)

780 
	`lua_pİ
(
L
, 2);

782 
	`lua_»move
(
L
, -2);

783  
‰
;

785 
	}
}

788 
LUALIB_API
 
	$luaL_ÿÎm‘a
 (
lua_S‹
 *
L
, 
obj
, cÚ¡ *
ev’t
) {

789 
obj
 = 
	`lua_absšdex
(
L
, obj);

790 ià(
	`luaL_g‘m‘af›ld
(
L
, 
obj
, 
ev’t
è=ğ
LUA_TNIL
)

792 
	`lua_pushv®ue
(
L
, 
obj
);

793 
	`lua_ÿÎ
(
L
, 1, 1);

795 
	}
}

798 
LUALIB_API
 
lua_IÁeg”
 
	$luaL_Ën
 (
lua_S‹
 *
L
, 
idx
) {

799 
lua_IÁeg”
 
l
;

800 
i¢um
;

801 
	`lua_Ën
(
L
, 
idx
);

802 
l
 = 
	`lua_toš‹g”x
(
L
, -1, &
i¢um
);

803 ià(!
i¢um
)

804 
	`luaL_”rÜ
(
L
, "object†ength is‚ot‡n integer");

805 
	`lua_pİ
(
L
, 1);

806  
l
;

807 
	}
}

810 
LUALIB_API
 cÚ¡ *
	$luaL_tŞ¡ršg
 (
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
) {

811 ià(
	`luaL_ÿÎm‘a
(
L
, 
idx
, "__tostring")) {

812 ià(!
	`lua_is¡ršg
(
L
, -1))

813 
	`luaL_”rÜ
(
L
, "'__tostring' must„eturn‡ string");

816 
	`lua_ty³
(
L
, 
idx
)) {

817 
LUA_TNUMBER
: {

818 ià(
	`lua_isš‹g”
(
L
, 
idx
))

819 
	`lua_pushf¡ršg
(
L
, "%I", (
LUAI_UACINT
)
	`lua_toš‹g”
(L, 
idx
));

821 
	`lua_pushf¡ršg
(
L
, "%f", (
LUAI_UACNUMBER
)
	`lua_tÚumb”
(L, 
idx
));

824 
LUA_TSTRING
:

825 
	`lua_pushv®ue
(
L
, 
idx
);

827 
LUA_TBOOLEAN
:

828 
	`lua_push¡ršg
(
L
, (
	`lua_toboŞ—n
(L, 
idx
) ? "true" : "false"));

830 
LUA_TNIL
:

831 
	`lua_pushl™”®
(
L
, "nil");

834 
‰
 = 
	`luaL_g‘m‘af›ld
(
L
, 
idx
, "__name");

835 cÚ¡ *
kšd
 = (
‰
 =ğ
LUA_TSTRING
è? 
	`lua_to¡ršg
(
L
, -1) :

836 
	`luaL_ty³Çme
(
L
, 
idx
);

837 
	`lua_pushf¡ršg
(
L
, "%s: %p", 
kšd
, 
	`lua_tİoš‹r
(L, 
idx
));

838 ià(
‰
 !ğ
LUA_TNIL
)

839 
	`lua_»move
(
L
, -2);

844  
	`lua_tŞ¡ršg
(
L
, -1, 
Ën
);

845 
	}
}

853 #ià
defšed
(
LUA_COMPAT_MODULE
)

855 cÚ¡ *
	$luaL_fšdbË
 (
lua_S‹
 *
L
, 
idx
,

856 cÚ¡ *
âame
, 
szhšt
) {

857 cÚ¡ *
e
;

858 ià(
idx
è
	`lua_pushv®ue
(
L
, idx);

860 
e
 = 
	`¡rchr
(
âame
, '.');

861 ià(
e
 =ğ
NULL
èğ
âame
 + 
	`¡¾’
(fname);

862 
	`lua_pushl¡ršg
(
L
, 
âame
, 
e
 - fname);

863 ià(
	`lua_¿wg‘
(
L
, -2è=ğ
LUA_TNIL
) {

864 
	`lua_pİ
(
L
, 1);

865 
	`lua_ü—‹bË
(
L
, 0, (*
e
 =ğ'.' ? 1 : 
szhšt
));

866 
	`lua_pushl¡ršg
(
L
, 
âame
, 
e
 - fname);

867 
	`lua_pushv®ue
(
L
, -2);

868 
	`lua_£‰abË
(
L
, -4);

870 ià(!
	`lua_i¡abË
(
L
, -1)) {

871 
	`lua_pİ
(
L
, 2);

872  
âame
;

874 
	`lua_»move
(
L
, -2);

875 
âame
 = 
e
 + 1;

876 } *
e
 == '.');

877  
NULL
;

878 
	}
}

884 
	$libsize
 (cÚ¡ 
luaL_Reg
 *
l
) {

885 
size
 = 0;

886 ; 
l
 &&†->
Çme
;†++è
size
++;

887  
size
;

888 
	}
}

897 
LUALIB_API
 
	$luaL_pushmoduË
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

898 
sizehšt
) {

899 
	`luaL_fšdbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
, 1);

900 ià(
	`lua_g‘f›ld
(
L
, -1, 
modÇme
è!ğ
LUA_TTABLE
) {

901 
	`lua_pİ
(
L
, 1);

903 
	`lua_pushglob®bË
(
L
);

904 ià(
	`luaL_fšdbË
(
L
, 0, 
modÇme
, 
sizehšt
è!ğ
NULL
)

905 
	`luaL_”rÜ
(
L
, "ÇmcÚæiù fÜ moduË '%s'", 
modÇme
);

906 
	`lua_pushv®ue
(
L
, -1);

907 
	`lua_£tf›ld
(
L
, -3, 
modÇme
);

909 
	`lua_»move
(
L
, -2);

910 
	}
}

913 
LUALIB_API
 
	$luaL_İ’lib
 (
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

914 cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

915 
	`luaL_checkv”siÚ
(
L
);

916 ià(
libÇme
) {

917 
	`luaL_pushmoduË
(
L
, 
libÇme
, 
	`libsize
(
l
));

918 
	`lua_š£¹
(
L
, -(
nup
 + 1));

920 ià(
l
)

921 
	`luaL_£tfuncs
(
L
, 
l
, 
nup
);

923 
	`lua_pİ
(
L
, 
nup
);

924 
	}
}

934 
LUALIB_API
 
	$luaL_£tfuncs
 (
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

935 
	`luaL_check¡ack
(
L
, 
nup
, "too many upvalues");

936 ; 
l
->
Çme
 !ğ
NULL
;†++) {

937 
i
;

938 
i
 = 0; i < 
nup
; i++)

939 
	`lua_pushv®ue
(
L
, -
nup
);

940 
	`lua_pushcşosu»
(
L
, 
l
->
func
, 
nup
);

941 
	`lua_£tf›ld
(
L
, -(
nup
 + 2), 
l
->
Çme
);

943 
	`lua_pİ
(
L
, 
nup
);

944 
	}
}

951 
LUALIB_API
 
	$luaL_g‘subbË
 (
lua_S‹
 *
L
, 
idx
, cÚ¡ *
âame
) {

952 ià(
	`lua_g‘f›ld
(
L
, 
idx
, 
âame
è=ğ
LUA_TTABLE
)

955 
	`lua_pİ
(
L
, 1);

956 
idx
 = 
	`lua_absšdex
(
L
, idx);

957 
	`lua_ÃwbË
(
L
);

958 
	`lua_pushv®ue
(
L
, -1);

959 
	`lua_£tf›ld
(
L
, 
idx
, 
âame
);

962 
	}
}

971 
LUALIB_API
 
	$luaL_»quœef
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

972 
lua_CFunùiÚ
 
İ’f
, 
glb
) {

973 
	`luaL_g‘subbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

974 
	`lua_g‘f›ld
(
L
, -1, 
modÇme
);

975 ià(!
	`lua_toboŞ—n
(
L
, -1)) {

976 
	`lua_pİ
(
L
, 1);

977 
	`lua_pushcfunùiÚ
(
L
, 
İ’f
);

978 
	`lua_push¡ršg
(
L
, 
modÇme
);

979 
	`lua_ÿÎ
(
L
, 1, 1);

980 
	`lua_pushv®ue
(
L
, -1);

981 
	`lua_£tf›ld
(
L
, -3, 
modÇme
);

983 
	`lua_»move
(
L
, -2);

984 ià(
glb
) {

985 
	`lua_pushv®ue
(
L
, -1);

986 
	`lua_£tglob®
(
L
, 
modÇme
);

988 
	}
}

991 
LUALIB_API
 cÚ¡ *
	$luaL_gsub
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
p
,

992 cÚ¡ *
r
) {

993 cÚ¡ *
wd
;

994 
size_t
 
l
 = 
	`¡¾’
(
p
);

995 
luaL_Bufãr
 
b
;

996 
	`luaL_buffš™
(
L
, &
b
);

997 (
wd
 = 
	`¡r¡r
(
s
, 
p
)è!ğ
NULL
) {

998 
	`luaL_addl¡ršg
(&
b
, 
s
, 
wd
 - s);

999 
	`luaL_add¡ršg
(&
b
, 
r
);

1000 
s
 = 
wd
 + 
l
;

1002 
	`luaL_add¡ršg
(&
b
, 
s
);

1003 
	`luaL_push»suÉ
(&
b
);

1004  
	`lua_to¡ršg
(
L
, -1);

1005 
	}
}

1008 *
	$l_®loc
 (*
ud
, *
±r
, 
size_t
 
osize
, size_ˆ
nsize
) {

1009 ()
ud
; ()
osize
;

1010 ià(
nsize
 == 0) {

1011 
	`ä“
(
±r
);

1012  
NULL
;

1015  
	`»®loc
(
±r
, 
nsize
);

1016 
	}
}

1019 
	$·nic
 (
lua_S‹
 *
L
) {

1020 
	`lua_wr™e¡ršg”rÜ
("PANIC: unprotectedƒrror in callo Lua API (%s)\n",

1021 
	`lua_to¡ršg
(
L
, -1));

1023 
	}
}

1026 
LUALIB_API
 
lua_S‹
 *
	$luaL_Ãw¡©e
 () {

1027 
lua_S‹
 *
L
 = 
	`lua_Ãw¡©e
(
l_®loc
, 
NULL
);

1028 ià(
L
è
	`lua_©·nic
(L, &
·nic
);

1029  
L
;

1030 
	}
}

1033 
LUALIB_API
 
	$luaL_checkv”siÚ_
 (
lua_S‹
 *
L
, 
lua_Numb”
 
v”
, 
size_t
 
sz
) {

1034 cÚ¡ 
lua_Numb”
 *
v
 = 
	`lua_v”siÚ
(
L
);

1035 ià(
sz
 !ğ
LUAL_NUMSIZES
)

1036 
	`luaL_”rÜ
(
L
, "core‡nd†ibrary have incompatible‚umericypes");

1037 ià(
v
 !ğ
	`lua_v”siÚ
(
NULL
))

1038 
	`luaL_”rÜ
(
L
, "multiple Lua VMs detected");

1039 ià(*
v
 !ğ
v”
)

1040 
	`luaL_”rÜ
(
L
, "version mismatch:‡pp.‚eeds %f, Lua core…rovides %f",

1041 (
LUAI_UACNUMBER
)
v”
, (LUAI_UACNUMBER)*
v
);

1042 
	}
}

1046 
	~"¥šlock.h
"

1048 
	scodeÿche
 {

1049 
¥šlock
 
	mlock
;

1050 
lua_S‹
 *
	mL
;

1053 
codeÿche
 
	gCC
;

1056 
	$ş—rÿche
() {

1057 ià(
CC
.
L
 =ğ
NULL
)

1059 
	`SPIN_LOCK
(&
CC
)

1060 
	`lua_şo£
(
CC
.
L
);

1061 
CC
.
L
 = 
	`luaL_Ãw¡©e
();

1062 
	`SPIN_UNLOCK
(&
CC
)

1063 
	}
}

1066 
	$š™
() {

1067 
	`SPIN_INIT
(&
CC
);

1068 
CC
.
L
 = 
	`luaL_Ãw¡©e
();

1069 
	}
}

1072 
	$lßd
(cÚ¡ *
key
) {

1073 ià(
CC
.
L
 =ğ
NULL
)

1074  
NULL
;

1075 
	`SPIN_LOCK
(&
CC
)

1076 
lua_S‹
 *
L
 = 
CC
.L;

1077 
	`lua_push¡ršg
(
L
, 
key
);

1078 
	`lua_¿wg‘
(
L
, 
LUA_REGISTRYINDEX
);

1079 cÚ¡ * 
»suÉ
 = 
	`lua_tou£rd©a
(
L
, -1);

1080 
	`lua_pİ
(
L
, 1);

1081 
	`SPIN_UNLOCK
(&
CC
)

1083  
»suÉ
;

1084 
	}
}

1087 
	$§ve
(cÚ¡ *
key
, cÚ¡ * 
´Ùo
) {

1088 
lua_S‹
 *
L
;

1089 cÚ¡ * 
»suÉ
 = 
NULL
;

1091 
	`SPIN_LOCK
(&
CC
)

1092 ià(
CC
.
L
 =ğ
NULL
) {

1093 
	`š™
();

1094 
L
 = 
CC
.L;

1096 
L
 = 
CC
.L;

1097 
	`lua_push¡ršg
(
L
, 
key
);

1098 
	`lua_pushv®ue
(
L
, -1);

1099 
	`lua_¿wg‘
(
L
, 
LUA_REGISTRYINDEX
);

1100 
»suÉ
 = 
	`lua_tou£rd©a
(
L
, -1);

1101 ià(
»suÉ
 =ğ
NULL
) {

1102 
	`lua_pİ
(
L
,1);

1103 
	`lua_pushlightu£rd©a
(
L
, (*)
´Ùo
);

1104 
	`lua_¿w£t
(
L
, 
LUA_REGISTRYINDEX
);

1106 
	`lua_pİ
(
L
,2);

1109 
	`SPIN_UNLOCK
(&
CC
)

1110  
»suÉ
;

1111 
	}
}

1113 
	#CACHE_OFF
 0

	)

1114 
	#CACHE_EXIST
 1

	)

1115 
	#CACHE_ON
 2

	)

1117 
	gÿche_key
 = 0;

1119 
	$ÿche_Ëv–
(
lua_S‹
 *
L
) {

1120 
t
 = 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
ÿche_key
);

1121 
r
 = 
	`lua_toš‹g”
(
L
, -1);

1122 
	`lua_pİ
(
L
,1);

1123 ià(
t
 =ğ
LUA_TNUMBER
) {

1124  
r
;

1126  
CACHE_ON
;

1127 
	}
}

1129 
	$ÿche_mode
(
lua_S‹
 *
L
) {

1130 cÚ¡ * 
l¡
[] = {

1134 
NULL
,

1136 ià(
	`lua_i¢ÚeÜn
(
L
,1)) {

1137 
t
 = 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
ÿche_key
);

1138 
r
 = 
	`lua_toš‹g”
(
L
, -1);

1139 ià(
t
 =ğ
LUA_TNUMBER
) {

1140 ià(
r
 < 0 ||„ >ğ
CACHE_ON
) {

1141 
r
 = 
CACHE_ON
;

1144 
r
 = 
CACHE_ON
;

1146 
	`lua_push¡ršg
(
L
, 
l¡
[
r
]);

1149 
t
 = 
	`luaL_checkİtiÚ
(
L
, 1, "OFF" , 
l¡
);

1150 
	`lua_pushš‹g”
(
L
, 
t
);

1151 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, &
ÿche_key
);

1153 
	}
}

1155 
LUALIB_API
 
	$luaL_lßdfex
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
,

1156 cÚ¡ *
mode
) {

1157 
Ëv–
 = 
	`ÿche_Ëv–
(
L
);

1158 ià(
Ëv–
 =ğ
CACHE_OFF
) {

1159  
	`luaL_lßdfex_
(
L
, 
f’ame
, 
mode
);

1161 cÚ¡ * 
´Ùo
 = 
	`lßd
(
f’ame
);

1162 ià(
´Ùo
) {

1163 
	`lua_şÚefunùiÚ
(
L
, 
´Ùo
);

1164  
LUA_OK
;

1166 ià(
Ëv–
 =ğ
CACHE_EXIST
) {

1167  
	`luaL_lßdfex_
(
L
, 
f’ame
, 
mode
);

1169 
lua_S‹
 * 
eL
 = 
	`luaL_Ãw¡©e
();

1170 ià(
eL
 =ğ
NULL
) {

1171 
	`lua_pushl™”®
(
L
, "New state failed");

1172  
LUA_ERRMEM
;

1174 
”r
 = 
	`luaL_lßdfex_
(
eL
, 
f’ame
, 
mode
);

1175 ià(
”r
 !ğ
LUA_OK
) {

1176 
size_t
 
sz
 = 0;

1177 cÚ¡ * 
msg
 = 
	`lua_tŞ¡ršg
(
eL
, -1, &
sz
);

1178 
	`lua_pushl¡ršg
(
L
, 
msg
, 
sz
);

1179 
	`lua_şo£
(
eL
);

1180  
”r
;

1182 
´Ùo
 = 
	`lua_tİoš‹r
(
eL
, -1);

1183 cÚ¡ * 
Şdv
 = 
	`§ve
(
f’ame
, 
´Ùo
);

1184 ià(
Şdv
) {

1185 
	`lua_şo£
(
eL
);

1186 
	`lua_şÚefunùiÚ
(
L
, 
Şdv
);

1188 
	`lua_şÚefunùiÚ
(
L
, 
´Ùo
);

1192  
LUA_OK
;

1193 
	}
}

1196 
	$ÿche_ş—r
(
lua_S‹
 *
L
) {

1197 ()(
L
);

1198 
	`ş—rÿche
();

1200 
	}
}

1202 
LUAMOD_API
 
	$luaİ’_ÿche
(
lua_S‹
 *
L
) {

1203 
luaL_Reg
 
l
[] = {

1204 { "ş—r", 
ÿche_ş—r
 },

1205 { "mode", 
ÿche_mode
 },

1206 { 
NULL
, NULL },

1208 
	`luaL_Ãwlib
(
L
,
l
);

1209 
	`lua_g‘glob®
(
L
, "loadfile");

1210 
	`lua_£tf›ld
(
L
, -2, "loadfile");

1212 
	}
}

	@3rd/lua/lauxlib.h

8 #iâdeà
Ïuxlib_h


9 
	#Ïuxlib_h


	)

12 
	~<¡ddef.h
>

13 
	~<¡dio.h
>

15 
	~"lua.h
"

20 
	#LUA_ERRFILE
 (
LUA_ERRERR
+1)

	)

24 
	#LUA_LOADED_TABLE
 "_LOADED"

	)

28 
	#LUA_PRELOAD_TABLE
 "_PRELOAD"

	)

31 
	sluaL_Reg
 {

32 cÚ¡ *
	mÇme
;

33 
lua_CFunùiÚ
 
	mfunc
;

34 } 
	tluaL_Reg
;

37 
	#LUAL_NUMSIZES
 ((
lua_IÁeg”
)*16 + (
lua_Numb”
))

	)

39 
LUALIB_API
 (
luaL_checkv”siÚ_
è(
lua_S‹
 *
L
, 
lua_Numb”
 
v”
, 
size_t
 
sz
);

40 
	#luaL_checkv”siÚ
(
L
) \

41 
	`luaL_checkv”siÚ_
(
L
, 
LUA_VERSION_NUM
, 
LUAL_NUMSIZES
)

	)

43 
LUALIB_API
 (
luaL_g‘m‘af›ld
è(
lua_S‹
 *
L
, 
obj
, cÚ¡ *
e
);

44 
LUALIB_API
 (
luaL_ÿÎm‘a
è(
lua_S‹
 *
L
, 
obj
, cÚ¡ *
e
);

45 
LUALIB_API
 cÚ¡ *(
luaL_tŞ¡ršg
è(
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
);

46 
LUALIB_API
 (
luaL_¬g”rÜ
è(
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
exŒamsg
);

47 
LUALIB_API
 cÚ¡ *(
luaL_checkl¡ršg
è(
lua_S‹
 *
L
, 
¬g
,

48 
size_t
 *
l
);

49 
LUALIB_API
 cÚ¡ *(
luaL_İ¡ršg
è(
lua_S‹
 *
L
, 
¬g
,

50 cÚ¡ *
def
, 
size_t
 *
l
);

51 
LUALIB_API
 
	$lua_Numb”
 (
luaL_checknumb”
è(
lua_S‹
 *
L
, 
¬g
);

52 
LUALIB_API
 
	$lua_Numb”
 (
luaL_İŠumb”
è(
lua_S‹
 *
L
, 
¬g
, 
lua_Numb”
 
def
);

54 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_checkš‹g”
è(
lua_S‹
 *
L
, 
¬g
);

55 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_İtš‹g”
è(
lua_S‹
 *
L
, 
¬g
,

56 
lua_IÁeg”
 
def
);

58 
LUALIB_API
 (
luaL_check¡ack
è(
lua_S‹
 *
L
, 
sz
, cÚ¡ *
msg
);

59 
LUALIB_API
 (
luaL_checkty³
è(
lua_S‹
 *
L
, 
¬g
, 
t
);

60 
LUALIB_API
 (
luaL_checkªy
è(
lua_S‹
 *
L
, 
¬g
);

62 
LUALIB_API
 (
luaL_Ãwm‘©abË
è(
lua_S‹
 *
L
, cÚ¡ *
Šame
);

63 
LUALIB_API
 (
luaL_£tm‘©abË
è(
lua_S‹
 *
L
, cÚ¡ *
Šame
);

64 
LUALIB_API
 *(
luaL_‹¡ud©a
è(
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
);

65 
LUALIB_API
 *(
luaL_checkud©a
è(
lua_S‹
 *
L
, 
ud
, cÚ¡ *
Šame
);

67 
LUALIB_API
 (
luaL_wh”e
è(
lua_S‹
 *
L
, 
lvl
);

68 
LUALIB_API
 (
luaL_”rÜ
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

70 
LUALIB_API
 (
luaL_checkİtiÚ
è(
lua_S‹
 *
L
, 
¬g
, cÚ¡ *
def
,

71 cÚ¡ *cÚ¡ 
l¡
[]);

73 
LUALIB_API
 (
luaL_f”esuÉ
è(
lua_S‹
 *
L
, 
¡©
, cÚ¡ *
âame
);

74 
LUALIB_API
 (
luaL_exeüesuÉ
è(
lua_S‹
 *
L
, 
¡©
);

77 
	#LUA_NOREF
 (-2)

	)

78 
	#LUA_REFNIL
 (-1)

	)

80 
LUALIB_API
 (
luaL_»f
è(
lua_S‹
 *
L
, 
t
);

81 
LUALIB_API
 (
luaL_uÄef
è(
lua_S‹
 *
L
, 
t
, 
»f
);

83 
LUALIB_API
 (
luaL_lßdfex
è(
lua_S‹
 *
L
, cÚ¡ *
f’ame
,

84 cÚ¡ *
mode
);

86 
	#luaL_lßdfe
(
L
,
f
è
	`luaL_lßdfex
(L,f,
NULL
)

	)

88 
LUALIB_API
 (
luaL_lßdbufãrx
è(
lua_S‹
 *
L
, cÚ¡ *
buff
, 
size_t
 
sz
,

89 cÚ¡ *
Çme
, cÚ¡ *
mode
);

90 
LUALIB_API
 (
luaL_lßd¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

92 
LUALIB_API
 
lua_S‹
 *(
luaL_Ãw¡©e
) ();

94 
LUALIB_API
 
	$lua_IÁeg”
 (
luaL_Ën
è(
lua_S‹
 *
L
, 
idx
);

96 
LUALIB_API
 cÚ¡ *(
luaL_gsub
è(
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
p
,

97 cÚ¡ *
r
);

99 
LUALIB_API
 (
luaL_£tfuncs
è(
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
);

101 
LUALIB_API
 (
luaL_g‘subbË
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
âame
);

103 
LUALIB_API
 (
luaL_Œaûback
è(
lua_S‹
 *
L
,†ua_S‹ *
L1
,

104 cÚ¡ *
msg
, 
Ëv–
);

106 
LUALIB_API
 (
luaL_»quœef
è(
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

107 
lua_CFunùiÚ
 
İ’f
, 
glb
);

116 
	#luaL_ÃwlibbË
(
L
,
l
) \

117 
	`lua_ü—‹bË
(
L
, 0, (
l
)/(Ö)[0]è- 1)

	)

119 
	#luaL_Ãwlib
(
L
,
l
) \

120 (
	`luaL_checkv”siÚ
(
L
), 
	`luaL_ÃwlibbË
(L,
l
), 
	`luaL_£tfuncs
(L,l,0))

	)

122 
	#luaL_¬gcheck
(
L
, 
cÚd
,
¬g
,
exŒamsg
) \

123 (()((
cÚd
è|| 
	`luaL_¬g”rÜ
(
L
, (
¬g
), (
exŒamsg
))))

	)

124 
	#luaL_check¡ršg
(
L
,
n
è(
	`luaL_checkl¡ršg
(L, (n), 
NULL
))

	)

125 
	#luaL_İt¡ršg
(
L
,
n
,
d
è(
	`luaL_İ¡ršg
(L, (n), (d), 
NULL
))

	)

127 
	#luaL_ty³Çme
(
L
,
i
è
	`lua_ty³Çme
(L, 
	`lua_ty³
(L,(i)))

	)

129 
	#luaL_dofe
(
L
, 
â
) \

130 (
	`luaL_lßdfe
(
L
, 
â
è|| 
	`lua_pÿÎ
(L, 0, 
LUA_MULTRET
, 0))

	)

132 
	#luaL_do¡ršg
(
L
, 
s
) \

133 (
	`luaL_lßd¡ršg
(
L
, 
s
è|| 
	`lua_pÿÎ
(L, 0, 
LUA_MULTRET
, 0))

	)

135 
	#luaL_g‘m‘©abË
(
L
,
n
è(
	`lua_g‘f›ld
(L, 
LUA_REGISTRYINDEX
, (n)))

	)

137 
	#luaL_İt
(
L
,
f
,
n
,
d
è(
	`lua_i¢ÚeÜn
(L,Ò)è? (dè: 
	`f
(L,Ò)))

	)

139 
	#luaL_lßdbufãr
(
L
,
s
,
sz
,
n
è
	`luaL_lßdbufãrx
(L,s,sz,n,
NULL
)

	)

148 
	sluaL_Bufãr
 {

149 *
b
;

150 
size_t
 
size
;

151 
size_t
 
n
;

152 
lua_S‹
 *
L
;

153 
š™b
[
LUAL_BUFFERSIZE
];

154 } 
	tluaL_Bufãr
;

157 
	#luaL_addch¬
(
B
,
c
) \

158 (()((
B
)->
n
 < (B)->
size
 || 
	`luaL_´•buffsize
((B), 1)), \

159 ((
B
)->
b
[(B)->
n
++] = (
c
)))

	)

161 
	#luaL_addsize
(
B
,
s
è((B)->
n
 +ğ(s))

	)

163 
LUALIB_API
 (
luaL_buffš™
è(
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
);

164 
LUALIB_API
 *(
luaL_´•buffsize
è(
luaL_Bufãr
 *
B
, 
size_t
 
sz
);

165 
LUALIB_API
 (
luaL_addl¡ršg
è(
luaL_Bufãr
 *
B
, cÚ¡ *
s
, 
size_t
 
l
);

166 
LUALIB_API
 (
luaL_add¡ršg
è(
luaL_Bufãr
 *
B
, cÚ¡ *
s
);

167 
LUALIB_API
 (
luaL_addv®ue
è(
luaL_Bufãr
 *
B
);

168 
LUALIB_API
 (
luaL_push»suÉ
è(
luaL_Bufãr
 *
B
);

169 
LUALIB_API
 (
luaL_push»suÉsize
è(
luaL_Bufãr
 *
B
, 
size_t
 
sz
);

170 
LUALIB_API
 *(
luaL_buffš™size
è(
lua_S‹
 *
L
, 
luaL_Bufãr
 *
B
, 
size_t
 
sz
);

172 
	#luaL_´•bufãr
(
B
è
	`luaL_´•buffsize
(B, 
LUAL_BUFFERSIZE
)

	)

190 
	#LUA_FILEHANDLE
 "FILE*"

	)

193 
	sluaL_SŒ—m
 {

194 
FILE
 *
f
;

195 
lua_CFunùiÚ
 
şo£f
;

196 } 
	tluaL_SŒ—m
;

203 #ià
	`defšed
(
LUA_COMPAT_MODULE
)

205 
LUALIB_API
 (
luaL_pushmoduË
è(
lua_S‹
 *
L
, cÚ¡ *
modÇme
,

206 
sizehšt
);

207 
LUALIB_API
 (
luaL_İ’lib
è(
lua_S‹
 *
L
, cÚ¡ *
libÇme
,

208 cÚ¡ 
luaL_Reg
 *
l
, 
nup
);

210 
	#luaL_»gi¡”
(
L
,
n
,
l
è(
	`luaL_İ’lib
(L,Ò),Ö),0))

	)

222 #ià!
	`defšed
(
lua_wr™e¡ršg
)

223 
	#lua_wr™e¡ršg
(
s
,
l
è
	`fwr™e
((s), (), (l), 
¡dout
)

	)

227 #ià!
	`defšed
(
lua_wr™–še
)

228 
	#lua_wr™–še
(è(
	`lua_wr™e¡ršg
("\n", 1), 
	`fæush
(
¡dout
))

	)

232 #ià!
	`defšed
(
lua_wr™e¡ršg”rÜ
)

233 
	#lua_wr™e¡ršg”rÜ
(
s
,
p
) \

234 (
	`årštf
(
¡d”r
, (
s
), (
p
)), 
	`fæush
(¡d”r))

	)

245 #ià
	`defšed
(
LUA_COMPAT_APIINTCASTS
)

247 
	#luaL_checkunsigÃd
(
L
,
a
è((
lua_UnsigÃd
)
	`luaL_checkš‹g”
(L,a))

	)

248 
	#luaL_İtunsigÃd
(
L
,
a
,
d
) \

249 ((
lua_UnsigÃd
)
	`luaL_İtš‹g”
(
L
,
a
,(
lua_IÁeg”
)(
d
)))

	)

251 
	#luaL_checkšt
(
L
,
n
è(()
	`luaL_checkš‹g”
(L, (n)))

	)

252 
	#luaL_İtšt
(
L
,
n
,
d
è(()
	`luaL_İtš‹g”
(L, (n), (d)))

	)

254 
	#luaL_checklÚg
(
L
,
n
è(()
	`luaL_checkš‹g”
(L, (n)))

	)

255 
	#luaL_İÚg
(
L
,
n
,
d
è(()
	`luaL_İtš‹g”
(L, (n), (d)))

	)

	@3rd/lua/lbaselib.c

7 
	#lba£lib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<ùy³.h
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"lua.h
"

20 
	~"Ïuxlib.h
"

21 
	~"lu®ib.h
"

24 
	$luaB_´št
 (
lua_S‹
 *
L
) {

25 
n
 = 
	`lua_g‘tİ
(
L
);

26 
i
;

27 
	`lua_g‘glob®
(
L
, "tostring");

28 
i
=1; i<=
n
; i++) {

29 cÚ¡ *
s
;

30 
size_t
 
l
;

31 
	`lua_pushv®ue
(
L
, -1);

32 
	`lua_pushv®ue
(
L
, 
i
);

33 
	`lua_ÿÎ
(
L
, 1, 1);

34 
s
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
l
);

35 ià(
s
 =ğ
NULL
)

36  
	`luaL_”rÜ
(
L
, "'tostring' must„eturn‡ stringo 'print'");

37 ià(
i
>1è
	`lua_wr™e¡ršg
("\t", 1);

38 
	`lua_wr™e¡ršg
(
s
, 
l
);

39 
	`lua_pİ
(
L
, 1);

41 
	`lua_wr™–še
();

43 
	}
}

46 
	#SPACECHARS
 " \f\n\r\t\v"

	)

48 cÚ¡ *
	$b_¡r2št
 (cÚ¡ *
s
, 
ba£
, 
lua_IÁeg”
 *
²
) {

49 
lua_UnsigÃd
 
n
 = 0;

50 
Ãg
 = 0;

51 
s
 +ğ
	`¡r¥n
(s, 
SPACECHARS
);

52 ià(*
s
 =ğ'-'è{ s++; 
Ãg
 = 1; }

53 ià(*
s
 == '+') s++;

54 ià(!
	`i§Êum
(()*
s
))

55  
NULL
;

57 
dig™
 = (
	`isdig™
(()*
s
)) ? *s - '0'

58 : (
	`touµ”
(()*
s
) - 'A') + 10;

59 ià(
dig™
 >ğ
ba£
è 
NULL
;

60 
n
 =‚ * 
ba£
 + 
dig™
;

61 
s
++;

62 } 
	`i§Êum
(()*
s
));

63 
s
 +ğ
	`¡r¥n
(s, 
SPACECHARS
);

64 *
²
 = (
lua_IÁeg”
)((
Ãg
è? (0u - 
n
) :‚);

65  
s
;

66 
	}
}

69 
	$luaB_tÚumb”
 (
lua_S‹
 *
L
) {

70 ià(
	`lua_i¢ÚeÜn
(
L
, 2)) {

71 
	`luaL_checkªy
(
L
, 1);

72 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TNUMBER
) {

73 
	`lua_£‰İ
(
L
, 1);

77 
size_t
 
l
;

78 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
l
);

79 ià(
s
 !ğ
NULL
 && 
	`lua_¡ršgtÚumb”
(
L
, sè=ğ
l
 + 1)

85 
size_t
 
l
;

86 cÚ¡ *
s
;

87 
lua_IÁeg”
 
n
 = 0;

88 
lua_IÁeg”
 
ba£
 = 
	`luaL_checkš‹g”
(
L
, 2);

89 
	`luaL_checkty³
(
L
, 1, 
LUA_TSTRING
);

90 
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
l
);

91 
	`luaL_¬gcheck
(
L
, 2 <ğ
ba£
 && base <= 36, 2, "base out of„ange");

92 ià(
	`b_¡r2št
(
s
, ()
ba£
, &
n
è=ğ + 
l
) {

93 
	`lua_pushš‹g”
(
L
, 
n
);

97 
	`lua_pushn
(
L
);

99 
	}
}

102 
	$luaB_”rÜ
 (
lua_S‹
 *
L
) {

103 
Ëv–
 = ()
	`luaL_İtš‹g”
(
L
, 2, 1);

104 
	`lua_£‰İ
(
L
, 1);

105 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TSTRING
 && 
Ëv–
 > 0) {

106 
	`luaL_wh”e
(
L
, 
Ëv–
);

107 
	`lua_pushv®ue
(
L
, 1);

108 
	`lua_cÚÿt
(
L
, 2);

110  
	`lua_”rÜ
(
L
);

111 
	}
}

114 
	$luaB_g‘m‘©abË
 (
lua_S‹
 *
L
) {

115 
	`luaL_checkªy
(
L
, 1);

116 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

117 
	`lua_pushn
(
L
);

120 
	`luaL_g‘m‘af›ld
(
L
, 1, "__metatable");

122 
	}
}

125 
	$luaB_£tm‘©abË
 (
lua_S‹
 *
L
) {

126 
t
 = 
	`lua_ty³
(
L
, 2);

127 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

128 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TNIL
 || =ğ
LUA_TTABLE
, 2,

130 ià(
	`luaL_g‘m‘af›ld
(
L
, 1, "__m‘©abË"è!ğ
LUA_TNIL
)

131  
	`luaL_”rÜ
(
L
, "cannot change‡…rotected metatable");

132 
	`lua_£‰İ
(
L
, 2);

133 
	`lua_£tm‘©abË
(
L
, 1);

135 
	}
}

138 
	$luaB_¿wequ®
 (
lua_S‹
 *
L
) {

139 
	`luaL_checkªy
(
L
, 1);

140 
	`luaL_checkªy
(
L
, 2);

141 
	`lua_pushboŞ—n
(
L
, 
	`lua_¿wequ®
(L, 1, 2));

143 
	}
}

146 
	$luaB_¿wËn
 (
lua_S‹
 *
L
) {

147 
t
 = 
	`lua_ty³
(
L
, 1);

148 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TTABLE
 || =ğ
LUA_TSTRING
, 1,

150 
	`lua_pushš‹g”
(
L
, 
	`lua_¿wËn
(L, 1));

152 
	}
}

155 
	$luaB_¿wg‘
 (
lua_S‹
 *
L
) {

156 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

157 
	`luaL_checkªy
(
L
, 2);

158 
	`lua_£‰İ
(
L
, 2);

159 
	`lua_¿wg‘
(
L
, 1);

161 
	}
}

163 
	$luaB_¿w£t
 (
lua_S‹
 *
L
) {

164 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

165 
	`luaL_checkªy
(
L
, 2);

166 
	`luaL_checkªy
(
L
, 3);

167 
	`lua_£‰İ
(
L
, 3);

168 
	`lua_¿w£t
(
L
, 1);

170 
	}
}

173 
	$luaB_cŞËùg¬bage
 (
lua_S‹
 *
L
) {

174 cÚ¡ *cÚ¡ 
İts
[] = {"stop", "restart", "collect",

176 "i¤uÂšg", 
NULL
};

177 cÚ¡ 
İt¢um
[] = {
LUA_GCSTOP
, 
LUA_GCRESTART
, 
LUA_GCCOLLECT
,

178 
LUA_GCCOUNT
, 
LUA_GCSTEP
, 
LUA_GCSETPAUSE
, 
LUA_GCSETSTEPMUL
,

179 
LUA_GCISRUNNING
};

180 
o
 = 
İt¢um
[
	`luaL_checkİtiÚ
(
L
, 1, "cŞËù", 
İts
)];

181 
ex
 = ()
	`luaL_İtš‹g”
(
L
, 2, 0);

182 
»s
 = 
	`lua_gc
(
L
, 
o
, 
ex
);

183 
o
) {

184 
LUA_GCCOUNT
: {

185 
b
 = 
	`lua_gc
(
L
, 
LUA_GCCOUNTB
, 0);

186 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
»s
 + (Öua_Numb”)
b
/1024));

189 
LUA_GCSTEP
: 
LUA_GCISRUNNING
: {

190 
	`lua_pushboŞ—n
(
L
, 
»s
);

194 
	`lua_pushš‹g”
(
L
, 
»s
);

198 
	}
}

201 
	$luaB_ty³
 (
lua_S‹
 *
L
) {

202 
t
 = 
	`lua_ty³
(
L
, 1);

203 
	`luaL_¬gcheck
(
L
, 
t
 !ğ
LUA_TNONE
, 1, "valueƒxpected");

204 
	`lua_push¡ršg
(
L
, 
	`lua_ty³Çme
(L, 
t
));

206 
	}
}

209 
	$·œsm‘a
 (
lua_S‹
 *
L
, cÚ¡ *
m‘hod
, 
isz”o
,

210 
lua_CFunùiÚ
 
™”
) {

211 
	`luaL_checkªy
(
L
, 1);

212 ià(
	`luaL_g‘m‘af›ld
(
L
, 1, 
m‘hod
è=ğ
LUA_TNIL
) {

213 
	`lua_pushcfunùiÚ
(
L
, 
™”
);

214 
	`lua_pushv®ue
(
L
, 1);

215 ià(
isz”o
è
	`lua_pushš‹g”
(
L
, 0);

216 
	`lua_pushn
(
L
);

219 
	`lua_pushv®ue
(
L
, 1);

220 
	`lua_ÿÎ
(
L
, 1, 3);

223 
	}
}

226 
	$luaB_Ãxt
 (
lua_S‹
 *
L
) {

227 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

228 
	`lua_£‰İ
(
L
, 2);

229 ià(
	`lua_Ãxt
(
L
, 1))

232 
	`lua_pushn
(
L
);

235 
	}
}

238 
	$luaB_·œs
 (
lua_S‹
 *
L
) {

239  
	`·œsm‘a
(
L
, "__·œs", 0, 
luaB_Ãxt
);

240 
	}
}

246 
	$aœ§ux
 (
lua_S‹
 *
L
) {

247 
lua_IÁeg”
 
i
 = 
	`luaL_checkš‹g”
(
L
, 2) + 1;

248 
	`lua_pushš‹g”
(
L
, 
i
);

249  (
	`lua_g‘i
(
L
, 1, 
i
è=ğ
LUA_TNIL
) ? 1 : 2;

250 
	}
}

257 
	$luaB_aœs
 (
lua_S‹
 *
L
) {

258 #ià
	`defšed
(
LUA_COMPAT_IPAIRS
)

259  
	`·œsm‘a
(
L
, "__aœs", 1, 
aœ§ux
);

261 
	`luaL_checkªy
(
L
, 1);

262 
	`lua_pushcfunùiÚ
(
L
, 
aœ§ux
);

263 
	`lua_pushv®ue
(
L
, 1);

264 
	`lua_pushš‹g”
(
L
, 0);

267 
	}
}

270 
	$lßd_aux
 (
lua_S‹
 *
L
, 
¡©us
, 
’vidx
) {

271 ià(
¡©us
 =ğ
LUA_OK
) {

272 ià(
’vidx
 != 0) {

273 
	`lua_pushv®ue
(
L
, 
’vidx
);

274 ià(!
	`lua_£tupv®ue
(
L
, -2, 1))

275 
	`lua_pİ
(
L
, 1);

280 
	`lua_pushn
(
L
);

281 
	`lua_š£¹
(
L
, -2);

284 
	}
}

287 
	$luaB_lßdfe
 (
lua_S‹
 *
L
) {

288 cÚ¡ *
âame
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

289 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, 
NULL
);

290 
’v
 = (!
	`lua_i¢Úe
(
L
, 3) ? 3 : 0);

291 
¡©us
 = 
	`luaL_lßdfex
(
L
, 
âame
, 
mode
);

292  
	`lßd_aux
(
L
, 
¡©us
, 
’v
);

293 
	}
}

308 
	#RESERVEDSLOT
 5

	)

317 cÚ¡ *
	$g’”ic_»ad”
 (
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
) {

318 ()(
ud
);

319 
	`luaL_check¡ack
(
L
, 2, "too many‚ested functions");

320 
	`lua_pushv®ue
(
L
, 1);

321 
	`lua_ÿÎ
(
L
, 0, 1);

322 ià(
	`lua_i¢
(
L
, -1)) {

323 
	`lua_pİ
(
L
, 1);

324 *
size
 = 0;

325  
NULL
;

327 ià(!
	`lua_is¡ršg
(
L
, -1))

328 
	`luaL_”rÜ
(
L
, "reader function must„eturn‡ string");

329 
	`lua_»¶aû
(
L
, 
RESERVEDSLOT
);

330  
	`lua_tŞ¡ršg
(
L
, 
RESERVEDSLOT
, 
size
);

331 
	}
}

334 
	$luaB_lßd
 (
lua_S‹
 *
L
) {

335 
¡©us
;

336 
size_t
 
l
;

337 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
l
);

338 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 3, "bt");

339 
’v
 = (!
	`lua_i¢Úe
(
L
, 4) ? 4 : 0);

340 ià(
s
 !ğ
NULL
) {

341 cÚ¡ *
chunkÇme
 = 
	`luaL_İt¡ršg
(
L
, 2, 
s
);

342 
¡©us
 = 
	`luaL_lßdbufãrx
(
L
, 
s
, 
l
, 
chunkÇme
, 
mode
);

345 cÚ¡ *
chunkÇme
 = 
	`luaL_İt¡ršg
(
L
, 2, "=(load)");

346 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

347 
	`lua_£‰İ
(
L
, 
RESERVEDSLOT
);

348 
¡©us
 = 
	`lua_lßd
(
L
, 
g’”ic_»ad”
, 
NULL
, 
chunkÇme
, 
mode
);

350  
	`lßd_aux
(
L
, 
¡©us
, 
’v
);

351 
	}
}

356 
	$dofecÚt
 (
lua_S‹
 *
L
, 
d1
, 
lua_KCÚ‹xt
 
d2
) {

357 ()
d1
; ()
d2
;

358  
	`lua_g‘tİ
(
L
) - 1;

359 
	}
}

362 
	$luaB_dofe
 (
lua_S‹
 *
L
) {

363 cÚ¡ *
âame
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

364 
	`lua_£‰İ
(
L
, 1);

365 ià(
	`luaL_lßdfe
(
L
, 
âame
è!ğ
LUA_OK
)

366  
	`lua_”rÜ
(
L
);

367 
	`lua_ÿÎk
(
L
, 0, 
LUA_MULTRET
, 0, 
dofecÚt
);

368  
	`dofecÚt
(
L
, 0, 0);

369 
	}
}

372 
	$luaB_as£¹
 (
lua_S‹
 *
L
) {

373 ià(
	`lua_toboŞ—n
(
L
, 1))

374  
	`lua_g‘tİ
(
L
);

376 
	`luaL_checkªy
(
L
, 1);

377 
	`lua_»move
(
L
, 1);

378 
	`lua_pushl™”®
(
L
, "assertion failed!");

379 
	`lua_£‰İ
(
L
, 1);

380  
	`luaB_”rÜ
(
L
);

382 
	}
}

385 
	$luaB_£Ëù
 (
lua_S‹
 *
L
) {

386 
n
 = 
	`lua_g‘tİ
(
L
);

387 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TSTRING
 && *
	`lua_to¡ršg
(L, 1) == '#') {

388 
	`lua_pushš‹g”
(
L
, 
n
-1);

392 
lua_IÁeg”
 
i
 = 
	`luaL_checkš‹g”
(
L
, 1);

393 ià(
i
 < 0è˜ğ
n
 + i;

394 ià(
i
 > 
n
) i =‚;

395 
	`luaL_¬gcheck
(
L
, 1 <ğ
i
, 1, "index out of„ange");

396  
n
 - ()
i
;

398 
	}
}

408 
	$fšishpÿÎ
 (
lua_S‹
 *
L
, 
¡©us
, 
lua_KCÚ‹xt
 
exŒa
) {

409 ià(
¡©us
 !ğ
LUA_OK
 && stu !ğ
LUA_YIELD
) {

410 
	`lua_pushboŞ—n
(
L
, 0);

411 
	`lua_pushv®ue
(
L
, -2);

415  
	`lua_g‘tİ
(
L
è- ()
exŒa
;

416 
	}
}

419 
	$luaB_pÿÎ
 (
lua_S‹
 *
L
) {

420 
¡©us
;

421 
	`luaL_checkªy
(
L
, 1);

422 
	`lua_pushboŞ—n
(
L
, 1);

423 
	`lua_š£¹
(
L
, 1);

424 
¡©us
 = 
	`lua_pÿÎk
(
L
, 
	`lua_g‘tİ
(Lè- 2, 
LUA_MULTRET
, 0, 0, 
fšishpÿÎ
);

425  
	`fšishpÿÎ
(
L
, 
¡©us
, 0);

426 
	}
}

434 
	$luaB_xpÿÎ
 (
lua_S‹
 *
L
) {

435 
¡©us
;

436 
n
 = 
	`lua_g‘tİ
(
L
);

437 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

438 
	`lua_pushboŞ—n
(
L
, 1);

439 
	`lua_pushv®ue
(
L
, 1);

440 
	`lua_rÙ©e
(
L
, 3, 2);

441 
¡©us
 = 
	`lua_pÿÎk
(
L
, 
n
 - 2, 
LUA_MULTRET
, 2, 2, 
fšishpÿÎ
);

442  
	`fšishpÿÎ
(
L
, 
¡©us
, 2);

443 
	}
}

446 
	$luaB_to¡ršg
 (
lua_S‹
 *
L
) {

447 
	`luaL_checkªy
(
L
, 1);

448 
	`luaL_tŞ¡ršg
(
L
, 1, 
NULL
);

450 
	}
}

453 cÚ¡ 
luaL_Reg
 
	gba£_funcs
[] = {

454 {"as£¹", 
luaB_as£¹
},

455 {"cŞËùg¬bage", 
luaB_cŞËùg¬bage
},

456 {"dofe", 
luaB_dofe
},

457 {"”rÜ", 
luaB_”rÜ
},

458 {"g‘m‘©abË", 
luaB_g‘m‘©abË
},

459 {"aœs", 
luaB_aœs
},

460 {"lßdfe", 
luaB_lßdfe
},

461 {"lßd", 
luaB_lßd
},

462 #ià
defšed
(
LUA_COMPAT_LOADSTRING
)

463 {"lßd¡ršg", 
luaB_lßd
},

465 {"Ãxt", 
luaB_Ãxt
},

466 {"·œs", 
luaB_·œs
},

467 {"pÿÎ", 
luaB_pÿÎ
},

468 {"´št", 
luaB_´št
},

469 {"¿wequ®", 
luaB_¿wequ®
},

470 {"¿wËn", 
luaB_¿wËn
},

471 {"¿wg‘", 
luaB_¿wg‘
},

472 {"¿w£t", 
luaB_¿w£t
},

473 {"£Ëù", 
luaB_£Ëù
},

474 {"£tm‘©abË", 
luaB_£tm‘©abË
},

475 {"tÚumb”", 
luaB_tÚumb”
},

476 {"to¡ršg", 
luaB_to¡ršg
},

477 {"ty³", 
luaB_ty³
},

478 {"xpÿÎ", 
luaB_xpÿÎ
},

480 {"_G", 
NULL
},

481 {"_VERSION", 
NULL
},

482 {
NULL
, NULL}

486 
LUAMOD_API
 
	$luaİ’_ba£
 (
lua_S‹
 *
L
) {

488 
	`lua_pushglob®bË
(
L
);

489 
	`luaL_£tfuncs
(
L
, 
ba£_funcs
, 0);

491 
	`lua_pushv®ue
(
L
, -1);

492 
	`lua_£tf›ld
(
L
, -2, "_G");

494 
	`lua_pushl™”®
(
L
, 
LUA_VERSION
);

495 
	`lua_£tf›ld
(
L
, -2, "_VERSION");

497 
	}
}

	@3rd/lua/lbitlib.c

7 
	#lb™lib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~"lua.h
"

15 
	~"Ïuxlib.h
"

16 
	~"lu®ib.h
"

19 #ià
defšed
(
LUA_COMPAT_BITLIB
)

22 
	#pushunsigÃd
(
L
,
n
è
	`lua_pushš‹g”
(L, (
lua_IÁeg”
)Ò))

	)

23 
	#checkunsigÃd
(
L
,
i
è((
lua_UnsigÃd
)
	`luaL_checkš‹g”
(L,i))

	)

27 #ià!
defšed
(
LUA_NBITS
)

28 
	#LUA_NBITS
 32

	)

37 
	#ALLONES
 (~(((~(
lua_UnsigÃd
)0è<< (
LUA_NBITS
 - 1)è<< 1))

	)

41 
	#Œim
(
x
è((xè& 
ALLONES
)

	)

45 
	#mask
(
n
è(~((
ALLONES
 << 1è<< (Òè- 1)))

	)

49 
lua_UnsigÃd
 
	$ªdaux
 (
lua_S‹
 *
L
) {

50 
i
, 
n
 = 
	`lua_g‘tİ
(
L
);

51 
lua_UnsigÃd
 
r
 = ~(lua_Unsigned)0;

52 
i
 = 1; i <ğ
n
; i++)

53 
r
 &ğ
	`checkunsigÃd
(
L
, 
i
);

54  
	`Œim
(
r
);

55 
	}
}

58 
	$b_ªd
 (
lua_S‹
 *
L
) {

59 
lua_UnsigÃd
 
r
 = 
	`ªdaux
(
L
);

60 
	`pushunsigÃd
(
L
, 
r
);

62 
	}
}

65 
	$b_‹¡
 (
lua_S‹
 *
L
) {

66 
lua_UnsigÃd
 
r
 = 
	`ªdaux
(
L
);

67 
	`lua_pushboŞ—n
(
L
, 
r
 != 0);

69 
	}
}

72 
	$b_Ü
 (
lua_S‹
 *
L
) {

73 
i
, 
n
 = 
	`lua_g‘tİ
(
L
);

74 
lua_UnsigÃd
 
r
 = 0;

75 
i
 = 1; i <ğ
n
; i++)

76 
r
 |ğ
	`checkunsigÃd
(
L
, 
i
);

77 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

79 
	}
}

82 
	$b_xÜ
 (
lua_S‹
 *
L
) {

83 
i
, 
n
 = 
	`lua_g‘tİ
(
L
);

84 
lua_UnsigÃd
 
r
 = 0;

85 
i
 = 1; i <ğ
n
; i++)

86 
r
 ^ğ
	`checkunsigÃd
(
L
, 
i
);

87 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

89 
	}
}

92 
	$b_nÙ
 (
lua_S‹
 *
L
) {

93 
lua_UnsigÃd
 
r
 = ~
	`checkunsigÃd
(
L
, 1);

94 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

96 
	}
}

99 
	$b_shiá
 (
lua_S‹
 *
L
, 
lua_UnsigÃd
 
r
, 
lua_IÁeg”
 
i
) {

100 ià(
i
 < 0) {

101 
i
 = -i;

102 
r
 = 
	`Œim
(r);

103 ià(
i
 >ğ
LUA_NBITS
è
r
 = 0;

104 
r
 >>ğ
i
;

107 ià(
i
 >ğ
LUA_NBITS
è
r
 = 0;

108 
r
 <<ğ
i
;

109 
r
 = 
	`Œim
(r);

111 
	`pushunsigÃd
(
L
, 
r
);

113 
	}
}

116 
	$b_lshiá
 (
lua_S‹
 *
L
) {

117  
	`b_shiá
(
L
, 
	`checkunsigÃd
(L, 1), 
	`luaL_checkš‹g”
(L, 2));

118 
	}
}

121 
	$b_rshiá
 (
lua_S‹
 *
L
) {

122  
	`b_shiá
(
L
, 
	`checkunsigÃd
(L, 1), -
	`luaL_checkš‹g”
(L, 2));

123 
	}
}

126 
	$b_¬shiá
 (
lua_S‹
 *
L
) {

127 
lua_UnsigÃd
 
r
 = 
	`checkunsigÃd
(
L
, 1);

128 
lua_IÁeg”
 
i
 = 
	`luaL_checkš‹g”
(
L
, 2);

129 ià(
i
 < 0 || !(
r
 & ((
lua_UnsigÃd
)1 << (
LUA_NBITS
 - 1))))

130  
	`b_shiá
(
L
, 
r
, -
i
);

132 ià(
i
 >ğ
LUA_NBITS
è
r
 = 
ALLONES
;

134 
r
 = 
	`Œim
(Ô >> 
i
è| ~Ñrim(~(
lua_UnsigÃd
)0) >> i));

135 
	`pushunsigÃd
(
L
, 
r
);

138 
	}
}

141 
	$b_rÙ
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
d
) {

142 
lua_UnsigÃd
 
r
 = 
	`checkunsigÃd
(
L
, 1);

143 
i
 = 
d
 & (
LUA_NBITS
 - 1);

144 
r
 = 
	`Œim
(r);

145 ià(
i
 != 0)

146 
r
 = (¸<< 
i
è| (¸>> (
LUA_NBITS
 - i));

147 
	`pushunsigÃd
(
L
, 
	`Œim
(
r
));

149 
	}
}

152 
	$b_ÌÙ
 (
lua_S‹
 *
L
) {

153  
	`b_rÙ
(
L
, 
	`luaL_checkš‹g”
(L, 2));

154 
	}
}

157 
	$b_¼Ù
 (
lua_S‹
 *
L
) {

158  
	`b_rÙ
(
L
, -
	`luaL_checkš‹g”
(L, 2));

159 
	}
}

168 
	$f›ld¬gs
 (
lua_S‹
 *
L
, 
çrg
, *
width
) {

169 
lua_IÁeg”
 
f
 = 
	`luaL_checkš‹g”
(
L
, 
çrg
);

170 
lua_IÁeg”
 
w
 = 
	`luaL_İtš‹g”
(
L
, 
çrg
 + 1, 1);

171 
	`luaL_¬gcheck
(
L
, 0 <ğ
f
, 
çrg
, "field cannot be‚egative");

172 
	`luaL_¬gcheck
(
L
, 0 < 
w
, 
çrg
 + 1, "width must be…ositive");

173 ià(
f
 + 
w
 > 
LUA_NBITS
)

174 
	`luaL_”rÜ
(
L
, "tryingo‡ccess‚on-existent bits");

175 *
width
 = ()
w
;

176  ()
f
;

177 
	}
}

180 
	$b_exŒaù
 (
lua_S‹
 *
L
) {

181 
w
;

182 
lua_UnsigÃd
 
r
 = 
	`Œim
(
	`checkunsigÃd
(
L
, 1));

183 
f
 = 
	`f›ld¬gs
(
L
, 2, &
w
);

184 
r
 = (¸>> 
f
è& 
	`mask
(
w
);

185 
	`pushunsigÃd
(
L
, 
r
);

187 
	}
}

190 
	$b_»¶aû
 (
lua_S‹
 *
L
) {

191 
w
;

192 
lua_UnsigÃd
 
r
 = 
	`Œim
(
	`checkunsigÃd
(
L
, 1));

193 
lua_UnsigÃd
 
v
 = 
	`Œim
(
	`checkunsigÃd
(
L
, 2));

194 
f
 = 
	`f›ld¬gs
(
L
, 3, &
w
);

195 
lua_UnsigÃd
 
m
 = 
	`mask
(
w
);

196 
r
 = (¸& ~(
m
 << 
f
)è| ((
v
 & m) << f);

197 
	`pushunsigÃd
(
L
, 
r
);

199 
	}
}

202 cÚ¡ 
luaL_Reg
 
	gb™lib
[] = {

203 {"¬shiá", 
b_¬shiá
},

204 {"bªd", 
b_ªd
},

205 {"bnÙ", 
b_nÙ
},

206 {"bÜ", 
b_Ü
},

207 {"bxÜ", 
b_xÜ
},

208 {"b‹¡", 
b_‹¡
},

209 {"exŒaù", 
b_exŒaù
},

210 {"ÌÙ©e", 
b_ÌÙ
},

211 {"lshiá", 
b_lshiá
},

212 {"»¶aû", 
b_»¶aû
},

213 {"¼Ù©e", 
b_¼Ù
},

214 {"rshiá", 
b_rshiá
},

215 {
NULL
, NULL}

220 
LUAMOD_API
 
	$luaİ’_b™32
 (
lua_S‹
 *
L
) {

221 
	`luaL_Ãwlib
(
L
, 
b™lib
);

223 
	}
}

229 
LUAMOD_API
 
	$luaİ’_b™32
 (
lua_S‹
 *
L
) {

230  
	`luaL_”rÜ
(
L
, "library 'bit32' has been deprecated");

231 
	}
}

	@3rd/lua/lcode.c

7 
	#lcode_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<m©h.h
>

14 
	~<¡dlib.h
>

16 
	~"lua.h
"

18 
	~"lcode.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lgc.h
"

22 
	~"Îex.h
"

23 
	~"lmem.h
"

24 
	~"lobjeù.h
"

25 
	~"lİcodes.h
"

26 
	~"Í¬£r.h
"

27 
	~"l¡ršg.h
"

28 
	~"ÉabË.h
"

29 
	~"lvm.h
"

33 
	#MAXREGS
 255

	)

36 
	#hasjumps
(
e
è(Ó)->
t
 !ğÓ)->
f
)

	)

43 
	$tÚum”®
(cÚ¡ 
expdesc
 *
e
, 
TV®ue
 *
v
) {

44 ià(
	`hasjumps
(
e
))

46 
e
->
k
) {

47 
VKINT
:

48 ià(
v
è
	`£tiv®ue
(v, 
e
->
u
.
iv®
);

50 
VKFLT
:

51 ià(
v
è
	`£tætv®ue
(v, 
e
->
u
.
nv®
);

55 
	}
}

64 
	$luaK_n
 (
FuncS‹
 *
fs
, 
äom
, 
n
) {

65 
In¡ruùiÚ
 *
´evious
;

66 
l
 = 
äom
 + 
n
 - 1;

67 ià(
fs
->
pc
 > fs->
Ï¡rg‘
) {

68 
´evious
 = &
fs
->
f
->
¥
->
code
[fs->
pc
-1];

69 ià(
	`GET_OPCODE
(*
´evious
è=ğ
OP_LOADNIL
) {

70 
päom
 = 
	`GETARG_A
(*
´evious
);

71 
¶
 = 
päom
 + 
	`GETARG_B
(*
´evious
);

72 ià((
päom
 <ğ
äom
 && from <ğ
¶
 + 1) ||

73 (
äom
 <ğ
päom
 &&…äom <ğ
l
 + 1)) {

74 ià(
päom
 < 
äom
) from =…from;

75 ià(
¶
 > 
l
)† =…l;

76 
	`SETARG_A
(*
´evious
, 
äom
);

77 
	`SETARG_B
(*
´evious
, 
l
 - 
äom
);

82 
	`luaK_codeABC
(
fs
, 
OP_LOADNIL
, 
äom
, 
n
 - 1, 0);

83 
	}
}

90 
	$g‘jump
 (
FuncS‹
 *
fs
, 
pc
) {

91 
off£t
 = 
	`GETARG_sBx
(
fs
->
f
->
¥
->
code
[
pc
]);

92 ià(
off£t
 =ğ
NO_JUMP
)

93  
NO_JUMP
;

95  (
pc
+1)+
off£t
;

96 
	}
}

103 
	$fixjump
 (
FuncS‹
 *
fs
, 
pc
, 
de¡
) {

104 
In¡ruùiÚ
 *
jmp
 = &
fs
->
f
->
¥
->
code
[
pc
];

105 
off£t
 = 
de¡
 - (
pc
 + 1);

106 
	`lua_as£¹
(
de¡
 !ğ
NO_JUMP
);

107 ià(
	`abs
(
off£t
è> 
MAXARG_sBx
)

108 
	`luaX_syÁax”rÜ
(
fs
->
ls
, "control structureoo†ong");

109 
	`SETARG_sBx
(*
jmp
, 
off£t
);

110 
	}
}

116 
	$luaK_cÚÿt
 (
FuncS‹
 *
fs
, *
l1
, 
l2
) {

117 ià(
l2
 =ğ
NO_JUMP
) ;

118 ià(*
l1
 =ğ
NO_JUMP
)

119 *
l1
 = 
l2
;

121 
li¡
 = *
l1
;

122 
Ãxt
;

123 (
Ãxt
 = 
	`g‘jump
(
fs
, 
li¡
)è!ğ
NO_JUMP
)

124 
li¡
 = 
Ãxt
;

125 
	`fixjump
(
fs
, 
li¡
, 
l2
);

127 
	}
}

136 
	$luaK_jump
 (
FuncS‹
 *
fs
) {

137 
jpc
 = 
fs
->jpc;

138 
j
;

139 
fs
->
jpc
 = 
NO_JUMP
;

140 
j
 = 
	`luaK_codeAsBx
(
fs
, 
OP_JMP
, 0, 
NO_JUMP
);

141 
	`luaK_cÚÿt
(
fs
, &
j
, 
jpc
);

142  
j
;

143 
	}
}

149 
	$luaK_»t
 (
FuncS‹
 *
fs
, 
fœ¡
, 
Ä‘
) {

150 
	`luaK_codeABC
(
fs
, 
OP_RETURN
, 
fœ¡
, 
Ä‘
+1, 0);

151 
	}
}

158 
	$cÚdjump
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
A
, 
B
, 
C
) {

159 
	`luaK_codeABC
(
fs
, 
İ
, 
A
, 
B
, 
C
);

160  
	`luaK_jump
(
fs
);

161 
	}
}

168 
	$luaK_g‘Ïb–
 (
FuncS‹
 *
fs
) {

169 
fs
->
Ï¡rg‘
 = fs->
pc
;

170  
fs
->
pc
;

171 
	}
}

179 
In¡ruùiÚ
 *
	$g‘jumpcÚŒŞ
 (
FuncS‹
 *
fs
, 
pc
) {

180 
In¡ruùiÚ
 *
pi
 = &
fs
->
f
->
¥
->
code
[
pc
];

181 ià(
pc
 >ğ1 && 
	`‹¡TMode
(
	`GET_OPCODE
(*(
pi
-1))))

182  
pi
-1;

184  
pi
;

185 
	}
}

195 
	$·tch‹¡»g
 (
FuncS‹
 *
fs
, 
node
, 
»g
) {

196 
In¡ruùiÚ
 *
i
 = 
	`g‘jumpcÚŒŞ
(
fs
, 
node
);

197 ià(
	`GET_OPCODE
(*
i
è!ğ
OP_TESTSET
)

199 ià(
»g
 !ğ
NO_REG
 &&„eg !ğ
	`GETARG_B
(*
i
))

200 
	`SETARG_A
(*
i
, 
»g
);

204 *
i
 = 
	`CREATE_ABC
(
OP_TEST
, 
	`GETARG_B
(*i), 0, 
	`GETARG_C
(*i));

207 
	}
}

213 
	$»movev®ues
 (
FuncS‹
 *
fs
, 
li¡
) {

214 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist))

215 
	`·tch‹¡»g
(
fs
, 
li¡
, 
NO_REG
);

216 
	}
}

224 
	$·tchli¡aux
 (
FuncS‹
 *
fs
, 
li¡
, 
vrg‘
, 
»g
,

225 
drg‘
) {

226 
li¡
 !ğ
NO_JUMP
) {

227 
Ãxt
 = 
	`g‘jump
(
fs
, 
li¡
);

228 ià(
	`·tch‹¡»g
(
fs
, 
li¡
, 
»g
))

229 
	`fixjump
(
fs
, 
li¡
, 
vrg‘
);

231 
	`fixjump
(
fs
, 
li¡
, 
drg‘
);

232 
li¡
 = 
Ãxt
;

234 
	}
}

242 
	$disch¬gejpc
 (
FuncS‹
 *
fs
) {

243 
	`·tchli¡aux
(
fs
, fs->
jpc
, fs->
pc
, 
NO_REG
, fs->pc);

244 
fs
->
jpc
 = 
NO_JUMP
;

245 
	}
}

252 
	$luaK_·tchtoh”e
 (
FuncS‹
 *
fs
, 
li¡
) {

253 
	`luaK_g‘Ïb–
(
fs
);

254 
	`luaK_cÚÿt
(
fs
, &fs->
jpc
, 
li¡
);

255 
	}
}

263 
	$luaK_·tchli¡
 (
FuncS‹
 *
fs
, 
li¡
, 
rg‘
) {

264 ià(
rg‘
 =ğ
fs
->
pc
)

265 
	`luaK_·tchtoh”e
(
fs
, 
li¡
);

267 
	`lua_as£¹
(
rg‘
 < 
fs
->
pc
);

268 
	`·tchli¡aux
(
fs
, 
li¡
, 
rg‘
, 
NO_REG
,arget);

270 
	}
}

278 
	$luaK_·tchşo£
 (
FuncS‹
 *
fs
, 
li¡
, 
Ëv–
) {

279 
Ëv–
++;

280 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist)) {

281 
	`lua_as£¹
(
	`GET_OPCODE
(
fs
->
f
->
¥
->
code
[
li¡
]è=ğ
OP_JMP
 &&

282 (
	`GETARG_A
(
fs
->
f
->
¥
->
code
[
li¡
]) == 0 ||

283 
	`GETARG_A
(
fs
->
f
->
¥
->
code
[
li¡
]è>ğ
Ëv–
));

284 
	`SETARG_A
(
fs
->
f
->
¥
->
code
[
li¡
], 
Ëv–
);

286 
	}
}

293 
	$luaK_code
 (
FuncS‹
 *
fs
, 
In¡ruùiÚ
 
i
) {

294 
PrÙo
 *
f
 = 
fs
->f;

295 
	`disch¬gejpc
(
fs
);

297 
	`luaM_growveùÜ
(
fs
->
ls
->
L
, 
f
->
¥
->
code
, fs->
pc
, f->¥->
sizecode
, 
In¡ruùiÚ
,

298 
MAX_INT
, "opcodes");

299 
f
->
¥
->
code
[
fs
->
pc
] = 
i
;

301 
	`luaM_growveùÜ
(
fs
->
ls
->
L
, 
f
->
¥
->
lšešfo
, fs->
pc
, f->¥->
siz–šešfo
, ,

302 
MAX_INT
, "opcodes");

303 
f
->
¥
->
lšešfo
[
fs
->
pc
] = fs->
ls
->
Ï¡lše
;

304  
fs
->
pc
++;

305 
	}
}

312 
	$luaK_codeABC
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
a
, 
b
, 
c
) {

313 
	`lua_as£¹
(
	`g‘OpMode
(
o
è=ğ
iABC
);

314 
	`lua_as£¹
(
	`g‘BMode
(
o
è!ğ
OpArgN
 || 
b
 == 0);

315 
	`lua_as£¹
(
	`g‘CMode
(
o
è!ğ
OpArgN
 || 
c
 == 0);

316 
	`lua_as£¹
(
a
 <ğ
MAXARG_A
 && 
b
 <ğ
MAXARG_B
 && 
c
 <ğ
MAXARG_C
);

317  
	`luaK_code
(
fs
, 
	`CREATE_ABC
(
o
, 
a
, 
b
, 
c
));

318 
	}
}

324 
	$luaK_codeABx
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
a
, 
bc
) {

325 
	`lua_as£¹
(
	`g‘OpMode
(
o
è=ğ
iABx
 || g‘OpMode(oè=ğ
iAsBx
);

326 
	`lua_as£¹
(
	`g‘CMode
(
o
è=ğ
OpArgN
);

327 
	`lua_as£¹
(
a
 <ğ
MAXARG_A
 && 
bc
 <ğ
MAXARG_Bx
);

328  
	`luaK_code
(
fs
, 
	`CREATE_ABx
(
o
, 
a
, 
bc
));

329 
	}
}

335 
	$cod“xŒ¯rg
 (
FuncS‹
 *
fs
, 
a
) {

336 
	`lua_as£¹
(
a
 <ğ
MAXARG_Ax
);

337  
	`luaK_code
(
fs
, 
	`CREATE_Ax
(
OP_EXTRAARG
, 
a
));

338 
	}
}

346 
	$luaK_codek
 (
FuncS‹
 *
fs
, 
»g
, 
k
) {

347 ià(
k
 <ğ
MAXARG_Bx
)

348  
	`luaK_codeABx
(
fs
, 
OP_LOADK
, 
»g
, 
k
);

350 
p
 = 
	`luaK_codeABx
(
fs
, 
OP_LOADKX
, 
»g
, 0);

351 
	`cod“xŒ¯rg
(
fs
, 
k
);

352  
p
;

354 
	}
}

361 
	$luaK_check¡ack
 (
FuncS‹
 *
fs
, 
n
) {

362 
Ãw¡ack
 = 
fs
->
ä“»g
 + 
n
;

363 ià(
Ãw¡ack
 > 
fs
->
f
->
¥
->
max¡acksize
) {

364 ià(
Ãw¡ack
 >ğ
MAXREGS
)

365 
	`luaX_syÁax”rÜ
(
fs
->
ls
,

367 
fs
->
f
->
¥
->
max¡acksize
 = 
	`ÿ¡_by‹
(
Ãw¡ack
);

369 
	}
}

375 
	$luaK_»£rv”egs
 (
FuncS‹
 *
fs
, 
n
) {

376 
	`luaK_check¡ack
(
fs
, 
n
);

377 
fs
->
ä“»g
 +ğ
n
;

378 
	}
}

386 
	$ä“»g
 (
FuncS‹
 *
fs
, 
»g
) {

387 ià(!
	`ISK
(
»g
è&&„eg >ğ
fs
->
Çùv¬
) {

388 
fs
->
ä“»g
--;

389 
	`lua_as£¹
(
»g
 =ğ
fs
->
ä“»g
);

391 
	}
}

397 
	$ä“exp
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

398 ià(
e
->
k
 =ğ
VNONRELOC
)

399 
	`ä“»g
(
fs
, 
e
->
u
.
šfo
);

400 
	}
}

407 
	$ä“exps
 (
FuncS‹
 *
fs
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

408 
r1
 = (
e1
->
k
 =ğ
VNONRELOC
è?ƒ1->
u
.
šfo
 : -1;

409 
r2
 = (
e2
->
k
 =ğ
VNONRELOC
è?ƒ2->
u
.
šfo
 : -1;

410 ià(
r1
 > 
r2
) {

411 
	`ä“»g
(
fs
, 
r1
);

412 
	`ä“»g
(
fs
, 
r2
);

415 
	`ä“»g
(
fs
, 
r2
);

416 
	`ä“»g
(
fs
, 
r1
);

418 
	}
}

428 
	$addk
 (
FuncS‹
 *
fs
, 
TV®ue
 *
key
, TV®u*
v
) {

429 
lua_S‹
 *
L
 = 
fs
->
ls
->L;

430 
PrÙo
 *
f
 = 
fs
->f;

431 
TV®ue
 *
idx
 = 
	`luaH_£t
(
L
, 
fs
->
ls
->
h
, 
key
);

432 
k
, 
Şdsize
;

433 ià(
	`‰isš‹g”
(
idx
)) {

434 
k
 = 
	`ÿ¡_št
(
	`iv®ue
(
idx
));

436 ià(
k
 < 
fs
->
nk
 && 
	`‰y³
(&
f
->k[k]è=ğ‰y³(
v
) &&

437 
	`luaV_¿wequ®obj
(&
f
->
k
[k], 
v
))

438  
k
;

441 
Şdsize
 = 
f
->
¥
->
sizek
;

442 
k
 = 
fs
->
nk
;

445 
	`£tiv®ue
(
idx
, 
k
);

446 
	`luaM_growveùÜ
(
L
, 
f
->
k
, k, f->
¥
->
sizek
, 
TV®ue
, 
MAXARG_Ax
, "constants");

447 
Şdsize
 < 
f
->
¥
->
sizek
è
	`£Šv®ue
(&f->
k
[oldsize++]);

448 
	`£tobj
(
L
, &
f
->
k
[k], 
v
);

449 
fs
->
nk
++;

450 
	`luaC_b¬r›r
(
L
, 
f
, 
v
);

451  
k
;

452 
	}
}

458 
	$luaK_¡ršgK
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
s
) {

459 
TV®ue
 
o
;

460 
	`£tsv®ue
(
fs
->
ls
->
L
, &
o
, 
s
);

461  
	`addk
(
fs
, &
o
, &o);

462 
	}
}

471 
	$luaK_štK
 (
FuncS‹
 *
fs
, 
lua_IÁeg”
 
n
) {

472 
TV®ue
 
k
, 
o
;

473 
	`£v®ue
(&
k
, 
	`ÿ¡
(*, ca¡(
size_t
, 
n
)));

474 
	`£tiv®ue
(&
o
, 
n
);

475  
	`addk
(
fs
, &
k
, &
o
);

476 
	}
}

481 
	$luaK_numb”K
 (
FuncS‹
 *
fs
, 
lua_Numb”
 
r
) {

482 
TV®ue
 
o
;

483 
	`£tætv®ue
(&
o
, 
r
);

484  
	`addk
(
fs
, &
o
, &o);

485 
	}
}

491 
	$boŞK
 (
FuncS‹
 *
fs
, 
b
) {

492 
TV®ue
 
o
;

493 
	`£tbv®ue
(&
o
, 
b
);

494  
	`addk
(
fs
, &
o
, &o);

495 
	}
}

501 
	$nK
 (
FuncS‹
 *
fs
) {

502 
TV®ue
 
k
, 
v
;

503 
	`£Šv®ue
(&
v
);

505 
	`£thv®ue
(
fs
->
ls
->
L
, &
k
, fs->ls->
h
);

506  
	`addk
(
fs
, &
k
, &
v
);

507 
	}
}

515 
	$luaK_£Œ‘uºs
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
ÄesuÉs
) {

516 ià(
e
->
k
 =ğ
VCALL
) {

517 
	`SETARG_C
(
	`g‘š¡ruùiÚ
(
fs
, 
e
), 
ÄesuÉs
 + 1);

519 ià(
e
->
k
 =ğ
VVARARG
) {

520 
In¡ruùiÚ
 *
pc
 = &
	`g‘š¡ruùiÚ
(
fs
, 
e
);

521 
	`SETARG_B
(*
pc
, 
ÄesuÉs
 + 1);

522 
	`SETARG_A
(*
pc
, 
fs
->
ä“»g
);

523 
	`luaK_»£rv”egs
(
fs
, 1);

525 
	`lua_as£¹
(
ÄesuÉs
 =ğ
LUA_MULTRET
);

526 
	}
}

539 
	$luaK_£tÚ”‘
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

540 ià(
e
->
k
 =ğ
VCALL
) {

542 
	`lua_as£¹
(
	`GETARG_C
(
	`g‘š¡ruùiÚ
(
fs
, 
e
)) == 2);

543 
e
->
k
 = 
VNONRELOC
;

544 
e
->
u
.
šfo
 = 
	`GETARG_A
(
	`g‘š¡ruùiÚ
(
fs
,ƒ));

546 ià(
e
->
k
 =ğ
VVARARG
) {

547 
	`SETARG_B
(
	`g‘š¡ruùiÚ
(
fs
, 
e
), 2);

548 
e
->
k
 = 
VRELOCABLE
;

550 
	}
}

556 
	$luaK_disch¬gev¬s
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

557 
e
->
k
) {

558 
VLOCAL
: {

559 
e
->
k
 = 
VNONRELOC
;

562 
VUPVAL
: {

563 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_GETUPVAL
, 0,ƒ->u.info, 0);

564 
e
->
k
 = 
VRELOCABLE
;

567 
VINDEXED
: {

568 
OpCode
 
İ
;

569 
	`ä“»g
(
fs
, 
e
->
u
.
šd
.
idx
);

570 ià(
e
->
u
.
šd
.
vt
 =ğ
VLOCAL
) {

571 
	`ä“»g
(
fs
, 
e
->
u
.
šd
.
t
);

572 
İ
 = 
OP_GETTABLE
;

575 
	`lua_as£¹
(
e
->
u
.
šd
.
vt
 =ğ
VUPVAL
);

576 
İ
 = 
OP_GETTABUP
;

578 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0,ƒ->u.
šd
.
t
,ƒ->u.šd.
idx
);

579 
e
->
k
 = 
VRELOCABLE
;

582 
VVARARG
: 
VCALL
: {

583 
	`luaK_£tÚ”‘
(
fs
, 
e
);

588 
	}
}

595 
	$disch¬ge2»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
»g
) {

596 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

597 
e
->
k
) {

598 
VNIL
: {

599 
	`luaK_n
(
fs
, 
»g
, 1);

602 
VFALSE
: 
VTRUE
: {

603 
	`luaK_codeABC
(
fs
, 
OP_LOADBOOL
, 
»g
, 
e
->
k
 =ğ
VTRUE
, 0);

606 
VK
: {

607 
	`luaK_codek
(
fs
, 
»g
, 
e
->
u
.
šfo
);

610 
VKFLT
: {

611 
	`luaK_codek
(
fs
, 
»g
, 
	`luaK_numb”K
(fs, 
e
->
u
.
nv®
));

614 
VKINT
: {

615 
	`luaK_codek
(
fs
, 
»g
, 
	`luaK_štK
(fs, 
e
->
u
.
iv®
));

618 
VRELOCABLE
: {

619 
In¡ruùiÚ
 *
pc
 = &
	`g‘š¡ruùiÚ
(
fs
, 
e
);

620 
	`SETARG_A
(*
pc
, 
»g
);

623 
VNONRELOC
: {

624 ià(
»g
 !ğ
e
->
u
.
šfo
)

625 
	`luaK_codeABC
(
fs
, 
OP_MOVE
, 
»g
, 
e
->
u
.
šfo
, 0);

629 
	`lua_as£¹
(
e
->
k
 =ğ
VJMP
);

633 
e
->
u
.
šfo
 = 
»g
;

634 
e
->
k
 = 
VNONRELOC
;

635 
	}
}

641 
	$disch¬ge2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

642 ià(
e
->
k
 !ğ
VNONRELOC
) {

643 
	`luaK_»£rv”egs
(
fs
, 1);

644 
	`disch¬ge2»g
(
fs
, 
e
, fs->
ä“»g
-1);

646 
	}
}

649 
	$code_lßdboŞ
 (
FuncS‹
 *
fs
, 
A
, 
b
, 
jump
) {

650 
	`luaK_g‘Ïb–
(
fs
);

651  
	`luaK_codeABC
(
fs
, 
OP_LOADBOOL
, 
A
, 
b
, 
jump
);

652 
	}
}

659 
	$Ãed_v®ue
 (
FuncS‹
 *
fs
, 
li¡
) {

660 ; 
li¡
 !ğ
NO_JUMP
;†i¡ = 
	`g‘jump
(
fs
,†ist)) {

661 
In¡ruùiÚ
 
i
 = *
	`g‘jumpcÚŒŞ
(
fs
, 
li¡
);

662 ià(
	`GET_OPCODE
(
i
è!ğ
OP_TESTSET
)  1;

665 
	}
}

675 
	$exp2»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
»g
) {

676 
	`disch¬ge2»g
(
fs
, 
e
, 
»g
);

677 ià(
e
->
k
 =ğ
VJMP
)

678 
	`luaK_cÚÿt
(
fs
, &
e
->
t
,ƒ->
u
.
šfo
);

679 ià(
	`hasjumps
(
e
)) {

680 
fš®
;

681 
p_f
 = 
NO_JUMP
;

682 
p_t
 = 
NO_JUMP
;

683 ià(
	`Ãed_v®ue
(
fs
, 
e
->
t
è||‚“d_v®ue(fs,ƒ->
f
)) {

684 
fj
 = (
e
->
k
 =ğ
VJMP
è? 
NO_JUMP
 : 
	`luaK_jump
(
fs
);

685 
p_f
 = 
	`code_lßdboŞ
(
fs
, 
»g
, 0, 1);

686 
p_t
 = 
	`code_lßdboŞ
(
fs
, 
»g
, 1, 0);

687 
	`luaK_·tchtoh”e
(
fs
, 
fj
);

689 
fš®
 = 
	`luaK_g‘Ïb–
(
fs
);

690 
	`·tchli¡aux
(
fs
, 
e
->
f
, 
fš®
, 
»g
, 
p_f
);

691 
	`·tchli¡aux
(
fs
, 
e
->
t
, 
fš®
, 
»g
, 
p_t
);

693 
e
->
f
 =ƒ->
t
 = 
NO_JUMP
;

694 
e
->
u
.
šfo
 = 
»g
;

695 
e
->
k
 = 
VNONRELOC
;

696 
	}
}

703 
	$luaK_exp2ÃxŒeg
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

704 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

705 
	`ä“exp
(
fs
, 
e
);

706 
	`luaK_»£rv”egs
(
fs
, 1);

707 
	`exp2»g
(
fs
, 
e
, fs->
ä“»g
 - 1);

708 
	}
}

715 
	$luaK_exp2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

716 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

717 ià(
e
->
k
 =ğ
VNONRELOC
) {

718 ià(!
	`hasjumps
(
e
))

719  
e
->
u
.
šfo
;

720 ià(
e
->
u
.
šfo
 >ğ
fs
->
Çùv¬
) {

721 
	`exp2»g
(
fs
, 
e
,ƒ->
u
.
šfo
);

722  
e
->
u
.
šfo
;

725 
	`luaK_exp2ÃxŒeg
(
fs
, 
e
);

726  
e
->
u
.
šfo
;

727 
	}
}

734 
	$luaK_exp2ªy»gup
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

735 ià(
e
->
k
 !ğ
VUPVAL
 || 
	`hasjumps
(e))

736 
	`luaK_exp2ªy»g
(
fs
, 
e
);

737 
	}
}

744 
	$luaK_exp2v®
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

745 ià(
	`hasjumps
(
e
))

746 
	`luaK_exp2ªy»g
(
fs
, 
e
);

748 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

749 
	}
}

758 
	$luaK_exp2RK
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

759 
	`luaK_exp2v®
(
fs
, 
e
);

760 
e
->
k
) {

761 
VTRUE
: 
e
->
u
.
šfo
 = 
	`boŞK
(
fs
, 1); 
vk
;

762 
VFALSE
: 
e
->
u
.
šfo
 = 
	`boŞK
(
fs
, 0); 
vk
;

763 
VNIL
: 
e
->
u
.
šfo
 = 
	`nK
(
fs
); 
vk
;

764 
VKINT
: 
e
->
u
.
šfo
 = 
	`luaK_štK
(
fs
,ƒ->u.
iv®
); 
vk
;

765 
VKFLT
: 
e
->
u
.
šfo
 = 
	`luaK_numb”K
(
fs
,ƒ->u.
nv®
); 
vk
;

766 
VK
:

767 
vk
:

768 
e
->
k
 = 
VK
;

769 ià(
e
->
u
.
šfo
 <ğ
MAXINDEXRK
)

770  
	`RKASK
(
e
->
u
.
šfo
);

775  
	`luaK_exp2ªy»g
(
fs
, 
e
);

776 
	}
}

782 
	$luaK_¡Üev¬
 (
FuncS‹
 *
fs
, 
expdesc
 *
v¬
,ƒxpdesø*
ex
) {

783 
v¬
->
k
) {

784 
VLOCAL
: {

785 
	`ä“exp
(
fs
, 
ex
);

786 
	`exp2»g
(
fs
, 
ex
, 
v¬
->
u
.
šfo
);

789 
VUPVAL
: {

790 
e
 = 
	`luaK_exp2ªy»g
(
fs
, 
ex
);

791 
	`luaK_codeABC
(
fs
, 
OP_SETUPVAL
, 
e
, 
v¬
->
u
.
šfo
, 0);

794 
VINDEXED
: {

795 
OpCode
 
İ
 = (
v¬
->
u
.
šd
.
vt
 =ğ
VLOCAL
è? 
OP_SETTABLE
 : 
OP_SETTABUP
;

796 
e
 = 
	`luaK_exp2RK
(
fs
, 
ex
);

797 
	`luaK_codeABC
(
fs
, 
İ
, 
v¬
->
u
.
šd
.
t
, v¬->u.šd.
idx
, 
e
);

800 : 
	`lua_as£¹
(0);

802 
	`ä“exp
(
fs
, 
ex
);

803 
	}
}

809 
	$luaK_£lf
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
,ƒxpdesø*
key
) {

810 
”eg
;

811 
	`luaK_exp2ªy»g
(
fs
, 
e
);

812 
”eg
 = 
e
->
u
.
šfo
;

813 
	`ä“exp
(
fs
, 
e
);

814 
e
->
u
.
šfo
 = 
fs
->
ä“»g
;

815 
e
->
k
 = 
VNONRELOC
;

816 
	`luaK_»£rv”egs
(
fs
, 2);

817 
	`luaK_codeABC
(
fs
, 
OP_SELF
, 
e
->
u
.
šfo
, 
”eg
, 
	`luaK_exp2RK
(fs, 
key
));

818 
	`ä“exp
(
fs
, 
key
);

819 
	}
}

825 
	$Ãg©ecÚd™iÚ
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

826 
In¡ruùiÚ
 *
pc
 = 
	`g‘jumpcÚŒŞ
(
fs
, 
e
->
u
.
šfo
);

827 
	`lua_as£¹
(
	`‹¡TMode
(
	`GET_OPCODE
(*
pc
)è&& GET_OPCODE(*pcè!ğ
OP_TESTSET
 &&

828 
	`GET_OPCODE
(*
pc
è!ğ
OP_TEST
);

829 
	`SETARG_A
(*
pc
, !(
	`GETARG_A
(*pc)));

830 
	}
}

839 
	$jumpÚcÚd
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
cÚd
) {

840 ià(
e
->
k
 =ğ
VRELOCABLE
) {

841 
In¡ruùiÚ
 
›
 = 
	`g‘š¡ruùiÚ
(
fs
, 
e
);

842 ià(
	`GET_OPCODE
(
›
è=ğ
OP_NOT
) {

843 
fs
->
pc
--;

844  
	`cÚdjump
(
fs
, 
OP_TEST
, 
	`GETARG_B
(
›
), 0, !
cÚd
);

848 
	`disch¬ge2ªy»g
(
fs
, 
e
);

849 
	`ä“exp
(
fs
, 
e
);

850  
	`cÚdjump
(
fs
, 
OP_TESTSET
, 
NO_REG
, 
e
->
u
.
šfo
, 
cÚd
);

851 
	}
}

857 
	$luaK_goiárue
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

858 
pc
;

859 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

860 
e
->
k
) {

861 
VJMP
: {

862 
	`Ãg©ecÚd™iÚ
(
fs
, 
e
);

863 
pc
 = 
e
->
u
.
šfo
;

866 
VK
: 
VKFLT
: 
VKINT
: 
VTRUE
: {

867 
pc
 = 
NO_JUMP
;

871 
pc
 = 
	`jumpÚcÚd
(
fs
, 
e
, 0);

875 
	`luaK_cÚÿt
(
fs
, &
e
->
f
, 
pc
);

876 
	`luaK_·tchtoh”e
(
fs
, 
e
->
t
);

877 
e
->
t
 = 
NO_JUMP
;

878 
	}
}

884 
	$luaK_goifçl£
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

885 
pc
;

886 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

887 
e
->
k
) {

888 
VJMP
: {

889 
pc
 = 
e
->
u
.
šfo
;

892 
VNIL
: 
VFALSE
: {

893 
pc
 = 
NO_JUMP
;

897 
pc
 = 
	`jumpÚcÚd
(
fs
, 
e
, 1);

901 
	`luaK_cÚÿt
(
fs
, &
e
->
t
, 
pc
);

902 
	`luaK_·tchtoh”e
(
fs
, 
e
->
f
);

903 
e
->
f
 = 
NO_JUMP
;

904 
	}
}

910 
	$cod’Ù
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
) {

911 
	`luaK_disch¬gev¬s
(
fs
, 
e
);

912 
e
->
k
) {

913 
VNIL
: 
VFALSE
: {

914 
e
->
k
 = 
VTRUE
;

917 
VK
: 
VKFLT
: 
VKINT
: 
VTRUE
: {

918 
e
->
k
 = 
VFALSE
;

921 
VJMP
: {

922 
	`Ãg©ecÚd™iÚ
(
fs
, 
e
);

925 
VRELOCABLE
:

926 
VNONRELOC
: {

927 
	`disch¬ge2ªy»g
(
fs
, 
e
);

928 
	`ä“exp
(
fs
, 
e
);

929 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
OP_NOT
, 0,ƒ->u.info, 0);

930 
e
->
k
 = 
VRELOCABLE
;

933 : 
	`lua_as£¹
(0);

936 { 
‹mp
 = 
e
->
f
;ƒ->àğe->
t
;ƒ->t =emp; }

937 
	`»movev®ues
(
fs
, 
e
->
f
);

938 
	`»movev®ues
(
fs
, 
e
->
t
);

939 
	}
}

946 
	$luaK_šdexed
 (
FuncS‹
 *
fs
, 
expdesc
 *
t
,ƒxpdesø*
k
) {

947 
	`lua_as£¹
(!
	`hasjumps
(
t
è&& (
	`vkisš»g
Ñ->
k
è||->k =ğ
VUPVAL
));

948 
t
->
u
.
šd
.ˆğt->u.
šfo
;

949 
t
->
u
.
šd
.
idx
 = 
	`luaK_exp2RK
(
fs
, 
k
);

950 
t
->
u
.
šd
.
vt
 = (t->
k
 =ğ
VUPVAL
è? VUPVAL : 
VLOCAL
;

951 
t
->
k
 = 
VINDEXED
;

952 
	}
}

960 
	$v®idİ
 (
İ
, 
TV®ue
 *
v1
, TV®u*
v2
) {

961 
İ
) {

962 
LUA_OPBAND
: 
LUA_OPBOR
: 
LUA_OPBXOR
:

963 
LUA_OPSHL
: 
LUA_OPSHR
: 
LUA_OPBNOT
: {

964 
lua_IÁeg”
 
i
;

965  (
	`toš‹g”
(
v1
, &
i
è&&oš‹g”(
v2
, &i));

967 
LUA_OPDIV
: 
LUA_OPIDIV
: 
LUA_OPMOD
:

968  (
	`nv®ue
(
v2
) != 0);

971 
	}
}

978 
	$cÚ¡fŞdšg
 (
FuncS‹
 *
fs
, 
İ
, 
expdesc
 *
e1
,

979 cÚ¡ 
expdesc
 *
e2
) {

980 
TV®ue
 
v1
, 
v2
, 
»s
;

981 ià(!
	`tÚum”®
(
e1
, &
v1
è|| !tÚum”®(
e2
, &
v2
è|| !
	`v®idİ
(
İ
, &v1, &v2))

983 
	`luaO_¬™h
(
fs
->
ls
->
L
, 
İ
, &
v1
, &
v2
, &
»s
);

984 ià(
	`‰isš‹g”
(&
»s
)) {

985 
e1
->
k
 = 
VKINT
;

986 
e1
->
u
.
iv®
 = 
	`iv®ue
(&
»s
);

989 
lua_Numb”
 
n
 = 
	`ætv®ue
(&
»s
);

990 ià(
	`luai_numi¢ª
(
n
) ||‚ == 0)

992 
e1
->
k
 = 
VKFLT
;

993 
e1
->
u
.
nv®
 = 
n
;

996 
	}
}

1004 
	$codeuÃxpv®
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
, 
expdesc
 *
e
, 
lše
) {

1005 
r
 = 
	`luaK_exp2ªy»g
(
fs
, 
e
);

1006 
	`ä“exp
(
fs
, 
e
);

1007 
e
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0, 
r
, 0);

1008 
e
->
k
 = 
VRELOCABLE
;

1009 
	`luaK_fixlše
(
fs
, 
lše
);

1010 
	}
}

1022 
	$codebšexpv®
 (
FuncS‹
 *
fs
, 
OpCode
 
İ
,

1023 
expdesc
 *
e1
,ƒxpdesø*
e2
, 
lše
) {

1024 
rk2
 = 
	`luaK_exp2RK
(
fs
, 
e2
);

1025 
rk1
 = 
	`luaK_exp2RK
(
fs
, 
e1
);

1026 
	`ä“exps
(
fs
, 
e1
, 
e2
);

1027 
e1
->
u
.
šfo
 = 
	`luaK_codeABC
(
fs
, 
İ
, 0, 
rk1
, 
rk2
);

1028 
e1
->
k
 = 
VRELOCABLE
;

1029 
	`luaK_fixlše
(
fs
, 
lše
);

1030 
	}
}

1037 
	$codecomp
 (
FuncS‹
 *
fs
, 
BšO´
 
İr
, 
expdesc
 *
e1
,ƒxpdesø*
e2
) {

1038 
rk1
 = (
e1
->
k
 =ğ
VK
è? 
	`RKASK
Ó1->
u
.
šfo
)

1039 : 
	`check_exp
(
e1
->
k
 =ğ
VNONRELOC
,ƒ1->
u
.
šfo
);

1040 
rk2
 = 
	`luaK_exp2RK
(
fs
, 
e2
);

1041 
	`ä“exps
(
fs
, 
e1
, 
e2
);

1042 
İr
) {

1043 
OPR_NE
: {

1044 
e1
->
u
.
šfo
 = 
	`cÚdjump
(
fs
, 
OP_EQ
, 0, 
rk1
, 
rk2
);

1047 
OPR_GT
: 
OPR_GE
: {

1049 
OpCode
 
İ
 = 
	`ÿ¡
(OpCode, (
İr
 - 
OPR_NE
è+ 
OP_EQ
);

1050 
e1
->
u
.
šfo
 = 
	`cÚdjump
(
fs
, 
İ
, 1, 
rk2
, 
rk1
);

1054 
OpCode
 
İ
 = 
	`ÿ¡
(OpCode, (
İr
 - 
OPR_EQ
è+ 
OP_EQ
);

1055 
e1
->
u
.
šfo
 = 
	`cÚdjump
(
fs
, 
İ
, 1, 
rk1
, 
rk2
);

1059 
e1
->
k
 = 
VJMP
;

1060 
	}
}

1066 
	$luaK_´efix
 (
FuncS‹
 *
fs
, 
UnO´
 
İ
, 
expdesc
 *
e
, 
lše
) {

1067 cÚ¡ 
expdesc
 
ef
 = {
VKINT
, {0}, 
NO_JUMP
, NO_JUMP};

1068 
İ
) {

1069 
OPR_MINUS
: 
OPR_BNOT
:

1070 ià(
	`cÚ¡fŞdšg
(
fs
, 
İ
 + 
LUA_OPUNM
, 
e
, &
ef
))

1073 
OPR_LEN
:

1074 
	`codeuÃxpv®
(
fs
, 
	`ÿ¡
(
OpCode
, 
İ
 + 
OP_UNM
), 
e
, 
lše
);

1076 
OPR_NOT
: 
	`cod’Ù
(
fs
, 
e
); ;

1077 : 
	`lua_as£¹
(0);

1079 
	}
}

1086 
	$luaK_šfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v
) {

1087 
İ
) {

1088 
OPR_AND
: {

1089 
	`luaK_goiárue
(
fs
, 
v
);

1092 
OPR_OR
: {

1093 
	`luaK_goifçl£
(
fs
, 
v
);

1096 
OPR_CONCAT
: {

1097 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

1100 
OPR_ADD
: 
OPR_SUB
:

1101 
OPR_MUL
: 
OPR_DIV
: 
OPR_IDIV
:

1102 
OPR_MOD
: 
OPR_POW
:

1103 
OPR_BAND
: 
OPR_BOR
: 
OPR_BXOR
:

1104 
OPR_SHL
: 
OPR_SHR
: {

1105 ià(!
	`tÚum”®
(
v
, 
NULL
))

1106 
	`luaK_exp2RK
(
fs
, 
v
);

1111 
	`luaK_exp2RK
(
fs
, 
v
);

1115 
	}
}

1124 
	$luaK_posfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
,

1125 
expdesc
 *
e1
,ƒxpdesø*
e2
, 
lše
) {

1126 
İ
) {

1127 
OPR_AND
: {

1128 
	`lua_as£¹
(
e1
->
t
 =ğ
NO_JUMP
);

1129 
	`luaK_disch¬gev¬s
(
fs
, 
e2
);

1130 
	`luaK_cÚÿt
(
fs
, &
e2
->
f
, 
e1
->f);

1131 *
e1
 = *
e2
;

1134 
OPR_OR
: {

1135 
	`lua_as£¹
(
e1
->
f
 =ğ
NO_JUMP
);

1136 
	`luaK_disch¬gev¬s
(
fs
, 
e2
);

1137 
	`luaK_cÚÿt
(
fs
, &
e2
->
t
, 
e1
->t);

1138 *
e1
 = *
e2
;

1141 
OPR_CONCAT
: {

1142 
	`luaK_exp2v®
(
fs
, 
e2
);

1143 ià(
e2
->
k
 =ğ
VRELOCABLE
 &&

1144 
	`GET_OPCODE
(
	`g‘š¡ruùiÚ
(
fs
, 
e2
)è=ğ
OP_CONCAT
) {

1145 
	`lua_as£¹
(
e1
->
u
.
šfo
 =ğ
	`GETARG_B
(
	`g‘š¡ruùiÚ
(
fs
, 
e2
))-1);

1146 
	`ä“exp
(
fs
, 
e1
);

1147 
	`SETARG_B
(
	`g‘š¡ruùiÚ
(
fs
, 
e2
), 
e1
->
u
.
šfo
);

1148 
e1
->
k
 = 
VRELOCABLE
;ƒ1->
u
.
šfo
 = 
e2
->u.info;

1151 
	`luaK_exp2ÃxŒeg
(
fs
, 
e2
);

1152 
	`codebšexpv®
(
fs
, 
OP_CONCAT
, 
e1
, 
e2
, 
lše
);

1156 
OPR_ADD
: 
OPR_SUB
: 
OPR_MUL
: 
OPR_DIV
:

1157 
OPR_IDIV
: 
OPR_MOD
: 
OPR_POW
:

1158 
OPR_BAND
: 
OPR_BOR
: 
OPR_BXOR
:

1159 
OPR_SHL
: 
OPR_SHR
: {

1160 ià(!
	`cÚ¡fŞdšg
(
fs
, 
İ
 + 
LUA_OPADD
, 
e1
, 
e2
))

1161 
	`codebšexpv®
(
fs
, 
	`ÿ¡
(
OpCode
, 
İ
 + 
OP_ADD
), 
e1
, 
e2
, 
lše
);

1164 
OPR_EQ
: 
OPR_LT
: 
OPR_LE
:

1165 
OPR_NE
: 
OPR_GT
: 
OPR_GE
: {

1166 
	`codecomp
(
fs
, 
İ
, 
e1
, 
e2
);

1169 : 
	`lua_as£¹
(0);

1171 
	}
}

1177 
	$luaK_fixlše
 (
FuncS‹
 *
fs
, 
lše
) {

1178 
fs
->
f
->
¥
->
lšešfo
[fs->
pc
 - 1] = 
lše
;

1179 
	}
}

1189 
	$luaK_£i¡
 (
FuncS‹
 *
fs
, 
ba£
, 
ÃËms
, 
to¡Üe
) {

1190 
c
 = (
ÃËms
 - 1)/
LFIELDS_PER_FLUSH
 + 1;

1191 
b
 = (
to¡Üe
 =ğ
LUA_MULTRET
) ? 0 :ostore;

1192 
	`lua_as£¹
(
to¡Üe
 !ğ0 &&o¡Ü<ğ
LFIELDS_PER_FLUSH
);

1193 ià(
c
 <ğ
MAXARG_C
)

1194 
	`luaK_codeABC
(
fs
, 
OP_SETLIST
, 
ba£
, 
b
, 
c
);

1195 ià(
c
 <ğ
MAXARG_Ax
) {

1196 
	`luaK_codeABC
(
fs
, 
OP_SETLIST
, 
ba£
, 
b
, 0);

1197 
	`cod“xŒ¯rg
(
fs
, 
c
);

1200 
	`luaX_syÁax”rÜ
(
fs
->
ls
, "constructoroo†ong");

1201 
fs
->
ä“»g
 = 
ba£
 + 1;

1202 
	}
}

	@3rd/lua/lcode.h

7 #iâdeà
lcode_h


8 
	#lcode_h


	)

10 
	~"Îex.h
"

11 
	~"lobjeù.h
"

12 
	~"lİcodes.h
"

13 
	~"Í¬£r.h
"

20 
	#NO_JUMP
 (-1)

	)

26 
	eBšO´
 {

27 
	mOPR_ADD
, 
	mOPR_SUB
, 
	mOPR_MUL
, 
	mOPR_MOD
, 
	mOPR_POW
,

28 
	mOPR_DIV
,

29 
	mOPR_IDIV
,

30 
	mOPR_BAND
, 
	mOPR_BOR
, 
	mOPR_BXOR
,

31 
	mOPR_SHL
, 
	mOPR_SHR
,

32 
	mOPR_CONCAT
,

33 
	mOPR_EQ
, 
	mOPR_LT
, 
	mOPR_LE
,

34 
	mOPR_NE
, 
	mOPR_GT
, 
	mOPR_GE
,

35 
	mOPR_AND
, 
	mOPR_OR
,

36 
	mOPR_NOBINOPR


37 } 
	tBšO´
;

40 
	eUnO´
 { 
	mOPR_MINUS
, 
	mOPR_BNOT
, 
	mOPR_NOT
, 
	mOPR_LEN
, 
	mOPR_NOUNOPR
 } 
	tUnO´
;

44 
	#g‘š¡ruùiÚ
(
fs
,
e
è((fs)->
f
->
¥
->
code
[Ó)->
u
.
šfo
])

	)

46 
	#luaK_codeAsBx
(
fs
,
o
,
A
,
sBx
è
	`luaK_codeABx
(fs,o,A,(sBx)+
MAXARG_sBx
)

	)

48 
	#luaK_£tmuÉ»t
(
fs
,
e
è
	`luaK_£Œ‘uºs
(fs,ƒ, 
LUA_MULTRET
)

	)

50 
	#luaK_jum±o
(
fs
,
t
è
	`luaK_·tchli¡
(fs, 
	`luaK_jump
(fs),)

	)

52 
LUAI_FUNC
 
luaK_codeABx
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
A
, 
Bx
);

53 
LUAI_FUNC
 
luaK_codeABC
 (
FuncS‹
 *
fs
, 
OpCode
 
o
, 
A
, 
B
, 
C
);

54 
LUAI_FUNC
 
luaK_codek
 (
FuncS‹
 *
fs
, 
»g
, 
k
);

55 
LUAI_FUNC
 
luaK_fixlše
 (
FuncS‹
 *
fs
, 
lše
);

56 
LUAI_FUNC
 
luaK_n
 (
FuncS‹
 *
fs
, 
äom
, 
n
);

57 
LUAI_FUNC
 
luaK_»£rv”egs
 (
FuncS‹
 *
fs
, 
n
);

58 
LUAI_FUNC
 
luaK_check¡ack
 (
FuncS‹
 *
fs
, 
n
);

59 
LUAI_FUNC
 
luaK_¡ršgK
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
s
);

60 
LUAI_FUNC
 
luaK_štK
 (
FuncS‹
 *
fs
, 
lua_IÁeg”
 
n
);

61 
LUAI_FUNC
 
luaK_disch¬gev¬s
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

62 
LUAI_FUNC
 
luaK_exp2ªy»g
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

63 
LUAI_FUNC
 
luaK_exp2ªy»gup
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

64 
LUAI_FUNC
 
luaK_exp2ÃxŒeg
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

65 
LUAI_FUNC
 
luaK_exp2v®
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

66 
LUAI_FUNC
 
luaK_exp2RK
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

67 
LUAI_FUNC
 
luaK_£lf
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
,ƒxpdesø*
key
);

68 
LUAI_FUNC
 
luaK_šdexed
 (
FuncS‹
 *
fs
, 
expdesc
 *
t
,ƒxpdesø*
k
);

69 
LUAI_FUNC
 
luaK_goiárue
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

70 
LUAI_FUNC
 
luaK_goifçl£
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

71 
LUAI_FUNC
 
luaK_¡Üev¬
 (
FuncS‹
 *
fs
, 
expdesc
 *
v¬
,ƒxpdesø*
e
);

72 
LUAI_FUNC
 
luaK_£Œ‘uºs
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
, 
ÄesuÉs
);

73 
LUAI_FUNC
 
luaK_£tÚ”‘
 (
FuncS‹
 *
fs
, 
expdesc
 *
e
);

74 
LUAI_FUNC
 
luaK_jump
 (
FuncS‹
 *
fs
);

75 
LUAI_FUNC
 
luaK_»t
 (
FuncS‹
 *
fs
, 
fœ¡
, 
Ä‘
);

76 
LUAI_FUNC
 
luaK_·tchli¡
 (
FuncS‹
 *
fs
, 
li¡
, 
rg‘
);

77 
LUAI_FUNC
 
luaK_·tchtoh”e
 (
FuncS‹
 *
fs
, 
li¡
);

78 
LUAI_FUNC
 
luaK_·tchşo£
 (
FuncS‹
 *
fs
, 
li¡
, 
Ëv–
);

79 
LUAI_FUNC
 
luaK_cÚÿt
 (
FuncS‹
 *
fs
, *
l1
, 
l2
);

80 
LUAI_FUNC
 
luaK_g‘Ïb–
 (
FuncS‹
 *
fs
);

81 
LUAI_FUNC
 
luaK_´efix
 (
FuncS‹
 *
fs
, 
UnO´
 
İ
, 
expdesc
 *
v
, 
lše
);

82 
LUAI_FUNC
 
luaK_šfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v
);

83 
LUAI_FUNC
 
luaK_posfix
 (
FuncS‹
 *
fs
, 
BšO´
 
İ
, 
expdesc
 *
v1
,

84 
expdesc
 *
v2
, 
lše
);

85 
LUAI_FUNC
 
luaK_£i¡
 (
FuncS‹
 *
fs
, 
ba£
, 
ÃËms
, 
to¡Üe
);

	@3rd/lua/lcorolib.c

7 
	#lcÜŞib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<¡dlib.h
>

15 
	~"lua.h
"

17 
	~"Ïuxlib.h
"

18 
	~"lu®ib.h
"

21 
lua_S‹
 *
	$g‘co
 (
lua_S‹
 *
L
) {

22 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 1);

23 
	`luaL_¬gcheck
(
L
, 
co
, 1, "threadƒxpected");

24  
co
;

25 
	}
}

28 
	$aux»sume
 (
lua_S‹
 *
L
,†ua_S‹ *
co
, 
Çrg
) {

29 
¡©us
;

30 ià(!
	`lua_check¡ack
(
co
, 
Çrg
)) {

31 
	`lua_pushl™”®
(
L
, "too many‡rgumentso„esume");

34 ià(
	`lua_¡©us
(
co
è=ğ
LUA_OK
 && 
	`lua_g‘tİ
(co) == 0) {

35 
	`lua_pushl™”®
(
L
, "cannot„esume dead coroutine");

38 
	`lua_xmove
(
L
, 
co
, 
Çrg
);

39 
¡©us
 = 
	`lua_»sume
(
co
, 
L
, 
Çrg
);

40 ià(
¡©us
 =ğ
LUA_OK
 || stu =ğ
LUA_YIELD
) {

41 
Äes
 = 
	`lua_g‘tİ
(
co
);

42 ià(!
	`lua_check¡ack
(
L
, 
Äes
 + 1)) {

43 
	`lua_pİ
(
co
, 
Äes
);

44 
	`lua_pushl™”®
(
L
, "too many„esultso„esume");

47 
	`lua_xmove
(
co
, 
L
, 
Äes
);

48  
Äes
;

51 
	`lua_xmove
(
co
, 
L
, 1);

54 
	}
}

57 
	$luaB_cÜesume
 (
lua_S‹
 *
L
) {

58 
lua_S‹
 *
co
 = 
	`g‘co
(
L
);

59 
r
;

60 
r
 = 
	`aux»sume
(
L
, 
co
, 
	`lua_g‘tİ
(L) - 1);

61 ià(
r
 < 0) {

62 
	`lua_pushboŞ—n
(
L
, 0);

63 
	`lua_š£¹
(
L
, -2);

67 
	`lua_pushboŞ—n
(
L
, 1);

68 
	`lua_š£¹
(
L
, -(
r
 + 1));

69  
r
 + 1;

71 
	}
}

74 
	$luaB_auxw¿p
 (
lua_S‹
 *
L
) {

75 
lua_S‹
 *
co
 = 
	`lua_tÙh»ad
(
L
, 
	`lua_upv®uešdex
(1));

76 
r
 = 
	`aux»sume
(
L
, 
co
, 
	`lua_g‘tİ
(L));

77 ià(
r
 < 0) {

78 ià(
	`lua_ty³
(
L
, -1è=ğ
LUA_TSTRING
) {

79 
	`luaL_wh”e
(
L
, 1);

80 
	`lua_š£¹
(
L
, -2);

81 
	`lua_cÚÿt
(
L
, 2);

83  
	`lua_”rÜ
(
L
);

85  
r
;

86 
	}
}

89 
	$luaB_coü—‹
 (
lua_S‹
 *
L
) {

90 
lua_S‹
 *
NL
;

91 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

92 
NL
 = 
	`lua_Ãwth»ad
(
L
);

93 
	`lua_pushv®ue
(
L
, 1);

94 
	`lua_xmove
(
L
, 
NL
, 1);

96 
	}
}

99 
	$luaB_cow¿p
 (
lua_S‹
 *
L
) {

100 
	`luaB_coü—‹
(
L
);

101 
	`lua_pushcşosu»
(
L
, 
luaB_auxw¿p
, 1);

103 
	}
}

106 
	$luaB_y›ld
 (
lua_S‹
 *
L
) {

107  
	`lua_y›ld
(
L
, 
	`lua_g‘tİ
(L));

108 
	}
}

111 
	$luaB_co¡©us
 (
lua_S‹
 *
L
) {

112 
lua_S‹
 *
co
 = 
	`g‘co
(
L
);

113 ià(
L
 =ğ
co
è
	`lua_pushl™”®
(L, "running");

115 
	`lua_¡©us
(
co
)) {

116 
LUA_YIELD
:

117 
	`lua_pushl™”®
(
L
, "suspended");

119 
LUA_OK
: {

120 
lua_Debug
 
¬
;

121 ià(
	`lua_g‘¡ack
(
co
, 0, &
¬
) > 0)

122 
	`lua_pushl™”®
(
L
, "normal");

123 ià(
	`lua_g‘tİ
(
co
) == 0)

124 
	`lua_pushl™”®
(
L
, "dead");

126 
	`lua_pushl™”®
(
L
, "suspended");

130 
	`lua_pushl™”®
(
L
, "dead");

135 
	}
}

138 
	$luaB_y›ldabË
 (
lua_S‹
 *
L
) {

139 
	`lua_pushboŞ—n
(
L
, 
	`lua_isy›ldabË
(L));

141 
	}
}

144 
	$luaB_cÜuÂšg
 (
lua_S‹
 *
L
) {

145 
ismaš
 = 
	`lua_pushth»ad
(
L
);

146 
	`lua_pushboŞ—n
(
L
, 
ismaš
);

148 
	}
}

151 cÚ¡ 
luaL_Reg
 
	gco_funcs
[] = {

152 {"ü—‹", 
luaB_coü—‹
},

153 {"»sume", 
luaB_cÜesume
},

154 {"ruÂšg", 
luaB_cÜuÂšg
},

155 {"¡©us", 
luaB_co¡©us
},

156 {"w¿p", 
luaB_cow¿p
},

157 {"y›ld", 
luaB_y›ld
},

158 {"isy›ldabË", 
luaB_y›ldabË
},

159 {
NULL
, NULL}

164 
LUAMOD_API
 
	$luaİ’_cÜoutše
 (
lua_S‹
 *
L
) {

165 
	`luaL_Ãwlib
(
L
, 
co_funcs
);

167 
	}
}

	@3rd/lua/lctype.c

7 
	#lùy³_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~"lùy³.h
"

15 #ià!
LUA_USE_CTYPE


17 
	~<lim™s.h
>

19 
LUAI_DDEF
 cÚ¡ 
lu_by‹
 
	gluai_ùy³_
[
UCHAR_MAX
 + 2] = {

	@3rd/lua/lctype.h

7 #iâdeà
lùy³_h


8 
	#lùy³_h


	)

10 
	~"lua.h
"

19 #ià!
defšed
(
LUA_USE_CTYPE
)

23 
	#LUA_USE_CTYPE
 0

	)

26 
	#LUA_USE_CTYPE
 1

	)

32 #ià!
LUA_USE_CTYPE


34 
	~<lim™s.h
>

36 
	~"Îim™s.h
"

39 
	#ALPHABIT
 0

	)

40 
	#DIGITBIT
 1

	)

41 
	#PRINTBIT
 2

	)

42 
	#SPACEBIT
 3

	)

43 
	#XDIGITBIT
 4

	)

46 
	#MASK
(
B
è(1 << (B))

	)

52 
	#‹¡´İ
(
c
,
p
è(
luai_ùy³_
[(c)+1] & (p))

	)

57 
	#li¦®pha
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
ALPHABIT
))

	)

58 
	#li¦®num
(
c
è
	`‹¡´İ
(c, (
	`MASK
(
ALPHABIT
è| MASK(
DIGITBIT
)))

	)

59 
	#lisdig™
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
DIGITBIT
))

	)

60 
	#lis¥aû
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
SPACEBIT
))

	)

61 
	#li¥ršt
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
PRINTBIT
))

	)

62 
	#lisxdig™
(
c
è
	`‹¡´İ
(c, 
	`MASK
(
XDIGITBIT
))

	)

67 
	#ÉŞow”
(
c
è((cè| ('A' ^ 'a'))

	)

71 
LUAI_DDEC
 cÚ¡ 
lu_by‹
 
	gluai_ùy³_
[
UCHAR_MAX
 + 2];

80 
	~<ùy³.h
>

83 
	#li¦®pha
(
c
è(
	`i§Íha
(cè|| (cè=ğ'_')

	)

84 
	#li¦®num
(
c
è(
	`i§Êum
(cè|| (cè=ğ'_')

	)

85 
	#lisdig™
(
c
è(
	`isdig™
(c))

	)

86 
	#lis¥aû
(
c
è(
	`is¥aû
(c))

	)

87 
	#li¥ršt
(
c
è(
	`i¥ršt
(c))

	)

88 
	#lisxdig™
(
c
è(
	`isxdig™
(c))

	)

90 
	#ÉŞow”
(
c
è(
	`tŞow”
(c))

	)

	@3rd/lua/ldblib.c

7 
	#ldblib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<¡dio.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

27 cÚ¡ 
	gHOOKKEY
 = 0;

35 
	$check¡ack
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
, 
n
) {

36 ià(
L
 !ğ
L1
 && !
	`lua_check¡ack
(L1, 
n
))

37 
	`luaL_”rÜ
(
L
, "stack overflow");

38 
	}
}

41 
	$db_g‘»gi¡ry
 (
lua_S‹
 *
L
) {

42 
	`lua_pushv®ue
(
L
, 
LUA_REGISTRYINDEX
);

44 
	}
}

47 
	$db_g‘m‘©abË
 (
lua_S‹
 *
L
) {

48 
	`luaL_checkªy
(
L
, 1);

49 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

50 
	`lua_pushn
(
L
);

53 
	}
}

56 
	$db_£tm‘©abË
 (
lua_S‹
 *
L
) {

57 
t
 = 
	`lua_ty³
(
L
, 2);

58 
	`luaL_¬gcheck
(
L
, 
t
 =ğ
LUA_TNIL
 || =ğ
LUA_TTABLE
, 2,

60 
	`lua_£‰İ
(
L
, 2);

61 
	`lua_£tm‘©abË
(
L
, 1);

63 
	}
}

66 
	$db_g‘u£rv®ue
 (
lua_S‹
 *
L
) {

67 ià(
	`lua_ty³
(
L
, 1è!ğ
LUA_TUSERDATA
)

68 
	`lua_pushn
(
L
);

70 
	`lua_g‘u£rv®ue
(
L
, 1);

72 
	}
}

75 
	$db_£tu£rv®ue
 (
lua_S‹
 *
L
) {

76 
	`luaL_checkty³
(
L
, 1, 
LUA_TUSERDATA
);

77 
	`luaL_checkªy
(
L
, 2);

78 
	`lua_£‰İ
(
L
, 2);

79 
	`lua_£tu£rv®ue
(
L
, 1);

81 
	}
}

90 
lua_S‹
 *
	$g‘th»ad
 (
lua_S‹
 *
L
, *
¬g
) {

91 ià(
	`lua_i¡h»ad
(
L
, 1)) {

92 *
¬g
 = 1;

93  
	`lua_tÙh»ad
(
L
, 1);

96 *
¬g
 = 0;

97  
L
;

99 
	}
}

107 
	$£‰abss
 (
lua_S‹
 *
L
, cÚ¡ *
k
, cÚ¡ *
v
) {

108 
	`lua_push¡ršg
(
L
, 
v
);

109 
	`lua_£tf›ld
(
L
, -2, 
k
);

110 
	}
}

112 
	$£‰absi
 (
lua_S‹
 *
L
, cÚ¡ *
k
, 
v
) {

113 
	`lua_pushš‹g”
(
L
, 
v
);

114 
	`lua_£tf›ld
(
L
, -2, 
k
);

115 
	}
}

117 
	$£‰absb
 (
lua_S‹
 *
L
, cÚ¡ *
k
, 
v
) {

118 
	`lua_pushboŞ—n
(
L
, 
v
);

119 
	`lua_£tf›ld
(
L
, -2, 
k
);

120 
	}
}

130 
	$Œ—t¡ackİtiÚ
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
, cÚ¡ *
âame
) {

131 ià(
L
 =ğ
L1
)

132 
	`lua_rÙ©e
(
L
, -2, 1);

134 
	`lua_xmove
(
L1
, 
L
, 1);

135 
	`lua_£tf›ld
(
L
, -2, 
âame
);

136 
	}
}

145 
	$db_g‘šfo
 (
lua_S‹
 *
L
) {

146 
lua_Debug
 
¬
;

147 
¬g
;

148 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

149 cÚ¡ *
İtiÚs
 = 
	`luaL_İt¡ršg
(
L
, 
¬g
+2, "flnStu");

150 
	`check¡ack
(
L
, 
L1
, 3);

151 ià(
	`lua_isfunùiÚ
(
L
, 
¬g
 + 1)) {

152 
İtiÚs
 = 
	`lua_pushf¡ršg
(
L
, ">%s", options);

153 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

154 
	`lua_xmove
(
L
, 
L1
, 1);

157 ià(!
	`lua_g‘¡ack
(
L1
, ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 1), &
¬
)) {

158 
	`lua_pushn
(
L
);

162 ià(!
	`lua_g‘šfo
(
L1
, 
İtiÚs
, &
¬
))

163  
	`luaL_¬g”rÜ
(
L
, 
¬g
+2, "invalid option");

164 
	`lua_ÃwbË
(
L
);

165 ià(
	`¡rchr
(
İtiÚs
, 'S')) {

166 
	`£‰abss
(
L
, "sourû", 
¬
.
sourû
);

167 
	`£‰abss
(
L
, "shÜt_¤c", 
¬
.
shÜt_¤c
);

168 
	`£‰absi
(
L
, "lšedefšed", 
¬
.
lšedefšed
);

169 
	`£‰absi
(
L
, "Ï¡lšedefšed", 
¬
.
Ï¡lšedefšed
);

170 
	`£‰abss
(
L
, "wh©", 
¬
.
wh©
);

172 ià(
	`¡rchr
(
İtiÚs
, 'l'))

173 
	`£‰absi
(
L
, "cu¼’še", 
¬
.
cu¼’še
);

174 ià(
	`¡rchr
(
İtiÚs
, 'u')) {

175 
	`£‰absi
(
L
, "nups", 
¬
.
nups
);

176 
	`£‰absi
(
L
, "Å¬ams", 
¬
.
Å¬ams
);

177 
	`£‰absb
(
L
, "isv¬¬g", 
¬
.
isv¬¬g
);

179 ià(
	`¡rchr
(
İtiÚs
, 'n')) {

180 
	`£‰abss
(
L
, "Çme", 
¬
.
Çme
);

181 
	`£‰abss
(
L
, "Çmewh©", 
¬
.
Çmewh©
);

183 ià(
	`¡rchr
(
İtiÚs
, 't'))

184 
	`£‰absb
(
L
, "i¡aÿÎ", 
¬
.
i¡aÿÎ
);

185 ià(
	`¡rchr
(
İtiÚs
, 'L'))

186 
	`Œ—t¡ackİtiÚ
(
L
, 
L1
, "activelines");

187 ià(
	`¡rchr
(
İtiÚs
, 'f'))

188 
	`Œ—t¡ackİtiÚ
(
L
, 
L1
, "func");

190 
	}
}

193 
	$db_g‘loÿl
 (
lua_S‹
 *
L
) {

194 
¬g
;

195 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

196 
lua_Debug
 
¬
;

197 cÚ¡ *
Çme
;

198 
nv¬
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 2);

199 ià(
	`lua_isfunùiÚ
(
L
, 
¬g
 + 1)) {

200 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

201 
	`lua_push¡ršg
(
L
, 
	`lua_g‘loÿl
(L, 
NULL
, 
nv¬
));

205 
Ëv–
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 1);

206 ià(!
	`lua_g‘¡ack
(
L1
, 
Ëv–
, &
¬
))

207  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "level out of„ange");

208 
	`check¡ack
(
L
, 
L1
, 1);

209 
Çme
 = 
	`lua_g‘loÿl
(
L1
, &
¬
, 
nv¬
);

210 ià(
Çme
) {

211 
	`lua_xmove
(
L1
, 
L
, 1);

212 
	`lua_push¡ršg
(
L
, 
Çme
);

213 
	`lua_rÙ©e
(
L
, -2, 1);

217 
	`lua_pushn
(
L
);

221 
	}
}

224 
	$db_£oÿl
 (
lua_S‹
 *
L
) {

225 
¬g
;

226 cÚ¡ *
Çme
;

227 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

228 
lua_Debug
 
¬
;

229 
Ëv–
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 1);

230 
nv¬
 = ()
	`luaL_checkš‹g”
(
L
, 
¬g
 + 2);

231 ià(!
	`lua_g‘¡ack
(
L1
, 
Ëv–
, &
¬
))

232  
	`luaL_¬g”rÜ
(
L
, 
¬g
+1, "level out of„ange");

233 
	`luaL_checkªy
(
L
, 
¬g
+3);

234 
	`lua_£‰İ
(
L
, 
¬g
+3);

235 
	`check¡ack
(
L
, 
L1
, 1);

236 
	`lua_xmove
(
L
, 
L1
, 1);

237 
Çme
 = 
	`lua_£oÿl
(
L1
, &
¬
, 
nv¬
);

238 ià(
Çme
 =ğ
NULL
)

239 
	`lua_pİ
(
L1
, 1);

240 
	`lua_push¡ršg
(
L
, 
Çme
);

242 
	}
}

248 
	$auxupv®ue
 (
lua_S‹
 *
L
, 
g‘
) {

249 cÚ¡ *
Çme
;

250 
n
 = ()
	`luaL_checkš‹g”
(
L
, 2);

251 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

252 
Çme
 = 
g‘
 ? 
	`lua_g‘upv®ue
(
L
, 1, 
n
è: 
	`lua_£tupv®ue
(L, 1,‚);

253 ià(
Çme
 =ğ
NULL
)  0;

254 
	`lua_push¡ršg
(
L
, 
Çme
);

255 
	`lua_š£¹
(
L
, -(
g‘
+1));

256  
g‘
 + 1;

257 
	}
}

260 
	$db_g‘upv®ue
 (
lua_S‹
 *
L
) {

261  
	`auxupv®ue
(
L
, 1);

262 
	}
}

265 
	$db_£tupv®ue
 (
lua_S‹
 *
L
) {

266 
	`luaL_checkªy
(
L
, 3);

267  
	`auxupv®ue
(
L
, 0);

268 
	}
}

275 
	$checkupv®
 (
lua_S‹
 *
L
, 
¬gf
, 
¬gnup
) {

276 
nup
 = ()
	`luaL_checkš‹g”
(
L
, 
¬gnup
);

277 
	`luaL_checkty³
(
L
, 
¬gf
, 
LUA_TFUNCTION
);

278 
	`luaL_¬gcheck
(
L
, (
	`lua_g‘upv®ue
(L, 
¬gf
, 
nup
è!ğ
NULL
), 
¬gnup
,

280  
nup
;

281 
	}
}

284 
	$db_upv®ueid
 (
lua_S‹
 *
L
) {

285 
n
 = 
	`checkupv®
(
L
, 1, 2);

286 
	`lua_pushlightu£rd©a
(
L
, 
	`lua_upv®ueid
(L, 1, 
n
));

288 
	}
}

291 
	$db_upv®uejoš
 (
lua_S‹
 *
L
) {

292 
n1
 = 
	`checkupv®
(
L
, 1, 2);

293 
n2
 = 
	`checkupv®
(
L
, 3, 4);

294 
	`luaL_¬gcheck
(
L
, !
	`lua_iscfunùiÚ
(L, 1), 1, "Lua functionƒxpected");

295 
	`luaL_¬gcheck
(
L
, !
	`lua_iscfunùiÚ
(L, 3), 3, "Lua functionƒxpected");

296 
	`lua_upv®uejoš
(
L
, 1, 
n1
, 3, 
n2
);

298 
	}
}

305 
	$hookf
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

306 cÚ¡ *cÚ¡ 
hookÇmes
[] =

308 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

309 
	`lua_pushth»ad
(
L
);

310 ià(
	`lua_¿wg‘
(
L
, -2è=ğ
LUA_TFUNCTION
) {

311 
	`lua_push¡ršg
(
L
, 
hookÇmes
[()
¬
->
ev’t
]);

312 ià(
¬
->
cu¼’še
 >= 0)

313 
	`lua_pushš‹g”
(
L
, 
¬
->
cu¼’še
);

314 
	`lua_pushn
(
L
);

315 
	`lua_as£¹
(
	`lua_g‘šfo
(
L
, "lS", 
¬
));

316 
	`lua_ÿÎ
(
L
, 2, 0);

318 
	}
}

324 
	$makemask
 (cÚ¡ *
smask
, 
couÁ
) {

325 
mask
 = 0;

326 ià(
	`¡rchr
(
smask
, 'c')è
mask
 |ğ
LUA_MASKCALL
;

327 ià(
	`¡rchr
(
smask
, 'r')è
mask
 |ğ
LUA_MASKRET
;

328 ià(
	`¡rchr
(
smask
, 'l')è
mask
 |ğ
LUA_MASKLINE
;

329 ià(
couÁ
 > 0è
mask
 |ğ
LUA_MASKCOUNT
;

330  
mask
;

331 
	}
}

337 *
	$unmakemask
 (
mask
, *
smask
) {

338 
i
 = 0;

339 ià(
mask
 & 
LUA_MASKCALL
è
smask
[
i
++] = 'c';

340 ià(
mask
 & 
LUA_MASKRET
è
smask
[
i
++] = 'r';

341 ià(
mask
 & 
LUA_MASKLINE
è
smask
[
i
++] = 'l';

342 
smask
[
i
] = '\0';

343  
smask
;

344 
	}
}

347 
	$db_£thook
 (
lua_S‹
 *
L
) {

348 
¬g
, 
mask
, 
couÁ
;

349 
lua_Hook
 
func
;

350 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

351 ià(
	`lua_i¢ÚeÜn
(
L
, 
¬g
+1)) {

352 
	`lua_£‰İ
(
L
, 
¬g
+1);

353 
func
 = 
NULL
; 
mask
 = 0; 
couÁ
 = 0;

356 cÚ¡ *
smask
 = 
	`luaL_check¡ršg
(
L
, 
¬g
+2);

357 
	`luaL_checkty³
(
L
, 
¬g
+1, 
LUA_TFUNCTION
);

358 
couÁ
 = ()
	`luaL_İtš‹g”
(
L
, 
¬g
 + 3, 0);

359 
func
 = 
hookf
; 
mask
 = 
	`makemask
(
smask
, 
couÁ
);

361 ià(
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
è=ğ
LUA_TNIL
) {

362 
	`lua_ü—‹bË
(
L
, 0, 2);

363 
	`lua_pushv®ue
(
L
, -1);

364 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

365 
	`lua_push¡ršg
(
L
, "k");

366 
	`lua_£tf›ld
(
L
, -2, "__mode");

367 
	`lua_pushv®ue
(
L
, -1);

368 
	`lua_£tm‘©abË
(
L
, -2);

370 
	`check¡ack
(
L
, 
L1
, 1);

371 
	`lua_pushth»ad
(
L1
); 
	`lua_xmove
(L1, 
L
, 1);

372 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

373 
	`lua_¿w£t
(
L
, -3);

374 
	`lua_£thook
(
L1
, 
func
, 
mask
, 
couÁ
);

376 
	}
}

379 
	$db_g‘hook
 (
lua_S‹
 *
L
) {

380 
¬g
;

381 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

382 
buff
[5];

383 
mask
 = 
	`lua_g‘hookmask
(
L1
);

384 
lua_Hook
 
hook
 = 
	`lua_g‘hook
(
L1
);

385 ià(
hook
 =ğ
NULL
)

386 
	`lua_pushn
(
L
);

387 ià(
hook
 !ğ
hookf
)

388 
	`lua_pushl™”®
(
L
, "external hook");

390 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

391 
	`check¡ack
(
L
, 
L1
, 1);

392 
	`lua_pushth»ad
(
L1
); 
	`lua_xmove
(L1, 
L
, 1);

393 
	`lua_¿wg‘
(
L
, -2);

394 
	`lua_»move
(
L
, -2);

396 
	`lua_push¡ršg
(
L
, 
	`unmakemask
(
mask
, 
buff
));

397 
	`lua_pushš‹g”
(
L
, 
	`lua_g‘hookcouÁ
(
L1
));

399 
	}
}

402 
	$db_debug
 (
lua_S‹
 *
L
) {

404 
bufãr
[250];

405 
	`lua_wr™e¡ršg”rÜ
("%s", "lua_debug> ");

406 ià(
	`fg‘s
(
bufãr
, (bufãr), 
¡dš
) == 0 ||

407 
	`¡rcmp
(
bufãr
, "cont\n") == 0)

409 ià(
	`luaL_lßdbufãr
(
L
, 
bufãr
, 
	`¡¾’
(buffer), "=(debug command)") ||

410 
	`lua_pÿÎ
(
L
, 0, 0, 0))

411 
	`lua_wr™e¡ršg”rÜ
("%s\n", 
	`lua_to¡ršg
(
L
, -1));

412 
	`lua_£‰İ
(
L
, 0);

414 
	}
}

417 
	$db_Œaûback
 (
lua_S‹
 *
L
) {

418 
¬g
;

419 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

420 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, 
¬g
 + 1);

421 ià(
msg
 =ğ
NULL
 && !
	`lua_i¢ÚeÜn
(
L
, 
¬g
 + 1))

422 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

424 
Ëv–
 = ()
	`luaL_İtš‹g”
(
L
, 
¬g
 + 2, (L =ğ
L1
) ? 1 : 0);

425 
	`luaL_Œaûback
(
L
, 
L1
, 
msg
, 
Ëv–
);

428 
	}
}

431 cÚ¡ 
luaL_Reg
 
	gdblib
[] = {

432 {"debug", 
db_debug
},

433 {"g‘u£rv®ue", 
db_g‘u£rv®ue
},

434 {"g‘hook", 
db_g‘hook
},

435 {"g‘šfo", 
db_g‘šfo
},

436 {"g‘loÿl", 
db_g‘loÿl
},

437 {"g‘»gi¡ry", 
db_g‘»gi¡ry
},

438 {"g‘m‘©abË", 
db_g‘m‘©abË
},

439 {"g‘upv®ue", 
db_g‘upv®ue
},

440 {"upv®uejoš", 
db_upv®uejoš
},

441 {"upv®ueid", 
db_upv®ueid
},

442 {"£tu£rv®ue", 
db_£tu£rv®ue
},

443 {"£thook", 
db_£thook
},

444 {"£oÿl", 
db_£oÿl
},

445 {"£tm‘©abË", 
db_£tm‘©abË
},

446 {"£tupv®ue", 
db_£tupv®ue
},

447 {"Œaûback", 
db_Œaûback
},

448 {
NULL
, NULL}

452 
LUAMOD_API
 
	$luaİ’_debug
 (
lua_S‹
 *
L
) {

453 
	`luaL_Ãwlib
(
L
, 
dblib
);

455 
	}
}

	@3rd/lua/ldebug.c

7 
	#ldebug_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡d¬g.h
>

14 
	~<¡ddef.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïpi.h
"

20 
	~"lcode.h
"

21 
	~"ldebug.h
"

22 
	~"ldo.h
"

23 
	~"lfunc.h
"

24 
	~"lobjeù.h
"

25 
	~"lİcodes.h
"

26 
	~"l¡©e.h
"

27 
	~"l¡ršg.h
"

28 
	~"ÉabË.h
"

29 
	~"Ém.h
"

30 
	~"lvm.h
"

34 
	#noLuaClosu»
(
f
è((fè=ğ
NULL
 || (f)->
c
.
‰
 =ğ
LUA_TCCL
)

	)

38 
	#ci_func
(
ci
è(
	`şLv®ue
((ci)->
func
))

	)

41 cÚ¡ *
funúameäomcode
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
,

42 cÚ¡ **
Çme
);

45 
	$cu¼’c
 (
C®lInfo
 *
ci
) {

46 
	`lua_as£¹
(
	`isLua
(
ci
));

47  
	`pcR–
(
ci
->
u
.
l
.
§vedpc
, 
	`ci_func
(ci)->
p
);

48 
	}
}

51 
	$cu¼’še
 (
C®lInfo
 *
ci
) {

52  
	`g‘funşše
(
	`ci_func
(
ci
)->
p
, 
	`cu¼’c
(ci));

53 
	}
}

62 
	$sw­exŒa
 (
lua_S‹
 *
L
) {

63 ià(
L
->
¡©us
 =ğ
LUA_YIELD
) {

64 
C®lInfo
 *
ci
 = 
L
->ci;

65 
StkId
 
‹mp
 = 
ci
->
func
;

66 
ci
->
func
 = 
	`»¡Üe¡ack
(
L
, ci->
exŒa
);

67 
ci
->
exŒa
 = 
	`§ve¡ack
(
L
, 
‹mp
);

69 
	}
}

81 
LUA_API
 
	$lua_£thook
 (
lua_S‹
 *
L
, 
lua_Hook
 
func
, 
mask
, 
couÁ
) {

82 ià(
func
 =ğ
NULL
 || 
mask
 == 0) {

83 
mask
 = 0;

84 
func
 = 
NULL
;

86 ià(
	`isLua
(
L
->
ci
))

87 
L
->
Şdpc
 = L->
ci
->
u
.
l
.
§vedpc
;

88 
L
->
hook
 = 
func
;

89 
L
->
ba£hookcouÁ
 = 
couÁ
;

90 
	`»£thookcouÁ
(
L
);

91 
L
->
hookmask
 = 
	`ÿ¡_by‹
(
mask
);

92 
	}
}

95 
LUA_API
 
lua_Hook
 
	$lua_g‘hook
 (
lua_S‹
 *
L
) {

96  
L
->
hook
;

97 
	}
}

100 
LUA_API
 
	$lua_g‘hookmask
 (
lua_S‹
 *
L
) {

101  
L
->
hookmask
;

102 
	}
}

105 
LUA_API
 
	$lua_g‘hookcouÁ
 (
lua_S‹
 *
L
) {

106  
L
->
ba£hookcouÁ
;

107 
	}
}

110 
LUA_API
 
	$lua_g‘¡ack
 (
lua_S‹
 *
L
, 
Ëv–
, 
lua_Debug
 *
¬
) {

111 
¡©us
;

112 
C®lInfo
 *
ci
;

113 ià(
Ëv–
 < 0)  0;

114 
	`lua_lock
(
L
);

115 
ci
 = 
L
->ci; 
Ëv–
 > 0 && c˜!ğ&L->
ba£_ci
; c˜ğci->
´evious
)

116 
Ëv–
--;

117 ià(
Ëv–
 =ğ0 && 
ci
 !ğ&
L
->
ba£_ci
) {

118 
¡©us
 = 1;

119 
¬
->
i_ci
 = 
ci
;

121 
¡©us
 = 0;

122 
	`lua_uÆock
(
L
);

123  
¡©us
;

124 
	}
}

127 cÚ¡ *
	$upv®Çme
 (
PrÙo
 *
p
, 
uv
) {

128 
TSŒšg
 *
s
 = 
	`check_exp
(
uv
 < 
p
->
¥
->
sizeupv®ues
,…->¥->
upv®ues
[uv].
Çme
);

129 ià(
s
 =ğ
NULL
)  "?";

130  
	`g‘¡r
(
s
);

131 
	}
}

134 cÚ¡ *
	$fšdv¬¬g
 (
C®lInfo
 *
ci
, 
n
, 
StkId
 *
pos
) {

135 
Å¬ams
 = 
	`şLv®ue
(
ci
->
func
)->
p
->
¥
->
num·¿ms
;

136 ià(
n
 >ğ
	`ÿ¡_št
(
ci
->
u
.
l
.
ba£
 - ci->
func
è- 
Å¬ams
)

137  
NULL
;

139 *
pos
 = 
ci
->
func
 + 
Å¬ams
 + 
n
;

142 
	}
}

145 cÚ¡ *
	$fšdloÿl
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
n
,

146 
StkId
 *
pos
) {

147 cÚ¡ *
Çme
 = 
NULL
;

148 
StkId
 
ba£
;

149 ià(
	`isLua
(
ci
)) {

150 ià(
n
 < 0)

151  
	`fšdv¬¬g
(
ci
, -
n
, 
pos
);

153 
ba£
 = 
ci
->
u
.
l
.base;

154 
Çme
 = 
	`luaF_g‘loÿÊame
(
	`ci_func
(
ci
)->
p
, 
n
, 
	`cu¼’c
(ci));

158 
ba£
 = 
ci
->
func
 + 1;

159 ià(
Çme
 =ğ
NULL
) {

160 
StkId
 
lim™
 = (
ci
 =ğ
L
->ciè? L->
tİ
 : ci->
Ãxt
->
func
;

161 ià(
lim™
 - 
ba£
 >ğ
n
 &&‚ > 0)

162 
Çme
 = "(*temporary)";

164  
NULL
;

166 *
pos
 = 
ba£
 + (
n
 - 1);

167  
Çme
;

168 
	}
}

171 
LUA_API
 cÚ¡ *
	$lua_g‘loÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
) {

172 cÚ¡ *
Çme
;

173 
	`lua_lock
(
L
);

174 
	`sw­exŒa
(
L
);

175 ià(
¬
 =ğ
NULL
) {

176 ià(!
	`isLfunùiÚ
(
L
->
tİ
 - 1))

177 
Çme
 = 
NULL
;

179 
Çme
 = 
	`luaF_g‘loÿÊame
(
	`şLv®ue
(
L
->
tİ
 - 1)->
p
, 
n
, 0);

182 
StkId
 
pos
 = 
NULL
;

183 
Çme
 = 
	`fšdloÿl
(
L
, 
¬
->
i_ci
, 
n
, &
pos
);

184 ià(
Çme
) {

185 
	`£tobj2s
(
L
, L->
tİ
, 
pos
);

186 
	`­i_šü_tİ
(
L
);

189 
	`sw­exŒa
(
L
);

190 
	`lua_uÆock
(
L
);

191  
Çme
;

192 
	}
}

195 
LUA_API
 cÚ¡ *
	$lua_£oÿl
 (
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
) {

196 
StkId
 
pos
 = 
NULL
;

197 cÚ¡ *
Çme
;

198 
	`lua_lock
(
L
);

199 
	`sw­exŒa
(
L
);

200 
Çme
 = 
	`fšdloÿl
(
L
, 
¬
->
i_ci
, 
n
, &
pos
);

201 ià(
Çme
) {

202 
	`£tobjs2s
(
L
, 
pos
, L->
tİ
 - 1);

203 
L
->
tİ
--;

205 
	`sw­exŒa
(
L
);

206 
	`lua_uÆock
(
L
);

207  
Çme
;

208 
	}
}

211 
	$funcšfo
 (
lua_Debug
 *
¬
, 
Closu»
 *
ş
) {

212 ià(
	`noLuaClosu»
(
ş
)) {

213 
¬
->
sourû
 = "=[C]";

214 
¬
->
lšedefšed
 = -1;

215 
¬
->
Ï¡lšedefšed
 = -1;

216 
¬
->
wh©
 = "C";

219 
Sh¬edPrÙo
 *
p
 = 
ş
->
l
.p->
¥
;

220 
¬
->
sourû
 = 
p
->sourû ? 
	`g‘¡r
(p->source) : "=?";

221 
¬
->
lšedefšed
 = 
p
->linedefined;

222 
¬
->
Ï¡lšedefšed
 = 
p
->lastlinedefined;

223 
¬
->
wh©
 = (¬->
lšedefšed
 == 0) ? "main" : "Lua";

225 
	`luaO_chunkid
(
¬
->
shÜt_¤c
,‡r->
sourû
, 
LUA_IDSIZE
);

226 
	}
}

229 
	$cŞËùv®idlšes
 (
lua_S‹
 *
L
, 
Closu»
 *
f
) {

230 ià(
	`noLuaClosu»
(
f
)) {

231 
	`£Šv®ue
(
L
->
tİ
);

232 
	`­i_šü_tİ
(
L
);

235 
i
;

236 
TV®ue
 
v
;

237 *
lšešfo
 = 
f
->
l
.
p
->
¥
->lineinfo;

238 
TabË
 *
t
 = 
	`luaH_Ãw
(
L
);

239 
	`£thv®ue
(
L
, L->
tİ
, 
t
);

240 
	`­i_šü_tİ
(
L
);

241 
	`£tbv®ue
(&
v
, 1);

242 
i
 = 0; i < 
f
->
l
.
p
->
¥
->
siz–šešfo
; i++)

243 
	`luaH_£tšt
(
L
, 
t
, 
lšešfo
[
i
], &
v
);

245 
	}
}

248 cÚ¡ *
	$g‘funúame
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, cÚ¡ **
Çme
) {

249 ià(
ci
 =ğ
NULL
)

250  
NULL
;

251 ià(
ci
->
ÿÎ¡©us
 & 
CIST_FIN
) {

252 *
Çme
 = "__gc";

256 ià(!(
ci
->
ÿÎ¡©us
 & 
CIST_TAIL
è&& 
	`isLua
(ci->
´evious
))

257  
	`funúameäomcode
(
L
, 
ci
->
´evious
, 
Çme
);

258  
NULL
;

259 
	}
}

262 
	$auxg‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
,

263 
Closu»
 *
f
, 
C®lInfo
 *
ci
) {

264 
¡©us
 = 1;

265 ; *
wh©
; what++) {

266 *
wh©
) {

268 
	`funcšfo
(
¬
, 
f
);

272 
¬
->
cu¼’še
 = (
ci
 && 
	`isLua
(ci)è? 
	`cu¼’še
(ci) : -1;

276 
¬
->
nups
 = (
f
 =ğ
NULL
è? 0 : f->
c
.
nupv®ues
;

277 ià(
	`noLuaClosu»
(
f
)) {

278 
¬
->
isv¬¬g
 = 1;

279 
¬
->
Å¬ams
 = 0;

282 
¬
->
isv¬¬g
 = 
f
->
l
.
p
->
¥
->
is_v¬¬g
;

283 
¬
->
Å¬ams
 = 
f
->
l
.
p
->
¥
->
num·¿ms
;

288 
¬
->
i¡aÿÎ
 = (
ci
è? ci->
ÿÎ¡©us
 & 
CIST_TAIL
 : 0;

292 
¬
->
Çmewh©
 = 
	`g‘funúame
(
L
, 
ci
, &¬->
Çme
);

293 ià(
¬
->
Çmewh©
 =ğ
NULL
) {

294 
¬
->
Çmewh©
 = "";

295 
¬
->
Çme
 = 
NULL
;

302 : 
¡©us
 = 0;

305  
¡©us
;

306 
	}
}

309 
LUA_API
 
	$lua_g‘šfo
 (
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
) {

310 
¡©us
;

311 
Closu»
 *
ş
;

312 
C®lInfo
 *
ci
;

313 
StkId
 
func
;

314 
	`lua_lock
(
L
);

315 
	`sw­exŒa
(
L
);

316 ià(*
wh©
 == '>') {

317 
ci
 = 
NULL
;

318 
func
 = 
L
->
tİ
 - 1;

319 
	`­i_check
(
L
, 
	`‰isfunùiÚ
(
func
), "functionƒxpected");

320 
wh©
++;

321 
L
->
tİ
--;

324 
ci
 = 
¬
->
i_ci
;

325 
func
 = 
ci
->func;

326 
	`lua_as£¹
(
	`‰isfunùiÚ
(
ci
->
func
));

328 
ş
 = 
	`‰isşosu»
(
func
è? 
	`şv®ue
(funcè: 
NULL
;

329 
¡©us
 = 
	`auxg‘šfo
(
L
, 
wh©
, 
¬
, 
ş
, 
ci
);

330 ià(
	`¡rchr
(
wh©
, 'f')) {

331 
	`£tobjs2s
(
L
, L->
tİ
, 
func
);

332 
	`­i_šü_tİ
(
L
);

334 
	`sw­exŒa
(
L
);

335 ià(
	`¡rchr
(
wh©
, 'L'))

336 
	`cŞËùv®idlšes
(
L
, 
ş
);

337 
	`lua_uÆock
(
L
);

338  
¡©us
;

339 
	}
}

348 cÚ¡ *
g‘objÇme
 (
PrÙo
 *
p
, 
Ï¡pc
, 
»g
,

349 cÚ¡ **
Çme
);

355 
	$kÇme
 (
PrÙo
 *
p
, 
pc
, 
c
, cÚ¡ **
Çme
) {

356 ià(
	`ISK
(
c
)) {

357 
TV®ue
 *
kv®ue
 = &
p
->
k
[
	`INDEXK
(
c
)];

358 ià(
	`‰is¡ršg
(
kv®ue
)) {

359 *
Çme
 = 
	`sv®ue
(
kv®ue
);

365 cÚ¡ *
wh©
 = 
	`g‘objÇme
(
p
, 
pc
, 
c
, 
Çme
);

366 ià(
wh©
 && *what == 'c') {

371 *
Çme
 = "?";

372 
	}
}

375 
	$f‹½c
 (
pc
, 
jm±¬g‘
) {

376 ià(
pc
 < 
jm±¬g‘
)

378  
pc
;

379 
	}
}

385 
	$fšd£Œeg
 (
PrÙo
 *
p
, 
Ï¡pc
, 
»g
) {

386 
pc
;

387 
£Œeg
 = -1;

388 
jm±¬g‘
 = 0;

389 
pc
 = 0;…ø< 
Ï¡pc
;…c++) {

390 
In¡ruùiÚ
 
i
 = 
p
->
¥
->
code
[
pc
];

391 
OpCode
 
İ
 = 
	`GET_OPCODE
(
i
);

392 
a
 = 
	`GETARG_A
(
i
);

393 
İ
) {

394 
OP_LOADNIL
: {

395 
b
 = 
	`GETARG_B
(
i
);

396 ià(
a
 <ğ
»g
 &&„eg <ğ¨+ 
b
)

397 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

400 
OP_TFORCALL
: {

401 ià(
»g
 >ğ
a
 + 2)

402 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

405 
OP_CALL
:

406 
OP_TAILCALL
: {

407 ià(
»g
 >ğ
a
)

408 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

411 
OP_JMP
: {

412 
b
 = 
	`GETARG_sBx
(
i
);

413 
de¡
 = 
pc
 + 1 + 
b
;

415 ià(
pc
 < 
de¡
 && de¡ <ğ
Ï¡pc
) {

416 ià(
de¡
 > 
jm±¬g‘
)

417 
jm±¬g‘
 = 
de¡
;

422 ià(
	`‹¡AMode
(
İ
è&& 
»g
 =ğ
a
)

423 
£Œeg
 = 
	`f‹½c
(
pc
, 
jm±¬g‘
);

427  
£Œeg
;

428 
	}
}

431 cÚ¡ *
	$g‘objÇme
 (
PrÙo
 *
p
, 
Ï¡pc
, 
»g
,

432 cÚ¡ **
Çme
) {

433 
pc
;

434 *
Çme
 = 
	`luaF_g‘loÿÊame
(
p
, 
»g
 + 1, 
Ï¡pc
);

435 ià(*
Çme
)

438 
pc
 = 
	`fšd£Œeg
(
p
, 
Ï¡pc
, 
»g
);

439 ià(
pc
 != -1) {

440 
In¡ruùiÚ
 
i
 = 
p
->
¥
->
code
[
pc
];

441 
OpCode
 
İ
 = 
	`GET_OPCODE
(
i
);

442 
İ
) {

443 
OP_MOVE
: {

444 
b
 = 
	`GETARG_B
(
i
);

445 ià(
b
 < 
	`GETARG_A
(
i
))

446  
	`g‘objÇme
(
p
, 
pc
, 
b
, 
Çme
);

449 
OP_GETTABUP
:

450 
OP_GETTABLE
: {

451 
k
 = 
	`GETARG_C
(
i
);

452 
t
 = 
	`GETARG_B
(
i
);

453 cÚ¡ *
vn
 = (
İ
 =ğ
OP_GETTABLE
)

454 ? 
	`luaF_g‘loÿÊame
(
p
, 
t
 + 1, 
pc
)

455 : 
	`upv®Çme
(
p
, 
t
);

456 
	`kÇme
(
p
, 
pc
, 
k
, 
Çme
);

457  (
vn
 && 
	`¡rcmp
(vn, 
LUA_ENV
) == 0) ? "global" : "field";

459 
OP_GETUPVAL
: {

460 *
Çme
 = 
	`upv®Çme
(
p
, 
	`GETARG_B
(
i
));

463 
OP_LOADK
:

464 
OP_LOADKX
: {

465 
b
 = (
İ
 =ğ
OP_LOADK
è? 
	`GETARG_Bx
(
i
)

466 : 
	`GETARG_Ax
(
p
->
¥
->
code
[
pc
 + 1]);

467 ià(
	`‰is¡ršg
(&
p
->
k
[
b
])) {

468 *
Çme
 = 
	`sv®ue
(&
p
->
k
[
b
]);

473 
OP_SELF
: {

474 
k
 = 
	`GETARG_C
(
i
);

475 
	`kÇme
(
p
, 
pc
, 
k
, 
Çme
);

481  
NULL
;

482 
	}
}

491 cÚ¡ *
	$funúameäomcode
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
,

492 cÚ¡ **
Çme
) {

493 
TMS
 
tm
 = (TMS)0;

494 
PrÙo
 *
p
 = 
	`ci_func
(
ci
)->p;

495 
pc
 = 
	`cu¼’c
(
ci
);

496 
In¡ruùiÚ
 
i
 = 
p
->
¥
->
code
[
pc
];

497 ià(
ci
->
ÿÎ¡©us
 & 
CIST_HOOKED
) {

498 *
Çme
 = "?";

501 
	`GET_OPCODE
(
i
)) {

502 
OP_CALL
:

503 
OP_TAILCALL
:

504  
	`g‘objÇme
(
p
, 
pc
, 
	`GETARG_A
(
i
), 
Çme
);

505 
OP_TFORCALL
: {

506 *
Çme
 = "for iterator";

510 
OP_SELF
: 
OP_GETTABUP
: 
OP_GETTABLE
:

511 
tm
 = 
TM_INDEX
;

513 
OP_SETTABUP
: 
OP_SETTABLE
:

514 
tm
 = 
TM_NEWINDEX
;

516 
OP_ADD
: 
OP_SUB
: 
OP_MUL
: 
OP_MOD
:

517 
OP_POW
: 
OP_DIV
: 
OP_IDIV
: 
OP_BAND
:

518 
OP_BOR
: 
OP_BXOR
: 
OP_SHL
: 
OP_SHR
: {

519 
off£t
 = 
	`ÿ¡_št
(
	`GET_OPCODE
(
i
)è- ca¡_št(
OP_ADD
);

520 
tm
 = 
	`ÿ¡
(
TMS
, 
off£t
 + 
	`ÿ¡_št
(
TM_ADD
));

523 
OP_UNM
: 
tm
 = 
TM_UNM
; ;

524 
OP_BNOT
: 
tm
 = 
TM_BNOT
; ;

525 
OP_LEN
: 
tm
 = 
TM_LEN
; ;

526 
OP_CONCAT
: 
tm
 = 
TM_CONCAT
; ;

527 
OP_EQ
: 
tm
 = 
TM_EQ
; ;

528 
OP_LT
: 
tm
 = 
TM_LT
; ;

529 
OP_LE
: 
tm
 = 
TM_LE
; ;

531  
NULL
;

533 *
Çme
 = 
	`g‘¡r
(
	`G
(
L
)->
tmÇme
[
tm
]);

535 
	}
}

546 
	$isš¡ack
 (
C®lInfo
 *
ci
, cÚ¡ 
TV®ue
 *
o
) {

547 
±rdiff_t
 
i
 = 
o
 - 
ci
->
u
.
l
.
ba£
;

548  (0 <ğ
i
 && i < (
ci
->
tİ
 - ci->
u
.
l
.
ba£
è&& ci->u.l.ba£ + i =ğ
o
);

549 
	}
}

557 cÚ¡ *
	$g‘upv®Çme
 (
C®lInfo
 *
ci
, cÚ¡ 
TV®ue
 *
o
,

558 cÚ¡ **
Çme
) {

559 
LClosu»
 *
c
 = 
	`ci_func
(
ci
);

560 
i
;

561 
i
 = 0; i < 
c
->
nupv®ues
; i++) {

562 ià(
c
->
upv®s
[
i
]->
v
 =ğ
o
) {

563 *
Çme
 = 
	`upv®Çme
(
c
->
p
, 
i
);

567  
NULL
;

568 
	}
}

571 cÚ¡ *
	$v¬šfo
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
) {

572 cÚ¡ *
Çme
 = 
NULL
;

573 
C®lInfo
 *
ci
 = 
L
->ci;

574 cÚ¡ *
kšd
 = 
NULL
;

575 ià(
	`isLua
(
ci
)) {

576 
kšd
 = 
	`g‘upv®Çme
(
ci
, 
o
, &
Çme
);

577 ià(!
kšd
 && 
	`isš¡ack
(
ci
, 
o
))

578 
kšd
 = 
	`g‘objÇme
(
	`ci_func
(
ci
)->
p
, 
	`cu¼’c
(ci),

579 
	`ÿ¡_št
(
o
 - 
ci
->
u
.
l
.
ba£
), &
Çme
);

581  (
kšd
è? 
	`luaO_pushf¡ršg
(
L
, " (% '%s')", kšd, 
Çme
) : "";

582 
	}
}

585 
l_nÜ‘
 
	$luaG_ty³”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
, cÚ¡ *
İ
) {

586 cÚ¡ *
t
 = 
	`luaT_objty³Çme
(
L
, 
o
);

587 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Ø% ¨% v®ue%s", 
İ
, 
t
, 
	`v¬šfo
(L, 
o
));

588 
	}
}

591 
l_nÜ‘
 
	$luaG_cÚÿ‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

592 ià(
	`‰is¡ršg
(
p1
è|| 
	`cvt2¡r
Õ1)èp1 = 
p2
;

593 
	`luaG_ty³”rÜ
(
L
, 
p1
, "concatenate");

594 
	}
}

597 
l_nÜ‘
 
	$luaG_İš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

598 cÚ¡ 
TV®ue
 *
p2
, cÚ¡ *
msg
) {

599 
lua_Numb”
 
‹mp
;

600 ià(!
	`tÚumb”
(
p1
, &
‹mp
))

601 
p2
 = 
p1
;

602 
	`luaG_ty³”rÜ
(
L
, 
p2
, 
msg
);

603 
	}
}

609 
l_nÜ‘
 
	$luaG_toš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

610 
lua_IÁeg”
 
‹mp
;

611 ià(!
	`toš‹g”
(
p1
, &
‹mp
))

612 
p2
 = 
p1
;

613 
	`luaG_ruÃ¼Ü
(
L
, "numb”% ha nØš‹g”„•»£Á©iÚ", 
	`v¬šfo
(L, 
p2
));

614 
	}
}

617 
l_nÜ‘
 
	$luaG_Üd””rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
) {

618 cÚ¡ *
t1
 = 
	`luaT_objty³Çme
(
L
, 
p1
);

619 cÚ¡ *
t2
 = 
	`luaT_objty³Çme
(
L
, 
p2
);

620 ià(
	`¡rcmp
(
t1
, 
t2
) == 0)

621 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Øcom·»wØ% v®ues", 
t1
);

623 
	`luaG_ruÃ¼Ü
(
L
, "©‹m±Øcom·» % w™h %s", 
t1
, 
t2
);

624 
	}
}

628 cÚ¡ *
	$luaG_addšfo
 (
lua_S‹
 *
L
, cÚ¡ *
msg
, 
TSŒšg
 *
¤c
,

629 
lše
) {

630 
buff
[
LUA_IDSIZE
];

631 ià(
¤c
)

632 
	`luaO_chunkid
(
buff
, 
	`g‘¡r
(
¤c
), 
LUA_IDSIZE
);

634 
buff
[0] = '?'; buff[1] = '\0';

636  
	`luaO_pushf¡ršg
(
L
, "%s:%d: %s", 
buff
, 
lše
, 
msg
);

637 
	}
}

640 
l_nÜ‘
 
	$luaG_”rÜmsg
 (
lua_S‹
 *
L
) {

641 ià(
L
->
”rfunc
 != 0) {

642 
StkId
 
”rfunc
 = 
	`»¡Üe¡ack
(
L
, L->errfunc);

643 
	`£tobjs2s
(
L
, L->
tİ
, L->top - 1);

644 
	`£tobjs2s
(
L
, L->
tİ
 - 1, 
”rfunc
);

645 
L
->
tİ
++;

646 
	`luaD_ÿÎnoy›ld
(
L
, L->
tİ
 - 2, 1);

648 
	`luaD_throw
(
L
, 
LUA_ERRRUN
);

649 
	}
}

652 
l_nÜ‘
 
	$luaG_ruÃ¼Ü
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

653 
C®lInfo
 *
ci
 = 
L
->ci;

654 cÚ¡ *
msg
;

655 
va_li¡
 
¬gp
;

656 
	`va_¡¬t
(
¬gp
, 
fmt
);

657 
msg
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

658 
	`va_’d
(
¬gp
);

659 ià(
	`isLua
(
ci
))

660 
	`luaG_addšfo
(
L
, 
msg
, 
	`ci_func
(
ci
)->
p
->
¥
->
sourû
, 
	`cu¼’še
(ci));

661 
	`luaG_”rÜmsg
(
L
);

662 
	}
}

665 
	$luaG_Œaûexec
 (
lua_S‹
 *
L
) {

666 
C®lInfo
 *
ci
 = 
L
->ci;

667 
lu_by‹
 
mask
 = 
L
->
hookmask
;

668 
couÁhook
 = (--
L
->
hookcouÁ
 =ğ0 && (
mask
 & 
LUA_MASKCOUNT
));

669 ià(
couÁhook
)

670 
	`»£thookcouÁ
(
L
);

671 ià(!(
mask
 & 
LUA_MASKLINE
))

673 ià(
ci
->
ÿÎ¡©us
 & 
CIST_HOOKYIELD
) {

674 
ci
->
ÿÎ¡©us
 &ğ~
CIST_HOOKYIELD
;

677 ià(
couÁhook
)

678 
	`luaD_hook
(
L
, 
LUA_HOOKCOUNT
, -1);

679 ià(
mask
 & 
LUA_MASKLINE
) {

680 
PrÙo
 *
p
 = 
	`ci_func
(
ci
)->p;

681 
Åc
 = 
	`pcR–
(
ci
->
u
.
l
.
§vedpc
, 
p
);

682 
Ãwlše
 = 
	`g‘funşše
(
p
, 
Åc
);

683 ià(
Åc
 == 0 ||

684 
ci
->
u
.
l
.
§vedpc
 <ğ
L
->
Şdpc
 ||

685 
Ãwlše
 !ğ
	`g‘funşše
(
p
, 
	`pcR–
(
L
->
Şdpc
,…)))

686 
	`luaD_hook
(
L
, 
LUA_HOOKLINE
, 
Ãwlše
);

688 
L
->
Şdpc
 = 
ci
->
u
.
l
.
§vedpc
;

689 ià(
L
->
¡©us
 =ğ
LUA_YIELD
) {

690 ià(
couÁhook
)

691 
L
->
hookcouÁ
 = 1;

692 
ci
->
u
.
l
.
§vedpc
--;

693 
ci
->
ÿÎ¡©us
 |ğ
CIST_HOOKYIELD
;

694 
ci
->
func
 = 
L
->
tİ
 - 1;

695 
	`luaD_throw
(
L
, 
LUA_YIELD
);

697 
	}
}

	@3rd/lua/ldebug.h

7 #iâdeà
ldebug_h


8 
	#ldebug_h


	)

11 
	~"l¡©e.h
"

14 
	#pcR–
(
pc
, 
p
è(
	`ÿ¡
(, (pcè- (p)->
¥
->
code
è- 1)

	)

16 
	#g‘funşše
(
f
,
pc
è(((f)->
¥
->
lšešfo
è? (f)->¥->lšešfo[pc] : -1)

	)

18 
	#»£thookcouÁ
(
L
è(L->
hookcouÁ
 = L->
ba£hookcouÁ
)

	)

21 
LUAI_FUNC
 
l_nÜ‘
 
luaG_ty³”rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
,

22 cÚ¡ *
İÇme
);

23 
LUAI_FUNC
 
l_nÜ‘
 
luaG_cÚÿ‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

24 cÚ¡ 
TV®ue
 *
p2
);

25 
LUAI_FUNC
 
l_nÜ‘
 
luaG_İš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

26 cÚ¡ 
TV®ue
 *
p2
,

27 cÚ¡ *
msg
);

28 
LUAI_FUNC
 
l_nÜ‘
 
luaG_toš‹¼Ü
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

29 cÚ¡ 
TV®ue
 *
p2
);

30 
LUAI_FUNC
 
l_nÜ‘
 
luaG_Üd””rÜ
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

31 cÚ¡ 
TV®ue
 *
p2
);

32 
LUAI_FUNC
 
l_nÜ‘
 
luaG_ruÃ¼Ü
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

33 
LUAI_FUNC
 cÚ¡ *
luaG_addšfo
 (
lua_S‹
 *
L
, cÚ¡ *
msg
,

34 
TSŒšg
 *
¤c
, 
lše
);

35 
LUAI_FUNC
 
l_nÜ‘
 
luaG_”rÜmsg
 (
lua_S‹
 *
L
);

36 
LUAI_FUNC
 
luaG_Œaûexec
 (
lua_S‹
 *
L
);

	@3rd/lua/ldo.c

7 
	#ldo_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<£tjmp.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïpi.h
"

20 
	~"ldebug.h
"

21 
	~"ldo.h
"

22 
	~"lfunc.h
"

23 
	~"lgc.h
"

24 
	~"lmem.h
"

25 
	~"lobjeù.h
"

26 
	~"lİcodes.h
"

27 
	~"Í¬£r.h
"

28 
	~"l¡©e.h
"

29 
	~"l¡ršg.h
"

30 
	~"ÉabË.h
"

31 
	~"Ém.h
"

32 
	~"lundump.h
"

33 
	~"lvm.h
"

34 
	~"lzio.h
"

38 
	#”rÜ¡©us
(
s
è((sè> 
LUA_YIELD
)

	)

53 #ià!
defšed
(
LUAI_THROW
)

55 #ià
defšed
(
__ılu¥lus
è&& !defšed(
LUA_USE_LONGJMP
)

58 
	#LUAI_THROW
(
L
,
c
è
	`throw
(c)

	)

59 
	#LUAI_TRY
(
L
,
c
,
a
) \

60 
Œy
 { 
a
 } 
	`ÿtch
(...è{ ià((
c
)->
¡©us
 =ğ0è(c)->¡©u ğ-1; }

	)

61 
	#luai_jmpbuf
 

	)

63 #–ià
defšed
(
LUA_USE_POSIX
)

66 
	#LUAI_THROW
(
L
,
c
è
	`_lÚgjmp
((c)->
b
, 1)

	)

67 
	#LUAI_TRY
(
L
,
c
,
a
èià(
	`_£tjmp
((c)->
b
è=ğ0è{‡ }

	)

68 
	#luai_jmpbuf
 
jmp_buf


	)

73 
	#LUAI_THROW
(
L
,
c
è
	`lÚgjmp
((c)->
b
, 1)

	)

74 
	#LUAI_TRY
(
L
,
c
,
a
èià(
	`£tjmp
((c)->
b
è=ğ0è{‡ }

	)

75 
	#luai_jmpbuf
 
jmp_buf


	)

84 
	slua_lÚgjmp
 {

85 
lua_lÚgjmp
 *
	m´evious
;

86 
luai_jmpbuf
 
	mb
;

87 vŞ©
	m¡©us
;

91 
	$£‹¼Üobj
 (
lua_S‹
 *
L
, 
”rcode
, 
StkId
 
Şdtİ
) {

92 
”rcode
) {

93 
LUA_ERRMEM
: {

94 
	`£tsv®ue2s
(
L
, 
Şdtİ
, 
	`G
(L)->
mem”rmsg
);

97 
LUA_ERRERR
: {

98 
	`£tsv®ue2s
(
L
, 
Şdtİ
, 
	`luaS_Ãwl™”®
(L, "error inƒrror handling"));

102 
	`£tobjs2s
(
L
, 
Şdtİ
, L->
tİ
 - 1);

106 
L
->
tİ
 = 
Şdtİ
 + 1;

107 
	}
}

110 
l_nÜ‘
 
	$luaD_throw
 (
lua_S‹
 *
L
, 
”rcode
) {

111 ià(
L
->
”rÜJmp
) {

112 
L
->
”rÜJmp
->
¡©us
 = 
”rcode
;

113 
	`LUAI_THROW
(
L
, L->
”rÜJmp
);

116 
glob®_S‹
 *
g
 = 
	`G
(
L
);

117 
L
->
¡©us
 = 
	`ÿ¡_by‹
(
”rcode
);

118 ià(
g
->
mašth»ad
->
”rÜJmp
) {

119 
	`£tobjs2s
(
L
, 
g
->
mašth»ad
->
tİ
++, L->top - 1);

120 
	`luaD_throw
(
g
->
mašth»ad
, 
”rcode
);

123 ià(
g
->
·nic
) {

124 
	`£‹¼Üobj
(
L
, 
”rcode
, L->
tİ
);

125 ià(
L
->
ci
->
tİ
 < L->top)

126 
L
->
ci
->
tİ
 = L->top;

127 
	`lua_uÆock
(
L
);

128 
g
->
	`·nic
(
L
);

130 
	`abÜt
();

133 
	}
}

136 
	$luaD_¿wruÅrÙeùed
 (
lua_S‹
 *
L
, 
Pfunc
 
f
, *
ud
) {

137 
ŞdnCÿÎs
 = 
L
->
nCÿÎs
;

138 
lua_lÚgjmp
 
lj
;

139 
lj
.
¡©us
 = 
LUA_OK
;

140 
lj
.
´evious
 = 
L
->
”rÜJmp
;

141 
L
->
”rÜJmp
 = &
lj
;

142 
	`LUAI_TRY
(
L
, &
lj
,

143 (*
f
)(
L
, 
ud
);

145 
L
->
”rÜJmp
 = 
lj
.
´evious
;

146 
L
->
nCÿÎs
 = 
ŞdnCÿÎs
;

147  
lj
.
¡©us
;

148 
	}
}

158 
	$cÜ»ù¡ack
 (
lua_S‹
 *
L
, 
TV®ue
 *
Şd¡ack
) {

159 
C®lInfo
 *
ci
;

160 
UpV®
 *
up
;

161 
L
->
tİ
 = (L->tİ - 
Şd¡ack
è+ L->
¡ack
;

162 
up
 = 
L
->
İ’upv®
; u°!ğ
NULL
; u°ğup->
u
.
İ’
.
Ãxt
)

163 
up
->
v
 = (up->v - 
Şd¡ack
è+ 
L
->
¡ack
;

164 
ci
 = 
L
->ci; c˜!ğ
NULL
; c˜ğci->
´evious
) {

165 
ci
->
tİ
 = (ci->tİ - 
Şd¡ack
è+ 
L
->
¡ack
;

166 
ci
->
func
 = (ci->funø- 
Şd¡ack
è+ 
L
->
¡ack
;

167 ià(
	`isLua
(
ci
))

168 
ci
->
u
.
l
.
ba£
 = (ci->u.l.ba£ - 
Şd¡ack
è+ 
L
->
¡ack
;

170 
	}
}

174 
	#ERRORSTACKSIZE
 (
LUAI_MAXSTACK
 + 200)

	)

177 
	$luaD_»®loc¡ack
 (
lua_S‹
 *
L
, 
Ãwsize
) {

178 
TV®ue
 *
Şd¡ack
 = 
L
->
¡ack
;

179 
lim
 = 
L
->
¡acksize
;

180 
	`lua_as£¹
(
Ãwsize
 <ğ
LUAI_MAXSTACK
 ||‚ewsiz=ğ
ERRORSTACKSIZE
);

181 
	`lua_as£¹
(
L
->
¡ack_Ï¡
 - L->
¡ack
 =ğL->
¡acksize
 - 
EXTRA_STACK
);

182 
	`luaM_»®locveùÜ
(
L
, L->
¡ack
, L->
¡acksize
, 
Ãwsize
, 
TV®ue
);

183 ; 
lim
 < 
Ãwsize
;†im++)

184 
	`£Šv®ue
(
L
->
¡ack
 + 
lim
);

185 
L
->
¡acksize
 = 
Ãwsize
;

186 
L
->
¡ack_Ï¡
 = L->
¡ack
 + 
Ãwsize
 - 
EXTRA_STACK
;

187 
	`cÜ»ù¡ack
(
L
, 
Şd¡ack
);

188 
	}
}

191 
	$luaD_grow¡ack
 (
lua_S‹
 *
L
, 
n
) {

192 
size
 = 
L
->
¡acksize
;

193 ià(
size
 > 
LUAI_MAXSTACK
)

194 
	`luaD_throw
(
L
, 
LUA_ERRERR
);

196 
Ãeded
 = 
	`ÿ¡_št
(
L
->
tİ
 - L->
¡ack
è+ 
n
 + 
EXTRA_STACK
;

197 
Ãwsize
 = 2 * 
size
;

198 ià(
Ãwsize
 > 
LUAI_MAXSTACK
)‚ewsize = LUAI_MAXSTACK;

199 ià(
Ãwsize
 < 
Ãeded
)‚ewsize =‚eeded;

200 ià(
Ãwsize
 > 
LUAI_MAXSTACK
) {

201 
	`luaD_»®loc¡ack
(
L
, 
ERRORSTACKSIZE
);

202 
	`luaG_ruÃ¼Ü
(
L
, "stack overflow");

205 
	`luaD_»®loc¡ack
(
L
, 
Ãwsize
);

207 
	}
}

210 
	$¡ackšu£
 (
lua_S‹
 *
L
) {

211 
C®lInfo
 *
ci
;

212 
StkId
 
lim
 = 
L
->
tİ
;

213 
ci
 = 
L
->ci; c˜!ğ
NULL
; c˜ğci->
´evious
) {

214 ià(
lim
 < 
ci
->
tİ
)†im = ci->top;

216 
	`lua_as£¹
(
lim
 <ğ
L
->
¡ack_Ï¡
);

217  
	`ÿ¡_št
(
lim
 - 
L
->
¡ack
) + 1;

218 
	}
}

221 
	$luaD_shršk¡ack
 (
lua_S‹
 *
L
) {

222 
šu£
 = 
	`¡ackšu£
(
L
);

223 
goodsize
 = 
šu£
 + (šu£ / 8è+ 2*
EXTRA_STACK
;

224 ià(
goodsize
 > 
LUAI_MAXSTACK
)

225 
goodsize
 = 
LUAI_MAXSTACK
;

226 ià(
L
->
¡acksize
 > 
LUAI_MAXSTACK
)

227 
	`luaE_ä“CI
(
L
);

229 
	`luaE_shrškCI
(
L
);

232 ià(
šu£
 <ğ(
LUAI_MAXSTACK
 - 
EXTRA_STACK
) &&

233 
goodsize
 < 
L
->
¡acksize
)

234 
	`luaD_»®loc¡ack
(
L
, 
goodsize
);

236 
	`cÚdmove¡ack
(
L
,{},{});

237 
	}
}

240 
	$luaD_šùİ
 (
lua_S‹
 *
L
) {

241 
	`luaD_check¡ack
(
L
, 1);

242 
L
->
tİ
++;

243 
	}
}

253 
	$luaD_hook
 (
lua_S‹
 *
L
, 
ev’t
, 
lše
) {

254 
lua_Hook
 
hook
 = 
L
->hook;

255 ià(
hook
 && 
L
->
®lowhook
) {

256 
C®lInfo
 *
ci
 = 
L
->ci;

257 
±rdiff_t
 
tİ
 = 
	`§ve¡ack
(
L
, L->top);

258 
±rdiff_t
 
ci_tİ
 = 
	`§ve¡ack
(
L
, 
ci
->
tİ
);

259 
lua_Debug
 
¬
;

260 
¬
.
ev’t
 =ƒvent;

261 
¬
.
cu¼’še
 = 
lše
;

262 
¬
.
i_ci
 = 
ci
;

263 
	`luaD_check¡ack
(
L
, 
LUA_MINSTACK
);

264 
ci
->
tİ
 = 
L
->tİ + 
LUA_MINSTACK
;

265 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

266 
L
->
®lowhook
 = 0;

267 
ci
->
ÿÎ¡©us
 |ğ
CIST_HOOKED
;

268 
	`lua_uÆock
(
L
);

269 (*
hook
)(
L
, &
¬
);

270 
	`lua_lock
(
L
);

271 
	`lua_as£¹
(!
L
->
®lowhook
);

272 
L
->
®lowhook
 = 1;

273 
ci
->
tİ
 = 
	`»¡Üe¡ack
(
L
, 
ci_tİ
);

274 
L
->
tİ
 = 
	`»¡Üe¡ack
(L,op);

275 
ci
->
ÿÎ¡©us
 &ğ~
CIST_HOOKED
;

277 
	}
}

280 
	$ÿÎhook
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
) {

281 
hook
 = 
LUA_HOOKCALL
;

282 
ci
->
u
.
l
.
§vedpc
++;

283 ià(
	`isLua
(
ci
->
´evious
) &&

284 
	`GET_OPCODE
(*(
ci
->
´evious
->
u
.
l
.
§vedpc
 - 1)è=ğ
OP_TAILCALL
) {

285 
ci
->
ÿÎ¡©us
 |ğ
CIST_TAIL
;

286 
hook
 = 
LUA_HOOKTAILCALL
;

288 
	`luaD_hook
(
L
, 
hook
, -1);

289 
ci
->
u
.
l
.
§vedpc
--;

290 
	}
}

293 
StkId
 
	$adju¡_v¬¬gs
 (
lua_S‹
 *
L
, 
Sh¬edPrÙo
 *
p
, 
aùu®
) {

294 
i
;

295 
nfix¬gs
 = 
p
->
num·¿ms
;

296 
StkId
 
ba£
, 
fixed
;

298 
fixed
 = 
L
->
tİ
 - 
aùu®
;

299 
ba£
 = 
L
->
tİ
;

300 
i
 = 0; i < 
nfix¬gs
 && i < 
aùu®
; i++) {

301 
	`£tobjs2s
(
L
, L->
tİ
++, 
fixed
 + 
i
);

302 
	`£Šv®ue
(
fixed
 + 
i
);

304 ; 
i
 < 
nfix¬gs
; i++)

305 
	`£Šv®ue
(
L
->
tİ
++);

306  
ba£
;

307 
	}
}

315 
	$ŒyfuncTM
 (
lua_S‹
 *
L
, 
StkId
 
func
) {

316 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
func
, 
TM_CALL
);

317 
StkId
 
p
;

318 ià(!
	`‰isfunùiÚ
(
tm
))

319 
	`luaG_ty³”rÜ
(
L
, 
func
, "call");

321 
p
 = 
L
->
tİ
;… > 
func
;…--)

322 
	`£tobjs2s
(
L
, 
p
,…-1);

323 
L
->
tİ
++;

324 
	`£tobj2s
(
L
, 
func
, 
tm
);

325 
	}
}

334 
	$mov”esuÉs
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
fœ¡ResuÉ
, 
StkId
 
»s
,

335 
Äes
, 
wª‹d
) {

336 
wª‹d
) {

339 ià(
Äes
 == 0)

340 
fœ¡ResuÉ
 = 
luaO_nobjeù
;

341 
	`£tobjs2s
(
L
, 
»s
, 
fœ¡ResuÉ
);

344 
LUA_MULTRET
: {

345 
i
;

346 
i
 = 0; i < 
Äes
; i++)

347 
	`£tobjs2s
(
L
, 
»s
 + 
i
, 
fœ¡ResuÉ
 + i);

348 
L
->
tİ
 = 
»s
 + 
Äes
;

352 
i
;

353 ià(
wª‹d
 <ğ
Äes
) {

354 
i
 = 0; i < 
wª‹d
; i++)

355 
	`£tobjs2s
(
L
, 
»s
 + 
i
, 
fœ¡ResuÉ
 + i);

358 
i
 = 0; i < 
Äes
; i++)

359 
	`£tobjs2s
(
L
, 
»s
 + 
i
, 
fœ¡ResuÉ
 + i);

360 ; 
i
 < 
wª‹d
; i++)

361 
	`£Šv®ue
(
»s
 + 
i
);

366 
L
->
tİ
 = 
»s
 + 
wª‹d
;

368 
	}
}

376 
	$luaD_posÿÎ
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
StkId
 
fœ¡ResuÉ
, 
Äes
) {

377 
StkId
 
»s
;

378 
wª‹d
 = 
ci
->
ÄesuÉs
;

379 ià(
L
->
hookmask
 & (
LUA_MASKRET
 | 
LUA_MASKLINE
)) {

380 ià(
L
->
hookmask
 & 
LUA_MASKRET
) {

381 
±rdiff_t
 
ä
 = 
	`§ve¡ack
(
L
, 
fœ¡ResuÉ
);

382 
	`luaD_hook
(
L
, 
LUA_HOOKRET
, -1);

383 
fœ¡ResuÉ
 = 
	`»¡Üe¡ack
(
L
, 
ä
);

385 
L
->
Şdpc
 = 
ci
->
´evious
->
u
.
l
.
§vedpc
;

387 
»s
 = 
ci
->
func
;

388 
L
->
ci
 = ci->
´evious
;

390  
	`mov”esuÉs
(
L
, 
fœ¡ResuÉ
, 
»s
, 
Äes
, 
wª‹d
);

391 
	}
}

395 
	#Ãxt_ci
(
L
è(L->
ci
 = (L->ci->
Ãxt
 ? L->ci->Ãxˆ: 
	`luaE_ex‹ndCI
(L)))

	)

399 
	#check¡ackp
(
L
,
n
,
p
) \

400 
	`luaD_check¡ackaux
(
L
, 
n
, \

401 
±rdiff_t
 
t__
 = 
	`§ve¡ack
(
L
, 
p
); \

402 
	`luaC_checkGC
(
L
), \

403 
p
 = 
	`»¡Üe¡ack
(
L
, 
t__
)è

	)

413 
	$luaD_´eÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
ÄesuÉs
) {

414 
lua_CFunùiÚ
 
f
;

415 
C®lInfo
 *
ci
;

416 
	`‰y³
(
func
)) {

417 
LUA_TCCL
:

418 
f
 = 
	`şCv®ue
(
func
)->f;

419 
Cfunc
;

420 
LUA_TLCF
:

421 
f
 = 
	`fv®ue
(
func
);

422 
Cfunc
: {

423 
n
;

424 
	`check¡ackp
(
L
, 
LUA_MINSTACK
, 
func
);

425 
ci
 = 
	`Ãxt_ci
(
L
);

426 
ci
->
ÄesuÉs
 =‚results;

427 
ci
->
func
 = func;

428 
ci
->
tİ
 = 
L
->tİ + 
LUA_MINSTACK
;

429 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

430 
ci
->
ÿÎ¡©us
 = 0;

431 ià(
L
->
hookmask
 & 
LUA_MASKCALL
)

432 
	`luaD_hook
(
L
, 
LUA_HOOKCALL
, -1);

433 
	`lua_uÆock
(
L
);

434 
n
 = (*
f
)(
L
);

435 
	`lua_lock
(
L
);

436 
	`­i_checkÃËms
(
L
, 
n
);

437 
	`luaD_posÿÎ
(
L
, 
ci
, L->
tİ
 - 
n
,‚);

440 
LUA_TLCL
: {

441 
StkId
 
ba£
;

442 
Sh¬edPrÙo
 *
p
 = 
	`şLv®ue
(
func
)->p->
¥
;

443 
n
 = 
	`ÿ¡_št
(
L
->
tİ
 - 
func
) - 1;

444 
fsize
 = 
p
->
max¡acksize
;

445 
	`check¡ackp
(
L
, 
fsize
, 
func
);

446 ià(
p
->
is_v¬¬g
)

447 
ba£
 = 
	`adju¡_v¬¬gs
(
L
, 
p
, 
n
);

449 ; 
n
 < 
p
->
num·¿ms
;‚++)

450 
	`£Šv®ue
(
L
->
tİ
++);

451 
ba£
 = 
func
 + 1;

453 
ci
 = 
	`Ãxt_ci
(
L
);

454 
ci
->
ÄesuÉs
 =‚results;

455 
ci
->
func
 = func;

456 
ci
->
u
.
l
.
ba£
 = base;

457 
L
->
tİ
 = 
ci
->tİ = 
ba£
 + 
fsize
;

458 
	`lua_as£¹
(
ci
->
tİ
 <ğ
L
->
¡ack_Ï¡
);

459 
ci
->
u
.
l
.
§vedpc
 = 
p
->
code
;

460 
ci
->
ÿÎ¡©us
 = 
CIST_LUA
;

461 ià(
L
->
hookmask
 & 
LUA_MASKCALL
)

462 
	`ÿÎhook
(
L
, 
ci
);

466 
	`check¡ackp
(
L
, 1, 
func
);

467 
	`ŒyfuncTM
(
L
, 
func
);

468  
	`luaD_´eÿÎ
(
L
, 
func
, 
ÄesuÉs
);

471 
	}
}

481 
	$¡ack”rÜ
 (
lua_S‹
 *
L
) {

482 ià(
L
->
nCÿÎs
 =ğ
LUAI_MAXCCALLS
)

483 
	`luaG_ruÃ¼Ü
(
L
, "C stack overflow");

484 ià(
L
->
nCÿÎs
 >ğ(
LUAI_MAXCCALLS
 + (LUAI_MAXCCALLS>>3)))

485 
	`luaD_throw
(
L
, 
LUA_ERRERR
);

486 
	}
}

495 
	$luaD_ÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
) {

496 ià(++
L
->
nCÿÎs
 >ğ
LUAI_MAXCCALLS
)

497 
	`¡ack”rÜ
(
L
);

498 ià(!
	`luaD_´eÿÎ
(
L
, 
func
, 
nResuÉs
))

499 
	`luaV_execu‹
(
L
);

500 
L
->
nCÿÎs
--;

501 
	}
}

507 
	$luaD_ÿÎnoy›ld
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
) {

508 
L
->
Ây
++;

509 
	`luaD_ÿÎ
(
L
, 
func
, 
nResuÉs
);

510 
L
->
Ây
--;

511 
	}
}

518 
	$fšishCÿÎ
 (
lua_S‹
 *
L
, 
¡©us
) {

519 
C®lInfo
 *
ci
 = 
L
->ci;

520 
n
;

522 
	`lua_as£¹
(
ci
->
u
.
c
.
k
 !ğ
NULL
 && 
L
->
Ây
 == 0);

524 
	`lua_as£¹
((
ci
->
ÿÎ¡©us
 & 
CIST_YPCALL
è|| 
¡©us
 =ğ
LUA_YIELD
);

525 ià(
ci
->
ÿÎ¡©us
 & 
CIST_YPCALL
) {

526 
ci
->
ÿÎ¡©us
 &ğ~
CIST_YPCALL
;

527 
L
->
”rfunc
 = 
ci
->
u
.
c
.
Şd_”rfunc
;

531 
	`adju¡»suÉs
(
L
, 
ci
->
ÄesuÉs
);

532 
	`lua_uÆock
(
L
);

533 
n
 = (*
ci
->
u
.
c
.
k
)(
L
, 
¡©us
, ci->u.c.
ùx
);

534 
	`lua_lock
(
L
);

535 
	`­i_checkÃËms
(
L
, 
n
);

536 
	`luaD_posÿÎ
(
L
, 
ci
, L->
tİ
 - 
n
,‚);

537 
	}
}

548 
	$uÄŞl
 (
lua_S‹
 *
L
, *
ud
) {

549 ià(
ud
 !ğ
NULL
)

550 
	`fšishCÿÎ
(
L
, *(*)
ud
);

551 
L
->
ci
 !ğ&L->
ba£_ci
) {

552 ià(!
	`isLua
(
L
->
ci
))

553 
	`fšishCÿÎ
(
L
, 
LUA_YIELD
);

555 
	`luaV_fšishOp
(
L
);

556 
	`luaV_execu‹
(
L
);

559 
	}
}

566 
C®lInfo
 *
	$fšdpÿÎ
 (
lua_S‹
 *
L
) {

567 
C®lInfo
 *
ci
;

568 
ci
 = 
L
->ci; c˜!ğ
NULL
; c˜ğci->
´evious
) {

569 ià(
ci
->
ÿÎ¡©us
 & 
CIST_YPCALL
)

570  
ci
;

572  
NULL
;

573 
	}
}

581 
	$»cov”
 (
lua_S‹
 *
L
, 
¡©us
) {

582 
StkId
 
Şdtİ
;

583 
C®lInfo
 *
ci
 = 
	`fšdpÿÎ
(
L
);

584 ià(
ci
 =ğ
NULL
)  0;

586 
Şdtİ
 = 
	`»¡Üe¡ack
(
L
, 
ci
->
exŒa
);

587 
	`luaF_şo£
(
L
, 
Şdtİ
);

588 
	`£‹¼Üobj
(
L
, 
¡©us
, 
Şdtİ
);

589 
L
->
ci
 = ci;

590 
L
->
®lowhook
 = 
	`g‘ßh
(
ci
->
ÿÎ¡©us
);

591 
L
->
Ây
 = 0;

592 
	`luaD_shršk¡ack
(
L
);

593 
L
->
”rfunc
 = 
ci
->
u
.
c
.
Şd_”rfunc
;

595 
	}
}

603 
	$»sume_”rÜ
 (
lua_S‹
 *
L
, cÚ¡ *
msg
, 
Çrg
) {

604 
L
->
tİ
 -ğ
Çrg
;

605 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãw
(L, 
msg
));

606 
	`­i_šü_tİ
(
L
);

607 
	`lua_uÆock
(
L
);

608  
LUA_ERRRUN
;

609 
	}
}

619 
	$»sume
 (
lua_S‹
 *
L
, *
ud
) {

620 
n
 = *(
	`ÿ¡
(*, 
ud
));

621 
StkId
 
fœ¡Arg
 = 
L
->
tİ
 - 
n
;

622 
C®lInfo
 *
ci
 = 
L
->ci;

623 ià(
L
->
¡©us
 =ğ
LUA_OK
) {

624 ià(!
	`luaD_´eÿÎ
(
L
, 
fœ¡Arg
 - 1, 
LUA_MULTRET
))

625 
	`luaV_execu‹
(
L
);

628 
	`lua_as£¹
(
L
->
¡©us
 =ğ
LUA_YIELD
);

629 
L
->
¡©us
 = 
LUA_OK
;

630 
ci
->
func
 = 
	`»¡Üe¡ack
(
L
, ci->
exŒa
);

631 ià(
	`isLua
(
ci
))

632 
	`luaV_execu‹
(
L
);

634 ià(
ci
->
u
.
c
.
k
 !ğ
NULL
) {

635 
	`lua_uÆock
(
L
);

636 
n
 = (*
ci
->
u
.
c
.
k
)(
L
, 
LUA_YIELD
, ci->u.c.
ùx
);

637 
	`lua_lock
(
L
);

638 
	`­i_checkÃËms
(
L
, 
n
);

639 
fœ¡Arg
 = 
L
->
tİ
 - 
n
;

641 
	`luaD_posÿÎ
(
L
, 
ci
, 
fœ¡Arg
, 
n
);

643 
	`uÄŞl
(
L
, 
NULL
);

645 
	}
}

648 
LUA_API
 
	$lua_»sume
 (
lua_S‹
 *
L
,†ua_S‹ *
äom
, 
Çrgs
) {

649 
¡©us
;

650 
ŞdÂy
 = 
L
->
Ây
;

651 
	`lua_lock
(
L
);

652 ià(
L
->
¡©us
 =ğ
LUA_OK
) {

653 ià(
L
->
ci
 !ğ&L->
ba£_ci
)

654  
	`»sume_”rÜ
(
L
, "ÿÂÙ„esumnÚ-su¥’ded cÜoutše", 
Çrgs
);

656 ià(
L
->
¡©us
 !ğ
LUA_YIELD
)

657  
	`»sume_”rÜ
(
L
, "ÿÂÙ„esumd—d cÜoutše", 
Çrgs
);

658 
L
->
nCÿÎs
 = (
äom
) ? from->nCcalls + 1 : 1;

659 ià(
L
->
nCÿÎs
 >ğ
LUAI_MAXCCALLS
)

660  
	`»sume_”rÜ
(
L
, "C sck ov”æow", 
Çrgs
);

661 
	`luai_u£r¡©”esume
(
L
, 
Çrgs
);

662 
L
->
Ây
 = 0;

663 
	`­i_checkÃËms
(
L
, (L->
¡©us
 =ğ
LUA_OK
è? 
Çrgs
 + 1 :‚args);

664 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
»sume
, &
Çrgs
);

665 ià(
¡©us
 == -1)

666 
¡©us
 = 
LUA_ERRRUN
;

668 
	`”rÜ¡©us
(
¡©us
è&& 
	`»cov”
(
L
, status)) {

670 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
uÄŞl
, &status);

672 ià(
	`”rÜ¡©us
(
¡©us
)) {

673 
L
->
¡©us
 = 
	`ÿ¡_by‹
(status);

674 
	`£‹¼Üobj
(
L
, 
¡©us
, L->
tİ
);

675 
L
->
ci
->
tİ
 = L->top;

677 
	`lua_as£¹
(
¡©us
 =ğ
L
->status);

679 
L
->
Ây
 = 
ŞdÂy
;

680 
L
->
nCÿÎs
--;

681 
	`lua_as£¹
(
L
->
nCÿÎs
 =ğ((
äom
) ? from->nCcalls : 0));

682 
	`lua_uÆock
(
L
);

683  
¡©us
;

684 
	}
}

687 
LUA_API
 
	$lua_isy›ldabË
 (
lua_S‹
 *
L
) {

688  (
L
->
Ây
 == 0);

689 
	}
}

692 
LUA_API
 
	$lua_y›ldk
 (
lua_S‹
 *
L
, 
ÄesuÉs
, 
lua_KCÚ‹xt
 
ùx
,

693 
lua_KFunùiÚ
 
k
) {

694 
C®lInfo
 *
ci
 = 
L
->ci;

695 
	`luai_u£r¡©ey›ld
(
L
, 
ÄesuÉs
);

696 
	`lua_lock
(
L
);

697 
	`­i_checkÃËms
(
L
, 
ÄesuÉs
);

698 ià(
L
->
Ây
 > 0) {

699 ià(
L
 !ğ
	`G
(L)->
mašth»ad
)

700 
	`luaG_ruÃ¼Ü
(
L
, "attempto yield‡cross‡ C-call boundary");

702 
	`luaG_ruÃ¼Ü
(
L
, "attempto yield from outside‡ coroutine");

704 
L
->
¡©us
 = 
LUA_YIELD
;

705 
ci
->
exŒa
 = 
	`§ve¡ack
(
L
, ci->
func
);

706 ià(
	`isLua
(
ci
)) {

707 
	`­i_check
(
L
, 
k
 =ğ
NULL
, "hooks cannot continue‡fter yielding");

710 ià((
ci
->
u
.
c
.
k
 = kè!ğ
NULL
)

711 
ci
->
u
.
c
.
ùx
 = ctx;

712 
ci
->
func
 = 
L
->
tİ
 - 
ÄesuÉs
 - 1;

713 
	`luaD_throw
(
L
, 
LUA_YIELD
);

715 
	`lua_as£¹
(
ci
->
ÿÎ¡©us
 & 
CIST_HOOKED
);

716 
	`lua_uÆock
(
L
);

718 
	}
}

721 
	$luaD_pÿÎ
 (
lua_S‹
 *
L
, 
Pfunc
 
func
, *
u
,

722 
±rdiff_t
 
Şd_tİ
,…Œdiff_ˆ
ef
) {

723 
¡©us
;

724 
C®lInfo
 *
Şd_ci
 = 
L
->
ci
;

725 
lu_by‹
 
Şd_®lowhooks
 = 
L
->
®lowhook
;

726 
Şd_Ây
 = 
L
->
Ây
;

727 
±rdiff_t
 
Şd_”rfunc
 = 
L
->
”rfunc
;

728 
L
->
”rfunc
 = 
ef
;

729 
¡©us
 = 
	`luaD_¿wruÅrÙeùed
(
L
, 
func
, 
u
);

730 ià(
¡©us
 !ğ
LUA_OK
) {

731 
StkId
 
Şdtİ
 = 
	`»¡Üe¡ack
(
L
, 
Şd_tİ
);

732 
	`luaF_şo£
(
L
, 
Şdtİ
);

733 
	`£‹¼Üobj
(
L
, 
¡©us
, 
Şdtİ
);

734 
L
->
ci
 = 
Şd_ci
;

735 
L
->
®lowhook
 = 
Şd_®lowhooks
;

736 
L
->
Ây
 = 
Şd_Ây
;

737 
	`luaD_shršk¡ack
(
L
);

739 
L
->
”rfunc
 = 
Şd_”rfunc
;

740  
¡©us
;

741 
	}
}

748 
	sSP¬£r
 {

749 
ZIO
 *
	mz
;

750 
Mbufãr
 
	mbuff
;

751 
Dynd©a
 
	mdyd
;

752 cÚ¡ *
	mmode
;

753 cÚ¡ *
	mÇme
;

757 
	$checkmode
 (
lua_S‹
 *
L
, cÚ¡ *
mode
, cÚ¡ *
x
) {

758 ià(
mode
 && 
	`¡rchr
(mode, 
x
[0]è=ğ
NULL
) {

759 
	`luaO_pushf¡ršg
(
L
,

760 "©‹m±Ølßd‡ % chunk (modi '%s')", 
x
, 
mode
);

761 
	`luaD_throw
(
L
, 
LUA_ERRSYNTAX
);

763 
	}
}

766 
	$f_·r£r
 (
lua_S‹
 *
L
, *
ud
) {

767 
LClosu»
 *
ş
;

768 
SP¬£r
 *
p
 = 
	`ÿ¡
(SP¬£¸*, 
ud
);

769 
c
 = 
	`zg‘c
(
p
->
z
);

770 ià(
c
 =ğ
LUA_SIGNATURE
[0]) {

771 
	`checkmode
(
L
, 
p
->
mode
, "binary");

772 
ş
 = 
	`luaU_undump
(
L
, 
p
->
z
,…->
Çme
);

775 
	`checkmode
(
L
, 
p
->
mode
, "text");

776 
ş
 = 
	`luaY_·r£r
(
L
, 
p
->
z
, &p->
buff
, &p->
dyd
,…->
Çme
, 
c
);

778 
	`lua_as£¹
(
ş
->
nupv®ues
 =ğş->
p
->
¥
->
sizeupv®ues
);

779 
	`luaF_š™upv®s
(
L
, 
ş
);

780 
	}
}

783 
	$luaD_´Ùeùed·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, cÚ¡ *
Çme
,

784 cÚ¡ *
mode
) {

785 
SP¬£r
 
p
;

786 
¡©us
;

787 
L
->
Ây
++;

788 
p
.
z
 = z;….
Çme
 =‚ame;….
mode
 = mode;

789 
p
.
dyd
.
aùv¬
.
¬r
 = 
NULL
;….dyd.aùv¬.
size
 = 0;

790 
p
.
dyd
.
gt
.
¬r
 = 
NULL
;….dyd.gt.
size
 = 0;

791 
p
.
dyd
.
Ïb–
.
¬r
 = 
NULL
;….dyd.Ïb–.
size
 = 0;

792 
	`luaZ_š™bufãr
(
L
, &
p
.
buff
);

793 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
f_·r£r
, &
p
, 
	`§ve¡ack
(L, L->
tİ
), L->
”rfunc
);

794 
	`luaZ_ä“bufãr
(
L
, &
p
.
buff
);

795 
	`luaM_ä“¬¿y
(
L
, 
p
.
dyd
.
aùv¬
.
¬r
,….dyd.aùv¬.
size
);

796 
	`luaM_ä“¬¿y
(
L
, 
p
.
dyd
.
gt
.
¬r
,….dyd.gt.
size
);

797 
	`luaM_ä“¬¿y
(
L
, 
p
.
dyd
.
Ïb–
.
¬r
,….dyd.Ïb–.
size
);

798 
L
->
Ây
--;

799  
¡©us
;

800 
	}
}

	@3rd/lua/ldo.h

7 #iâdeà
ldo_h


8 
	#ldo_h


	)

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

13 
	~"lzio.h
"

23 
	#luaD_check¡ackaux
(
L
,
n
,
´e
,
pos
) \

24 ià(
L
->
¡ack_Ï¡
 - L->
tİ
 <ğ(
n
)) \

25 { 
´e
; 
	`luaD_grow¡ack
(
L
, 
n
); 
pos
; } { 
	`cÚdmove¡ack
(L,´e,pos); }

	)

28 
	#luaD_check¡ack
(
L
,
n
è
	`luaD_check¡ackaux
(L,n,()0,()0)

	)

32 
	#§ve¡ack
(
L
,
p
è((*)Õè- (*)L->
¡ack
)

	)

33 
	#»¡Üe¡ack
(
L
,
n
è((
TV®ue
 *)((*)L->
¡ack
 + (n)))

	)

37 (*
	tPfunc
è(
	tlua_S‹
 *
	tL
, *
	tud
);

39 
LUAI_FUNC
 
	`luaD_´Ùeùed·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, cÚ¡ *
Çme
,

40 cÚ¡ *
mode
);

41 
LUAI_FUNC
 
	`luaD_hook
 (
lua_S‹
 *
L
, 
ev’t
, 
lše
);

42 
LUAI_FUNC
 
	`luaD_´eÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
ÄesuÉs
);

43 
LUAI_FUNC
 
	`luaD_ÿÎ
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
);

44 
LUAI_FUNC
 
	`luaD_ÿÎnoy›ld
 (
lua_S‹
 *
L
, 
StkId
 
func
, 
nResuÉs
);

45 
LUAI_FUNC
 
	`luaD_pÿÎ
 (
lua_S‹
 *
L
, 
Pfunc
 
func
, *
u
,

46 
±rdiff_t
 
Şdtİ
,…Œdiff_ˆ
ef
);

47 
LUAI_FUNC
 
	`luaD_posÿÎ
 (
lua_S‹
 *
L
, 
C®lInfo
 *
ci
, 
StkId
 
fœ¡ResuÉ
,

48 
Äes
);

49 
LUAI_FUNC
 
	`luaD_»®loc¡ack
 (
lua_S‹
 *
L
, 
Ãwsize
);

50 
LUAI_FUNC
 
	`luaD_grow¡ack
 (
lua_S‹
 *
L
, 
n
);

51 
LUAI_FUNC
 
	`luaD_shršk¡ack
 (
lua_S‹
 *
L
);

52 
LUAI_FUNC
 
	`luaD_šùİ
 (
lua_S‹
 *
L
);

54 
LUAI_FUNC
 
l_nÜ‘
 
	`luaD_throw
 (
lua_S‹
 *
L
, 
”rcode
);

55 
LUAI_FUNC
 
	`luaD_¿wruÅrÙeùed
 (
lua_S‹
 *
L
, 
Pfunc
 
f
, *
ud
);

	@3rd/lua/ldump.c

7 
	#ldump_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lua.h
"

17 
	~"lobjeù.h
"

18 
	~"l¡©e.h
"

19 
	~"lundump.h
"

23 
lua_S‹
 *
	mL
;

24 
lua_Wr™”
 
	mwr™”
;

25 *
	md©a
;

26 
	m¡r
;

27 
	m¡©us
;

28 } 
	tDumpS‹
;

35 
	#DumpVeùÜ
(
v
,
n
,
D
è
	`DumpBlock
(v,Ò)*((v)[0]),D)

	)

37 
	#DumpL™”®
(
s
,
D
è
	`DumpBlock
(s, (sè- (), D)

	)

40 
	$DumpBlock
 (cÚ¡ *
b
, 
size_t
 
size
, 
DumpS‹
 *
D
) {

41 ià(
D
->
¡©us
 =ğ0 && 
size
 > 0) {

42 
	`lua_uÆock
(
D
->
L
);

43 
D
->
¡©us
 = (*D->
wr™”
)(D->
L
, 
b
, 
size
, D->
d©a
);

44 
	`lua_lock
(
D
->
L
);

46 
	}
}

49 
	#DumpV¬
(
x
,
D
è
	`DumpVeùÜ
(&x,1,D)

	)

52 
	$DumpBy‹
 (
y
, 
DumpS‹
 *
D
) {

53 
lu_by‹
 
x
 = (lu_by‹)
y
;

54 
	`DumpV¬
(
x
, 
D
);

55 
	}
}

58 
	$DumpIÁ
 (
x
, 
DumpS‹
 *
D
) {

59 
	`DumpV¬
(
x
, 
D
);

60 
	}
}

63 
	$DumpNumb”
 (
lua_Numb”
 
x
, 
DumpS‹
 *
D
) {

64 
	`DumpV¬
(
x
, 
D
);

65 
	}
}

68 
	$DumpIÁeg”
 (
lua_IÁeg”
 
x
, 
DumpS‹
 *
D
) {

69 
	`DumpV¬
(
x
, 
D
);

70 
	}
}

73 
	$DumpSŒšg
 (cÚ¡ 
TSŒšg
 *
s
, 
DumpS‹
 *
D
) {

74 ià(
s
 =ğ
NULL
)

75 
	`DumpBy‹
(0, 
D
);

77 
size_t
 
size
 = 
	`ts¦’
(
s
) + 1;

78 cÚ¡ *
¡r
 = 
	`g‘¡r
(
s
);

79 ià(
size
 < 0xFF)

80 
	`DumpBy‹
(
	`ÿ¡_št
(
size
), 
D
);

82 
	`DumpBy‹
(0xFF, 
D
);

83 
	`DumpV¬
(
size
, 
D
);

85 
	`DumpVeùÜ
(
¡r
, 
size
 - 1, 
D
);

87 
	}
}

90 
	$DumpCode
 (cÚ¡ 
Sh¬edPrÙo
 *
f
, 
DumpS‹
 *
D
) {

91 
	`DumpIÁ
(
f
->
sizecode
, 
D
);

92 
	`DumpVeùÜ
(
f
->
code
, f->
sizecode
, 
D
);

93 
	}
}

96 
DumpFunùiÚ
(cÚ¡ 
PrÙo
 *
f
, 
TSŒšg
 *
psourû
, 
DumpS‹
 *
D
);

98 
	$DumpCÚ¡ªts
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

99 
i
;

100 
n
 = 
f
->
¥
->
sizek
;

101 
	`DumpIÁ
(
n
, 
D
);

102 
i
 = 0; i < 
n
; i++) {

103 cÚ¡ 
TV®ue
 *
o
 = &
f
->
k
[
i
];

104 
	`DumpBy‹
(
	`‰y³
(
o
), 
D
);

105 
	`‰y³
(
o
)) {

106 
LUA_TNIL
:

108 
LUA_TBOOLEAN
:

109 
	`DumpBy‹
(
	`bv®ue
(
o
), 
D
);

111 
LUA_TNUMFLT
:

112 
	`DumpNumb”
(
	`ætv®ue
(
o
), 
D
);

114 
LUA_TNUMINT
:

115 
	`DumpIÁeg”
(
	`iv®ue
(
o
), 
D
);

117 
LUA_TSHRSTR
:

118 
LUA_TLNGSTR
:

119 
	`DumpSŒšg
(
	`tsv®ue
(
o
), 
D
);

122 
	`lua_as£¹
(0);

125 
	}
}

128 
	$DumpPrÙos
 (cÚ¡ 
PrÙo
 *
f
, 
DumpS‹
 *
D
) {

129 
i
;

130 
n
 = 
f
->
¥
->
siz•
;

131 
	`DumpIÁ
(
n
, 
D
);

132 
i
 = 0; i < 
n
; i++)

133 
	`DumpFunùiÚ
(
f
->
p
[
i
], f->
¥
->
sourû
, 
D
);

134 
	}
}

137 
	$DumpUpv®ues
 (cÚ¡ 
Sh¬edPrÙo
 *
f
, 
DumpS‹
 *
D
) {

138 
i
, 
n
 = 
f
->
sizeupv®ues
;

139 
	`DumpIÁ
(
n
, 
D
);

140 
i
 = 0; i < 
n
; i++) {

141 
	`DumpBy‹
(
f
->
upv®ues
[
i
].
š¡ack
, 
D
);

142 
	`DumpBy‹
(
f
->
upv®ues
[
i
].
idx
, 
D
);

144 
	}
}

147 
	$DumpDebug
 (cÚ¡ 
Sh¬edPrÙo
 *
f
, 
DumpS‹
 *
D
) {

148 
i
, 
n
;

149 
n
 = (
D
->
¡r
è? 0 : 
f
->
siz–šešfo
;

150 
	`DumpIÁ
(
n
, 
D
);

151 
	`DumpVeùÜ
(
f
->
lšešfo
, 
n
, 
D
);

152 
n
 = (
D
->
¡r
è? 0 : 
f
->
siz–ocv¬s
;

153 
	`DumpIÁ
(
n
, 
D
);

154 
i
 = 0; i < 
n
; i++) {

155 
	`DumpSŒšg
(
f
->
locv¬s
[
i
].
v¬Çme
, 
D
);

156 
	`DumpIÁ
(
f
->
locv¬s
[
i
].
¡¬c
, 
D
);

157 
	`DumpIÁ
(
f
->
locv¬s
[
i
].
’dpc
, 
D
);

159 
n
 = (
D
->
¡r
è? 0 : 
f
->
sizeupv®ues
;

160 
	`DumpIÁ
(
n
, 
D
);

161 
i
 = 0; i < 
n
; i++)

162 
	`DumpSŒšg
(
f
->
upv®ues
[
i
].
Çme
, 
D
);

163 
	}
}

166 
	$DumpFunùiÚ
 (cÚ¡ 
PrÙo
 *
å
, 
TSŒšg
 *
psourû
, 
DumpS‹
 *
D
) {

167 cÚ¡ 
Sh¬edPrÙo
 *
f
 = 
å
->
¥
;

168 ià(
D
->
¡r
 || 
f
->
sourû
 =ğ
psourû
)

169 
	`DumpSŒšg
(
NULL
, 
D
);

171 
	`DumpSŒšg
(
f
->
sourû
, 
D
);

172 
	`DumpIÁ
(
f
->
lšedefšed
, 
D
);

173 
	`DumpIÁ
(
f
->
Ï¡lšedefšed
, 
D
);

174 
	`DumpBy‹
(
f
->
num·¿ms
, 
D
);

175 
	`DumpBy‹
(
f
->
is_v¬¬g
, 
D
);

176 
	`DumpBy‹
(
f
->
max¡acksize
, 
D
);

177 
	`DumpCode
(
f
, 
D
);

178 
	`DumpCÚ¡ªts
(
å
, 
D
);

179 
	`DumpUpv®ues
(
f
, 
D
);

180 
	`DumpPrÙos
(
å
, 
D
);

181 
	`DumpDebug
(
f
, 
D
);

182 
	}
}

185 
	$DumpH—d”
 (
DumpS‹
 *
D
) {

186 
	`DumpL™”®
(
LUA_SIGNATURE
, 
D
);

187 
	`DumpBy‹
(
LUAC_VERSION
, 
D
);

188 
	`DumpBy‹
(
LUAC_FORMAT
, 
D
);

189 
	`DumpL™”®
(
LUAC_DATA
, 
D
);

190 
	`DumpBy‹
((), 
D
);

191 
	`DumpBy‹
((
size_t
), 
D
);

192 
	`DumpBy‹
((
In¡ruùiÚ
), 
D
);

193 
	`DumpBy‹
((
lua_IÁeg”
), 
D
);

194 
	`DumpBy‹
((
lua_Numb”
), 
D
);

195 
	`DumpIÁeg”
(
LUAC_INT
, 
D
);

196 
	`DumpNumb”
(
LUAC_NUM
, 
D
);

197 
	}
}

203 
	$luaU_dump
(
lua_S‹
 *
L
, cÚ¡ 
PrÙo
 *
f
, 
lua_Wr™”
 
w
, *
d©a
,

204 
¡r
) {

205 
DumpS‹
 
D
;

206 
D
.
L
 = L;

207 
D
.
wr™”
 = 
w
;

208 
D
.
d©a
 = data;

209 
D
.
¡r
 = strip;

210 
D
.
¡©us
 = 0;

211 
	`DumpH—d”
(&
D
);

212 
	`DumpBy‹
(
f
->
¥
->
sizeupv®ues
, &
D
);

213 
	`DumpFunùiÚ
(
f
, 
NULL
, &
D
);

214  
D
.
¡©us
;

215 
	}
}

	@3rd/lua/lfunc.c

7 
	#lfunc_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lua.h
"

17 
	~"lfunc.h
"

18 
	~"lgc.h
"

19 
	~"lmem.h
"

20 
	~"lobjeù.h
"

21 
	~"l¡©e.h
"

25 
CClosu»
 *
	$luaF_ÃwCşosu»
 (
lua_S‹
 *
L
, 
n
) {

26 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TCCL
, 
	`sizeCşosu»
(
n
));

27 
CClosu»
 *
c
 = 
	`gco2cş
(
o
);

28 
c
->
nupv®ues
 = 
	`ÿ¡_by‹
(
n
);

29  
c
;

30 
	}
}

33 
LClosu»
 *
	$luaF_ÃwLşosu»
 (
lua_S‹
 *
L
, 
n
) {

34 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TLCL
, 
	`sizeLşosu»
(
n
));

35 
LClosu»
 *
c
 = 
	`gco2lş
(
o
);

36 
c
->
p
 = 
NULL
;

37 
c
->
nupv®ues
 = 
	`ÿ¡_by‹
(
n
);

38 
n
--è
c
->
upv®s
[n] = 
NULL
;

39  
c
;

40 
	}
}

45 
	$luaF_š™upv®s
 (
lua_S‹
 *
L
, 
LClosu»
 *
ş
) {

46 
i
;

47 
i
 = 0; i < 
ş
->
nupv®ues
; i++) {

48 
UpV®
 *
uv
 = 
	`luaM_Ãw
(
L
, UpVal);

49 
uv
->
»fcouÁ
 = 1;

50 
uv
->
v
 = &uv->
u
.
v®ue
;

51 
	`£Šv®ue
(
uv
->
v
);

52 
ş
->
upv®s
[
i
] = 
uv
;

54 
	}
}

57 
UpV®
 *
	$luaF_fšdupv®
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
) {

58 
UpV®
 **
µ
 = &
L
->
İ’upv®
;

59 
UpV®
 *
p
;

60 
UpV®
 *
uv
;

61 
	`lua_as£¹
(
	`isštwups
(
L
è|| L->
İ’upv®
 =ğ
NULL
);

62 *
µ
 !ğ
NULL
 && (
p
 = *µ)->
v
 >ğ
Ëv–
) {

63 
	`lua_as£¹
(
	`upisİ’
(
p
));

64 ià(
p
->
v
 =ğ
Ëv–
)

65  
p
;

66 
µ
 = &
p
->
u
.
İ’
.
Ãxt
;

69 
uv
 = 
	`luaM_Ãw
(
L
, 
UpV®
);

70 
uv
->
»fcouÁ
 = 0;

71 
uv
->
u
.
İ’
.
Ãxt
 = *
µ
;

72 
uv
->
u
.
İ’
.
touched
 = 1;

73 *
µ
 = 
uv
;

74 
uv
->
v
 = 
Ëv–
;

75 ià(!
	`isštwups
(
L
)) {

76 
L
->
twups
 = 
	`G
(L)->twups;

77 
	`G
(
L
)->
twups
 = L;

79  
uv
;

80 
	}
}

83 
	$luaF_şo£
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
) {

84 
UpV®
 *
uv
;

85 
L
->
İ’upv®
 !ğ
NULL
 && (
uv
 = L->İ’upv®)->
v
 >ğ
Ëv–
) {

86 
	`lua_as£¹
(
	`upisİ’
(
uv
));

87 
L
->
İ’upv®
 = 
uv
->
u
.
İ’
.
Ãxt
;

88 ià(
uv
->
»fcouÁ
 == 0)

89 
	`luaM_ä“
(
L
, 
uv
);

91 
	`£tobj
(
L
, &
uv
->
u
.
v®ue
, uv->
v
);

92 
uv
->
v
 = &uv->
u
.
v®ue
;

93 
	`luaC_upv®b¬r›r
(
L
, 
uv
);

96 
	}
}

99 
PrÙo
 *
	$luaF_Ãw´Ùo
 (
lua_S‹
 *
L
, 
Sh¬edPrÙo
 *
¥
) {

100 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TPROTO
, (
PrÙo
));

101 
PrÙo
 *
f
 = 
	`gco2p
(
o
);

102 
f
->
¥
 = 
NULL
;

103 
f
->
k
 = 
NULL
;

104 
f
->
p
 = 
NULL
;

105 
f
->
ÿche
 = 
NULL
;

106 ià(
¥
 =ğ
NULL
) {

107 
¥
 = 
	`luaM_Ãw
(
L
, 
Sh¬edPrÙo
);

108 
¥
->
l_G
 = 
	`G
(
L
);

109 
¥
->
sizek
 = 0;

110 
¥
->
siz•
 = 0;

111 
¥
->
code
 = 
NULL
;

112 
¥
->
sizecode
 = 0;

113 
¥
->
lšešfo
 = 
NULL
;

114 
¥
->
siz–šešfo
 = 0;

115 
¥
->
upv®ues
 = 
NULL
;

116 
¥
->
sizeupv®ues
 = 0;

117 
¥
->
num·¿ms
 = 0;

118 
¥
->
is_v¬¬g
 = 0;

119 
¥
->
max¡acksize
 = 0;

120 
¥
->
locv¬s
 = 
NULL
;

121 
¥
->
siz–ocv¬s
 = 0;

122 
¥
->
lšedefšed
 = 0;

123 
¥
->
Ï¡lšedefšed
 = 0;

124 
¥
->
sourû
 = 
NULL
;

126 
f
->
¥
 = sp;

127  
f
;

128 
	}
}

131 
	$ä“sh¬ed´Ùo
 (
lua_S‹
 *
L
, 
Sh¬edPrÙo
 *
f
) {

132 ià(
f
 =ğ
NULL
 || 
	`G
(
L
è!ğf->
l_G
)

134 
	`luaM_ä“¬¿y
(
L
, 
f
->
code
, f->
sizecode
);

135 
	`luaM_ä“¬¿y
(
L
, 
f
->
lšešfo
, f->
siz–šešfo
);

136 
	`luaM_ä“¬¿y
(
L
, 
f
->
locv¬s
, f->
siz–ocv¬s
);

137 
	`luaM_ä“¬¿y
(
L
, 
f
->
upv®ues
, f->
sizeupv®ues
);

138 
	`luaM_ä“
(
L
, 
f
);

139 
	}
}

141 
	$luaF_ä“´Ùo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
) {

142 
	`luaM_ä“¬¿y
(
L
, 
f
->
p
, f->
¥
->
siz•
);

143 
	`luaM_ä“¬¿y
(
L
, 
f
->
k
, f->
¥
->
sizek
);

144 
	`ä“sh¬ed´Ùo
(
L
, 
f
->
¥
);

145 
	`luaM_ä“
(
L
, 
f
);

146 
	}
}

153 cÚ¡ *
	$luaF_g‘loÿÊame
 (cÚ¡ 
PrÙo
 *
å
, 
loÿl_numb”
, 
pc
) {

154 
i
;

155 cÚ¡ 
Sh¬edPrÙo
 *
f
 = 
å
->
¥
;

156 
i
 = 0; i<
f
->
siz–ocv¬s
 && f->
locv¬s
[i].
¡¬c
 <ğ
pc
; i++) {

157 ià(
pc
 < 
f
->
locv¬s
[
i
].
’dpc
) {

158 
loÿl_numb”
--;

159 ià(
loÿl_numb”
 == 0)

160  
	`g‘¡r
(
f
->
locv¬s
[
i
].
v¬Çme
);

163  
NULL
;

164 
	}
}

	@3rd/lua/lfunc.h

7 #iâdeà
lfunc_h


8 
	#lfunc_h


	)

11 
	~"lobjeù.h
"

14 
	#sizeCşosu»
(
n
è(
	`ÿ¡
(, (
CClosu»
)) + \

15 
	`ÿ¡
(, (
TV®ue
)*((
n
)-1)))

	)

17 
	#sizeLşosu»
(
n
è(
	`ÿ¡
(, (
LClosu»
)) + \

18 
	`ÿ¡
(, (
TV®ue
 *)*((
n
)-1)))

	)

22 
	#isštwups
(
L
è(L->
twups
 !ğL)

	)

29 
	#MAXUPVAL
 255

	)

35 
	sUpV®
 {

36 
TV®ue
 *
	mv
;

37 
lu_mem
 
	m»fcouÁ
;

40 
UpV®
 *
	mÃxt
;

41 
	mtouched
;

42 } 
	mİ’
;

43 
TV®ue
 
	mv®ue
;

44 } 
	mu
;

47 
	#upisİ’
(
up
è((up)->
v
 !ğ&(up)->
u
.
v®ue
)

	)

50 
LUAI_FUNC
 
PrÙo
 *
luaF_Ãw´Ùo
 (
lua_S‹
 *
L
, 
Sh¬edPrÙo
 *
¥
);

51 
LUAI_FUNC
 
CClosu»
 *
luaF_ÃwCşosu»
 (
lua_S‹
 *
L
, 
ÃËms
);

52 
LUAI_FUNC
 
LClosu»
 *
luaF_ÃwLşosu»
 (
lua_S‹
 *
L
, 
ÃËms
);

53 
LUAI_FUNC
 
luaF_š™upv®s
 (
lua_S‹
 *
L
, 
LClosu»
 *
ş
);

54 
LUAI_FUNC
 
UpV®
 *
luaF_fšdupv®
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
);

55 
LUAI_FUNC
 
luaF_şo£
 (
lua_S‹
 *
L
, 
StkId
 
Ëv–
);

56 
LUAI_FUNC
 
luaF_ä“´Ùo
 (
lua_S‹
 *
L
, 
PrÙo
 *
f
);

57 
LUAI_FUNC
 cÚ¡ *
luaF_g‘loÿÊame
 (cÚ¡ 
PrÙo
 *
func
, 
loÿl_numb”
,

58 
pc
);

	@3rd/lua/lgc.c

7 
	#lgc_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lgc.h
"

21 
	~"lmem.h
"

22 
	~"lobjeù.h
"

23 
	~"l¡©e.h
"

24 
	~"l¡ršg.h
"

25 
	~"ÉabË.h
"

26 
	~"Ém.h
"

33 
	#GCSšsid—tomic
 (
GCS·u£
 + 1)

	)

39 
	#GCSWEEPCOST
 (((
TSŒšg
è+ 4è/ 4)

	)

42 
	#GCSWEEPMAX
 (
	`ÿ¡_št
((
GCSTEPSIZE
 / 
GCSWEEPCOST
è/ 4))

	)

45 
	#GCFINALIZECOST
 
GCSWEEPCOST


	)

52 
	#STEPMULADJ
 200

	)

59 
	#PAUSEADJ
 100

	)

66 
	#maskcŞÜs
 (~(
	`b™mask
(
BLACKBIT
è| 
WHITEBITS
))

	)

67 
	#makewh™e
(
g
,
x
) \

68 (
x
->
m¬ked
 = 
	`ÿ¡_by‹
((x->m¬ked & 
maskcŞÜs
è| 
	`luaC_wh™e
(
g
)))

	)

70 
	#wh™e2g¿y
(
x
è
	`»£tb™s
(x->
m¬ked
, 
WHITEBITS
)

	)

71 
	#bÏck2g¿y
(
x
è
	`»£tb™
(x->
m¬ked
, 
BLACKBIT
)

	)

74 
	#v®iswh™e
(
x
è(
	`iscŞËùabË
(xè&& 
	`iswh™e
(
	`gcv®ue
(x)))

	)

76 
	#checkd—dkey
(
n
è
	`lua_as£¹
(!
	`‰isd—dkey
(
	`gkey
Ò)è|| 
	`‰i¢
(
	`gv®
Ò)))

	)

79 
	#checkcÚsi¡’cy
(
obj
) \

80 
	`lua_lÚgas£¹
(!
	`iscŞËùabË
(
obj
è|| 
	`righ‰t
(obj))

	)

83 
	#m¬kv®ue
(
g
,
o
è{ 
	`checkcÚsi¡’cy
(o); \

84 ià(
	`v®iswh™e
(
o
)è
	`»®lym¬kobjeù
(
g
,
	`gcv®ue
(o)); }

	)

86 
	#m¬kobjeù
(
g
,
t
è{ ià(
	`iswh™e
Ñ)è
	`»®lym¬kobjeù
(g, 
	`obj2gco
Ñ)); }

	)

92 
	#m¬kobjeùN
(
g
,
t
è{ iàÑè
	`m¬kobjeù
(g,t); }

	)

94 
»®lym¬kobjeù
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
o
);

107 
	#gnod–a¡
(
h
è
	`gnode
(h, 
	`ÿ¡
(
size_t
, 
	`siz’ode
(h)))

	)

113 
	#lškgşi¡
(
o
,
p
è((o)->
gşi¡
 = (p), (pèğ
	`obj2gco
(o))

	)

125 
	$»mov“Áry
 (
Node
 *
n
) {

126 
	`lua_as£¹
(
	`‰i¢
(
	`gv®
(
n
)));

127 ià(
	`v®iswh™e
(
	`gkey
(
n
)))

128 
	`£td—dv®ue
(
	`wgkey
(
n
));

129 
	}
}

139 
	$isş—»d
 (
glob®_S‹
 *
g
, cÚ¡ 
TV®ue
 *
o
) {

140 ià(!
	`iscŞËùabË
(
o
))  0;

141 ià(
	`‰is¡ršg
(
o
)) {

142 
	`m¬kobjeù
(
g
, 
	`tsv®ue
(
o
));

145  
	`iswh™e
(
	`gcv®ue
(
o
));

146 
	}
}

155 
	$luaC_b¬r›r_
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, GCObjeù *
v
) {

156 
glob®_S‹
 *
g
 = 
	`G
(
L
);

157 
	`lua_as£¹
(
	`isbÏck
(
o
è&& 
	`iswh™e
(
v
è&& !
	`isd—d
(
g
, v) && !isdead(g, o));

158 ià(
	`k“pšv¬ŸÁ
(
g
))

159 
	`»®lym¬kobjeù
(
g
, 
v
);

161 
	`lua_as£¹
(
	`issw“µha£
(
g
));

162 
	`makewh™e
(
g
, 
o
);

164 
	}
}

171 
	$luaC_b¬r›rback_
 (
lua_S‹
 *
L
, 
TabË
 *
t
) {

172 
glob®_S‹
 *
g
 = 
	`G
(
L
);

173 
	`lua_as£¹
(
	`isbÏck
(
t
è&& !
	`isd—d
(
g
,));

174 
	`bÏck2g¿y
(
t
);

175 
	`lškgşi¡
(
t
, 
g
->
g¿yagaš
);

176 
	}
}

185 
	$luaC_upv®b¬r›r_
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
) {

186 
glob®_S‹
 *
g
 = 
	`G
(
L
);

187 
GCObjeù
 *
o
 = 
	`gcv®ue
(
uv
->
v
);

188 
	`lua_as£¹
(!
	`upisİ’
(
uv
));

189 ià(
	`k“pšv¬ŸÁ
(
g
))

190 
	`m¬kobjeù
(
g
, 
o
);

191 
	}
}

194 
	$luaC_fix
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
) {

195 
glob®_S‹
 *
g
 = 
	`G
(
L
);

196 ià(
g
->
®lgc
 !ğ
o
)

198 
	`wh™e2g¿y
(
o
);

199 
g
->
®lgc
 = 
o
->
Ãxt
;

200 
o
->
Ãxt
 = 
g
->
fixedgc
;

201 
g
->
fixedgc
 = 
o
;

202 
	}
}

209 
GCObjeù
 *
	$luaC_Ãwobj
 (
lua_S‹
 *
L
, 
‰
, 
size_t
 
sz
) {

210 
glob®_S‹
 *
g
 = 
	`G
(
L
);

211 
GCObjeù
 *
o
 = 
	`ÿ¡
(GCObjeù *, 
	`luaM_Ãwobjeù
(
L
, 
	`nov¬ŸÁ
(
‰
), 
sz
));

212 
o
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

213 
o
->
‰
 =t;

214 
o
->
Ãxt
 = 
g
->
®lgc
;

215 
g
->
®lgc
 = 
o
;

216  
o
;

217 
	}
}

236 
	$»®lym¬kobjeù
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
o
) {

237 
»’Œy
:

238 
	`wh™e2g¿y
(
o
);

239 
o
->
‰
) {

240 
LUA_TSHRSTR
: {

241 
	`g¿y2bÏck
(
o
);

242 
g
->
GCmemŒav
 +ğ
	`siz–¡ršg
(
	`gco2ts
(
o
)->
sh¾’
);

245 
LUA_TLNGSTR
: {

246 
	`g¿y2bÏck
(
o
);

247 
g
->
GCmemŒav
 +ğ
	`siz–¡ršg
(
	`gco2ts
(
o
)->
u
.
ÊgËn
);

250 
LUA_TUSERDATA
: {

251 
TV®ue
 
uv®ue
;

252 
	`m¬kobjeùN
(
g
, 
	`gco2u
(
o
)->
m‘©abË
);

253 
	`g¿y2bÏck
(
o
);

254 
g
->
GCmemŒav
 +ğ
	`sizeud©a
(
	`gco2u
(
o
));

255 
	`g‘u£rv®ue
(
g
->
mašth»ad
, 
	`gco2u
(
o
), &
uv®ue
);

256 ià(
	`v®iswh™e
(&
uv®ue
)) {

257 
o
 = 
	`gcv®ue
(&
uv®ue
);

258 
»’Œy
;

262 
LUA_TLCL
: {

263 
	`lškgşi¡
(
	`gco2lş
(
o
), 
g
->
g¿y
);

266 
LUA_TCCL
: {

267 
	`lškgşi¡
(
	`gco2cş
(
o
), 
g
->
g¿y
);

270 
LUA_TTABLE
: {

271 
	`lškgşi¡
(
	`gco2t
(
o
), 
g
->
g¿y
);

274 
LUA_TTHREAD
: {

275 
	`lškgşi¡
(
	`gco2th
(
o
), 
g
->
g¿y
);

278 
LUA_TPROTO
: {

279 
	`lškgşi¡
(
	`gco2p
(
o
), 
g
->
g¿y
);

282 : 
	`lua_as£¹
(0); ;

284 
	}
}

290 
	$m¬kmt
 (
glob®_S‹
 *
g
) {

291 
i
;

292 
i
=0; i < 
LUA_NUMTAGS
; i++)

293 
	`m¬kobjeùN
(
g
, g->
mt
[
i
]);

294 
	}
}

300 
	$m¬kbešgâz
 (
glob®_S‹
 *
g
) {

301 
GCObjeù
 *
o
;

302 
o
 = 
g
->
tobeâz
; o !ğ
NULL
; o = o->
Ãxt
)

303 
	`m¬kobjeù
(
g
, 
o
);

304 
	}
}

313 
	$»m¬kupv®s
 (
glob®_S‹
 *
g
) {

314 
lua_S‹
 *
th»ad
;

315 
lua_S‹
 **
p
 = &
g
->
twups
;

316 (
th»ad
 = *
p
è!ğ
NULL
) {

317 
	`lua_as£¹
(!
	`isbÏck
(
th»ad
));

318 ià(
	`isg¿y
(
th»ad
è&&h»ad->
İ’upv®
 !ğ
NULL
)

319 
p
 = &
th»ad
->
twups
;

321 
UpV®
 *
uv
;

322 *
p
 = 
th»ad
->
twups
;

323 
th»ad
->
twups
 =hread;

324 
uv
 = 
th»ad
->
İ’upv®
; uv !ğ
NULL
; uv = uv->
u
.
İ’
.
Ãxt
) {

325 ià(
uv
->
u
.
İ’
.
touched
) {

326 
	`m¬kv®ue
(
g
, 
uv
->
v
);

327 
uv
->
u
.
İ’
.
touched
 = 0;

332 
	}
}

338 
	$»¡¬tcŞËùiÚ
 (
glob®_S‹
 *
g
) {

339 
g
->
g¿y
 = g->
g¿yagaš
 = 
NULL
;

340 
g
->
w—k
 = g->
®lw—k
 = g->
•hem”Ú
 = 
NULL
;

341 
	`m¬kobjeù
(
g
, g->
mašth»ad
);

342 
	`m¬kv®ue
(
g
, &g->
l_»gi¡ry
);

343 
	`m¬kmt
(
g
);

344 
	`m¬kbešgâz
(
g
);

345 
	}
}

362 
	$Œav”£w—kv®ue
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

363 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

366 
hasş—rs
 = (
h
->
siz—¼ay
 > 0);

367 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

368 
	`checkd—dkey
(
n
);

369 ià(
	`‰i¢
(
	`gv®
(
n
)))

370 
	`»mov“Áry
(
n
);

372 
	`lua_as£¹
(!
	`‰i¢
(
	`gkey
(
n
)));

373 
	`m¬kv®ue
(
g
, 
	`gkey
(
n
));

374 ià(!
hasş—rs
 && 
	`isş—»d
(
g
, 
	`gv®
(
n
)))

375 
hasş—rs
 = 1;

378 ià(
g
->
gc¡©e
 =ğ
GCS´İag©e
)

379 
	`lškgşi¡
(
h
, 
g
->
g¿yagaš
);

380 ià(
hasş—rs
)

381 
	`lškgşi¡
(
h
, 
g
->
w—k
);

382 
	}
}

395 
	$Œav”£•hem”Ú
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

396 
m¬ked
 = 0;

397 
hasş—rs
 = 0;

398 
hasww
 = 0;

399 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

400 
i
;

402 
i
 = 0; i < 
h
->
siz—¼ay
; i++) {

403 ià(
	`v®iswh™e
(&
h
->
¬¿y
[
i
])) {

404 
m¬ked
 = 1;

405 
	`»®lym¬kobjeù
(
g
, 
	`gcv®ue
(&
h
->
¬¿y
[
i
]));

409 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

410 
	`checkd—dkey
(
n
);

411 ià(
	`‰i¢
(
	`gv®
(
n
)))

412 
	`»mov“Áry
(
n
);

413 ià(
	`isş—»d
(
g
, 
	`gkey
(
n
))) {

414 
hasş—rs
 = 1;

415 ià(
	`v®iswh™e
(
	`gv®
(
n
)))

416 
hasww
 = 1;

418 ià(
	`v®iswh™e
(
	`gv®
(
n
))) {

419 
m¬ked
 = 1;

420 
	`»®lym¬kobjeù
(
g
, 
	`gcv®ue
(
	`gv®
(
n
)));

424 ià(
g
->
gc¡©e
 =ğ
GCS´İag©e
)

425 
	`lškgşi¡
(
h
, 
g
->
g¿yagaš
);

426 ià(
hasww
)

427 
	`lškgşi¡
(
h
, 
g
->
•hem”Ú
);

428 ià(
hasş—rs
)

429 
	`lškgşi¡
(
h
, 
g
->
®lw—k
);

430  
m¬ked
;

431 
	}
}

434 
	$Œav”£¡rÚgbË
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

435 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

436 
i
;

437 
i
 = 0; i < 
h
->
siz—¼ay
; i++)

438 
	`m¬kv®ue
(
g
, &
h
->
¬¿y
[
i
]);

439 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

440 
	`checkd—dkey
(
n
);

441 ià(
	`‰i¢
(
	`gv®
(
n
)))

442 
	`»mov“Áry
(
n
);

444 
	`lua_as£¹
(!
	`‰i¢
(
	`gkey
(
n
)));

445 
	`m¬kv®ue
(
g
, 
	`gkey
(
n
));

446 
	`m¬kv®ue
(
g
, 
	`gv®
(
n
));

449 
	}
}

452 
lu_mem
 
	$Œav”£bË
 (
glob®_S‹
 *
g
, 
TabË
 *
h
) {

453 cÚ¡ *
w—kkey
, *
w—kv®ue
;

454 cÚ¡ 
TV®ue
 *
mode
 = 
	`gç¡tm
(
g
, 
h
->
m‘©abË
, 
TM_MODE
);

455 
	`m¬kobjeùN
(
g
, 
h
->
m‘©abË
);

456 ià(
mode
 && 
	`‰is¡ršg
(mode) &&

457 ((
w—kkey
 = 
	`¡rchr
(
	`sv®ue
(
mode
), 'k')),

458 (
w—kv®ue
 = 
	`¡rchr
(
	`sv®ue
(
mode
), 'v')),

459 (
w—kkey
 || 
w—kv®ue
))) {

460 
	`bÏck2g¿y
(
h
);

461 ià(!
w—kkey
)

462 
	`Œav”£w—kv®ue
(
g
, 
h
);

463 ià(!
w—kv®ue
)

464 
	`Œav”£•hem”Ú
(
g
, 
h
);

466 
	`lškgşi¡
(
h
, 
g
->
®lw—k
);

469 
	`Œav”£¡rÚgbË
(
g
, 
h
);

470  (
TabË
è+ (
TV®ue
è* 
h
->
siz—¼ay
 +

471 (
Node
è* 
	`ÿ¡
(
size_t
, 
	`®locsiz’ode
(
h
));

472 
	}
}

474 
	$m¬ksh¬ed´Ùo
 (
glob®_S‹
 *
g
, 
Sh¬edPrÙo
 *
f
) {

475 
i
;

476 ià(
g
 !ğ
f
->
l_G
)

478 
	`m¬kobjeùN
(
g
, 
f
->
sourû
);

479 
i
 = 0; i < 
f
->
sizeupv®ues
; i++)

480 
	`m¬kobjeùN
(
g
, 
f
->
upv®ues
[
i
].
Çme
);

481 
i
 = 0; i < 
f
->
siz–ocv¬s
; i++)

482 
	`m¬kobjeùN
(
g
, 
f
->
locv¬s
[
i
].
v¬Çme
);

483  (
In¡ruùiÚ
è* 
f
->
sizecode
 +

484 (è* 
f
->
siz–šešfo
 +

485 (
LocV¬
è* 
f
->
siz–ocv¬s
 +

486 (
Upv®desc
è* 
f
->
sizeupv®ues
;

487 
	}
}

494 
	$Œav”£´Ùo
 (
glob®_S‹
 *
g
, 
PrÙo
 *
f
) {

495 
i
,
nk
,
Å
;

496 ià(
f
->
ÿche
 && 
	`iswh™e
(f->cache))

497 
f
->
ÿche
 = 
NULL
;

498 ià(
f
->
¥
 =ğ
NULL
)

499  (
PrÙo
);

500 
nk
 = (
f
->
k
 =ğ
NULL
è? 0 : f->
¥
->
sizek
;

501 
Å
 = (
f
->
p
 =ğ
NULL
è? 0 : f->
¥
->
siz•
;

502 
i
 = 0; i < 
nk
; i++)

503 
	`m¬kv®ue
(
g
, &
f
->
k
[
i
]);

504 
i
 = 0; i < 
Å
; i++)

505 
	`m¬kobjeùN
(
g
, 
f
->
p
[
i
]);

506  (
PrÙo
è+ (PrÙØ*è* 
Å
 +

507 (
TV®ue
è* 
nk
 +

508 
	`m¬ksh¬ed´Ùo
(
g
, 
f
->
¥
);

509 
	}
}

512 
lu_mem
 
	$Œav”£Cşosu»
 (
glob®_S‹
 *
g
, 
CClosu»
 *
ş
) {

513 
i
;

514 
i
 = 0; i < 
ş
->
nupv®ues
; i++)

515 
	`m¬kv®ue
(
g
, &
ş
->
upv®ue
[
i
]);

516  
	`sizeCşosu»
(
ş
->
nupv®ues
);

517 
	}
}

525 
lu_mem
 
	$Œav”£Lşosu»
 (
glob®_S‹
 *
g
, 
LClosu»
 *
ş
) {

526 
i
;

527 
	`m¬kobjeùN
(
g
, 
ş
->
p
);

528 
i
 = 0; i < 
ş
->
nupv®ues
; i++) {

529 
UpV®
 *
uv
 = 
ş
->
upv®s
[
i
];

530 ià(
uv
 !ğ
NULL
) {

531 ià(
	`upisİ’
(
uv
è&& 
g
->
gc¡©e
 !ğ
GCSšsid—tomic
)

532 
uv
->
u
.
İ’
.
touched
 = 1;

534 
	`m¬kv®ue
(
g
, 
uv
->
v
);

537  
	`sizeLşosu»
(
ş
->
nupv®ues
);

538 
	}
}

541 
lu_mem
 
	$Œav”£th»ad
 (
glob®_S‹
 *
g
, 
lua_S‹
 *
th
) {

542 
StkId
 
o
 = 
th
->
¡ack
;

543 ià(
o
 =ğ
NULL
)

545 
	`lua_as£¹
(
g
->
gc¡©e
 =ğ
GCSšsid—tomic
 ||

546 
th
->
İ’upv®
 =ğ
NULL
 || 
	`isštwups
(th));

547 ; 
o
 < 
th
->
tİ
; o++)

548 
	`m¬kv®ue
(
g
, 
o
);

549 ià(
g
->
gc¡©e
 =ğ
GCSšsid—tomic
) {

550 
StkId
 
lim
 = 
th
->
¡ack
 +h->
¡acksize
;

551 ; 
o
 < 
lim
; o++)

552 
	`£Šv®ue
(
o
);

554 ià(!
	`isštwups
(
th
è&&h->
İ’upv®
 !ğ
NULL
) {

555 
th
->
twups
 = 
g
->twups;

556 
g
->
twups
 = 
th
;

559 ià(
g
->
gckšd
 !ğ
KGC_EMERGENCY
)

560 
	`luaD_shršk¡ack
(
th
);

561  ((
lua_S‹
è+ (
TV®ue
è* 
th
->
¡acksize
 +

562 (
C®lInfo
è* 
th
->
nci
);

563 
	}
}

570 
	$´İag©em¬k
 (
glob®_S‹
 *
g
) {

571 
lu_mem
 
size
;

572 
GCObjeù
 *
o
 = 
g
->
g¿y
;

573 
	`lua_as£¹
(
	`isg¿y
(
o
));

574 
	`g¿y2bÏck
(
o
);

575 
o
->
‰
) {

576 
LUA_TTABLE
: {

577 
TabË
 *
h
 = 
	`gco2t
(
o
);

578 
g
->
g¿y
 = 
h
->
gşi¡
;

579 
size
 = 
	`Œav”£bË
(
g
, 
h
);

582 
LUA_TLCL
: {

583 
LClosu»
 *
ş
 = 
	`gco2lş
(
o
);

584 
g
->
g¿y
 = 
ş
->
gşi¡
;

585 
size
 = 
	`Œav”£Lşosu»
(
g
, 
ş
);

588 
LUA_TCCL
: {

589 
CClosu»
 *
ş
 = 
	`gco2cş
(
o
);

590 
g
->
g¿y
 = 
ş
->
gşi¡
;

591 
size
 = 
	`Œav”£Cşosu»
(
g
, 
ş
);

594 
LUA_TTHREAD
: {

595 
lua_S‹
 *
th
 = 
	`gco2th
(
o
);

596 
g
->
g¿y
 = 
th
->
gşi¡
;

597 
	`lškgşi¡
(
th
, 
g
->
g¿yagaš
);

598 
	`bÏck2g¿y
(
o
);

599 
size
 = 
	`Œav”£th»ad
(
g
, 
th
);

602 
LUA_TPROTO
: {

603 
PrÙo
 *
p
 = 
	`gco2p
(
o
);

604 
g
->
g¿y
 = 
p
->
gşi¡
;

605 
size
 = 
	`Œav”£´Ùo
(
g
, 
p
);

608 : 
	`lua_as£¹
(0); ;

610 
g
->
GCmemŒav
 +ğ
size
;

611 
	}
}

614 
	$´İag©—Î
 (
glob®_S‹
 *
g
) {

615 
g
->
g¿y
è
	`´İag©em¬k
(g);

616 
	}
}

619 
	$cÚv”g“phem”Ús
 (
glob®_S‹
 *
g
) {

620 
chªged
;

622 
GCObjeù
 *
w
;

623 
GCObjeù
 *
Ãxt
 = 
g
->
•hem”Ú
;

624 
g
->
•hem”Ú
 = 
NULL
;

625 
chªged
 = 0;

626 (
w
 = 
Ãxt
è!ğ
NULL
) {

627 
Ãxt
 = 
	`gco2t
(
w
)->
gşi¡
;

628 ià(
	`Œav”£•hem”Ú
(
g
, 
	`gco2t
(
w
))) {

629 
	`´İag©—Î
(
g
);

630 
chªged
 = 1;

633 } 
chªged
);

634 
	}
}

650 
	$ş—rkeys
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
l
, GCObjeù *
f
) {

651 ; 
l
 !ğ
f
;† = 
	`gco2t
Ö)->
gşi¡
) {

652 
TabË
 *
h
 = 
	`gco2t
(
l
);

653 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

654 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

655 ià(!
	`‰i¢
(
	`gv®
(
n
)è&& (
	`isş—»d
(
g
, 
	`gkey
(n)))) {

656 
	`£Šv®ue
(
	`gv®
(
n
));

657 
	`»mov“Áry
(
n
);

661 
	}
}

668 
	$ş—rv®ues
 (
glob®_S‹
 *
g
, 
GCObjeù
 *
l
, GCObjeù *
f
) {

669 ; 
l
 !ğ
f
;† = 
	`gco2t
Ö)->
gşi¡
) {

670 
TabË
 *
h
 = 
	`gco2t
(
l
);

671 
Node
 *
n
, *
lim™
 = 
	`gnod–a¡
(
h
);

672 
i
;

673 
i
 = 0; i < 
h
->
siz—¼ay
; i++) {

674 
TV®ue
 *
o
 = &
h
->
¬¿y
[
i
];

675 ià(
	`isş—»d
(
g
, 
o
))

676 
	`£Šv®ue
(
o
);

678 
n
 = 
	`gnode
(
h
, 0);‚ < 
lim™
;‚++) {

679 ià(!
	`‰i¢
(
	`gv®
(
n
)è&& 
	`isş—»d
(
g
, gval(n))) {

680 
	`£Šv®ue
(
	`gv®
(
n
));

681 
	`»mov“Áry
(
n
);

685 
	}
}

688 
	$luaC_upvdeccouÁ
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
) {

689 
	`lua_as£¹
(
uv
->
»fcouÁ
 > 0);

690 
uv
->
»fcouÁ
--;

691 ià(
uv
->
»fcouÁ
 =ğ0 && !
	`upisİ’
(uv))

692 
	`luaM_ä“
(
L
, 
uv
);

693 
	}
}

696 
	$ä“Lşosu»
 (
lua_S‹
 *
L
, 
LClosu»
 *
ş
) {

697 
i
;

698 
i
 = 0; i < 
ş
->
nupv®ues
; i++) {

699 
UpV®
 *
uv
 = 
ş
->
upv®s
[
i
];

700 ià(
uv
)

701 
	`luaC_upvdeccouÁ
(
L
, 
uv
);

703 
	`luaM_ä“mem
(
L
, 
ş
, 
	`sizeLşosu»
(ş->
nupv®ues
));

704 
	}
}

707 
	$ä“obj
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
) {

708 
o
->
‰
) {

709 
LUA_TPROTO
: 
	`luaF_ä“´Ùo
(
L
, 
	`gco2p
(
o
)); ;

710 
LUA_TLCL
: {

711 
	`ä“Lşosu»
(
L
, 
	`gco2lş
(
o
));

714 
LUA_TCCL
: {

715 
	`luaM_ä“mem
(
L
, 
o
, 
	`sizeCşosu»
(
	`gco2cş
(o)->
nupv®ues
));

718 
LUA_TTABLE
: 
	`luaH_ä“
(
L
, 
	`gco2t
(
o
)); ;

719 
LUA_TTHREAD
: 
	`luaE_ä“th»ad
(
L
, 
	`gco2th
(
o
)); ;

720 
LUA_TUSERDATA
: 
	`luaM_ä“mem
(
L
, 
o
, 
	`sizeud©a
(
	`gco2u
(o))); ;

721 
LUA_TSHRSTR
:

722 
	`luaS_»move
(
L
, 
	`gco2ts
(
o
));

723 
	`luaM_ä“mem
(
L
, 
o
, 
	`siz–¡ršg
(
	`gco2ts
(o)->
sh¾’
));

725 
LUA_TLNGSTR
: {

726 
	`luaM_ä“mem
(
L
, 
o
, 
	`siz–¡ršg
(
	`gco2ts
(o)->
u
.
ÊgËn
));

729 : 
	`lua_as£¹
(0);

731 
	}
}

734 
	#sw“pwhŞ–i¡
(
L
,
p
è
	`sw“¶i¡
(L,p,
MAX_LUMEM
)

	)

735 
GCObjeù
 **
sw“¶i¡
 (
lua_S‹
 *
L
, GCObjeù **
p
, 
lu_mem
 
couÁ
);

745 
GCObjeù
 **
	$sw“¶i¡
 (
lua_S‹
 *
L
, 
GCObjeù
 **
p
, 
lu_mem
 
couÁ
) {

746 
glob®_S‹
 *
g
 = 
	`G
(
L
);

747 
ow
 = 
	`Ùh”wh™e
(
g
);

748 
wh™e
 = 
	`luaC_wh™e
(
g
);

749 *
p
 !ğ
NULL
 && 
couÁ
-- > 0) {

750 
GCObjeù
 *
cu¼
 = *
p
;

751 
m¬ked
 = 
cu¼
->marked;

752 ià(
	`isd—dm
(
ow
, 
m¬ked
)) {

753 *
p
 = 
cu¼
->
Ãxt
;

754 
	`ä“obj
(
L
, 
cu¼
);

757 
cu¼
->
m¬ked
 = 
	`ÿ¡_by‹
((m¬ked & 
maskcŞÜs
è| 
wh™e
);

758 
p
 = &
cu¼
->
Ãxt
;

761  (*
p
 =ğ
NULL
) ? NULL :…;

762 
	}
}

768 
GCObjeù
 **
	$sw“±Şive
 (
lua_S‹
 *
L
, 
GCObjeù
 **
p
) {

769 
GCObjeù
 **
Şd
 = 
p
;

771 
p
 = 
	`sw“¶i¡
(
L
,…, 1);

772 } 
p
 =ğ
Şd
);

773  
p
;

774 
	}
}

788 
	$checkSizes
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

789 ià(
g
->
gckšd
 !ğ
KGC_EMERGENCY
) {

790 
l_mem
 
Şddebt
 = 
g
->
GCdebt
;

791 ià(
g
->
¡¹
.
nu£
 < g->¡¹.
size
 / 4)

792 
	`luaS_»size
(
L
, 
g
->
¡¹
.
size
 / 2);

793 
g
->
GCe¡im©e
 +ğg->
GCdebt
 - 
Şddebt
;

795 
	}
}

798 
GCObjeù
 *
	$ud©a2fš®ize
 (
glob®_S‹
 *
g
) {

799 
GCObjeù
 *
o
 = 
g
->
tobeâz
;

800 
	`lua_as£¹
(
	`tofš®ize
(
o
));

801 
g
->
tobeâz
 = 
o
->
Ãxt
;

802 
o
->
Ãxt
 = 
g
->
®lgc
;

803 
g
->
®lgc
 = 
o
;

804 
	`»£tb™
(
o
->
m¬ked
, 
FINALIZEDBIT
);

805 ià(
	`issw“µha£
(
g
))

806 
	`makewh™e
(
g
, 
o
);

807  
o
;

808 
	}
}

811 
	$dÙheÿÎ
 (
lua_S‹
 *
L
, *
ud
) {

812 
	`UNUSED
(
ud
);

813 
	`luaD_ÿÎnoy›ld
(
L
, L->
tİ
 - 2, 0);

814 
	}
}

817 
	$GCTM
 (
lua_S‹
 *
L
, 
´İag©“¼Üs
) {

818 
glob®_S‹
 *
g
 = 
	`G
(
L
);

819 cÚ¡ 
TV®ue
 *
tm
;

820 
TV®ue
 
v
;

821 
	`£tgcov®ue
(
L
, &
v
, 
	`ud©a2fš®ize
(
g
));

822 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, &
v
, 
TM_GC
);

823 ià(
tm
 !ğ
NULL
 && 
	`‰isfunùiÚ
(tm)) {

824 
¡©us
;

825 
lu_by‹
 
Şdah
 = 
L
->
®lowhook
;

826 
ruÂšg
 = 
g
->
güuÂšg
;

827 
L
->
®lowhook
 = 0;

828 
g
->
güuÂšg
 = 0;

829 
	`£tobj2s
(
L
, L->
tİ
, 
tm
);

830 
	`£tobj2s
(
L
, L->
tİ
 + 1, &
v
);

831 
L
->
tİ
 += 2;

832 
L
->
ci
->
ÿÎ¡©us
 |ğ
CIST_FIN
;

833 
¡©us
 = 
	`luaD_pÿÎ
(
L
, 
dÙheÿÎ
, 
NULL
, 
	`§ve¡ack
(L, L->
tİ
 - 2), 0);

834 
L
->
ci
->
ÿÎ¡©us
 &ğ~
CIST_FIN
;

835 
L
->
®lowhook
 = 
Şdah
;

836 
g
->
güuÂšg
 = 
ruÂšg
;

837 ià(
¡©us
 !ğ
LUA_OK
 && 
´İag©“¼Üs
) {

838 ià(
¡©us
 =ğ
LUA_ERRRUN
) {

839 cÚ¡ *
msg
 = (
	`‰is¡ršg
(
L
->
tİ
 - 1))

840 ? 
	`sv®ue
(
L
->
tİ
 - 1)

842 
	`luaO_pushf¡ršg
(
L
, "”rÜ iÀ__gøm‘am‘hod (%s)", 
msg
);

843 
¡©us
 = 
LUA_ERRGCMM
;

845 
	`luaD_throw
(
L
, 
¡©us
);

848 
	}
}

854 
	$ruÇãwfš®iz”s
 (
lua_S‹
 *
L
) {

855 
glob®_S‹
 *
g
 = 
	`G
(
L
);

856 
i
;

857 
	`lua_as£¹
(!
g
->
tobeâz
 || g->
gcfšnum
 > 0);

858 
i
 = 0; 
g
->
tobeâz
 && i < g->
gcfšnum
; i++)

859 
	`GCTM
(
L
, 1);

860 
g
->
gcfšnum
 = (!g->
tobeâz
) ? 0

861 : 
g
->
gcfšnum
 * 2;

862  
i
;

863 
	}
}

869 
	$ÿÎ®Í’dšgfš®iz”s
 (
lua_S‹
 *
L
) {

870 
glob®_S‹
 *
g
 = 
	`G
(
L
);

871 
g
->
tobeâz
)

872 
	`GCTM
(
L
, 0);

873 
	}
}

879 
GCObjeù
 **
	$fšdÏ¡
 (
GCObjeù
 **
p
) {

880 *
p
 !ğ
NULL
)

881 
p
 = &(*p)->
Ãxt
;

882  
p
;

883 
	}
}

890 
	$£·¿‹tobeâz
 (
glob®_S‹
 *
g
, 
®l
) {

891 
GCObjeù
 *
cu¼
;

892 
GCObjeù
 **
p
 = &
g
->
fšobj
;

893 
GCObjeù
 **
Ï¡Ãxt
 = 
	`fšdÏ¡
(&
g
->
tobeâz
);

894 (
cu¼
 = *
p
è!ğ
NULL
) {

895 
	`lua_as£¹
(
	`tofš®ize
(
cu¼
));

896 ià(!(
	`iswh™e
(
cu¼
è|| 
®l
))

897 
p
 = &
cu¼
->
Ãxt
;

899 *
p
 = 
cu¼
->
Ãxt
;

900 
cu¼
->
Ãxt
 = *
Ï¡Ãxt
;

901 *
Ï¡Ãxt
 = 
cu¼
;

902 
Ï¡Ãxt
 = &
cu¼
->
Ãxt
;

905 
	}
}

912 
	$luaC_checkfš®iz”
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, 
TabË
 *
mt
) {

913 
glob®_S‹
 *
g
 = 
	`G
(
L
);

914 ià(
	`tofš®ize
(
o
) ||

915 
	`gç¡tm
(
g
, 
mt
, 
TM_GC
è=ğ
NULL
)

918 
GCObjeù
 **
p
;

919 ià(
	`issw“µha£
(
g
)) {

920 
	`makewh™e
(
g
, 
o
);

921 ià(
g
->
sw“pgc
 =ğ&
o
->
Ãxt
)

922 
g
->
sw“pgc
 = 
	`sw“±Şive
(
L
, g->sweepgc);

925 
p
 = &
g
->
®lgc
; *°!ğ
o
;… = &(*p)->
Ãxt
) { }

926 *
p
 = 
o
->
Ãxt
;

927 
o
->
Ãxt
 = 
g
->
fšobj
;

928 
g
->
fšobj
 = 
o
;

929 
	`l_£tb™
(
o
->
m¬ked
, 
FINALIZEDBIT
);

931 
	}
}

950 
	$£au£
 (
glob®_S‹
 *
g
) {

951 
l_mem
 
th»shŞd
, 
debt
;

952 
l_mem
 
e¡im©e
 = 
g
->
GCe¡im©e
 / 
PAUSEADJ
;

953 
	`lua_as£¹
(
e¡im©e
 > 0);

954 
th»shŞd
 = (
g
->
gıau£
 < 
MAX_LMEM
 / 
e¡im©e
)

955 ? 
e¡im©e
 * 
g
->
gıau£


956 : 
MAX_LMEM
;

957 
debt
 = 
	`g‘tÙ®by‹s
(
g
è- 
th»shŞd
;

958 
	`luaE_£tdebt
(
g
, 
debt
);

959 
	}
}

969 
	$’‹rsw“p
 (
lua_S‹
 *
L
) {

970 
glob®_S‹
 *
g
 = 
	`G
(
L
);

971 
g
->
gc¡©e
 = 
GCSsw·Îgc
;

972 
	`lua_as£¹
(
g
->
sw“pgc
 =ğ
NULL
);

973 
g
->
sw“pgc
 = 
	`sw“¶i¡
(
L
, &g->
®lgc
, 1);

974 
	}
}

977 
	$luaC_ä“®lobjeùs
 (
lua_S‹
 *
L
) {

978 
glob®_S‹
 *
g
 = 
	`G
(
L
);

979 
	`£·¿‹tobeâz
(
g
, 1);

980 
	`lua_as£¹
(
g
->
fšobj
 =ğ
NULL
);

981 
	`ÿÎ®Í’dšgfš®iz”s
(
L
);

982 
	`lua_as£¹
(
g
->
tobeâz
 =ğ
NULL
);

983 
g
->
cu¼’twh™e
 = 
WHITEBITS
;

984 
g
->
gckšd
 = 
KGC_NORMAL
;

985 
	`sw“pwhŞ–i¡
(
L
, &
g
->
fšobj
);

986 
	`sw“pwhŞ–i¡
(
L
, &
g
->
®lgc
);

987 
	`sw“pwhŞ–i¡
(
L
, &
g
->
fixedgc
);

988 
	`lua_as£¹
(
g
->
¡¹
.
nu£
 == 0);

989 
	}
}

992 
l_mem
 
	$©omic
 (
lua_S‹
 *
L
) {

993 
glob®_S‹
 *
g
 = 
	`G
(
L
);

994 
l_mem
 
wÜk
;

995 
GCObjeù
 *
Üigw—k
, *
Üig®l
;

996 
GCObjeù
 *
g¿yagaš
 = 
g
->grayagain;

997 
	`lua_as£¹
(
g
->
•hem”Ú
 =ğ
NULL
 && g->
w—k
 == NULL);

998 
	`lua_as£¹
(!
	`iswh™e
(
g
->
mašth»ad
));

999 
g
->
gc¡©e
 = 
GCSšsid—tomic
;

1000 
g
->
GCmemŒav
 = 0;

1001 
	`m¬kobjeù
(
g
, 
L
);

1003 
	`m¬kv®ue
(
g
, &g->
l_»gi¡ry
);

1004 
	`m¬kmt
(
g
);

1006 
	`»m¬kupv®s
(
g
);

1007 
	`´İag©—Î
(
g
);

1008 
wÜk
 = 
g
->
GCmemŒav
;

1009 
g
->
g¿y
 = 
g¿yagaš
;

1010 
	`´İag©—Î
(
g
);

1011 
g
->
GCmemŒav
 = 0;

1012 
	`cÚv”g“phem”Ús
(
g
);

1015 
	`ş—rv®ues
(
g
, g->
w—k
, 
NULL
);

1016 
	`ş—rv®ues
(
g
, g->
®lw—k
, 
NULL
);

1017 
Üigw—k
 = 
g
->
w—k
; 
Üig®l
 = g->
®lw—k
;

1018 
wÜk
 +ğ
g
->
GCmemŒav
;

1019 
	`£·¿‹tobeâz
(
g
, 0);

1020 
g
->
gcfšnum
 = 1;

1021 
	`m¬kbešgâz
(
g
);

1022 
	`´İag©—Î
(
g
);

1023 
g
->
GCmemŒav
 = 0;

1024 
	`cÚv”g“phem”Ús
(
g
);

1027 
	`ş—rkeys
(
g
, g->
•hem”Ú
, 
NULL
);

1028 
	`ş—rkeys
(
g
, g->
®lw—k
, 
NULL
);

1030 
	`ş—rv®ues
(
g
, g->
w—k
, 
Üigw—k
);

1031 
	`ş—rv®ues
(
g
, g->
®lw—k
, 
Üig®l
);

1032 
	`luaS_ş—rÿche
(
g
);

1033 
g
->
cu¼’twh™e
 = 
	`ÿ¡_by‹
(
	`Ùh”wh™e
(g));

1034 
wÜk
 +ğ
g
->
GCmemŒav
;

1035  
wÜk
;

1036 
	}
}

1039 
lu_mem
 
	$sw“p¡•
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
,

1040 
Ãxt¡©e
, 
GCObjeù
 **
Ãxi¡
) {

1041 ià(
g
->
sw“pgc
) {

1042 
l_mem
 
Şddebt
 = 
g
->
GCdebt
;

1043 
g
->
sw“pgc
 = 
	`sw“¶i¡
(
L
, g->sw“pgc, 
GCSWEEPMAX
);

1044 
g
->
GCe¡im©e
 +ğg->
GCdebt
 - 
Şddebt
;

1045 ià(
g
->
sw“pgc
)

1046  (
GCSWEEPMAX
 * 
GCSWEEPCOST
);

1049 
g
->
gc¡©e
 = 
Ãxt¡©e
;

1050 
g
->
sw“pgc
 = 
Ãxi¡
;

1052 
	}
}

1055 
lu_mem
 
	$sšgË¡•
 (
lua_S‹
 *
L
) {

1056 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1057 
g
->
gc¡©e
) {

1058 
GCS·u£
: {

1059 
g
->
GCmemŒav
 = g->
¡¹
.
size
 * (
GCObjeù
*);

1060 
	`»¡¬tcŞËùiÚ
(
g
);

1061 
g
->
gc¡©e
 = 
GCS´İag©e
;

1062  
g
->
GCmemŒav
;

1064 
GCS´İag©e
: {

1065 
g
->
GCmemŒav
 = 0;

1066 
	`lua_as£¹
(
g
->
g¿y
);

1067 
	`´İag©em¬k
(
g
);

1068 ià(
g
->
g¿y
 =ğ
NULL
)

1069 
g
->
gc¡©e
 = 
GCS©omic
;

1070  
g
->
GCmemŒav
;

1072 
GCS©omic
: {

1073 
lu_mem
 
wÜk
;

1074 
	`´İag©—Î
(
g
);

1075 
wÜk
 = 
	`©omic
(
L
);

1076 
	`’‹rsw“p
(
L
);

1077 
g
->
GCe¡im©e
 = 
	`g‘tÙ®by‹s
(g); ;

1078  
wÜk
;

1080 
GCSsw·Îgc
: {

1081  
	`sw“p¡•
(
L
, 
g
, 
GCSswpfšobj
, &g->
fšobj
);

1083 
GCSswpfšobj
: {

1084  
	`sw“p¡•
(
L
, 
g
, 
GCSsw±obeâz
, &g->
tobeâz
);

1086 
GCSsw±obeâz
: {

1087  
	`sw“p¡•
(
L
, 
g
, 
GCSsw³nd
, 
NULL
);

1089 
GCSsw³nd
: {

1090 
	`makewh™e
(
g
, g->
mašth»ad
);

1091 
	`checkSizes
(
L
, 
g
);

1092 
g
->
gc¡©e
 = 
GCSÿÎfš
;

1095 
GCSÿÎfš
: {

1096 ià(
g
->
tobeâz
 && g->
gckšd
 !ğ
KGC_EMERGENCY
) {

1097 
n
 = 
	`ruÇãwfš®iz”s
(
L
);

1098  (
n
 * 
GCFINALIZECOST
);

1101 
g
->
gc¡©e
 = 
GCS·u£
;

1105 : 
	`lua_as£¹
(0);  0;

1107 
	}
}

1114 
	$luaC_ruÁ¡©e
 (
lua_S‹
 *
L
, 
¡©esmask
) {

1115 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1116 !
	`‹¡b™
(
¡©esmask
, 
g
->
gc¡©e
))

1117 
	`sšgË¡•
(
L
);

1118 
	}
}

1125 
l_mem
 
	$g‘debt
 (
glob®_S‹
 *
g
) {

1126 
l_mem
 
debt
 = 
g
->
GCdebt
;

1127 
¡•mul
 = 
g
->
gc¡•mul
;

1128 ià(
debt
 <= 0)  0;

1130 
debt
 = (debˆ/ 
STEPMULADJ
) + 1;

1131 
debt
 = (debˆ< 
MAX_LMEM
 / 
¡•mul
) ? debt * stepmul : MAX_LMEM;

1132  
debt
;

1134 
	}
}

1139 
	$luaC_¡•
 (
lua_S‹
 *
L
) {

1140 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1141 
l_mem
 
debt
 = 
	`g‘debt
(
g
);

1142 ià(!
g
->
güuÂšg
) {

1143 
	`luaE_£tdebt
(
g
, -
GCSTEPSIZE
 * 10);

1147 
lu_mem
 
wÜk
 = 
	`sšgË¡•
(
L
);

1148 
debt
 -ğ
wÜk
;

1149 } 
debt
 > -
GCSTEPSIZE
 && 
g
->
gc¡©e
 !ğ
GCS·u£
);

1150 ià(
g
->
gc¡©e
 =ğ
GCS·u£
)

1151 
	`£au£
(
g
);

1153 
debt
 = (debˆ/ 
g
->
gc¡•mul
è* 
STEPMULADJ
;

1154 
	`luaE_£tdebt
(
g
, 
debt
);

1155 
	`ruÇãwfš®iz”s
(
L
);

1157 
	}
}

1169 
	$luaC_fuÎgc
 (
lua_S‹
 *
L
, 
i£m”g’cy
) {

1170 
glob®_S‹
 *
g
 = 
	`G
(
L
);

1171 
	`lua_as£¹
(
g
->
gckšd
 =ğ
KGC_NORMAL
);

1172 ià(
i£m”g’cy
è
g
->
gckšd
 = 
KGC_EMERGENCY
;

1173 ià(
	`k“pšv¬ŸÁ
(
g
)) {

1174 
	`’‹rsw“p
(
L
);

1177 
	`luaC_ruÁ¡©e
(
L
, 
	`b™mask
(
GCS·u£
));

1178 
	`luaC_ruÁ¡©e
(
L
, ~
	`b™mask
(
GCS·u£
));

1179 
	`luaC_ruÁ¡©e
(
L
, 
	`b™mask
(
GCSÿÎfš
));

1181 
	`lua_as£¹
(
g
->
GCe¡im©e
 =ğ
	`g‘tÙ®by‹s
(g));

1182 
	`luaC_ruÁ¡©e
(
L
, 
	`b™mask
(
GCS·u£
));

1183 
g
->
gckšd
 = 
KGC_NORMAL
;

1184 
	`£au£
(
g
);

1185 
	}
}

	@3rd/lua/lgc.h

7 #iâdeà
lgc_h


8 
	#lgc_h


	)

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

30 #ià!
defšed
(
GCSTEPSIZE
)

32 
	#GCSTEPSIZE
 (
	`ÿ¡_št
(100 * (
TSŒšg
)))

	)

39 
	#GCS´İag©e
 0

	)

40 
	#GCS©omic
 1

	)

41 
	#GCSsw·Îgc
 2

	)

42 
	#GCSswpfšobj
 3

	)

43 
	#GCSsw±obeâz
 4

	)

44 
	#GCSsw³nd
 5

	)

45 
	#GCSÿÎfš
 6

	)

46 
	#GCS·u£
 7

	)

49 
	#issw“µha£
(
g
) \

50 (
GCSsw·Îgc
 <ğ(
g
)->
gc¡©e
 && (g)->gc¡©<ğ
GCSsw³nd
)

	)

61 
	#k“pšv¬ŸÁ
(
g
è((g)->
gc¡©e
 <ğ
GCS©omic
)

	)

67 
	#»£tb™s
(
x
,
m
è((xè&ğ
	`ÿ¡
(
lu_by‹
, ~(m)))

	)

68 
	#£tb™s
(
x
,
m
è((xè|ğ(m))

	)

69 
	#‹¡b™s
(
x
,
m
è((xè& (m))

	)

70 
	#b™mask
(
b
è(1<<(b))

	)

71 
	#b™2mask
(
b1
,
b2
è(
	`b™mask
(b1è| b™mask(b2))

	)

72 
	#l_£tb™
(
x
,
b
è
	`£tb™s
(x, 
	`b™mask
(b))

	)

73 
	#»£tb™
(
x
,
b
è
	`»£tb™s
(x, 
	`b™mask
(b))

	)

74 
	#‹¡b™
(
x
,
b
è
	`‹¡b™s
(x, 
	`b™mask
(b))

	)

78 
	#WHITE0BIT
 0

	)

79 
	#WHITE1BIT
 1

	)

80 
	#BLACKBIT
 2

	)

81 
	#FINALIZEDBIT
 3

	)

84 
	#WHITEBITS
 
	`b™2mask
(
WHITE0BIT
, 
WHITE1BIT
)

	)

87 
	#iswh™e
(
x
è
	`‹¡b™s
((x)->
m¬ked
, 
WHITEBITS
)

	)

88 
	#isbÏck
(
x
è
	`‹¡b™
((x)->
m¬ked
, 
BLACKBIT
)

	)

89 
	#isg¿y
(
x
) \

90 (!
	`‹¡b™s
((
x
)->
m¬ked
, 
WHITEBITS
 | 
	`b™mask
(
BLACKBIT
)))

	)

92 
	#tofš®ize
(
x
è
	`‹¡b™
((x)->
m¬ked
, 
FINALIZEDBIT
)

	)

94 
	#Ùh”wh™e
(
g
è((g)->
cu¼’twh™e
 ^ 
WHITEBITS
)

	)

95 
	#isd—dm
(
ow
,
m
è(!(((mè^ 
WHITEBITS
è& (ow)))

	)

96 
	#isd—d
(
g
,
v
è
	`isd—dm
(
	`Ùh”wh™e
(g), (v)->
m¬ked
)

	)

98 
	#chªgewh™e
(
x
è((x)->
m¬ked
 ^ğ
WHITEBITS
)

	)

99 
	#g¿y2bÏck
(
x
è
	`l_£tb™
((x)->
m¬ked
, 
BLACKBIT
)

	)

101 
	#luaC_wh™e
(
g
è
	`ÿ¡
(
lu_by‹
, (g)->
cu¼’twh™e
 & 
WHITEBITS
)

	)

110 
	#luaC_cÚdGC
(
L
,
´e
,
pos
) \

111 { ià(
	`G
(
L
)->
GCdebt
 > 0è{ 
´e
; 
	`luaC_¡•
(L); 
pos
;}; \

112 
	`cÚdchªgemem
(
L
,
´e
,
pos
); }

	)

115 
	#luaC_checkGC
(
L
è
	`luaC_cÚdGC
(L,()0,()0)

	)

118 
	#luaC_b¬r›r
(
L
,
p
,
v
) ( \

119 (
	`iscŞËùabË
(
v
è&& 
	`isbÏck
(
p
è&& 
	`iswh™e
(
	`gcv®ue
(v))) ? \

120 
	`luaC_b¬r›r_
(
L
,
	`obj2gco
(
p
),
	`gcv®ue
(
v
)è: 
	`ÿ¡_void
(0))

	)

122 
	#luaC_b¬r›rback
(
L
,
p
,
v
) ( \

123 (
	`iscŞËùabË
(
v
è&& 
	`isbÏck
(
p
è&& 
	`iswh™e
(
	`gcv®ue
(v))) ? \

124 
	`luaC_b¬r›rback_
(
L
,
p
è: 
	`ÿ¡_void
(0))

	)

126 
	#luaC_objb¬r›r
(
L
,
p
,
o
) ( \

127 (
	`isbÏck
(
p
è&& 
	`iswh™e
(
o
)) ? \

128 
	`luaC_b¬r›r_
(
L
,
	`obj2gco
(
p
),obj2gco(
o
)è: 
	`ÿ¡_void
(0))

	)

130 
	#luaC_upv®b¬r›r
(
L
,
uv
) ( \

131 (
	`iscŞËùabË
((
uv
)->
v
è&& !
	`upisİ’
(uv)) ? \

132 
	`luaC_upv®b¬r›r_
(
L
,
uv
è: 
	`ÿ¡_void
(0))

	)

134 
LUAI_FUNC
 
luaC_fix
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
);

135 
LUAI_FUNC
 
luaC_ä“®lobjeùs
 (
lua_S‹
 *
L
);

136 
LUAI_FUNC
 
luaC_¡•
 (
lua_S‹
 *
L
);

137 
LUAI_FUNC
 
luaC_ruÁ¡©e
 (
lua_S‹
 *
L
, 
¡©esmask
);

138 
LUAI_FUNC
 
luaC_fuÎgc
 (
lua_S‹
 *
L
, 
i£m”g’cy
);

139 
LUAI_FUNC
 
GCObjeù
 *
luaC_Ãwobj
 (
lua_S‹
 *
L
, 
‰
, 
size_t
 
sz
);

140 
LUAI_FUNC
 
luaC_b¬r›r_
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, GCObjeù *
v
);

141 
LUAI_FUNC
 
luaC_b¬r›rback_
 (
lua_S‹
 *
L
, 
TabË
 *
o
);

142 
LUAI_FUNC
 
luaC_upv®b¬r›r_
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
);

143 
LUAI_FUNC
 
luaC_checkfš®iz”
 (
lua_S‹
 *
L
, 
GCObjeù
 *
o
, 
TabË
 *
mt
);

144 
LUAI_FUNC
 
luaC_upvdeccouÁ
 (
lua_S‹
 *
L
, 
UpV®
 *
uv
);

	@3rd/lua/linit.c

8 
	#lš™_c


	)

9 
	#LUA_LIB


	)

27 
	~"Í»fix.h
"

30 
	~<¡ddef.h
>

32 
	~"lua.h
"

34 
	~"lu®ib.h
"

35 
	~"Ïuxlib.h
"

42 cÚ¡ 
luaL_Reg
 
	glßdedlibs
[] = {

43 {"_G", 
luaİ’_ba£
},

44 {
LUA_LOADLIBNAME
, 
luaİ’_·ckage
},

45 {
LUA_COLIBNAME
, 
luaİ’_cÜoutše
},

46 {
LUA_TABLIBNAME
, 
luaİ’_bË
},

47 {
LUA_IOLIBNAME
, 
luaİ’_io
},

48 {
LUA_OSLIBNAME
, 
luaİ’_os
},

49 {
LUA_STRLIBNAME
, 
luaİ’_¡ršg
},

50 {
LUA_MATHLIBNAME
, 
luaİ’_m©h
},

51 {
LUA_UTF8LIBNAME
, 
luaİ’_utf8
},

52 {
LUA_DBLIBNAME
, 
luaİ’_debug
},

53 #ià
defšed
(
LUA_COMPAT_BITLIB
)

54 {
LUA_BITLIBNAME
, 
luaİ’_b™32
},

56 {
NULL
, NULL}

60 
LUALIB_API
 
	$luaL_İ’libs
 (
lua_S‹
 *
L
) {

61 cÚ¡ 
luaL_Reg
 *
lib
;

63 
lib
 = 
lßdedlibs
;†ib->
func
;†ib++) {

64 
	`luaL_»quœef
(
L
, 
lib
->
Çme
,†ib->
func
, 1);

65 
	`lua_pİ
(
L
, 1);

67 
	}
}

	@3rd/lua/liolib.c

7 
	#liŞib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<ùy³.h
>

14 
	~<”ºo.h
>

15 
	~<loÿË.h
>

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

20 
	~"lua.h
"

22 
	~"Ïuxlib.h
"

23 
	~"lu®ib.h
"

32 #ià!
defšed
(
l_checkmode
)

35 #ià!
defšed
(
L_MODEEXT
)

36 
	#L_MODEEXT
 "b"

	)

40 
	$l_checkmode
 (cÚ¡ *
mode
) {

41  (*
mode
 !ğ'\0' && 
	`¡rchr
("rwa", *(mode++)è!ğ
NULL
 &&

42 (*
mode
 != '+' || (++mode, 1)) &&

43 (
	`¡r¥n
(
mode
, 
L_MODEEXT
è=ğ
	`¡¾’
(mode)));

44 
	}
}

55 #ià!
defšed
(
l_pİ’
)

57 #ià
defšed
(
LUA_USE_POSIX
)

59 
	#l_pİ’
(
L
,
c
,
m
è(
	`fæush
(
NULL
), 
	`pİ’
(c,m))

	)

60 
	#l_pşo£
(
L
,
fe
è(
	`pşo£
(fe))

	)

62 #–ià
defšed
(
LUA_USE_WINDOWS
)

64 
	#l_pİ’
(
L
,
c
,
m
è(
	`_pİ’
(c,m))

	)

65 
	#l_pşo£
(
L
,
fe
è(
	`_pşo£
(fe))

	)

70 
	#l_pİ’
(
L
,
c
,
m
) \

71 (()(()
c
, 
m
), \

72 
	`luaL_”rÜ
(
L
, "'popen'‚ot supported"), \

73 (
FILE
*)0)

	)

74 
	#l_pşo£
(
L
,
fe
è(()L, ()fe, -1)

	)

83 #ià!
defšed
(
l_g‘c
)

85 #ià
defšed
(
LUA_USE_POSIX
)

86 
	#l_g‘c
(
f
è
	`g‘c_uÆocked
(f)

	)

87 
	#l_lockfe
(
f
è
	`æockfe
(f)

	)

88 
	#l_uÆockfe
(
f
è
	`fuÆockfe
(f)

	)

90 
	#l_g‘c
(
f
è
	`g‘c
(f)

	)

91 
	#l_lockfe
(
f
è(()0)

	)

92 
	#l_uÆockfe
(
f
è(()0)

	)

104 #ià!
defšed
(
l_f£ek
)

106 #ià
defšed
(
LUA_USE_POSIX
)

108 
	~<sys/ty³s.h
>

110 
	#l_f£ek
(
f
,
o
,
w
è
	`f£eko
(f,o,w)

	)

111 
	#l_á–l
(
f
è
	`á–lo
(f)

	)

112 
	#l_£eknum
 
off_t


	)

114 #–ià
defšed
(
LUA_USE_WINDOWS
è&& !defšed(
_CRTIMP_TYPEINFO
) \

115 && 
defšed
(
_MSC_VER
è&& (
	g_MSC_VER
 >= 1400)

118 
	#l_f£ek
(
f
,
o
,
w
è
	`_f£eki64
(f,o,w)

	)

119 
	#l_á–l
(
f
è
	`_á–li64
(f)

	)

120 
	#l_£eknum
 
__št64


	)

125 
	#l_f£ek
(
f
,
o
,
w
è
	`f£ek
(f,o,w)

	)

126 
	#l_á–l
(
f
è
	`á–l
(f)

	)

127 
	#l_£eknum
 

	)

136 
	#IO_PREFIX
 "_IO_"

	)

137 
	#IOPREF_LEN
 ((
IO_PREFIX
)/(è- 1)

	)

138 
	#IO_INPUT
 (
IO_PREFIX
 "šput")

	)

139 
	#IO_OUTPUT
 (
IO_PREFIX
 "ouut")

	)

142 
luaL_SŒ—m
 
	tLSŒ—m
;

145 
	#tŞ¡»am
(
L
è((
LSŒ—m
 *)
	`luaL_checkud©a
(L, 1, 
LUA_FILEHANDLE
))

	)

147 
	#isşo£d
(
p
è(Õ)->
şo£f
 =ğ
NULL
)

	)

150 
	$io_ty³
 (
lua_S‹
 *
L
) {

151 
LSŒ—m
 *
p
;

152 
	`luaL_checkªy
(
L
, 1);

153 
p
 = (
LSŒ—m
 *)
	`luaL_‹¡ud©a
(
L
, 1, 
LUA_FILEHANDLE
);

154 ià(
p
 =ğ
NULL
)

155 
	`lua_pushn
(
L
);

156 ià(
	`isşo£d
(
p
))

157 
	`lua_pushl™”®
(
L
, "closed file");

159 
	`lua_pushl™”®
(
L
, "file");

161 
	}
}

164 
	$f_to¡ršg
 (
lua_S‹
 *
L
) {

165 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

166 ià(
	`isşo£d
(
p
))

167 
	`lua_pushl™”®
(
L
, "file (closed)");

169 
	`lua_pushf¡ršg
(
L
, "f(%p)", 
p
->
f
);

171 
	}
}

174 
FILE
 *
	$tofe
 (
lua_S‹
 *
L
) {

175 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

176 ià(
	`isşo£d
(
p
))

177 
	`luaL_”rÜ
(
L
, "attempto use‡ closed file");

178 
	`lua_as£¹
(
p
->
f
);

179  
p
->
f
;

180 
	}
}

188 
LSŒ—m
 *
	$Ãw´efe
 (
lua_S‹
 *
L
) {

189 
LSŒ—m
 *
p
 = (LSŒ—m *)
	`lua_Ãwu£rd©a
(
L
, (LStream));

190 
p
->
şo£f
 = 
NULL
;

191 
	`luaL_£tm‘©abË
(
L
, 
LUA_FILEHANDLE
);

192  
p
;

193 
	}
}

201 
	$aux_şo£
 (
lua_S‹
 *
L
) {

202 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

203 vŞ©
lua_CFunùiÚ
 
cf
 = 
p
->
şo£f
;

204 
p
->
şo£f
 = 
NULL
;

205  (*
cf
)(
L
);

206 
	}
}

209 
	$io_şo£
 (
lua_S‹
 *
L
) {

210 ià(
	`lua_i¢Úe
(
L
, 1))

211 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
IO_OUTPUT
);

212 
	`tofe
(
L
);

213  
	`aux_şo£
(
L
);

214 
	}
}

217 
	$f_gc
 (
lua_S‹
 *
L
) {

218 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

219 ià(!
	`isşo£d
(
p
è&&…->
f
 !ğ
NULL
)

220 
	`aux_şo£
(
L
);

222 
	}
}

228 
	$io_fşo£
 (
lua_S‹
 *
L
) {

229 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

230 
»s
 = 
	`fşo£
(
p
->
f
);

231  
	`luaL_f”esuÉ
(
L
, (
»s
 =ğ0), 
NULL
);

232 
	}
}

235 
LSŒ—m
 *
	$Ãwfe
 (
lua_S‹
 *
L
) {

236 
LSŒ—m
 *
p
 = 
	`Ãw´efe
(
L
);

237 
p
->
f
 = 
NULL
;

238 
p
->
şo£f
 = &
io_fşo£
;

239  
p
;

240 
	}
}

243 
	$İ’check
 (
lua_S‹
 *
L
, cÚ¡ *
âame
, cÚ¡ *
mode
) {

244 
LSŒ—m
 *
p
 = 
	`Ãwfe
(
L
);

245 
p
->
f
 = 
	`fİ’
(
âame
, 
mode
);

246 ià(
p
->
f
 =ğ
NULL
)

247 
	`luaL_”rÜ
(
L
, "ÿÂÙ o³Àf'%s' (%s)", 
âame
, 
	`¡»¼Ü
(
”ºo
));

248 
	}
}

251 
	$io_İ’
 (
lua_S‹
 *
L
) {

252 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

253 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, "r");

254 
LSŒ—m
 *
p
 = 
	`Ãwfe
(
L
);

255 cÚ¡ *
md
 = 
mode
;

256 
	`luaL_¬gcheck
(
L
, 
	`l_checkmode
(
md
), 2, "invalid mode");

257 
p
->
f
 = 
	`fİ’
(
f’ame
, 
mode
);

258  (
p
->
f
 =ğ
NULL
è? 
	`luaL_f”esuÉ
(
L
, 0, 
f’ame
) : 1;

259 
	}
}

265 
	$io_pşo£
 (
lua_S‹
 *
L
) {

266 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

267  
	`luaL_exeüesuÉ
(
L
, 
	`l_pşo£
(L, 
p
->
f
));

268 
	}
}

271 
	$io_pİ’
 (
lua_S‹
 *
L
) {

272 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

273 cÚ¡ *
mode
 = 
	`luaL_İt¡ršg
(
L
, 2, "r");

274 
LSŒ—m
 *
p
 = 
	`Ãw´efe
(
L
);

275 
p
->
f
 = 
	`l_pİ’
(
L
, 
f’ame
, 
mode
);

276 
p
->
şo£f
 = &
io_pşo£
;

277  (
p
->
f
 =ğ
NULL
è? 
	`luaL_f”esuÉ
(
L
, 0, 
f’ame
) : 1;

278 
	}
}

281 
	$io_tmpfe
 (
lua_S‹
 *
L
) {

282 
LSŒ—m
 *
p
 = 
	`Ãwfe
(
L
);

283 
p
->
f
 = 
	`tmpfe
();

284  (
p
->
f
 =ğ
NULL
è? 
	`luaL_f”esuÉ
(
L
, 0, NULL) : 1;

285 
	}
}

288 
FILE
 *
	$g‘iofe
 (
lua_S‹
 *
L
, cÚ¡ *
fšdex
) {

289 
LSŒ—m
 *
p
;

290 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
fšdex
);

291 
p
 = (
LSŒ—m
 *)
	`lua_tou£rd©a
(
L
, -1);

292 ià(
	`isşo£d
(
p
))

293 
	`luaL_”rÜ
(
L
, "¡ªd¬d % fi şo£d", 
fšdex
 + 
IOPREF_LEN
);

294  
p
->
f
;

295 
	}
}

298 
	$g_iofe
 (
lua_S‹
 *
L
, cÚ¡ *
f
, cÚ¡ *
mode
) {

299 ià(!
	`lua_i¢ÚeÜn
(
L
, 1)) {

300 cÚ¡ *
f’ame
 = 
	`lua_to¡ršg
(
L
, 1);

301 ià(
f’ame
)

302 
	`İ’check
(
L
, 
f’ame
, 
mode
);

304 
	`tofe
(
L
);

305 
	`lua_pushv®ue
(
L
, 1);

307 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
f
);

310 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
f
);

312 
	}
}

315 
	$io_šput
 (
lua_S‹
 *
L
) {

316  
	`g_iofe
(
L
, 
IO_INPUT
, "r");

317 
	}
}

320 
	$io_ouut
 (
lua_S‹
 *
L
) {

321  
	`g_iofe
(
L
, 
IO_OUTPUT
, "w");

322 
	}
}

325 
io_»adlše
 (
lua_S‹
 *
L
);

332 
	#MAXARGLINE
 250

	)

334 
	$aux_lšes
 (
lua_S‹
 *
L
, 
toşo£
) {

335 
n
 = 
	`lua_g‘tİ
(
L
) - 1;

336 
	`luaL_¬gcheck
(
L
, 
n
 <ğ
MAXARGLINE
, MAXARGLINE + 2, "too many‡rguments");

337 
	`lua_pushš‹g”
(
L
, 
n
);

338 
	`lua_pushboŞ—n
(
L
, 
toşo£
);

339 
	`lua_rÙ©e
(
L
, 2, 2);

340 
	`lua_pushcşosu»
(
L
, 
io_»adlše
, 3 + 
n
);

341 
	}
}

344 
	$f_lšes
 (
lua_S‹
 *
L
) {

345 
	`tofe
(
L
);

346 
	`aux_lšes
(
L
, 0);

348 
	}
}

351 
	$io_lšes
 (
lua_S‹
 *
L
) {

352 
toşo£
;

353 ià(
	`lua_i¢Úe
(
L
, 1)è
	`lua_pushn
(L);

354 ià(
	`lua_i¢
(
L
, 1)) {

355 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
IO_INPUT
);

356 
	`lua_»¶aû
(
L
, 1);

357 
	`tofe
(
L
);

358 
toşo£
 = 0;

361 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

362 
	`İ’check
(
L
, 
f’ame
, "r");

363 
	`lua_»¶aû
(
L
, 1);

364 
toşo£
 = 1;

366 
	`aux_lšes
(
L
, 
toşo£
);

368 
	}
}

379 #ià!
defšed
 (
L_MAXLENNUM
)

380 
	#L_MAXLENNUM
 200

	)

386 
FILE
 *
	mf
;

387 
	mc
;

388 
	mn
;

389 
	mbuff
[
L_MAXLENNUM
 + 1];

390 } 
	tRN
;

396 
	$Ãxtc
 (
RN
 *
º
) {

397 ià(
º
->
n
 >ğ
L_MAXLENNUM
) {

398 
º
->
buff
[0] = '\0';

402 
º
->
buff
[º->
n
++] =„n->
c
;

403 
º
->
c
 = 
	`l_g‘c
Ôn->
f
);

406 
	}
}

412 
	$‹¡2
 (
RN
 *
º
, cÚ¡ *
£t
) {

413 ià(
º
->
c
 =ğ
£t
[0] ||„n->c == set[1])

414  
	`Ãxtc
(
º
);

416 
	}
}

422 
	$»addig™s
 (
RN
 *
º
, 
hex
) {

423 
couÁ
 = 0;

424 (
hex
 ? 
	`isxdig™
(
º
->
c
è: 
	`isdig™
Ôn->c)è&& 
	`Ãxtc
(rn))

425 
couÁ
++;

426  
couÁ
;

427 
	}
}

435 
	$»ad_numb”
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

436 
RN
 
º
;

437 
couÁ
 = 0;

438 
hex
 = 0;

439 
deı
[2];

440 
º
.
f
 = f;„n.
n
 = 0;

441 
deı
[0] = 
	`lua_g‘loÿËdeıošt
();

442 
deı
[1] = '.';

443 
	`l_lockfe
(
º
.
f
);

444 dØ{ 
º
.
c
 = 
	`l_g‘c
Ôn.
f
); } 
	`is¥aû
(rn.c));

445 
	`‹¡2
(&
º
, "-+");

446 ià(
	`‹¡2
(&
º
, "00")) {

447 ià(
	`‹¡2
(&
º
, "xX")è
hex
 = 1;

448 
couÁ
 = 1;

450 
couÁ
 +ğ
	`»addig™s
(&
º
, 
hex
);

451 ià(
	`‹¡2
(&
º
, 
deı
))

452 
couÁ
 +ğ
	`»addig™s
(&
º
, 
hex
);

453 ià(
couÁ
 > 0 && 
	`‹¡2
(&
º
, (
hex
 ? "pP" : "eE"))) {

454 
	`‹¡2
(&
º
, "-+");

455 
	`»addig™s
(&
º
, 0);

457 
	`ung‘c
(
º
.
c
,„n.
f
);

458 
	`l_uÆockfe
(
º
.
f
);

459 
º
.
buff
[º.
n
] = '\0';

460 ià(
	`lua_¡ršgtÚumb”
(
L
, 
º
.
buff
))

463 
	`lua_pushn
(
L
);

466 
	}
}

469 
	$‹¡_eof
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

470 
c
 = 
	`g‘c
(
f
);

471 
	`ung‘c
(
c
, 
f
);

472 
	`lua_pushl™”®
(
L
, "");

473  (
c
 !ğ
EOF
);

474 
	}
}

477 
	$»ad_lše
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
chİ
) {

478 
luaL_Bufãr
 
b
;

479 
c
 = '\0';

480 
	`luaL_buffš™
(
L
, &
b
);

481 
c
 !ğ
EOF
 && c != '\n') {

482 *
buff
 = 
	`luaL_´•bufãr
(&
b
);

483 
i
 = 0;

484 
	`l_lockfe
(
f
);

485 
i
 < 
LUAL_BUFFERSIZE
 && (
c
 = 
	`l_g‘c
(
f
)è!ğ
EOF
 && c != '\n')

486 
buff
[
i
++] = 
c
;

487 
	`l_uÆockfe
(
f
);

488 
	`luaL_addsize
(&
b
, 
i
);

490 ià(!
chİ
 && 
c
 == '\n')

491 
	`luaL_addch¬
(&
b
, 
c
);

492 
	`luaL_push»suÉ
(&
b
);

494  (
c
 =ğ'\n' || 
	`lua_¿wËn
(
L
, -1) > 0);

495 
	}
}

498 
	$»ad_®l
 (
lua_S‹
 *
L
, 
FILE
 *
f
) {

499 
size_t
 
Ä
;

500 
luaL_Bufãr
 
b
;

501 
	`luaL_buffš™
(
L
, &
b
);

503 *
p
 = 
	`luaL_´•bufãr
(&
b
);

504 
Ä
 = 
	`ä—d
(
p
, (), 
LUAL_BUFFERSIZE
, 
f
);

505 
	`luaL_addsize
(&
b
, 
Ä
);

506 } 
Ä
 =ğ
LUAL_BUFFERSIZE
);

507 
	`luaL_push»suÉ
(&
b
);

508 
	}
}

511 
	$»ad_ch¬s
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
size_t
 
n
) {

512 
size_t
 
Ä
;

513 *
p
;

514 
luaL_Bufãr
 
b
;

515 
	`luaL_buffš™
(
L
, &
b
);

516 
p
 = 
	`luaL_´•buffsize
(&
b
, 
n
);

517 
Ä
 = 
	`ä—d
(
p
, (), 
n
, 
f
);

518 
	`luaL_addsize
(&
b
, 
Ä
);

519 
	`luaL_push»suÉ
(&
b
);

520  (
Ä
 > 0);

521 
	}
}

524 
	$g_»ad
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
fœ¡
) {

525 
Çrgs
 = 
	`lua_g‘tİ
(
L
) - 1;

526 
sucûss
;

527 
n
;

528 
	`ş—»¼
(
f
);

529 ià(
Çrgs
 == 0) {

530 
sucûss
 = 
	`»ad_lše
(
L
, 
f
, 1);

531 
n
 = 
fœ¡
+1;

534 
	`luaL_check¡ack
(
L
, 
Çrgs
+
LUA_MINSTACK
, "too many‡rguments");

535 
sucûss
 = 1;

536 
n
 = 
fœ¡
; 
Çrgs
-- && 
sucûss
;‚++) {

537 ià(
	`lua_ty³
(
L
, 
n
è=ğ
LUA_TNUMBER
) {

538 
size_t
 
l
 = (size_t)
	`luaL_checkš‹g”
(
L
, 
n
);

539 
sucûss
 = (
l
 =ğ0è? 
	`‹¡_eof
(
L
, 
f
è: 
	`»ad_ch¬s
(L, f,†);

542 cÚ¡ *
p
 = 
	`luaL_check¡ršg
(
L
, 
n
);

543 ià(*
p
 == '*')…++;

544 *
p
) {

546 
sucûss
 = 
	`»ad_numb”
(
L
, 
f
);

549 
sucûss
 = 
	`»ad_lše
(
L
, 
f
, 1);

552 
sucûss
 = 
	`»ad_lše
(
L
, 
f
, 0);

555 
	`»ad_®l
(
L
, 
f
);

556 
sucûss
 = 1;

559  
	`luaL_¬g”rÜ
(
L
, 
n
, "invalid format");

564 ià(
	`ã¼Ü
(
f
))

565  
	`luaL_f”esuÉ
(
L
, 0, 
NULL
);

566 ià(!
sucûss
) {

567 
	`lua_pİ
(
L
, 1);

568 
	`lua_pushn
(
L
);

570  
n
 - 
fœ¡
;

571 
	}
}

574 
	$io_»ad
 (
lua_S‹
 *
L
) {

575  
	`g_»ad
(
L
, 
	`g‘iofe
(L, 
IO_INPUT
), 1);

576 
	}
}

579 
	$f_»ad
 (
lua_S‹
 *
L
) {

580  
	`g_»ad
(
L
, 
	`tofe
(L), 2);

581 
	}
}

584 
	$io_»adlše
 (
lua_S‹
 *
L
) {

585 
LSŒ—m
 *
p
 = (LSŒ—m *)
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

586 
i
;

587 
n
 = ()
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(2));

588 ià(
	`isşo£d
(
p
))

589  
	`luaL_”rÜ
(
L
, "file is‡lready closed");

590 
	`lua_£‰İ
(
L
 , 1);

591 
	`luaL_check¡ack
(
L
, 
n
, "too many‡rguments");

592 
i
 = 1; i <ğ
n
; i++)

593 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(3 + 
i
));

594 
n
 = 
	`g_»ad
(
L
, 
p
->
f
, 2);

595 
	`lua_as£¹
(
n
 > 0);

596 ià(
	`lua_toboŞ—n
(
L
, -
n
))

597  
n
;

599 ià(
n
 > 1) {

601  
	`luaL_”rÜ
(
L
, "%s", 
	`lua_to¡ršg
(L, -
n
 + 1));

603 ià(
	`lua_toboŞ—n
(
L
, 
	`lua_upv®uešdex
(3))) {

604 
	`lua_£‰İ
(
L
, 0);

605 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

606 
	`aux_şo£
(
L
);

610 
	}
}

615 
	$g_wr™e
 (
lua_S‹
 *
L
, 
FILE
 *
f
, 
¬g
) {

616 
Çrgs
 = 
	`lua_g‘tİ
(
L
è- 
¬g
;

617 
¡©us
 = 1;

618 ; 
Çrgs
--; 
¬g
++) {

619 ià(
	`lua_ty³
(
L
, 
¬g
è=ğ
LUA_TNUMBER
) {

621 
Ën
 = 
	`lua_isš‹g”
(
L
, 
¬g
)

622 ? 
	`årštf
(
f
, 
LUA_INTEGER_FMT
,

623 (
LUAI_UACINT
)
	`lua_toš‹g”
(
L
, 
¬g
))

624 : 
	`årštf
(
f
, 
LUA_NUMBER_FMT
,

625 (
LUAI_UACNUMBER
)
	`lua_tÚumb”
(
L
, 
¬g
));

626 
¡©us
 = stu && (
Ën
 > 0);

629 
size_t
 
l
;

630 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
l
);

631 
¡©us
 = stu && (
	`fwr™e
(
s
, (), 
l
, 
f
) ==†);

634 ià(
¡©us
)  1;

635  
	`luaL_f”esuÉ
(
L
, 
¡©us
, 
NULL
);

636 
	}
}

639 
	$io_wr™e
 (
lua_S‹
 *
L
) {

640  
	`g_wr™e
(
L
, 
	`g‘iofe
(L, 
IO_OUTPUT
), 1);

641 
	}
}

644 
	$f_wr™e
 (
lua_S‹
 *
L
) {

645 
FILE
 *
f
 = 
	`tofe
(
L
);

646 
	`lua_pushv®ue
(
L
, 1);

647  
	`g_wr™e
(
L
, 
f
, 2);

648 
	}
}

651 
	$f_£ek
 (
lua_S‹
 *
L
) {

652 cÚ¡ 
mode
[] = {
SEEK_SET
, 
SEEK_CUR
, 
SEEK_END
};

653 cÚ¡ *cÚ¡ 
mod’ames
[] = {"£t", "cur", "’d", 
NULL
};

654 
FILE
 *
f
 = 
	`tofe
(
L
);

655 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, "cur", 
mod’ames
);

656 
lua_IÁeg”
 
p3
 = 
	`luaL_İtš‹g”
(
L
, 3, 0);

657 
l_£eknum
 
off£t
 = (l_£eknum)
p3
;

658 
	`luaL_¬gcheck
(
L
, (
lua_IÁeg”
)
off£t
 =ğ
p3
, 3,

660 
İ
 = 
	`l_f£ek
(
f
, 
off£t
, 
mode
[op]);

661 ià(
İ
)

662  
	`luaL_f”esuÉ
(
L
, 0, 
NULL
);

664 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
	`l_á–l
(
f
));

667 
	}
}

670 
	$f_£tvbuf
 (
lua_S‹
 *
L
) {

671 cÚ¡ 
mode
[] = {
_IONBF
, 
_IOFBF
, 
_IOLBF
};

672 cÚ¡ *cÚ¡ 
mod’ames
[] = {"no", "fuÎ", "lše", 
NULL
};

673 
FILE
 *
f
 = 
	`tofe
(
L
);

674 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, 
NULL
, 
mod’ames
);

675 
lua_IÁeg”
 
sz
 = 
	`luaL_İtš‹g”
(
L
, 3, 
LUAL_BUFFERSIZE
);

676 
»s
 = 
	`£tvbuf
(
f
, 
NULL
, 
mode
[
İ
], (
size_t
)
sz
);

677  
	`luaL_f”esuÉ
(
L
, 
»s
 =ğ0, 
NULL
);

678 
	}
}

682 
	$io_æush
 (
lua_S‹
 *
L
) {

683  
	`luaL_f”esuÉ
(
L
, 
	`fæush
(
	`g‘iofe
(L, 
IO_OUTPUT
)è=ğ0, 
NULL
);

684 
	}
}

687 
	$f_æush
 (
lua_S‹
 *
L
) {

688  
	`luaL_f”esuÉ
(
L
, 
	`fæush
(
	`tofe
(L)è=ğ0, 
NULL
);

689 
	}
}

695 cÚ¡ 
luaL_Reg
 
	giŞib
[] = {

696 {"şo£", 
io_şo£
},

697 {"æush", 
io_æush
},

698 {"šput", 
io_šput
},

699 {"lšes", 
io_lšes
},

700 {"İ’", 
io_İ’
},

701 {"ouut", 
io_ouut
},

702 {"pİ’", 
io_pİ’
},

703 {"»ad", 
io_»ad
},

704 {"tmpfe", 
io_tmpfe
},

705 {"ty³", 
io_ty³
},

706 {"wr™e", 
io_wr™e
},

707 {
NULL
, NULL}

714 cÚ¡ 
luaL_Reg
 
	gæib
[] = {

715 {"şo£", 
io_şo£
},

716 {"æush", 
f_æush
},

717 {"lšes", 
f_lšes
},

718 {"»ad", 
f_»ad
},

719 {"£ek", 
f_£ek
},

720 {"£tvbuf", 
f_£tvbuf
},

721 {"wr™e", 
f_wr™e
},

722 {"__gc", 
f_gc
},

723 {"__to¡ršg", 
f_to¡ršg
},

724 {
NULL
, NULL}

728 
	$ü—‹m‘a
 (
lua_S‹
 *
L
) {

729 
	`luaL_Ãwm‘©abË
(
L
, 
LUA_FILEHANDLE
);

730 
	`lua_pushv®ue
(
L
, -1);

731 
	`lua_£tf›ld
(
L
, -2, "__index");

732 
	`luaL_£tfuncs
(
L
, 
æib
, 0);

733 
	`lua_pİ
(
L
, 1);

734 
	}
}

740 
	$io_noşo£
 (
lua_S‹
 *
L
) {

741 
LSŒ—m
 *
p
 = 
	`tŞ¡»am
(
L
);

742 
p
->
şo£f
 = &
io_noşo£
;

743 
	`lua_pushn
(
L
);

744 
	`lua_pushl™”®
(
L
, "cannot close standard file");

746 
	}
}

749 
	$ü—‹¡dfe
 (
lua_S‹
 *
L
, 
FILE
 *
f
, cÚ¡ *
k
,

750 cÚ¡ *
âame
) {

751 
LSŒ—m
 *
p
 = 
	`Ãw´efe
(
L
);

752 
p
->
f
 = f;

753 
p
->
şo£f
 = &
io_noşo£
;

754 ià(
k
 !ğ
NULL
) {

755 
	`lua_pushv®ue
(
L
, -1);

756 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
k
);

758 
	`lua_£tf›ld
(
L
, -2, 
âame
);

759 
	}
}

762 
LUAMOD_API
 
	$luaİ’_io
 (
lua_S‹
 *
L
) {

763 
	`luaL_Ãwlib
(
L
, 
iŞib
);

764 
	`ü—‹m‘a
(
L
);

766 
	`ü—‹¡dfe
(
L
, 
¡dš
, 
IO_INPUT
, "stdin");

767 
	`ü—‹¡dfe
(
L
, 
¡dout
, 
IO_OUTPUT
, "stdout");

768 
	`ü—‹¡dfe
(
L
, 
¡d”r
, 
NULL
, "stderr");

770 
	}
}

	@3rd/lua/llex.c

7 
	#Îex_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<loÿË.h
>

14 
	~<¡ršg.h
>

16 
	~"lua.h
"

18 
	~"lùy³.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lgc.h
"

22 
	~"Îex.h
"

23 
	~"lobjeù.h
"

24 
	~"Í¬£r.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"lzio.h
"

32 
	#Ãxt
(
ls
èÖs->
cu¼’t
 = 
	`zg‘c
Ös->
z
))

	)

36 
	#cu¼IsNewlše
(
ls
èÖs->
cu¼’t
 =ğ'\n' ||†s->cu¼’ˆ=ğ'\r')

	)

40 cÚ¡ *cÚ¡ 
	gluaX_tok’s
 [] = {

51 
	#§ve_ªd_Ãxt
(
ls
è(
	`§ve
Ös,†s->
cu¼’t
), 
	`Ãxt
Ös))

	)

54 
l_nÜ‘
 
Ëx”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
, 
tok’
);

57 
	$§ve
 (
LexS‹
 *
ls
, 
c
) {

58 
Mbufãr
 *
b
 = 
ls
->
buff
;

59 ià(
	`luaZ_bufæ’
(
b
è+ 1 > 
	`luaZ_sizebufãr
(b)) {

60 
size_t
 
Ãwsize
;

61 ià(
	`luaZ_sizebufãr
(
b
è>ğ
MAX_SIZE
/2)

62 
	`Ëx”rÜ
(
ls
, "lexicalƒlementoo†ong", 0);

63 
Ãwsize
 = 
	`luaZ_sizebufãr
(
b
) * 2;

64 
	`luaZ_»sizebufãr
(
ls
->
L
, 
b
, 
Ãwsize
);

66 
b
->
bufãr
[
	`luaZ_bufæ’
(b)++] = 
	`ÿ¡
(, 
c
);

67 
	}
}

70 
	$luaX_š™
 (
lua_S‹
 *
L
) {

71 
i
;

72 
TSŒšg
 *
e
 = 
	`luaS_Ãwl™”®
(
L
, 
LUA_ENV
);

73 
	`luaC_fix
(
L
, 
	`obj2gco
(
e
));

74 
i
=0; i<
NUM_RESERVED
; i++) {

75 
TSŒšg
 *
ts
 = 
	`luaS_Ãw
(
L
, 
luaX_tok’s
[
i
]);

76 
	`luaC_fix
(
L
, 
	`obj2gco
(
ts
));

77 
ts
->
exŒa
 = 
	`ÿ¡_by‹
(
i
+1);

79 
	}
}

82 cÚ¡ *
	$luaX_tok’2¡r
 (
LexS‹
 *
ls
, 
tok’
) {

83 ià(
tok’
 < 
FIRST_RESERVED
) {

84 
	`lua_as£¹
(
tok’
 =ğ
	`ÿ¡_uch¬
(token));

85  
	`luaO_pushf¡ršg
(
ls
->
L
, "'%c'", 
tok’
);

88 cÚ¡ *
s
 = 
luaX_tok’s
[
tok’
 - 
FIRST_RESERVED
];

89 ià(
tok’
 < 
TK_EOS
)

90  
	`luaO_pushf¡ršg
(
ls
->
L
, "'%s'", 
s
);

92  
s
;

94 
	}
}

97 cÚ¡ *
	$txtTok’
 (
LexS‹
 *
ls
, 
tok’
) {

98 
tok’
) {

99 
TK_NAME
: 
TK_STRING
:

100 
TK_FLT
: 
TK_INT
:

101 
	`§ve
(
ls
, '\0');

102  
	`luaO_pushf¡ršg
(
ls
->
L
, "'%s'", 
	`luaZ_bufãr
Ös->
buff
));

104  
	`luaX_tok’2¡r
(
ls
, 
tok’
);

106 
	}
}

109 
l_nÜ‘
 
	$Ëx”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
, 
tok’
) {

110 
msg
 = 
	`luaG_addšfo
(
ls
->
L
, msg,†s->
sourû
,†s->
lš’umb”
);

111 ià(
tok’
)

112 
	`luaO_pushf¡ršg
(
ls
->
L
, "% Ã¬ %s", 
msg
, 
	`txtTok’
Ös, 
tok’
));

113 
	`luaD_throw
(
ls
->
L
, 
LUA_ERRSYNTAX
);

114 
	}
}

117 
l_nÜ‘
 
	$luaX_syÁax”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
) {

118 
	`Ëx”rÜ
(
ls
, 
msg
,†s->
t
.
tok’
);

119 
	}
}

127 
TSŒšg
 *
	$luaX_Ãw¡ršg
 (
LexS‹
 *
ls
, cÚ¡ *
¡r
, 
size_t
 
l
) {

128 
lua_S‹
 *
L
 = 
ls
->L;

129 
TV®ue
 *
o
;

130 
TSŒšg
 *
ts
 = 
	`luaS_Ãwl¡r
(
L
, 
¡r
, 
l
);

131 
	`£tsv®ue2s
(
L
, L->
tİ
++, 
ts
);

132 
o
 = 
	`luaH_£t
(
L
, 
ls
->
h
, L->
tİ
 - 1);

133 ià(
	`‰i¢
(
o
)) {

136 
	`£tbv®ue
(
o
, 1);

137 
	`luaC_checkGC
(
L
);

140 
ts
 = 
	`tsv®ue
(
	`keyäomv®
(
o
));

142 
L
->
tİ
--;

143  
ts
;

144 
	}
}

151 
	$šşš’umb”
 (
LexS‹
 *
ls
) {

152 
Şd
 = 
ls
->
cu¼’t
;

153 
	`lua_as£¹
(
	`cu¼IsNewlše
(
ls
));

154 
	`Ãxt
(
ls
);

155 ià(
	`cu¼IsNewlše
(
ls
è&&†s->
cu¼’t
 !ğ
Şd
)

156 
	`Ãxt
(
ls
);

157 ià(++
ls
->
lš’umb”
 >ğ
MAX_INT
)

158 
	`Ëx”rÜ
(
ls
, "chunk hasoo many†ines", 0);

159 
	}
}

162 
	$luaX_£tšput
 (
lua_S‹
 *
L
, 
LexS‹
 *
ls
, 
ZIO
 *
z
, 
TSŒšg
 *
sourû
,

163 
fœ¡ch¬
) {

164 
ls
->
t
.
tok’
 = 0;

165 
ls
->
L
 = L;

166 
ls
->
cu¼’t
 = 
fœ¡ch¬
;

167 
ls
->
lookah—d
.
tok’
 = 
TK_EOS
;

168 
ls
->
z
 = z;

169 
ls
->
fs
 = 
NULL
;

170 
ls
->
lš’umb”
 = 1;

171 
ls
->
Ï¡lše
 = 1;

172 
ls
->
sourû
 = source;

173 
ls
->
’vn
 = 
	`luaS_Ãwl™”®
(
L
, 
LUA_ENV
);

174 
	`luaZ_»sizebufãr
(
ls
->
L
,†s->
buff
, 
LUA_MINBUFFER
);

175 
	}
}

186 
	$check_Ãxt1
 (
LexS‹
 *
ls
, 
c
) {

187 ià(
ls
->
cu¼’t
 =ğ
c
) {

188 
	`Ãxt
(
ls
);

192 
	}
}

199 
	$check_Ãxt2
 (
LexS‹
 *
ls
, cÚ¡ *
£t
) {

200 
	`lua_as£¹
(
£t
[2] == '\0');

201 ià(
ls
->
cu¼’t
 =ğ
£t
[0] ||†s->current == set[1]) {

202 
	`§ve_ªd_Ãxt
(
ls
);

206 
	}
}

214 
	$»ad_num”®
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

215 
TV®ue
 
obj
;

216 cÚ¡ *
expo
 = "Ee";

217 
fœ¡
 = 
ls
->
cu¼’t
;

218 
	`lua_as£¹
(
	`lisdig™
(
ls
->
cu¼’t
));

219 
	`§ve_ªd_Ãxt
(
ls
);

220 ià(
fœ¡
 =ğ'0' && 
	`check_Ãxt2
(
ls
, "xX"))

221 
expo
 = "Pp";

223 ià(
	`check_Ãxt2
(
ls
, 
expo
))

224 
	`check_Ãxt2
(
ls
, "-+");

225 ià(
	`lisxdig™
(
ls
->
cu¼’t
))

226 
	`§ve_ªd_Ãxt
(
ls
);

227 ià(
ls
->
cu¼’t
 == '.')

228 
	`§ve_ªd_Ãxt
(
ls
);

231 
	`§ve
(
ls
, '\0');

232 ià(
	`luaO_¡r2num
(
	`luaZ_bufãr
(
ls
->
buff
), &
obj
) == 0)

233 
	`Ëx”rÜ
(
ls
, "m®fÜmed‚umb”", 
TK_FLT
);

234 ià(
	`‰isš‹g”
(&
obj
)) {

235 
£mšfo
->
i
 = 
	`iv®ue
(&
obj
);

236  
TK_INT
;

239 
	`lua_as£¹
(
	`‰isæßt
(&
obj
));

240 
£mšfo
->
r
 = 
	`ætv®ue
(&
obj
);

241  
TK_FLT
;

243 
	}
}

251 
	$sk_£p
 (
LexS‹
 *
ls
) {

252 
couÁ
 = 0;

253 
s
 = 
ls
->
cu¼’t
;

254 
	`lua_as£¹
(
s
 == '[' || s == ']');

255 
	`§ve_ªd_Ãxt
(
ls
);

256 
ls
->
cu¼’t
 == '=') {

257 
	`§ve_ªd_Ãxt
(
ls
);

258 
couÁ
++;

260  (
ls
->
cu¼’t
 =ğ
s
è? 
couÁ
 : (-count) - 1;

261 
	}
}

264 
	$»ad_lÚg_¡ršg
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
, 
£p
) {

265 
lše
 = 
ls
->
lš’umb”
;

266 
	`§ve_ªd_Ãxt
(
ls
);

267 ià(
	`cu¼IsNewlše
(
ls
))

268 
	`šşš’umb”
(
ls
);

270 
ls
->
cu¼’t
) {

271 
EOZ
: {

272 cÚ¡ *
wh©
 = (
£mšfo
 ? "string" : "comment");

273 cÚ¡ *
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
,

274 "unfšished†Úg % (¡¬tšg‡ˆlš%d)", 
wh©
, 
lše
);

275 
	`Ëx”rÜ
(
ls
, 
msg
, 
TK_EOS
);

279 ià(
	`sk_£p
(
ls
è=ğ
£p
) {

280 
	`§ve_ªd_Ãxt
(
ls
);

281 
’dloİ
;

286 
	`§ve
(
ls
, '\n');

287 
	`šşš’umb”
(
ls
);

288 ià(!
£mšfo
è
	`luaZ_»£tbufãr
(
ls
->
buff
);

292 ià(
£mšfo
è
	`§ve_ªd_Ãxt
(
ls
);

293 
	`Ãxt
(
ls
);

296 } 
’dloİ
:

297 ià(
£mšfo
)

298 
£mšfo
->
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
è+ (2 + 
£p
),

299 
	`luaZ_bufæ’
(
ls
->
buff
è- 2*(2 + 
£p
));

300 
	}
}

303 
	$esccheck
 (
LexS‹
 *
ls
, 
c
, cÚ¡ *
msg
) {

304 ià(!
c
) {

305 ià(
ls
->
cu¼’t
 !ğ
EOZ
)

306 
	`§ve_ªd_Ãxt
(
ls
);

307 
	`Ëx”rÜ
(
ls
, 
msg
, 
TK_STRING
);

309 
	}
}

312 
	$g‘hexa
 (
LexS‹
 *
ls
) {

313 
	`§ve_ªd_Ãxt
(
ls
);

314 
	`esccheck
 (
ls
, 
	`lisxdig™
Ös->
cu¼’t
), "hexadecimal digitƒxpected");

315  
	`luaO_hexav®ue
(
ls
->
cu¼’t
);

316 
	}
}

319 
	$»adhex«sc
 (
LexS‹
 *
ls
) {

320 
r
 = 
	`g‘hexa
(
ls
);

321 
r
 = (¸<< 4è+ 
	`g‘hexa
(
ls
);

322 
	`luaZ_bufäemove
(
ls
->
buff
, 2);

323  
r
;

324 
	}
}

327 
	$»adutf8esc
 (
LexS‹
 *
ls
) {

328 
r
;

329 
i
 = 4;

330 
	`§ve_ªd_Ãxt
(
ls
);

331 
	`esccheck
(
ls
,†s->
cu¼’t
 == '{', "missing '{'");

332 
r
 = 
	`g‘hexa
(
ls
);

333 (
	`§ve_ªd_Ãxt
(
ls
), 
	`lisxdig™
Ös->
cu¼’t
))) {

334 
i
++;

335 
r
 = (¸<< 4è+ 
	`luaO_hexav®ue
(
ls
->
cu¼’t
);

336 
	`esccheck
(
ls
, 
r
 <= 0x10FFFF, "UTF-8 valueoo†arge");

338 
	`esccheck
(
ls
,†s->
cu¼’t
 == '}', "missing '}'");

339 
	`Ãxt
(
ls
);

340 
	`luaZ_bufäemove
(
ls
->
buff
, 
i
);

341  
r
;

342 
	}
}

345 
	$utf8esc
 (
LexS‹
 *
ls
) {

346 
buff
[
UTF8BUFFSZ
];

347 
n
 = 
	`luaO_utf8esc
(
buff
, 
	`»adutf8esc
(
ls
));

348 ; 
n
 > 0;‚--)

349 
	`§ve
(
ls
, 
buff
[
UTF8BUFFSZ
 - 
n
]);

350 
	}
}

353 
	$»addeûsc
 (
LexS‹
 *
ls
) {

354 
i
;

355 
r
 = 0;

356 
i
 = 0; i < 3 && 
	`lisdig™
(
ls
->
cu¼’t
); i++) {

357 
r
 = 10*¸+ 
ls
->
cu¼’t
 - '0';

358 
	`§ve_ªd_Ãxt
(
ls
);

360 
	`esccheck
(
ls
, 
r
 <ğ
UCHAR_MAX
, "decimalƒscapeoo†arge");

361 
	`luaZ_bufäemove
(
ls
->
buff
, 
i
);

362  
r
;

363 
	}
}

366 
	$»ad_¡ršg
 (
LexS‹
 *
ls
, 
d–
, 
SemInfo
 *
£mšfo
) {

367 
	`§ve_ªd_Ãxt
(
ls
);

368 
ls
->
cu¼’t
 !ğ
d–
) {

369 
ls
->
cu¼’t
) {

370 
EOZ
:

371 
	`Ëx”rÜ
(
ls
, "unfšished sŒšg", 
TK_EOS
);

375 
	`Ëx”rÜ
(
ls
, "unfšished sŒšg", 
TK_STRING
);

378 
c
;

379 
	`§ve_ªd_Ãxt
(
ls
);

380 
ls
->
cu¼’t
) {

381 'a': 
c
 = '\a'; 
»ad_§ve
;

382 'b': 
c
 = '\b'; 
»ad_§ve
;

383 'f': 
c
 = '\f'; 
»ad_§ve
;

384 'n': 
c
 = '\n'; 
»ad_§ve
;

385 'r': 
c
 = '\r'; 
»ad_§ve
;

386 't': 
c
 = '\t'; 
»ad_§ve
;

387 'v': 
c
 = '\v'; 
»ad_§ve
;

388 'x': 
c
 = 
	`»adhex«sc
(
ls
); 
»ad_§ve
;

389 'u': 
	`utf8esc
(
ls
); 
no_§ve
;

391 
	`šşš’umb”
(
ls
); 
c
 = '\n'; 
Úly_§ve
;

393 
c
 = 
ls
->
cu¼’t
; 
»ad_§ve
;

394 
EOZ
: 
no_§ve
;

396 
	`luaZ_bufäemove
(
ls
->
buff
, 1);

397 
	`Ãxt
(
ls
);

398 
	`lis¥aû
(
ls
->
cu¼’t
)) {

399 ià(
	`cu¼IsNewlše
(
ls
)è
	`šşš’umb”
(ls);

400 
	`Ãxt
(
ls
);

402 
no_§ve
;

405 
	`esccheck
(
ls
, 
	`lisdig™
Ös->
cu¼’t
), "invalidƒscape sequence");

406 
c
 = 
	`»addeûsc
(
ls
);

407 
Úly_§ve
;

410 
»ad_§ve
:

411 
	`Ãxt
(
ls
);

413 
Úly_§ve
:

414 
	`luaZ_bufäemove
(
ls
->
buff
, 1);

415 
	`§ve
(
ls
, 
c
);

417 
no_§ve
: ;

420 
	`§ve_ªd_Ãxt
(
ls
);

423 
	`§ve_ªd_Ãxt
(
ls
);

424 
£mšfo
->
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
) + 1,

425 
	`luaZ_bufæ’
(
ls
->
buff
) - 2);

426 
	}
}

429 
	$Îex
 (
LexS‹
 *
ls
, 
SemInfo
 *
£mšfo
) {

430 
	`luaZ_»£tbufãr
(
ls
->
buff
);

432 
ls
->
cu¼’t
) {

434 
	`šşš’umb”
(
ls
);

438 
	`Ãxt
(
ls
);

442 
	`Ãxt
(
ls
);

443 ià(
ls
->
cu¼’t
 != '-')  '-';

445 
	`Ãxt
(
ls
);

446 ià(
ls
->
cu¼’t
 == '[') {

447 
£p
 = 
	`sk_£p
(
ls
);

448 
	`luaZ_»£tbufãr
(
ls
->
buff
);

449 ià(
£p
 >= 0) {

450 
	`»ad_lÚg_¡ršg
(
ls
, 
NULL
, 
£p
);

451 
	`luaZ_»£tbufãr
(
ls
->
buff
);

456 !
	`cu¼IsNewlše
(
ls
è&&†s->
cu¼’t
 !ğ
EOZ
)

457 
	`Ãxt
(
ls
);

461 
£p
 = 
	`sk_£p
(
ls
);

462 ià(
£p
 >= 0) {

463 
	`»ad_lÚg_¡ršg
(
ls
, 
£mšfo
, 
£p
);

464  
TK_STRING
;

466 ià(
£p
 != -1)

467 
	`Ëx”rÜ
(
ls
, "šv®id†Úg sŒšg d–im™”", 
TK_STRING
);

471 
	`Ãxt
(
ls
);

472 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_EQ
;

476 
	`Ãxt
(
ls
);

477 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_LE
;

478 ià(
	`check_Ãxt1
(
ls
, '<')è 
TK_SHL
;

482 
	`Ãxt
(
ls
);

483 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_GE
;

484 ià(
	`check_Ãxt1
(
ls
, '>')è 
TK_SHR
;

488 
	`Ãxt
(
ls
);

489 ià(
	`check_Ãxt1
(
ls
, '/')è 
TK_IDIV
;

493 
	`Ãxt
(
ls
);

494 ià(
	`check_Ãxt1
(
ls
, '=')è 
TK_NE
;

498 
	`Ãxt
(
ls
);

499 ià(
	`check_Ãxt1
(
ls
, ':')è 
TK_DBCOLON
;

503 
	`»ad_¡ršg
(
ls
,†s->
cu¼’t
, 
£mšfo
);

504  
TK_STRING
;

507 
	`§ve_ªd_Ãxt
(
ls
);

508 ià(
	`check_Ãxt1
(
ls
, '.')) {

509 ià(
	`check_Ãxt1
(
ls
, '.'))

510  
TK_DOTS
;

511  
TK_CONCAT
;

513 ià(!
	`lisdig™
(
ls
->
cu¼’t
))  '.';

514  
	`»ad_num”®
(
ls
, 
£mšfo
);

518  
	`»ad_num”®
(
ls
, 
£mšfo
);

520 
EOZ
: {

521  
TK_EOS
;

524 ià(
	`li¦®pha
(
ls
->
cu¼’t
)) {

525 
TSŒšg
 *
ts
;

527 
	`§ve_ªd_Ãxt
(
ls
);

528 } 
	`li¦®num
(
ls
->
cu¼’t
));

529 
ts
 = 
	`luaX_Ãw¡ršg
(
ls
, 
	`luaZ_bufãr
Ös->
buff
),

530 
	`luaZ_bufæ’
(
ls
->
buff
));

531 
£mšfo
->
ts
 =s;

532 ià(
	`i¤e£rved
(
ts
))

533  
ts
->
exŒa
 - 1 + 
FIRST_RESERVED
;

535  
TK_NAME
;

539 
c
 = 
ls
->
cu¼’t
;

540 
	`Ãxt
(
ls
);

541  
c
;

546 
	}
}

549 
	$luaX_Ãxt
 (
LexS‹
 *
ls
) {

550 
ls
->
Ï¡lše
 =†s->
lš’umb”
;

551 ià(
ls
->
lookah—d
.
tok’
 !ğ
TK_EOS
) {

552 
ls
->
t
 =†s->
lookah—d
;

553 
ls
->
lookah—d
.
tok’
 = 
TK_EOS
;

556 
ls
->
t
.
tok’
 = 
	`Îex
Ös, &ls->t.
£mšfo
);

557 
	}
}

560 
	$luaX_lookah—d
 (
LexS‹
 *
ls
) {

561 
	`lua_as£¹
(
ls
->
lookah—d
.
tok’
 =ğ
TK_EOS
);

562 
ls
->
lookah—d
.
tok’
 = 
	`Îex
Ös, &ls->lookah—d.
£mšfo
);

563  
ls
->
lookah—d
.
tok’
;

564 
	}
}

	@3rd/lua/llex.h

7 #iâdeà
Îex_h


8 
	#Îex_h


	)

10 
	~"lobjeù.h
"

11 
	~"lzio.h
"

14 
	#FIRST_RESERVED
 257

	)

17 #ià!
defšed
(
LUA_ENV
)

18 
	#LUA_ENV
 "_ENV"

	)

26 
	eRESERVED
 {

28 
	mTK_AND
 = 
FIRST_RESERVED
, 
	mTK_BREAK
,

29 
	mTK_DO
, 
	mTK_ELSE
, 
	mTK_ELSEIF
, 
	mTK_END
, 
	mTK_FALSE
, 
	mTK_FOR
, 
	mTK_FUNCTION
,

30 
	mTK_GOTO
, 
	mTK_IF
, 
	mTK_IN
, 
	mTK_LOCAL
, 
	mTK_NIL
, 
	mTK_NOT
, 
	mTK_OR
, 
	mTK_REPEAT
,

31 
	mTK_RETURN
, 
	mTK_THEN
, 
	mTK_TRUE
, 
	mTK_UNTIL
, 
	mTK_WHILE
,

33 
	mTK_IDIV
, 
	mTK_CONCAT
, 
	mTK_DOTS
, 
	mTK_EQ
, 
	mTK_GE
, 
	mTK_LE
, 
	mTK_NE
,

34 
	mTK_SHL
, 
	mTK_SHR
,

35 
	mTK_DBCOLON
, 
	mTK_EOS
,

36 
	mTK_FLT
, 
	mTK_INT
, 
	mTK_NAME
, 
	mTK_STRING


40 
	#NUM_RESERVED
 (
	`ÿ¡
(, 
TK_WHILE
-
FIRST_RESERVED
+1))

	)

44 
lua_Numb”
 
	mr
;

45 
lua_IÁeg”
 
	mi
;

46 
TSŒšg
 *
	mts
;

47 } 
	tSemInfo
;

50 
	sTok’
 {

51 
	mtok’
;

52 
SemInfo
 
	m£mšfo
;

53 } 
	tTok’
;

58 
	sLexS‹
 {

59 
	mcu¼’t
;

60 
	mlš’umb”
;

61 
	mÏ¡lše
;

62 
Tok’
 
	mt
;

63 
Tok’
 
	mlookah—d
;

64 
FuncS‹
 *
	mfs
;

65 
lua_S‹
 *
	mL
;

66 
ZIO
 *
	mz
;

67 
Mbufãr
 *
	mbuff
;

68 
TabË
 *
	mh
;

69 
Dynd©a
 *
	mdyd
;

70 
TSŒšg
 *
	msourû
;

71 
TSŒšg
 *
	m’vn
;

72 } 
	tLexS‹
;

75 
LUAI_FUNC
 
luaX_š™
 (
lua_S‹
 *
L
);

76 
LUAI_FUNC
 
luaX_£tšput
 (
lua_S‹
 *
L
, 
LexS‹
 *
ls
, 
ZIO
 *
z
,

77 
TSŒšg
 *
sourû
, 
fœ¡ch¬
);

78 
LUAI_FUNC
 
TSŒšg
 *
luaX_Ãw¡ršg
 (
LexS‹
 *
ls
, cÚ¡ *
¡r
, 
size_t
 
l
);

79 
LUAI_FUNC
 
luaX_Ãxt
 (
LexS‹
 *
ls
);

80 
LUAI_FUNC
 
luaX_lookah—d
 (
LexS‹
 *
ls
);

81 
LUAI_FUNC
 
l_nÜ‘
 
luaX_syÁax”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
s
);

82 
LUAI_FUNC
 cÚ¡ *
luaX_tok’2¡r
 (
LexS‹
 *
ls
, 
tok’
);

	@3rd/lua/llimits.h

7 #iâdeà
Îim™s_h


8 
	#Îim™s_h


	)

11 
	~<lim™s.h
>

12 
	~<¡ddef.h
>

15 
	~"lua.h
"

22 #ià
defšed
(
LUAI_MEM
)

23 
LUAI_UMEM
 
	tlu_mem
;

24 
LUAI_MEM
 
	tl_mem
;

25 #–ià
LUAI_BITSINT
 >= 32

26 
size_t
 
	tlu_mem
;

27 
±rdiff_t
 
	tl_mem
;

29 
	tlu_mem
;

30 
	tl_mem
;

35 
	tlu_by‹
;

39 
	#MAX_SIZET
 ((
size_t
)(~(size_t)0))

	)

42 
	#MAX_SIZE
 ((
size_t
è< (
lua_IÁeg”
è? 
MAX_SIZET
 \

43 : (
size_t
)(
LUA_MAXINTEGER
))

	)

46 
	#MAX_LUMEM
 ((
lu_mem
)(~Öu_mem)0))

	)

48 
	#MAX_LMEM
 ((
l_mem
)(
MAX_LUMEM
 >> 1))

	)

51 
	#MAX_INT
 
INT_MAX


	)

59 
	#pošt2ušt
(
p
è(()((
size_t
)Õè& 
UINT_MAX
))

	)

64 #ià
defšed
(
LUAI_USER_ALIGNMENT_T
)

65 
LUAI_USER_ALIGNMENT_T
 
	tL_Umax®ign
;

68 
lua_Numb”
 
	mn
;

69 
	mu
;

70 *
	ms
;

71 
lua_IÁeg”
 
	mi
;

72 
	ml
;

73 } 
	tL_Umax®ign
;

79 
LUAI_UACNUMBER
 
	tl_uacNumb”
;

80 
LUAI_UACINT
 
	tl_uacIÁ
;

84 #ià
defšed
(
lua_as£¹
)

85 
	#check_exp
(
c
,
e
è(
	`lua_as£¹
(c), (e))

	)

87 
	#lua_lÚgas£¹
(
c
è((cè? ()0 : 
	`lua_as£¹
(0))

	)

89 
	#lua_as£¹
(
c
è(()0)

	)

90 
	#check_exp
(
c
,
e
èÓ)

	)

91 
	#lua_lÚgas£¹
(
c
è(()0)

	)

97 #ià!
defšed
(
luai_­icheck
)

98 
	#luai_­icheck
(
l
,
e
è
	`lua_as£¹
Ó)

	)

101 
	#­i_check
(
l
,
e
,
msg
è
	`luai_­icheck
Ö,Óè&& msg)

	)

105 #ià!
defšed
(
UNUSED
)

106 
	#UNUSED
(
x
è(()(x))

	)

111 
	#ÿ¡
(
t
, 
exp
è(Ñ)Óxp))

	)

113 
	#ÿ¡_void
(
i
è
	`ÿ¡
(, (i))

	)

114 
	#ÿ¡_by‹
(
i
è
	`ÿ¡
(
lu_by‹
, (i))

	)

115 
	#ÿ¡_num
(
i
è
	`ÿ¡
(
lua_Numb”
, (i))

	)

116 
	#ÿ¡_št
(
i
è
	`ÿ¡
(, (i))

	)

117 
	#ÿ¡_uch¬
(
i
è
	`ÿ¡
(, (i))

	)

121 #ià!
defšed
(
l_ÿ¡S2U
)

122 
	#l_ÿ¡S2U
(
i
è((
lua_UnsigÃd
)(i))

	)

130 #ià!
defšed
(
l_ÿ¡U2S
)

131 
	#l_ÿ¡U2S
(
i
è((
lua_IÁeg”
)(i))

	)

138 #ià
defšed
(
__GNUC__
)

139 
	#l_nÜ‘
 
	`__©Œibu‹__
((
nÜ‘uº
))

	)

140 #–ià
defšed
(
_MSC_VER
) && _MSC_VER >= 1200

141 
	#l_nÜ‘
 
	`__deş¥ec
(
nÜ‘uº
)

	)

143 
	#l_nÜ‘
 

	)

152 #ià!
defšed
(
LUAI_MAXCCALLS
)

153 
	#LUAI_MAXCCALLS
 200

	)

162 #ià
LUAI_BITSINT
 >= 32

163 
	tIn¡ruùiÚ
;

165 
	tIn¡ruùiÚ
;

176 #ià!
defšed
(
LUAI_MAXSHORTLEN
)

177 
	#LUAI_MAXSHORTLEN
 40

	)

187 #ià!
defšed
(
MINSTRTABSIZE
)

188 
	#MINSTRTABSIZE
 128

	)

197 #ià!
defšed
(
STRCACHE_N
)

198 
	#STRCACHE_N
 53

	)

199 
	#STRCACHE_M
 2

	)

204 #ià!
defšed
(
LUA_MINBUFFER
)

205 
	#LUA_MINBUFFER
 32

	)

213 #ià!
defšed
(
lua_lock
)

214 
	#lua_lock
(
L
è((è0)

	)

215 
	#lua_uÆock
(
L
è((è0)

	)

222 #ià!
defšed
(
luai_th»ady›ld
)

223 
	#luai_th»ady›ld
(
L
è{
	`lua_uÆock
(L); 
	`lua_lock
(L);}

	)

232 #ià!
defšed
(
luai_u£r¡©eİ’
)

233 
	#luai_u£r¡©eİ’
(
L
è(()L)

	)

236 #ià!
defšed
(
luai_u£r¡©eşo£
)

237 
	#luai_u£r¡©eşo£
(
L
è(()L)

	)

240 #ià!
defšed
(
luai_u£r¡©‘h»ad
)

241 
	#luai_u£r¡©‘h»ad
(
L
,
L1
è(()L)

	)

244 #ià!
defšed
(
luai_u£r¡©eä“
)

245 
	#luai_u£r¡©eä“
(
L
,
L1
è(()L)

	)

248 #ià!
defšed
(
luai_u£r¡©”esume
)

249 
	#luai_u£r¡©”esume
(
L
,
n
è(()L)

	)

252 #ià!
defšed
(
luai_u£r¡©ey›ld
)

253 
	#luai_u£r¡©ey›ld
(
L
,
n
è(()L)

	)

263 #ià!
defšed
(
luai_numidiv
)

264 
	#luai_numidiv
(
L
,
a
,
b
è(()L, 
	`l_æoÜ
(
	`luai_numdiv
(L,a,b)))

	)

268 #ià!
defšed
(
luai_numdiv
)

269 
	#luai_numdiv
(
L
,
a
,
b
è(×)/(b))

	)

279 #ià!
defšed
(
luai_nummod
)

280 
	#luai_nummod
(
L
,
a
,
b
,
m
) \

281 { (
m
èğ
	`l_m©hİ
(
fmod
)(
a
,
b
); ià((m)*(bè< 0è(mè+ğ(b); }

	)

285 #ià!
defšed
(
luai_numpow
)

286 
	#luai_numpow
(
L
,
a
,
b
è(()L, 
	`l_m©hİ
(
pow
)×,b))

	)

290 #ià!
defšed
(
luai_numadd
)

291 
	#luai_numadd
(
L
,
a
,
b
è(×)+(b))

	)

292 
	#luai_numsub
(
L
,
a
,
b
è(×)-(b))

	)

293 
	#luai_nummul
(
L
,
a
,
b
è(×)*(b))

	)

294 
	#luai_numunm
(
L
,
a
è(-×))

	)

295 
	#luai_numeq
(
a
,
b
è(×)==(b))

	)

296 
	#luai_numÉ
(
a
,
b
è(×)<(b))

	)

297 
	#luai_numË
(
a
,
b
è(×)<=(b))

	)

298 
	#luai_numi¢ª
(
a
è(!
	`luai_numeq
(×), (a)))

	)

308 #ià!
defšed
(
HARDSTACKTESTS
)

309 
	#cÚdmove¡ack
(
L
,
´e
,
pos
è(()0)

	)

312 
	#cÚdmove¡ack
(
L
,
´e
,
pos
) \

313 { 
sz_
 = (
L
)->
¡acksize
; 
´e
; 
	`luaD_»®loc¡ack
((L), sz_); 
pos
; }

	)

316 #ià!
defšed
(
HARDMEMTESTS
)

317 
	#cÚdchªgemem
(
L
,
´e
,
pos
è(()0)

	)

319 
	#cÚdchªgemem
(
L
,
´e
,
pos
) \

320 { ià(
	`G
(
L
)->
güuÂšg
è{ 
´e
; 
	`luaC_fuÎgc
(L, 0); 
pos
; } }

	)

	@3rd/lua/lmathlib.c

7 
	#lm©hlib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<¡dlib.h
>

14 
	~<m©h.h
>

16 
	~"lua.h
"

18 
	~"Ïuxlib.h
"

19 
	~"lu®ib.h
"

22 #undeà
PI


23 
	#PI
 (
	`l_m©hİ
(3.141592653589793238462643383279502884))

	)

26 #ià!
defšed
(
l_¿nd
)

27 #ià
defšed
(
LUA_USE_POSIX
)

28 
	#l_¿nd
(è
	`¿ndom
()

	)

29 
	#l_¤ªd
(
x
è
	`¤ªdom
(x)

	)

30 
	#L_RANDMAX
 2147483647

	)

32 
	#l_¿nd
(è
	`¿nd
()

	)

33 
	#l_¤ªd
(
x
è
	`¤ªd
(x)

	)

34 
	#L_RANDMAX
 
RAND_MAX


	)

39 
	$m©h_abs
 (
lua_S‹
 *
L
) {

40 ià(
	`lua_isš‹g”
(
L
, 1)) {

41 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”
(
L
, 1);

42 ià(
n
 < 0èÀğ(
lua_IÁeg”
)(0u - (
lua_UnsigÃd
)n);

43 
	`lua_pushš‹g”
(
L
, 
n
);

46 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
çbs
)(
	`luaL_checknumb”
(L, 1)));

48 
	}
}

50 
	$m©h_sš
 (
lua_S‹
 *
L
) {

51 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
sš
)(
	`luaL_checknumb”
(L, 1)));

53 
	}
}

55 
	$m©h_cos
 (
lua_S‹
 *
L
) {

56 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
cos
)(
	`luaL_checknumb”
(L, 1)));

58 
	}
}

60 
	$m©h_n
 (
lua_S‹
 *
L
) {

61 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
n
)(
	`luaL_checknumb”
(L, 1)));

63 
	}
}

65 
	$m©h_asš
 (
lua_S‹
 *
L
) {

66 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
asš
)(
	`luaL_checknumb”
(L, 1)));

68 
	}
}

70 
	$m©h_acos
 (
lua_S‹
 *
L
) {

71 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
acos
)(
	`luaL_checknumb”
(L, 1)));

73 
	}
}

75 
	$m©h_©ª
 (
lua_S‹
 *
L
) {

76 
lua_Numb”
 
y
 = 
	`luaL_checknumb”
(
L
, 1);

77 
lua_Numb”
 
x
 = 
	`luaL_İŠumb”
(
L
, 2, 1);

78 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
©ª2
)(
y
, 
x
));

80 
	}
}

83 
	$m©h_tošt
 (
lua_S‹
 *
L
) {

84 
v®id
;

85 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”x
(
L
, 1, &
v®id
);

86 ià(
v®id
)

87 
	`lua_pushš‹g”
(
L
, 
n
);

89 
	`luaL_checkªy
(
L
, 1);

90 
	`lua_pushn
(
L
);

93 
	}
}

96 
	$pushnumšt
 (
lua_S‹
 *
L
, 
lua_Numb”
 
d
) {

97 
lua_IÁeg”
 
n
;

98 ià(
	`lua_numb”toš‹g”
(
d
, &
n
))

99 
	`lua_pushš‹g”
(
L
, 
n
);

101 
	`lua_pushnumb”
(
L
, 
d
);

102 
	}
}

105 
	$m©h_æoÜ
 (
lua_S‹
 *
L
) {

106 ià(
	`lua_isš‹g”
(
L
, 1))

107 
	`lua_£‰İ
(
L
, 1);

109 
lua_Numb”
 
d
 = 
	`l_m©hİ
(
æoÜ
)(
	`luaL_checknumb”
(
L
, 1));

110 
	`pushnumšt
(
L
, 
d
);

113 
	}
}

116 
	$m©h_û
 (
lua_S‹
 *
L
) {

117 ià(
	`lua_isš‹g”
(
L
, 1))

118 
	`lua_£‰İ
(
L
, 1);

120 
lua_Numb”
 
d
 = 
	`l_m©hİ
(
û
)(
	`luaL_checknumb”
(
L
, 1));

121 
	`pushnumšt
(
L
, 
d
);

124 
	}
}

127 
	$m©h_fmod
 (
lua_S‹
 *
L
) {

128 ià(
	`lua_isš‹g”
(
L
, 1) &&†ua_isinteger(L, 2)) {

129 
lua_IÁeg”
 
d
 = 
	`lua_toš‹g”
(
L
, 2);

130 ià((
lua_UnsigÃd
)
d
 + 1u <= 1u) {

131 
	`luaL_¬gcheck
(
L
, 
d
 != 0, 2, "zero");

132 
	`lua_pushš‹g”
(
L
, 0);

135 
	`lua_pushš‹g”
(
L
, 
	`lua_toš‹g”
(L, 1è% 
d
);

138 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
fmod
)(
	`luaL_checknumb”
(L, 1),

139 
	`luaL_checknumb”
(
L
, 2)));

141 
	}
}

149 
	$m©h_modf
 (
lua_S‹
 *
L
) {

150 ià(
	`lua_isš‹g”
(
L
 ,1)) {

151 
	`lua_£‰İ
(
L
, 1);

152 
	`lua_pushnumb”
(
L
, 0);

155 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 1);

157 
lua_Numb”
 

 = (
n
 < 0è? 
	`l_m©hİ
(
û
)Òè:†_m©hİ(
æoÜ
)(n);

158 
	`pushnumšt
(
L
, 

);

160 
	`lua_pushnumb”
(
L
, (
n
 =ğ

è? 
	`l_m©hİ
(0.0) : (n - ip));

163 
	}
}

166 
	$m©h_sq¹
 (
lua_S‹
 *
L
) {

167 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
sq¹
)(
	`luaL_checknumb”
(L, 1)));

169 
	}
}

172 
	$m©h_uÉ
 (
lua_S‹
 *
L
) {

173 
lua_IÁeg”
 
a
 = 
	`luaL_checkš‹g”
(
L
, 1);

174 
lua_IÁeg”
 
b
 = 
	`luaL_checkš‹g”
(
L
, 2);

175 
	`lua_pushboŞ—n
(
L
, (
lua_UnsigÃd
)
a
 < (lua_UnsigÃd)
b
);

177 
	}
}

179 
	$m©h_log
 (
lua_S‹
 *
L
) {

180 
lua_Numb”
 
x
 = 
	`luaL_checknumb”
(
L
, 1);

181 
lua_Numb”
 
»s
;

182 ià(
	`lua_i¢ÚeÜn
(
L
, 2))

183 
»s
 = 
	`l_m©hİ
(
log
)(
x
);

185 
lua_Numb”
 
ba£
 = 
	`luaL_checknumb”
(
L
, 2);

186 #ià!
	`defšed
(
LUA_USE_C89
)

187 ià(
ba£
 =ğ
	`l_m©hİ
(2.0))

188 
»s
 = 
	`l_m©hİ
(
log2
)(
x
); 

190 ià(
ba£
 =ğ
	`l_m©hİ
(10.0))

191 
»s
 = 
	`l_m©hİ
(
log10
)(
x
);

193 
»s
 = 
	`l_m©hİ
(
log
)(
x
)/l_m©hİÖog)(
ba£
);

195 
	`lua_pushnumb”
(
L
, 
»s
);

197 
	}
}

199 
	$m©h_exp
 (
lua_S‹
 *
L
) {

200 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
exp
)(
	`luaL_checknumb”
(L, 1)));

202 
	}
}

204 
	$m©h_deg
 (
lua_S‹
 *
L
) {

205 
	`lua_pushnumb”
(
L
, 
	`luaL_checknumb”
(L, 1è* (
	`l_m©hİ
(180.0è/ 
PI
));

207 
	}
}

209 
	$m©h_¿d
 (
lua_S‹
 *
L
) {

210 
	`lua_pushnumb”
(
L
, 
	`luaL_checknumb”
(L, 1è* (
PI
 / 
	`l_m©hİ
(180.0)));

212 
	}
}

215 
	$m©h_mš
 (
lua_S‹
 *
L
) {

216 
n
 = 
	`lua_g‘tİ
(
L
);

217 
imš
 = 1;

218 
i
;

219 
	`luaL_¬gcheck
(
L
, 
n
 >= 1, 1, "valueƒxpected");

220 
i
 = 2; i <ğ
n
; i++) {

221 ià(
	`lua_com·»
(
L
, 
i
, 
imš
, 
LUA_OPLT
))

222 
imš
 = 
i
;

224 
	`lua_pushv®ue
(
L
, 
imš
);

226 
	}
}

229 
	$m©h_max
 (
lua_S‹
 *
L
) {

230 
n
 = 
	`lua_g‘tİ
(
L
);

231 
imax
 = 1;

232 
i
;

233 
	`luaL_¬gcheck
(
L
, 
n
 >= 1, 1, "valueƒxpected");

234 
i
 = 2; i <ğ
n
; i++) {

235 ià(
	`lua_com·»
(
L
, 
imax
, 
i
, 
LUA_OPLT
))

236 
imax
 = 
i
;

238 
	`lua_pushv®ue
(
L
, 
imax
);

240 
	}
}

247 
	$m©h_¿ndom
 (
lua_S‹
 *
L
) {

248 
lua_IÁeg”
 
low
, 
up
;

249 
r
 = ()
	`l_¿nd
(è* (1.0 / (()
L_RANDMAX
 + 1.0));

250 
	`lua_g‘tİ
(
L
)) {

252 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
r
);

256 
low
 = 1;

257 
up
 = 
	`luaL_checkš‹g”
(
L
, 1);

261 
low
 = 
	`luaL_checkš‹g”
(
L
, 1);

262 
up
 = 
	`luaL_checkš‹g”
(
L
, 2);

265 :  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rguments");

268 
	`luaL_¬gcheck
(
L
, 
low
 <ğ
up
, 1, "interval isƒmpty");

269 
	`luaL_¬gcheck
(
L
, 
low
 >ğ0 || 
up
 <ğ
LUA_MAXINTEGER
 +†ow, 1,

271 
r
 *ğ()(
up
 - 
low
) + 1.0;

272 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
r
 + 
low
);

274 
	}
}

277 
	$m©h_¿ndom£ed
 (
lua_S‹
 *
L
) {

278 
	`l_¤ªd
(()(
lua_IÁeg”
)
	`luaL_checknumb”
(
L
, 1));

279 ()
	`l_¿nd
();

281 
	}
}

284 
	$m©h_ty³
 (
lua_S‹
 *
L
) {

285 ià(
	`lua_ty³
(
L
, 1è=ğ
LUA_TNUMBER
) {

286 ià(
	`lua_isš‹g”
(
L
, 1))

287 
	`lua_pushl™”®
(
L
, "integer");

289 
	`lua_pushl™”®
(
L
, "float");

292 
	`luaL_checkªy
(
L
, 1);

293 
	`lua_pushn
(
L
);

296 
	}
}

304 #ià
defšed
(
LUA_COMPAT_MATHLIB
)

306 
	$m©h_cosh
 (
lua_S‹
 *
L
) {

307 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
cosh
)(
	`luaL_checknumb”
(L, 1)));

309 
	}
}

311 
	$m©h_sšh
 (
lua_S‹
 *
L
) {

312 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
sšh
)(
	`luaL_checknumb”
(L, 1)));

314 
	}
}

316 
	$m©h_nh
 (
lua_S‹
 *
L
) {

317 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
nh
)(
	`luaL_checknumb”
(L, 1)));

319 
	}
}

321 
	$m©h_pow
 (
lua_S‹
 *
L
) {

322 
lua_Numb”
 
x
 = 
	`luaL_checknumb”
(
L
, 1);

323 
lua_Numb”
 
y
 = 
	`luaL_checknumb”
(
L
, 2);

324 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
pow
)(
x
, 
y
));

326 
	}
}

328 
	$m©h_äexp
 (
lua_S‹
 *
L
) {

329 
e
;

330 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
äexp
)(
	`luaL_checknumb”
(L, 1), &
e
));

331 
	`lua_pushš‹g”
(
L
, 
e
);

333 
	}
}

335 
	$m©h_ldexp
 (
lua_S‹
 *
L
) {

336 
lua_Numb”
 
x
 = 
	`luaL_checknumb”
(
L
, 1);

337 
•
 = ()
	`luaL_checkš‹g”
(
L
, 2);

338 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
ldexp
)(
x
, 
•
));

340 
	}
}

342 
	$m©h_log10
 (
lua_S‹
 *
L
) {

343 
	`lua_pushnumb”
(
L
, 
	`l_m©hİ
(
log10
)(
	`luaL_checknumb”
(L, 1)));

345 
	}
}

352 cÚ¡ 
luaL_Reg
 
	gm©hlib
[] = {

353 {"abs", 
m©h_abs
},

354 {"acos", 
m©h_acos
},

355 {"asš", 
m©h_asš
},

356 {"©ª", 
m©h_©ª
},

357 {"û", 
m©h_û
},

358 {"cos", 
m©h_cos
},

359 {"deg", 
m©h_deg
},

360 {"exp", 
m©h_exp
},

361 {"toš‹g”", 
m©h_tošt
},

362 {"æoÜ", 
m©h_æoÜ
},

363 {"fmod", 
m©h_fmod
},

364 {"uÉ", 
m©h_uÉ
},

365 {"log", 
m©h_log
},

366 {"max", 
m©h_max
},

367 {"mš", 
m©h_mš
},

368 {"modf", 
m©h_modf
},

369 {"¿d", 
m©h_¿d
},

370 {"¿ndom", 
m©h_¿ndom
},

371 {"¿ndom£ed", 
m©h_¿ndom£ed
},

372 {"sš", 
m©h_sš
},

373 {"sq¹", 
m©h_sq¹
},

374 {"n", 
m©h_n
},

375 {"ty³", 
m©h_ty³
},

376 #ià
defšed
(
LUA_COMPAT_MATHLIB
)

377 {"©ª2", 
m©h_©ª
},

378 {"cosh", 
m©h_cosh
},

379 {"sšh", 
m©h_sšh
},

380 {"nh", 
m©h_nh
},

381 {"pow", 
m©h_pow
},

382 {"äexp", 
m©h_äexp
},

383 {"ldexp", 
m©h_ldexp
},

384 {"log10", 
m©h_log10
},

387 {"pi", 
NULL
},

388 {"huge", 
NULL
},

389 {"maxš‹g”", 
NULL
},

390 {"mšš‹g”", 
NULL
},

391 {
NULL
, NULL}

398 
LUAMOD_API
 
	$luaİ’_m©h
 (
lua_S‹
 *
L
) {

399 
	`luaL_Ãwlib
(
L
, 
m©hlib
);

400 
	`lua_pushnumb”
(
L
, 
PI
);

401 
	`lua_£tf›ld
(
L
, -2, "pi");

402 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
HUGE_VAL
);

403 
	`lua_£tf›ld
(
L
, -2, "huge");

404 
	`lua_pushš‹g”
(
L
, 
LUA_MAXINTEGER
);

405 
	`lua_£tf›ld
(
L
, -2, "maxinteger");

406 
	`lua_pushš‹g”
(
L
, 
LUA_MININTEGER
);

407 
	`lua_£tf›ld
(
L
, -2, "mininteger");

409 
	}
}

	@3rd/lua/lmem.c

7 
	#lmem_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lgc.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"l¡©e.h
"

45 
	#MINSIZEARRAY
 4

	)

48 *
	$luaM_growaux_
 (
lua_S‹
 *
L
, *
block
, *
size
, 
size_t
 
size_–ems
,

49 
lim™
, cÚ¡ *
wh©
) {

50 *
Ãwblock
;

51 
Ãwsize
;

52 ià(*
size
 >ğ
lim™
/2) {

53 ià(*
size
 >ğ
lim™
)

54 
	`luaG_ruÃ¼Ü
(
L
, "toØmªy % Öim™ i %d)", 
wh©
, 
lim™
);

55 
Ãwsize
 = 
lim™
;

58 
Ãwsize
 = (*
size
)*2;

59 ià(
Ãwsize
 < 
MINSIZEARRAY
)

60 
Ãwsize
 = 
MINSIZEARRAY
;

62 
Ãwblock
 = 
	`luaM_»®locv
(
L
, 
block
, *
size
, 
Ãwsize
, 
size_–ems
);

63 *
size
 = 
Ãwsize
;

64  
Ãwblock
;

65 
	}
}

68 
l_nÜ‘
 
	$luaM_toobig
 (
lua_S‹
 *
L
) {

69 
	`luaG_ruÃ¼Ü
(
L
, "memory‡llocationƒrror: blockoo big");

70 
	}
}

77 *
	$luaM_»®loc_
 (
lua_S‹
 *
L
, *
block
, 
size_t
 
osize
, size_ˆ
nsize
) {

78 *
Ãwblock
;

79 
glob®_S‹
 *
g
 = 
	`G
(
L
);

80 
size_t
 
»®osize
 = (
block
è? 
osize
 : 0;

81 
	`lua_as£¹
((
»®osize
 =ğ0è=ğ(
block
 =ğ
NULL
));

82 #ià
	`defšed
(
HARDMEMTESTS
)

83 ià(
nsize
 > 
»®osize
 && 
g
->
güuÂšg
)

84 
	`luaC_fuÎgc
(
L
, 1);

86 
Ãwblock
 = (*
g
->
ä—Îoc
)(g->
ud
, 
block
, 
osize
, 
nsize
);

87 ià(
Ãwblock
 =ğ
NULL
 && 
nsize
 > 0) {

88 
	`lua_as£¹
(
nsize
 > 
»®osize
);

89 ià(
g
->
v”siÚ
) {

90 
	`luaC_fuÎgc
(
L
, 1);

91 
Ãwblock
 = (*
g
->
ä—Îoc
)(g->
ud
, 
block
, 
osize
, 
nsize
);

93 ià(
Ãwblock
 =ğ
NULL
)

94 
	`luaD_throw
(
L
, 
LUA_ERRMEM
);

96 
	`lua_as£¹
((
nsize
 =ğ0è=ğ(
Ãwblock
 =ğ
NULL
));

97 
g
->
GCdebt
 = (g->GCdebˆ+ 
nsize
è- 
»®osize
;

98  
Ãwblock
;

99 
	}
}

	@3rd/lua/lmem.h

7 #iâdeà
lmem_h


8 
	#lmem_h


	)

11 
	~<¡ddef.h
>

13 
	~"Îim™s.h
"

14 
	~"lua.h
"

30 
	#luaM_»®locv
(
L
,
b
,
Ú
,
n
,
e
) \

31 ((((
n
è>ğ(
size_t
è&& 
	`ÿ¡
(size_t, (n)è+ 1 > 
MAX_SIZET
/(
e
)) \

32 ? 
	`luaM_toobig
(
L
è: 
	`ÿ¡_void
(0)) , \

33 
	`luaM_»®loc_
(
L
, (
b
), (
Ú
)*(
e
), (
n
)*Ó)))

	)

38 
	#luaM_»®locvch¬
(
L
,
b
,
Ú
,
n
) \

39 
	`ÿ¡
(*, 
	`luaM_»®loc_
(
L
, (
b
), (
Ú
)*(), (
n
)*()))

	)

41 
	#luaM_ä“mem
(
L
, 
b
, 
s
è
	`luaM_»®loc_
(L, (b), (s), 0)

	)

42 
	#luaM_ä“
(
L
, 
b
è
	`luaM_»®loc_
(L, (b), (*(b)), 0)

	)

43 
	#luaM_ä“¬¿y
(
L
, 
b
, 
n
è
	`luaM_»®loc_
(L, (b), (n)*(*(b)), 0)

	)

45 
	#luaM_m®loc
(
L
,
s
è
	`luaM_»®loc_
(L, 
NULL
, 0, (s))

	)

46 
	#luaM_Ãw
(
L
,
t
è
	`ÿ¡
Ñ *, 
	`luaM_m®loc
(L, Ñ)))

	)

47 
	#luaM_ÃwveùÜ
(
L
,
n
,
t
) \

48 
	`ÿ¡
(
t
 *, 
	`luaM_»®locv
(
L
, 
NULL
, 0, 
n
, Ñ)))

	)

50 
	#luaM_Ãwobjeù
(
L
,
g
,
s
è
	`luaM_»®loc_
(L, 
NULL
,ag, (s))

	)

52 
	#luaM_growveùÜ
(
L
,
v
,
ÃËms
,
size
,
t
,
lim™
,
e
) \

53 ià((
ÃËms
)+1 > (
size
)) \

54 ((
v
)=
	`ÿ¡
(
t
 *, 
	`luaM_growaux_
(
L
,v,&(
size
),Ñ),
lim™
,
e
)))

	)

56 
	#luaM_»®locveùÜ
(
L
, 
v
,
Şdn
,
n
,
t
) \

57 ((
v
)=
	`ÿ¡
(
t
 *, 
	`luaM_»®locv
(
L
, v, 
Şdn
, 
n
, Ñ))))

	)

59 
LUAI_FUNC
 
l_nÜ‘
 
luaM_toobig
 (
lua_S‹
 *
L
);

62 
LUAI_FUNC
 *
luaM_»®loc_
 (
lua_S‹
 *
L
, *
block
, 
size_t
 
Şdsize
,

63 
size_t
 
size
);

64 
LUAI_FUNC
 *
luaM_growaux_
 (
lua_S‹
 *
L
, *
block
, *
size
,

65 
size_t
 
size_–em
, 
lim™
,

66 cÚ¡ *
wh©
);

	@3rd/lua/loadlib.c

11 
	#lßdlib_c


	)

12 
	#LUA_LIB


	)

14 
	~"Í»fix.h
"

17 
	~<¡dio.h
>

18 
	~<¡dlib.h
>

19 
	~<¡ršg.h
>

21 
	~"lua.h
"

23 
	~"Ïuxlib.h
"

24 
	~"lu®ib.h
"

31 #ià!
defšed
 (
LUA_IGMARK
)

32 
	#LUA_IGMARK
 "-"

	)

42 #ià!
defšed
(
LUA_CSUBSEP
)

43 
	#LUA_CSUBSEP
 
LUA_DIRSEP


	)

46 #ià!
defšed
(
LUA_LSUBSEP
)

47 
	#LUA_LSUBSEP
 
LUA_DIRSEP


	)

52 
	#LUA_POF
 "luaİ’_"

	)

55 
	#LUA_OFSEP
 "_"

	)

62 cÚ¡ 
	gCLIBS
 = 0;

64 
	#LIB_FAIL
 "İ’"

	)

67 
	#£rogdœ
(
L
è(()0)

	)

77 
lsys_uÆßdlib
 (*
lib
);

85 *
lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
);

92 
lua_CFunùiÚ
 
lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
);

97 #ià
defšed
(
LUA_USE_DLOPEN
)

107 
	~<dlfú.h
>

114 #ià
defšed
(
__GNUC__
)

115 
	#ÿ¡_func
(
p
è(
	`__ex‹nsiÚ__
 (
lua_CFunùiÚ
)Õ))

	)

117 
	#ÿ¡_func
(
p
è((
lua_CFunùiÚ
)Õ))

	)

121 
	$lsys_uÆßdlib
 (*
lib
) {

122 
	`dlşo£
(
lib
);

123 
	}
}

126 *
	$lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
) {

127 *
lib
 = 
	`dlİ’
(
·th
, 
RTLD_NOW
 | (
£eglb
 ? 
RTLD_GLOBAL
 : 
RTLD_LOCAL
));

128 ià(
lib
 =ğ
NULL
è
	`lua_push¡ršg
(
L
, 
	`dË¼Ü
());

129  
lib
;

130 
	}
}

133 
lua_CFunùiÚ
 
	$lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

134 
lua_CFunùiÚ
 
f
 = 
	`ÿ¡_func
(
	`dlsym
(
lib
, 
sym
));

135 ià(
f
 =ğ
NULL
è
	`lua_push¡ršg
(
L
, 
	`dË¼Ü
());

136  
f
;

137 
	}
}

143 #–ià
defšed
(
LUA_DL_DLL
)

150 
	~<wšdows.h
>

156 #ià!
defšed
(
LUA_LLE_FLAGS
)

157 
	#LUA_LLE_FLAGS
 0

	)

161 #undeà
£rogdœ


168 
	$£rogdœ
 (
lua_S‹
 *
L
) {

169 
buff
[
MAX_PATH
 + 1];

170 *
lb
;

171 
DWORD
 
nsize
 = (
buff
)/();

172 
DWORD
 
n
 = 
	`G‘ModuËFeNameA
(
NULL
, 
buff
, 
nsize
);

173 ià(
n
 =ğ0 ||‚ =ğ
nsize
 || (
lb
 = 
	`¡¼chr
(
buff
, '\\')è=ğ
NULL
)

174 
	`luaL_”rÜ
(
L
, "unableo get ModuleFileName");

176 *
lb
 = '\0';

177 
	`luaL_gsub
(
L
, 
	`lua_to¡ršg
(L, -1), 
LUA_EXEC_DIR
, 
buff
);

178 
	`lua_»move
(
L
, -2);

180 
	}
}

185 
	$push”rÜ
 (
lua_S‹
 *
L
) {

186 
”rÜ
 = 
	`G‘La¡E¼Ü
();

187 
bufãr
[128];

188 ià(
	`FÜm©Mes§geA
(
FORMAT_MESSAGE_IGNORE_INSERTS
 | 
FORMAT_MESSAGE_FROM_SYSTEM
,

189 
NULL
, 
”rÜ
, 0, 
bufãr
, (buffer)/(), NULL))

190 
	`lua_push¡ršg
(
L
, 
bufãr
);

192 
	`lua_pushf¡ršg
(
L
, "sy¡emƒ¼Ü %d\n", 
”rÜ
);

193 
	}
}

195 
	$lsys_uÆßdlib
 (*
lib
) {

196 
	`F»eLib¿ry
((
HMODULE
)
lib
);

197 
	}
}

200 *
	$lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
) {

201 
HMODULE
 
lib
 = 
	`LßdLib¿ryExA
(
·th
, 
NULL
, 
LUA_LLE_FLAGS
);

202 ()(
£eglb
);

203 ià(
lib
 =ğ
NULL
è
	`push”rÜ
(
L
);

204  
lib
;

205 
	}
}

208 
lua_CFunùiÚ
 
	$lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

209 
lua_CFunùiÚ
 
f
 = (lua_CFunùiÚ)
	`G‘ProcAdd»ss
((
HMODULE
)
lib
, 
sym
);

210 ià(
f
 =ğ
NULL
è
	`push”rÜ
(
L
);

211  
f
;

212 
	}
}

224 #undeà
LIB_FAIL


225 
	#LIB_FAIL
 "ab£Á"

	)

228 
	#DLMSG
 "dyÇmiølib¿r› nÙƒÇbËd; check you¸Lu¨š¡®ÏtiÚ"

	)

231 
	$lsys_uÆßdlib
 (*
lib
) {

232 ()(
lib
);

233 
	}
}

236 *
	$lsys_lßd
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, 
£eglb
) {

237 ()(
·th
); ()(
£eglb
);

238 
	`lua_pushl™”®
(
L
, 
DLMSG
);

239  
NULL
;

240 
	}
}

243 
lua_CFunùiÚ
 
	$lsys_sym
 (
lua_S‹
 *
L
, *
lib
, cÚ¡ *
sym
) {

244 ()(
lib
); ()(
sym
);

245 
	`lua_pushl™”®
(
L
, 
DLMSG
);

246  
NULL
;

247 
	}
}

263 #ià!
defšed
(
LUA_PATH_VAR
)

264 
	#LUA_PATH_VAR
 "LUA_PATH"

	)

267 #ià!
defšed
(
LUA_CPATH_VAR
)

268 
	#LUA_CPATH_VAR
 "LUA_CPATH"

	)

272 
	#AUXMARK
 "\1"

	)

278 
	$nÛnv
 (
lua_S‹
 *
L
) {

279 
b
;

280 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_NOENV");

281 
b
 = 
	`lua_toboŞ—n
(
L
, -1);

282 
	`lua_pİ
(
L
, 1);

283  
b
;

284 
	}
}

290 
	$£©h
 (
lua_S‹
 *
L
, cÚ¡ *
f›ldÇme
,

291 cÚ¡ *
’vÇme
,

292 cÚ¡ *
dá
) {

293 cÚ¡ *
nv”
 = 
	`lua_pushf¡ršg
(
L
, "%s%s", 
’vÇme
, 
LUA_VERSUFFIX
);

294 cÚ¡ *
·th
 = 
	`g‘’v
(
nv”
);

295 ià(
·th
 =ğ
NULL
)

296 
·th
 = 
	`g‘’v
(
’vÇme
);

297 ià(
·th
 =ğ
NULL
 || 
	`nÛnv
(
L
))

298 
	`lua_push¡ršg
(
L
, 
dá
);

301 
·th
 = 
	`luaL_gsub
(
L
,…©h, 
LUA_PATH_SEP
 LUA_PATH_SEP,

302 
LUA_PATH_SEP
 
AUXMARK
 LUA_PATH_SEP);

303 
	`luaL_gsub
(
L
, 
·th
, 
AUXMARK
, 
dá
);

304 
	`lua_»move
(
L
, -2);

306 
	`£rogdœ
(
L
);

307 
	`lua_£tf›ld
(
L
, -3, 
f›ldÇme
);

308 
	`lua_pİ
(
L
, 1);

309 
	}
}

317 *
	$checkşib
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

318 *
¶ib
;

319 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
CLIBS
);

320 
	`lua_g‘f›ld
(
L
, -1, 
·th
);

321 
¶ib
 = 
	`lua_tou£rd©a
(
L
, -1);

322 
	`lua_pİ
(
L
, 2);

323  
¶ib
;

324 
	}
}

331 
	$addtoşib
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, *
¶ib
) {

332 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
CLIBS
);

333 
	`lua_pushlightu£rd©a
(
L
, 
¶ib
);

334 
	`lua_pushv®ue
(
L
, -1);

335 
	`lua_£tf›ld
(
L
, -3, 
·th
);

336 
	`lua_¿w£ti
(
L
, -2, 
	`luaL_Ën
(L, -2) + 1);

337 
	`lua_pİ
(
L
, 1);

338 
	}
}

345 
	$gùm
 (
lua_S‹
 *
L
) {

346 
lua_IÁeg”
 
n
 = 
	`luaL_Ën
(
L
, 1);

347 ; 
n
 >= 1;‚--) {

348 
	`lua_¿wg‘i
(
L
, 1, 
n
);

349 
	`lsys_uÆßdlib
(
	`lua_tou£rd©a
(
L
, -1));

350 
	`lua_pİ
(
L
, 1);

353 
	}
}

358 
	#ERRLIB
 1

	)

359 
	#ERRFUNC
 2

	)

372 
	$lookfÜfunc
 (
lua_S‹
 *
L
, cÚ¡ *
·th
, cÚ¡ *
sym
) {

373 *
»g
 = 
	`checkşib
(
L
, 
·th
);

374 ià(
»g
 =ğ
NULL
) {

375 
»g
 = 
	`lsys_lßd
(
L
, 
·th
, *
sym
 == '*');

376 ià(
»g
 =ğ
NULL
è 
ERRLIB
;

377 
	`addtoşib
(
L
, 
·th
, 
»g
);

379 ià(*
sym
 == '*') {

380 
	`lua_pushboŞ—n
(
L
, 1);

384 
lua_CFunùiÚ
 
f
 = 
	`lsys_sym
(
L
, 
»g
, 
sym
);

385 ià(
f
 =ğ
NULL
)

386  
ERRFUNC
;

387 
	`lua_pushcfunùiÚ
(
L
, 
f
);

390 
	}
}

393 
	$Î_lßdlib
 (
lua_S‹
 *
L
) {

394 cÚ¡ *
·th
 = 
	`luaL_check¡ršg
(
L
, 1);

395 cÚ¡ *
š™
 = 
	`luaL_check¡ršg
(
L
, 2);

396 
¡©
 = 
	`lookfÜfunc
(
L
, 
·th
, 
š™
);

397 ià(
¡©
 == 0)

400 
	`lua_pushn
(
L
);

401 
	`lua_š£¹
(
L
, -2);

402 
	`lua_push¡ršg
(
L
, (
¡©
 =ğ
ERRLIB
è? 
LIB_FAIL
 : "init");

405 
	}
}

416 
	$»adabË
 (cÚ¡ *
f’ame
) {

417 
FILE
 *
f
 = 
	`fİ’
(
f’ame
, "r");

418 ià(
f
 =ğ
NULL
)  0;

419 
	`fşo£
(
f
);

421 
	}
}

424 cÚ¡ *
	$pushÃx‰em¶©e
 (
lua_S‹
 *
L
, cÚ¡ *
·th
) {

425 cÚ¡ *
l
;

426 *
·th
 =ğ*
LUA_PATH_SEP
)…ath++;

427 ià(*
·th
 =ğ'\0'è 
NULL
;

428 
l
 = 
	`¡rchr
(
·th
, *
LUA_PATH_SEP
);

429 ià(
l
 =ğ
NULL
èÈğ
·th
 + 
	`¡¾’
(path);

430 
	`lua_pushl¡ršg
(
L
, 
·th
, 
l
 -…ath);

431  
l
;

432 
	}
}

435 cÚ¡ *
	$£¬ch·th
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
,

436 cÚ¡ *
·th
,

437 cÚ¡ *
£p
,

438 cÚ¡ *
dœ£p
) {

439 
luaL_Bufãr
 
msg
;

440 
	`luaL_buffš™
(
L
, &
msg
);

441 ià(*
£p
 != '\0')

442 
Çme
 = 
	`luaL_gsub
(
L
,‚ame, 
£p
, 
dœ£p
);

443 (
·th
 = 
	`pushÃx‰em¶©e
(
L
,…©h)è!ğ
NULL
) {

444 cÚ¡ *
f’ame
 = 
	`luaL_gsub
(
L
, 
	`lua_to¡ršg
(L, -1),

445 
LUA_PATH_MARK
, 
Çme
);

446 
	`lua_»move
(
L
, -2);

447 ià(
	`»adabË
(
f’ame
))

448  
f’ame
;

449 
	`lua_pushf¡ršg
(
L
, "\n\ŠØf'%s'", 
f’ame
);

450 
	`lua_»move
(
L
, -2);

451 
	`luaL_addv®ue
(&
msg
);

453 
	`luaL_push»suÉ
(&
msg
);

454  
NULL
;

455 
	}
}

458 
	$Î_£¬ch·th
 (
lua_S‹
 *
L
) {

459 cÚ¡ *
f
 = 
	`£¬ch·th
(
L
, 
	`luaL_check¡ršg
(L, 1),

460 
	`luaL_check¡ršg
(
L
, 2),

461 
	`luaL_İt¡ršg
(
L
, 3, "."),

462 
	`luaL_İt¡ršg
(
L
, 4, 
LUA_DIRSEP
));

463 ià(
f
 !ğ
NULL
)  1;

465 
	`lua_pushn
(
L
);

466 
	`lua_š£¹
(
L
, -2);

469 
	}
}

472 cÚ¡ *
	$fšdfe
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
,

473 cÚ¡ *
²ame
,

474 cÚ¡ *
dœ£p
) {

475 cÚ¡ *
·th
;

476 
	`lua_g‘f›ld
(
L
, 
	`lua_upv®uešdex
(1), 
²ame
);

477 
·th
 = 
	`lua_to¡ršg
(
L
, -1);

478 ià(
·th
 =ğ
NULL
)

479 
	`luaL_”rÜ
(
L
, "'·ckage.%s' mu¡ b¨¡ršg", 
²ame
);

480  
	`£¬ch·th
(
L
, 
Çme
, 
·th
, ".", 
dœ£p
);

481 
	}
}

484 
	$checklßd
 (
lua_S‹
 *
L
, 
¡©
, cÚ¡ *
f’ame
) {

485 ià(
¡©
) {

486 
	`lua_push¡ršg
(
L
, 
f’ame
);

490  
	`luaL_”rÜ
(
L
, "error†oading module '%s' from file '%s':\n\t%s",

491 
	`lua_to¡ršg
(
L
, 1), 
f’ame
,†ua_tostring(L, -1));

492 
	}
}

495 
	$£¬ch”_Lua
 (
lua_S‹
 *
L
) {

496 cÚ¡ *
f’ame
;

497 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

498 
f’ame
 = 
	`fšdfe
(
L
, 
Çme
, "·th", 
LUA_LSUBSEP
);

499 ià(
f’ame
 =ğ
NULL
)  1;

500  
	`checklßd
(
L
, (
	`luaL_lßdfe
(L, 
f’ame
è=ğ
LUA_OK
), filename);

501 
	}
}

512 
	$lßdfunc
 (
lua_S‹
 *
L
, cÚ¡ *
f’ame
, cÚ¡ *
modÇme
) {

513 cÚ¡ *
İ’func
;

514 cÚ¡ *
m¬k
;

515 
modÇme
 = 
	`luaL_gsub
(
L
, modÇme, ".", 
LUA_OFSEP
);

516 
m¬k
 = 
	`¡rchr
(
modÇme
, *
LUA_IGMARK
);

517 ià(
m¬k
) {

518 
¡©
;

519 
İ’func
 = 
	`lua_pushl¡ršg
(
L
, 
modÇme
, 
m¬k
 - modname);

520 
İ’func
 = 
	`lua_pushf¡ršg
(
L
, 
LUA_POF
"%s", openfunc);

521 
¡©
 = 
	`lookfÜfunc
(
L
, 
f’ame
, 
İ’func
);

522 ià(
¡©
 !ğ
ERRFUNC
)  stat;

523 
modÇme
 = 
m¬k
 + 1;

525 
İ’func
 = 
	`lua_pushf¡ršg
(
L
, 
LUA_POF
"%s", 
modÇme
);

526  
	`lookfÜfunc
(
L
, 
f’ame
, 
İ’func
);

527 
	}
}

530 
	$£¬ch”_C
 (
lua_S‹
 *
L
) {

531 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

532 cÚ¡ *
f’ame
 = 
	`fšdfe
(
L
, 
Çme
, "ı©h", 
LUA_CSUBSEP
);

533 ià(
f’ame
 =ğ
NULL
)  1;

534  
	`checklßd
(
L
, (
	`lßdfunc
(L, 
f’ame
, 
Çme
) == 0), filename);

535 
	}
}

538 
	$£¬ch”_CroÙ
 (
lua_S‹
 *
L
) {

539 cÚ¡ *
f’ame
;

540 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

541 cÚ¡ *
p
 = 
	`¡rchr
(
Çme
, '.');

542 
¡©
;

543 ià(
p
 =ğ
NULL
)  0;

544 
	`lua_pushl¡ršg
(
L
, 
Çme
, 
p
 -‚ame);

545 
f’ame
 = 
	`fšdfe
(
L
, 
	`lua_to¡ršg
(L, -1), "ı©h", 
LUA_CSUBSEP
);

546 ià(
f’ame
 =ğ
NULL
)  1;

547 ià((
¡©
 = 
	`lßdfunc
(
L
, 
f’ame
, 
Çme
)) != 0) {

548 ià(
¡©
 !ğ
ERRFUNC
)

549  
	`checklßd
(
L
, 0, 
f’ame
);

551 
	`lua_pushf¡ršg
(
L
, "\n\ŠØmoduË '%s' iÀf'%s'", 
Çme
, 
f’ame
);

555 
	`lua_push¡ršg
(
L
, 
f’ame
);

557 
	}
}

560 
	$£¬ch”_´–ßd
 (
lua_S‹
 *
L
) {

561 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

562 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_PRELOAD_TABLE
);

563 ià(
	`lua_g‘f›ld
(
L
, -1, 
Çme
è=ğ
LUA_TNIL
)

564 
	`lua_pushf¡ršg
(
L
, "\n\ŠØf›ld…ackage.´–ßd['%s']", 
Çme
);

566 
	}
}

569 
	$fšdlßd”
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

570 
i
;

571 
luaL_Bufãr
 
msg
;

572 
	`luaL_buffš™
(
L
, &
msg
);

574 ià(
	`lua_g‘f›ld
(
L
, 
	`lua_upv®uešdex
(1), "£¬ch”s"è!ğ
LUA_TTABLE
)

575 
	`luaL_”rÜ
(
L
, "'package.searchers' must be‡able");

577 
i
 = 1; ; i++) {

578 ià(
	`lua_¿wg‘i
(
L
, 3, 
i
è=ğ
LUA_TNIL
) {

579 
	`lua_pİ
(
L
, 1);

580 
	`luaL_push»suÉ
(&
msg
);

581 
	`luaL_”rÜ
(
L
, "moduË '%s'‚Ù found:%s", 
Çme
, 
	`lua_to¡ršg
(L, -1));

583 
	`lua_push¡ršg
(
L
, 
Çme
);

584 
	`lua_ÿÎ
(
L
, 1, 2);

585 ià(
	`lua_isfunùiÚ
(
L
, -2))

587 ià(
	`lua_is¡ršg
(
L
, -2)) {

588 
	`lua_pİ
(
L
, 1);

589 
	`luaL_addv®ue
(&
msg
);

592 
	`lua_pİ
(
L
, 2);

594 
	}
}

597 
	$Î_»quœe
 (
lua_S‹
 *
L
) {

598 cÚ¡ *
Çme
 = 
	`luaL_check¡ršg
(
L
, 1);

599 
	`lua_£‰İ
(
L
, 1);

600 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

601 
	`lua_g‘f›ld
(
L
, 2, 
Çme
);

602 ià(
	`lua_toboŞ—n
(
L
, -1))

605 
	`lua_pİ
(
L
, 1);

606 
	`fšdlßd”
(
L
, 
Çme
);

607 
	`lua_push¡ršg
(
L
, 
Çme
);

608 
	`lua_š£¹
(
L
, -2);

609 
	`lua_ÿÎ
(
L
, 2, 1);

610 ià(!
	`lua_i¢
(
L
, -1))

611 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

612 ià(
	`lua_g‘f›ld
(
L
, 2, 
Çme
è=ğ
LUA_TNIL
) {

613 
	`lua_pushboŞ—n
(
L
, 1);

614 
	`lua_pushv®ue
(
L
, -1);

615 
	`lua_£tf›ld
(
L
, 2, 
Çme
);

618 
	}
}

629 #ià
defšed
(
LUA_COMPAT_MODULE
)

634 
	$£t_’v
 (
lua_S‹
 *
L
) {

635 
lua_Debug
 
¬
;

636 ià(
	`lua_g‘¡ack
(
L
, 1, &
¬
) == 0 ||

637 
	`lua_g‘šfo
(
L
, "f", &
¬
) == 0 ||

638 
	`lua_iscfunùiÚ
(
L
, -1))

639 
	`luaL_”rÜ
(
L
, "'module'‚ot called from‡ Lua function");

640 
	`lua_pushv®ue
(
L
, -2);

641 
	`lua_£tupv®ue
(
L
, -2, 1);

642 
	`lua_pİ
(
L
, 1);

643 
	}
}

646 
	$doİtiÚs
 (
lua_S‹
 *
L
, 
n
) {

647 
i
;

648 
i
 = 2; i <ğ
n
; i++) {

649 ià(
	`lua_isfunùiÚ
(
L
, 
i
)) {

650 
	`lua_pushv®ue
(
L
, 
i
);

651 
	`lua_pushv®ue
(
L
, -2);

652 
	`lua_ÿÎ
(
L
, 1, 0);

655 
	}
}

658 
	$modš™
 (
lua_S‹
 *
L
, cÚ¡ *
modÇme
) {

659 cÚ¡ *
dÙ
;

660 
	`lua_pushv®ue
(
L
, -1);

661 
	`lua_£tf›ld
(
L
, -2, "_M");

662 
	`lua_push¡ršg
(
L
, 
modÇme
);

663 
	`lua_£tf›ld
(
L
, -2, "_NAME");

664 
dÙ
 = 
	`¡¼chr
(
modÇme
, '.');

665 ià(
dÙ
 =ğ
NULL
èdÙ = 
modÇme
;

666 
dÙ
++;

668 
	`lua_pushl¡ršg
(
L
, 
modÇme
, 
dÙ
 - modname);

669 
	`lua_£tf›ld
(
L
, -2, "_PACKAGE");

670 
	}
}

673 
	$Î_moduË
 (
lua_S‹
 *
L
) {

674 cÚ¡ *
modÇme
 = 
	`luaL_check¡ršg
(
L
, 1);

675 
Ï¡¬g
 = 
	`lua_g‘tİ
(
L
);

676 
	`luaL_pushmoduË
(
L
, 
modÇme
, 1);

678 ià(
	`lua_g‘f›ld
(
L
, -1, "_NAME"è!ğ
LUA_TNIL
)

679 
	`lua_pİ
(
L
, 1);

681 
	`lua_pİ
(
L
, 1);

682 
	`modš™
(
L
, 
modÇme
);

684 
	`lua_pushv®ue
(
L
, -1);

685 
	`£t_’v
(
L
);

686 
	`doİtiÚs
(
L
, 
Ï¡¬g
);

688 
	}
}

691 
	$Î_£—Î
 (
lua_S‹
 *
L
) {

692 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

693 ià(!
	`lua_g‘m‘©abË
(
L
, 1)) {

694 
	`lua_ü—‹bË
(
L
, 0, 1);

695 
	`lua_pushv®ue
(
L
, -1);

696 
	`lua_£tm‘©abË
(
L
, 1);

698 
	`lua_pushglob®bË
(
L
);

699 
	`lua_£tf›ld
(
L
, -2, "__index");

701 
	}
}

708 cÚ¡ 
luaL_Reg
 
	gpk_funcs
[] = {

709 {"lßdlib", 
Î_lßdlib
},

710 {"£¬ch·th", 
Î_£¬ch·th
},

711 #ià
defšed
(
LUA_COMPAT_MODULE
)

712 {"£—Î", 
Î_£—Î
},

715 {"´–ßd", 
NULL
},

716 {"ı©h", 
NULL
},

717 {"·th", 
NULL
},

718 {"£¬ch”s", 
NULL
},

719 {"lßded", 
NULL
},

720 {
NULL
, NULL}

724 cÚ¡ 
luaL_Reg
 
	gÎ_funcs
[] = {

725 #ià
defšed
(
LUA_COMPAT_MODULE
)

726 {"moduË", 
Î_moduË
},

728 {"»quœe", 
Î_»quœe
},

729 {
NULL
, NULL}

733 
	$ü—‹£¬ch”¡abË
 (
lua_S‹
 *
L
) {

734 cÚ¡ 
lua_CFunùiÚ
 
£¬ch”s
[] =

735 {
£¬ch”_´–ßd
, 
£¬ch”_Lua
, 
£¬ch”_C
, 
£¬ch”_CroÙ
, 
NULL
};

736 
i
;

738 
	`lua_ü—‹bË
(
L
, (
£¬ch”s
)/(searchers[0]) - 1, 0);

740 
i
=0; 
£¬ch”s
[i] !ğ
NULL
; i++) {

741 
	`lua_pushv®ue
(
L
, -2);

742 
	`lua_pushcşosu»
(
L
, 
£¬ch”s
[
i
], 1);

743 
	`lua_¿w£ti
(
L
, -2, 
i
+1);

745 #ià
	`defšed
(
LUA_COMPAT_LOADERS
)

746 
	`lua_pushv®ue
(
L
, -1);

747 
	`lua_£tf›ld
(
L
, -3, "loaders");

749 
	`lua_£tf›ld
(
L
, -2, "searchers");

750 
	}
}

757 
	$ü—‹şib¡abË
 (
lua_S‹
 *
L
) {

758 
	`lua_ÃwbË
(
L
);

759 
	`lua_ü—‹bË
(
L
, 0, 1);

760 
	`lua_pushcfunùiÚ
(
L
, 
gùm
);

761 
	`lua_£tf›ld
(
L
, -2, "__gc");

762 
	`lua_£tm‘©abË
(
L
, -2);

763 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, &
CLIBS
);

764 
	}
}

767 
LUAMOD_API
 
	$luaİ’_·ckage
 (
lua_S‹
 *
L
) {

768 
	`ü—‹şib¡abË
(
L
);

769 
	`luaL_Ãwlib
(
L
, 
pk_funcs
);

770 
	`ü—‹£¬ch”¡abË
(
L
);

772 
	`£©h
(
L
, "·th", 
LUA_PATH_VAR
, 
LUA_PATH_DEFAULT
);

773 
	`£©h
(
L
, "ı©h", 
LUA_CPATH_VAR
, 
LUA_CPATH_DEFAULT
);

775 
	`lua_pushl™”®
(
L
, 
LUA_DIRSEP
 "\n" 
LUA_PATH_SEP
 "\n" 
LUA_PATH_MARK
 "\n"

776 
LUA_EXEC_DIR
 "\n" 
LUA_IGMARK
 "\n");

777 
	`lua_£tf›ld
(
L
, -2, "config");

779 
	`luaL_g‘subbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_LOADED_TABLE
);

780 
	`lua_£tf›ld
(
L
, -2, "loaded");

782 
	`luaL_g‘subbË
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_PRELOAD_TABLE
);

783 
	`lua_£tf›ld
(
L
, -2, "preload");

784 
	`lua_pushglob®bË
(
L
);

785 
	`lua_pushv®ue
(
L
, -2);

786 
	`luaL_£tfuncs
(
L
, 
Î_funcs
, 1);

787 
	`lua_pİ
(
L
, 1);

789 
	}
}

	@3rd/lua/lobject.c

7 
	#lobjeù_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<loÿË.h
>

14 
	~<m©h.h
>

15 
	~<¡d¬g.h
>

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

20 
	~"lua.h
"

22 
	~"lùy³.h
"

23 
	~"ldebug.h
"

24 
	~"ldo.h
"

25 
	~"lmem.h
"

26 
	~"lobjeù.h
"

27 
	~"l¡©e.h
"

28 
	~"l¡ršg.h
"

29 
	~"lvm.h
"

33 
LUAI_DDEF
 cÚ¡ 
TV®ue
 
	gluaO_nobjeù_
 = {
NILCONSTANT
};

41 
	$luaO_št2fb
 (
x
) {

42 
e
 = 0;

43 ià(
x
 < 8)  x;

44 
x
 >= (8 << 4)) {

45 
x
 = (x + 0xf) >> 4;

46 
e
 += 4;

48 
x
 >= (8 << 1)) {

49 
x
 = (x + 1) >> 1;

50 
e
++;

52  ((
e
+1è<< 3è| (
	`ÿ¡_št
(
x
) - 8);

53 
	}
}

57 
	$luaO_fb2št
 (
x
) {

58  (
x
 < 8) ? x : ((x & 7) + 8) << ((x >> 3) - 1);

59 
	}
}

65 
	$luaO_ûlog2
 (
x
) {

66 cÚ¡ 
lu_by‹
 
log_2
[256] = {

76 
l
 = 0;

77 
x
--;

78 
x
 >ğ256è{ 
l
 += 8; x >>= 8; }

79  
l
 + 
log_2
[
x
];

80 
	}
}

83 
lua_IÁeg”
 
	$šr™h
 (
lua_S‹
 *
L
, 
İ
, 
lua_IÁeg”
 
v1
,

84 
lua_IÁeg”
 
v2
) {

85 
İ
) {

86 
LUA_OPADD
:  
	`štİ
(+, 
v1
, 
v2
);

87 
LUA_OPSUB
: 
	`štİ
(-, 
v1
, 
v2
);

88 
LUA_OPMUL
: 
	`štİ
(*, 
v1
, 
v2
);

89 
LUA_OPMOD
:  
	`luaV_mod
(
L
, 
v1
, 
v2
);

90 
LUA_OPIDIV
:  
	`luaV_div
(
L
, 
v1
, 
v2
);

91 
LUA_OPBAND
:  
	`štİ
(&, 
v1
, 
v2
);

92 
LUA_OPBOR
:  
	`štİ
(|, 
v1
, 
v2
);

93 
LUA_OPBXOR
:  
	`štİ
(^, 
v1
, 
v2
);

94 
LUA_OPSHL
:  
	`luaV_shiál
(
v1
, 
v2
);

95 
LUA_OPSHR
:  
	`luaV_shiál
(
v1
, -
v2
);

96 
LUA_OPUNM
:  
	`štİ
(-, 0, 
v1
);

97 
LUA_OPBNOT
:  
	`štİ
(^, ~
	`l_ÿ¡S2U
(0), 
v1
);

98 : 
	`lua_as£¹
(0);  0;

100 
	}
}

103 
lua_Numb”
 
	$num¬™h
 (
lua_S‹
 *
L
, 
İ
, 
lua_Numb”
 
v1
,

104 
lua_Numb”
 
v2
) {

105 
İ
) {

106 
LUA_OPADD
:  
	`luai_numadd
(
L
, 
v1
, 
v2
);

107 
LUA_OPSUB
:  
	`luai_numsub
(
L
, 
v1
, 
v2
);

108 
LUA_OPMUL
:  
	`luai_nummul
(
L
, 
v1
, 
v2
);

109 
LUA_OPDIV
:  
	`luai_numdiv
(
L
, 
v1
, 
v2
);

110 
LUA_OPPOW
:  
	`luai_numpow
(
L
, 
v1
, 
v2
);

111 
LUA_OPIDIV
:  
	`luai_numidiv
(
L
, 
v1
, 
v2
);

112 
LUA_OPUNM
:  
	`luai_numunm
(
L
, 
v1
);

113 
LUA_OPMOD
: {

114 
lua_Numb”
 
m
;

115 
	`luai_nummod
(
L
, 
v1
, 
v2
, 
m
);

116  
m
;

118 : 
	`lua_as£¹
(0);  0;

120 
	}
}

123 
	$luaO_¬™h
 (
lua_S‹
 *
L
, 
İ
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

124 
TV®ue
 *
»s
) {

125 
İ
) {

126 
LUA_OPBAND
: 
LUA_OPBOR
: 
LUA_OPBXOR
:

127 
LUA_OPSHL
: 
LUA_OPSHR
:

128 
LUA_OPBNOT
: {

129 
lua_IÁeg”
 
i1
;†ua_IÁeg” 
i2
;

130 ià(
	`toš‹g”
(
p1
, &
i1
è&&oš‹g”(
p2
, &
i2
)) {

131 
	`£tiv®ue
(
»s
, 
	`šr™h
(
L
, 
İ
, 
i1
, 
i2
));

136 
LUA_OPDIV
: 
LUA_OPPOW
: {

137 
lua_Numb”
 
n1
;†ua_Numb” 
n2
;

138 ià(
	`tÚumb”
(
p1
, &
n1
è&&Úumb”(
p2
, &
n2
)) {

139 
	`£tætv®ue
(
»s
, 
	`num¬™h
(
L
, 
İ
, 
n1
, 
n2
));

145 
lua_Numb”
 
n1
;†ua_Numb” 
n2
;

146 ià(
	`‰isš‹g”
(
p1
è&&tisš‹g”(
p2
)) {

147 
	`£tiv®ue
(
»s
, 
	`šr™h
(
L
, 
İ
, 
	`iv®ue
(
p1
), iv®ue(
p2
)));

150 ià(
	`tÚumb”
(
p1
, &
n1
è&&Úumb”(
p2
, &
n2
)) {

151 
	`£tætv®ue
(
»s
, 
	`num¬™h
(
L
, 
İ
, 
n1
, 
n2
));

158 
	`lua_as£¹
(
L
 !ğ
NULL
);

159 
	`luaT_ŒybšTM
(
L
, 
p1
, 
p2
, 
»s
, 
	`ÿ¡
(
TMS
, (
İ
 - 
LUA_OPADD
è+ 
TM_ADD
));

160 
	}
}

163 
	$luaO_hexav®ue
 (
c
) {

164 ià(
	`lisdig™
(
c
))  c - '0';

165  (
	`ÉŞow”
(
c
) - 'a') + 10;

166 
	}
}

169 
	$i¢eg
 (cÚ¡ **
s
) {

170 ià(**
s
 == '-') { (*s)++;  1; }

171 ià(**
s
 == '+') (*s)++;

173 
	}
}

183 #ià!
defšed
(
lua_¡rx2numb”
)

187 
	#MAXSIGDIG
 30

	)

193 
lua_Numb”
 
	$lua_¡rx2numb”
 (cÚ¡ *
s
, **
’d±r
) {

194 
dÙ
 = 
	`lua_g‘loÿËdeıošt
();

195 
lua_Numb”
 
r
 = 0.0;

196 
sigdig
 = 0;

197 
nosigdig
 = 0;

198 
e
 = 0;

199 
Ãg
;

200 
hasdÙ
 = 0;

201 *
’d±r
 = 
	`ÿ¡
(*, 
s
);

202 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
s
))) s++;

203 
Ãg
 = 
	`i¢eg
(&
s
);

204 ià(!(*
s
 == '0' && (*(s + 1) == 'x' || *(s + 1) == 'X')))

206 
s
 += 2; ; s++) {

207 ià(*
s
 =ğ
dÙ
) {

208 ià(
hasdÙ
) ;

209 
hasdÙ
 = 1;

211 ià(
	`lisxdig™
(
	`ÿ¡_uch¬
(*
s
))) {

212 ià(
sigdig
 =ğ0 && *
s
 == '0')

213 
nosigdig
++;

214 ià(++
sigdig
 <ğ
MAXSIGDIG
)

215 
r
 = (¸* 
	`ÿ¡_num
(16.0)è+ 
	`luaO_hexav®ue
(*
s
);

216 
e
++;

217 ià(
hasdÙ
è
e
--;

221 ià(
nosigdig
 + 
sigdig
 == 0)

223 *
’d±r
 = 
	`ÿ¡
(*, 
s
);

224 
e
 *= 4;

225 ià(*
s
 == 'p' || *s == 'P') {

226 
exp1
 = 0;

227 
Ãg1
;

228 
s
++;

229 
Ãg1
 = 
	`i¢eg
(&
s
);

230 ià(!
	`lisdig™
(
	`ÿ¡_uch¬
(*
s
)))

232 
	`lisdig™
(
	`ÿ¡_uch¬
(*
s
)))

233 
exp1
 =ƒxp1 * 10 + *(
s
++) - '0';

234 ià(
Ãg1
è
exp1
 = -exp1;

235 
e
 +ğ
exp1
;

236 *
’d±r
 = 
	`ÿ¡
(*, 
s
);

238 ià(
Ãg
è
r
 = -r;

239  
	`l_m©hİ
(
ldexp
)(
r
, 
e
);

240 
	}
}

247 #ià!
defšed
 (
L_MAXLENNUM
)

248 
	#L_MAXLENNUM
 200

	)

251 cÚ¡ *
	$l_¡r2dloc
 (cÚ¡ *
s
, 
lua_Numb”
 *
»suÉ
, 
mode
) {

252 *
’d±r
;

253 *
»suÉ
 = (
mode
 =ğ'x'è? 
	`lua_¡rx2numb”
(
s
, &
’d±r
)

254 : 
	`lua_¡r2numb”
(
s
, &
’d±r
);

255 ià(
’d±r
 =ğ
s
è 
NULL
;

256 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
’d±r
)))ƒndptr++;

257  (*
’d±r
 =ğ'\0'è?ƒnd±¸: 
NULL
;

258 
	}
}

274 cÚ¡ *
	$l_¡r2d
 (cÚ¡ *
s
, 
lua_Numb”
 *
»suÉ
) {

275 cÚ¡ *
’d±r
;

276 cÚ¡ *
pmode
 = 
	`¡½brk
(
s
, ".xXnN");

277 
mode
 = 
pmode
 ? 
	`ÉŞow”
(
	`ÿ¡_uch¬
(*pmode)) : 0;

278 ià(
mode
 == 'n')

279  
NULL
;

280 
’d±r
 = 
	`l_¡r2dloc
(
s
, 
»suÉ
, 
mode
);

281 ià(
’d±r
 =ğ
NULL
) {

282 
buff
[
L_MAXLENNUM
 + 1];

283 cÚ¡ *
pdÙ
 = 
	`¡rchr
(
s
, '.');

284 ià(
	`¡¾’
(
s
è> 
L_MAXLENNUM
 || 
pdÙ
 =ğ
NULL
)

285  
NULL
;

286 
	`¡rıy
(
buff
, 
s
);

287 
buff
[
pdÙ
 - 
s
] = 
	`lua_g‘loÿËdeıošt
();

288 
’d±r
 = 
	`l_¡r2dloc
(
buff
, 
»suÉ
, 
mode
);

289 ià(
’d±r
 !ğ
NULL
)

290 
’d±r
 = 
s
 + (’d±¸- 
buff
);

292  
’d±r
;

293 
	}
}

296 
	#MAXBY10
 
	`ÿ¡
(
lua_UnsigÃd
, 
LUA_MAXINTEGER
 / 10)

	)

297 
	#MAXLASTD
 
	`ÿ¡_št
(
LUA_MAXINTEGER
 % 10)

	)

299 cÚ¡ *
	$l_¡r2št
 (cÚ¡ *
s
, 
lua_IÁeg”
 *
»suÉ
) {

300 
lua_UnsigÃd
 
a
 = 0;

301 
em±y
 = 1;

302 
Ãg
;

303 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
s
))) s++;

304 
Ãg
 = 
	`i¢eg
(&
s
);

305 ià(
s
[0] == '0' &&

306 (
s
[1] == 'x' || s[1] == 'X')) {

307 
s
 += 2;

308 ; 
	`lisxdig™
(
	`ÿ¡_uch¬
(*
s
)); s++) {

309 
a
 =‡ * 16 + 
	`luaO_hexav®ue
(*
s
);

310 
em±y
 = 0;

314 ; 
	`lisdig™
(
	`ÿ¡_uch¬
(*
s
)); s++) {

315 
d
 = *
s
 - '0';

316 ià(
a
 >ğ
MAXBY10
 && (¨> MAXBY10 || 
d
 > 
MAXLASTD
 + 
Ãg
))

317  
NULL
;

318 
a
 =‡ * 10 + 
d
;

319 
em±y
 = 0;

322 
	`lis¥aû
(
	`ÿ¡_uch¬
(*
s
))) s++;

323 ià(
em±y
 || *
s
 !ğ'\0'è 
NULL
;

325 *
»suÉ
 = 
	`l_ÿ¡U2S
((
Ãg
è? 0u - 
a
 :‡);

326  
s
;

328 
	}
}

331 
size_t
 
	$luaO_¡r2num
 (cÚ¡ *
s
, 
TV®ue
 *
o
) {

332 
lua_IÁeg”
 
i
; 
lua_Numb”
 
n
;

333 cÚ¡ *
e
;

334 ià((
e
 = 
	`l_¡r2št
(
s
, &
i
)è!ğ
NULL
) {

335 
	`£tiv®ue
(
o
, 
i
);

337 ià((
e
 = 
	`l_¡r2d
(
s
, &
n
)è!ğ
NULL
) {

338 
	`£tætv®ue
(
o
, 
n
);

342  (
e
 - 
s
) + 1;

343 
	}
}

346 
	$luaO_utf8esc
 (*
buff
, 
x
) {

347 
n
 = 1;

348 
	`lua_as£¹
(
x
 <= 0x10FFFF);

349 ià(
x
 < 0x80)

350 
buff
[
UTF8BUFFSZ
 - 1] = 
	`ÿ¡
(, 
x
);

352 
mfb
 = 0x3f;

354 
buff
[
UTF8BUFFSZ
 - (
n
++)] = 
	`ÿ¡
(, 0x80 | (
x
 & 0x3f));

355 
x
 >>= 6;

356 
mfb
 >>= 1;

357 } 
x
 > 
mfb
);

358 
buff
[
UTF8BUFFSZ
 - 
n
] = 
	`ÿ¡
(, (~
mfb
 << 1è| 
x
);

360  
n
;

361 
	}
}

365 
	#MAXNUMBER2STR
 50

	)

371 
	$luaO_to¡ršg
 (
lua_S‹
 *
L
, 
StkId
 
obj
) {

372 
buff
[
MAXNUMBER2STR
];

373 
size_t
 
Ën
;

374 
	`lua_as£¹
(
	`‰i¢umb”
(
obj
));

375 ià(
	`‰isš‹g”
(
obj
))

376 
Ën
 = 
	`lua_š‹g”2¡r
(
buff
, (buff), 
	`iv®ue
(
obj
));

378 
Ën
 = 
	`lua_numb”2¡r
(
buff
, (buff), 
	`ætv®ue
(
obj
));

379 #ià!
	`defšed
(
LUA_COMPAT_FLOATSTRING
)

380 ià(
buff
[
	`¡r¥n
(buff, "-0123456789")] == '\0') {

381 
buff
[
Ën
++] = 
	`lua_g‘loÿËdeıošt
();

382 
buff
[
Ën
++] = '0';

386 
	`£tsv®ue2s
(
L
, 
obj
, 
	`luaS_Ãwl¡r
(L, 
buff
, 
Ën
));

387 
	}
}

390 
	$push¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

391 
	`£tsv®ue2s
(
L
, L->
tİ
, 
	`luaS_Ãwl¡r
(L, 
¡r
, 
l
));

392 
	`luaD_šùİ
(
L
);

393 
	}
}

400 cÚ¡ *
	$luaO_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, 
va_li¡
 
¬gp
) {

401 
n
 = 0;

403 cÚ¡ *
e
 = 
	`¡rchr
(
fmt
, '%');

404 ià(
e
 =ğ
NULL
) ;

405 
	`push¡r
(
L
, 
fmt
, 
e
 - fmt);

406 *(
e
+1)) {

408 cÚ¡ *
s
 = 
	`va_¬g
(
¬gp
, *);

409 ià(
s
 =ğ
NULL
) s = "(null)";

410 
	`push¡r
(
L
, 
s
, 
	`¡¾’
(s));

414 
buff
 = 
	`ÿ¡
(, 
	`va_¬g
(
¬gp
, ));

415 ià(
	`li¥ršt
(
	`ÿ¡_uch¬
(
buff
)))

416 
	`push¡r
(
L
, &
buff
, 1);

418 
	`luaO_pushf¡ršg
(
L
, "<\\%d>", 
	`ÿ¡_uch¬
(
buff
));

422 
	`£tiv®ue
(
L
->
tİ
, 
	`va_¬g
(
¬gp
, ));

423 
tİ2¡r
;

426 
	`£tiv®ue
(
L
->
tİ
, 
	`ÿ¡
(
lua_IÁeg”
, 
	`va_¬g
(
¬gp
, 
l_uacIÁ
)));

427 
tİ2¡r
;

430 
	`£tætv®ue
(
L
->
tİ
, 
	`ÿ¡_num
(
	`va_¬g
(
¬gp
, 
l_uacNumb”
)));

431 
tİ2¡r
:

432 
	`luaD_šùİ
(
L
);

433 
	`luaO_to¡ršg
(
L
, L->
tİ
 - 1);

437 
buff
[4*(*) + 8];

438 
l
 = 
	`l_¥rštf
(
buff
, (buff), "%p", 
	`va_¬g
(
¬gp
, *));

439 
	`push¡r
(
L
, 
buff
, 
l
);

443 
buff
[
UTF8BUFFSZ
];

444 
l
 = 
	`luaO_utf8esc
(
buff
, 
	`ÿ¡
(, 
	`va_¬g
(
¬gp
, )));

445 
	`push¡r
(
L
, 
buff
 + 
UTF8BUFFSZ
 - 
l
,†);

449 
	`push¡r
(
L
, "%", 1);

453 
	`luaG_ruÃ¼Ü
(
L
, "invalid option '%%%c'o 'lua_pushfstring'",

454 *(
e
 + 1));

457 
n
 += 2;

458 
fmt
 = 
e
+2;

460 
	`luaD_check¡ack
(
L
, 1);

461 
	`push¡r
(
L
, 
fmt
, 
	`¡¾’
(fmt));

462 ià(
n
 > 0è
	`luaV_cÚÿt
(
L
,‚ + 1);

463  
	`sv®ue
(
L
->
tİ
 - 1);

464 
	}
}

467 cÚ¡ *
	$luaO_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...) {

468 cÚ¡ *
msg
;

469 
va_li¡
 
¬gp
;

470 
	`va_¡¬t
(
¬gp
, 
fmt
);

471 
msg
 = 
	`luaO_pushvf¡ršg
(
L
, 
fmt
, 
¬gp
);

472 
	`va_’d
(
¬gp
);

473  
msg
;

474 
	}
}

478 
	#LL
(
x
è((x)/(è- 1)

	)

480 
	#RETS
 "..."

	)

481 
	#PRE
 "[¡ršg \""

	)

482 
	#POS
 "\"]"

	)

484 
	#add¡r
(
a
,
b
,
l
èĞ
	`memıy
×,b,Öè* ()),‡ +ğÖè)

	)

486 
	$luaO_chunkid
 (*
out
, cÚ¡ *
sourû
, 
size_t
 
bufæ’
) {

487 
size_t
 
l
 = 
	`¡¾’
(
sourû
);

488 ià(*
sourû
 == '=') {

489 ià(
l
 <ğ
bufæ’
)

490 
	`memıy
(
out
, 
sourû
 + 1, 
l
 * ());

492 
	`add¡r
(
out
, 
sourû
 + 1, 
bufæ’
 - 1);

493 *
out
 = '\0';

496 ià(*
sourû
 == '@') {

497 ià(
l
 <ğ
bufæ’
)

498 
	`memıy
(
out
, 
sourû
 + 1, 
l
 * ());

500 
	`add¡r
(
out
, 
RETS
, 
	`LL
(RETS));

501 
bufæ’
 -ğ
	`LL
(
RETS
);

502 
	`memıy
(
out
, 
sourû
 + 1 + 
l
 - 
bufæ’
, bufflen * ());

506 cÚ¡ *
Æ
 = 
	`¡rchr
(
sourû
, '\n');

507 
	`add¡r
(
out
, 
PRE
, 
	`LL
(PRE));

508 
bufæ’
 -ğ
	`LL
(
PRE
 
RETS
 
POS
) + 1;

509 ià(
l
 < 
bufæ’
 && 
Æ
 =ğ
NULL
) {

510 
	`add¡r
(
out
, 
sourû
, 
l
);

513 ià(
Æ
 !ğ
NULL
è
l
 =‚È- 
sourû
;

514 ià(
l
 > 
bufæ’
)† = bufflen;

515 
	`add¡r
(
out
, 
sourû
, 
l
);

516 
	`add¡r
(
out
, 
RETS
, 
	`LL
(RETS));

518 
	`memıy
(
out
, 
POS
, (
	`LL
(POS) + 1) * ());

520 
	}
}

	@3rd/lua/lobject.h

8 #iâdeà
lobjeù_h


9 
	#lobjeù_h


	)

12 
	~<¡d¬g.h
>

15 
	~"Îim™s.h
"

16 
	~"lua.h
"

22 
	#LUA_TPROTO
 
LUA_NUMTAGS


	)

23 
	#LUA_TDEADKEY
 (
LUA_NUMTAGS
+1è

	)

28 
	#LUA_TOTALTAGS
 (
LUA_TPROTO
 + 2)

	)

47 
	#LUA_TLCL
 (
LUA_TFUNCTION
 | (0 << 4)è

	)

48 
	#LUA_TLCF
 (
LUA_TFUNCTION
 | (1 << 4)è

	)

49 
	#LUA_TCCL
 (
LUA_TFUNCTION
 | (2 << 4)è

	)

53 
	#LUA_TSHRSTR
 (
LUA_TSTRING
 | (0 << 4)è

	)

54 
	#LUA_TLNGSTR
 (
LUA_TSTRING
 | (1 << 4)è

	)

58 
	#LUA_TNUMFLT
 (
LUA_TNUMBER
 | (0 << 4)è

	)

59 
	#LUA_TNUMINT
 (
LUA_TNUMBER
 | (1 << 4)è

	)

63 
	#BIT_ISCOLLECTABLE
 (1 << 6)

	)

66 
	#ùb
(
t
è(Ñè| 
BIT_ISCOLLECTABLE
)

	)

72 
GCObjeù
 
	tGCObjeù
;

79 
	#CommÚH—d”
 
GCObjeù
 *
Ãxt
; 
lu_by‹
 
‰
;†u_by‹ 
m¬ked


	)

85 
	sGCObjeù
 {

86 
	mCommÚH—d”
;

100 
	uV®ue
 {

101 
GCObjeù
 *
	mgc
;

102 *
	mp
;

103 
	mb
;

104 
lua_CFunùiÚ
 
	mf
;

105 
lua_IÁeg”
 
	mi
;

106 
lua_Numb”
 
	mn
;

107 } 
	tV®ue
;

110 
	#TV®uef›lds
 
V®ue
 
v®ue_
; 
‰_


	)

113 
	slua_TV®ue
 {

114 
	mTV®uef›lds
;

115 } 
	tTV®ue
;

120 
	#NILCONSTANT
 {
NULL
}, 
LUA_TNIL


	)

123 
	#v®_
(
o
è((o)->
v®ue_
)

	)

127 
	#¹ty³
(
o
è((o)->
‰_
)

	)

130 
	#nov¬ŸÁ
(
x
è((xè& 0x0F)

	)

133 
	#‰y³
(
o
è(
	`¹ty³
(oè& 0x3F)

	)

136 
	#‰nov
(
o
è(
	`nov¬ŸÁ
(
	`¹ty³
(o)))

	)

140 
	#checkg
(
o
,
t
è(
	`¹ty³
(oè=ğÑ))

	)

141 
	#checkty³
(
o
,
t
è(
	`‰nov
(oè=ğÑ))

	)

142 
	#‰i¢umb”
(
o
è
	`checkty³
((o), 
LUA_TNUMBER
)

	)

143 
	#‰isæßt
(
o
è
	`checkg
((o), 
LUA_TNUMFLT
)

	)

144 
	#‰isš‹g”
(
o
è
	`checkg
((o), 
LUA_TNUMINT
)

	)

145 
	#‰i¢
(
o
è
	`checkg
((o), 
LUA_TNIL
)

	)

146 
	#‰isboŞ—n
(
o
è
	`checkg
((o), 
LUA_TBOOLEAN
)

	)

147 
	#‰i¦ightu£rd©a
(
o
è
	`checkg
((o), 
LUA_TLIGHTUSERDATA
)

	)

148 
	#‰is¡ršg
(
o
è
	`checkty³
((o), 
LUA_TSTRING
)

	)

149 
	#‰isshr¡ršg
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TSHRSTR
))

	)

150 
	#‰i¦ng¡ršg
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TLNGSTR
))

	)

151 
	#‰i¡abË
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TTABLE
))

	)

152 
	#‰isfunùiÚ
(
o
è
	`checkty³
(o, 
LUA_TFUNCTION
)

	)

153 
	#‰isşosu»
(
o
è((
	`¹ty³
(oè& 0x1Fè=ğ
LUA_TFUNCTION
)

	)

154 
	#‰isCşosu»
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TCCL
))

	)

155 
	#‰isLşosu»
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TLCL
))

	)

156 
	#‰i¦cf
(
o
è
	`checkg
((o), 
LUA_TLCF
)

	)

157 
	#‰isfuÎu£rd©a
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TUSERDATA
))

	)

158 
	#‰i¡h»ad
(
o
è
	`checkg
((o), 
	`ùb
(
LUA_TTHREAD
))

	)

159 
	#‰isd—dkey
(
o
è
	`checkg
((o), 
LUA_TDEADKEY
)

	)

163 
	#iv®ue
(
o
è
	`check_exp
(
	`‰isš‹g”
(o), 
	`v®_
(o).
i
)

	)

164 
	#ætv®ue
(
o
è
	`check_exp
(
	`‰isæßt
(o), 
	`v®_
(o).
n
)

	)

165 
	#nv®ue
(
o
è
	`check_exp
(
	`‰i¢umb”
(o), \

166 (
	`‰isš‹g”
(
o
è? 
	`ÿ¡_num
(
	`iv®ue
(o)è: 
	`ætv®ue
(o)))

	)

167 
	#gcv®ue
(
o
è
	`check_exp
(
	`iscŞËùabË
(o), 
	`v®_
(o).
gc
)

	)

168 
	#pv®ue
(
o
è
	`check_exp
(
	`‰i¦ightu£rd©a
(o), 
	`v®_
(o).
p
)

	)

169 
	#tsv®ue
(
o
è
	`check_exp
(
	`‰is¡ršg
(o), 
	`gco2ts
(
	`v®_
(o).
gc
))

	)

170 
	#uv®ue
(
o
è
	`check_exp
(
	`‰isfuÎu£rd©a
(o), 
	`gco2u
(
	`v®_
(o).
gc
))

	)

171 
	#şv®ue
(
o
è
	`check_exp
(
	`‰isşosu»
(o), 
	`gco2ş
(
	`v®_
(o).
gc
))

	)

172 
	#şLv®ue
(
o
è
	`check_exp
(
	`‰isLşosu»
(o), 
	`gco2lş
(
	`v®_
(o).
gc
))

	)

173 
	#şCv®ue
(
o
è
	`check_exp
(
	`‰isCşosu»
(o), 
	`gco2cş
(
	`v®_
(o).
gc
))

	)

174 
	#fv®ue
(
o
è
	`check_exp
(
	`‰i¦cf
(o), 
	`v®_
(o).
f
)

	)

175 
	#hv®ue
(
o
è
	`check_exp
(
	`‰i¡abË
(o), 
	`gco2t
(
	`v®_
(o).
gc
))

	)

176 
	#bv®ue
(
o
è
	`check_exp
(
	`‰isboŞ—n
(o), 
	`v®_
(o).
b
)

	)

177 
	#thv®ue
(
o
è
	`check_exp
(
	`‰i¡h»ad
(o), 
	`gco2th
(
	`v®_
(o).
gc
))

	)

179 
	#d—dv®ue
(
o
è
	`check_exp
(
	`‰isd—dkey
(o), 
	`ÿ¡
(*, 
	`v®_
(o).
gc
))

	)

181 
	#l_isçl£
(
o
è(
	`‰i¢
(oè|| (
	`‰isboŞ—n
(oè&& 
	`bv®ue
(oè=ğ0))

	)

184 
	#iscŞËùabË
(
o
è(
	`¹ty³
(oè& 
BIT_ISCOLLECTABLE
)

	)

188 
	#righ‰t
(
obj
è(
	`‰y³
(objè=ğ
	`gcv®ue
(obj)->
‰
)

	)

190 
	#checkliv’ess
(
L
,
obj
) \

191 
	`lua_lÚgas£¹
(!
	`iscŞËùabË
(
obj
) || \

192 (
	`righ‰t
(
obj
è&& (
L
 =ğ
NULL
 || !
	`isd—d
(
	`G
(L),
	`gcv®ue
(obj)))))

	)

196 
	#£‰t_
(
o
,
t
è((o)->
‰_
=Ñ))

	)

198 
	#£tætv®ue
(
obj
,
x
) \

199 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
n
=(
x
); 
	`£‰t_
(io, 
LUA_TNUMFLT
); }

	)

201 
	#chgætv®ue
(
obj
,
x
) \

202 { 
TV®ue
 *
io
=(
obj
); 
	`lua_as£¹
(
	`‰isæßt
(io)); 
	`v®_
(io).
n
=(
x
); }

	)

204 
	#£tiv®ue
(
obj
,
x
) \

205 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
i
=(
x
); 
	`£‰t_
(io, 
LUA_TNUMINT
); }

	)

207 
	#chgiv®ue
(
obj
,
x
) \

208 { 
TV®ue
 *
io
=(
obj
); 
	`lua_as£¹
(
	`‰isš‹g”
(io)); 
	`v®_
(io).
i
=(
x
); }

	)

210 
	#£Šv®ue
(
obj
è
	`£‰t_
(obj, 
LUA_TNIL
)

	)

212 
	#£tfv®ue
(
obj
,
x
) \

213 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
f
=(
x
); 
	`£‰t_
(io, 
LUA_TLCF
); }

	)

215 
	#£v®ue
(
obj
,
x
) \

216 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
p
=(
x
); 
	`£‰t_
(io, 
LUA_TLIGHTUSERDATA
); }

	)

218 
	#£tbv®ue
(
obj
,
x
) \

219 { 
TV®ue
 *
io
=(
obj
); 
	`v®_
(io).
b
=(
x
); 
	`£‰t_
(io, 
LUA_TBOOLEAN
); }

	)

221 
	#£tgcov®ue
(
L
,
obj
,
x
) \

222 { 
TV®ue
 *
io
 = (
obj
); 
GCObjeù
 *
i_g
=(
x
); \

223 
	`v®_
(
io
).
gc
 = 
i_g
; 
	`£‰t_
(io, 
	`ùb
(i_g->
‰
)); }

	)

225 
	#£tsv®ue
(
L
,
obj
,
x
) \

226 { 
TV®ue
 *
io
 = (
obj
); 
TSŒšg
 *
x_
 = (
x
); \

227 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(x_->
‰
)); \

228 
	`checkliv’ess
(
L
,
io
); }

	)

230 
	#£tuv®ue
(
L
,
obj
,
x
) \

231 { 
TV®ue
 *
io
 = (
obj
); 
Ud©a
 *
x_
 = (
x
); \

232 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TUSERDATA
)); \

233 
	`checkliv’ess
(
L
,
io
); }

	)

235 
	#£‰hv®ue
(
L
,
obj
,
x
) \

236 { 
TV®ue
 *
io
 = (
obj
); 
lua_S‹
 *
x_
 = (
x
); \

237 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TTHREAD
)); \

238 
	`checkliv’ess
(
L
,
io
); }

	)

240 
	#£tşLv®ue
(
L
,
obj
,
x
) \

241 { 
TV®ue
 *
io
 = (
obj
); 
LClosu»
 *
x_
 = (
x
); \

242 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TLCL
)); \

243 
	`checkliv’ess
(
L
,
io
); }

	)

245 
	#£tşCv®ue
(
L
,
obj
,
x
) \

246 { 
TV®ue
 *
io
 = (
obj
); 
CClosu»
 *
x_
 = (
x
); \

247 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TCCL
)); \

248 
	`checkliv’ess
(
L
,
io
); }

	)

250 
	#£thv®ue
(
L
,
obj
,
x
) \

251 { 
TV®ue
 *
io
 = (
obj
); 
TabË
 *
x_
 = (
x
); \

252 
	`v®_
(
io
).
gc
 = 
	`obj2gco
(
x_
); 
	`£‰t_
(io, 
	`ùb
(
LUA_TTABLE
)); \

253 
	`checkliv’ess
(
L
,
io
); }

	)

255 
	#£td—dv®ue
(
obj
è
	`£‰t_
(obj, 
LUA_TDEADKEY
)

	)

259 
	#£tobj
(
L
,
obj1
,
obj2
) \

260 { 
TV®ue
 *
io1
=(
obj1
); *io1 = *(
obj2
); \

261 ()
L
; 
	`checkliv’ess
(L,
io1
); }

	)

269 
	#£tobjs2s
 
£tobj


	)

271 
	#£tobj2s
 
£tobj


	)

272 
	#£tsv®ue2s
 
£tsv®ue


	)

273 
	#£thv®ue2s
 
£thv®ue


	)

274 
	#£tv®ue2s
 
£tv®ue


	)

276 
	#£tobjt2t
 
£tobj


	)

278 
	#£tobj2n
 
£tobj


	)

279 
	#£tsv®ue2n
 
£tsv®ue


	)

282 
	#£tobj2t
(
L
,
o1
,
o2
è(()L, *(o1)=*(o2), 
	`checkliv’ess
(L,(o1)))

	)

294 
TV®ue
 *
	tStkId
;

303 
	sTSŒšg
 {

304 
	mCommÚH—d”
;

305 
lu_by‹
 
	mexŒa
;

306 
lu_by‹
 
	msh¾’
;

307 
	mhash
;

309 
size_t
 
	mÊgËn
;

310 
TSŒšg
 *
	mhÃxt
;

311 } 
	mu
;

312 } 
	tTSŒšg
;

318 
	uUTSŒšg
 {

319 
L_Umax®ign
 
	mdummy
;

320 
TSŒšg
 
	mtsv
;

321 } 
	tUTSŒšg
;

328 
	#g‘¡r
(
ts
) \

329 
	`check_exp
(((
ts
)->
exŒa
), 
	`ÿ¡
(*, (ts)è+ (
UTSŒšg
))

	)

333 
	#sv®ue
(
o
è
	`g‘¡r
(
	`tsv®ue
(o))

	)

336 
	#ts¦’
(
s
è((s)->
‰
 =ğ
LUA_TSHRSTR
 ? (s)->
sh¾’
 : (s)->
u
.
ÊgËn
)

	)

339 
	#v¦’
(
o
è
	`ts¦’
(
	`tsv®ue
(o))

	)

346 
	sUd©a
 {

347 
	mCommÚH—d”
;

348 
lu_by‹
 
	m‰uv_
;

349 
TabË
 *
	mm‘©abË
;

350 
size_t
 
	mËn
;

351 
V®ue
 
	mu£r_
;

352 } 
	tUd©a
;

358 
	uUUd©a
 {

359 
L_Umax®ign
 
	mdummy
;

360 
Ud©a
 
	muv
;

361 } 
	tUUd©a
;

368 
	#g‘ud©amem
(
u
) \

369 
	`check_exp
(((
u
)->
‰uv_
), (
	`ÿ¡
(*, (u)è+ (
UUd©a
)))

	)

371 
	#£tu£rv®ue
(
L
,
u
,
o
) \

372 { cÚ¡ 
TV®ue
 *
io
=(
o
); 
Ud©a
 *
iu
 = (
u
); \

373 
iu
->
u£r_
 = 
io
->
v®ue_
; iu->
‰uv_
 = 
	`¹ty³
(io); \

374 
	`checkliv’ess
(
L
,
io
); }

	)

377 
	#g‘u£rv®ue
(
L
,
u
,
o
) \

378 { 
TV®ue
 *
io
=(
o
); cÚ¡ 
Ud©a
 *
iu
 = (
u
); \

379 
io
->
v®ue_
 = 
iu
->
u£r_
; 
	`£‰t_
(io, iu->
‰uv_
); \

380 
	`checkliv’ess
(
L
,
io
); }

	)

386 
	sUpv®desc
 {

387 
TSŒšg
 *
	mÇme
;

388 
lu_by‹
 
	mš¡ack
;

389 
lu_by‹
 
	midx
;

390 } 
	tUpv®desc
;

397 
	sLocV¬
 {

398 
TSŒšg
 *
	mv¬Çme
;

399 
	m¡¬c
;

400 
	m’dpc
;

401 } 
	tLocV¬
;

403 
	sSh¬edPrÙo
 {

404 
lu_by‹
 
	mnum·¿ms
;

405 
lu_by‹
 
	mis_v¬¬g
;

406 
lu_by‹
 
	mmax¡acksize
;

407 
	msizeupv®ues
;

408 
	msizek
;

409 
	msizecode
;

410 
	msiz–šešfo
;

411 
	msiz•
;

412 
	msiz–ocv¬s
;

413 
	mlšedefšed
;

414 
	mÏ¡lšedefšed
;

415 *
	ml_G
;

416 
In¡ruùiÚ
 *
	mcode
;

417 *
	mlšešfo
;

418 
LocV¬
 *
	mlocv¬s
;

419 
Upv®desc
 *
	mupv®ues
;

420 
TSŒšg
 *
	msourû
;

421 } 
	tSh¬edPrÙo
;

426 
	sPrÙo
 {

427 
	mCommÚH—d”
;

428 
Sh¬edPrÙo
 *
	m¥
;

429 
TV®ue
 *
	mk
;

430 
PrÙo
 **
	mp
;

431 
LClosu»
 *
	mÿche
;

432 
GCObjeù
 *
	mgşi¡
;

433 } 
	tPrÙo
;

440 
UpV®
 
	tUpV®
;

447 
	#Closu»H—d”
 \

448 
CommÚH—d”
; 
lu_by‹
 
nupv®ues
; 
GCObjeù
 *
gşi¡


	)

450 
	sCClosu»
 {

451 
	mClosu»H—d”
;

452 
lua_CFunùiÚ
 
	mf
;

453 
TV®ue
 
	mupv®ue
[1];

454 } 
	tCClosu»
;

457 
	sLClosu»
 {

458 
	mClosu»H—d”
;

459 
PrÙo
 *
	mp
;

460 
UpV®
 *
	mupv®s
[1];

461 } 
	tLClosu»
;

464 
	uClosu»
 {

465 
CClosu»
 
	mc
;

466 
LClosu»
 
	ml
;

467 } 
	tClosu»
;

470 
	#isLfunùiÚ
(
o
è
	`‰isLşosu»
(o)

	)

472 
	#g‘´Ùo
(
o
è(
	`şLv®ue
(o)->
p
)

	)

479 
	uTKey
 {

481 
	mTV®uef›lds
;

482 
	mÃxt
;

483 } 
	mnk
;

484 
TV®ue
 
	mtvk
;

485 } 
	tTKey
;

489 
	#£Šodekey
(
L
,
key
,
obj
) \

490 { 
TKey
 *
k_
=(
key
); cÚ¡ 
TV®ue
 *
io_
=(
obj
); \

491 
k_
->
nk
.
v®ue_
 = 
io_
->v®ue_; k_->nk.
‰_
 = io_->tt_; \

492 ()
L
; 
	`checkliv’ess
(L,
io_
); }

	)

495 
	sNode
 {

496 
TV®ue
 
	mi_v®
;

497 
TKey
 
	mi_key
;

498 } 
	tNode
;

501 
	sTabË
 {

502 
	mCommÚH—d”
;

503 
lu_by‹
 
	mæags
;

504 
lu_by‹
 
	mlsiz’ode
;

505 
	msiz—¼ay
;

506 
TV®ue
 *
	m¬¿y
;

507 
Node
 *
	mnode
;

508 
Node
 *
	mÏ¡ä“
;

509 
TabË
 *
	mm‘©abË
;

510 
GCObjeù
 *
	mgşi¡
;

511 } 
	tTabË
;

518 
	#lmod
(
s
,
size
) \

519 (
	`check_exp
((
size
&(size-1))==0, (
	`ÿ¡
(, (
s
è& ((size)-1)))))

	)

522 
	#twÙo
(
x
è(1<<(x))

	)

523 
	#siz’ode
(
t
è(
	`twÙo
(Ñ)->
lsiz’ode
))

	)

529 
	#luaO_nobjeù
 (&
luaO_nobjeù_
)

	)

532 
LUAI_DDEC
 cÚ¡ 
TV®ue
 
	gluaO_nobjeù_
;

535 
	#UTF8BUFFSZ
 8

	)

537 
LUAI_FUNC
 
luaO_št2fb
 (
x
);

538 
LUAI_FUNC
 
luaO_fb2št
 (
x
);

539 
LUAI_FUNC
 
luaO_utf8esc
 (*
buff
, 
x
);

540 
LUAI_FUNC
 
luaO_ûlog2
 (
x
);

541 
LUAI_FUNC
 
luaO_¬™h
 (
lua_S‹
 *
L
, 
İ
, cÚ¡ 
TV®ue
 *
p1
,

542 cÚ¡ 
TV®ue
 *
p2
, TV®u*
»s
);

543 
LUAI_FUNC
 
size_t
 
luaO_¡r2num
 (cÚ¡ *
s
, 
TV®ue
 *
o
);

544 
LUAI_FUNC
 
luaO_hexav®ue
 (
c
);

545 
LUAI_FUNC
 
luaO_to¡ršg
 (
lua_S‹
 *
L
, 
StkId
 
obj
);

546 
LUAI_FUNC
 cÚ¡ *
luaO_pushvf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
,

547 
va_li¡
 
¬gp
);

548 
LUAI_FUNC
 cÚ¡ *
luaO_pushf¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

549 
LUAI_FUNC
 
luaO_chunkid
 (*
out
, cÚ¡ *
sourû
, 
size_t
 
Ën
);

	@3rd/lua/lopcodes.c

7 
	#lİcodes_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

15 
	~"lİcodes.h
"

20 
LUAI_DDEF
 cÚ¡ *cÚ¡ 
	gluaP_İÇmes
[
NUM_OPCODES
+1] = {

68 
NULL


72 
	#İmode
(
t
,
a
,
b
,
c
,
m
è((Ñ)<<7è| (×)<<6è| ((b)<<4è| ((c)<<2è| (m))

	)

74 
LUAI_DDEF
 cÚ¡ 
lu_by‹
 
	gluaP_İmodes
[
NUM_OPCODES
] = {

76 
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

77 ,
İmode
(0, 1, 
OpArgK
, 
OpArgN
, 
iABx
)

78 ,
İmode
(0, 1, 
OpArgN
, OpArgN, 
iABx
)

79 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

80 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

81 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

82 ,
İmode
(0, 1, 
OpArgU
, 
OpArgK
, 
iABC
)

83 ,
İmode
(0, 1, 
OpArgR
, 
OpArgK
, 
iABC
)

84 ,
İmode
(0, 0, 
OpArgK
, OpArgK, 
iABC
)

85 ,
İmode
(0, 0, 
OpArgU
, 
OpArgN
, 
iABC
)

86 ,
İmode
(0, 0, 
OpArgK
, OpArgK, 
iABC
)

87 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

88 ,
İmode
(0, 1, 
OpArgR
, 
OpArgK
, 
iABC
)

89 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

90 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

91 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

92 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

93 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

94 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

95 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

96 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

97 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

98 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

99 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

100 ,
İmode
(0, 1, 
OpArgK
, OpArgK, 
iABC
)

101 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

102 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

103 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

104 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iABC
)

105 ,
İmode
(0, 1, 
OpArgR
, OpArgR, 
iABC
)

106 ,
İmode
(0, 0, 
OpArgR
, 
OpArgN
, 
iAsBx
)

107 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

108 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

109 ,
İmode
(1, 0, 
OpArgK
, OpArgK, 
iABC
)

110 ,
İmode
(1, 0, 
OpArgN
, 
OpArgU
, 
iABC
)

111 ,
İmode
(1, 1, 
OpArgR
, 
OpArgU
, 
iABC
)

112 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

113 ,
İmode
(0, 1, 
OpArgU
, OpArgU, 
iABC
)

114 ,
İmode
(0, 0, 
OpArgU
, 
OpArgN
, 
iABC
)

115 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

116 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

117 ,
İmode
(0, 0, 
OpArgN
, 
OpArgU
, 
iABC
)

118 ,
İmode
(0, 1, 
OpArgR
, 
OpArgN
, 
iAsBx
)

119 ,
İmode
(0, 0, 
OpArgU
, OpArgU, 
iABC
)

120 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABx
)

121 ,
İmode
(0, 1, 
OpArgU
, 
OpArgN
, 
iABC
)

122 ,
İmode
(0, 0, 
OpArgU
, OpArgU, 
iAx
)

	@3rd/lua/lopcodes.h

7 #iâdeà
lİcodes_h


8 
	#lİcodes_h


	)

10 
	~"Îim™s.h
"

32 
	eOpMode
 {
	miABC
, 
	miABx
, 
	miAsBx
, 
	miAx
};

38 
	#SIZE_C
 9

	)

39 
	#SIZE_B
 9

	)

40 
	#SIZE_Bx
 (
SIZE_C
 + 
SIZE_B
)

	)

41 
	#SIZE_A
 8

	)

42 
	#SIZE_Ax
 (
SIZE_C
 + 
SIZE_B
 + 
SIZE_A
)

	)

44 
	#SIZE_OP
 6

	)

46 
	#POS_OP
 0

	)

47 
	#POS_A
 (
POS_OP
 + 
SIZE_OP
)

	)

48 
	#POS_C
 (
POS_A
 + 
SIZE_A
)

	)

49 
	#POS_B
 (
POS_C
 + 
SIZE_C
)

	)

50 
	#POS_Bx
 
POS_C


	)

51 
	#POS_Ax
 
POS_A


	)

59 #ià
SIZE_Bx
 < 
LUAI_BITSINT
-1

60 
	#MAXARG_Bx
 ((1<<
SIZE_Bx
)-1)

	)

61 
	#MAXARG_sBx
 (
MAXARG_Bx
>>1è

	)

63 
	#MAXARG_Bx
 
MAX_INT


	)

64 
	#MAXARG_sBx
 
MAX_INT


	)

67 #ià
SIZE_Ax
 < 
LUAI_BITSINT
-1

68 
	#MAXARG_Ax
 ((1<<
SIZE_Ax
)-1)

	)

70 
	#MAXARG_Ax
 
MAX_INT


	)

74 
	#MAXARG_A
 ((1<<
SIZE_A
)-1)

	)

75 
	#MAXARG_B
 ((1<<
SIZE_B
)-1)

	)

76 
	#MAXARG_C
 ((1<<
SIZE_C
)-1)

	)

80 
	#MASK1
(
n
,
p
è((~((~(
In¡ruùiÚ
)0)<<Ò)))<<Õ))

	)

83 
	#MASK0
(
n
,
p
è(~
	`MASK1
Ò,p))

	)

89 
	#GET_OPCODE
(
i
è(
	`ÿ¡
(
OpCode
, ((i)>>
POS_OP
è& 
	`MASK1
(
SIZE_OP
,0)))

	)

90 
	#SET_OPCODE
(
i
,
o
è((ièğ(((i)&
	`MASK0
(
SIZE_OP
,
POS_OP
)) | \

91 ((
	`ÿ¡
(
In¡ruùiÚ
, 
o
)<<
POS_OP
)&
	`MASK1
(
SIZE_OP
,POS_OP))))

	)

93 
	#g‘¬g
(
i
,
pos
,
size
è(
	`ÿ¡
(, ((i)>>posè& 
	`MASK1
(size,0)))

	)

94 
	#£rg
(
i
,
v
,
pos
,
size
è((ièğ(((i)&
	`MASK0
(size,pos)) | \

95 ((
	`ÿ¡
(
In¡ruùiÚ
, 
v
)<<
pos
)&
	`MASK1
(
size
,pos))))

	)

97 
	#GETARG_A
(
i
è
	`g‘¬g
(i, 
POS_A
, 
SIZE_A
)

	)

98 
	#SETARG_A
(
i
,
v
è
	`£rg
(i, v, 
POS_A
, 
SIZE_A
)

	)

100 
	#GETARG_B
(
i
è
	`g‘¬g
(i, 
POS_B
, 
SIZE_B
)

	)

101 
	#SETARG_B
(
i
,
v
è
	`£rg
(i, v, 
POS_B
, 
SIZE_B
)

	)

103 
	#GETARG_C
(
i
è
	`g‘¬g
(i, 
POS_C
, 
SIZE_C
)

	)

104 
	#SETARG_C
(
i
,
v
è
	`£rg
(i, v, 
POS_C
, 
SIZE_C
)

	)

106 
	#GETARG_Bx
(
i
è
	`g‘¬g
(i, 
POS_Bx
, 
SIZE_Bx
)

	)

107 
	#SETARG_Bx
(
i
,
v
è
	`£rg
(i, v, 
POS_Bx
, 
SIZE_Bx
)

	)

109 
	#GETARG_Ax
(
i
è
	`g‘¬g
(i, 
POS_Ax
, 
SIZE_Ax
)

	)

110 
	#SETARG_Ax
(
i
,
v
è
	`£rg
(i, v, 
POS_Ax
, 
SIZE_Ax
)

	)

112 
	#GETARG_sBx
(
i
è(
	`GETARG_Bx
(i)-
MAXARG_sBx
)

	)

113 
	#SETARG_sBx
(
i
,
b
è
	`SETARG_Bx
((i),
	`ÿ¡
(, (b)+
MAXARG_sBx
))

	)

116 
	#CREATE_ABC
(
o
,
a
,
b
,
c
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

117 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_A
) \

118 | (
	`ÿ¡
(
In¡ruùiÚ
, 
b
)<<
POS_B
) \

119 | (
	`ÿ¡
(
In¡ruùiÚ
, 
c
)<<
POS_C
))

	)

121 
	#CREATE_ABx
(
o
,
a
,
bc
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

122 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_A
) \

123 | (
	`ÿ¡
(
In¡ruùiÚ
, 
bc
)<<
POS_Bx
))

	)

125 
	#CREATE_Ax
(
o
,
a
è((
	`ÿ¡
(
In¡ruùiÚ
, o)<<
POS_OP
) \

126 | (
	`ÿ¡
(
In¡ruùiÚ
, 
a
)<<
POS_Ax
))

	)

134 
	#BITRK
 (1 << (
SIZE_B
 - 1))

	)

137 
	#ISK
(
x
è((xè& 
BITRK
)

	)

140 
	#INDEXK
(
r
è(()Ôè& ~
BITRK
)

	)

142 #ià!
defšed
(
MAXINDEXRK
)

143 
	#MAXINDEXRK
 (
BITRK
 - 1)

	)

147 
	#RKASK
(
x
è((xè| 
BITRK
)

	)

153 
	#NO_REG
 
MAXARG_A


	)

171 
	mOP_MOVE
,

172 
	mOP_LOADK
,

173 
	mOP_LOADKX
,

174 
	mOP_LOADBOOL
,

175 
	mOP_LOADNIL
,

176 
	mOP_GETUPVAL
,

178 
	mOP_GETTABUP
,

179 
	mOP_GETTABLE
,

181 
	mOP_SETTABUP
,

182 
	mOP_SETUPVAL
,

183 
	mOP_SETTABLE
,

185 
	mOP_NEWTABLE
,

187 
	mOP_SELF
,

189 
	mOP_ADD
,

190 
	mOP_SUB
,

191 
	mOP_MUL
,

192 
	mOP_MOD
,

193 
	mOP_POW
,

194 
	mOP_DIV
,

195 
	mOP_IDIV
,

196 
	mOP_BAND
,

197 
	mOP_BOR
,

198 
	mOP_BXOR
,

199 
	mOP_SHL
,

200 
	mOP_SHR
,

201 
	mOP_UNM
,

202 
	mOP_BNOT
,

203 
	mOP_NOT
,

204 
	mOP_LEN
,

206 
	mOP_CONCAT
,

208 
	mOP_JMP
,

209 
	mOP_EQ
,

210 
	mOP_LT
,

211 
	mOP_LE
,

213 
	mOP_TEST
,

214 
	mOP_TESTSET
,

216 
	mOP_CALL
,

217 
	mOP_TAILCALL
,

218 
	mOP_RETURN
,

220 
	mOP_FORLOOP
,

222 
	mOP_FORPREP
,

224 
	mOP_TFORCALL
,

225 
	mOP_TFORLOOP
,

227 
	mOP_SETLIST
,

229 
	mOP_CLOSURE
,

231 
	mOP_VARARG
,

233 
	mOP_EXTRAARG


234 } 
	tOpCode
;

237 
	#NUM_OPCODES
 (
	`ÿ¡
(, 
OP_EXTRAARG
è+ 1)

	)

274 
	eOpArgMask
 {

275 
	mOpArgN
,

276 
	mOpArgU
,

277 
	mOpArgR
,

278 
	mOpArgK


281 
LUAI_DDEC
 cÚ¡ 
lu_by‹
 
	gluaP_İmodes
[
NUM_OPCODES
];

283 
	#g‘OpMode
(
m
è(
	`ÿ¡
(
OpMode
, 
luaP_İmodes
[m] & 3))

	)

284 
	#g‘BMode
(
m
è(
	`ÿ¡
(
OpArgMask
, (
luaP_İmodes
[m] >> 4è& 3))

	)

285 
	#g‘CMode
(
m
è(
	`ÿ¡
(
OpArgMask
, (
luaP_İmodes
[m] >> 2è& 3))

	)

286 
	#‹¡AMode
(
m
è(
luaP_İmodes
[m] & (1 << 6))

	)

287 
	#‹¡TMode
(
m
è(
luaP_İmodes
[m] & (1 << 7))

	)

290 
LUAI_DDEC
 cÚ¡ *cÚ¡ 
	gluaP_İÇmes
[
NUM_OPCODES
+1];

294 
	#LFIELDS_PER_FLUSH
 50

	)

	@3rd/lua/loslib.c

7 
	#lo¦ib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<”ºo.h
>

14 
	~<loÿË.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

17 
	~<time.h
>

19 
	~"lua.h
"

21 
	~"Ïuxlib.h
"

22 
	~"lu®ib.h
"

31 #ià!
defšed
(
LUA_STRFTIMEOPTIONS
)

34 
	#L_STRFTIMEC89
 "aAbBcdHIjmMpSUwWxXyYZ%"

	)

37 
	#L_STRFTIMEC99
 "aAbBcCdDeFgGhHIjmMnprRStTuUVwWxXyYzZ%" \

38 "||" "EcECExEXEyEY" "OdOeOHOIOmOMOSOuOUOVOwOWOy"

	)

41 
	#L_STRFTIMEWIN
 "aAbBcdHIjmMpSUwWxXyYzZ%" \

42 "||" "#c#x#d#H#I#j#m#M#S#U#w#W#y#Y"

	)

44 #ià
defšed
(
LUA_USE_WINDOWS
)

45 
	#LUA_STRFTIMEOPTIONS
 
L_STRFTIMEWIN


	)

46 #–ià
defšed
(
LUA_USE_C89
)

47 
	#LUA_STRFTIMEOPTIONS
 
L_STRFTIMEC89


	)

49 
	#LUA_STRFTIMEOPTIONS
 
L_STRFTIMEC99


	)

62 #ià!
defšed
(
l_time_t
)

66 
	#l_tim‘
 
lua_IÁeg”


	)

67 
	#l_pushtime
(
L
,
t
è
	`lua_pushš‹g”
(L,(
lua_IÁeg”
)Ñ))

	)

69 
time_t
 
	$l_checktime
 (
lua_S‹
 *
L
, 
¬g
) {

70 
lua_IÁeg”
 
t
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

71 
	`luaL_¬gcheck
(
L
, (
time_t
)
t
 =ğt, 
¬g
, "time out-of-bounds");

72  (
time_t
)
t
;

73 
	}
}

78 #ià!
defšed
(
l_gmtime
)

84 #ià
defšed
(
LUA_USE_POSIX
)

86 
	#l_gmtime
(
t
,
r
è
	`gmtime_r
Ñ,r)

	)

87 
	#l_loÿÉime
(
t
,
r
è
	`loÿÉime_r
Ñ,r)

	)

92 
	#l_gmtime
(
t
,
r
è(()Ô)->
tm_£c
, 
	`gmtime
Ñ))

	)

93 
	#l_loÿÉime
(
t
,
r
è(()Ô)->
tm_£c
, 
	`loÿÉime
Ñ))

	)

109 #ià!
defšed
(
lua_tm²am
)

111 #ià
defšed
(
LUA_USE_POSIX
)

113 
	~<uni¡d.h
>

115 
	#LUA_TMPNAMBUFSIZE
 32

	)

117 #ià!
defšed
(
LUA_TMPNAMTEMPLATE
)

118 
	#LUA_TMPNAMTEMPLATE
 "/tmp/lua_XXXXXX"

	)

121 
	#lua_tm²am
(
b
,
e
) { \

122 
	`¡rıy
(
b
, 
LUA_TMPNAMTEMPLATE
); \

123 
e
 = 
	`mk¡emp
(
b
); \

124 ià(
e
 !ğ-1è
	`şo£
(e); \

125 
e
 = (=ğ-1); }

	)

130 
	#LUA_TMPNAMBUFSIZE
 
L_tm²am


	)

131 
	#lua_tm²am
(
b
,
e
è{ƒ = (
	`tm²am
(bè=ğ
NULL
); }

	)

141 
	$os_execu‹
 (
lua_S‹
 *
L
) {

142 cÚ¡ *
cmd
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

143 
¡©
 = 
	`sy¡em
(
cmd
);

144 ià(
cmd
 !ğ
NULL
)

145  
	`luaL_exeüesuÉ
(
L
, 
¡©
);

147 
	`lua_pushboŞ—n
(
L
, 
¡©
);

150 
	}
}

153 
	$os_»move
 (
lua_S‹
 *
L
) {

154 cÚ¡ *
f’ame
 = 
	`luaL_check¡ršg
(
L
, 1);

155  
	`luaL_f”esuÉ
(
L
, 
	`»move
(
f’ame
) == 0, filename);

156 
	}
}

159 
	$os_»Çme
 (
lua_S‹
 *
L
) {

160 cÚ¡ *
äomÇme
 = 
	`luaL_check¡ršg
(
L
, 1);

161 cÚ¡ *
tÚame
 = 
	`luaL_check¡ršg
(
L
, 2);

162  
	`luaL_f”esuÉ
(
L
, 
	`»Çme
(
äomÇme
, 
tÚame
è=ğ0, 
NULL
);

163 
	}
}

166 
	$os_tm²ame
 (
lua_S‹
 *
L
) {

167 
buff
[
LUA_TMPNAMBUFSIZE
];

168 
”r
;

169 
	`lua_tm²am
(
buff
, 
”r
);

170 ià(
”r
)

171  
	`luaL_”rÜ
(
L
, "unableo generate‡ unique filename");

172 
	`lua_push¡ršg
(
L
, 
buff
);

174 
	}
}

177 
	$os_g‘’v
 (
lua_S‹
 *
L
) {

178 
	`lua_push¡ršg
(
L
, 
	`g‘’v
(
	`luaL_check¡ršg
(L, 1)));

180 
	}
}

183 
	$os_şock
 (
lua_S‹
 *
L
) {

184 
	`lua_pushnumb”
(
L
, ((
lua_Numb”
)
	`şock
())/Öua_Numb”)
CLOCKS_PER_SEC
);

186 
	}
}

197 
	$£tf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
v®ue
) {

198 
	`lua_pushš‹g”
(
L
, 
v®ue
);

199 
	`lua_£tf›ld
(
L
, -2, 
key
);

200 
	}
}

202 
	$£tboŞf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
v®ue
) {

203 ià(
v®ue
 < 0)

205 
	`lua_pushboŞ—n
(
L
, 
v®ue
);

206 
	`lua_£tf›ld
(
L
, -2, 
key
);

207 
	}
}

213 
	$£Îf›lds
 (
lua_S‹
 *
L
, 
tm
 *
¡m
) {

214 
	`£tf›ld
(
L
, "£c", 
¡m
->
tm_£c
);

215 
	`£tf›ld
(
L
, "mš", 
¡m
->
tm_mš
);

216 
	`£tf›ld
(
L
, "hour", 
¡m
->
tm_hour
);

217 
	`£tf›ld
(
L
, "day", 
¡m
->
tm_mday
);

218 
	`£tf›ld
(
L
, "mÚth", 
¡m
->
tm_mÚ
 + 1);

219 
	`£tf›ld
(
L
, "y—r", 
¡m
->
tm_y—r
 + 1900);

220 
	`£tf›ld
(
L
, "wday", 
¡m
->
tm_wday
 + 1);

221 
	`£tf›ld
(
L
, "yday", 
¡m
->
tm_yday
 + 1);

222 
	`£tboŞf›ld
(
L
, "isd¡", 
¡m
->
tm_isd¡
);

223 
	}
}

226 
	$g‘boŞf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
) {

227 
»s
;

228 
»s
 = (
	`lua_g‘f›ld
(
L
, -1, 
key
è=ğ
LUA_TNIL
è? -1 : 
	`lua_toboŞ—n
(L, -1);

229 
	`lua_pİ
(
L
, 1);

230  
»s
;

231 
	}
}

235 #ià!
defšed
(
L_MAXDATEFIELD
)

236 
	#L_MAXDATEFIELD
 (
INT_MAX
 / 2)

	)

239 
	$g‘f›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
d
, 
d–
) {

240 
i¢um
;

241 
t
 = 
	`lua_g‘f›ld
(
L
, -1, 
key
);

242 
lua_IÁeg”
 
»s
 = 
	`lua_toš‹g”x
(
L
, -1, &
i¢um
);

243 ià(!
i¢um
) {

244 ià(
t
 !ğ
LUA_TNIL
)

245  
	`luaL_”rÜ
(
L
, "f›ld '%s' i nÙ‡Àš‹g”", 
key
);

246 ià(
d
 < 0)

247  
	`luaL_”rÜ
(
L
, "f›ld '%s' missšg iÀd©bË", 
key
);

248 
»s
 = 
d
;

251 ià(!(-
L_MAXDATEFIELD
 <ğ
»s
 &&„es <= L_MAXDATEFIELD))

252  
	`luaL_”rÜ
(
L
, "f›ld '%s' i out-of-bound", 
key
);

253 
»s
 -ğ
d–
;

255 
	`lua_pİ
(
L
, 1);

256  ()
»s
;

257 
	}
}

260 cÚ¡ *
	$checkİtiÚ
 (
lua_S‹
 *
L
, cÚ¡ *
cÚv
,

261 
±rdiff_t
 
cÚvËn
, *
buff
) {

262 cÚ¡ *
İtiÚ
 = 
LUA_STRFTIMEOPTIONS
;

263 
İËn
 = 1;

264 ; *
İtiÚ
 !ğ'\0' && 
İËn
 <ğ
cÚvËn
; option += oplen) {

265 ià(*
İtiÚ
 == '|')

266 
İËn
++;

267 ià(
	`memcmp
(
cÚv
, 
İtiÚ
, 
İËn
) == 0) {

268 
	`memıy
(
buff
, 
cÚv
, 
İËn
);

269 
buff
[
İËn
] = '\0';

270  
cÚv
 + 
İËn
;

273 
	`luaL_¬g”rÜ
(
L
, 1,

274 
	`lua_pushf¡ršg
(
L
, "šv®id cÚv”siÚ s³cif›¸'%%%s'", 
cÚv
));

275  
cÚv
;

276 
	}
}

280 
	#SIZETIMEFMT
 250

	)

283 
	$os_d©e
 (
lua_S‹
 *
L
) {

284 
size_t
 
¦’
;

285 cÚ¡ *
s
 = 
	`luaL_İ¡ršg
(
L
, 1, "%c", &
¦’
);

286 
time_t
 
t
 = 
	`luaL_İt
(
L
, 
l_checktime
, 2, 
	`time
(
NULL
));

287 cÚ¡ *
£
 = 
s
 + 
¦’
;

288 
tm
 
tmr
, *
¡m
;

289 ià(*
s
 == '!') {

290 
¡m
 = 
	`l_gmtime
(&
t
, &
tmr
);

291 
s
++;

294 
¡m
 = 
	`l_loÿÉime
(&
t
, &
tmr
);

295 ià(
¡m
 =ğ
NULL
)

296 
	`luaL_”rÜ
(
L
, "time„esult cannot be„epresented inhis installation");

297 ià(
	`¡rcmp
(
s
, "*t") == 0) {

298 
	`lua_ü—‹bË
(
L
, 0, 9);

299 
	`£Îf›lds
(
L
, 
¡m
);

302 
cc
[4];

303 
luaL_Bufãr
 
b
;

304 
cc
[0] = '%';

305 
	`luaL_buffš™
(
L
, &
b
);

306 
s
 < 
£
) {

307 ià(*
s
 != '%')

308 
	`luaL_addch¬
(&
b
, *
s
++);

310 
size_t
 
»¦’
;

311 *
buff
 = 
	`luaL_´•buffsize
(&
b
, 
SIZETIMEFMT
);

312 
s
++;

313 
s
 = 
	`checkİtiÚ
(
L
, s, 
£
 - s, 
cc
 + 1);

314 
»¦’
 = 
	`¡ráime
(
buff
, 
SIZETIMEFMT
, 
cc
, 
¡m
);

315 
	`luaL_addsize
(&
b
, 
»¦’
);

318 
	`luaL_push»suÉ
(&
b
);

321 
	}
}

324 
	$os_time
 (
lua_S‹
 *
L
) {

325 
time_t
 
t
;

326 ià(
	`lua_i¢ÚeÜn
(
L
, 1))

327 
t
 = 
	`time
(
NULL
);

329 
tm
 
ts
;

330 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

331 
	`lua_£‰İ
(
L
, 1);

332 
ts
.
tm_£c
 = 
	`g‘f›ld
(
L
, "sec", 0, 0);

333 
ts
.
tm_mš
 = 
	`g‘f›ld
(
L
, "min", 0, 0);

334 
ts
.
tm_hour
 = 
	`g‘f›ld
(
L
, "hour", 12, 0);

335 
ts
.
tm_mday
 = 
	`g‘f›ld
(
L
, "day", -1, 0);

336 
ts
.
tm_mÚ
 = 
	`g‘f›ld
(
L
, "month", -1, 1);

337 
ts
.
tm_y—r
 = 
	`g‘f›ld
(
L
, "year", -1, 1900);

338 
ts
.
tm_isd¡
 = 
	`g‘boŞf›ld
(
L
, "isdst");

339 
t
 = 
	`mktime
(&
ts
);

340 
	`£Îf›lds
(
L
, &
ts
);

342 ià(
t
 !ğ(
time_t
)(
l_tim‘
)t || == (time_t)(-1))

343 
	`luaL_”rÜ
(
L
, "time„esult cannot be„epresented inhis installation");

344 
	`l_pushtime
(
L
, 
t
);

346 
	}
}

349 
	$os_difáime
 (
lua_S‹
 *
L
) {

350 
time_t
 
t1
 = 
	`l_checktime
(
L
, 1);

351 
time_t
 
t2
 = 
	`l_checktime
(
L
, 2);

352 
	`lua_pushnumb”
(
L
, (
lua_Numb”
)
	`difáime
(
t1
, 
t2
));

354 
	}
}

359 
	$os_£oÿË
 (
lua_S‹
 *
L
) {

360 cÚ¡ 
ÿt
[] = {
LC_ALL
, 
LC_COLLATE
, 
LC_CTYPE
, 
LC_MONETARY
,

361 
LC_NUMERIC
, 
LC_TIME
};

362 cÚ¡ *cÚ¡ 
ÿŠames
[] = {"all", "collate", "ctype", "monetary",

363 "num”ic", "time", 
NULL
};

364 cÚ¡ *
l
 = 
	`luaL_İt¡ršg
(
L
, 1, 
NULL
);

365 
İ
 = 
	`luaL_checkİtiÚ
(
L
, 2, "®l", 
ÿŠames
);

366 
	`lua_push¡ršg
(
L
, 
	`£oÿË
(
ÿt
[
İ
], 
l
));

368 
	}
}

371 
	$os_ex™
 (
lua_S‹
 *
L
) {

372 
¡©us
;

373 ià(
	`lua_isboŞ—n
(
L
, 1))

374 
¡©us
 = (
	`lua_toboŞ—n
(
L
, 1è? 
EXIT_SUCCESS
 : 
EXIT_FAILURE
);

376 
¡©us
 = ()
	`luaL_İtš‹g”
(
L
, 1, 
EXIT_SUCCESS
);

377 ià(
	`lua_toboŞ—n
(
L
, 2))

378 
	`lua_şo£
(
L
);

379 ià(
L
è
	`ex™
(
¡©us
);

381 
	}
}

384 cÚ¡ 
luaL_Reg
 
	gsy¦ib
[] = {

385 {"şock", 
os_şock
},

386 {"d©e", 
os_d©e
},

387 {"difáime", 
os_difáime
},

388 {"execu‹", 
os_execu‹
},

389 {"ex™", 
os_ex™
},

390 {"g‘’v", 
os_g‘’v
},

391 {"»move", 
os_»move
},

392 {"»Çme", 
os_»Çme
},

393 {"£oÿË", 
os_£oÿË
},

394 {"time", 
os_time
},

395 {"tm²ame", 
os_tm²ame
},

396 {
NULL
, NULL}

403 
LUAMOD_API
 
	$luaİ’_os
 (
lua_S‹
 *
L
) {

404 
	`luaL_Ãwlib
(
L
, 
sy¦ib
);

406 
	}
}

	@3rd/lua/lparser.c

7 
	#Í¬£r_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"lcode.h
"

18 
	~"ldebug.h
"

19 
	~"ldo.h
"

20 
	~"lfunc.h
"

21 
	~"Îex.h
"

22 
	~"lmem.h
"

23 
	~"lobjeù.h
"

24 
	~"lİcodes.h
"

25 
	~"Í¬£r.h
"

26 
	~"l¡©e.h
"

27 
	~"l¡ršg.h
"

28 
	~"ÉabË.h
"

34 
	#MAXVARS
 200

	)

37 
	#hasmuÉ»t
(
k
è((kè=ğ
VCALL
 || (kè=ğ
VVARARG
)

	)

42 
	#eq¡r
(
a
,
b
è(×è=ğ(b))

	)

48 
	sBlockCÁ
 {

49 
BlockCÁ
 *
	m´evious
;

50 
	mfœ¡Ïb–
;

51 
	mfœ¡gÙo
;

52 
lu_by‹
 
	mÇùv¬
;

53 
lu_by‹
 
	mupv®
;

54 
lu_by‹
 
	mi¦oİ
;

55 } 
	tBlockCÁ
;

62 
¡©em’t
 (
LexS‹
 *
ls
);

63 
ex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
);

67 
l_nÜ‘
 
	$£m”rÜ
 (
LexS‹
 *
ls
, cÚ¡ *
msg
) {

68 
ls
->
t
.
tok’
 = 0;

69 
	`luaX_syÁax”rÜ
(
ls
, 
msg
);

70 
	}
}

73 
l_nÜ‘
 
	$”rÜ_ex³ùed
 (
LexS‹
 *
ls
, 
tok’
) {

74 
	`luaX_syÁax”rÜ
(
ls
,

75 
	`luaO_pushf¡ršg
(
ls
->
L
, "% ex³ùed", 
	`luaX_tok’2¡r
Ös, 
tok’
)));

76 
	}
}

79 
l_nÜ‘
 
	$”rÜlim™
 (
FuncS‹
 *
fs
, 
lim™
, cÚ¡ *
wh©
) {

80 
lua_S‹
 *
L
 = 
fs
->
ls
->L;

81 cÚ¡ *
msg
;

82 
lše
 = 
fs
->
f
->
¥
->
lšedefšed
;

83 cÚ¡ *
wh”e
 = (
lše
 == 0)

85 : 
	`luaO_pushf¡ršg
(
L
, "funùiÚ‡ˆlš%d", 
lše
);

86 
msg
 = 
	`luaO_pushf¡ršg
(
L
, "too many %s (limit is %d) in %s",

87 
wh©
, 
lim™
, 
wh”e
);

88 
	`luaX_syÁax”rÜ
(
fs
->
ls
, 
msg
);

89 
	}
}

92 
	$checklim™
 (
FuncS‹
 *
fs
, 
v
, 
l
, cÚ¡ *
wh©
) {

93 ià(
v
 > 
l
è
	`”rÜlim™
(
fs
,†, 
wh©
);

94 
	}
}

97 
	$‹¡Ãxt
 (
LexS‹
 *
ls
, 
c
) {

98 ià(
ls
->
t
.
tok’
 =ğ
c
) {

99 
	`luaX_Ãxt
(
ls
);

103 
	}
}

106 
	$check
 (
LexS‹
 *
ls
, 
c
) {

107 ià(
ls
->
t
.
tok’
 !ğ
c
)

108 
	`”rÜ_ex³ùed
(
ls
, 
c
);

109 
	}
}

112 
	$checkÃxt
 (
LexS‹
 *
ls
, 
c
) {

113 
	`check
(
ls
, 
c
);

114 
	`luaX_Ãxt
(
ls
);

115 
	}
}

118 
	#check_cÚd™iÚ
(
ls
,
c
,
msg
è{ ià(!(c)è
	`luaX_syÁax”rÜ
Ös, msg); }

	)

122 
	$check_m©ch
 (
LexS‹
 *
ls
, 
wh©
, 
who
, 
wh”e
) {

123 ià(!
	`‹¡Ãxt
(
ls
, 
wh©
)) {

124 ià(
wh”e
 =ğ
ls
->
lš’umb”
)

125 
	`”rÜ_ex³ùed
(
ls
, 
wh©
);

127 
	`luaX_syÁax”rÜ
(
ls
, 
	`luaO_pushf¡ršg
Ös->
L
,

129 
	`luaX_tok’2¡r
(
ls
, 
wh©
),†uaX_tok’2¡rÖs, 
who
), 
wh”e
));

132 
	}
}

135 
TSŒšg
 *
	$¡r_checkÇme
 (
LexS‹
 *
ls
) {

136 
TSŒšg
 *
ts
;

137 
	`check
(
ls
, 
TK_NAME
);

138 
ts
 = 
ls
->
t
.
£mšfo
.ts;

139 
	`luaX_Ãxt
(
ls
);

140  
ts
;

141 
	}
}

144 
	$š™_exp
 (
expdesc
 *
e
, 
expkšd
 
k
, 
i
) {

145 
e
->
f
 =ƒ->
t
 = 
NO_JUMP
;

146 
e
->
k
 = k;

147 
e
->
u
.
šfo
 = 
i
;

148 
	}
}

151 
	$code¡ršg
 (
LexS‹
 *
ls
, 
expdesc
 *
e
, 
TSŒšg
 *
s
) {

152 
	`š™_exp
(
e
, 
VK
, 
	`luaK_¡ršgK
(
ls
->
fs
, 
s
));

153 
	}
}

156 
	$checkÇme
 (
LexS‹
 *
ls
, 
expdesc
 *
e
) {

157 
	`code¡ršg
(
ls
, 
e
, 
	`¡r_checkÇme
(ls));

158 
	}
}

161 
	$»gi¡”loÿlv¬
 (
LexS‹
 *
ls
, 
TSŒšg
 *
v¬Çme
) {

162 
FuncS‹
 *
fs
 = 
ls
->fs;

163 
PrÙo
 *
å
 = 
fs
->
f
;

164 
Sh¬edPrÙo
 *
f
 = 
å
->
¥
;

165 
Şdsize
 = 
f
->
siz–ocv¬s
;

166 
	`luaM_growveùÜ
(
ls
->
L
, 
f
->
locv¬s
, 
fs
->
Æocv¬s
, f->
siz–ocv¬s
,

167 
LocV¬
, 
SHRT_MAX
, "local variables");

168 
Şdsize
 < 
f
->
siz–ocv¬s
)

169 
f
->
locv¬s
[
Şdsize
++].
v¬Çme
 = 
NULL
;

170 
f
->
locv¬s
[
fs
->
Æocv¬s
].
v¬Çme
 = varname;

171 
	`luaC_objb¬r›r
(
ls
->
L
, 
å
, 
v¬Çme
);

172  
fs
->
Æocv¬s
++;

173 
	}
}

176 
	$Ãw_loÿlv¬
 (
LexS‹
 *
ls
, 
TSŒšg
 *
Çme
) {

177 
FuncS‹
 *
fs
 = 
ls
->fs;

178 
Dynd©a
 *
dyd
 = 
ls
->dyd;

179 
»g
 = 
	`»gi¡”loÿlv¬
(
ls
, 
Çme
);

180 
	`checklim™
(
fs
, 
dyd
->
aùv¬
.
n
 + 1 - fs->
fœ¡loÿl
,

181 
MAXVARS
, "local variables");

182 
	`luaM_growveùÜ
(
ls
->
L
, 
dyd
->
aùv¬
.
¬r
, dyd->aùv¬.
n
 + 1,

183 
dyd
->
aùv¬
.
size
, 
V¬desc
, 
MAX_INT
, "local variables");

184 
dyd
->
aùv¬
.
¬r
[dyd->aùv¬.
n
++].
idx
 = 
	`ÿ¡
(, 
»g
);

185 
	}
}

188 
	$Ãw_loÿlv¬l™”®_
 (
LexS‹
 *
ls
, cÚ¡ *
Çme
, 
size_t
 
sz
) {

189 
	`Ãw_loÿlv¬
(
ls
, 
	`luaX_Ãw¡ršg
Ös, 
Çme
, 
sz
));

190 
	}
}

192 
	#Ãw_loÿlv¬l™”®
(
ls
,
v
) \

193 
	`Ãw_loÿlv¬l™”®_
(
ls
, "" 
v
, ((v)/())-1)

	)

196 
LocV¬
 *
	$g‘locv¬
 (
FuncS‹
 *
fs
, 
i
) {

197 
idx
 = 
fs
->
ls
->
dyd
->
aùv¬
.
¬r
[fs->
fœ¡loÿl
 + 
i
].idx;

198 
	`lua_as£¹
(
idx
 < 
fs
->
Æocv¬s
);

199  &
fs
->
f
->
¥
->
locv¬s
[
idx
];

200 
	}
}

203 
	$adju¡loÿlv¬s
 (
LexS‹
 *
ls
, 
nv¬s
) {

204 
FuncS‹
 *
fs
 = 
ls
->fs;

205 
fs
->
Çùv¬
 = 
	`ÿ¡_by‹
(fs->Çùv¬ + 
nv¬s
);

206 ; 
nv¬s
;‚vars--) {

207 
	`g‘locv¬
(
fs
, fs->
Çùv¬
 - 
nv¬s
)->
¡¬c
 = fs->
pc
;

209 
	}
}

212 
	$»movev¬s
 (
FuncS‹
 *
fs
, 
tŞev–
) {

213 
fs
->
ls
->
dyd
->
aùv¬
.
n
 -ğ(fs->
Çùv¬
 - 
tŞev–
);

214 
fs
->
Çùv¬
 > 
tŞev–
)

215 
	`g‘locv¬
(
fs
, --fs->
Çùv¬
)->
’dpc
 = fs->
pc
;

216 
	}
}

219 
	$£¬chupv®ue
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
Çme
) {

220 
i
;

221 
Upv®desc
 *
up
 = 
fs
->
f
->
¥
->
upv®ues
;

222 
i
 = 0; i < 
fs
->
nups
; i++) {

223 ià(
	`eq¡r
(
up
[
i
].
Çme
,‚ame))  i;

226 
	}
}

229 
	$Ãwupv®ue
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
Çme
, 
expdesc
 *
v
) {

230 
PrÙo
 *
å
 = 
fs
->
f
;

231 
Sh¬edPrÙo
 *
f
 = 
å
->
¥
;

232 
Şdsize
 = 
f
->
sizeupv®ues
;

233 
	`checklim™
(
fs
, fs->
nups
 + 1, 
MAXUPVAL
, "upvalues");

234 
	`luaM_growveùÜ
(
fs
->
ls
->
L
, 
f
->
upv®ues
, fs->
nups
, f->
sizeupv®ues
,

235 
Upv®desc
, 
MAXUPVAL
, "upvalues");

236 
Şdsize
 < 
f
->
sizeupv®ues
)

237 
f
->
upv®ues
[
Şdsize
++].
Çme
 = 
NULL
;

238 
f
->
upv®ues
[
fs
->
nups
].
š¡ack
 = (
v
->
k
 =ğ
VLOCAL
);

239 
f
->
upv®ues
[
fs
->
nups
].
idx
 = 
	`ÿ¡_by‹
(
v
->
u
.
šfo
);

240 
f
->
upv®ues
[
fs
->
nups
].
Çme
 =‚ame;

241 
	`luaC_objb¬r›r
(
fs
->
ls
->
L
, 
å
, 
Çme
);

242  
fs
->
nups
++;

243 
	}
}

246 
	$£¬chv¬
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
n
) {

247 
i
;

248 
i
 = 
	`ÿ¡_št
(
fs
->
Çùv¬
) - 1; i >= 0; i--) {

249 ià(
	`eq¡r
(
n
, 
	`g‘locv¬
(
fs
, 
i
)->
v¬Çme
))

250  
i
;

253 
	}
}

260 
	$m¬kupv®
 (
FuncS‹
 *
fs
, 
Ëv–
) {

261 
BlockCÁ
 *
bl
 = 
fs
->bl;

262 
bl
->
Çùv¬
 > 
Ëv–
)

263 
bl
 = bl->
´evious
;

264 
bl
->
upv®
 = 1;

265 
	}
}

272 
	$sšgËv¬aux
 (
FuncS‹
 *
fs
, 
TSŒšg
 *
n
, 
expdesc
 *
v¬
, 
ba£
) {

273 ià(
fs
 =ğ
NULL
)

274 
	`š™_exp
(
v¬
, 
VVOID
, 0);

276 
v
 = 
	`£¬chv¬
(
fs
, 
n
);

277 ià(
v
 >= 0) {

278 
	`š™_exp
(
v¬
, 
VLOCAL
, 
v
);

279 ià(!
ba£
)

280 
	`m¬kupv®
(
fs
, 
v
);

283 
idx
 = 
	`£¬chupv®ue
(
fs
, 
n
);

284 ià(
idx
 < 0) {

285 
	`sšgËv¬aux
(
fs
->
´ev
, 
n
, 
v¬
, 0);

286 ià(
v¬
->
k
 =ğ
VVOID
)

289 
idx
 = 
	`Ãwupv®ue
(
fs
, 
n
, 
v¬
);

291 
	`š™_exp
(
v¬
, 
VUPVAL
, 
idx
);

294 
	}
}

297 
	$sšgËv¬
 (
LexS‹
 *
ls
, 
expdesc
 *
v¬
) {

298 
TSŒšg
 *
v¬Çme
 = 
	`¡r_checkÇme
(
ls
);

299 
FuncS‹
 *
fs
 = 
ls
->fs;

300 
	`sšgËv¬aux
(
fs
, 
v¬Çme
, 
v¬
, 1);

301 ià(
v¬
->
k
 =ğ
VVOID
) {

302 
expdesc
 
key
;

303 
	`sšgËv¬aux
(
fs
, 
ls
->
’vn
, 
v¬
, 1);

304 
	`lua_as£¹
(
v¬
->
k
 !ğ
VVOID
);

305 
	`code¡ršg
(
ls
, &
key
, 
v¬Çme
);

306 
	`luaK_šdexed
(
fs
, 
v¬
, &
key
);

308 
	}
}

311 
	$adju¡_assign
 (
LexS‹
 *
ls
, 
nv¬s
, 
Ãxps
, 
expdesc
 *
e
) {

312 
FuncS‹
 *
fs
 = 
ls
->fs;

313 
exŒa
 = 
nv¬s
 - 
Ãxps
;

314 ià(
	`hasmuÉ»t
(
e
->
k
)) {

315 
exŒa
++;

316 ià(
exŒa
 < 0)ƒxtra = 0;

317 
	`luaK_£Œ‘uºs
(
fs
, 
e
, 
exŒa
);

318 ià(
exŒa
 > 1è
	`luaK_»£rv”egs
(
fs
,ƒxtra-1);

321 ià(
e
->
k
 !ğ
VVOID
è
	`luaK_exp2ÃxŒeg
(
fs
,ƒ);

322 ià(
exŒa
 > 0) {

323 
»g
 = 
fs
->
ä“»g
;

324 
	`luaK_»£rv”egs
(
fs
, 
exŒa
);

325 
	`luaK_n
(
fs
, 
»g
, 
exŒa
);

328 ià(
Ãxps
 > 
nv¬s
)

329 
ls
->
fs
->
ä“»g
 -ğ
Ãxps
 - 
nv¬s
;

330 
	}
}

333 
	$’‹¾ev–
 (
LexS‹
 *
ls
) {

334 
lua_S‹
 *
L
 = 
ls
->L;

335 ++
L
->
nCÿÎs
;

336 
	`checklim™
(
ls
->
fs
, 
L
->
nCÿÎs
, 
LUAI_MAXCCALLS
, "C†evels");

337 
	}
}

340 
	#Ëav–ev–
(
ls
è(Ös)->
L
->
nCÿÎs
--)

	)

343 
	$şo£gÙo
 (
LexS‹
 *
ls
, 
g
, 
Lab–desc
 *
Ïb–
) {

344 
i
;

345 
FuncS‹
 *
fs
 = 
ls
->fs;

346 
Lab–li¡
 *
gl
 = &
ls
->
dyd
->
gt
;

347 
Lab–desc
 *
gt
 = &
gl
->
¬r
[
g
];

348 
	`lua_as£¹
(
	`eq¡r
(
gt
->
Çme
, 
Ïb–
->name));

349 ià(
gt
->
Çùv¬
 < 
Ïb–
->nactvar) {

350 
TSŒšg
 *
vÇme
 = 
	`g‘locv¬
(
fs
, 
gt
->
Çùv¬
)->
v¬Çme
;

351 cÚ¡ *
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
,

353 
	`g‘¡r
(
gt
->
Çme
), gt->
lše
, g‘¡r(
vÇme
));

354 
	`£m”rÜ
(
ls
, 
msg
);

356 
	`luaK_·tchli¡
(
fs
, 
gt
->
pc
, 
Ïb–
->pc);

358 
i
 = 
g
; i < 
gl
->
n
 - 1; i++)

359 
gl
->
¬r
[
i
] = gl->arr[i + 1];

360 
gl
->
n
--;

361 
	}
}

367 
	$fšdÏb–
 (
LexS‹
 *
ls
, 
g
) {

368 
i
;

369 
BlockCÁ
 *
bl
 = 
ls
->
fs
->bl;

370 
Dynd©a
 *
dyd
 = 
ls
->dyd;

371 
Lab–desc
 *
gt
 = &
dyd
->gt.
¬r
[
g
];

373 
i
 = 
bl
->
fœ¡Ïb–
; i < 
dyd
->
Ïb–
.
n
; i++) {

374 
Lab–desc
 *
lb
 = &
dyd
->
Ïb–
.
¬r
[
i
];

375 ià(
	`eq¡r
(
lb
->
Çme
, 
gt
->name)) {

376 ià(
gt
->
Çùv¬
 > 
lb
->nactvar &&

377 (
bl
->
upv®
 || 
dyd
->
Ïb–
.
n
 > bl->
fœ¡Ïb–
))

378 
	`luaK_·tchşo£
(
ls
->
fs
, 
gt
->
pc
, 
lb
->
Çùv¬
);

379 
	`şo£gÙo
(
ls
, 
g
, 
lb
);

384 
	}
}

387 
	$ÃwÏb–’Œy
 (
LexS‹
 *
ls
, 
Lab–li¡
 *
l
, 
TSŒšg
 *
Çme
,

388 
lše
, 
pc
) {

389 
n
 = 
l
->n;

390 
	`luaM_growveùÜ
(
ls
->
L
, 
l
->
¬r
, 
n
,†->
size
,

391 
Lab–desc
, 
SHRT_MAX
, "labels/gotos");

392 
l
->
¬r
[
n
].
Çme
 =‚ame;

393 
l
->
¬r
[
n
].
lše
 =†ine;

394 
l
->
¬r
[
n
].
Çùv¬
 = 
ls
->
fs
->nactvar;

395 
l
->
¬r
[
n
].
pc
 =…c;

396 
l
->
n
 =‚ + 1;

397  
n
;

398 
	}
}

405 
	$fšdgÙos
 (
LexS‹
 *
ls
, 
Lab–desc
 *
lb
) {

406 
Lab–li¡
 *
gl
 = &
ls
->
dyd
->
gt
;

407 
i
 = 
ls
->
fs
->
bl
->
fœ¡gÙo
;

408 
i
 < 
gl
->
n
) {

409 ià(
	`eq¡r
(
gl
->
¬r
[
i
].
Çme
, 
lb
->name))

410 
	`şo£gÙo
(
ls
, 
i
, 
lb
);

412 
i
++;

414 
	}
}

423 
	$movegÙosout
 (
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
) {

424 
i
 = 
bl
->
fœ¡gÙo
;

425 
Lab–li¡
 *
gl
 = &
fs
->
ls
->
dyd
->
gt
;

428 
i
 < 
gl
->
n
) {

429 
Lab–desc
 *
gt
 = &
gl
->
¬r
[
i
];

430 ià(
gt
->
Çùv¬
 > 
bl
->nactvar) {

431 ià(
bl
->
upv®
)

432 
	`luaK_·tchşo£
(
fs
, 
gt
->
pc
, 
bl
->
Çùv¬
);

433 
gt
->
Çùv¬
 = 
bl
->nactvar;

435 ià(!
	`fšdÏb–
(
fs
->
ls
, 
i
))

436 
i
++;

438 
	}
}

441 
	$’‹rblock
 (
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
, 
lu_by‹
 
i¦oİ
) {

442 
bl
->
i¦oİ
 = isloop;

443 
bl
->
Çùv¬
 = 
fs
->nactvar;

444 
bl
->
fœ¡Ïb–
 = 
fs
->
ls
->
dyd
->
Ïb–
.
n
;

445 
bl
->
fœ¡gÙo
 = 
fs
->
ls
->
dyd
->
gt
.
n
;

446 
bl
->
upv®
 = 0;

447 
bl
->
´evious
 = 
fs
->bl;

448 
fs
->
bl
 = bl;

449 
	`lua_as£¹
(
fs
->
ä“»g
 =ğfs->
Çùv¬
);

450 
	}
}

456 
	$b»akÏb–
 (
LexS‹
 *
ls
) {

457 
TSŒšg
 *
n
 = 
	`luaS_Ãw
(
ls
->
L
, "break");

458 
l
 = 
	`ÃwÏb–’Œy
(
ls
, &ls->
dyd
->
Ïb–
, 
n
, 0,†s->
fs
->
pc
);

459 
	`fšdgÙos
(
ls
, &ls->
dyd
->
Ïb–
.
¬r
[
l
]);

460 
	}
}

466 
l_nÜ‘
 
	$undefgÙo
 (
LexS‹
 *
ls
, 
Lab–desc
 *
gt
) {

467 cÚ¡ *
msg
 = 
	`i¤e£rved
(
gt
->
Çme
)

470 
msg
 = 
	`luaO_pushf¡ršg
(
ls
->
L
, msg, 
	`g‘¡r
(
gt
->
Çme
), gt->
lše
);

471 
	`£m”rÜ
(
ls
, 
msg
);

472 
	}
}

475 
	$Ëaveblock
 (
FuncS‹
 *
fs
) {

476 
BlockCÁ
 *
bl
 = 
fs
->bl;

477 
LexS‹
 *
ls
 = 
fs
->ls;

478 ià(
bl
->
´evious
 && bl->
upv®
) {

480 
j
 = 
	`luaK_jump
(
fs
);

481 
	`luaK_·tchşo£
(
fs
, 
j
, 
bl
->
Çùv¬
);

482 
	`luaK_·tchtoh”e
(
fs
, 
j
);

484 ià(
bl
->
i¦oİ
)

485 
	`b»akÏb–
(
ls
);

486 
fs
->
bl
 = bl->
´evious
;

487 
	`»movev¬s
(
fs
, 
bl
->
Çùv¬
);

488 
	`lua_as£¹
(
bl
->
Çùv¬
 =ğ
fs
->nactvar);

489 
fs
->
ä“»g
 = fs->
Çùv¬
;

490 
ls
->
dyd
->
Ïb–
.
n
 = 
bl
->
fœ¡Ïb–
;

491 ià(
bl
->
´evious
)

492 
	`movegÙosout
(
fs
, 
bl
);

493 ià(
bl
->
fœ¡gÙo
 < 
ls
->
dyd
->
gt
.
n
)

494 
	`undefgÙo
(
ls
, &ls->
dyd
->
gt
.
¬r
[
bl
->
fœ¡gÙo
]);

495 
	}
}

501 
PrÙo
 *
	$add´ÙÙy³
 (
LexS‹
 *
ls
) {

502 
PrÙo
 *
şp
;

503 
lua_S‹
 *
L
 = 
ls
->L;

504 
FuncS‹
 *
fs
 = 
ls
->fs;

505 
PrÙo
 *
f
 = 
fs
->f;

506 ià(
fs
->
Å
 >ğ
f
->
¥
->
siz•
) {

507 
Şdsize
 = 
f
->
¥
->
siz•
;

508 
	`luaM_growveùÜ
(
L
, 
f
->
p
, 
fs
->
Å
, f->
¥
->
siz•
, 
PrÙo
 *, 
MAXARG_Bx
, "functions");

509 
Şdsize
 < 
f
->
¥
->
siz•
)

510 
f
->
p
[
Şdsize
++] = 
NULL
;

512 
f
->
p
[
fs
->
Å
++] = 
şp
 = 
	`luaF_Ãw´Ùo
(
L
, 
NULL
);

513 
	`luaC_objb¬r›r
(
L
, 
f
, 
şp
);

514  
şp
;

515 
	}
}

524 
	$codeşosu»
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

525 
FuncS‹
 *
fs
 = 
ls
->fs->
´ev
;

526 
	`š™_exp
(
v
, 
VRELOCABLE
, 
	`luaK_codeABx
(
fs
, 
OP_CLOSURE
, 0, fs->
Å
 - 1));

527 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

528 
	}
}

531 
	$İ’_func
 (
LexS‹
 *
ls
, 
FuncS‹
 *
fs
, 
BlockCÁ
 *
bl
) {

532 
Sh¬edPrÙo
 *
f
;

533 
fs
->
´ev
 = 
ls
->fs;

534 
fs
->
ls
 =†s;

535 
ls
->
fs
 = fs;

536 
fs
->
pc
 = 0;

537 
fs
->
Ï¡rg‘
 = 0;

538 
fs
->
jpc
 = 
NO_JUMP
;

539 
fs
->
ä“»g
 = 0;

540 
fs
->
nk
 = 0;

541 
fs
->
Å
 = 0;

542 
fs
->
nups
 = 0;

543 
fs
->
Æocv¬s
 = 0;

544 
fs
->
Çùv¬
 = 0;

545 
fs
->
fœ¡loÿl
 = 
ls
->
dyd
->
aùv¬
.
n
;

546 
fs
->
bl
 = 
NULL
;

547 
f
 = 
fs
->f->
¥
;

548 
f
->
sourû
 = 
ls
->source;

549 
f
->
max¡acksize
 = 2;

550 
	`’‹rblock
(
fs
, 
bl
, 0);

551 
	}
}

554 
	$şo£_func
 (
LexS‹
 *
ls
) {

555 
lua_S‹
 *
L
 = 
ls
->L;

556 
FuncS‹
 *
fs
 = 
ls
->fs;

557 
PrÙo
 *
f
 = 
fs
->f;

558 
Sh¬edPrÙo
 *
¥
 = 
f
->sp;

559 
	`luaK_»t
(
fs
, 0, 0);

560 
	`Ëaveblock
(
fs
);

561 
	`luaM_»®locveùÜ
(
L
, 
¥
->
code
, sp->
sizecode
, 
fs
->
pc
, 
In¡ruùiÚ
);

562 
¥
->
sizecode
 = 
fs
->
pc
;

563 
	`luaM_»®locveùÜ
(
L
, 
¥
->
lšešfo
, sp->
siz–šešfo
, 
fs
->
pc
, );

564 
¥
->
siz–šešfo
 = 
fs
->
pc
;

565 
	`luaM_»®locveùÜ
(
L
, 
f
->
k
, 
¥
->
sizek
, 
fs
->
nk
, 
TV®ue
);

566 
¥
->
sizek
 = 
fs
->
nk
;

567 
	`luaM_»®locveùÜ
(
L
, 
f
->
p
, 
¥
->
siz•
, 
fs
->
Å
, 
PrÙo
 *);

568 
¥
->
siz•
 = 
fs
->
Å
;

569 
	`luaM_»®locveùÜ
(
L
, 
¥
->
locv¬s
, sp->
siz–ocv¬s
, 
fs
->
Æocv¬s
, 
LocV¬
);

570 
¥
->
siz–ocv¬s
 = 
fs
->
Æocv¬s
;

571 
	`luaM_»®locveùÜ
(
L
, 
¥
->
upv®ues
, sp->
sizeupv®ues
, 
fs
->
nups
, 
Upv®desc
);

572 
¥
->
sizeupv®ues
 = 
fs
->
nups
;

573 
	`lua_as£¹
(
fs
->
bl
 =ğ
NULL
);

574 
ls
->
fs
 = fs->
´ev
;

575 
	`luaC_checkGC
(
L
);

576 
	}
}

590 
	$block_fŞlow
 (
LexS‹
 *
ls
, 
w™huÁ
) {

591 
ls
->
t
.
tok’
) {

592 
TK_ELSE
: 
TK_ELSEIF
:

593 
TK_END
: 
TK_EOS
:

595 
TK_UNTIL
:  
w™huÁ
;

598 
	}
}

601 
	$¡©li¡
 (
LexS‹
 *
ls
) {

603 !
	`block_fŞlow
(
ls
, 1)) {

604 ià(
ls
->
t
.
tok’
 =ğ
TK_RETURN
) {

605 
	`¡©em’t
(
ls
);

608 
	`¡©em’t
(
ls
);

610 
	}
}

613 
	$f›ld£l
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

615 
FuncS‹
 *
fs
 = 
ls
->fs;

616 
expdesc
 
key
;

617 
	`luaK_exp2ªy»gup
(
fs
, 
v
);

618 
	`luaX_Ãxt
(
ls
);

619 
	`checkÇme
(
ls
, &
key
);

620 
	`luaK_šdexed
(
fs
, 
v
, &
key
);

621 
	}
}

624 
	$yšdex
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

626 
	`luaX_Ãxt
(
ls
);

627 
	`ex´
(
ls
, 
v
);

628 
	`luaK_exp2v®
(
ls
->
fs
, 
v
);

629 
	`checkÃxt
(
ls
, ']');

630 
	}
}

640 
	sCÚsCÚŒŞ
 {

641 
expdesc
 
	mv
;

642 
expdesc
 *
	mt
;

643 
	mnh
;

644 
	mÇ
;

645 
	mto¡Üe
;

649 
	$»cf›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

651 
FuncS‹
 *
fs
 = 
ls
->fs;

652 
»g
 = 
ls
->
fs
->
ä“»g
;

653 
expdesc
 
key
, 
v®
;

654 
rkkey
;

655 ià(
ls
->
t
.
tok’
 =ğ
TK_NAME
) {

656 
	`checklim™
(
fs
, 
cc
->
nh
, 
MAX_INT
, "items in‡ constructor");

657 
	`checkÇme
(
ls
, &
key
);

660 
	`yšdex
(
ls
, &
key
);

661 
cc
->
nh
++;

662 
	`checkÃxt
(
ls
, '=');

663 
rkkey
 = 
	`luaK_exp2RK
(
fs
, &
key
);

664 
	`ex´
(
ls
, &
v®
);

665 
	`luaK_codeABC
(
fs
, 
OP_SETTABLE
, 
cc
->
t
->
u
.
šfo
, 
rkkey
, 
	`luaK_exp2RK
(fs, &
v®
));

666 
fs
->
ä“»g
 = 
»g
;

667 
	}
}

670 
	$şo£li¡f›ld
 (
FuncS‹
 *
fs
, 
CÚsCÚŒŞ
 *
cc
) {

671 ià(
cc
->
v
.
k
 =ğ
VVOID
) ;

672 
	`luaK_exp2ÃxŒeg
(
fs
, &
cc
->
v
);

673 
cc
->
v
.
k
 = 
VVOID
;

674 ià(
cc
->
to¡Üe
 =ğ
LFIELDS_PER_FLUSH
) {

675 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
šfo
, cc->
Ç
, cc->
to¡Üe
);

676 
cc
->
to¡Üe
 = 0;

678 
	}
}

681 
	$Ï¡li¡f›ld
 (
FuncS‹
 *
fs
, 
CÚsCÚŒŞ
 *
cc
) {

682 ià(
cc
->
to¡Üe
 == 0) ;

683 ià(
	`hasmuÉ»t
(
cc
->
v
.
k
)) {

684 
	`luaK_£tmuÉ»t
(
fs
, &
cc
->
v
);

685 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
šfo
, cc->
Ç
, 
LUA_MULTRET
);

686 
cc
->
Ç
--;

689 ià(
cc
->
v
.
k
 !ğ
VVOID
)

690 
	`luaK_exp2ÃxŒeg
(
fs
, &
cc
->
v
);

691 
	`luaK_£i¡
(
fs
, 
cc
->
t
->
u
.
šfo
, cc->
Ç
, cc->
to¡Üe
);

693 
	}
}

696 
	$li¡f›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

698 
	`ex´
(
ls
, &
cc
->
v
);

699 
	`checklim™
(
ls
->
fs
, 
cc
->
Ç
, 
MAX_INT
, "items in‡ constructor");

700 
cc
->
Ç
++;

701 
cc
->
to¡Üe
++;

702 
	}
}

705 
	$f›ld
 (
LexS‹
 *
ls
, 
CÚsCÚŒŞ
 *
cc
) {

707 
ls
->
t
.
tok’
) {

708 
TK_NAME
: {

709 ià(
	`luaX_lookah—d
(
ls
) != '=')

710 
	`li¡f›ld
(
ls
, 
cc
);

712 
	`»cf›ld
(
ls
, 
cc
);

716 
	`»cf›ld
(
ls
, 
cc
);

720 
	`li¡f›ld
(
ls
, 
cc
);

724 
	}
}

727 
	$cÚ¡ruùÜ
 (
LexS‹
 *
ls
, 
expdesc
 *
t
) {

730 
FuncS‹
 *
fs
 = 
ls
->fs;

731 
lše
 = 
ls
->
lš’umb”
;

732 
pc
 = 
	`luaK_codeABC
(
fs
, 
OP_NEWTABLE
, 0, 0, 0);

733 
CÚsCÚŒŞ
 
cc
;

734 
cc
.
Ç
 = cc.
nh
 = cc.
to¡Üe
 = 0;

735 
cc
.
t
 =;

736 
	`š™_exp
(
t
, 
VRELOCABLE
, 
pc
);

737 
	`š™_exp
(&
cc
.
v
, 
VVOID
, 0);

738 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, 
t
);

739 
	`checkÃxt
(
ls
, '{');

741 
	`lua_as£¹
(
cc
.
v
.
k
 =ğ
VVOID
 || cc.
to¡Üe
 > 0);

742 ià(
ls
->
t
.
tok’
 == '}') ;

743 
	`şo£li¡f›ld
(
fs
, &
cc
);

744 
	`f›ld
(
ls
, &
cc
);

745 } 
	`‹¡Ãxt
(
ls
, ',') ||estnext(ls, ';'));

746 
	`check_m©ch
(
ls
, '}', '{', 
lše
);

747 
	`Ï¡li¡f›ld
(
fs
, &
cc
);

748 
	`SETARG_B
(
fs
->
f
->
¥
->
code
[
pc
], 
	`luaO_št2fb
(
cc
.
Ç
));

749 
	`SETARG_C
(
fs
->
f
->
¥
->
code
[
pc
], 
	`luaO_št2fb
(
cc
.
nh
));

750 
	}
}

756 
	$·¾i¡
 (
LexS‹
 *
ls
) {

758 
FuncS‹
 *
fs
 = 
ls
->fs;

759 
Sh¬edPrÙo
 *
f
 = 
fs
->f->
¥
;

760 
Å¬ams
 = 0;

761 
f
->
is_v¬¬g
 = 0;

762 ià(
ls
->
t
.
tok’
 != ')') {

764 
ls
->
t
.
tok’
) {

765 
TK_NAME
: {

766 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

767 
Å¬ams
++;

770 
TK_DOTS
: {

771 
	`luaX_Ãxt
(
ls
);

772 
f
->
is_v¬¬g
 = 1;

775 : 
	`luaX_syÁax”rÜ
(
ls
, "<name> or '...'ƒxpected");

777 } !
f
->
is_v¬¬g
 && 
	`‹¡Ãxt
(
ls
, ','));

779 
	`adju¡loÿlv¬s
(
ls
, 
Å¬ams
);

780 
f
->
num·¿ms
 = 
	`ÿ¡_by‹
(
fs
->
Çùv¬
);

781 
	`luaK_»£rv”egs
(
fs
, fs->
Çùv¬
);

782 
	}
}

785 
	$body
 (
LexS‹
 *
ls
, 
expdesc
 *
e
, 
ism‘hod
, 
lše
) {

787 
FuncS‹
 
Ãw_fs
;

788 
BlockCÁ
 
bl
;

789 
Ãw_fs
.
f
 = 
	`add´ÙÙy³
(
ls
);

790 
Ãw_fs
.
f
->
¥
->
lšedefšed
 = 
lše
;

791 
	`İ’_func
(
ls
, &
Ãw_fs
, &
bl
);

792 
	`checkÃxt
(
ls
, '(');

793 ià(
ism‘hod
) {

794 
	`Ãw_loÿlv¬l™”®
(
ls
, "self");

795 
	`adju¡loÿlv¬s
(
ls
, 1);

797 
	`·¾i¡
(
ls
);

798 
	`checkÃxt
(
ls
, ')');

799 
	`¡©li¡
(
ls
);

800 
Ãw_fs
.
f
->
¥
->
Ï¡lšedefšed
 = 
ls
->
lš’umb”
;

801 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_FUNCTION
, 
lše
);

802 
	`codeşosu»
(
ls
, 
e
);

803 
	`şo£_func
(
ls
);

804 
	}
}

807 
	$ex¶i¡
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

809 
n
 = 1;

810 
	`ex´
(
ls
, 
v
);

811 
	`‹¡Ãxt
(
ls
, ',')) {

812 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, 
v
);

813 
	`ex´
(
ls
, 
v
);

814 
n
++;

816  
n
;

817 
	}
}

820 
	$funÿrgs
 (
LexS‹
 *
ls
, 
expdesc
 *
f
, 
lše
) {

821 
FuncS‹
 *
fs
 = 
ls
->fs;

822 
expdesc
 
¬gs
;

823 
ba£
, 
Å¬ams
;

824 
ls
->
t
.
tok’
) {

826 
	`luaX_Ãxt
(
ls
);

827 ià(
ls
->
t
.
tok’
 == ')')

828 
¬gs
.
k
 = 
VVOID
;

830 
	`ex¶i¡
(
ls
, &
¬gs
);

831 
	`luaK_£tmuÉ»t
(
fs
, &
¬gs
);

833 
	`check_m©ch
(
ls
, ')', '(', 
lše
);

837 
	`cÚ¡ruùÜ
(
ls
, &
¬gs
);

840 
TK_STRING
: {

841 
	`code¡ršg
(
ls
, &
¬gs
,†s->
t
.
£mšfo
.
ts
);

842 
	`luaX_Ãxt
(
ls
);

846 
	`luaX_syÁax”rÜ
(
ls
, "function‡rgumentsƒxpected");

849 
	`lua_as£¹
(
f
->
k
 =ğ
VNONRELOC
);

850 
ba£
 = 
f
->
u
.
šfo
;

851 ià(
	`hasmuÉ»t
(
¬gs
.
k
))

852 
Å¬ams
 = 
LUA_MULTRET
;

854 ià(
¬gs
.
k
 !ğ
VVOID
)

855 
	`luaK_exp2ÃxŒeg
(
fs
, &
¬gs
);

856 
Å¬ams
 = 
fs
->
ä“»g
 - (
ba£
+1);

858 
	`š™_exp
(
f
, 
VCALL
, 
	`luaK_codeABC
(
fs
, 
OP_CALL
, 
ba£
, 
Å¬ams
+1, 2));

859 
	`luaK_fixlše
(
fs
, 
lše
);

860 
fs
->
ä“»g
 = 
ba£
+1;

862 
	}
}

874 
	$´im¬yexp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

876 
ls
->
t
.
tok’
) {

878 
lše
 = 
ls
->
lš’umb”
;

879 
	`luaX_Ãxt
(
ls
);

880 
	`ex´
(
ls
, 
v
);

881 
	`check_m©ch
(
ls
, ')', '(', 
lše
);

882 
	`luaK_disch¬gev¬s
(
ls
->
fs
, 
v
);

885 
TK_NAME
: {

886 
	`sšgËv¬
(
ls
, 
v
);

890 
	`luaX_syÁax”rÜ
(
ls
, "unexpected symbol");

893 
	}
}

896 
	$suffixedexp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

899 
FuncS‹
 *
fs
 = 
ls
->fs;

900 
lše
 = 
ls
->
lš’umb”
;

901 
	`´im¬yexp
(
ls
, 
v
);

903 
ls
->
t
.
tok’
) {

905 
	`f›ld£l
(
ls
, 
v
);

909 
expdesc
 
key
;

910 
	`luaK_exp2ªy»gup
(
fs
, 
v
);

911 
	`yšdex
(
ls
, &
key
);

912 
	`luaK_šdexed
(
fs
, 
v
, &
key
);

916 
expdesc
 
key
;

917 
	`luaX_Ãxt
(
ls
);

918 
	`checkÇme
(
ls
, &
key
);

919 
	`luaK_£lf
(
fs
, 
v
, &
key
);

920 
	`funÿrgs
(
ls
, 
v
, 
lše
);

923 '(': 
TK_STRING
: '{': {

924 
	`luaK_exp2ÃxŒeg
(
fs
, 
v
);

925 
	`funÿrgs
(
ls
, 
v
, 
lše
);

931 
	}
}

934 
	$sim¶“xp
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

937 
ls
->
t
.
tok’
) {

938 
TK_FLT
: {

939 
	`š™_exp
(
v
, 
VKFLT
, 0);

940 
v
->
u
.
nv®
 = 
ls
->
t
.
£mšfo
.
r
;

943 
TK_INT
: {

944 
	`š™_exp
(
v
, 
VKINT
, 0);

945 
v
->
u
.
iv®
 = 
ls
->
t
.
£mšfo
.
i
;

948 
TK_STRING
: {

949 
	`code¡ršg
(
ls
, 
v
,†s->
t
.
£mšfo
.
ts
);

952 
TK_NIL
: {

953 
	`š™_exp
(
v
, 
VNIL
, 0);

956 
TK_TRUE
: {

957 
	`š™_exp
(
v
, 
VTRUE
, 0);

960 
TK_FALSE
: {

961 
	`š™_exp
(
v
, 
VFALSE
, 0);

964 
TK_DOTS
: {

965 
FuncS‹
 *
fs
 = 
ls
->fs;

966 
	`check_cÚd™iÚ
(
ls
, 
fs
->
f
->
¥
->
is_v¬¬g
,

968 
	`š™_exp
(
v
, 
VVARARG
, 
	`luaK_codeABC
(
fs
, 
OP_VARARG
, 0, 1, 0));

972 
	`cÚ¡ruùÜ
(
ls
, 
v
);

975 
TK_FUNCTION
: {

976 
	`luaX_Ãxt
(
ls
);

977 
	`body
(
ls
, 
v
, 0,†s->
lš’umb”
);

981 
	`suffixedexp
(
ls
, 
v
);

985 
	`luaX_Ãxt
(
ls
);

986 
	}
}

989 
UnO´
 
	$g‘unİr
 (
İ
) {

990 
İ
) {

991 
TK_NOT
:  
OPR_NOT
;

992 '-':  
OPR_MINUS
;

993 '~':  
OPR_BNOT
;

994 '#':  
OPR_LEN
;

995 :  
OPR_NOUNOPR
;

997 
	}
}

1000 
BšO´
 
	$g‘bšİr
 (
İ
) {

1001 
İ
) {

1002 '+':  
OPR_ADD
;

1003 '-':  
OPR_SUB
;

1004 '*':  
OPR_MUL
;

1005 '%':  
OPR_MOD
;

1006 '^':  
OPR_POW
;

1007 '/':  
OPR_DIV
;

1008 
TK_IDIV
:  
OPR_IDIV
;

1009 '&':  
OPR_BAND
;

1010 '|':  
OPR_BOR
;

1011 '~':  
OPR_BXOR
;

1012 
TK_SHL
:  
OPR_SHL
;

1013 
TK_SHR
:  
OPR_SHR
;

1014 
TK_CONCAT
:  
OPR_CONCAT
;

1015 
TK_NE
:  
OPR_NE
;

1016 
TK_EQ
:  
OPR_EQ
;

1017 '<':  
OPR_LT
;

1018 
TK_LE
:  
OPR_LE
;

1019 '>':  
OPR_GT
;

1020 
TK_GE
:  
OPR_GE
;

1021 
TK_AND
:  
OPR_AND
;

1022 
TK_OR
:  
OPR_OR
;

1023 :  
OPR_NOBINOPR
;

1025 
	}
}

1029 
lu_by‹
 
	mËá
;

1030 
lu_by‹
 
	mright
;

1031 } 
	g´iÜ™y
[] = {

1044 
	#UNARY_PRIORITY
 12

	)

1051 
BšO´
 
	$subex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
, 
lim™
) {

1052 
BšO´
 
İ
;

1053 
UnO´
 
uİ
;

1054 
	`’‹¾ev–
(
ls
);

1055 
uİ
 = 
	`g‘unİr
(
ls
->
t
.
tok’
);

1056 ià(
uİ
 !ğ
OPR_NOUNOPR
) {

1057 
lše
 = 
ls
->
lš’umb”
;

1058 
	`luaX_Ãxt
(
ls
);

1059 
	`subex´
(
ls
, 
v
, 
UNARY_PRIORITY
);

1060 
	`luaK_´efix
(
ls
->
fs
, 
uİ
, 
v
, 
lše
);

1062 
	`sim¶“xp
(
ls
, 
v
);

1064 
İ
 = 
	`g‘bšİr
(
ls
->
t
.
tok’
);

1065 
İ
 !ğ
OPR_NOBINOPR
 && 
´iÜ™y
[İ].
Ëá
 > 
lim™
) {

1066 
expdesc
 
v2
;

1067 
BšO´
 
Ãxtİ
;

1068 
lše
 = 
ls
->
lš’umb”
;

1069 
	`luaX_Ãxt
(
ls
);

1070 
	`luaK_šfix
(
ls
->
fs
, 
İ
, 
v
);

1072 
Ãxtİ
 = 
	`subex´
(
ls
, &
v2
, 
´iÜ™y
[
İ
].
right
);

1073 
	`luaK_posfix
(
ls
->
fs
, 
İ
, 
v
, &
v2
, 
lše
);

1074 
İ
 = 
Ãxtİ
;

1076 
	`Ëav–ev–
(
ls
);

1077  
İ
;

1078 
	}
}

1081 
	$ex´
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

1082 
	`subex´
(
ls
, 
v
, 0);

1083 
	}
}

1096 
	$block
 (
LexS‹
 *
ls
) {

1098 
FuncS‹
 *
fs
 = 
ls
->fs;

1099 
BlockCÁ
 
bl
;

1100 
	`’‹rblock
(
fs
, &
bl
, 0);

1101 
	`¡©li¡
(
ls
);

1102 
	`Ëaveblock
(
fs
);

1103 
	}
}

1110 
	sLHS_assign
 {

1111 
LHS_assign
 *
	m´ev
;

1112 
expdesc
 
	mv
;

1122 
	$check_cÚæiù
 (
LexS‹
 *
ls
, 
LHS_assign
 *
lh
, 
expdesc
 *
v
) {

1123 
FuncS‹
 *
fs
 = 
ls
->fs;

1124 
exŒa
 = 
fs
->
ä“»g
;

1125 
cÚæiù
 = 0;

1126 ; 
lh
;†h =†h->
´ev
) {

1127 ià(
lh
->
v
.
k
 =ğ
VINDEXED
) {

1129 ià(
lh
->
v
.
u
.
šd
.
vt
 =ğv->
k
 &&†h->v.u.šd.
t
 =ğv->u.
šfo
) {

1130 
cÚæiù
 = 1;

1131 
lh
->
v
.
u
.
šd
.
vt
 = 
VLOCAL
;

1132 
lh
->
v
.
u
.
šd
.
t
 = 
exŒa
;

1135 ià(
v
->
k
 =ğ
VLOCAL
 && 
lh
->v.
u
.
šd
.
idx
 =ğv->u.
šfo
) {

1136 
cÚæiù
 = 1;

1137 
lh
->
v
.
u
.
šd
.
idx
 = 
exŒa
;

1141 ià(
cÚæiù
) {

1143 
OpCode
 
İ
 = (
v
->
k
 =ğ
VLOCAL
è? 
OP_MOVE
 : 
OP_GETUPVAL
;

1144 
	`luaK_codeABC
(
fs
, 
İ
, 
exŒa
, 
v
->
u
.
šfo
, 0);

1145 
	`luaK_»£rv”egs
(
fs
, 1);

1147 
	}
}

1150 
	$assignm’t
 (
LexS‹
 *
ls
, 
LHS_assign
 *
lh
, 
nv¬s
) {

1151 
expdesc
 
e
;

1152 
	`check_cÚd™iÚ
(
ls
, 
	`vkisv¬
(
lh
->
v
.
k
), "syntaxƒrror");

1153 ià(
	`‹¡Ãxt
(
ls
, ',')) {

1154 
LHS_assign
 
nv
;

1155 
nv
.
´ev
 = 
lh
;

1156 
	`suffixedexp
(
ls
, &
nv
.
v
);

1157 ià(
nv
.
v
.
k
 !ğ
VINDEXED
)

1158 
	`check_cÚæiù
(
ls
, 
lh
, &
nv
.
v
);

1159 
	`checklim™
(
ls
->
fs
, 
nv¬s
 +†s->
L
->
nCÿÎs
, 
LUAI_MAXCCALLS
,

1161 
	`assignm’t
(
ls
, &
nv
, 
nv¬s
+1);

1164 
Ãxps
;

1165 
	`checkÃxt
(
ls
, '=');

1166 
Ãxps
 = 
	`ex¶i¡
(
ls
, &
e
);

1167 ià(
Ãxps
 !ğ
nv¬s
)

1168 
	`adju¡_assign
(
ls
, 
nv¬s
, 
Ãxps
, &
e
);

1170 
	`luaK_£tÚ”‘
(
ls
->
fs
, &
e
);

1171 
	`luaK_¡Üev¬
(
ls
->
fs
, &
lh
->
v
, &
e
);

1175 
	`š™_exp
(&
e
, 
VNONRELOC
, 
ls
->
fs
->
ä“»g
-1);

1176 
	`luaK_¡Üev¬
(
ls
->
fs
, &
lh
->
v
, &
e
);

1177 
	}
}

1180 
	$cÚd
 (
LexS‹
 *
ls
) {

1182 
expdesc
 
v
;

1183 
	`ex´
(
ls
, &
v
);

1184 ià(
v
.
k
 =ğ
VNIL
èv.k = 
VFALSE
;

1185 
	`luaK_goiárue
(
ls
->
fs
, &
v
);

1186  
v
.
f
;

1187 
	}
}

1190 
	$gÙo¡©
 (
LexS‹
 *
ls
, 
pc
) {

1191 
lše
 = 
ls
->
lš’umb”
;

1192 
TSŒšg
 *
Ïb–
;

1193 
g
;

1194 ià(
	`‹¡Ãxt
(
ls
, 
TK_GOTO
))

1195 
Ïb–
 = 
	`¡r_checkÇme
(
ls
);

1197 
	`luaX_Ãxt
(
ls
);

1198 
Ïb–
 = 
	`luaS_Ãw
(
ls
->
L
, "break");

1200 
g
 = 
	`ÃwÏb–’Œy
(
ls
, &ls->
dyd
->
gt
, 
Ïb–
, 
lše
, 
pc
);

1201 
	`fšdÏb–
(
ls
, 
g
);

1202 
	}
}

1206 
	$check»³©ed
 (
FuncS‹
 *
fs
, 
Lab–li¡
 *
Î
, 
TSŒšg
 *
Ïb–
) {

1207 
i
;

1208 
i
 = 
fs
->
bl
->
fœ¡Ïb–
; i < 
Î
->
n
; i++) {

1209 ià(
	`eq¡r
(
Ïb–
, 
Î
->
¬r
[
i
].
Çme
)) {

1210 cÚ¡ *
msg
 = 
	`luaO_pushf¡ršg
(
fs
->
ls
->
L
,

1212 
	`g‘¡r
(
Ïb–
), 
Î
->
¬r
[
i
].
lše
);

1213 
	`£m”rÜ
(
fs
->
ls
, 
msg
);

1216 
	}
}

1220 
	$sknoİ¡©
 (
LexS‹
 *
ls
) {

1221 
ls
->
t
.
tok’
 =ğ';' ||†s->t.tok’ =ğ
TK_DBCOLON
)

1222 
	`¡©em’t
(
ls
);

1223 
	}
}

1226 
	$Ïb–¡©
 (
LexS‹
 *
ls
, 
TSŒšg
 *
Ïb–
, 
lše
) {

1228 
FuncS‹
 *
fs
 = 
ls
->fs;

1229 
Lab–li¡
 *
Î
 = &
ls
->
dyd
->
Ïb–
;

1230 
l
;

1231 
	`check»³©ed
(
fs
, 
Î
, 
Ïb–
);

1232 
	`checkÃxt
(
ls
, 
TK_DBCOLON
);

1234 
l
 = 
	`ÃwÏb–’Œy
(
ls
, 
Î
, 
Ïb–
, 
lše
, 
	`luaK_g‘Ïb–
(
fs
));

1235 
	`sknoİ¡©
(
ls
);

1236 ià(
	`block_fŞlow
(
ls
, 0)) {

1238 
Î
->
¬r
[
l
].
Çùv¬
 = 
fs
->
bl
->nactvar;

1240 
	`fšdgÙos
(
ls
, &
Î
->
¬r
[
l
]);

1241 
	}
}

1244 
	$whe¡©
 (
LexS‹
 *
ls
, 
lše
) {

1246 
FuncS‹
 *
fs
 = 
ls
->fs;

1247 
wheš™
;

1248 
cÚdex™
;

1249 
BlockCÁ
 
bl
;

1250 
	`luaX_Ãxt
(
ls
);

1251 
wheš™
 = 
	`luaK_g‘Ïb–
(
fs
);

1252 
cÚdex™
 = 
	`cÚd
(
ls
);

1253 
	`’‹rblock
(
fs
, &
bl
, 1);

1254 
	`checkÃxt
(
ls
, 
TK_DO
);

1255 
	`block
(
ls
);

1256 
	`luaK_jum±o
(
fs
, 
wheš™
);

1257 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_WHILE
, 
lše
);

1258 
	`Ëaveblock
(
fs
);

1259 
	`luaK_·tchtoh”e
(
fs
, 
cÚdex™
);

1260 
	}
}

1263 
	$»³©¡©
 (
LexS‹
 *
ls
, 
lše
) {

1265 
cÚdex™
;

1266 
FuncS‹
 *
fs
 = 
ls
->fs;

1267 
»³©_š™
 = 
	`luaK_g‘Ïb–
(
fs
);

1268 
BlockCÁ
 
bl1
, 
bl2
;

1269 
	`’‹rblock
(
fs
, &
bl1
, 1);

1270 
	`’‹rblock
(
fs
, &
bl2
, 0);

1271 
	`luaX_Ãxt
(
ls
);

1272 
	`¡©li¡
(
ls
);

1273 
	`check_m©ch
(
ls
, 
TK_UNTIL
, 
TK_REPEAT
, 
lše
);

1274 
cÚdex™
 = 
	`cÚd
(
ls
);

1275 ià(
bl2
.
upv®
)

1276 
	`luaK_·tchşo£
(
fs
, 
cÚdex™
, 
bl2
.
Çùv¬
);

1277 
	`Ëaveblock
(
fs
);

1278 
	`luaK_·tchli¡
(
fs
, 
cÚdex™
, 
»³©_š™
);

1279 
	`Ëaveblock
(
fs
);

1280 
	}
}

1283 
	$exp1
 (
LexS‹
 *
ls
) {

1284 
expdesc
 
e
;

1285 
»g
;

1286 
	`ex´
(
ls
, &
e
);

1287 
	`luaK_exp2ÃxŒeg
(
ls
->
fs
, &
e
);

1288 
	`lua_as£¹
(
e
.
k
 =ğ
VNONRELOC
);

1289 
»g
 = 
e
.
u
.
šfo
;

1290  
»g
;

1291 
	}
}

1294 
	$fÜbody
 (
LexS‹
 *
ls
, 
ba£
, 
lše
, 
nv¬s
, 
i¢um
) {

1296 
BlockCÁ
 
bl
;

1297 
FuncS‹
 *
fs
 = 
ls
->fs;

1298 
´•
, 
’dfÜ
;

1299 
	`adju¡loÿlv¬s
(
ls
, 3);

1300 
	`checkÃxt
(
ls
, 
TK_DO
);

1301 
´•
 = 
i¢um
 ? 
	`luaK_codeAsBx
(
fs
, 
OP_FORPREP
, 
ba£
, 
NO_JUMP
è: 
	`luaK_jump
(fs);

1302 
	`’‹rblock
(
fs
, &
bl
, 0);

1303 
	`adju¡loÿlv¬s
(
ls
, 
nv¬s
);

1304 
	`luaK_»£rv”egs
(
fs
, 
nv¬s
);

1305 
	`block
(
ls
);

1306 
	`Ëaveblock
(
fs
);

1307 
	`luaK_·tchtoh”e
(
fs
, 
´•
);

1308 ià(
i¢um
)

1309 
’dfÜ
 = 
	`luaK_codeAsBx
(
fs
, 
OP_FORLOOP
, 
ba£
, 
NO_JUMP
);

1311 
	`luaK_codeABC
(
fs
, 
OP_TFORCALL
, 
ba£
, 0, 
nv¬s
);

1312 
	`luaK_fixlše
(
fs
, 
lše
);

1313 
’dfÜ
 = 
	`luaK_codeAsBx
(
fs
, 
OP_TFORLOOP
, 
ba£
 + 2, 
NO_JUMP
);

1315 
	`luaK_·tchli¡
(
fs
, 
’dfÜ
, 
´•
 + 1);

1316 
	`luaK_fixlše
(
fs
, 
lše
);

1317 
	}
}

1320 
	$fÜnum
 (
LexS‹
 *
ls
, 
TSŒšg
 *
v¬Çme
, 
lše
) {

1322 
FuncS‹
 *
fs
 = 
ls
->fs;

1323 
ba£
 = 
fs
->
ä“»g
;

1324 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for index)");

1325 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for†imit)");

1326 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for step)");

1327 
	`Ãw_loÿlv¬
(
ls
, 
v¬Çme
);

1328 
	`checkÃxt
(
ls
, '=');

1329 
	`exp1
(
ls
);

1330 
	`checkÃxt
(
ls
, ',');

1331 
	`exp1
(
ls
);

1332 ià(
	`‹¡Ãxt
(
ls
, ','))

1333 
	`exp1
(
ls
);

1335 
	`luaK_codek
(
fs
, fs->
ä“»g
, 
	`luaK_štK
(fs, 1));

1336 
	`luaK_»£rv”egs
(
fs
, 1);

1338 
	`fÜbody
(
ls
, 
ba£
, 
lše
, 1, 1);

1339 
	}
}

1342 
	$fÜli¡
 (
LexS‹
 *
ls
, 
TSŒšg
 *
šdexÇme
) {

1344 
FuncS‹
 *
fs
 = 
ls
->fs;

1345 
expdesc
 
e
;

1346 
nv¬s
 = 4;

1347 
lše
;

1348 
ba£
 = 
fs
->
ä“»g
;

1350 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for generator)");

1351 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for state)");

1352 
	`Ãw_loÿlv¬l™”®
(
ls
, "(for control)");

1354 
	`Ãw_loÿlv¬
(
ls
, 
šdexÇme
);

1355 
	`‹¡Ãxt
(
ls
, ',')) {

1356 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

1357 
nv¬s
++;

1359 
	`checkÃxt
(
ls
, 
TK_IN
);

1360 
lše
 = 
ls
->
lš’umb”
;

1361 
	`adju¡_assign
(
ls
, 3, 
	`ex¶i¡
Ös, &
e
), &e);

1362 
	`luaK_check¡ack
(
fs
, 3);

1363 
	`fÜbody
(
ls
, 
ba£
, 
lše
, 
nv¬s
 - 3, 0);

1364 
	}
}

1367 
	$fÜ¡©
 (
LexS‹
 *
ls
, 
lše
) {

1369 
FuncS‹
 *
fs
 = 
ls
->fs;

1370 
TSŒšg
 *
v¬Çme
;

1371 
BlockCÁ
 
bl
;

1372 
	`’‹rblock
(
fs
, &
bl
, 1);

1373 
	`luaX_Ãxt
(
ls
);

1374 
v¬Çme
 = 
	`¡r_checkÇme
(
ls
);

1375 
ls
->
t
.
tok’
) {

1376 '=': 
	`fÜnum
(
ls
, 
v¬Çme
, 
lše
); ;

1377 ',': 
TK_IN
: 
	`fÜli¡
(
ls
, 
v¬Çme
); ;

1378 : 
	`luaX_syÁax”rÜ
(
ls
, "'=' or 'in'ƒxpected");

1380 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_FOR
, 
lše
);

1381 
	`Ëaveblock
(
fs
);

1382 
	}
}

1385 
	$‹¡_th’_block
 (
LexS‹
 *
ls
, *
esÿ³li¡
) {

1387 
BlockCÁ
 
bl
;

1388 
FuncS‹
 *
fs
 = 
ls
->fs;

1389 
expdesc
 
v
;

1390 
jf
;

1391 
	`luaX_Ãxt
(
ls
);

1392 
	`ex´
(
ls
, &
v
);

1393 
	`checkÃxt
(
ls
, 
TK_THEN
);

1394 ià(
ls
->
t
.
tok’
 =ğ
TK_GOTO
 ||†s->t.tok’ =ğ
TK_BREAK
) {

1395 
	`luaK_goifçl£
(
ls
->
fs
, &
v
);

1396 
	`’‹rblock
(
fs
, &
bl
, 0);

1397 
	`gÙo¡©
(
ls
, 
v
.
t
);

1398 
	`‹¡Ãxt
(
ls
, ';')) {}

1399 ià(
	`block_fŞlow
(
ls
, 0)) {

1400 
	`Ëaveblock
(
fs
);

1404 
jf
 = 
	`luaK_jump
(
fs
);

1407 
	`luaK_goiárue
(
ls
->
fs
, &
v
);

1408 
	`’‹rblock
(
fs
, &
bl
, 0);

1409 
jf
 = 
v
.
f
;

1411 
	`¡©li¡
(
ls
);

1412 
	`Ëaveblock
(
fs
);

1413 ià(
ls
->
t
.
tok’
 =ğ
TK_ELSE
 ||

1414 
ls
->
t
.
tok’
 =ğ
TK_ELSEIF
)

1415 
	`luaK_cÚÿt
(
fs
, 
esÿ³li¡
, 
	`luaK_jump
(fs));

1416 
	`luaK_·tchtoh”e
(
fs
, 
jf
);

1417 
	}
}

1420 
	$if¡©
 (
LexS‹
 *
ls
, 
lše
) {

1422 
FuncS‹
 *
fs
 = 
ls
->fs;

1423 
esÿ³li¡
 = 
NO_JUMP
;

1424 
	`‹¡_th’_block
(
ls
, &
esÿ³li¡
);

1425 
ls
->
t
.
tok’
 =ğ
TK_ELSEIF
)

1426 
	`‹¡_th’_block
(
ls
, &
esÿ³li¡
);

1427 ià(
	`‹¡Ãxt
(
ls
, 
TK_ELSE
))

1428 
	`block
(
ls
);

1429 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_IF
, 
lše
);

1430 
	`luaK_·tchtoh”e
(
fs
, 
esÿ³li¡
);

1431 
	}
}

1434 
	$loÿlfunc
 (
LexS‹
 *
ls
) {

1435 
expdesc
 
b
;

1436 
FuncS‹
 *
fs
 = 
ls
->fs;

1437 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

1438 
	`adju¡loÿlv¬s
(
ls
, 1);

1439 
	`body
(
ls
, &
b
, 0,†s->
lš’umb”
);

1441 
	`g‘locv¬
(
fs
, 
b
.
u
.
šfo
)->
¡¬c
 = fs->
pc
;

1442 
	}
}

1445 
	$loÿl¡©
 (
LexS‹
 *
ls
) {

1447 
nv¬s
 = 0;

1448 
Ãxps
;

1449 
expdesc
 
e
;

1451 
	`Ãw_loÿlv¬
(
ls
, 
	`¡r_checkÇme
(ls));

1452 
nv¬s
++;

1453 } 
	`‹¡Ãxt
(
ls
, ','));

1454 ià(
	`‹¡Ãxt
(
ls
, '='))

1455 
Ãxps
 = 
	`ex¶i¡
(
ls
, &
e
);

1457 
e
.
k
 = 
VVOID
;

1458 
Ãxps
 = 0;

1460 
	`adju¡_assign
(
ls
, 
nv¬s
, 
Ãxps
, &
e
);

1461 
	`adju¡loÿlv¬s
(
ls
, 
nv¬s
);

1462 
	}
}

1465 
	$funúame
 (
LexS‹
 *
ls
, 
expdesc
 *
v
) {

1467 
ism‘hod
 = 0;

1468 
	`sšgËv¬
(
ls
, 
v
);

1469 
ls
->
t
.
tok’
 == '.')

1470 
	`f›ld£l
(
ls
, 
v
);

1471 ià(
ls
->
t
.
tok’
 == ':') {

1472 
ism‘hod
 = 1;

1473 
	`f›ld£l
(
ls
, 
v
);

1475  
ism‘hod
;

1476 
	}
}

1479 
	$func¡©
 (
LexS‹
 *
ls
, 
lše
) {

1481 
ism‘hod
;

1482 
expdesc
 
v
, 
b
;

1483 
	`luaX_Ãxt
(
ls
);

1484 
ism‘hod
 = 
	`funúame
(
ls
, &
v
);

1485 
	`body
(
ls
, &
b
, 
ism‘hod
, 
lše
);

1486 
	`luaK_¡Üev¬
(
ls
->
fs
, &
v
, &
b
);

1487 
	`luaK_fixlše
(
ls
->
fs
, 
lše
);

1488 
	}
}

1491 
	$ex´¡©
 (
LexS‹
 *
ls
) {

1493 
FuncS‹
 *
fs
 = 
ls
->fs;

1494 
LHS_assign
 
v
;

1495 
	`suffixedexp
(
ls
, &
v
.v);

1496 ià(
ls
->
t
.
tok’
 == '=' ||†s->t.token == ',') {

1497 
v
.
´ev
 = 
NULL
;

1498 
	`assignm’t
(
ls
, &
v
, 1);

1501 
	`check_cÚd™iÚ
(
ls
, 
v
.v.
k
 =ğ
VCALL
, "syntaxƒrror");

1502 
	`SETARG_C
(
	`g‘š¡ruùiÚ
(
fs
, &
v
.v), 1);

1504 
	}
}

1507 
	$»t¡©
 (
LexS‹
 *
ls
) {

1509 
FuncS‹
 *
fs
 = 
ls
->fs;

1510 
expdesc
 
e
;

1511 
fœ¡
, 
Ä‘
;

1512 ià(
	`block_fŞlow
(
ls
, 1è||†s->
t
.
tok’
 == ';')

1513 
fœ¡
 = 
Ä‘
 = 0;

1515 
Ä‘
 = 
	`ex¶i¡
(
ls
, &
e
);

1516 ià(
	`hasmuÉ»t
(
e
.
k
)) {

1517 
	`luaK_£tmuÉ»t
(
fs
, &
e
);

1518 ià(
e
.
k
 =ğ
VCALL
 && 
Ä‘
 == 1) {

1519 
	`SET_OPCODE
(
	`g‘š¡ruùiÚ
(
fs
,&
e
), 
OP_TAILCALL
);

1520 
	`lua_as£¹
(
	`GETARG_A
(
	`g‘š¡ruùiÚ
(
fs
,&
e
)è=ğfs->
Çùv¬
);

1522 
fœ¡
 = 
fs
->
Çùv¬
;

1523 
Ä‘
 = 
LUA_MULTRET
;

1526 ià(
Ä‘
 == 1)

1527 
fœ¡
 = 
	`luaK_exp2ªy»g
(
fs
, &
e
);

1529 
	`luaK_exp2ÃxŒeg
(
fs
, &
e
);

1530 
fœ¡
 = 
fs
->
Çùv¬
;

1531 
	`lua_as£¹
(
Ä‘
 =ğ
fs
->
ä“»g
 - 
fœ¡
);

1535 
	`luaK_»t
(
fs
, 
fœ¡
, 
Ä‘
);

1536 
	`‹¡Ãxt
(
ls
, ';');

1537 
	}
}

1540 
	$¡©em’t
 (
LexS‹
 *
ls
) {

1541 
lše
 = 
ls
->
lš’umb”
;

1542 
	`’‹¾ev–
(
ls
);

1543 
ls
->
t
.
tok’
) {

1545 
	`luaX_Ãxt
(
ls
);

1548 
TK_IF
: {

1549 
	`if¡©
(
ls
, 
lše
);

1552 
TK_WHILE
: {

1553 
	`whe¡©
(
ls
, 
lše
);

1556 
TK_DO
: {

1557 
	`luaX_Ãxt
(
ls
);

1558 
	`block
(
ls
);

1559 
	`check_m©ch
(
ls
, 
TK_END
, 
TK_DO
, 
lše
);

1562 
TK_FOR
: {

1563 
	`fÜ¡©
(
ls
, 
lše
);

1566 
TK_REPEAT
: {

1567 
	`»³©¡©
(
ls
, 
lše
);

1570 
TK_FUNCTION
: {

1571 
	`func¡©
(
ls
, 
lše
);

1574 
TK_LOCAL
: {

1575 
	`luaX_Ãxt
(
ls
);

1576 ià(
	`‹¡Ãxt
(
ls
, 
TK_FUNCTION
))

1577 
	`loÿlfunc
(
ls
);

1579 
	`loÿl¡©
(
ls
);

1582 
TK_DBCOLON
: {

1583 
	`luaX_Ãxt
(
ls
);

1584 
	`Ïb–¡©
(
ls
, 
	`¡r_checkÇme
Ös), 
lše
);

1587 
TK_RETURN
: {

1588 
	`luaX_Ãxt
(
ls
);

1589 
	`»t¡©
(
ls
);

1592 
TK_BREAK
:

1593 
TK_GOTO
: {

1594 
	`gÙo¡©
(
ls
, 
	`luaK_jump
Ös->
fs
));

1598 
	`ex´¡©
(
ls
);

1602 
	`lua_as£¹
(
ls
->
fs
->
f
->
¥
->
max¡acksize
 >ğls->fs->
ä“»g
 &&

1603 
ls
->
fs
->
ä“»g
 >ğls->fs->
Çùv¬
);

1604 
ls
->
fs
->
ä“»g
 =†s->fs->
Çùv¬
;

1605 
	`Ëav–ev–
(
ls
);

1606 
	}
}

1615 
	$mašfunc
 (
LexS‹
 *
ls
, 
FuncS‹
 *
fs
) {

1616 
BlockCÁ
 
bl
;

1617 
expdesc
 
v
;

1618 
	`İ’_func
(
ls
, 
fs
, &
bl
);

1619 
fs
->
f
->
¥
->
is_v¬¬g
 = 1;

1620 
	`š™_exp
(&
v
, 
VLOCAL
, 0);

1621 
	`Ãwupv®ue
(
fs
, 
ls
->
’vn
, &
v
);

1622 
	`luaX_Ãxt
(
ls
);

1623 
	`¡©li¡
(
ls
);

1624 
	`check
(
ls
, 
TK_EOS
);

1625 
	`şo£_func
(
ls
);

1626 
	}
}

1629 
LClosu»
 *
	$luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
,

1630 
Dynd©a
 *
dyd
, cÚ¡ *
Çme
, 
fœ¡ch¬
) {

1631 
LexS‹
 
Ëx¡©e
;

1632 
FuncS‹
 
func¡©e
;

1633 
LClosu»
 *
ş
 = 
	`luaF_ÃwLşosu»
(
L
, 1);

1634 
	`£tşLv®ue
(
L
, L->
tİ
, 
ş
);

1635 
	`luaD_šùİ
(
L
);

1636 
Ëx¡©e
.
h
 = 
	`luaH_Ãw
(
L
);

1637 
	`£thv®ue
(
L
, L->
tİ
, 
Ëx¡©e
.
h
);

1638 
	`luaD_šùİ
(
L
);

1639 
func¡©e
.
f
 = 
ş
->
p
 = 
	`luaF_Ãw´Ùo
(
L
, 
NULL
);

1640 
func¡©e
.
f
->
¥
->
sourû
 = 
	`luaS_Ãw
(
L
, 
Çme
);

1641 
	`lua_as£¹
(
	`iswh™e
(
func¡©e
.
f
));

1642 
Ëx¡©e
.
buff
 = buff;

1643 
Ëx¡©e
.
dyd
 = dyd;

1644 
dyd
->
aùv¬
.
n
 = dyd->
gt
.Àğdyd->
Ïb–
.n = 0;

1645 
	`luaX_£tšput
(
L
, &
Ëx¡©e
, 
z
, 
func¡©e
.
f
->
¥
->
sourû
, 
fœ¡ch¬
);

1646 
	`mašfunc
(&
Ëx¡©e
, &
func¡©e
);

1647 
	`lua_as£¹
(!
func¡©e
.
´ev
 && func¡©e.
nups
 =ğ1 && !
Ëx¡©e
.
fs
);

1649 
	`lua_as£¹
(
dyd
->
aùv¬
.
n
 =ğ0 && dyd->
gt
.À=ğ0 && dyd->
Ïb–
.n == 0);

1650 
L
->
tİ
--;

1651  
ş
;

1652 
	}
}

	@3rd/lua/lparser.h

7 #iâdeà
Í¬£r_h


8 
	#Í¬£r_h


	)

10 
	~"Îim™s.h
"

11 
	~"lobjeù.h
"

12 
	~"lzio.h
"

26 
	mVVOID
,

28 
	mVNIL
,

29 
	mVTRUE
,

30 
	mVFALSE
,

31 
	mVK
,

32 
	mVKFLT
,

33 
	mVKINT
,

34 
	mVNONRELOC
,

36 
	mVLOCAL
,

37 
	mVUPVAL
,

38 
	mVINDEXED
,

42 
	mVJMP
,

44 
	mVRELOCABLE
,

46 
	mVCALL
,

47 
	mVVARARG


48 } 
	texpkšd
;

51 
	#vkisv¬
(
k
è(
VLOCAL
 <ğ(kè&& (kè<ğ
VINDEXED
)

	)

52 
	#vkisš»g
(
k
è((kè=ğ
VNONRELOC
 || (kè=ğ
VLOCAL
)

	)

54 
	sexpdesc
 {

55 
expkšd
 
	mk
;

57 
lua_IÁeg”
 
	miv®
;

58 
lua_Numb”
 
	mnv®
;

59 
	mšfo
;

61 
	midx
;

62 
lu_by‹
 
	mt
;

63 
lu_by‹
 
	mvt
;

64 } 
	mšd
;

65 } 
	mu
;

66 
	mt
;

67 
	mf
;

68 } 
	texpdesc
;

72 
	sV¬desc
 {

73 
	midx
;

74 } 
	tV¬desc
;

78 
	sLab–desc
 {

79 
TSŒšg
 *
	mÇme
;

80 
	mpc
;

81 
	mlše
;

82 
lu_by‹
 
	mÇùv¬
;

83 } 
	tLab–desc
;

87 
	sLab–li¡
 {

88 
Lab–desc
 *
	m¬r
;

89 
	mn
;

90 
	msize
;

91 } 
	tLab–li¡
;

95 
	sDynd©a
 {

97 
V¬desc
 *
	m¬r
;

98 
	mn
;

99 
	msize
;

100 } 
	maùv¬
;

101 
Lab–li¡
 
	mgt
;

102 
Lab–li¡
 
	mÏb–
;

103 } 
	tDynd©a
;

107 
	gBlockCÁ
;

111 
	sFuncS‹
 {

112 
PrÙo
 *
	mf
;

113 
FuncS‹
 *
	m´ev
;

114 
LexS‹
 *
	mls
;

115 
BlockCÁ
 *
	mbl
;

116 
	mpc
;

117 
	mÏ¡rg‘
;

118 
	mjpc
;

119 
	mnk
;

120 
	mÅ
;

121 
	mfœ¡loÿl
;

122 
	mÆocv¬s
;

123 
lu_by‹
 
	mÇùv¬
;

124 
lu_by‹
 
	mnups
;

125 
lu_by‹
 
	mä“»g
;

126 } 
	tFuncS‹
;

129 
LUAI_FUNC
 
LClosu»
 *
luaY_·r£r
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
Mbufãr
 *
buff
,

130 
Dynd©a
 *
dyd
, cÚ¡ *
Çme
, 
fœ¡ch¬
);

	@3rd/lua/lprefix.h

7 #iâdeà
Í»fix_h


8 
	#Í»fix_h


	)

14 #ià!
defšed
(
LUA_USE_C89
)

16 #ià!
defšed
(
_XOPEN_SOURCE
)

17 
	#_XOPEN_SOURCE
 600

	)

18 #–ià
_XOPEN_SOURCE
 == 0

19 #undeà
_XOPEN_SOURCE


25 #ià!
defšed
(
LUA_32BITS
è&& !defšed(
_FILE_OFFSET_BITS
)

26 
	#_LARGEFILE_SOURCE
 1

	)

27 
	#_FILE_OFFSET_BITS
 64

	)

36 #ià
defšed
(
_WIN32
)

38 #ià!
defšed
(
_CRT_SECURE_NO_WARNINGS
)

39 
	#_CRT_SECURE_NO_WARNINGS


	)

	@3rd/lua/lstate.c

7 
	#l¡©e_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ddef.h
>

14 
	~<¡ršg.h
>

16 
	~"lua.h
"

18 
	~"Ïpi.h
"

19 
	~"ldebug.h
"

20 
	~"ldo.h
"

21 
	~"lfunc.h
"

22 
	~"lgc.h
"

23 
	~"Îex.h
"

24 
	~"lmem.h
"

25 
	~"l¡©e.h
"

26 
	~"l¡ršg.h
"

27 
	~"ÉabË.h
"

28 
	~"Ém.h
"

31 #ià!
defšed
(
LUAI_GCPAUSE
)

32 
	#LUAI_GCPAUSE
 200

	)

35 #ià!
defšed
(
LUAI_GCMUL
)

36 
	#LUAI_GCMUL
 200

	)

44 #ià!
defšed
(
luai_make£ed
)

45 
	~<time.h
>

46 
	#luai_make£ed
(è
	`ÿ¡
(, 
	`time
(
NULL
))

	)

54 
	sLX
 {

55 
lu_by‹
 
	mexŒa_
[
LUA_EXTRASPACE
];

56 
lua_S‹
 
	ml
;

57 } 
	tLX
;

63 
	sLG
 {

64 
LX
 
	ml
;

65 
glob®_S‹
 
	mg
;

66 } 
	tLG
;

70 
	#äom¡©e
(
L
è(
	`ÿ¡
(
LX
 *, ca¡(
lu_by‹
 *, (L)è- 
	`off£tof
(LX, 
l
)))

	)

77 
	#addbuff
(
b
,
p
,
e
) \

78 { 
size_t
 
t
 = 
	`ÿ¡
(size_t, 
e
); \

79 
	`memıy
(
b
 + 
p
, &
t
, Ñ));… +ğÑ); }

	)

81 
	$make£ed
 (
lua_S‹
 *
L
) {

82 
buff
[4 * (
size_t
)];

83 
h
 = 
	`luai_make£ed
();

84 
p
 = 0;

85 
	`addbuff
(
buff
, 
p
, 
L
);

86 
	`addbuff
(
buff
, 
p
, &
h
);

87 
	`addbuff
(
buff
, 
p
, 
luaO_nobjeù
);

88 
	`addbuff
(
buff
, 
p
, &
lua_Ãw¡©e
);

89 
	`lua_as£¹
(
p
 =ğ(
buff
));

90  
	`luaS_hash
(
buff
, 
p
, 
h
);

91 
	}
}

98 
	$luaE_£tdebt
 (
glob®_S‹
 *
g
, 
l_mem
 
debt
) {

99 
l_mem
 
tb
 = 
	`g‘tÙ®by‹s
(
g
);

100 
	`lua_as£¹
(
tb
 > 0);

101 ià(
debt
 < 
tb
 - 
MAX_LMEM
)

102 
debt
 = 
tb
 - 
MAX_LMEM
;

103 
g
->
tÙ®by‹s
 = 
tb
 - 
debt
;

104 
g
->
GCdebt
 = 
debt
;

105 
	}
}

108 
C®lInfo
 *
	$luaE_ex‹ndCI
 (
lua_S‹
 *
L
) {

109 
C®lInfo
 *
ci
 = 
	`luaM_Ãw
(
L
, CallInfo);

110 
	`lua_as£¹
(
L
->
ci
->
Ãxt
 =ğ
NULL
);

111 
L
->
ci
->
Ãxt
 = ci;

112 
ci
->
´evious
 = 
L
->ci;

113 
ci
->
Ãxt
 = 
NULL
;

114 
L
->
nci
++;

115  
ci
;

116 
	}
}

122 
	$luaE_ä“CI
 (
lua_S‹
 *
L
) {

123 
C®lInfo
 *
ci
 = 
L
->ci;

124 
C®lInfo
 *
Ãxt
 = 
ci
->next;

125 
ci
->
Ãxt
 = 
NULL
;

126 (
ci
 = 
Ãxt
è!ğ
NULL
) {

127 
Ãxt
 = 
ci
->next;

128 
	`luaM_ä“
(
L
, 
ci
);

129 
L
->
nci
--;

131 
	}
}

137 
	$luaE_shrškCI
 (
lua_S‹
 *
L
) {

138 
C®lInfo
 *
ci
 = 
L
->ci;

139 
C®lInfo
 *
Ãxt2
;

141 
ci
->
Ãxt
 !ğ
NULL
 && (
Ãxt2
 = ci->next->next) != NULL) {

142 
	`luaM_ä“
(
L
, 
ci
->
Ãxt
);

143 
L
->
nci
--;

144 
ci
->
Ãxt
 = 
Ãxt2
;

145 
Ãxt2
->
´evious
 = 
ci
;

146 
ci
 = 
Ãxt2
;

148 
	}
}

151 
	$¡ack_š™
 (
lua_S‹
 *
L1
,†ua_S‹ *
L
) {

152 
i
; 
C®lInfo
 *
ci
;

154 
L1
->
¡ack
 = 
	`luaM_ÃwveùÜ
(
L
, 
BASIC_STACK_SIZE
, 
TV®ue
);

155 
L1
->
¡acksize
 = 
BASIC_STACK_SIZE
;

156 
i
 = 0; i < 
BASIC_STACK_SIZE
; i++)

157 
	`£Šv®ue
(
L1
->
¡ack
 + 
i
);

158 
L1
->
tİ
 = L1->
¡ack
;

159 
L1
->
¡ack_Ï¡
 = L1->
¡ack
 + L1->
¡acksize
 - 
EXTRA_STACK
;

161 
ci
 = &
L1
->
ba£_ci
;

162 
ci
->
Ãxt
 = ci->
´evious
 = 
NULL
;

163 
ci
->
ÿÎ¡©us
 = 0;

164 
ci
->
func
 = 
L1
->
tİ
;

165 
	`£Šv®ue
(
L1
->
tİ
++);

166 
ci
->
tİ
 = 
L1
->tİ + 
LUA_MINSTACK
;

167 
L1
->
ci
 = ci;

168 
	}
}

171 
	$ä“¡ack
 (
lua_S‹
 *
L
) {

172 ià(
L
->
¡ack
 =ğ
NULL
)

174 
L
->
ci
 = &L->
ba£_ci
;

175 
	`luaE_ä“CI
(
L
);

176 
	`lua_as£¹
(
L
->
nci
 == 0);

177 
	`luaM_ä“¬¿y
(
L
, L->
¡ack
, L->
¡acksize
);

178 
	}
}

184 
	$š™_»gi¡ry
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

185 
TV®ue
 
‹mp
;

187 
TabË
 *
»gi¡ry
 = 
	`luaH_Ãw
(
L
);

188 
	`£thv®ue
(
L
, &
g
->
l_»gi¡ry
, 
»gi¡ry
);

189 
	`luaH_»size
(
L
, 
»gi¡ry
, 
LUA_RIDX_LAST
, 0);

191 
	`£‰hv®ue
(
L
, &
‹mp
, L);

192 
	`luaH_£tšt
(
L
, 
»gi¡ry
, 
LUA_RIDX_MAINTHREAD
, &
‹mp
);

194 
	`£thv®ue
(
L
, &
‹mp
, 
	`luaH_Ãw
(L));

195 
	`luaH_£tšt
(
L
, 
»gi¡ry
, 
LUA_RIDX_GLOBALS
, &
‹mp
);

196 
	}
}

203 
	$f_luaİ’
 (
lua_S‹
 *
L
, *
ud
) {

204 
glob®_S‹
 *
g
 = 
	`G
(
L
);

205 
	`UNUSED
(
ud
);

206 
	`¡ack_š™
(
L
, L);

207 
	`š™_»gi¡ry
(
L
, 
g
);

208 
	`luaS_š™
(
L
);

209 
	`luaT_š™
(
L
);

210 
	`luaX_š™
(
L
);

211 
g
->
güuÂšg
 = 1;

212 
g
->
v”siÚ
 = 
	`lua_v”siÚ
(
NULL
);

213 
	`luai_u£r¡©eİ’
(
L
);

214 
	}
}

221 
	$´eš™_th»ad
 (
lua_S‹
 *
L
, 
glob®_S‹
 *
g
) {

222 
	`G
(
L
èğ
g
;

223 
L
->
¡ack
 = 
NULL
;

224 
L
->
ci
 = 
NULL
;

225 
L
->
nci
 = 0;

226 
L
->
¡acksize
 = 0;

227 
L
->
twups
 = L;

228 
L
->
”rÜJmp
 = 
NULL
;

229 
L
->
nCÿÎs
 = 0;

230 
L
->
hook
 = 
NULL
;

231 
L
->
hookmask
 = 0;

232 
L
->
ba£hookcouÁ
 = 0;

233 
L
->
®lowhook
 = 1;

234 
	`»£thookcouÁ
(
L
);

235 
L
->
İ’upv®
 = 
NULL
;

236 
L
->
Ây
 = 1;

237 
L
->
¡©us
 = 
LUA_OK
;

238 
L
->
”rfunc
 = 0;

239 
	}
}

242 
	$şo£_¡©e
 (
lua_S‹
 *
L
) {

243 
glob®_S‹
 *
g
 = 
	`G
(
L
);

244 
	`luaF_şo£
(
L
, L->
¡ack
);

245 
	`luaC_ä“®lobjeùs
(
L
);

246 ià(
g
->
v”siÚ
)

247 
	`luai_u£r¡©eşo£
(
L
);

248 
	`luaM_ä“¬¿y
(
L
, 
	`G
(L)->
¡¹
.
hash
, G(L)->¡¹.
size
);

249 
	`ä“¡ack
(
L
);

250 
	`lua_as£¹
(
	`g‘tÙ®by‹s
(
g
è=ğ(
LG
));

251 (*
g
->
ä—Îoc
)(g->
ud
, 
	`äom¡©e
(
L
), (
LG
), 0);

252 
	}
}

255 
LUA_API
 
lua_S‹
 *
	$lua_Ãwth»ad
 (
lua_S‹
 *
L
) {

256 
glob®_S‹
 *
g
 = 
	`G
(
L
);

257 
lua_S‹
 *
L1
;

258 
	`lua_lock
(
L
);

259 
	`luaC_checkGC
(
L
);

261 
L1
 = &
	`ÿ¡
(
LX
 *, 
	`luaM_Ãwobjeù
(
L
, 
LUA_TTHREAD
, (LX)))->
l
;

262 
L1
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

263 
L1
->
‰
 = 
LUA_TTHREAD
;

265 
L1
->
Ãxt
 = 
g
->
®lgc
;

266 
g
->
®lgc
 = 
	`obj2gco
(
L1
);

268 
	`£‰hv®ue
(
L
, L->
tİ
, 
L1
);

269 
	`­i_šü_tİ
(
L
);

270 
	`´eš™_th»ad
(
L1
, 
g
);

271 
L1
->
hookmask
 = 
L
->hookmask;

272 
L1
->
ba£hookcouÁ
 = 
L
->basehookcount;

273 
L1
->
hook
 = 
L
->hook;

274 
	`»£thookcouÁ
(
L1
);

276 
	`memıy
(
	`lua_g‘exŒa¥aû
(
L1
),†ua_g‘exŒa¥aû(
g
->
mašth»ad
),

277 
LUA_EXTRASPACE
);

278 
	`luai_u£r¡©‘h»ad
(
L
, 
L1
);

279 
	`¡ack_š™
(
L1
, 
L
);

280 
	`lua_uÆock
(
L
);

281  
L1
;

282 
	}
}

285 
	$luaE_ä“th»ad
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
) {

286 
LX
 *
l
 = 
	`äom¡©e
(
L1
);

287 
	`luaF_şo£
(
L1
, L1->
¡ack
);

288 
	`lua_as£¹
(
L1
->
İ’upv®
 =ğ
NULL
);

289 
	`luai_u£r¡©eä“
(
L
, 
L1
);

290 
	`ä“¡ack
(
L1
);

291 
	`luaM_ä“
(
L
, 
l
);

292 
	}
}

295 
LUA_API
 
lua_S‹
 *
	$lua_Ãw¡©e
 (
lua_AÎoc
 
f
, *
ud
) {

296 
i
;

297 
lua_S‹
 *
L
;

298 
glob®_S‹
 *
g
;

299 
LG
 *
l
 = 
	`ÿ¡
(LG *, (*
f
)(
ud
, 
NULL
, 
LUA_TTHREAD
, (LG)));

300 ià(
l
 =ğ
NULL
)  NULL;

301 
L
 = &
l
->l.l;

302 
g
 = &
l
->g;

303 
L
->
Ãxt
 = 
NULL
;

304 
L
->
‰
 = 
LUA_TTHREAD
;

305 
g
->
cu¼’twh™e
 = 
	`b™mask
(
WHITE0BIT
);

306 
L
->
m¬ked
 = 
	`luaC_wh™e
(
g
);

307 
	`´eš™_th»ad
(
L
, 
g
);

308 
g
->
ä—Îoc
 = 
f
;

309 
g
->
ud
 = ud;

310 
g
->
mašth»ad
 = 
L
;

311 
g
->
£ed
 = 
	`make£ed
(
L
);

312 
g
->
güuÂšg
 = 0;

313 
g
->
GCe¡im©e
 = 0;

314 
g
->
¡¹
.
size
 = g->¡¹.
nu£
 = 0;

315 
g
->
¡¹
.
hash
 = 
NULL
;

316 
	`£Šv®ue
(&
g
->
l_»gi¡ry
);

317 
g
->
·nic
 = 
NULL
;

318 
g
->
v”siÚ
 = 
NULL
;

319 
g
->
gc¡©e
 = 
GCS·u£
;

320 
g
->
gckšd
 = 
KGC_NORMAL
;

321 
g
->
®lgc
 = g->
fšobj
 = g->
tobeâz
 = g->
fixedgc
 = 
NULL
;

322 
g
->
sw“pgc
 = 
NULL
;

323 
g
->
g¿y
 = g->
g¿yagaš
 = 
NULL
;

324 
g
->
w—k
 = g->
•hem”Ú
 = g->
®lw—k
 = 
NULL
;

325 
g
->
twups
 = 
NULL
;

326 
g
->
tÙ®by‹s
 = (
LG
);

327 
g
->
GCdebt
 = 0;

328 
g
->
gcfšnum
 = 0;

329 
g
->
gıau£
 = 
LUAI_GCPAUSE
;

330 
g
->
gc¡•mul
 = 
LUAI_GCMUL
;

331 
i
=0; i < 
LUA_NUMTAGS
; i++è
g
->
mt
[i] = 
NULL
;

332 ià(
	`luaD_¿wruÅrÙeùed
(
L
, 
f_luaİ’
, 
NULL
è!ğ
LUA_OK
) {

334 
	`şo£_¡©e
(
L
);

335 
L
 = 
NULL
;

337  
L
;

338 
	}
}

341 
LUA_API
 
	$lua_şo£
 (
lua_S‹
 *
L
) {

342 
L
 = 
	`G
(L)->
mašth»ad
;

343 
	`lua_lock
(
L
);

344 
	`şo£_¡©e
(
L
);

345 
	}
}

	@3rd/lua/lstate.h

7 #iâdeà
l¡©e_h


8 
	#l¡©e_h


	)

10 
	~"lua.h
"

12 
	~"lobjeù.h
"

13 
	~"Ém.h
"

14 
	~"lzio.h
"

33 
	glua_lÚgjmp
;

40 #ià!
defšed
(
l_sigÇlT
)

41 
	~<sigÇl.h
>

42 
	#l_sigÇlT
 
sig_©omic_t


	)

47 
	#EXTRA_STACK
 5

	)

50 
	#BASIC_STACK_SIZE
 (2*
LUA_MINSTACK
)

	)

54 
	#KGC_NORMAL
 0

	)

55 
	#KGC_EMERGENCY
 1

	)

58 
	s¡ršgbË
 {

59 
TSŒšg
 **
	mhash
;

60 
	mnu£
;

61 
	msize
;

62 } 
	t¡ršgbË
;

74 
	sC®lInfo
 {

75 
StkId
 
	mfunc
;

76 
StkId
 
	mtİ
;

77 
C®lInfo
 *
	m´evious
, *
	mÃxt
;

80 
StkId
 
	mba£
;

81 cÚ¡ 
In¡ruùiÚ
 *
	m§vedpc
;

82 } 
	ml
;

84 
lua_KFunùiÚ
 
	mk
;

85 
±rdiff_t
 
	mŞd_”rfunc
;

86 
lua_KCÚ‹xt
 
	mùx
;

87 } 
	mc
;

88 } 
	mu
;

89 
±rdiff_t
 
	mexŒa
;

90 
	mÄesuÉs
;

91 
	mÿÎ¡©us
;

92 } 
	tC®lInfo
;

98 
	#CIST_OAH
 (1<<0è

	)

99 
	#CIST_LUA
 (1<<1è

	)

100 
	#CIST_HOOKED
 (1<<2è

	)

101 
	#CIST_FRESH
 (1<<3è

	)

103 
	#CIST_YPCALL
 (1<<4è

	)

104 
	#CIST_TAIL
 (1<<5è

	)

105 
	#CIST_HOOKYIELD
 (1<<6è

	)

106 
	#CIST_LEQ
 (1<<7è

	)

107 
	#CIST_FIN
 (1<<8è

	)

109 
	#isLua
(
ci
è((ci)->
ÿÎ¡©us
 & 
CIST_LUA
)

	)

112 
	#£tßh
(
¡
,
v
è((¡èğ((¡è& ~
CIST_OAH
è| (v))

	)

113 
	#g‘ßh
(
¡
è((¡è& 
CIST_OAH
)

	)

119 
	sglob®_S‹
 {

120 
lua_AÎoc
 
	mä—Îoc
;

121 *
	mud
;

122 
l_mem
 
	mtÙ®by‹s
;

123 
l_mem
 
	mGCdebt
;

124 
lu_mem
 
	mGCmemŒav
;

125 
lu_mem
 
	mGCe¡im©e
;

126 
¡ršgbË
 
	m¡¹
;

127 
TV®ue
 
	ml_»gi¡ry
;

128 
	m£ed
;

129 
lu_by‹
 
	mcu¼’twh™e
;

130 
lu_by‹
 
	mgc¡©e
;

131 
lu_by‹
 
	mgckšd
;

132 
lu_by‹
 
	mgüuÂšg
;

133 
GCObjeù
 *
	m®lgc
;

134 
GCObjeù
 **
	msw“pgc
;

135 
GCObjeù
 *
	mfšobj
;

136 
GCObjeù
 *
	mg¿y
;

137 
GCObjeù
 *
	mg¿yagaš
;

138 
GCObjeù
 *
	mw—k
;

139 
GCObjeù
 *
	m•hem”Ú
;

140 
GCObjeù
 *
	m®lw—k
;

141 
GCObjeù
 *
	mtobeâz
;

142 
GCObjeù
 *
	mfixedgc
;

143 
lua_S‹
 *
	mtwups
;

144 
	mgcfšnum
;

145 
	mgıau£
;

146 
	mgc¡•mul
;

147 
lua_CFunùiÚ
 
	m·nic
;

148 
lua_S‹
 *
	mmašth»ad
;

149 cÚ¡ 
lua_Numb”
 *
	mv”siÚ
;

150 
TSŒšg
 *
	mmem”rmsg
;

151 
TSŒšg
 *
	mtmÇme
[
TM_N
];

152 
TabË
 *
	mmt
[
LUA_NUMTAGS
];

153 
TSŒšg
 *
	m¡rÿche
[
STRCACHE_N
][
STRCACHE_M
];

154 } 
	tglob®_S‹
;

160 
	slua_S‹
 {

161 
	mCommÚH—d”
;

162 
	mnci
;

163 
lu_by‹
 
	m¡©us
;

164 
StkId
 
	mtİ
;

165 
glob®_S‹
 *
	ml_G
;

166 
C®lInfo
 *
	mci
;

167 cÚ¡ 
In¡ruùiÚ
 *
	mŞdpc
;

168 
StkId
 
	m¡ack_Ï¡
;

169 
StkId
 
	m¡ack
;

170 
UpV®
 *
	mİ’upv®
;

171 
GCObjeù
 *
	mgşi¡
;

172 
lua_S‹
 *
	mtwups
;

173 
lua_lÚgjmp
 *
	m”rÜJmp
;

174 
C®lInfo
 
	mba£_ci
;

175 vŞ©
lua_Hook
 
	mhook
;

176 
±rdiff_t
 
	m”rfunc
;

177 
	m¡acksize
;

178 
	mba£hookcouÁ
;

179 
	mhookcouÁ
;

180 
	mÂy
;

181 
	mnCÿÎs
;

182 
l_sigÇlT
 
	mhookmask
;

183 
lu_by‹
 
	m®lowhook
;

187 
	#G
(
L
è(L->
l_G
)

	)

193 
	uGCUniÚ
 {

194 
GCObjeù
 
	mgc
;

195 
TSŒšg
 
	mts
;

196 
Ud©a
 
	mu
;

197 
Closu»
 
	mş
;

198 
TabË
 
	mh
;

199 
PrÙo
 
	mp
;

200 
lua_S‹
 
	mth
;

204 
	#ÿ¡_u
(
o
è
	`ÿ¡
(
GCUniÚ
 *, (o))

	)

207 
	#gco2ts
(
o
) \

208 
	`check_exp
(
	`nov¬ŸÁ
((
o
)->
‰
è=ğ
LUA_TSTRING
, &((
	`ÿ¡_u
(o))->
ts
))

	)

209 
	#gco2u
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TUSERDATA
, &((
	`ÿ¡_u
(o))->
u
))

	)

210 
	#gco2lş
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TLCL
, &((
	`ÿ¡_u
(o))->
ş
.
l
))

	)

211 
	#gco2cş
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TCCL
, &((
	`ÿ¡_u
(o))->
ş
.
c
))

	)

212 
	#gco2ş
(
o
) \

213 
	`check_exp
(
	`nov¬ŸÁ
((
o
)->
‰
è=ğ
LUA_TFUNCTION
, &((
	`ÿ¡_u
(o))->
ş
))

	)

214 
	#gco2t
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TTABLE
, &((
	`ÿ¡_u
(o))->
h
))

	)

215 
	#gco2p
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TPROTO
, &((
	`ÿ¡_u
(o))->
p
))

	)

216 
	#gco2th
(
o
è
	`check_exp
((o)->
‰
 =ğ
LUA_TTHREAD
, &((
	`ÿ¡_u
(o))->
th
))

	)

220 
	#obj2gco
(
v
) \

221 
	`check_exp
(
	`nov¬ŸÁ
((
v
)->
‰
è< 
LUA_TDEADKEY
, (&(
	`ÿ¡_u
(v)->
gc
)))

	)

225 
	#g‘tÙ®by‹s
(
g
è
	`ÿ¡
(
lu_mem
, (g)->
tÙ®by‹s
 + (g)->
GCdebt
)

	)

227 
LUAI_FUNC
 
luaE_£tdebt
 (
glob®_S‹
 *
g
, 
l_mem
 
debt
);

228 
LUAI_FUNC
 
luaE_ä“th»ad
 (
lua_S‹
 *
L
,†ua_S‹ *
L1
);

229 
LUAI_FUNC
 
C®lInfo
 *
luaE_ex‹ndCI
 (
lua_S‹
 *
L
);

230 
LUAI_FUNC
 
luaE_ä“CI
 (
lua_S‹
 *
L
);

231 
LUAI_FUNC
 
luaE_shrškCI
 (
lua_S‹
 *
L
);

	@3rd/lua/lstring.c

7 
	#l¡ršg_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lmem.h
"

20 
	~"lobjeù.h
"

21 
	~"l¡©e.h
"

22 
	~"l¡ršg.h
"

25 
	#MEMERRMSG
 "nÙƒnough memÜy"

	)

32 #ià!
defšed
(
LUAI_HASHLIMIT
)

33 
	#LUAI_HASHLIMIT
 5

	)

40 
	$luaS_eqÊg¡r
 (
TSŒšg
 *
a
, TSŒšg *
b
) {

41 
size_t
 
Ën
 = 
a
->
u
.
ÊgËn
;

42 
	`lua_as£¹
(
a
->
‰
 =ğ
LUA_TLNGSTR
 && 
b
->tt == LUA_TLNGSTR);

43  (
a
 =ğ
b
) ||

44 ((
Ën
 =ğ
b
->
u
.
ÊgËn
) &&

45 (
	`memcmp
(
	`g‘¡r
(
a
), g‘¡r(
b
), 
Ën
) == 0));

46 
	}
}

49 
	$luaS_hash
 (cÚ¡ *
¡r
, 
size_t
 
l
, 
£ed
) {

50 
h
 = 
£ed
 ^ 
	`ÿ¡
(, 
l
);

51 
size_t
 
¡•
 = (
l
 >> 
LUAI_HASHLIMIT
) + 1;

52 ; 
l
 >ğ
¡•
;† -= step)

53 
h
 ^ğ((h<<5è+ (h>>2è+ 
	`ÿ¡_by‹
(
¡r
[
l
 - 1]));

54  
h
;

55 
	}
}

58 
	$luaS_hashlÚg¡r
 (
TSŒšg
 *
ts
) {

59 
	`lua_as£¹
(
ts
->
‰
 =ğ
LUA_TLNGSTR
);

60 ià(
ts
->
exŒa
 == 0) {

61 
ts
->
hash
 = 
	`luaS_hash
(
	`g‘¡r
Ñs),s->
u
.
ÊgËn
,s->hash);

62 
ts
->
exŒa
 = 1;

64  
ts
->
hash
;

65 
	}
}

71 
	$luaS_»size
 (
lua_S‹
 *
L
, 
Ãwsize
) {

72 
i
;

73 
¡ršgbË
 *
tb
 = &
	`G
(
L
)->
¡¹
;

74 ià(
Ãwsize
 > 
tb
->
size
) {

75 
	`luaM_»®locveùÜ
(
L
, 
tb
->
hash
,b->
size
, 
Ãwsize
, 
TSŒšg
 *);

76 
i
 = 
tb
->
size
; i < 
Ãwsize
; i++)

77 
tb
->
hash
[
i
] = 
NULL
;

79 
i
 = 0; i < 
tb
->
size
; i++) {

80 
TSŒšg
 *
p
 = 
tb
->
hash
[
i
];

81 
tb
->
hash
[
i
] = 
NULL
;

82 
p
) {

83 
TSŒšg
 *
hÃxt
 = 
p
->
u
.hnext;

84 
h
 = 
	`lmod
(
p
->
hash
, 
Ãwsize
);

85 
p
->
u
.
hÃxt
 = 
tb
->
hash
[
h
];

86 
tb
->
hash
[
h
] = 
p
;

87 
p
 = 
hÃxt
;

90 ià(
Ãwsize
 < 
tb
->
size
) {

92 
	`lua_as£¹
(
tb
->
hash
[
Ãwsize
] =ğ
NULL
 &&b->hash[tb->
size
 - 1] == NULL);

93 
	`luaM_»®locveùÜ
(
L
, 
tb
->
hash
,b->
size
, 
Ãwsize
, 
TSŒšg
 *);

95 
tb
->
size
 = 
Ãwsize
;

96 
	}
}

103 
	$luaS_ş—rÿche
 (
glob®_S‹
 *
g
) {

104 
i
, 
j
;

105 
i
 = 0; i < 
STRCACHE_N
; i++)

106 
j
 = 0; j < 
STRCACHE_M
; j++) {

107 ià(
	`iswh™e
(
g
->
¡rÿche
[
i
][
j
]))

108 
g
->
¡rÿche
[
i
][
j
] = g->
mem”rmsg
;

110 
	}
}

116 
	$luaS_š™
 (
lua_S‹
 *
L
) {

117 
glob®_S‹
 *
g
 = 
	`G
(
L
);

118 
i
, 
j
;

119 
	`luaS_»size
(
L
, 
MINSTRTABSIZE
);

121 
g
->
mem”rmsg
 = 
	`luaS_Ãwl™”®
(
L
, 
MEMERRMSG
);

122 
	`luaC_fix
(
L
, 
	`obj2gco
(
g
->
mem”rmsg
));

123 
i
 = 0; i < 
STRCACHE_N
; i++)

124 
j
 = 0; j < 
STRCACHE_M
; j++)

125 
g
->
¡rÿche
[
i
][
j
] = g->
mem”rmsg
;

126 
	}
}

133 
TSŒšg
 *
	$ü—‹¡robj
 (
lua_S‹
 *
L
, 
size_t
 
l
, 
g
, 
h
) {

134 
TSŒšg
 *
ts
;

135 
GCObjeù
 *
o
;

136 
size_t
 
tÙ®size
;

137 
tÙ®size
 = 
	`siz–¡ršg
(
l
);

138 
o
 = 
	`luaC_Ãwobj
(
L
, 
g
, 
tÙ®size
);

139 
ts
 = 
	`gco2ts
(
o
);

140 
ts
->
hash
 = 
h
;

141 
ts
->
exŒa
 = 0;

142 
	`g‘¡r
(
ts
)[
l
] = '\0';

143  
ts
;

144 
	}
}

147 
TSŒšg
 *
	$luaS_ü—‹Êg¡robj
 (
lua_S‹
 *
L
, 
size_t
 
l
) {

148 
TSŒšg
 *
ts
 = 
	`ü—‹¡robj
(
L
, 
l
, 
LUA_TLNGSTR
, 
	`G
(L)->
£ed
);

149 
ts
->
u
.
ÊgËn
 = 
l
;

150  
ts
;

151 
	}
}

154 
	$luaS_»move
 (
lua_S‹
 *
L
, 
TSŒšg
 *
ts
) {

155 
¡ršgbË
 *
tb
 = &
	`G
(
L
)->
¡¹
;

156 
TSŒšg
 **
p
 = &
tb
->
hash
[
	`lmod
(
ts
->hash,b->
size
)];

157 *
p
 !ğ
ts
)

158 
p
 = &(*p)->
u
.
hÃxt
;

159 *
p
 = (*p)->
u
.
hÃxt
;

160 
tb
->
nu£
--;

161 
	}
}

167 
TSŒšg
 *
	$qu”yshr¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
, 
h
) {

168 
TSŒšg
 *
ts
;

169 
glob®_S‹
 *
g
 = 
	`G
(
L
);

170 
TSŒšg
 **
li¡
 = &
g
->
¡¹
.
hash
[
	`lmod
(
h
, g->¡¹.
size
)];

171 
	`lua_as£¹
(
¡r
 !ğ
NULL
);

172 
ts
 = *
li¡
; !ğ
NULL
; ğts->
u
.
hÃxt
) {

173 ià(
l
 =ğ
ts
->
sh¾’
 &&

174 (
	`memcmp
(
¡r
, 
	`g‘¡r
(
ts
), 
l
 * ()) == 0)) {

176 ià(
	`isd—d
(
g
, 
ts
))

177 
	`chªgewh™e
(
ts
);

178  
ts
;

181  
NULL
;

182 
	}
}

184 
TSŒšg
 *
	$addshr¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
, 
h
) {

185 
TSŒšg
 *
ts
;

186 
glob®_S‹
 *
g
 = 
	`G
(
L
);

187 
TSŒšg
 **
li¡
 = &
g
->
¡¹
.
hash
[
	`lmod
(
h
, g->¡¹.
size
)];

188 ià(
g
->
¡¹
.
nu£
 >ğg->¡¹.
size
 && g->¡¹.siz<ğ
MAX_INT
/2) {

189 
	`luaS_»size
(
L
, 
g
->
¡¹
.
size
 * 2);

190 
li¡
 = &
g
->
¡¹
.
hash
[
	`lmod
(
h
, g->¡¹.
size
)];

192 
ts
 = 
	`ü—‹¡robj
(
L
, 
l
, 
LUA_TSHRSTR
, 
h
);

193 
	`memıy
(
	`g‘¡r
(
ts
), 
¡r
, 
l
 * ());

194 
ts
->
sh¾’
 = 
	`ÿ¡_by‹
(
l
);

195 
ts
->
u
.
hÃxt
 = *
li¡
;

196 *
li¡
 = 
ts
;

197 
g
->
¡¹
.
nu£
++;

198  
ts
;

199 
	}
}

201 
TSŒšg
 *
š‹ºshr¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
);

206 
TSŒšg
 *
	$luaS_Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

207 ià(
l
 <ğ
LUAI_MAXSHORTLEN
)

208  
	`š‹ºshr¡r
(
L
, 
¡r
, 
l
);

210 
TSŒšg
 *
ts
;

211 ià(
l
 >ğ(
MAX_SIZE
 - (
TSŒšg
))/())

212 
	`luaM_toobig
(
L
);

213 
ts
 = 
	`luaS_ü—‹Êg¡robj
(
L
, 
l
);

214 
	`memıy
(
	`g‘¡r
(
ts
), 
¡r
, 
l
 * ());

215  
ts
;

217 
	}
}

226 
TSŒšg
 *
	$luaS_Ãw
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
) {

227 
i
 = 
	`pošt2ušt
(
¡r
è% 
STRCACHE_N
;

228 
j
;

229 
TSŒšg
 **
p
 = 
	`G
(
L
)->
¡rÿche
[
i
];

230 
j
 = 0; j < 
STRCACHE_M
; j++) {

231 ià(
	`¡rcmp
(
¡r
, 
	`g‘¡r
(
p
[
j
])) == 0)

232  
p
[
j
];

235 
j
 = 
STRCACHE_M
 - 1; j > 0; j--)

236 
p
[
j
] =…[j - 1];

238 
p
[0] = 
	`luaS_Ãwl¡r
(
L
, 
¡r
, 
	`¡¾’
(str));

239  
p
[0];

240 
	}
}

243 
Ud©a
 *
	$luaS_Ãwud©a
 (
lua_S‹
 *
L
, 
size_t
 
s
) {

244 
Ud©a
 *
u
;

245 
GCObjeù
 *
o
;

246 ià(
s
 > 
MAX_SIZE
 - (
Ud©a
))

247 
	`luaM_toobig
(
L
);

248 
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TUSERDATA
, 
	`siz–ud©a
(
s
));

249 
u
 = 
	`gco2u
(
o
);

250 
u
->
Ën
 = 
s
;

251 
u
->
m‘©abË
 = 
NULL
;

252 
	`£tu£rv®ue
(
L
, 
u
, 
luaO_nobjeù
);

253  
u
;

254 
	}
}

260 
	~"rwlock.h
"

261 
	~"©omic.h
"

262 
	~<¡dlib.h
>

264 
	#SHRSTR_SLOT
 0x10000

	)

265 
	#HASH_NODE
(
h
è((hè% 
SHRSTR_SLOT
)

	)

266 
	#g‘addr¡r
(
ts
è(
	`ÿ¡
(*, (ts)è+ (
UTSŒšg
))

	)

268 
	sshrm­_¦Ù
 {

269 
rwlock
 
	mlock
;

270 
TSŒšg
 *
	m¡r
;

273 
	sshrm­
 {

274 
shrm­_¦Ù
 
	mh
[
SHRSTR_SLOT
];

275 
	mn
;

278 
shrm­
 
	gSSM
;

280 
LUA_API
 

281 
	$luaS_š™shr
() {

282 
shrm­
 * 
s
 = &
SSM
;

283 
i
;

284 
i
=0;i<
SHRSTR_SLOT
;i++) {

285 
	`rwlock_š™
(&
s
->
h
[
i
].
lock
);

287 
	}
}

289 
LUA_API
 

290 
	$luaS_ex™shr
() {

291 
i
;

292 
i
=0;i<
SHRSTR_SLOT
;i++) {

293 
TSŒšg
 *
¡r
 = 
SSM
.
h
[
i
].str;

294 
¡r
) {

295 
TSŒšg
 * 
Ãxt
 = 
¡r
->
u
.
hÃxt
;

296 
	`ä“
(
¡r
);

297 
¡r
 = 
Ãxt
;

300 
	}
}

302 
TSŒšg
 *

303 
	$qu”y_¡ršg
(
h
, cÚ¡ *
¡r
, 
lu_by‹
 
l
) {

304 
shrm­_¦Ù
 *
s
 = &
SSM
.
h
[
	`HASH_NODE
(h)];

305 
	`rwlock_¾ock
(&
s
->
lock
);

306 
TSŒšg
 *
ts
 = 
s
->
¡r
;

307 
ts
) {

308 ià(
ts
->
hash
 =ğ
h
 &&

309 
ts
->
sh¾’
 =ğ
l
 &&

310 
	`memcmp
(
¡r
, 
ts
+1, 
l
) == 0) {

313 
ts
 =s->
u
.
hÃxt
;

315 
	`rwlock_ruÆock
(&
s
->
lock
);

316  
ts
;

317 
	}
}

319 
TSŒšg
 *

320 
	$qu”y_±r
(
TSŒšg
 *
t
) {

321 
h
 = 
t
->
hash
;

322 
shrm­_¦Ù
 *
s
 = &
SSM
.
h
[
	`HASH_NODE
(h)];

323 
	`rwlock_¾ock
(&
s
->
lock
);

324 
TSŒšg
 *
ts
 = 
s
->
¡r
;

325 
ts
) {

326 ià(
ts
 =ğ
t
)

328 
ts
 =s->
u
.
hÃxt
;

330 
	`rwlock_ruÆock
(&
s
->
lock
);

331  
ts
;

332 
	}
}

334 
TSŒšg
 *

335 
	$Ãw_¡ršg
(
h
, cÚ¡ *
¡r
, 
lu_by‹
 
l
) {

336 
size_t
 
sz
 = 
	`siz–¡ršg
(
l
);

337 
TSŒšg
 *
ts
 = 
	`m®loc
(
sz
);

338 
	`mem£t
(
ts
, 0, 
sz
);

339 
ts
->
‰
 = 
LUA_TSHRSTR
;

340 
ts
->
hash
 = 
h
;

341 
ts
->
sh¾’
 = 
l
;

342 
	`memıy
(
ts
+1, 
¡r
, 
l
);

343  
ts
;

344 
	}
}

346 
TSŒšg
 *

347 
	$add_¡ršg
(
h
, cÚ¡ *
¡r
, 
lu_by‹
 
l
) {

348 
TSŒšg
 * 
tmp
 = 
	`Ãw_¡ršg
(
h
, 
¡r
, 
l
);

349 
shrm­_¦Ù
 *
s
 = &
SSM
.
h
[
	`HASH_NODE
(h)];

350 
	`rwlock_wlock
(&
s
->
lock
);

351 
TSŒšg
 *
ts
 = 
s
->
¡r
;

352 
ts
) {

353 ià(
ts
->
hash
 =ğ
h
 &&

354 
ts
->
sh¾’
 =ğ
l
 &&

355 
	`memcmp
(
¡r
, 
ts
+1, 
l
) == 0) {

358 
ts
 =s->
u
.
hÃxt
;

360 ià(
ts
 =ğ
NULL
) {

361 
ts
 = 
tmp
;

362 
ts
->
u
.
hÃxt
 = 
s
->
¡r
;

363 
s
->
¡r
 = 
ts
;

364 
tmp
 = 
NULL
;

366 
	`rwlock_wuÆock
(&
s
->
lock
);

367 ià(
tmp
) {

369 
	`ä“
(
tmp
);

371  
ts
;

372 
	}
}

374 
TSŒšg
 *

375 
	$š‹ºshr¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
) {

376 
TSŒšg
 *
ts
;

377 
glob®_S‹
 *
g
 = 
	`G
(
L
);

378 
h
 = 
	`luaS_hash
(
¡r
, 
l
, 
g
->
£ed
);

379 
h0
;

381 
ts
 = 
	`qu”yshr¡r
 (
L
, 
¡r
, 
l
, 
h
);

382 ià(
ts
)

383  
ts
;

385 
h0
 = 
	`luaS_hash
(
¡r
, 
l
, 0);

386 
ts
 = 
	`qu”y_¡ršg
(
h0
, 
¡r
, 
l
);

387 ià(
ts
)

388  
ts
;

390 ià(
SSM
.
n
 > 0) {

391 
	`ATOM_DEC
(&
SSM
.
n
);

392  
	`add_¡ršg
(
h0
, 
¡r
, 
l
);

395  
	`addshr¡r
 (
L
, 
¡r
, 
l
, 
h
);

396 
	}
}

398 
LUA_API
 

399 
	$luaS_ex·ndshr
(
n
) {

400 
	`ATOM_ADD
(&
SSM
.
n
,‚);

401 
	}
}

403 
LUAI_FUNC
 
TSŒšg
 *

404 
	$luaS_şÚe¡ršg
(
lua_S‹
 *
L
, 
TSŒšg
 *
ts
) {

405 
h
;

406 
l
;

407 cÚ¡ * 
¡r
 = 
	`g‘addr¡r
(
ts
);

408 
glob®_S‹
 *
g
 = 
	`G
(
L
);

409 
TSŒšg
 *
»suÉ
;

410 ià(
ts
->
‰
 =ğ
LUA_TLNGSTR
)

411  
	`luaS_Ãwl¡r
(
L
, 
¡r
, 
ts
->
u
.
ÊgËn
);

413 
l
 = 
ts
->
sh¾’
;

414 
h
 = 
	`luaS_hash
(
¡r
, 
l
, 
g
->
£ed
);

415 
»suÉ
 = 
	`qu”yshr¡r
 (
L
, 
¡r
, 
l
, 
h
);

416 ià(
»suÉ
)

417  
»suÉ
;

419 
»suÉ
 = 
	`qu”y_±r
(
ts
);

420 ià(
»suÉ
)

421  
»suÉ
;

422 
h
 = 
	`luaS_hash
(
¡r
, 
l
, 0);

423 
»suÉ
 = 
	`qu”y_¡ršg
(
h
, 
¡r
, 
l
);

424 ià(
»suÉ
)

425  
»suÉ
;

427  
	`add_¡ršg
(
h
, 
¡r
, 
l
);

428 
	}
}

430 
	s¦Ùšfo
 {

431 
	mËn
;

432 
	msize
;

436 
	$g‘¦Ù
(
shrm­_¦Ù
 *
s
, 
¦Ùšfo
 *
šfo
) {

437 
	`mem£t
(
šfo
, 0, (*info));

438 
	`rwlock_¾ock
(&
s
->
lock
);

439 
TSŒšg
 *
ts
 = 
s
->
¡r
;

440 
ts
) {

441 ++
šfo
->
Ën
;

442 
šfo
->
size
 +ğ
	`siz–¡ršg
(
ts
->
sh¾’
);

443 
ts
 =s->
u
.
hÃxt
;

445 
	`rwlock_ruÆock
(&
s
->
lock
);

446 
	}
}

448 
LUA_API
 

449 
	$luaS_shršfo
(
lua_S‹
 *
L
) {

450 
¦Ùšfo
 
tÙ®
;

451 
¦Ùšfo
 
tmp
;

452 
	`mem£t
(&
tÙ®
, 0, (total));

453 
i
;

454 
Ën
 = 0;

455 
i
=0;i<
SHRSTR_SLOT
;i++) {

456 
shrm­_¦Ù
 *
s
 = &
SSM
.
h
[
i
];

457 
	`g‘¦Ù
(
s
, &
tmp
);

458 
Ën
 +ğ
tmp
.len;

459 ià(
tmp
.
Ën
 > 
tÙ®
.len) {

460 
tÙ®
.
Ën
 = 
tmp
.len;

462 
tÙ®
.
size
 +ğ
tmp
.size;

464 
	`lua_pushš‹g”
(
L
, 
Ën
);

465 
	`lua_pushš‹g”
(
L
, 
tÙ®
.
size
);

466 
	`lua_pushš‹g”
(
L
, 
tÙ®
.
Ën
);

467 
	`lua_pushš‹g”
(
L
, 
SSM
.
n
);

469 
	}
}

	@3rd/lua/lstring.h

7 #iâdeà
l¡ršg_h


8 
	#l¡ršg_h


	)

10 
	~"lgc.h
"

11 
	~"lobjeù.h
"

12 
	~"l¡©e.h
"

15 
	#siz–¡ršg
(
l
è((
UTSŒšg
è+ (Öè+ 1è* ())

	)

17 
	#siz–ud©a
(
l
è((
UUd©a
è+ (l))

	)

18 
	#sizeud©a
(
u
è
	`siz–ud©a
((u)->
Ën
)

	)

20 
	#luaS_Ãwl™”®
(
L
, 
s
è(
	`luaS_Ãwl¡r
(L, "" s, \

21 ((
s
)/())-1))

	)

27 
	#i¤e£rved
(
s
è((s)->
‰
 =ğ
LUA_TSHRSTR
 && (s)->
exŒa
 > 0)

	)

33 
	#eqshr¡r
(
a
,
b
è
	`check_exp
(×)->
‰
 =ğ
LUA_TSHRSTR
, (aè=ğ(b))

	)

36 
LUAI_FUNC
 
luaS_hash
 (cÚ¡ *
¡r
, 
size_t
 
l
, 
£ed
);

37 
LUAI_FUNC
 
luaS_hashlÚg¡r
 (
TSŒšg
 *
ts
);

38 
LUAI_FUNC
 
luaS_eqÊg¡r
 (
TSŒšg
 *
a
, TSŒšg *
b
);

39 
LUAI_FUNC
 
luaS_»size
 (
lua_S‹
 *
L
, 
Ãwsize
);

40 
LUAI_FUNC
 
luaS_ş—rÿche
 (
glob®_S‹
 *
g
);

41 
LUAI_FUNC
 
luaS_š™
 (
lua_S‹
 *
L
);

42 
LUAI_FUNC
 
luaS_»move
 (
lua_S‹
 *
L
, 
TSŒšg
 *
ts
);

43 
LUAI_FUNC
 
Ud©a
 *
luaS_Ãwud©a
 (
lua_S‹
 *
L
, 
size_t
 
s
);

44 
LUAI_FUNC
 
TSŒšg
 *
luaS_Ãwl¡r
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
, 
size_t
 
l
);

45 
LUAI_FUNC
 
TSŒšg
 *
luaS_Ãw
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
);

46 
LUAI_FUNC
 
TSŒšg
 *
luaS_ü—‹Êg¡robj
 (
lua_S‹
 *
L
, 
size_t
 
l
);

48 
	#ENABLE_SHORT_STRING_TABLE


	)

50 
LUA_API
 
luaS_š™shr
();

51 
LUA_API
 
luaS_ex™shr
();

52 
LUA_API
 
luaS_ex·ndshr
(
n
);

53 
LUAI_FUNC
 
TSŒšg
 *
luaS_şÚe¡ršg
(
lua_S‹
 *
L
, TString *);

54 
LUA_API
 
luaS_shršfo
(
lua_S‹
 *
L
);

	@3rd/lua/lstrlib.c

7 
	#l¡¾ib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<ùy³.h
>

14 
	~<æßt.h
>

15 
	~<lim™s.h
>

16 
	~<loÿË.h
>

17 
	~<¡ddef.h
>

18 
	~<¡dio.h
>

19 
	~<¡dlib.h
>

20 
	~<¡ršg.h
>

22 
	~"lua.h
"

24 
	~"Ïuxlib.h
"

25 
	~"lu®ib.h
"

33 #ià!
defšed
(
LUA_MAXCAPTURES
)

34 
	#LUA_MAXCAPTURES
 32

	)

39 
	#uch¬
(
c
è(()(c))

	)

46 
	#MAX_SIZET
 ((
size_t
)(~(size_t)0))

	)

48 
	#MAXSIZE
 \

49 ((
size_t
è< (è? 
MAX_SIZET
 : (size_t)(
INT_MAX
))

	)

54 
	$¡r_Ën
 (
lua_S‹
 *
L
) {

55 
size_t
 
l
;

56 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

57 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
l
);

59 
	}
}

63 
lua_IÁeg”
 
	$po¤–©
 (
lua_IÁeg”
 
pos
, 
size_t
 
Ën
) {

64 ià(
pos
 >= 0) …os;

65 ià(0u - (
size_t
)
pos
 > 
Ën
)  0;

66  (
lua_IÁeg”
)
Ën
 + 
pos
 + 1;

67 
	}
}

70 
	$¡r_sub
 (
lua_S‹
 *
L
) {

71 
size_t
 
l
;

72 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

73 
lua_IÁeg”
 
¡¬t
 = 
	`po¤–©
(
	`luaL_checkš‹g”
(
L
, 2), 
l
);

74 
lua_IÁeg”
 
’d
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, -1), 
l
);

75 ià(
¡¬t
 < 1) start = 1;

76 ià(
’d
 > (
lua_IÁeg”
)
l
)ƒnd =†;

77 ià(
¡¬t
 <ğ
’d
)

78 
	`lua_pushl¡ršg
(
L
, 
s
 + 
¡¬t
 - 1, (
size_t
)(
’d
 - start) + 1);

79 
	`lua_pushl™”®
(
L
, "");

81 
	}
}

84 
	$¡r_»v”£
 (
lua_S‹
 *
L
) {

85 
size_t
 
l
, 
i
;

86 
luaL_Bufãr
 
b
;

87 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

88 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
l
);

89 
i
 = 0; i < 
l
; i++)

90 
p
[
i
] = 
s
[
l
 - i - 1];

91 
	`luaL_push»suÉsize
(&
b
, 
l
);

93 
	}
}

96 
	$¡r_low”
 (
lua_S‹
 *
L
) {

97 
size_t
 
l
;

98 
size_t
 
i
;

99 
luaL_Bufãr
 
b
;

100 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

101 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
l
);

102 
i
=0; i<
l
; i++)

103 
p
[
i
] = 
	`tŞow”
(
	`uch¬
(
s
[i]));

104 
	`luaL_push»suÉsize
(&
b
, 
l
);

106 
	}
}

109 
	$¡r_uµ”
 (
lua_S‹
 *
L
) {

110 
size_t
 
l
;

111 
size_t
 
i
;

112 
luaL_Bufãr
 
b
;

113 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

114 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
l
);

115 
i
=0; i<
l
; i++)

116 
p
[
i
] = 
	`touµ”
(
	`uch¬
(
s
[i]));

117 
	`luaL_push»suÉsize
(&
b
, 
l
);

119 
	}
}

122 
	$¡r_»p
 (
lua_S‹
 *
L
) {

123 
size_t
 
l
, 
l£p
;

124 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

125 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 2);

126 cÚ¡ *
£p
 = 
	`luaL_İ¡ršg
(
L
, 3, "", &
l£p
);

127 ià(
n
 <ğ0è
	`lua_pushl™”®
(
L
, "");

128 ià(
l
 + 
l£p
 <† ||† +†£°> 
MAXSIZE
 / 
n
)

129  
	`luaL_”rÜ
(
L
, "resulting stringoo†arge");

131 
size_t
 
tÙ®Ën
 = (size_t)
n
 * 
l
 + (size_t)Ò - 1è* 
l£p
;

132 
luaL_Bufãr
 
b
;

133 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
tÙ®Ën
);

134 
n
-- > 1) {

135 
	`memıy
(
p
, 
s
, 
l
 * ());… +=†;

136 ià(
l£p
 > 0) {

137 
	`memıy
(
p
, 
£p
, 
l£p
 * ());

138 
p
 +ğ
l£p
;

141 
	`memıy
(
p
, 
s
, 
l
 * ());

142 
	`luaL_push»suÉsize
(&
b
, 
tÙ®Ën
);

145 
	}
}

148 
	$¡r_by‹
 (
lua_S‹
 *
L
) {

149 
size_t
 
l
;

150 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
l
);

151 
lua_IÁeg”
 
posi
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
l
);

152 
lua_IÁeg”
 
po£
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 
posi
), 
l
);

153 
n
, 
i
;

154 ià(
posi
 < 1)…osi = 1;

155 ià(
po£
 > (
lua_IÁeg”
)
l
)…ose =†;

156 ià(
posi
 > 
po£
)  0;

157 ià(
po£
 - 
posi
 >ğ
INT_MAX
)

158  
	`luaL_”rÜ
(
L
, "string sliceoo†ong");

159 
n
 = ()(
po£
 - 
posi
) + 1;

160 
	`luaL_check¡ack
(
L
, 
n
, "string sliceoo†ong");

161 
i
=0; i<
n
; i++)

162 
	`lua_pushš‹g”
(
L
, 
	`uch¬
(
s
[
posi
+
i
-1]));

163  
n
;

164 
	}
}

167 
	$¡r_ch¬
 (
lua_S‹
 *
L
) {

168 
n
 = 
	`lua_g‘tİ
(
L
);

169 
i
;

170 
luaL_Bufãr
 
b
;

171 *
p
 = 
	`luaL_buffš™size
(
L
, &
b
, 
n
);

172 
i
=1; i<=
n
; i++) {

173 
lua_IÁeg”
 
c
 = 
	`luaL_checkš‹g”
(
L
, 
i
);

174 
	`luaL_¬gcheck
(
L
, 
	`uch¬
(
c
è=ğc, 
i
, "value out of„ange");

175 
p
[
i
 - 1] = 
	`uch¬
(
c
);

177 
	`luaL_push»suÉsize
(&
b
, 
n
);

179 
	}
}

182 
	$wr™”
 (
lua_S‹
 *
L
, cÚ¡ *
b
, 
size_t
 
size
, *
B
) {

183 ()
L
;

184 
	`luaL_addl¡ršg
((
luaL_Bufãr
 *è
B
, (cÚ¡ *)
b
, 
size
);

186 
	}
}

189 
	$¡r_dump
 (
lua_S‹
 *
L
) {

190 
luaL_Bufãr
 
b
;

191 
¡r
 = 
	`lua_toboŞ—n
(
L
, 2);

192 
	`luaL_checkty³
(
L
, 1, 
LUA_TFUNCTION
);

193 
	`lua_£‰İ
(
L
, 1);

194 
	`luaL_buffš™
(
L
,&
b
);

195 ià(
	`lua_dump
(
L
, 
wr™”
, &
b
, 
¡r
) != 0)

196  
	`luaL_”rÜ
(
L
, "unableo dump given function");

197 
	`luaL_push»suÉ
(&
b
);

199 
	}
}

210 
	#CAP_UNFINISHED
 (-1)

	)

211 
	#CAP_POSITION
 (-2)

	)

214 
	sM©chS‹
 {

215 cÚ¡ *
	m¤c_š™
;

216 cÚ¡ *
	m¤c_’d
;

217 cÚ¡ *
	mp_’d
;

218 
lua_S‹
 *
	mL
;

219 
	mm©chd•th
;

220 
	mËv–
;

222 cÚ¡ *
	mš™
;

223 
±rdiff_t
 
	mËn
;

224 } 
	mÿ±u»
[
LUA_MAXCAPTURES
];

225 } 
	tM©chS‹
;

229 cÚ¡ *
m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
);

233 #ià!
defšed
(
MAXCCALLS
)

234 
	#MAXCCALLS
 200

	)

238 
	#L_ESC
 '%'

	)

239 
	#SPECIALS
 "^$*+?.([%-"

	)

242 
	$check_ÿ±u»
 (
M©chS‹
 *
ms
, 
l
) {

243 
l
 -= '1';

244 ià(
l
 < 0 ||† >ğ
ms
->
Ëv–
 || ms->
ÿ±u»
[l].
Ën
 =ğ
CAP_UNFINISHED
)

245  
	`luaL_”rÜ
(
ms
->
L
, "šv®id c­tu» index %%%d", 
l
 + 1);

246  
l
;

247 
	}
}

250 
	$ÿ±u»_to_şo£
 (
M©chS‹
 *
ms
) {

251 
Ëv–
 = 
ms
->level;

252 
Ëv–
--;†evel>=0;†evel--)

253 ià(
ms
->
ÿ±u»
[
Ëv–
].
Ën
 =ğ
CAP_UNFINISHED
) †evel;

254  
	`luaL_”rÜ
(
ms
->
L
, "invalid…attern capture");

255 
	}
}

258 cÚ¡ *
	$şas£nd
 (
M©chS‹
 *
ms
, cÚ¡ *
p
) {

259 *
p
++) {

260 
L_ESC
: {

261 ià(
p
 =ğ
ms
->
p_’d
)

262 
	`luaL_”rÜ
(
ms
->
L
, "malformed…attern (ends with '%%')");

263  
p
+1;

266 ià(*
p
 == '^')…++;

268 ià(
p
 =ğ
ms
->
p_’d
)

269 
	`luaL_”rÜ
(
ms
->
L
, "malformed…attern (missing ']')");

270 ià(*(
p
++è=ğ
L_ESC
 &&… < 
ms
->
p_’d
)

271 
p
++;

272 } *
p
 != ']');

273  
p
+1;

276  
p
;

279 
	}
}

282 
	$m©ch_şass
 (
c
, 
ş
) {

283 
»s
;

284 
	`tŞow”
(
ş
)) {

285 'a' : 
»s
 = 
	`i§Íha
(
c
); ;

286 'c' : 
»s
 = 
	`isúŒl
(
c
); ;

287 'd' : 
»s
 = 
	`isdig™
(
c
); ;

288 'g' : 
»s
 = 
	`isg¿ph
(
c
); ;

289 'l' : 
»s
 = 
	`i¦ow”
(
c
); ;

290 'p' : 
»s
 = 
	`i¥unù
(
c
); ;

291 's' : 
»s
 = 
	`is¥aû
(
c
); ;

292 'u' : 
»s
 = 
	`isuµ”
(
c
); ;

293 'w' : 
»s
 = 
	`i§Êum
(
c
); ;

294 'x' : 
»s
 = 
	`isxdig™
(
c
); ;

295 'z' : 
»s
 = (
c
 == 0); ;

296 :  (
ş
 =ğ
c
);

298  (
	`i¦ow”
(
ş
è? 
»s
 : !res);

299 
	}
}

302 
	$m©chb¿ck‘şass
 (
c
, cÚ¡ *
p
, cÚ¡ *
ec
) {

303 
sig
 = 1;

304 ià(*(
p
+1) == '^') {

305 
sig
 = 0;

306 
p
++;

308 ++
p
 < 
ec
) {

309 ià(*
p
 =ğ
L_ESC
) {

310 
p
++;

311 ià(
	`m©ch_şass
(
c
, 
	`uch¬
(*
p
)))

312  
sig
;

314 ià((*(
p
+1è=ğ'-'è&& (p+2 < 
ec
)) {

315 
p
+=2;

316 ià(
	`uch¬
(*(
p
-2)è<ğ
c
 && c <= uchar(*p))

317  
sig
;

319 ià(
	`uch¬
(*
p
è=ğ
c
è 
sig
;

321  !
sig
;

322 
	}
}

325 
	$sšgËm©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
,

326 cÚ¡ *
•
) {

327 ià(
s
 >ğ
ms
->
¤c_’d
)

330 
c
 = 
	`uch¬
(*
s
);

331 *
p
) {

333 
L_ESC
:  
	`m©ch_şass
(
c
, 
	`uch¬
(*(
p
+1)));

334 '[':  
	`m©chb¿ck‘şass
(
c
, 
p
, 
•
-1);

335 :  (
	`uch¬
(*
p
è=ğ
c
);

338 
	}
}

341 cÚ¡ *
	$m©chb®ªû
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

342 cÚ¡ *
p
) {

343 ià(
p
 >ğ
ms
->
p_’d
 - 1)

344 
	`luaL_”rÜ
(
ms
->
L
, "malformed…attern (missing‡rgumentso '%%b')");

345 ià(*
s
 !ğ*
p
è 
NULL
;

347 
b
 = *
p
;

348 
e
 = *(
p
+1);

349 
cÚt
 = 1;

350 ++
s
 < 
ms
->
¤c_’d
) {

351 ià(*
s
 =ğ
e
) {

352 ià(--
cÚt
 =ğ0è 
s
+1;

354 ià(*
s
 =ğ
b
è
cÚt
++;

357  
NULL
;

358 
	}
}

361 cÚ¡ *
	$max_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

362 cÚ¡ *
p
, cÚ¡ *
•
) {

363 
±rdiff_t
 
i
 = 0;

364 
	`sšgËm©ch
(
ms
, 
s
 + 
i
, 
p
, 
•
))

365 
i
++;

367 
i
>=0) {

368 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, (
s
+
i
), 
•
+1);

369 ià(
»s
) „es;

370 
i
--;

372  
NULL
;

373 
	}
}

376 cÚ¡ *
	$mš_ex·nd
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

377 cÚ¡ *
p
, cÚ¡ *
•
) {

379 cÚ¡ *
»s
 = 
	`m©ch
(
ms
, 
s
, 
•
+1);

380 ià(
»s
 !ğ
NULL
)

381  
»s
;

382 ià(
	`sšgËm©ch
(
ms
, 
s
, 
p
, 
•
))

383 
s
++;

384  
NULL
;

386 
	}
}

389 cÚ¡ *
	$¡¬t_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

390 cÚ¡ *
p
, 
wh©
) {

391 cÚ¡ *
»s
;

392 
Ëv–
 = 
ms
->level;

393 ià(
Ëv–
 >ğ
LUA_MAXCAPTURES
è
	`luaL_”rÜ
(
ms
->
L
, "too many captures");

394 
ms
->
ÿ±u»
[
Ëv–
].
š™
 = 
s
;

395 
ms
->
ÿ±u»
[
Ëv–
].
Ën
 = 
wh©
;

396 
ms
->
Ëv–
 =†evel+1;

397 ià((
»s
=
	`m©ch
(
ms
, 
s
, 
p
)è=ğ
NULL
)

398 
ms
->
Ëv–
--;

399  
»s
;

400 
	}
}

403 cÚ¡ *
	$’d_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
,

404 cÚ¡ *
p
) {

405 
l
 = 
	`ÿ±u»_to_şo£
(
ms
);

406 cÚ¡ *
»s
;

407 
ms
->
ÿ±u»
[
l
].
Ën
 = 
s
 - ms->ÿ±u»[l].
š™
;

408 ià((
»s
 = 
	`m©ch
(
ms
, 
s
, 
p
)è=ğ
NULL
)

409 
ms
->
ÿ±u»
[
l
].
Ën
 = 
CAP_UNFINISHED
;

410  
»s
;

411 
	}
}

414 cÚ¡ *
	$m©ch_ÿ±u»
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, 
l
) {

415 
size_t
 
Ën
;

416 
l
 = 
	`check_ÿ±u»
(
ms
,†);

417 
Ën
 = 
ms
->
ÿ±u»
[
l
].len;

418 ià((
size_t
)(
ms
->
¤c_’d
-
s
è>ğ
Ën
 &&

419 
	`memcmp
(
ms
->
ÿ±u»
[
l
].
š™
, 
s
, 
Ën
) == 0)

420  
s
+
Ën
;

421  
NULL
;

422 
	}
}

425 cÚ¡ *
	$m©ch
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
p
) {

426 ià(
ms
->
m©chd•th
-- == 0)

427 
	`luaL_”rÜ
(
ms
->
L
, "patternoo complex");

428 
š™
:

429 ià(
p
 !ğ
ms
->
p_’d
) {

430 *
p
) {

432 ià(*(
p
 + 1) == ')')

433 
s
 = 
	`¡¬t_ÿ±u»
(
ms
, s, 
p
 + 2, 
CAP_POSITION
);

435 
s
 = 
	`¡¬t_ÿ±u»
(
ms
, s, 
p
 + 1, 
CAP_UNFINISHED
);

439 
s
 = 
	`’d_ÿ±u»
(
ms
, s, 
p
 + 1);

443 ià((
p
 + 1è!ğ
ms
->
p_’d
)

444 
dæt
;

445 
s
 = ( =ğ
ms
->
¤c_’d
è? s : 
NULL
;

448 
L_ESC
: {

449 *(
p
 + 1)) {

451 
s
 = 
	`m©chb®ªû
(
ms
, s, 
p
 + 2);

452 ià(
s
 !ğ
NULL
) {

453 
p
 +ğ4; 
š™
;

458 cÚ¡ *
•
; 
´evious
;

459 
p
 += 2;

460 ià(*
p
 != '[')

461 
	`luaL_”rÜ
(
ms
->
L
, "missing '['‡fter '%%f' in…attern");

462 
•
 = 
	`şas£nd
(
ms
, 
p
);

463 
´evious
 = (
s
 =ğ
ms
->
¤c_š™
) ? '\0' : *(s - 1);

464 ià(!
	`m©chb¿ck‘şass
(
	`uch¬
(
´evious
), 
p
, 
•
 - 1) &&

465 
	`m©chb¿ck‘şass
(
	`uch¬
(*
s
), 
p
, 
•
 - 1)) {

466 
p
 = 
•
; 
š™
;

468 
s
 = 
NULL
;

474 
s
 = 
	`m©ch_ÿ±u»
(
ms
, s, 
	`uch¬
(*(
p
 + 1)));

475 ià(
s
 !ğ
NULL
) {

476 
p
 +ğ2; 
š™
;

480 : 
dæt
;

484 : 
dæt
: {

485 cÚ¡ *
•
 = 
	`şas£nd
(
ms
, 
p
);

487 ià(!
	`sšgËm©ch
(
ms
, 
s
, 
p
, 
•
)) {

488 ià(*
•
 == '*' || *ep == '?' || *ep == '-') {

489 
p
 = 
•
 + 1; 
š™
;

492 
s
 = 
NULL
;

495 *
•
) {

497 cÚ¡ *
»s
;

498 ià((
»s
 = 
	`m©ch
(
ms
, 
s
 + 1, 
•
 + 1)è!ğ
NULL
)

499 
s
 = 
»s
;

501 
p
 = 
•
 + 1; 
š™
;

506 
s
++;

509 
s
 = 
	`max_ex·nd
(
ms
, s, 
p
, 
•
);

512 
s
 = 
	`mš_ex·nd
(
ms
, s, 
p
, 
•
);

515 
s
++; 
p
 = 
•
; 
š™
;

522 
ms
->
m©chd•th
++;

523  
s
;

524 
	}
}

528 cÚ¡ *
	$lmemfšd
 (cÚ¡ *
s1
, 
size_t
 
l1
,

529 cÚ¡ *
s2
, 
size_t
 
l2
) {

530 ià(
l2
 =ğ0è 
s1
;

531 ià(
l2
 > 
l1
è 
NULL
;

533 cÚ¡ *
š™
;

534 
l2
--;

535 
l1
 =†1-
l2
;

536 
l1
 > 0 && (
š™
 = (cÚ¡ *)
	`memchr
(
s1
, *
s2
,†1)è!ğ
NULL
) {

537 
š™
++;

538 ià(
	`memcmp
(
š™
, 
s2
+1, 
l2
) == 0)

539  
š™
-1;

541 
l1
 -ğ
š™
-
s1
;

542 
s1
 = 
š™
;

545  
NULL
;

547 
	}
}

550 
	$push_Úeÿ±u»
 (
M©chS‹
 *
ms
, 
i
, cÚ¡ *
s
,

551 cÚ¡ *
e
) {

552 ià(
i
 >ğ
ms
->
Ëv–
) {

553 ià(
i
 == 0)

554 
	`lua_pushl¡ršg
(
ms
->
L
, 
s
, 
e
 - s);

556 
	`luaL_”rÜ
(
ms
->
L
, "šv®id c­tu» index %%%d", 
i
 + 1);

559 
±rdiff_t
 
l
 = 
ms
->
ÿ±u»
[
i
].
Ën
;

560 ià(
l
 =ğ
CAP_UNFINISHED
è
	`luaL_”rÜ
(
ms
->
L
, "unfinished capture");

561 ià(
l
 =ğ
CAP_POSITION
)

562 
	`lua_pushš‹g”
(
ms
->
L
, (ms->
ÿ±u»
[
i
].
š™
 - ms->
¤c_š™
) + 1);

564 
	`lua_pushl¡ršg
(
ms
->
L
, ms->
ÿ±u»
[
i
].
š™
, 
l
);

566 
	}
}

569 
	$push_ÿ±u»s
 (
M©chS‹
 *
ms
, cÚ¡ *
s
, cÚ¡ *
e
) {

570 
i
;

571 
Æev–s
 = (
ms
->
Ëv–
 =ğ0 && 
s
) ? 1 : ms->level;

572 
	`luaL_check¡ack
(
ms
->
L
, 
Æev–s
, "too many captures");

573 
i
 = 0; i < 
Æev–s
; i++)

574 
	`push_Úeÿ±u»
(
ms
, 
i
, 
s
, 
e
);

575  
Æev–s
;

576 
	}
}

580 
	$no¥ecŸls
 (cÚ¡ *
p
, 
size_t
 
l
) {

581 
size_t
 
u±o
 = 0;

583 ià(
	`¡½brk
(
p
 + 
u±o
, 
SPECIALS
))

585 
u±o
 +ğ
	`¡¾’
(
p
 + upto) + 1;

586 } 
u±o
 <ğ
l
);

588 
	}
}

591 
	$´•¡©e
 (
M©chS‹
 *
ms
, 
lua_S‹
 *
L
,

592 cÚ¡ *
s
, 
size_t
 
ls
, cÚ¡ *
p
, size_ˆ
Í
) {

593 
ms
->
L
 = L;

594 
ms
->
m©chd•th
 = 
MAXCCALLS
;

595 
ms
->
¤c_š™
 = 
s
;

596 
ms
->
¤c_’d
 = 
s
 + 
ls
;

597 
ms
->
p_’d
 = 
p
 + 
Í
;

598 
	}
}

601 
	$»´•¡©e
 (
M©chS‹
 *
ms
) {

602 
ms
->
Ëv–
 = 0;

603 
	`lua_as£¹
(
ms
->
m©chd•th
 =ğ
MAXCCALLS
);

604 
	}
}

607 
	$¡r_fšd_aux
 (
lua_S‹
 *
L
, 
fšd
) {

608 
size_t
 
ls
, 
Í
;

609 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
ls
);

610 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Í
);

611 
lua_IÁeg”
 
š™
 = 
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 1), 
ls
);

612 ià(
š™
 < 1) init = 1;

613 ià(
š™
 > (
lua_IÁeg”
)
ls
 + 1) {

614 
	`lua_pushn
(
L
);

618 ià(
fšd
 && (
	`lua_toboŞ—n
(
L
, 4è|| 
	`no¥ecŸls
(
p
, 
Í
))) {

620 cÚ¡ *
s2
 = 
	`lmemfšd
(
s
 + 
š™
 - 1, 
ls
 - (
size_t
)š™ + 1, 
p
, 
Í
);

621 ià(
s2
) {

622 
	`lua_pushš‹g”
(
L
, (
s2
 - 
s
) + 1);

623 
	`lua_pushš‹g”
(
L
, (
s2
 - 
s
è+ 
Í
);

628 
M©chS‹
 
ms
;

629 cÚ¡ *
s1
 = 
s
 + 
š™
 - 1;

630 
ªchÜ
 = (*
p
 == '^');

631 ià(
ªchÜ
) {

632 
p
++; 
Í
--;

634 
	`´•¡©e
(&
ms
, 
L
, 
s
, 
ls
, 
p
, 
Í
);

636 cÚ¡ *
»s
;

637 
	`»´•¡©e
(&
ms
);

638 ià((
»s
=
	`m©ch
(&
ms
, 
s1
, 
p
)è!ğ
NULL
) {

639 ià(
fšd
) {

640 
	`lua_pushš‹g”
(
L
, (
s1
 - 
s
) + 1);

641 
	`lua_pushš‹g”
(
L
, 
»s
 - 
s
);

642  
	`push_ÿ±u»s
(&
ms
, 
NULL
, 0) + 2;

645  
	`push_ÿ±u»s
(&
ms
, 
s1
, 
»s
);

647 } 
s1
++ < 
ms
.
¤c_’d
 && !
ªchÜ
);

649 
	`lua_pushn
(
L
);

651 
	}
}

654 
	$¡r_fšd
 (
lua_S‹
 *
L
) {

655  
	`¡r_fšd_aux
(
L
, 1);

656 
	}
}

659 
	$¡r_m©ch
 (
lua_S‹
 *
L
) {

660  
	`¡r_fšd_aux
(
L
, 0);

661 
	}
}

665 
	sGM©chS‹
 {

666 cÚ¡ *
	m¤c
;

667 cÚ¡ *
	mp
;

668 cÚ¡ *
	mÏ¡m©ch
;

669 
M©chS‹
 
	mms
;

670 } 
	tGM©chS‹
;

673 
	$gm©ch_aux
 (
lua_S‹
 *
L
) {

674 
GM©chS‹
 *
gm
 = (GM©chS‹ *)
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(3));

675 cÚ¡ *
¤c
;

676 
gm
->
ms
.
L
 = L;

677 
¤c
 = 
gm
->¤c; srø<ğgm->
ms
.
¤c_’d
; src++) {

678 cÚ¡ *
e
;

679 
	`»´•¡©e
(&
gm
->
ms
);

680 ià((
e
 = 
	`m©ch
(&
gm
->
ms
, 
¤c
, gm->
p
)è!ğ
NULL
 &&ƒ !ğgm->
Ï¡m©ch
) {

681 
gm
->
¤c
 = gm->
Ï¡m©ch
 = 
e
;

682  
	`push_ÿ±u»s
(&
gm
->
ms
, 
¤c
, 
e
);

686 
	}
}

689 
	$gm©ch
 (
lua_S‹
 *
L
) {

690 
size_t
 
ls
, 
Í
;

691 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
ls
);

692 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Í
);

693 
GM©chS‹
 *
gm
;

694 
	`lua_£‰İ
(
L
, 2);

695 
gm
 = (
GM©chS‹
 *)
	`lua_Ãwu£rd©a
(
L
, (GMatchState));

696 
	`´•¡©e
(&
gm
->
ms
, 
L
, 
s
, 
ls
, 
p
, 
Í
);

697 
gm
->
¤c
 = 
s
; gm->
p
 =…; gm->
Ï¡m©ch
 = 
NULL
;

698 
	`lua_pushcşosu»
(
L
, 
gm©ch_aux
, 3);

700 
	}
}

703 
	$add_s
 (
M©chS‹
 *
ms
, 
luaL_Bufãr
 *
b
, cÚ¡ *
s
,

704 cÚ¡ *
e
) {

705 
size_t
 
l
, 
i
;

706 
lua_S‹
 *
L
 = 
ms
->L;

707 cÚ¡ *
Ãws
 = 
	`lua_tŞ¡ršg
(
L
, 3, &
l
);

708 
i
 = 0; i < 
l
; i++) {

709 ià(
Ãws
[
i
] !ğ
L_ESC
)

710 
	`luaL_addch¬
(
b
, 
Ãws
[
i
]);

712 
i
++;

713 ià(!
	`isdig™
(
	`uch¬
(
Ãws
[
i
]))) {

714 ià(
Ãws
[
i
] !ğ
L_ESC
)

715 
	`luaL_”rÜ
(
L
, "šv®id u£ oà'%c' iÀ»¶aûm’ˆ¡ršg", 
L_ESC
);

716 
	`luaL_addch¬
(
b
, 
Ãws
[
i
]);

718 ià(
Ãws
[
i
] == '0')

719 
	`luaL_addl¡ršg
(
b
, 
s
, 
e
 - s);

721 
	`push_Úeÿ±u»
(
ms
, 
Ãws
[
i
] - '1', 
s
, 
e
);

722 
	`luaL_tŞ¡ršg
(
L
, -1, 
NULL
);

723 
	`lua_»move
(
L
, -2);

724 
	`luaL_addv®ue
(
b
);

728 
	}
}

731 
	$add_v®ue
 (
M©chS‹
 *
ms
, 
luaL_Bufãr
 *
b
, cÚ¡ *
s
,

732 cÚ¡ *
e
, 
Œ
) {

733 
lua_S‹
 *
L
 = 
ms
->L;

734 
Œ
) {

735 
LUA_TFUNCTION
: {

736 
n
;

737 
	`lua_pushv®ue
(
L
, 3);

738 
n
 = 
	`push_ÿ±u»s
(
ms
, 
s
, 
e
);

739 
	`lua_ÿÎ
(
L
, 
n
, 1);

742 
LUA_TTABLE
: {

743 
	`push_Úeÿ±u»
(
ms
, 0, 
s
, 
e
);

744 
	`lua_g‘bË
(
L
, 3);

748 
	`add_s
(
ms
, 
b
, 
s
, 
e
);

752 ià(!
	`lua_toboŞ—n
(
L
, -1)) {

753 
	`lua_pİ
(
L
, 1);

754 
	`lua_pushl¡ršg
(
L
, 
s
, 
e
 - s);

756 ià(!
	`lua_is¡ršg
(
L
, -1))

757 
	`luaL_”rÜ
(
L
, "šv®id„•Ïûm’ˆv®u× %s)", 
	`luaL_ty³Çme
(L, -1));

758 
	`luaL_addv®ue
(
b
);

759 
	}
}

762 
	$¡r_gsub
 (
lua_S‹
 *
L
) {

763 
size_t
 
¤ş
, 
Í
;

764 cÚ¡ *
¤c
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
¤ş
);

765 cÚ¡ *
p
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
Í
);

766 cÚ¡ *
Ï¡m©ch
 = 
NULL
;

767 
Œ
 = 
	`lua_ty³
(
L
, 3);

768 
lua_IÁeg”
 
max_s
 = 
	`luaL_İtš‹g”
(
L
, 4, 
¤ş
 + 1);

769 
ªchÜ
 = (*
p
 == '^');

770 
lua_IÁeg”
 
n
 = 0;

771 
M©chS‹
 
ms
;

772 
luaL_Bufãr
 
b
;

773 
	`luaL_¬gcheck
(
L
, 
Œ
 =ğ
LUA_TNUMBER
 ||¸=ğ
LUA_TSTRING
 ||

774 
Œ
 =ğ
LUA_TFUNCTION
 ||¸=ğ
LUA_TTABLE
, 3,

776 
	`luaL_buffš™
(
L
, &
b
);

777 ià(
ªchÜ
) {

778 
p
++; 
Í
--;

780 
	`´•¡©e
(&
ms
, 
L
, 
¤c
, 
¤ş
, 
p
, 
Í
);

781 
n
 < 
max_s
) {

782 cÚ¡ *
e
;

783 
	`»´•¡©e
(&
ms
);

784 ià((
e
 = 
	`m©ch
(&
ms
, 
¤c
, 
p
)è!ğ
NULL
 &&ƒ !ğ
Ï¡m©ch
) {

785 
n
++;

786 
	`add_v®ue
(&
ms
, &
b
, 
¤c
, 
e
, 
Œ
);

787 
¤c
 = 
Ï¡m©ch
 = 
e
;

789 ià(
¤c
 < 
ms
.
¤c_’d
)

790 
	`luaL_addch¬
(&
b
, *
¤c
++);

792 ià(
ªchÜ
) ;

794 
	`luaL_addl¡ršg
(&
b
, 
¤c
, 
ms
.
¤c_’d
-src);

795 
	`luaL_push»suÉ
(&
b
);

796 
	`lua_pushš‹g”
(
L
, 
n
);

798 
	}
}

810 #ià!
defšed
(
lua_numb”2¡rx
)

816 
	~<m©h.h
>

818 
	#SIZELENMOD
 ((
LUA_NUMBER_FRMLEN
)/())

	)

827 
	#L_NBFD
 ((
	`l_m©hlim
(
MANT_DIG
è- 1)%4 + 1)

	)

833 
lua_Numb”
 
	$adddig™
 (*
buff
, 
n
, 
lua_Numb”
 
x
) {

834 
lua_Numb”
 
dd
 = 
	`l_m©hİ
(
æoÜ
)(
x
);

835 
d
 = ()
dd
;

836 
buff
[
n
] = (
d
 < 10 ? d + '0' : d - 10 + 'a');

837  
x
 - 
dd
;

838 
	}
}

841 
	$num2¡¿ux
 (*
buff
, 
sz
, 
lua_Numb”
 
x
) {

843 ià(
x
 !ğx || x =ğ(
lua_Numb”
)
HUGE_VAL
 || x == -(lua_Number)HUGE_VAL)

844  
	`l_¥rštf
(
buff
, 
sz
, 
LUA_NUMBER_FMT
, (
LUAI_UACNUMBER
)
x
);

845 ià(
x
 == 0) {

847  
	`l_¥rštf
(
buff
, 
sz
, 
LUA_NUMBER_FMT
 "x0p+0", (
LUAI_UACNUMBER
)
x
);

850 
e
;

851 
lua_Numb”
 
m
 = 
	`l_m©hİ
(
äexp
)(
x
, &
e
);

852 
n
 = 0;

853 ià(
m
 < 0) {

854 
buff
[
n
++] = '-';

855 
m
 = -m;

857 
buff
[
n
++] = '0'; buff[n++] = 'x';

858 
m
 = 
	`adddig™
(
buff
, 
n
++, m * (1 << 
L_NBFD
));

859 
e
 -ğ
L_NBFD
;

860 ià(
m
 > 0) {

861 
buff
[
n
++] = 
	`lua_g‘loÿËdeıošt
();

863 
m
 = 
	`adddig™
(
buff
, 
n
++, m * 16);

864 } 
m
 > 0);

866 
n
 +ğ
	`l_¥rštf
(
buff
 +‚, 
sz
 -‚, "p%+d", 
e
);

867 
	`lua_as£¹
(
n
 < 
sz
);

868  
n
;

870 
	}
}

873 
	$lua_numb”2¡rx
 (
lua_S‹
 *
L
, *
buff
, 
sz
,

874 cÚ¡ *
fmt
, 
lua_Numb”
 
x
) {

875 
n
 = 
	`num2¡¿ux
(
buff
, 
sz
, 
x
);

876 ià(
fmt
[
SIZELENMOD
] == 'A') {

877 
i
;

878 
i
 = 0; i < 
n
; i++)

879 
buff
[
i
] = 
	`touµ”
(
	`uch¬
(buff[i]));

881 ià(
fmt
[
SIZELENMOD
] != 'a')

882 
	`luaL_”rÜ
(
L
, "modifiers for format '%%a'/'%%A'‚ot implemented");

883  
n
;

884 
	}
}

896 
	#MAX_ITEM
 (120 + 
	`l_m©hlim
(
MAX_10_EXP
))

	)

900 
	#FLAGS
 "-+ #0"

	)

905 
	#MAX_FORMAT
 32

	)

908 
	$addquÙed
 (
luaL_Bufãr
 *
b
, cÚ¡ *
s
, 
size_t
 
Ën
) {

909 
	`luaL_addch¬
(
b
, '"');

910 
Ën
--) {

911 ià(*
s
 == '"' || *s == '\\' || *s == '\n') {

912 
	`luaL_addch¬
(
b
, '\\');

913 
	`luaL_addch¬
(
b
, *
s
);

915 ià(
	`isúŒl
(
	`uch¬
(*
s
))) {

916 
buff
[10];

917 ià(!
	`isdig™
(
	`uch¬
(*(
s
+1))))

918 
	`l_¥rštf
(
buff
, (buff), "\\%d", ()
	`uch¬
(*
s
));

920 
	`l_¥rštf
(
buff
, (buff), "\\%03d", ()
	`uch¬
(*
s
));

921 
	`luaL_add¡ršg
(
b
, 
buff
);

924 
	`luaL_addch¬
(
b
, *
s
);

925 
s
++;

927 
	`luaL_addch¬
(
b
, '"');

928 
	}
}

934 
	$checkdp
 (*
buff
, 
nb
) {

935 ià(
	`memchr
(
buff
, '.', 
nb
è=ğ
NULL
) {

936 
pošt
 = 
	`lua_g‘loÿËdeıošt
();

937 *
µošt
 = (*)
	`memchr
(
buff
, 
pošt
, 
nb
);

938 ià(
µošt
) *ppoint = '.';

940 
	}
}

943 
	$addl™”®
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
¬g
) {

944 
	`lua_ty³
(
L
, 
¬g
)) {

945 
LUA_TSTRING
: {

946 
size_t
 
Ën
;

947 cÚ¡ *
s
 = 
	`lua_tŞ¡ršg
(
L
, 
¬g
, &
Ën
);

948 
	`addquÙed
(
b
, 
s
, 
Ën
);

951 
LUA_TNUMBER
: {

952 *
buff
 = 
	`luaL_´•buffsize
(
b
, 
MAX_ITEM
);

953 
nb
;

954 ià(!
	`lua_isš‹g”
(
L
, 
¬g
)) {

955 
lua_Numb”
 
n
 = 
	`lua_tÚumb”
(
L
, 
¬g
);

956 
nb
 = 
	`lua_numb”2¡rx
(
L
, 
buff
, 
MAX_ITEM
, "%" 
LUA_NUMBER_FRMLEN
 "a", 
n
);

957 
	`checkdp
(
buff
, 
nb
);

960 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”
(
L
, 
¬g
);

961 cÚ¡ *
fÜm©
 = (
n
 =ğ
LUA_MININTEGER
)

962 ? "0x%" 
LUA_INTEGER_FRMLEN
 "x"

963 : 
LUA_INTEGER_FMT
;

964 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm©
, (
LUAI_UACINT
)
n
);

966 
	`luaL_addsize
(
b
, 
nb
);

969 
LUA_TNIL
: 
LUA_TBOOLEAN
: {

970 
	`luaL_tŞ¡ršg
(
L
, 
¬g
, 
NULL
);

971 
	`luaL_addv®ue
(
b
);

975 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "value has‚o†iteral form");

978 
	}
}

981 cÚ¡ *
	$sÿnfÜm©
 (
lua_S‹
 *
L
, cÚ¡ *
¡rämt
, *
fÜm
) {

982 cÚ¡ *
p
 = 
¡rämt
;

983 *
p
 !ğ'\0' && 
	`¡rchr
(
FLAGS
, *pè!ğ
NULL
)…++;

984 ià((
size_t
)(
p
 - 
¡rämt
è>ğ(
FLAGS
)/())

985 
	`luaL_”rÜ
(
L
, "invalid format (repeated flags)");

986 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

987 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

988 ià(*
p
 == '.') {

989 
p
++;

990 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

991 ià(
	`isdig™
(
	`uch¬
(*
p
)))…++;

993 ià(
	`isdig™
(
	`uch¬
(*
p
)))

994 
	`luaL_”rÜ
(
L
, "invalid format (width or…recisionoo†ong)");

995 *(
fÜm
++) = '%';

996 
	`memıy
(
fÜm
, 
¡rämt
, ((
p
 - strfrmt) + 1) * ());

997 
fÜm
 +ğ(
p
 - 
¡rämt
) + 1;

998 *
fÜm
 = '\0';

999  
p
;

1000 
	}
}

1006 
	$addËnmod
 (*
fÜm
, cÚ¡ *
Ënmod
) {

1007 
size_t
 
l
 = 
	`¡¾’
(
fÜm
);

1008 
size_t
 
lm
 = 
	`¡¾’
(
Ënmod
);

1009 
¥ec
 = 
fÜm
[
l
 - 1];

1010 
	`¡rıy
(
fÜm
 + 
l
 - 1, 
Ënmod
);

1011 
fÜm
[
l
 + 
lm
 - 1] = 
¥ec
;

1012 
fÜm
[
l
 + 
lm
] = '\0';

1013 
	}
}

1016 
	$¡r_fÜm©
 (
lua_S‹
 *
L
) {

1017 
tİ
 = 
	`lua_g‘tİ
(
L
);

1018 
¬g
 = 1;

1019 
size_t
 
sæ
;

1020 cÚ¡ *
¡rämt
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
sæ
);

1021 cÚ¡ *
¡rämt_’d
 = 
¡rämt
+
sæ
;

1022 
luaL_Bufãr
 
b
;

1023 
	`luaL_buffš™
(
L
, &
b
);

1024 
¡rämt
 < 
¡rämt_’d
) {

1025 ià(*
¡rämt
 !ğ
L_ESC
)

1026 
	`luaL_addch¬
(&
b
, *
¡rämt
++);

1027 ià(*++
¡rämt
 =ğ
L_ESC
)

1028 
	`luaL_addch¬
(&
b
, *
¡rämt
++);

1030 
fÜm
[
MAX_FORMAT
];

1031 *
buff
 = 
	`luaL_´•buffsize
(&
b
, 
MAX_ITEM
);

1032 
nb
 = 0;

1033 ià(++
¬g
 > 
tİ
)

1034 
	`luaL_¬g”rÜ
(
L
, 
¬g
, "no value");

1035 
¡rämt
 = 
	`sÿnfÜm©
(
L
, sŒämt, 
fÜm
);

1036 *
¡rämt
++) {

1038 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, ()
	`luaL_checkš‹g”
(
L
, 
¬g
));

1043 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

1044 
	`addËnmod
(
fÜm
, 
LUA_INTEGER_FRMLEN
);

1045 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, (
LUAI_UACINT
)
n
);

1049 
	`addËnmod
(
fÜm
, 
LUA_NUMBER_FRMLEN
);

1050 
nb
 = 
	`lua_numb”2¡rx
(
L
, 
buff
, 
MAX_ITEM
, 
fÜm
,

1051 
	`luaL_checknumb”
(
L
, 
¬g
));

1055 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 
¬g
);

1056 
	`addËnmod
(
fÜm
, 
LUA_NUMBER_FRMLEN
);

1057 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, (
LUAI_UACNUMBER
)
n
);

1061 
	`addl™”®
(
L
, &
b
, 
¬g
);

1065 
size_t
 
l
;

1066 cÚ¡ *
s
 = 
	`luaL_tŞ¡ršg
(
L
, 
¬g
, &
l
);

1067 ià(
fÜm
[2] == '\0')

1068 
	`luaL_addv®ue
(&
b
);

1070 
	`luaL_¬gcheck
(
L
, 
l
 =ğ
	`¡¾’
(
s
), 
¬g
, "string contains zeros");

1071 ià(!
	`¡rchr
(
fÜm
, '.'è&& 
l
 >= 100) {

1073 
	`luaL_addv®ue
(&
b
);

1076 
nb
 = 
	`l_¥rštf
(
buff
, 
MAX_ITEM
, 
fÜm
, 
s
);

1077 
	`lua_pİ
(
L
, 1);

1083  
	`luaL_”rÜ
(
L
, "invalid option '%%%c'o 'format'",

1084 *(
¡rämt
 - 1));

1087 
	`lua_as£¹
(
nb
 < 
MAX_ITEM
);

1088 
	`luaL_addsize
(&
b
, 
nb
);

1091 
	`luaL_push»suÉ
(&
b
);

1093 
	}
}

1106 #ià!
defšed
(
LUAL_PACKPADBYTE
)

1107 
	#LUAL_PACKPADBYTE
 0x00

	)

1111 
	#MAXINTSIZE
 16

	)

1114 
	#NB
 
CHAR_BIT


	)

1117 
	#MC
 ((1 << 
NB
è- 1)

	)

1120 
	#SZINT
 (()(
lua_IÁeg”
))

	)

1125 
	mdummy
;

1126 
	ml™e
;

1127 } 
	gÇtiv“ndŸn
 = {1};

1131 
	scD
 {

1132 
	mc
;

1133 uniÚ { 
	md
; *
	mp
; 
lua_IÁeg”
 
	mi
; 
lua_Numb”
 
	mn
; } 
	mu
;

1136 
	#MAXALIGN
 (
	`off£tof
(
cD
, 
u
))

	)

1142 
	uFty³s
 {

1143 
	mf
;

1144 
	md
;

1145 
lua_Numb”
 
	mn
;

1146 
	mbuff
[5 * (
lua_Numb”
)];

1147 } 
	tFty³s
;

1153 
	sH—d”
 {

1154 
lua_S‹
 *
	mL
;

1155 
	mi¦™e
;

1156 
	mmax®ign
;

1157 } 
	tH—d”
;

1163 
	eKO±iÚ
 {

1164 
	mKšt
,

1165 
	mKušt
,

1166 
	mKæßt
,

1167 
	mKch¬
,

1168 
	mK¡ršg
,

1169 
	mKz¡r
,

1170 
	mK·ddšg
,

1171 
	mK·dd®ign
,

1172 
	mKnİ


1173 } 
	tKO±iÚ
;

1180 
	$dig™
 (
c
è{  '0' <ğø&& c <ğ'9'; 
	}
}

1182 
	$g‘num
 (cÚ¡ **
fmt
, 
df
) {

1183 ià(!
	`dig™
(**
fmt
))

1184  
df
;

1186 
a
 = 0;

1188 
a
 =‡*10 + (*((*
fmt
)++) - '0');

1189 } 
	`dig™
(**
fmt
è&& 
a
 <ğ(()
MAXSIZE
 - 9)/10);

1190  
a
;

1192 
	}
}

1199 
	$g‘numlim™
 (
H—d”
 *
h
, cÚ¡ **
fmt
, 
df
) {

1200 
sz
 = 
	`g‘num
(
fmt
, 
df
);

1201 ià(
sz
 > 
MAXINTSIZE
 || sz <= 0)

1202 
	`luaL_”rÜ
(
h
->
L
, "integral size (%d) out of†imits [1,%d]",

1203 
sz
, 
MAXINTSIZE
);

1204  
sz
;

1205 
	}
}

1211 
	$š™h—d”
 (
lua_S‹
 *
L
, 
H—d”
 *
h
) {

1212 
h
->
L
 = L;

1213 
h
->
i¦™e
 = 
Çtiv“ndŸn
.
l™e
;

1214 
h
->
max®ign
 = 1;

1215 
	}
}

1221 
KO±iÚ
 
	$g‘İtiÚ
 (
H—d”
 *
h
, cÚ¡ **
fmt
, *
size
) {

1222 
İt
 = *((*
fmt
)++);

1223 *
size
 = 0;

1224 
İt
) {

1225 'b': *
size
 = ();  
Kšt
;

1226 'B': *
size
 = ();  
Kušt
;

1227 'h': *
size
 = ();  
Kšt
;

1228 'H': *
size
 = ();  
Kušt
;

1229 'l': *
size
 = ();  
Kšt
;

1230 'L': *
size
 = ();  
Kušt
;

1231 'j': *
size
 = (
lua_IÁeg”
);  
Kšt
;

1232 'J': *
size
 = (
lua_IÁeg”
);  
Kušt
;

1233 'T': *
size
 = (
size_t
);  
Kušt
;

1234 'f': *
size
 = ();  
Kæßt
;

1235 'd': *
size
 = ();  
Kæßt
;

1236 'n': *
size
 = (
lua_Numb”
);  
Kæßt
;

1237 'i': *
size
 = 
	`g‘numlim™
(
h
, 
fmt
, ());  
Kšt
;

1238 'I': *
size
 = 
	`g‘numlim™
(
h
, 
fmt
, ());  
Kušt
;

1239 's': *
size
 = 
	`g‘numlim™
(
h
, 
fmt
, (
size_t
));  
K¡ršg
;

1241 *
size
 = 
	`g‘num
(
fmt
, -1);

1242 ià(*
size
 == -1)

1243 
	`luaL_”rÜ
(
h
->
L
, "missing size for format option 'c'");

1244  
Kch¬
;

1245 'z':  
Kz¡r
;

1246 'x': *
size
 = 1;  
K·ddšg
;

1247 'X':  
K·dd®ign
;

1249 '<': 
h
->
i¦™e
 = 1; ;

1250 '>': 
h
->
i¦™e
 = 0; ;

1251 '=': 
h
->
i¦™e
 = 
Çtiv“ndŸn
.
l™e
; ;

1252 '!': 
h
->
max®ign
 = 
	`g‘numlim™
(h, 
fmt
, 
MAXALIGN
); ;

1253 : 
	`luaL_”rÜ
(
h
->
L
, "šv®id fÜm© o±iÚ '%c'", 
İt
);

1255  
Knİ
;

1256 
	}
}

1268 
KO±iÚ
 
	$g‘d‘as
 (
H—d”
 *
h
, 
size_t
 
tÙ®size
,

1269 cÚ¡ **
fmt
, *
psize
, *
Áßlign
) {

1270 
KO±iÚ
 
İt
 = 
	`g‘İtiÚ
(
h
, 
fmt
, 
psize
);

1271 
®ign
 = *
psize
;

1272 ià(
İt
 =ğ
K·dd®ign
) {

1273 ià(**
fmt
 =ğ'\0' || 
	`g‘İtiÚ
(
h
, fmt, &
®ign
è=ğ
Kch¬
 ||‡lign == 0)

1274 
	`luaL_¬g”rÜ
(
h
->
L
, 1, "invalid‚ext option for option 'X'");

1276 ià(
®ign
 <ğ1 || 
İt
 =ğ
Kch¬
)

1277 *
Áßlign
 = 0;

1279 ià(
®ign
 > 
h
->
max®ign
)

1280 
®ign
 = 
h
->
max®ign
;

1281 ià((
®ign
 & (align - 1)) != 0)

1282 
	`luaL_¬g”rÜ
(
h
->
L
, 1, "format‡sks for‡lignment‚ot…ower of 2");

1283 *
Áßlign
 = (
®ign
 - ()(
tÙ®size
 & (align - 1))) & (align - 1);

1285  
İt
;

1286 
	}
}

1295 
	$·ckšt
 (
luaL_Bufãr
 *
b
, 
lua_UnsigÃd
 
n
,

1296 
i¦™e
, 
size
, 
Ãg
) {

1297 *
buff
 = 
	`luaL_´•buffsize
(
b
, 
size
);

1298 
i
;

1299 
buff
[
i¦™e
 ? 0 : 
size
 - 1] = ()(
n
 & 
MC
);

1300 
i
 = 1; i < 
size
; i++) {

1301 
n
 >>ğ
NB
;

1302 
buff
[
i¦™e
 ? 
i
 : 
size
 - 1 - i] = ()(
n
 & 
MC
);

1304 ià(
Ãg
 && 
size
 > 
SZINT
) {

1305 
i
 = 
SZINT
; i < 
size
; i++)

1306 
buff
[
i¦™e
 ? 
i
 : 
size
 - 1 - i] = ()
MC
;

1308 
	`luaL_addsize
(
b
, 
size
);

1309 
	}
}

1316 
	$cİyw™h’dŸn
 (vŞ©*
de¡
, vŞ©cÚ¡ *
¤c
,

1317 
size
, 
i¦™e
) {

1318 ià(
i¦™e
 =ğ
Çtiv“ndŸn
.
l™e
) {

1319 
size
-- != 0)

1320 *(
de¡
++èğ*(
¤c
++);

1323 
de¡
 +ğ
size
 - 1;

1324 
size
-- != 0)

1325 *(
de¡
--èğ*(
¤c
++);

1327 
	}
}

1330 
	$¡r_·ck
 (
lua_S‹
 *
L
) {

1331 
luaL_Bufãr
 
b
;

1332 
H—d”
 
h
;

1333 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

1334 
¬g
 = 1;

1335 
size_t
 
tÙ®size
 = 0;

1336 
	`š™h—d”
(
L
, &
h
);

1337 
	`lua_pushn
(
L
);

1338 
	`luaL_buffš™
(
L
, &
b
);

1339 *
fmt
 != '\0') {

1340 
size
, 
Áßlign
;

1341 
KO±iÚ
 
İt
 = 
	`g‘d‘as
(&
h
, 
tÙ®size
, &
fmt
, &
size
, &
Áßlign
);

1342 
tÙ®size
 +ğ
Áßlign
 + 
size
;

1343 
Áßlign
-- > 0)

1344 
	`luaL_addch¬
(&
b
, 
LUAL_PACKPADBYTE
);

1345 
¬g
++;

1346 
İt
) {

1347 
Kšt
: {

1348 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

1349 ià(
size
 < 
SZINT
) {

1350 
lua_IÁeg”
 
lim
 = (lua_IÁeg”)1 << ((
size
 * 
NB
) - 1);

1351 
	`luaL_¬gcheck
(
L
, -
lim
 <ğ
n
 &&‚ <†im, 
¬g
, "integer overflow");

1353 
	`·ckšt
(&
b
, (
lua_UnsigÃd
)
n
, 
h
.
i¦™e
, 
size
, (n < 0));

1356 
Kušt
: {

1357 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

1358 ià(
size
 < 
SZINT
)

1359 
	`luaL_¬gcheck
(
L
, (
lua_UnsigÃd
)
n
 < (Öua_UnsigÃd)1 << (
size
 * 
NB
)),

1360 
¬g
, "unsigned overflow");

1361 
	`·ckšt
(&
b
, (
lua_UnsigÃd
)
n
, 
h
.
i¦™e
, 
size
, 0);

1364 
Kæßt
: {

1365 vŞ©
Fty³s
 
u
;

1366 *
buff
 = 
	`luaL_´•buffsize
(&
b
, 
size
);

1367 
lua_Numb”
 
n
 = 
	`luaL_checknumb”
(
L
, 
¬g
);

1368 ià(
size
 =ğ(
u
.
f
)èu.àğ()
n
;

1369 ià(
size
 =ğ(
u
.
d
)èu.d = ()
n
;

1370 
u
.
n
 =‚;

1372 
	`cİyw™h’dŸn
(
buff
, 
u
.buff, 
size
, 
h
.
i¦™e
);

1373 
	`luaL_addsize
(&
b
, 
size
);

1376 
Kch¬
: {

1377 
size_t
 
Ën
;

1378 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
Ën
);

1379 
	`luaL_¬gcheck
(
L
, 
Ën
 <ğ(
size_t
)
size
, 
¬g
,

1381 
	`luaL_addl¡ršg
(&
b
, 
s
, 
Ën
);

1382 
Ën
++ < (
size_t
)
size
)

1383 
	`luaL_addch¬
(&
b
, 
LUAL_PACKPADBYTE
);

1386 
K¡ršg
: {

1387 
size_t
 
Ën
;

1388 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
Ën
);

1389 
	`luaL_¬gcheck
(
L
, 
size
 >ğ()(
size_t
) ||

1390 
Ën
 < ((
size_t
)1 << (
size
 * 
NB
)),

1391 
¬g
, "string†ength does‚ot fit in given size");

1392 
	`·ckšt
(&
b
, (
lua_UnsigÃd
)
Ën
, 
h
.
i¦™e
, 
size
, 0);

1393 
	`luaL_addl¡ršg
(&
b
, 
s
, 
Ën
);

1394 
tÙ®size
 +ğ
Ën
;

1397 
Kz¡r
: {

1398 
size_t
 
Ën
;

1399 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 
¬g
, &
Ën
);

1400 
	`luaL_¬gcheck
(
L
, 
	`¡¾’
(
s
è=ğ
Ën
, 
¬g
, "string contains zeros");

1401 
	`luaL_addl¡ršg
(&
b
, 
s
, 
Ën
);

1402 
	`luaL_addch¬
(&
b
, '\0');

1403 
tÙ®size
 +ğ
Ën
 + 1;

1406 
K·ddšg
: 
	`luaL_addch¬
(&
b
, 
LUAL_PACKPADBYTE
);

1407 
K·dd®ign
: 
Knİ
:

1408 
¬g
--;

1412 
	`luaL_push»suÉ
(&
b
);

1414 
	}
}

1417 
	$¡r_·cksize
 (
lua_S‹
 *
L
) {

1418 
H—d”
 
h
;

1419 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

1420 
size_t
 
tÙ®size
 = 0;

1421 
	`š™h—d”
(
L
, &
h
);

1422 *
fmt
 != '\0') {

1423 
size
, 
Áßlign
;

1424 
KO±iÚ
 
İt
 = 
	`g‘d‘as
(&
h
, 
tÙ®size
, &
fmt
, &
size
, &
Áßlign
);

1425 
size
 +ğ
Áßlign
;

1426 
	`luaL_¬gcheck
(
L
, 
tÙ®size
 <ğ
MAXSIZE
 - 
size
, 1,

1428 
tÙ®size
 +ğ
size
;

1429 
İt
) {

1430 
K¡ršg
:

1431 
Kz¡r
:

1432 
	`luaL_¬g”rÜ
(
L
, 1, "variable-length format");

1437 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
tÙ®size
);

1439 
	}
}

1450 
lua_IÁeg”
 
	$uÅackšt
 (
lua_S‹
 *
L
, cÚ¡ *
¡r
,

1451 
i¦™e
, 
size
, 
issigÃd
) {

1452 
lua_UnsigÃd
 
»s
 = 0;

1453 
i
;

1454 
lim™
 = (
size
 <ğ
SZINT
) ? size : SZINT;

1455 
i
 = 
lim™
 - 1; i >= 0; i--) {

1456 
»s
 <<ğ
NB
;

1457 
»s
 |ğ(
lua_UnsigÃd
)()
¡r
[
i¦™e
 ? 
i
 : 
size
 - 1 - i];

1459 ià(
size
 < 
SZINT
) {

1460 ià(
issigÃd
) {

1461 
lua_UnsigÃd
 
mask
 = (lua_UnsigÃd)1 << (
size
*
NB
 - 1);

1462 
»s
 = (Ôe ^ 
mask
) - mask);

1465 ià(
size
 > 
SZINT
) {

1466 
mask
 = (!
issigÃd
 || (
lua_IÁeg”
)
»s
 >ğ0è? 0 : 
MC
;

1467 
i
 = 
lim™
; i < 
size
; i++) {

1468 ià(()
¡r
[
i¦™e
 ? 
i
 : 
size
 - 1 - i] !ğ
mask
)

1469 
	`luaL_”rÜ
(
L
, "%d-by‹ iÁeg” dÛ nÙ f™ iÁØLu¨IÁeg”", 
size
);

1472  (
lua_IÁeg”
)
»s
;

1473 
	}
}

1476 
	$¡r_uÅack
 (
lua_S‹
 *
L
) {

1477 
H—d”
 
h
;

1478 cÚ¡ *
fmt
 = 
	`luaL_check¡ršg
(
L
, 1);

1479 
size_t
 
ld
;

1480 cÚ¡ *
d©a
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
ld
);

1481 
size_t
 
pos
 = (size_t)
	`po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 1), 
ld
) - 1;

1482 
n
 = 0;

1483 
	`luaL_¬gcheck
(
L
, 
pos
 <ğ
ld
, 3, "initial…osition out of string");

1484 
	`š™h—d”
(
L
, &
h
);

1485 *
fmt
 != '\0') {

1486 
size
, 
Áßlign
;

1487 
KO±iÚ
 
İt
 = 
	`g‘d‘as
(&
h
, 
pos
, &
fmt
, &
size
, &
Áßlign
);

1488 ià((
size_t
)
Áßlign
 + 
size
 > ~
pos
 ||…o +‚tßligÀ+ siz> 
ld
)

1489 
	`luaL_¬g”rÜ
(
L
, 2, "data stringoo short");

1490 
pos
 +ğ
Áßlign
;

1492 
	`luaL_check¡ack
(
L
, 2, "too many„esults");

1493 
n
++;

1494 
İt
) {

1495 
Kšt
:

1496 
Kušt
: {

1497 
lua_IÁeg”
 
»s
 = 
	`uÅackšt
(
L
, 
d©a
 + 
pos
, 
h
.
i¦™e
, 
size
,

1498 (
İt
 =ğ
Kšt
));

1499 
	`lua_pushš‹g”
(
L
, 
»s
);

1502 
Kæßt
: {

1503 vŞ©
Fty³s
 
u
;

1504 
lua_Numb”
 
num
;

1505 
	`cİyw™h’dŸn
(
u
.
buff
, 
d©a
 + 
pos
, 
size
, 
h
.
i¦™e
);

1506 ià(
size
 =ğ(
u
.
f
)è
num
 = (
lua_Numb”
)u.f;

1507 ià(
size
 =ğ(
u
.
d
)è
num
 = (
lua_Numb”
)u.d;

1508 
num
 = 
u
.
n
;

1509 
	`lua_pushnumb”
(
L
, 
num
);

1512 
Kch¬
: {

1513 
	`lua_pushl¡ršg
(
L
, 
d©a
 + 
pos
, 
size
);

1516 
K¡ršg
: {

1517 
size_t
 
Ën
 = (size_t)
	`uÅackšt
(
L
, 
d©a
 + 
pos
, 
h
.
i¦™e
, 
size
, 0);

1518 
	`luaL_¬gcheck
(
L
, 
pos
 + 
Ën
 + 
size
 <ğ
ld
, 2, "data stringoo short");

1519 
	`lua_pushl¡ršg
(
L
, 
d©a
 + 
pos
 + 
size
, 
Ën
);

1520 
pos
 +ğ
Ën
;

1523 
Kz¡r
: {

1524 
size_t
 
Ën
 = ()
	`¡¾’
(
d©a
 + 
pos
);

1525 
	`lua_pushl¡ršg
(
L
, 
d©a
 + 
pos
, 
Ën
);

1526 
pos
 +ğ
Ën
 + 1;

1529 
K·dd®ign
: 
K·ddšg
: 
Knİ
:

1530 
n
--;

1533 
pos
 +ğ
size
;

1535 
	`lua_pushš‹g”
(
L
, 
pos
 + 1);

1536  
n
 + 1;

1537 
	}
}

1542 cÚ¡ 
luaL_Reg
 
	g¡¾ib
[] = {

1543 {"by‹", 
¡r_by‹
},

1544 {"ch¬", 
¡r_ch¬
},

1545 {"dump", 
¡r_dump
},

1546 {"fšd", 
¡r_fšd
},

1547 {"fÜm©", 
¡r_fÜm©
},

1548 {"gm©ch", 
gm©ch
},

1549 {"gsub", 
¡r_gsub
},

1550 {"Ën", 
¡r_Ën
},

1551 {"low”", 
¡r_low”
},

1552 {"m©ch", 
¡r_m©ch
},

1553 {"»p", 
¡r_»p
},

1554 {"»v”£", 
¡r_»v”£
},

1555 {"sub", 
¡r_sub
},

1556 {"uµ”", 
¡r_uµ”
},

1557 {"·ck", 
¡r_·ck
},

1558 {"·cksize", 
¡r_·cksize
},

1559 {"uÅack", 
¡r_uÅack
},

1560 {
NULL
, NULL}

1564 
	$ü—‹m‘©abË
 (
lua_S‹
 *
L
) {

1565 
	`lua_ü—‹bË
(
L
, 0, 1);

1566 
	`lua_pushl™”®
(
L
, "");

1567 
	`lua_pushv®ue
(
L
, -2);

1568 
	`lua_£tm‘©abË
(
L
, -2);

1569 
	`lua_pİ
(
L
, 1);

1570 
	`lua_pushv®ue
(
L
, -2);

1571 
	`lua_£tf›ld
(
L
, -2, "__index");

1572 
	`lua_pİ
(
L
, 1);

1573 
	}
}

1579 
LUAMOD_API
 
	$luaİ’_¡ršg
 (
lua_S‹
 *
L
) {

1580 
	`luaL_Ãwlib
(
L
, 
¡¾ib
);

1581 
	`ü—‹m‘©abË
(
L
);

1583 
	}
}

	@3rd/lua/ltable.c

7 
	#ÉabË_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

26 
	~<m©h.h
>

27 
	~<lim™s.h
>

29 
	~"lua.h
"

31 
	~"ldebug.h
"

32 
	~"ldo.h
"

33 
	~"lgc.h
"

34 
	~"lmem.h
"

35 
	~"lobjeù.h
"

36 
	~"l¡©e.h
"

37 
	~"l¡ršg.h
"

38 
	~"ÉabË.h
"

39 
	~"lvm.h
"

46 
	#MAXABITS
 
	`ÿ¡_št
((è* 
CHAR_BIT
 - 1)

	)

47 
	#MAXASIZE
 (1u << 
MAXABITS
)

	)

55 
	#MAXHBITS
 (
MAXABITS
 - 1)

	)

58 
	#hashpow2
(
t
,
n
è(
	`gnode
Ñ, 
	`lmod
(Ò), 
	`siz’ode
Ñ))))

	)

60 
	#hash¡r
(
t
,
¡r
è
	`hashpow2
Ñ, (¡r)->
hash
)

	)

61 
	#hashboŞ—n
(
t
,
p
è
	`hashpow2
Ñ,…)

	)

62 
	#hashšt
(
t
,
i
è
	`hashpow2
Ñ, i)

	)

69 
	#hashmod
(
t
,
n
è(
	`gnode
Ñ, (Òè% ((
	`siz’ode
Ñ)-1)|1))))

	)

72 
	#hashpoš‹r
(
t
,
p
è
	`hashmod
Ñ, 
	`pošt2ušt
Õ))

	)

75 
	#dummynode
 (&
dummynode_
)

	)

77 cÚ¡ 
Node
 
	gdummynode_
 = {

78 {
NILCONSTANT
},

79 {{
NILCONSTANT
, 0}}

96 #ià!
defšed
(
l_hashæßt
)

97 
	$l_hashæßt
 (
lua_Numb”
 
n
) {

98 
i
;

99 
lua_IÁeg”
 
ni
;

100 
n
 = 
	`l_m©hİ
(
äexp
)Ò, &
i
è* -
	`ÿ¡_num
(
INT_MIN
);

101 ià(!
	`lua_numb”toš‹g”
(
n
, &
ni
)) {

102 
	`lua_as£¹
(
	`luai_numi¢ª
(
n
è|| 
	`l_m©hİ
(
çbs
)Òè=ğ
	`ÿ¡_num
(
HUGE_VAL
));

106 
u
 = 
	`ÿ¡
(, 
i
è+ ca¡(, 
ni
);

107  
	`ÿ¡_št
(
u
 <ğ
	`ÿ¡
(, 
INT_MAX
) ? u : ~u);

109 
	}
}

117 
Node
 *
	$mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

118 
	`‰y³
(
key
)) {

119 
LUA_TNUMINT
:

120  
	`hashšt
(
t
, 
	`iv®ue
(
key
));

121 
LUA_TNUMFLT
:

122  
	`hashmod
(
t
, 
	`l_hashæßt
(
	`ætv®ue
(
key
)));

123 
LUA_TSHRSTR
:

124  
	`hash¡r
(
t
, 
	`tsv®ue
(
key
));

125 
LUA_TLNGSTR
:

126  
	`hashpow2
(
t
, 
	`luaS_hashlÚg¡r
(
	`tsv®ue
(
key
)));

127 
LUA_TBOOLEAN
:

128  
	`hashboŞ—n
(
t
, 
	`bv®ue
(
key
));

129 
LUA_TLIGHTUSERDATA
:

130  
	`hashpoš‹r
(
t
, 
	`pv®ue
(
key
));

131 
LUA_TLCF
:

132  
	`hashpoš‹r
(
t
, 
	`fv®ue
(
key
));

134 
	`lua_as£¹
(!
	`‰isd—dkey
(
key
));

135  
	`hashpoš‹r
(
t
, 
	`gcv®ue
(
key
));

137 
	}
}

144 
	$¬¿yšdex
 (cÚ¡ 
TV®ue
 *
key
) {

145 ià(
	`‰isš‹g”
(
key
)) {

146 
lua_IÁeg”
 
k
 = 
	`iv®ue
(
key
);

147 ià(0 < 
k
 && (
lua_UnsigÃd
)k <ğ
MAXASIZE
)

148  
	`ÿ¡
(, 
k
);

151 
	}
}

159 
	$fšdšdex
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
) {

160 
i
;

161 ià(
	`‰i¢
(
key
))  0;

162 
i
 = 
	`¬¿yšdex
(
key
);

163 ià(
i
 !ğ0 && i <ğ
t
->
siz—¼ay
)

164  
i
;

166 
nx
;

167 
Node
 *
n
 = 
	`mašpos™iÚ
(
t
, 
key
);

170 ià(
	`luaV_¿wequ®obj
(
	`gkey
(
n
), 
key
) ||

171 (
	`‰isd—dkey
(
	`gkey
(
n
)è&& 
	`iscŞËùabË
(
key
) &&

172 
	`d—dv®ue
(
	`gkey
(
n
)è=ğ
	`gcv®ue
(
key
))) {

173 
i
 = 
	`ÿ¡_št
(
n
 - 
	`gnode
(
t
, 0));

175  (
i
 + 1è+ 
t
->
siz—¼ay
;

177 
nx
 = 
	`gÃxt
(
n
);

178 ià(
nx
 == 0)

179 
	`luaG_ruÃ¼Ü
(
L
, "invalid keyo 'next'");

180 
n
 +ğ
nx
;

183 
	}
}

186 
	$luaH_Ãxt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
) {

187 
i
 = 
	`fšdšdex
(
L
, 
t
, 
key
);

188 ; 
i
 < 
t
->
siz—¼ay
; i++) {

189 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
])) {

190 
	`£tiv®ue
(
key
, 
i
 + 1);

191 
	`£tobj2s
(
L
, 
key
+1, &
t
->
¬¿y
[
i
]);

195 
i
 -ğ
t
->
siz—¼ay
; 
	`ÿ¡_št
(iè< 
	`siz’ode
(t); i++) {

196 ià(!
	`‰i¢
(
	`gv®
(
	`gnode
(
t
, 
i
)))) {

197 
	`£tobj2s
(
L
, 
key
, 
	`gkey
(
	`gnode
(
t
, 
i
)));

198 
	`£tobj2s
(
L
, 
key
+1, 
	`gv®
(
	`gnode
(
t
, 
i
)));

203 
	}
}

219 
	$compu‹sizes
 (
nums
[], *
²a
) {

220 
i
;

221 
twÙoi
;

222 
a
 = 0;

223 
Ç
 = 0;

224 
İtim®
 = 0;

226 
i
 = 0, 
twÙoi
 = 1; *
²a
 >wotoi / 2; i++,wotoi *= 2) {

227 ià(
nums
[
i
] > 0) {

228 
a
 +ğ
nums
[
i
];

229 ià(
a
 > 
twÙoi
/2) {

230 
İtim®
 = 
twÙoi
;

231 
Ç
 = 
a
;

235 
	`lua_as£¹
((
İtim®
 =ğ0 || o±im® / 2 < 
Ç
) &&‚a <= optimal);

236 *
²a
 = 
Ç
;

237  
İtim®
;

238 
	}
}

241 
	$couÁšt
 (cÚ¡ 
TV®ue
 *
key
, *
nums
) {

242 
k
 = 
	`¬¿yšdex
(
key
);

243 ià(
k
 != 0) {

244 
nums
[
	`luaO_ûlog2
(
k
)]++;

249 
	}
}

257 
	$numu£¬¿y
 (cÚ¡ 
TabË
 *
t
, *
nums
) {

258 
lg
;

259 
‰lg
;

260 
au£
 = 0;

261 
i
 = 1;

263 
lg
 = 0, 
‰lg
 = 1;†g <ğ
MAXABITS
;†g++,tlg *= 2) {

264 
lc
 = 0;

265 
lim
 = 
‰lg
;

266 ià(
lim
 > 
t
->
siz—¼ay
) {

267 
lim
 = 
t
->
siz—¼ay
;

268 ià(
i
 > 
lim
)

272 ; 
i
 <ğ
lim
; i++) {

273 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
-1]))

274 
lc
++;

276 
nums
[
lg
] +ğ
lc
;

277 
au£
 +ğ
lc
;

279  
au£
;

280 
	}
}

283 
	$numu£hash
 (cÚ¡ 
TabË
 *
t
, *
nums
, *
²a
) {

284 
tÙ®u£
 = 0;

285 
au£
 = 0;

286 
i
 = 
	`siz’ode
(
t
);

287 
i
--) {

288 
Node
 *
n
 = &
t
->
node
[
i
];

289 ià(!
	`‰i¢
(
	`gv®
(
n
))) {

290 
au£
 +ğ
	`couÁšt
(
	`gkey
(
n
), 
nums
);

291 
tÙ®u£
++;

294 *
²a
 +ğ
au£
;

295  
tÙ®u£
;

296 
	}
}

299 
	$£¼ayveùÜ
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
size
) {

300 
i
;

301 
	`luaM_»®locveùÜ
(
L
, 
t
->
¬¿y
,->
siz—¼ay
, 
size
, 
TV®ue
);

302 
i
=
t
->
siz—¼ay
; i<
size
; i++)

303 
	`£Šv®ue
(&
t
->
¬¿y
[
i
]);

304 
t
->
siz—¼ay
 = 
size
;

305 
	}
}

308 
	$£ŠodeveùÜ
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
size
) {

309 ià(
size
 == 0) {

310 
t
->
node
 = 
	`ÿ¡
(
Node
 *, 
dummynode
);

311 
t
->
lsiz’ode
 = 0;

312 
t
->
Ï¡ä“
 = 
NULL
;

315 
i
;

316 
lsize
 = 
	`luaO_ûlog2
(
size
);

317 ià(
lsize
 > 
MAXHBITS
)

318 
	`luaG_ruÃ¼Ü
(
L
, "table overflow");

319 
size
 = 
	`twÙo
(
lsize
);

320 
t
->
node
 = 
	`luaM_ÃwveùÜ
(
L
, 
size
, 
Node
);

321 
i
 = 0; i < ()
size
; i++) {

322 
Node
 *
n
 = 
	`gnode
(
t
, 
i
);

323 
	`gÃxt
(
n
) = 0;

324 
	`£Šv®ue
(
	`wgkey
(
n
));

325 
	`£Šv®ue
(
	`gv®
(
n
));

327 
t
->
lsiz’ode
 = 
	`ÿ¡_by‹
(
lsize
);

328 
t
->
Ï¡ä“
 = 
	`gnode
Ñ, 
size
);

330 
	}
}

333 
	$luaH_»size
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
,

334 
nhsize
) {

335 
i
;

336 
j
;

337 
Şdasize
 = 
t
->
siz—¼ay
;

338 
Şdhsize
 = 
	`®locsiz’ode
(
t
);

339 
Node
 *
nŞd
 = 
t
->
node
;

340 ià(
Çsize
 > 
Şdasize
)

341 
	`£¼ayveùÜ
(
L
, 
t
, 
Çsize
);

343 
	`£ŠodeveùÜ
(
L
, 
t
, 
nhsize
);

344 ià(
Çsize
 < 
Şdasize
) {

345 
t
->
siz—¼ay
 = 
Çsize
;

347 
i
=
Çsize
; i<
Şdasize
; i++) {

348 ià(!
	`‰i¢
(&
t
->
¬¿y
[
i
]))

349 
	`luaH_£tšt
(
L
, 
t
, 
i
 + 1, &t->
¬¿y
[i]);

352 
	`luaM_»®locveùÜ
(
L
, 
t
->
¬¿y
, 
Şdasize
, 
Çsize
, 
TV®ue
);

355 
j
 = 
Şdhsize
 - 1; j >= 0; j--) {

356 
Node
 *
Şd
 = 
nŞd
 + 
j
;

357 ià(!
	`‰i¢
(
	`gv®
(
Şd
))) {

360 
	`£tobjt2t
(
L
, 
	`luaH_£t
(L, 
t
, 
	`gkey
(
Şd
)), 
	`gv®
(old));

363 ià(
Şdhsize
 > 0)

364 
	`luaM_ä“¬¿y
(
L
, 
nŞd
, 
	`ÿ¡
(
size_t
, 
Şdhsize
));

365 
	}
}

368 
	$luaH_»siz—¼ay
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
) {

369 
nsize
 = 
	`®locsiz’ode
(
t
);

370 
	`luaH_»size
(
L
, 
t
, 
Çsize
, 
nsize
);

371 
	}
}

376 
	$»hash
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
ek
) {

377 
asize
;

378 
Ç
;

379 
nums
[
MAXABITS
 + 1];

380 
i
;

381 
tÙ®u£
;

382 
i
 = 0; i <ğ
MAXABITS
; i++è
nums
[i] = 0;

383 
Ç
 = 
	`numu£¬¿y
(
t
, 
nums
);

384 
tÙ®u£
 = 
Ç
;

385 
tÙ®u£
 +ğ
	`numu£hash
(
t
, 
nums
, &
Ç
);

387 
Ç
 +ğ
	`couÁšt
(
ek
, 
nums
);

388 
tÙ®u£
++;

390 
asize
 = 
	`compu‹sizes
(
nums
, &
Ç
);

392 
	`luaH_»size
(
L
, 
t
, 
asize
, 
tÙ®u£
 - 
Ç
);

393 
	}
}

402 
TabË
 *
	$luaH_Ãw
 (
lua_S‹
 *
L
) {

403 
GCObjeù
 *
o
 = 
	`luaC_Ãwobj
(
L
, 
LUA_TTABLE
, (
TabË
));

404 
TabË
 *
t
 = 
	`gco2t
(
o
);

405 
t
->
m‘©abË
 = 
NULL
;

406 
t
->
æags
 = 
	`ÿ¡_by‹
(~0);

407 
t
->
¬¿y
 = 
NULL
;

408 
t
->
siz—¼ay
 = 0;

409 
	`£ŠodeveùÜ
(
L
, 
t
, 0);

410  
t
;

411 
	}
}

414 
	$luaH_ä“
 (
lua_S‹
 *
L
, 
TabË
 *
t
) {

415 ià(!
	`isdummy
(
t
))

416 
	`luaM_ä“¬¿y
(
L
, 
t
->
node
, 
	`ÿ¡
(
size_t
, 
	`siz’ode
(t)));

417 
	`luaM_ä“¬¿y
(
L
, 
t
->
¬¿y
,->
siz—¼ay
);

418 
	`luaM_ä“
(
L
, 
t
);

419 
	}
}

422 
Node
 *
	$g‘ä“pos
 (
TabË
 *
t
) {

423 ià(!
	`isdummy
(
t
)) {

424 
t
->
Ï¡ä“
 >->
node
) {

425 
t
->
Ï¡ä“
--;

426 ià(
	`‰i¢
(
	`gkey
(
t
->
Ï¡ä“
)))

427  
t
->
Ï¡ä“
;

430  
NULL
;

431 
	}
}

442 
TV®ue
 *
	$luaH_Ãwkey
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

443 
Node
 *
mp
;

444 
TV®ue
 
aux
;

445 ià(
	`‰i¢
(
key
)è
	`luaG_ruÃ¼Ü
(
L
, "table index is‚il");

446 ià(
	`‰isæßt
(
key
)) {

447 
lua_IÁeg”
 
k
;

448 ià(
	`luaV_toš‹g”
(
key
, &
k
, 0)) {

449 
	`£tiv®ue
(&
aux
, 
k
);

450 
key
 = &
aux
;

452 ià(
	`luai_numi¢ª
(
	`ætv®ue
(
key
)))

453 
	`luaG_ruÃ¼Ü
(
L
, "table index is NaN");

455 
mp
 = 
	`mašpos™iÚ
(
t
, 
key
);

456 ià(!
	`‰i¢
(
	`gv®
(
mp
)è|| 
	`isdummy
(
t
)) {

457 
Node
 *
Ùh”n
;

458 
Node
 *
f
 = 
	`g‘ä“pos
(
t
);

459 ià(
f
 =ğ
NULL
) {

460 
	`»hash
(
L
, 
t
, 
key
);

462  
	`luaH_£t
(
L
, 
t
, 
key
);

464 
	`lua_as£¹
(!
	`isdummy
(
t
));

465 
Ùh”n
 = 
	`mašpos™iÚ
(
t
, 
	`gkey
(
mp
));

466 ià(
Ùh”n
 !ğ
mp
) {

468 
Ùh”n
 + 
	`gÃxt
(Ùh”nè!ğ
mp
)

469 
Ùh”n
 +ğ
	`gÃxt
(othern);

470 
	`gÃxt
(
Ùh”n
èğ
	`ÿ¡_št
(
f
 - othern);

471 *
f
 = *
mp
;

472 ià(
	`gÃxt
(
mp
) != 0) {

473 
	`gÃxt
(
f
è+ğ
	`ÿ¡_št
(
mp
 - f);

474 
	`gÃxt
(
mp
) = 0;

476 
	`£Šv®ue
(
	`gv®
(
mp
));

480 ià(
	`gÃxt
(
mp
) != 0)

481 
	`gÃxt
(
f
èğ
	`ÿ¡_št
((
mp
 + gnext(mp)) - f);

482 
	`lua_as£¹
(
	`gÃxt
(
f
) == 0);

483 
	`gÃxt
(
mp
èğ
	`ÿ¡_št
(
f
 - mp);

484 
mp
 = 
f
;

487 
	`£Šodekey
(
L
, &
mp
->
i_key
, 
key
);

488 
	`luaC_b¬r›rback
(
L
, 
t
, 
key
);

489 
	`lua_as£¹
(
	`‰i¢
(
	`gv®
(
mp
)));

490  
	`gv®
(
mp
);

491 
	}
}

497 cÚ¡ 
TV®ue
 *
	$luaH_g‘št
 (
TabË
 *
t
, 
lua_IÁeg”
 
key
) {

499 ià(
	`l_ÿ¡S2U
(
key
è- 1 < 
t
->
siz—¼ay
)

500  &
t
->
¬¿y
[
key
 - 1];

502 
Node
 *
n
 = 
	`hashšt
(
t
, 
key
);

504 ià(
	`‰isš‹g”
(
	`gkey
(
n
)è&& 
	`iv®ue
(gkeyÒ)è=ğ
key
)

505  
	`gv®
(
n
);

507 
nx
 = 
	`gÃxt
(
n
);

508 ià(
nx
 == 0) ;

509 
n
 +ğ
nx
;

512  
luaO_nobjeù
;

514 
	}
}

520 cÚ¡ 
TV®ue
 *
	$luaH_g‘shÜt¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
) {

521 
Node
 *
n
 = 
	`hash¡r
(
t
, 
key
);

522 
	`lua_as£¹
(
key
->
‰
 =ğ
LUA_TSHRSTR
);

524 cÚ¡ 
TV®ue
 *
k
 = 
	`gkey
(
n
);

525 ià(
	`‰isshr¡ršg
(
k
è&& 
	`eqshr¡r
(
	`tsv®ue
(k), 
key
))

526  
	`gv®
(
n
);

528 
nx
 = 
	`gÃxt
(
n
);

529 ià(
nx
 == 0)

530  
luaO_nobjeù
;

531 
n
 +ğ
nx
;

534 
	}
}

541 cÚ¡ 
TV®ue
 *
	$g‘g’”ic
 (
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

542 
Node
 *
n
 = 
	`mašpos™iÚ
(
t
, 
key
);

544 ià(
	`luaV_¿wequ®obj
(
	`gkey
(
n
), 
key
))

545  
	`gv®
(
n
);

547 
nx
 = 
	`gÃxt
(
n
);

548 ià(
nx
 == 0)

549  
luaO_nobjeù
;

550 
n
 +ğ
nx
;

553 
	}
}

556 cÚ¡ 
TV®ue
 *
	$luaH_g‘¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
) {

557 ià(
key
->
‰
 =ğ
LUA_TSHRSTR
)

558  
	`luaH_g‘shÜt¡r
(
t
, 
key
);

560 
TV®ue
 
ko
;

561 
	`£tsv®ue
(
	`ÿ¡
(
lua_S‹
 *, 
NULL
), &
ko
, 
key
);

562  
	`g‘g’”ic
(
t
, &
ko
);

564 
	}
}

570 cÚ¡ 
TV®ue
 *
	$luaH_g‘
 (
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

571 
	`‰y³
(
key
)) {

572 
LUA_TSHRSTR
:  
	`luaH_g‘shÜt¡r
(
t
, 
	`tsv®ue
(
key
));

573 
LUA_TNUMINT
:  
	`luaH_g‘št
(
t
, 
	`iv®ue
(
key
));

574 
LUA_TNIL
:  
luaO_nobjeù
;

575 
LUA_TNUMFLT
: {

576 
lua_IÁeg”
 
k
;

577 ià(
	`luaV_toš‹g”
(
key
, &
k
, 0))

578  
	`luaH_g‘št
(
t
, 
k
);

582  
	`g‘g’”ic
(
t
, 
key
);

584 
	}
}

591 
TV®ue
 *
	$luaH_£t
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

592 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘
(
t
, 
key
);

593 ià(
p
 !ğ
luaO_nobjeù
)

594  
	`ÿ¡
(
TV®ue
 *, 
p
);

595  
	`luaH_Ãwkey
(
L
, 
t
, 
key
);

596 
	}
}

599 
	$luaH_£tšt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
lua_IÁeg”
 
key
, 
TV®ue
 *
v®ue
) {

600 cÚ¡ 
TV®ue
 *
p
 = 
	`luaH_g‘št
(
t
, 
key
);

601 
TV®ue
 *
ûÎ
;

602 ià(
p
 !ğ
luaO_nobjeù
)

603 
ûÎ
 = 
	`ÿ¡
(
TV®ue
 *, 
p
);

605 
TV®ue
 
k
;

606 
	`£tiv®ue
(&
k
, 
key
);

607 
ûÎ
 = 
	`luaH_Ãwkey
(
L
, 
t
, &
k
);

609 
	`£tobj2t
(
L
, 
ûÎ
, 
v®ue
);

610 
	}
}

613 
	$unbound_£¬ch
 (
TabË
 *
t
, 
j
) {

614 
i
 = 
j
;

615 
j
++;

617 !
	`‰i¢
(
	`luaH_g‘št
(
t
, 
j
))) {

618 
i
 = 
j
;

619 ià(
j
 > 
	`ÿ¡
(, 
MAX_INT
)/2) {

621 
i
 = 1;

622 !
	`‰i¢
(
	`luaH_g‘št
(
t
, 
i
))) i++;

623  
i
 - 1;

625 
j
 *= 2;

628 
j
 - 
i
 > 1) {

629 
m
 = (
i
+
j
)/2;

630 ià(
	`‰i¢
(
	`luaH_g‘št
(
t
, 
m
))è
j
 = m;

631 
i
 = 
m
;

633  
i
;

634 
	}
}

641 
	$luaH_g‘n
 (
TabË
 *
t
) {

642 
j
 = 
t
->
siz—¼ay
;

643 ià(
j
 > 0 && 
	`‰i¢
(&
t
->
¬¿y
[j - 1])) {

645 
i
 = 0;

646 
j
 - 
i
 > 1) {

647 
m
 = (
i
+
j
)/2;

648 ià(
	`‰i¢
(&
t
->
¬¿y
[
m
 - 1])è
j
 = m;

649 
i
 = 
m
;

651  
i
;

654 ià(
	`isdummy
(
t
))

655  
j
;

656  
	`unbound_£¬ch
(
t
, 
j
);

657 
	}
}

661 #ià
defšed
(
LUA_DEBUG
)

663 
Node
 *
	$luaH_mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
) {

664  
	`mašpos™iÚ
(
t
, 
key
);

665 
	}
}

667 
	$luaH_isdummy
 (cÚ¡ 
TabË
 *
t
è{  
	`isdummy
Ñ); 
	}
}

	@3rd/lua/ltable.h

7 #iâdeà
ÉabË_h


8 
	#ÉabË_h


	)

10 
	~"lobjeù.h
"

13 
	#gnode
(
t
,
i
è(&Ñ)->
node
[i])

	)

14 
	#gv®
(
n
è(&Ò)->
i_v®
)

	)

15 
	#gÃxt
(
n
è(Ò)->
i_key
.
nk
.
Ãxt
)

	)

19 
	#gkey
(
n
è
	`ÿ¡
(cÚ¡ 
TV®ue
*, (&Ò)->
i_key
.
tvk
))

	)

25 
	#wgkey
(
n
è(&Ò)->
i_key
.
nk
)

	)

27 
	#šv®id©eTMÿche
(
t
è(Ñ)->
æags
 = 0)

	)

31 
	#isdummy
(
t
è(Ñ)->
Ï¡ä“
 =ğ
NULL
)

	)

35 
	#®locsiz’ode
(
t
è(
	`isdummy
Ñè? 0 : 
	`siz’ode
Ñ))

	)

39 
	#keyäomv®
(
v
) \

40 (
	`gkey
(
	`ÿ¡
(
Node
 *, ca¡(*, (
v
)è- 
	`off£tof
(Node, 
i_v®
))))

	)

43 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘št
 (
TabË
 *
t
, 
lua_IÁeg”
 
key
);

44 
LUAI_FUNC
 
luaH_£tšt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
lua_IÁeg”
 
key
,

45 
TV®ue
 *
v®ue
);

46 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘shÜt¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
);

47 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘¡r
 (
TabË
 *
t
, 
TSŒšg
 *
key
);

48 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaH_g‘
 (
TabË
 *
t
, cÚ¡ TV®u*
key
);

49 
LUAI_FUNC
 
TV®ue
 *
luaH_Ãwkey
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ TV®u*
key
);

50 
LUAI_FUNC
 
TV®ue
 *
luaH_£t
 (
lua_S‹
 *
L
, 
TabË
 *
t
, cÚ¡ TV®u*
key
);

51 
LUAI_FUNC
 
TabË
 *
luaH_Ãw
 (
lua_S‹
 *
L
);

52 
LUAI_FUNC
 
luaH_»size
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
,

53 
nhsize
);

54 
LUAI_FUNC
 
luaH_»siz—¼ay
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
Çsize
);

55 
LUAI_FUNC
 
luaH_ä“
 (
lua_S‹
 *
L
, 
TabË
 *
t
);

56 
LUAI_FUNC
 
luaH_Ãxt
 (
lua_S‹
 *
L
, 
TabË
 *
t
, 
StkId
 
key
);

57 
LUAI_FUNC
 
luaH_g‘n
 (
TabË
 *
t
);

60 #ià
defšed
(
LUA_DEBUG
)

61 
LUAI_FUNC
 
Node
 *
luaH_mašpos™iÚ
 (cÚ¡ 
TabË
 *
t
, cÚ¡ 
TV®ue
 *
key
);

62 
LUAI_FUNC
 
luaH_isdummy
 (cÚ¡ 
TabË
 *
t
);

	@3rd/lua/ltablib.c

7 
	#Éablib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<lim™s.h
>

14 
	~<¡ddef.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

27 
	#TAB_R
 1

	)

28 
	#TAB_W
 2

	)

29 
	#TAB_L
 4

	)

30 
	#TAB_RW
 (
TAB_R
 | 
TAB_W
è

	)

33 
	#aux_g‘n
(
L
,
n
,
w
è(
	`checkb
(L,‚, (wè| 
TAB_L
), 
	`luaL_Ën
(L,‚))

	)

36 
	$checkf›ld
 (
lua_S‹
 *
L
, cÚ¡ *
key
, 
n
) {

37 
	`lua_push¡ršg
(
L
, 
key
);

38  (
	`lua_¿wg‘
(
L
, -
n
è!ğ
LUA_TNIL
);

39 
	}
}

46 
	$checkb
 (
lua_S‹
 *
L
, 
¬g
, 
wh©
) {

47 ià(
	`lua_ty³
(
L
, 
¬g
è!ğ
LUA_TTABLE
) {

48 
n
 = 1;

49 ià(
	`lua_g‘m‘©abË
(
L
, 
¬g
) &&

50 (!(
wh©
 & 
TAB_R
è|| 
	`checkf›ld
(
L
, "__šdex", ++
n
)) &&

51 (!(
wh©
 & 
TAB_W
è|| 
	`checkf›ld
(
L
, "__Ãwšdex", ++
n
)) &&

52 (!(
wh©
 & 
TAB_L
è|| 
	`checkf›ld
(
L
, "__Ën", ++
n
))) {

53 
	`lua_pİ
(
L
, 
n
);

56 
	`luaL_checkty³
(
L
, 
¬g
, 
LUA_TTABLE
);

58 
	}
}

61 #ià
defšed
(
LUA_COMPAT_MAXN
)

62 
	$maxn
 (
lua_S‹
 *
L
) {

63 
lua_Numb”
 
max
 = 0;

64 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

65 
	`lua_pushn
(
L
);

66 
	`lua_Ãxt
(
L
, 1)) {

67 
	`lua_pİ
(
L
, 1);

68 ià(
	`lua_ty³
(
L
, -1è=ğ
LUA_TNUMBER
) {

69 
lua_Numb”
 
v
 = 
	`lua_tÚumb”
(
L
, -1);

70 ià(
v
 > 
max
) max = v;

73 
	`lua_pushnumb”
(
L
, 
max
);

75 
	}
}

79 
	$tš£¹
 (
lua_S‹
 *
L
) {

80 
lua_IÁeg”
 
e
 = 
	`aux_g‘n
(
L
, 1, 
TAB_RW
) + 1;

81 
lua_IÁeg”
 
pos
;

82 
	`lua_g‘tİ
(
L
)) {

84 
pos
 = 
e
;

88 
lua_IÁeg”
 
i
;

89 
pos
 = 
	`luaL_checkš‹g”
(
L
, 2);

90 
	`luaL_¬gcheck
(
L
, 1 <ğ
pos
 &&…o <ğ
e
, 2, "position out of bounds");

91 
i
 = 
e
; i > 
pos
; i--) {

92 
	`lua_g‘i
(
L
, 1, 
i
 - 1);

93 
	`lua_£ti
(
L
, 1, 
i
);

98  
	`luaL_”rÜ
(
L
, "wrong‚umber of‡rgumentso 'insert'");

101 
	`lua_£ti
(
L
, 1, 
pos
);

103 
	}
}

106 
	$Œemove
 (
lua_S‹
 *
L
) {

107 
lua_IÁeg”
 
size
 = 
	`aux_g‘n
(
L
, 1, 
TAB_RW
);

108 
lua_IÁeg”
 
pos
 = 
	`luaL_İtš‹g”
(
L
, 2, 
size
);

109 ià(
pos
 !ğ
size
)

110 
	`luaL_¬gcheck
(
L
, 1 <ğ
pos
 &&…o <ğ
size
 + 1, 1, "position out of bounds");

111 
	`lua_g‘i
(
L
, 1, 
pos
);

112  ; 
pos
 < 
size
;…os++) {

113 
	`lua_g‘i
(
L
, 1, 
pos
 + 1);

114 
	`lua_£ti
(
L
, 1, 
pos
);

116 
	`lua_pushn
(
L
);

117 
	`lua_£ti
(
L
, 1, 
pos
);

119 
	}
}

128 
	$tmove
 (
lua_S‹
 *
L
) {

129 
lua_IÁeg”
 
f
 = 
	`luaL_checkš‹g”
(
L
, 2);

130 
lua_IÁeg”
 
e
 = 
	`luaL_checkš‹g”
(
L
, 3);

131 
lua_IÁeg”
 
t
 = 
	`luaL_checkš‹g”
(
L
, 4);

132 
‰
 = !
	`lua_i¢ÚeÜn
(
L
, 5) ? 5 : 1;

133 
	`checkb
(
L
, 1, 
TAB_R
);

134 
	`checkb
(
L
, 
‰
, 
TAB_W
);

135 ià(
e
 >ğ
f
) {

136 
lua_IÁeg”
 
n
, 
i
;

137 
	`luaL_¬gcheck
(
L
, 
f
 > 0 || 
e
 < 
LUA_MAXINTEGER
 + f, 3,

139 
n
 = 
e
 - 
f
 + 1;

140 
	`luaL_¬gcheck
(
L
, 
t
 <ğ
LUA_MAXINTEGER
 - 
n
 + 1, 4,

142 ià(
t
 > 
e
 || <ğ
f
 || (
‰
 !ğ1 && !
	`lua_com·»
(
L
, 1,t, 
LUA_OPEQ
))) {

143 
i
 = 0; i < 
n
; i++) {

144 
	`lua_g‘i
(
L
, 1, 
f
 + 
i
);

145 
	`lua_£ti
(
L
, 
‰
, 
t
 + 
i
);

149 
i
 = 
n
 - 1; i >= 0; i--) {

150 
	`lua_g‘i
(
L
, 1, 
f
 + 
i
);

151 
	`lua_£ti
(
L
, 
‰
, 
t
 + 
i
);

155 
	`lua_pushv®ue
(
L
, 
‰
);

157 
	}
}

160 
	$addf›ld
 (
lua_S‹
 *
L
, 
luaL_Bufãr
 *
b
, 
lua_IÁeg”
 
i
) {

161 
	`lua_g‘i
(
L
, 1, 
i
);

162 ià(!
	`lua_is¡ršg
(
L
, -1))

163 
	`luaL_”rÜ
(
L
, "invalid value (%s)‡t index %d inable for 'concat'",

164 
	`luaL_ty³Çme
(
L
, -1), 
i
);

165 
	`luaL_addv®ue
(
b
);

166 
	}
}

169 
	$tcÚÿt
 (
lua_S‹
 *
L
) {

170 
luaL_Bufãr
 
b
;

171 
lua_IÁeg”
 
Ï¡
 = 
	`aux_g‘n
(
L
, 1, 
TAB_R
);

172 
size_t
 
l£p
;

173 cÚ¡ *
£p
 = 
	`luaL_İ¡ršg
(
L
, 2, "", &
l£p
);

174 
lua_IÁeg”
 
i
 = 
	`luaL_İtš‹g”
(
L
, 3, 1);

175 
Ï¡
 = 
	`luaL_İtš‹g”
(
L
, 4,†ast);

176 
	`luaL_buffš™
(
L
, &
b
);

177 ; 
i
 < 
Ï¡
; i++) {

178 
	`addf›ld
(
L
, &
b
, 
i
);

179 
	`luaL_addl¡ršg
(&
b
, 
£p
, 
l£p
);

181 ià(
i
 =ğ
Ï¡
)

182 
	`addf›ld
(
L
, &
b
, 
i
);

183 
	`luaL_push»suÉ
(&
b
);

185 
	}
}

194 
	$·ck
 (
lua_S‹
 *
L
) {

195 
i
;

196 
n
 = 
	`lua_g‘tİ
(
L
);

197 
	`lua_ü—‹bË
(
L
, 
n
, 1);

198 
	`lua_š£¹
(
L
, 1);

199 
i
 = 
n
; i >= 1; i--)

200 
	`lua_£ti
(
L
, 1, 
i
);

201 
	`lua_pushš‹g”
(
L
, 
n
);

202 
	`lua_£tf›ld
(
L
, 1, "n");

204 
	}
}

207 
	$uÅack
 (
lua_S‹
 *
L
) {

208 
lua_UnsigÃd
 
n
;

209 
lua_IÁeg”
 
i
 = 
	`luaL_İtš‹g”
(
L
, 2, 1);

210 
lua_IÁeg”
 
e
 = 
	`luaL_İt
(
L
, 
luaL_checkš‹g”
, 3, 
	`luaL_Ën
(L, 1));

211 ià(
i
 > 
e
)  0;

212 
n
 = (
lua_UnsigÃd
)
e
 - 
i
;

213 ià(
n
 >ğ()
INT_MAX
 || !
	`lua_check¡ack
(
L
, ()(++n)))

214  
	`luaL_”rÜ
(
L
, "too many„esultso unpack");

215 ; 
i
 < 
e
; i++) {

216 
	`lua_g‘i
(
L
, 1, 
i
);

218 
	`lua_g‘i
(
L
, 1, 
e
);

219  ()
n
;

220 
	}
}

236 
	tIdxT
;

245 #ià!
defšed
(
l_¿ndomizePivÙ
)

247 
	~<time.h
>

250 
	#sof
(
e
è(Óè/ ())

	)

258 
	$l_¿ndomizePivÙ
 () {

259 
şock_t
 
c
 = 
	`şock
();

260 
time_t
 
t
 = 
	`time
(
NULL
);

261 
buff
[
	`sof
(
c
è+ sof(
t
)];

262 
i
, 
ºd
 = 0;

263 
	`memıy
(
buff
, &
c
, 
	`sof
(c) * ());

264 
	`memıy
(
buff
 + 
	`sof
(
c
), &
t
, sof(t) * ());

265 
i
 = 0; i < 
	`sof
(
buff
); i++)

266 
ºd
 +ğ
buff
[
i
];

267  
ºd
;

268 
	}
}

274 
	#RANLIMIT
 100u

	)

277 
	$£t2
 (
lua_S‹
 *
L
, 
IdxT
 
i
, IdxT 
j
) {

278 
	`lua_£ti
(
L
, 1, 
i
);

279 
	`lua_£ti
(
L
, 1, 
j
);

280 
	}
}

287 
	$sÜt_comp
 (
lua_S‹
 *
L
, 
a
, 
b
) {

288 ià(
	`lua_i¢
(
L
, 2))

289  
	`lua_com·»
(
L
, 
a
, 
b
, 
LUA_OPLT
);

291 
»s
;

292 
	`lua_pushv®ue
(
L
, 2);

293 
	`lua_pushv®ue
(
L
, 
a
-1);

294 
	`lua_pushv®ue
(
L
, 
b
-2);

295 
	`lua_ÿÎ
(
L
, 2, 1);

296 
»s
 = 
	`lua_toboŞ—n
(
L
, -1);

297 
	`lua_pİ
(
L
, 1);

298  
»s
;

300 
	}
}

310 
IdxT
 
	$·¹™iÚ
 (
lua_S‹
 *
L
, 
IdxT
 
lo
, IdxT 
up
) {

311 
IdxT
 
i
 = 
lo
;

312 
IdxT
 
j
 = 
up
 - 1;

316 
	`lua_g‘i
(
L
, 1, ++
i
), 
	`sÜt_comp
(L, -1, -2)) {

317 ià(
i
 =ğ
up
 - 1)

318 
	`luaL_”rÜ
(
L
, "invalid order function for sorting");

319 
	`lua_pİ
(
L
, 1);

323 
	`lua_g‘i
(
L
, 1, --
j
), 
	`sÜt_comp
(L, -3, -1)) {

324 ià(
j
 < 
i
)

325 
	`luaL_”rÜ
(
L
, "invalid order function for sorting");

326 
	`lua_pİ
(
L
, 1);

329 ià(
j
 < 
i
) {

331 
	`lua_pİ
(
L
, 1);

333 
	`£t2
(
L
, 
up
 - 1, 
i
);

334  
i
;

337 
	`£t2
(
L
, 
i
, 
j
);

339 
	}
}

346 
IdxT
 
	$choo£PivÙ
 (
IdxT
 
lo
, IdxT 
up
, 
ºd
) {

347 
IdxT
 
r4
 = (
up
 - 
lo
) / 4;

348 
IdxT
 
p
 = 
ºd
 % (
r4
 * 2è+ (
lo
 +„4);

349 
	`lua_as£¹
(
lo
 + 
r4
 <ğ
p
 &&… <ğ
up
 -„4);

350  
p
;

351 
	}
}

357 
	$auxsÜt
 (
lua_S‹
 *
L
, 
IdxT
 
lo
, IdxT 
up
,

358 
ºd
) {

359 
lo
 < 
up
) {

360 
IdxT
 
p
;

361 
IdxT
 
n
;

363 
	`lua_g‘i
(
L
, 1, 
lo
);

364 
	`lua_g‘i
(
L
, 1, 
up
);

365 ià(
	`sÜt_comp
(
L
, -1, -2))

366 
	`£t2
(
L
, 
lo
, 
up
);

368 
	`lua_pİ
(
L
, 2);

369 ià(
up
 - 
lo
 == 1)

371 ià(
up
 - 
lo
 < 
RANLIMIT
 || 
ºd
 == 0)

372 
p
 = (
lo
 + 
up
)/2;

374 
p
 = 
	`choo£PivÙ
(
lo
, 
up
, 
ºd
);

375 
	`lua_g‘i
(
L
, 1, 
p
);

376 
	`lua_g‘i
(
L
, 1, 
lo
);

377 ià(
	`sÜt_comp
(
L
, -2, -1))

378 
	`£t2
(
L
, 
p
, 
lo
);

380 
	`lua_pİ
(
L
, 1);

381 
	`lua_g‘i
(
L
, 1, 
up
);

382 ià(
	`sÜt_comp
(
L
, -1, -2))

383 
	`£t2
(
L
, 
p
, 
up
);

385 
	`lua_pİ
(
L
, 2);

387 ià(
up
 - 
lo
 == 2)

389 
	`lua_g‘i
(
L
, 1, 
p
);

390 
	`lua_pushv®ue
(
L
, -1);

391 
	`lua_g‘i
(
L
, 1, 
up
 - 1);

392 
	`£t2
(
L
, 
p
, 
up
 - 1);

393 
p
 = 
	`·¹™iÚ
(
L
, 
lo
, 
up
);

395 ià(
p
 - 
lo
 < 
up
 -…) {

396 
	`auxsÜt
(
L
, 
lo
, 
p
 - 1, 
ºd
);

397 
n
 = 
p
 - 
lo
;

398 
lo
 = 
p
 + 1;

401 
	`auxsÜt
(
L
, 
p
 + 1, 
up
, 
ºd
);

402 
n
 = 
up
 - 
p
;

403 
up
 = 
p
 - 1;

405 ià((
up
 - 
lo
è/ 128 > 
n
)

406 
ºd
 = 
	`l_¿ndomizePivÙ
();

408 
	}
}

411 
	$sÜt
 (
lua_S‹
 *
L
) {

412 
lua_IÁeg”
 
n
 = 
	`aux_g‘n
(
L
, 1, 
TAB_RW
);

413 ià(
n
 > 1) {

414 
	`luaL_¬gcheck
(
L
, 
n
 < 
INT_MAX
, 1, "arrayoo big");

415 ià(!
	`lua_i¢ÚeÜn
(
L
, 2))

416 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

417 
	`lua_£‰İ
(
L
, 2);

418 
	`auxsÜt
(
L
, 1, (
IdxT
)
n
, 0);

421 
	}
}

426 cÚ¡ 
luaL_Reg
 
	gb_funcs
[] = {

427 {"cÚÿt", 
tcÚÿt
},

428 #ià
defšed
(
LUA_COMPAT_MAXN
)

429 {"maxn", 
maxn
},

431 {"š£¹", 
tš£¹
},

432 {"·ck", 
·ck
},

433 {"uÅack", 
uÅack
},

434 {"»move", 
Œemove
},

435 {"move", 
tmove
},

436 {"sÜt", 
sÜt
},

437 {
NULL
, NULL}

441 
LUAMOD_API
 
	$luaİ’_bË
 (
lua_S‹
 *
L
) {

442 
	`luaL_Ãwlib
(
L
, 
b_funcs
);

443 #ià
	`defšed
(
LUA_COMPAT_UNPACK
)

445 
	`lua_g‘f›ld
(
L
, -1, "unpack");

446 
	`lua_£tglob®
(
L
, "unpack");

449 
	}
}

	@3rd/lua/ltm.c

7 
	#Ém_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lobjeù.h
"

20 
	~"l¡©e.h
"

21 
	~"l¡ršg.h
"

22 
	~"ÉabË.h
"

23 
	~"Ém.h
"

24 
	~"lvm.h
"

27 cÚ¡ 
	gud©©y³Çme
[] = "userdata";

29 
LUAI_DDEF
 cÚ¡ *cÚ¡ 
	gluaT_ty³Çmes_
[
LUA_TOTALTAGS
] = {

31 "n", "boŞ—n", 
ud©©y³Çme
, "number",

32 "¡ršg", "bË", "funùiÚ", 
ud©©y³Çme
, "thread",

37 
	$luaT_š™
 (
lua_S‹
 *
L
) {

38 cÚ¡ *cÚ¡ 
luaT_ev’Šame
[] = {

47 
i
;

48 
i
=0; i<
TM_N
; i++) {

49 
	`G
(
L
)->
tmÇme
[
i
] = 
	`luaS_Ãw
(L, 
luaT_ev’Šame
[i]);

50 
	`luaC_fix
(
L
, 
	`obj2gco
(
	`G
(L)->
tmÇme
[
i
]));

52 
	}
}

59 cÚ¡ 
TV®ue
 *
	$luaT_g‘tm
 (
TabË
 *
ev’ts
, 
TMS
 
ev’t
, 
TSŒšg
 *
’ame
) {

60 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaH_g‘shÜt¡r
(
ev’ts
, 
’ame
);

61 
	`lua_as£¹
(
ev’t
 <ğ
TM_EQ
);

62 ià(
	`‰i¢
(
tm
)) {

63 
ev’ts
->
æags
 |ğ
	`ÿ¡_by‹
(1u<<
ev’t
);

64  
NULL
;

66  
tm
;

67 
	}
}

70 cÚ¡ 
TV®ue
 *
	$luaT_g‘tmbyobj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
, 
TMS
 
ev’t
) {

71 
TabË
 *
mt
;

72 
	`‰nov
(
o
)) {

73 
LUA_TTABLE
:

74 
mt
 = 
	`hv®ue
(
o
)->
m‘©abË
;

76 
LUA_TUSERDATA
:

77 
mt
 = 
	`uv®ue
(
o
)->
m‘©abË
;

80 
mt
 = 
	`G
(
L
)->mt[
	`‰nov
(
o
)];

82  (
mt
 ? 
	`luaH_g‘shÜt¡r
(mt, 
	`G
(
L
)->
tmÇme
[
ev’t
]è: 
luaO_nobjeù
);

83 
	}
}

90 cÚ¡ *
	$luaT_objty³Çme
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
) {

91 
TabË
 *
mt
;

92 ià((
	`‰i¡abË
(
o
è&& (
mt
 = 
	`hv®ue
(o)->
m‘©abË
è!ğ
NULL
) ||

93 (
	`‰isfuÎu£rd©a
(
o
è&& (
mt
 = 
	`uv®ue
(o)->
m‘©abË
è!ğ
NULL
)) {

94 cÚ¡ 
TV®ue
 *
Çme
 = 
	`luaH_g‘shÜt¡r
(
mt
, 
	`luaS_Ãw
(
L
, "__name"));

95 ià(
	`‰is¡ršg
(
Çme
))

96  
	`g‘¡r
(
	`tsv®ue
(
Çme
));

98  
	`‰y³Çme
(
	`‰nov
(
o
));

99 
	}
}

102 
	$luaT_ÿÎTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
f
, cÚ¡ TV®u*
p1
,

103 cÚ¡ 
TV®ue
 *
p2
, TV®u*
p3
, 
ha¤es
) {

104 
±rdiff_t
 
»suÉ
 = 
	`§ve¡ack
(
L
, 
p3
);

105 
StkId
 
func
 = 
L
->
tİ
;

106 
	`£tobj2s
(
L
, 
func
, 
f
);

107 
	`£tobj2s
(
L
, 
func
 + 1, 
p1
);

108 
	`£tobj2s
(
L
, 
func
 + 2, 
p2
);

109 
L
->
tİ
 += 3;

110 ià(!
ha¤es
)

111 
	`£tobj2s
(
L
, L->
tİ
++, 
p3
);

113 ià(
	`isLua
(
L
->
ci
))

114 
	`luaD_ÿÎ
(
L
, 
func
, 
ha¤es
);

116 
	`luaD_ÿÎnoy›ld
(
L
, 
func
, 
ha¤es
);

117 ià(
ha¤es
) {

118 
p3
 = 
	`»¡Üe¡ack
(
L
, 
»suÉ
);

119 
	`£tobjs2s
(
L
, 
p3
, --L->
tİ
);

121 
	}
}

124 
	$luaT_ÿÎbšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

125 
StkId
 
»s
, 
TMS
 
ev’t
) {

126 cÚ¡ 
TV®ue
 *
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
p1
, 
ev’t
);

127 ià(
	`‰i¢
(
tm
))

128 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
p2
, 
ev’t
);

129 ià(
	`‰i¢
(
tm
))  0;

130 
	`luaT_ÿÎTM
(
L
, 
tm
, 
p1
, 
p2
, 
»s
, 1);

132 
	}
}

135 
	$luaT_ŒybšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

136 
StkId
 
»s
, 
TMS
 
ev’t
) {

137 ià(!
	`luaT_ÿÎbšTM
(
L
, 
p1
, 
p2
, 
»s
, 
ev’t
)) {

138 
ev’t
) {

139 
TM_CONCAT
:

140 
	`luaG_cÚÿ‹¼Ü
(
L
, 
p1
, 
p2
);

142 
TM_BAND
: 
TM_BOR
: 
TM_BXOR
:

143 
TM_SHL
: 
TM_SHR
: 
TM_BNOT
: {

144 
lua_Numb”
 
dummy
;

145 ià(
	`tÚumb”
(
p1
, &
dummy
è&&Úumb”(
p2
, &dummy))

146 
	`luaG_toš‹¼Ü
(
L
, 
p1
, 
p2
);

148 
	`luaG_İš‹¼Ü
(
L
, 
p1
, 
p2
, "perform bitwise operation on");

152 
	`luaG_İš‹¼Ü
(
L
, 
p1
, 
p2
, "perform‡rithmetic on");

155 
	}
}

158 
	$luaT_ÿÎÜd”TM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

159 
TMS
 
ev’t
) {

160 ià(!
	`luaT_ÿÎbšTM
(
L
, 
p1
, 
p2
, L->
tİ
, 
ev’t
))

163  !
	`l_isçl£
(
L
->
tİ
);

164 
	}
}

	@3rd/lua/ltm.h

7 #iâdeà
Ém_h


8 
	#Ém_h


	)

11 
	~"lobjeù.h
"

19 
	mTM_INDEX
,

20 
	mTM_NEWINDEX
,

21 
	mTM_GC
,

22 
	mTM_MODE
,

23 
	mTM_LEN
,

24 
	mTM_EQ
,

25 
	mTM_ADD
,

26 
	mTM_SUB
,

27 
	mTM_MUL
,

28 
	mTM_MOD
,

29 
	mTM_POW
,

30 
	mTM_DIV
,

31 
	mTM_IDIV
,

32 
	mTM_BAND
,

33 
	mTM_BOR
,

34 
	mTM_BXOR
,

35 
	mTM_SHL
,

36 
	mTM_SHR
,

37 
	mTM_UNM
,

38 
	mTM_BNOT
,

39 
	mTM_LT
,

40 
	mTM_LE
,

41 
	mTM_CONCAT
,

42 
	mTM_CALL
,

43 
	mTM_N


44 } 
	tTMS
;

48 
	#gç¡tm
(
g
,
‘
,
e
è(Ótè=ğ
NULL
 ? NULL : \

49 ((
‘
)->
æags
 & (1u<<(
e
))è? 
NULL
 : 
	`luaT_g‘tm
Ót,ƒ, (
g
)->
tmÇme
[e]))

	)

51 
	#ç¡tm
(
l
,
‘
,
e
è
	`gç¡tm
(
	`G
Ö),ƒt,ƒ)

	)

53 
	#‰y³Çme
(
x
è
luaT_ty³Çmes_
[(xè+ 1]

	)

55 
LUAI_DDEC
 cÚ¡ *cÚ¡ 
	gluaT_ty³Çmes_
[
LUA_TOTALTAGS
];

58 
LUAI_FUNC
 cÚ¡ *
luaT_objty³Çme
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
o
);

60 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaT_g‘tm
 (
TabË
 *
ev’ts
, 
TMS
 
ev’t
, 
TSŒšg
 *
’ame
);

61 
LUAI_FUNC
 cÚ¡ 
TV®ue
 *
luaT_g‘tmbyobj
 (
lua_S‹
 *
L
, cÚ¡ TV®u*
o
,

62 
TMS
 
ev’t
);

63 
LUAI_FUNC
 
luaT_š™
 (
lua_S‹
 *
L
);

65 
LUAI_FUNC
 
luaT_ÿÎTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
f
, cÚ¡ TV®u*
p1
,

66 cÚ¡ 
TV®ue
 *
p2
, TV®u*
p3
, 
ha¤es
);

67 
LUAI_FUNC
 
luaT_ÿÎbšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

68 
StkId
 
»s
, 
TMS
 
ev’t
);

69 
LUAI_FUNC
 
luaT_ŒybšTM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
, cÚ¡ TV®u*
p2
,

70 
StkId
 
»s
, 
TMS
 
ev’t
);

71 
LUAI_FUNC
 
luaT_ÿÎÜd”TM
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
p1
,

72 cÚ¡ 
TV®ue
 *
p2
, 
TMS
 
ev’t
);

	@3rd/lua/lua.c

7 
	#lua_c


	)

9 
	~"Í»fix.h
"

12 
	~<sigÇl.h
>

13 
	~<¡dio.h
>

14 
	~<¡dlib.h
>

15 
	~<¡ršg.h
>

17 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

20 
	~"lu®ib.h
"

21 
	~"l¡ršg.h
"

25 #ià!
defšed
(
LUA_PROMPT
)

26 
	#LUA_PROMPT
 "> "

	)

27 
	#LUA_PROMPT2
 ">> "

	)

30 #ià!
defšed
(
LUA_PROGNAME
)

31 
	#LUA_PROGNAME
 "lua"

	)

34 #ià!
defšed
(
LUA_MAXINPUT
)

35 
	#LUA_MAXINPUT
 512

	)

38 #ià!
defšed
(
LUA_INIT_VAR
)

39 
	#LUA_INIT_VAR
 "LUA_INIT"

	)

42 
	#LUA_INITVARVERSION
 
LUA_INIT_VAR
 
LUA_VERSUFFIX


	)

49 #ià!
defšed
(
lua_¡dš_is_‰y
)

51 #ià
defšed
(
LUA_USE_POSIX
)

53 
	~<uni¡d.h
>

54 
	#lua_¡dš_is_‰y
(è
	`i§‰y
(0)

	)

56 #–ià
defšed
(
LUA_USE_WINDOWS
)

58 
	~<io.h
>

59 
	~<wšdows.h
>

61 
	#lua_¡dš_is_‰y
(è
	`_i§‰y
(
	`_f’o
(
¡dš
))

	)

66 
	#lua_¡dš_is_‰y
(è1

	)

79 #ià!
defšed
(
lua_»adlše
)

81 #ià
defšed
(
LUA_USE_READLINE
)

83 
	~<»adlše/»adlše.h
>

84 
	~<»adlše/hi¡Üy.h
>

85 
	#lua_»adlše
(
L
,
b
,
p
è(()L, ((b)=
	`»adlše
Õ)è!ğ
NULL
)

	)

86 
	#lua_§v–še
(
L
,
lše
è(()L, 
	`add_hi¡Üy
Öše))

	)

87 
	#lua_ä“lše
(
L
,
b
è(()L, 
	`ä“
(b))

	)

91 
	#lua_»adlše
(
L
,
b
,
p
) \

92 (()
L
, 
	`åuts
(
p
, 
¡dout
), 
	`fæush
(stdout), \

93 
	`fg‘s
(
b
, 
LUA_MAXINPUT
, 
¡dš
è!ğ
NULL
è

	)

94 
	#lua_§v–še
(
L
,
lše
è{ ()L; (îše; }

	)

95 
	#lua_ä“lše
(
L
,
b
è{ ()L; ()b; }

	)

104 
lua_S‹
 *
	gglob®L
 = 
NULL
;

106 cÚ¡ *
	g´ogÇme
 = 
LUA_PROGNAME
;

112 
	$l¡İ
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

113 ()
¬
;

114 
	`lua_£thook
(
L
, 
NULL
, 0, 0);

115 
	`luaL_”rÜ
(
L
, "interrupted!");

116 
	}
}

125 
	$ÏùiÚ
 (
i
) {

126 
	`sigÇl
(
i
, 
SIG_DFL
);

127 
	`lua_£thook
(
glob®L
, 
l¡İ
, 
LUA_MASKCALL
 | 
LUA_MASKRET
 | 
LUA_MASKCOUNT
, 1);

128 
	}
}

131 
	$´št_u§ge
 (cÚ¡ *
badİtiÚ
) {

132 
	`lua_wr™e¡ršg”rÜ
("%s: ", 
´ogÇme
);

133 ià(
badİtiÚ
[1] == 'e' || badoption[1] == 'l')

134 
	`lua_wr™e¡ršg”rÜ
("'%s'‚“d ¬gum’t\n", 
badİtiÚ
);

136 
	`lua_wr™e¡ršg”rÜ
("uÄecognized o±iÚ '%s'\n", 
badİtiÚ
);

137 
	`lua_wr™e¡ršg”rÜ
(

148 
´ogÇme
);

149 
	}
}

156 
	$l_mes§ge
 (cÚ¡ *
²ame
, cÚ¡ *
msg
) {

157 ià(
²ame
è
	`lua_wr™e¡ršg”rÜ
("%s: ",…name);

158 
	`lua_wr™e¡ršg”rÜ
("%s\n", 
msg
);

159 
	}
}

167 
	$»pÜt
 (
lua_S‹
 *
L
, 
¡©us
) {

168 ià(
¡©us
 !ğ
LUA_OK
) {

169 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, -1);

170 
	`l_mes§ge
(
´ogÇme
, 
msg
);

171 
	`lua_pİ
(
L
, 1);

173  
¡©us
;

174 
	}
}

180 
	$msghªdËr
 (
lua_S‹
 *
L
) {

181 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, 1);

182 ià(
msg
 =ğ
NULL
) {

183 ià(
	`luaL_ÿÎm‘a
(
L
, 1, "__tostring") &&

184 
	`lua_ty³
(
L
, -1è=ğ
LUA_TSTRING
)

187 
msg
 = 
	`lua_pushf¡ršg
(
L
, "(error object is‡ %s value)",

188 
	`luaL_ty³Çme
(
L
, 1));

190 
	`luaL_Œaûback
(
L
, L, 
msg
, 1);

192 
	}
}

199 
	$doÿÎ
 (
lua_S‹
 *
L
, 
Çrg
, 
Äes
) {

200 
¡©us
;

201 
ba£
 = 
	`lua_g‘tİ
(
L
è- 
Çrg
;

202 
	`lua_pushcfunùiÚ
(
L
, 
msghªdËr
);

203 
	`lua_š£¹
(
L
, 
ba£
);

204 
glob®L
 = 
L
;

205 
	`sigÇl
(
SIGINT
, 
ÏùiÚ
);

206 
¡©us
 = 
	`lua_pÿÎ
(
L
, 
Çrg
, 
Äes
, 
ba£
);

207 
	`sigÇl
(
SIGINT
, 
SIG_DFL
);

208 
	`lua_»move
(
L
, 
ba£
);

209  
¡©us
;

210 
	}
}

213 
	$´št_v”siÚ
 () {

214 
	`lua_wr™e¡ršg
(
LUA_COPYRIGHT
, 
	`¡¾’
(LUA_COPYRIGHT));

215 
	`lua_wr™–še
();

216 
	}
}

227 
	$ü—‹¬gbË
 (
lua_S‹
 *
L
, **
¬gv
, 
¬gc
, 
süt
) {

228 
i
, 
Çrg
;

229 ià(
süt
 =ğ
¬gc
) script = 0;

230 
Çrg
 = 
¬gc
 - (
süt
 + 1);

231 
	`lua_ü—‹bË
(
L
, 
Çrg
, 
süt
 + 1);

232 
i
 = 0; i < 
¬gc
; i++) {

233 
	`lua_push¡ršg
(
L
, 
¬gv
[
i
]);

234 
	`lua_¿w£ti
(
L
, -2, 
i
 - 
süt
);

236 
	`lua_£tglob®
(
L
, "arg");

237 
	}
}

240 
	$dochunk
 (
lua_S‹
 *
L
, 
¡©us
) {

241 ià(
¡©us
 =ğ
LUA_OK
è¡©u ğ
	`doÿÎ
(
L
, 0, 0);

242  
	`»pÜt
(
L
, 
¡©us
);

243 
	}
}

246 
	$dofe
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

247  
	`dochunk
(
L
, 
	`luaL_lßdfe
(L, 
Çme
));

248 
	}
}

251 
	$do¡ršg
 (
lua_S‹
 *
L
, cÚ¡ *
s
, cÚ¡ *
Çme
) {

252  
	`dochunk
(
L
, 
	`luaL_lßdbufãr
(L, 
s
, 
	`¡¾’
(s), 
Çme
));

253 
	}
}

260 
	$dŞib¿ry
 (
lua_S‹
 *
L
, cÚ¡ *
Çme
) {

261 
¡©us
;

262 
	`lua_g‘glob®
(
L
, "require");

263 
	`lua_push¡ršg
(
L
, 
Çme
);

264 
¡©us
 = 
	`doÿÎ
(
L
, 1, 1);

265 ià(
¡©us
 =ğ
LUA_OK
)

266 
	`lua_£tglob®
(
L
, 
Çme
);

267  
	`»pÜt
(
L
, 
¡©us
);

268 
	}
}

274 cÚ¡ *
	$g‘_´om±
 (
lua_S‹
 *
L
, 
fœ¡lše
) {

275 cÚ¡ *
p
;

276 
	`lua_g‘glob®
(
L
, 
fœ¡lše
 ? "_PROMPT" : "_PROMPT2");

277 
p
 = 
	`lua_to¡ršg
(
L
, -1);

278 ià(
p
 =ğ
NULL
è°ğ(
fœ¡lše
 ? 
LUA_PROMPT
 : 
LUA_PROMPT2
);

279  
p
;

280 
	}
}

283 
	#EOFMARK
 "<eof>"

	)

284 
	#m¬kËn
 ((
EOFMARK
)/(è- 1)

	)

292 
	$šcom¶‘e
 (
lua_S‹
 *
L
, 
¡©us
) {

293 ià(
¡©us
 =ğ
LUA_ERRSYNTAX
) {

294 
size_t
 
lmsg
;

295 cÚ¡ *
msg
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
lmsg
);

296 ià(
lmsg
 >ğ
m¬kËn
 && 
	`¡rcmp
(
msg
 +†msg - m¬kËn, 
EOFMARK
) == 0) {

297 
	`lua_pİ
(
L
, 1);

302 
	}
}

308 
	$pushlše
 (
lua_S‹
 *
L
, 
fœ¡lše
) {

309 
bufãr
[
LUA_MAXINPUT
];

310 *
b
 = 
bufãr
;

311 
size_t
 
l
;

312 cÚ¡ *
´mt
 = 
	`g‘_´om±
(
L
, 
fœ¡lše
);

313 
»ad¡©us
 = 
	`lua_»adlše
(
L
, 
b
, 
´mt
);

314 ià(
»ad¡©us
 == 0)

316 
	`lua_pİ
(
L
, 1);

317 
l
 = 
	`¡¾’
(
b
);

318 ià(
l
 > 0 && 
b
[l-1] == '\n')

319 
b
[--
l
] = '\0';

320 ià(
fœ¡lše
 && 
b
[0] == '=')

321 
	`lua_pushf¡ršg
(
L
, "»tuº %s", 
b
 + 1);

323 
	`lua_pushl¡ršg
(
L
, 
b
, 
l
);

324 
	`lua_ä“lše
(
L
, 
b
);

326 
	}
}

333 
	$add»tuº
 (
lua_S‹
 *
L
) {

334 cÚ¡ *
lše
 = 
	`lua_to¡ršg
(
L
, -1);

335 cÚ¡ *
»še
 = 
	`lua_pushf¡ršg
(
L
, "»tuº %s;", 
lše
);

336 
¡©us
 = 
	`luaL_lßdbufãr
(
L
, 
»še
, 
	`¡¾’
(retline), "=stdin");

337 ià(
¡©us
 =ğ
LUA_OK
) {

338 
	`lua_»move
(
L
, -2);

339 ià(
lše
[0] != '\0')

340 
	`lua_§v–še
(
L
, 
lše
);

343 
	`lua_pİ
(
L
, 2);

344  
¡©us
;

345 
	}
}

351 
	$muÉše
 (
lua_S‹
 *
L
) {

353 
size_t
 
Ën
;

354 cÚ¡ *
lše
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
Ën
);

355 
¡©us
 = 
	`luaL_lßdbufãr
(
L
, 
lše
, 
Ën
, "=stdin");

356 ià(!
	`šcom¶‘e
(
L
, 
¡©us
è|| !
	`pushlše
(L, 0)) {

357 
	`lua_§v–še
(
L
, 
lše
);

358  
¡©us
;

360 
	`lua_pushl™”®
(
L
, "\n");

361 
	`lua_š£¹
(
L
, -2);

362 
	`lua_cÚÿt
(
L
, 3);

364 
	}
}

373 
	$lßdlše
 (
lua_S‹
 *
L
) {

374 
¡©us
;

375 
	`lua_£‰İ
(
L
, 0);

376 ià(!
	`pushlše
(
L
, 1))

378 ià((
¡©us
 = 
	`add»tuº
(
L
)è!ğ
LUA_OK
)

379 
¡©us
 = 
	`muÉše
(
L
);

380 
	`lua_»move
(
L
, 1);

381 
	`lua_as£¹
(
	`lua_g‘tİ
(
L
) == 1);

382  
¡©us
;

383 
	}
}

389 
	$l_´št
 (
lua_S‹
 *
L
) {

390 
n
 = 
	`lua_g‘tİ
(
L
);

391 ià(
n
 > 0) {

392 
	`luaL_check¡ack
(
L
, 
LUA_MINSTACK
, "too many„esultso…rint");

393 
	`lua_g‘glob®
(
L
, "print");

394 
	`lua_š£¹
(
L
, 1);

395 ià(
	`lua_pÿÎ
(
L
, 
n
, 0, 0è!ğ
LUA_OK
)

396 
	`l_mes§ge
(
´ogÇme
, 
	`lua_pushf¡ršg
(
L
, "error calling 'print' (%s)",

397 
	`lua_to¡ršg
(
L
, -1)));

399 
	}
}

406 
	$doREPL
 (
lua_S‹
 *
L
) {

407 
¡©us
;

408 cÚ¡ *
Şd´ogÇme
 = 
´ogÇme
;

409 
´ogÇme
 = 
NULL
;

410 (
¡©us
 = 
	`lßdlše
(
L
)) != -1) {

411 ià(
¡©us
 =ğ
LUA_OK
)

412 
¡©us
 = 
	`doÿÎ
(
L
, 0, 
LUA_MULTRET
);

413 ià(
¡©us
 =ğ
LUA_OK
è
	`l_´št
(
L
);

414 
	`»pÜt
(
L
, 
¡©us
);

416 
	`lua_£‰İ
(
L
, 0);

417 
	`lua_wr™–še
();

418 
´ogÇme
 = 
Şd´ogÇme
;

419 
	}
}

425 
	$push¬gs
 (
lua_S‹
 *
L
) {

426 
i
, 
n
;

427 ià(
	`lua_g‘glob®
(
L
, "¬g"è!ğ
LUA_TTABLE
)

428 
	`luaL_”rÜ
(
L
, "'arg' is‚ot‡able");

429 
n
 = ()
	`luaL_Ën
(
L
, -1);

430 
	`luaL_check¡ack
(
L
, 
n
 + 3, "too many‡rgumentso script");

431 
i
 = 1; i <ğ
n
; i++)

432 
	`lua_¿wg‘i
(
L
, -
i
, i);

433 
	`lua_»move
(
L
, -
i
);

434  
n
;

435 
	}
}

438 
	$hªdË_süt
 (
lua_S‹
 *
L
, **
¬gv
) {

439 
¡©us
;

440 cÚ¡ *
âame
 = 
¬gv
[0];

441 ià(
	`¡rcmp
(
âame
, "-"è=ğ0 && sŒcmp(
¬gv
[-1], "--") != 0)

442 
âame
 = 
NULL
;

443 
¡©us
 = 
	`luaL_lßdfe
(
L
, 
âame
);

444 ià(
¡©us
 =ğ
LUA_OK
) {

445 
n
 = 
	`push¬gs
(
L
);

446 
¡©us
 = 
	`doÿÎ
(
L
, 
n
, 
LUA_MULTRET
);

448  
	`»pÜt
(
L
, 
¡©us
);

449 
	}
}

454 
	#has_”rÜ
 1

	)

455 
	#has_i
 2

	)

456 
	#has_v
 4

	)

457 
	#has_e
 8

	)

458 
	#has_E
 16

	)

466 
	$cŞËù¬gs
 (**
¬gv
, *
fœ¡
) {

467 
¬gs
 = 0;

468 
i
;

469 
i
 = 1; 
¬gv
[i] !ğ
NULL
; i++) {

470 *
fœ¡
 = 
i
;

471 ià(
¬gv
[
i
][0] != '-')

472  
¬gs
;

473 
¬gv
[
i
][1]) {

475 ià(
¬gv
[
i
][2] != '\0')

476  
has_”rÜ
;

477 *
fœ¡
 = 
i
 + 1;

478  
¬gs
;

480  
¬gs
;

482 ià(
¬gv
[
i
][2] != '\0')

483  
has_”rÜ
;

484 
¬gs
 |ğ
has_E
;

487 
¬gs
 |ğ
has_i
;

489 ià(
¬gv
[
i
][2] != '\0')

490  
has_”rÜ
;

491 
¬gs
 |ğ
has_v
;

494 
¬gs
 |ğ
has_e
;

496 ià(
¬gv
[
i
][2] == '\0') {

497 
i
++;

498 ià(
¬gv
[
i
] =ğ
NULL
 ||‡rgv[i][0] == '-')

499  
has_”rÜ
;

503  
has_”rÜ
;

506 *
fœ¡
 = 
i
;

507  
¬gs
;

508 
	}
}

515 
	$ruÇrgs
 (
lua_S‹
 *
L
, **
¬gv
, 
n
) {

516 
i
;

517 
i
 = 1; i < 
n
; i++) {

518 
İtiÚ
 = 
¬gv
[
i
][1];

519 
	`lua_as£¹
(
¬gv
[
i
][0] == '-');

520 ià(
İtiÚ
 == 'e' || option == 'l') {

521 
¡©us
;

522 cÚ¡ *
exŒa
 = 
¬gv
[
i
] + 2;

523 ià(*
exŒa
 =ğ'\0'èexŒ¨ğ
¬gv
[++
i
];

524 
	`lua_as£¹
(
exŒa
 !ğ
NULL
);

525 
¡©us
 = (
İtiÚ
 == 'e')

526 ? 
	`do¡ršg
(
L
, 
exŒa
, "=(command†ine)")

527 : 
	`dŞib¿ry
(
L
, 
exŒa
);

528 ià(
¡©us
 !ğ
LUA_OK
)  0;

532 
	}
}

536 
	$hªdË_luaš™
 (
lua_S‹
 *
L
) {

537 cÚ¡ *
Çme
 = "=" 
LUA_INITVARVERSION
;

538 cÚ¡ *
š™
 = 
	`g‘’v
(
Çme
 + 1);

539 ià(
š™
 =ğ
NULL
) {

540 
Çme
 = "=" 
LUA_INIT_VAR
;

541 
š™
 = 
	`g‘’v
(
Çme
 + 1);

543 ià(
š™
 =ğ
NULL
è 
LUA_OK
;

544 ià(
š™
[0] == '@')

545  
	`dofe
(
L
, 
š™
+1);

547  
	`do¡ršg
(
L
, 
š™
, 
Çme
);

548 
	}
}

555 
	$pmaš
 (
lua_S‹
 *
L
) {

556 
¬gc
 = ()
	`lua_toš‹g”
(
L
, 1);

557 **
¬gv
 = (**)
	`lua_tou£rd©a
(
L
, 2);

558 
süt
;

559 
¬gs
 = 
	`cŞËù¬gs
(
¬gv
, &
süt
);

560 
	`luaL_checkv”siÚ
(
L
);

561 ià(
¬gv
[0] &&‡rgv[0][0]è
´ogÇme
 =‡rgv[0];

562 ià(
¬gs
 =ğ
has_”rÜ
) {

563 
	`´št_u§ge
(
¬gv
[
süt
]);

566 ià(
¬gs
 & 
has_v
)

567 
	`´št_v”siÚ
();

568 ià(
¬gs
 & 
has_E
) {

569 
	`lua_pushboŞ—n
(
L
, 1);

570 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_NOENV");

572 
	`luaL_İ’libs
(
L
);

573 
	`ü—‹¬gbË
(
L
, 
¬gv
, 
¬gc
, 
süt
);

574 ià(!(
¬gs
 & 
has_E
)) {

575 ià(
	`hªdË_luaš™
(
L
è!ğ
LUA_OK
)

578 ià(!
	`ruÇrgs
(
L
, 
¬gv
, 
süt
))

580 ià(
süt
 < 
¬gc
 &&

581 
	`hªdË_süt
(
L
, 
¬gv
 + 
süt
è!ğ
LUA_OK
)

583 ià(
¬gs
 & 
has_i
)

584 
	`doREPL
(
L
);

585 ià(
süt
 =ğ
¬gc
 && !(
¬gs
 & (
has_e
 | 
has_v
))) {

586 ià(
	`lua_¡dš_is_‰y
()) {

587 
	`´št_v”siÚ
();

588 
	`doREPL
(
L
);

590 
	`dofe
(
L
, 
NULL
);

592 
	`lua_pushboŞ—n
(
L
, 1);

594 
	}
}

597 
	$maš
 (
¬gc
, **
¬gv
) {

598 
¡©us
, 
»suÉ
;

599 
lua_S‹
 *
L
;

600 
	`luaS_š™shr
();

601 
L
 = 
	`luaL_Ãw¡©e
();

602 ià(
L
 =ğ
NULL
) {

603 
	`l_mes§ge
(
¬gv
[0], "cannot create state:‚otƒnough memory");

604  
EXIT_FAILURE
;

606 
	`lua_pushcfunùiÚ
(
L
, &
pmaš
);

607 
	`lua_pushš‹g”
(
L
, 
¬gc
);

608 
	`lua_pushlightu£rd©a
(
L
, 
¬gv
);

609 
¡©us
 = 
	`lua_pÿÎ
(
L
, 2, 1, 0);

610 
»suÉ
 = 
	`lua_toboŞ—n
(
L
, -1);

611 
	`»pÜt
(
L
, 
¡©us
);

612 
	`lua_şo£
(
L
);

613 
	`luaS_ex™shr
();

614  (
»suÉ
 && 
¡©us
 =ğ
LUA_OK
è? 
EXIT_SUCCESS
 : 
EXIT_FAILURE
;

615 
	}
}

	@3rd/lua/lua.h

9 #iâdeà
lua_h


10 
	#lua_h


	)

12 
	~<¡d¬g.h
>

13 
	~<¡ddef.h
>

16 
	~"luacÚf.h
"

19 
	#LUA_VERSION_MAJOR
 "5"

	)

20 
	#LUA_VERSION_MINOR
 "3"

	)

21 
	#LUA_VERSION_NUM
 503

	)

22 
	#LUA_VERSION_RELEASE
 "4"

	)

24 
	#LUA_VERSION
 "Lu¨" 
LUA_VERSION_MAJOR
 "." 
LUA_VERSION_MINOR


	)

25 
	#LUA_RELEASE
 
LUA_VERSION
 "." 
LUA_VERSION_RELEASE


	)

26 
	#LUA_COPYRIGHT
 
LUA_RELEASE
 " Cİyrighˆ(Cè1994-2017 Lua.Üg, PUC-Rio"

	)

27 
	#LUA_AUTHORS
 "R. I”u§limschy, L. H. dFigueœedo, W. C–es"

	)

31 
	#LUA_SIGNATURE
 "\x1bLua"

	)

34 
	#LUA_MULTRET
 (-1)

	)

42 
	#LUA_REGISTRYINDEX
 (-
LUAI_MAXSTACK
 - 1000)

	)

43 
	#lua_upv®uešdex
(
i
è(
LUA_REGISTRYINDEX
 - (i))

	)

47 
	#LUA_OK
 0

	)

48 
	#LUA_YIELD
 1

	)

49 
	#LUA_ERRRUN
 2

	)

50 
	#LUA_ERRSYNTAX
 3

	)

51 
	#LUA_ERRMEM
 4

	)

52 
	#LUA_ERRGCMM
 5

	)

53 
	#LUA_ERRERR
 6

	)

56 
lua_S‹
 
	tlua_S‹
;

62 
	#LUA_TNONE
 (-1)

	)

64 
	#LUA_TNIL
 0

	)

65 
	#LUA_TBOOLEAN
 1

	)

66 
	#LUA_TLIGHTUSERDATA
 2

	)

67 
	#LUA_TNUMBER
 3

	)

68 
	#LUA_TSTRING
 4

	)

69 
	#LUA_TTABLE
 5

	)

70 
	#LUA_TFUNCTION
 6

	)

71 
	#LUA_TUSERDATA
 7

	)

72 
	#LUA_TTHREAD
 8

	)

74 
	#LUA_NUMTAGS
 9

	)

79 
	#LUA_MINSTACK
 20

	)

83 
	#LUA_RIDX_MAINTHREAD
 1

	)

84 
	#LUA_RIDX_GLOBALS
 2

	)

85 
	#LUA_RIDX_LAST
 
LUA_RIDX_GLOBALS


	)

89 
LUA_NUMBER
 
	tlua_Numb”
;

93 
LUA_INTEGER
 
	tlua_IÁeg”
;

96 
LUA_UNSIGNED
 
	tlua_UnsigÃd
;

99 
LUA_KCONTEXT
 
	tlua_KCÚ‹xt
;

105 (*
	tlua_CFunùiÚ
è(
	tlua_S‹
 *
	tL
);

110 (*
	tlua_KFunùiÚ
è(
	tlua_S‹
 *
	tL
, 
	t¡©us
, 
	tlua_KCÚ‹xt
 
	tùx
);

116 cÚ¡ * (*
	tlua_R—d”
è(
	tlua_S‹
 *
	tL
, *
	tud
, 
	tsize_t
 *
	tsz
);

118 (*
	tlua_Wr™”
è(
	tlua_S‹
 *
	tL
, cÚ¡ *
	tp
, 
	tsize_t
 
	tsz
, *
	tud
);

124 * (*
	tlua_AÎoc
è(*
	tud
, *
	t±r
, 
	tsize_t
 
	tosize
, size_ˆ
	tnsize
);

131 #ià
	`defšed
(
LUA_USER_H
)

132 #šşud
LUA_USER_H


139 cÚ¡ 
lua_id’t
[];

145 
LUA_API
 
lua_S‹
 *(
lua_Ãw¡©e
è(
lua_AÎoc
 
f
, *
ud
);

146 
LUA_API
 (
lua_şo£
è(
lua_S‹
 *
L
);

147 
LUA_API
 
lua_S‹
 *(
lua_Ãwth»ad
èÖua_S‹ *
L
);

149 
LUA_API
 
	$lua_CFunùiÚ
 (
lua_©·nic
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
·nicf
);

152 
LUA_API
 cÚ¡ 
lua_Numb”
 *(
lua_v”siÚ
è(
lua_S‹
 *
L
);

158 
LUA_API
 (
lua_absšdex
è(
lua_S‹
 *
L
, 
idx
);

159 
LUA_API
 (
lua_g‘tİ
è(
lua_S‹
 *
L
);

160 
LUA_API
 (
lua_£‰İ
è(
lua_S‹
 *
L
, 
idx
);

161 
LUA_API
 (
lua_pushv®ue
è(
lua_S‹
 *
L
, 
idx
);

162 
LUA_API
 (
lua_rÙ©e
è(
lua_S‹
 *
L
, 
idx
, 
n
);

163 
LUA_API
 (
lua_cİy
è(
lua_S‹
 *
L
, 
äomidx
, 
toidx
);

164 
LUA_API
 (
lua_check¡ack
è(
lua_S‹
 *
L
, 
n
);

166 
LUA_API
 (
lua_xmove
è(
lua_S‹
 *
äom
,†ua_S‹ *
to
, 
n
);

173 
LUA_API
 (
lua_i¢umb”
è(
lua_S‹
 *
L
, 
idx
);

174 
LUA_API
 (
lua_is¡ršg
è(
lua_S‹
 *
L
, 
idx
);

175 
LUA_API
 (
lua_iscfunùiÚ
è(
lua_S‹
 *
L
, 
idx
);

176 
LUA_API
 (
lua_isš‹g”
è(
lua_S‹
 *
L
, 
idx
);

177 
LUA_API
 (
lua_isu£rd©a
è(
lua_S‹
 *
L
, 
idx
);

178 
LUA_API
 (
lua_ty³
è(
lua_S‹
 *
L
, 
idx
);

179 
LUA_API
 cÚ¡ *(
lua_ty³Çme
è(
lua_S‹
 *
L
, 

);

181 
LUA_API
 
	$lua_Numb”
 (
lua_tÚumb”x
è(
lua_S‹
 *
L
, 
idx
, *
i¢um
);

182 
LUA_API
 
	$lua_IÁeg”
 (
lua_toš‹g”x
è(
lua_S‹
 *
L
, 
idx
, *
i¢um
);

183 
LUA_API
 (
lua_toboŞ—n
è(
lua_S‹
 *
L
, 
idx
);

184 
LUA_API
 cÚ¡ *(
lua_tŞ¡ršg
è(
lua_S‹
 *
L
, 
idx
, 
size_t
 *
Ën
);

185 
LUA_API
 
	$size_t
 (
lua_¿wËn
è(
lua_S‹
 *
L
, 
idx
);

186 
LUA_API
 
	$lua_CFunùiÚ
 (
lua_tocfunùiÚ
è(
lua_S‹
 *
L
, 
idx
);

187 
LUA_API
 *(
lua_tou£rd©a
è(
lua_S‹
 *
L
, 
idx
);

188 
LUA_API
 
lua_S‹
 *(
lua_tÙh»ad
èÖua_S‹ *
L
, 
idx
);

189 
LUA_API
 cÚ¡ *(
lua_tİoš‹r
è(
lua_S‹
 *
L
, 
idx
);

196 
	#LUA_OPADD
 0

	)

197 
	#LUA_OPSUB
 1

	)

198 
	#LUA_OPMUL
 2

	)

199 
	#LUA_OPMOD
 3

	)

200 
	#LUA_OPPOW
 4

	)

201 
	#LUA_OPDIV
 5

	)

202 
	#LUA_OPIDIV
 6

	)

203 
	#LUA_OPBAND
 7

	)

204 
	#LUA_OPBOR
 8

	)

205 
	#LUA_OPBXOR
 9

	)

206 
	#LUA_OPSHL
 10

	)

207 
	#LUA_OPSHR
 11

	)

208 
	#LUA_OPUNM
 12

	)

209 
	#LUA_OPBNOT
 13

	)

211 
LUA_API
 (
lua_¬™h
è(
lua_S‹
 *
L
, 
İ
);

213 
	#LUA_OPEQ
 0

	)

214 
	#LUA_OPLT
 1

	)

215 
	#LUA_OPLE
 2

	)

217 
LUA_API
 (
lua_¿wequ®
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
);

218 
LUA_API
 (
lua_com·»
è(
lua_S‹
 *
L
, 
idx1
, 
idx2
, 
İ
);

224 
LUA_API
 (
lua_pushn
è(
lua_S‹
 *
L
);

225 
LUA_API
 (
lua_pushnumb”
è(
lua_S‹
 *
L
, 
lua_Numb”
 
n
);

226 
LUA_API
 (
lua_pushš‹g”
è(
lua_S‹
 *
L
, 
lua_IÁeg”
 
n
);

227 
LUA_API
 cÚ¡ *(
lua_pushl¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
, 
size_t
 
Ën
);

228 
LUA_API
 cÚ¡ *(
lua_push¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

229 
LUA_API
 cÚ¡ *(
lua_pushvf¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
,

230 
va_li¡
 
¬gp
);

231 
LUA_API
 cÚ¡ *(
lua_pushf¡ršg
è(
lua_S‹
 *
L
, cÚ¡ *
fmt
, ...);

232 
LUA_API
 (
lua_pushcşosu»
è(
lua_S‹
 *
L
, 
lua_CFunùiÚ
 
â
, 
n
);

233 
LUA_API
 (
lua_pushboŞ—n
è(
lua_S‹
 *
L
, 
b
);

234 
LUA_API
 (
lua_pushlightu£rd©a
è(
lua_S‹
 *
L
, *
p
);

235 
LUA_API
 (
lua_pushth»ad
è(
lua_S‹
 *
L
);

241 
LUA_API
 (
lua_g‘glob®
è(
lua_S‹
 *
L
, cÚ¡ *
Çme
);

242 
LUA_API
 (
lua_g‘bË
è(
lua_S‹
 *
L
, 
idx
);

243 
LUA_API
 (
lua_g‘f›ld
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
);

244 
LUA_API
 (
lua_g‘i
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

245 
LUA_API
 (
lua_¿wg‘
è(
lua_S‹
 *
L
, 
idx
);

246 
LUA_API
 (
lua_¿wg‘i
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

247 
LUA_API
 (
lua_¿wg‘p
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
);

249 
LUA_API
 (
lua_ü—‹bË
è(
lua_S‹
 *
L
, 
Ç¼
, 
Äec
);

250 
LUA_API
 *(
lua_Ãwu£rd©a
è(
lua_S‹
 *
L
, 
size_t
 
sz
);

251 
LUA_API
 (
lua_g‘m‘©abË
è(
lua_S‹
 *
L
, 
objšdex
);

252 
LUA_API
 (
lua_g‘u£rv®ue
è(
lua_S‹
 *
L
, 
idx
);

258 
LUA_API
 (
lua_£tglob®
è(
lua_S‹
 *
L
, cÚ¡ *
Çme
);

259 
LUA_API
 (
lua_£‰abË
è(
lua_S‹
 *
L
, 
idx
);

260 
LUA_API
 (
lua_£tf›ld
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
k
);

261 
LUA_API
 (
lua_£ti
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

262 
LUA_API
 (
lua_¿w£t
è(
lua_S‹
 *
L
, 
idx
);

263 
LUA_API
 (
lua_¿w£ti
è(
lua_S‹
 *
L
, 
idx
, 
lua_IÁeg”
 
n
);

264 
LUA_API
 (
lua_¿w£
è(
lua_S‹
 *
L
, 
idx
, cÚ¡ *
p
);

265 
LUA_API
 (
lua_£tm‘©abË
è(
lua_S‹
 *
L
, 
objšdex
);

266 
LUA_API
 (
lua_£tu£rv®ue
è(
lua_S‹
 *
L
, 
idx
);

272 
LUA_API
 (
lua_ÿÎk
è(
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
,

273 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
);

274 
	#lua_ÿÎ
(
L
,
n
,
r
è
	`lua_ÿÎk
(L, (n), (r), 0, 
NULL
)

	)

276 
LUA_API
 (
lua_pÿÎk
è(
lua_S‹
 *
L
, 
Çrgs
, 
ÄesuÉs
, 
”rfunc
,

277 
lua_KCÚ‹xt
 
ùx
, 
lua_KFunùiÚ
 
k
);

278 
	#lua_pÿÎ
(
L
,
n
,
r
,
f
è
	`lua_pÿÎk
(L, (n), (r), (f), 0, 
NULL
)

	)

280 
LUA_API
 (
lua_lßd
è(
lua_S‹
 *
L
, 
lua_R—d”
 
»ad”
, *
dt
,

281 cÚ¡ *
chunkÇme
, cÚ¡ *
mode
);

283 
LUA_API
 (
lua_dump
è(
lua_S‹
 *
L
, 
lua_Wr™”
 
wr™”
, *
d©a
, 
¡r
);

285 
LUA_API
 (
lua_şÚefunùiÚ
è(
lua_S‹
 *
L
, cÚ¡ *
eL
);

291 
LUA_API
 (
lua_y›ldk
è(
lua_S‹
 *
L
, 
ÄesuÉs
, 
lua_KCÚ‹xt
 
ùx
,

292 
lua_KFunùiÚ
 
k
);

293 
LUA_API
 (
lua_»sume
è(
lua_S‹
 *
L
,†ua_S‹ *
äom
, 
Çrg
);

294 
LUA_API
 (
lua_¡©us
è(
lua_S‹
 *
L
);

295 
LUA_API
 (
lua_isy›ldabË
è(
lua_S‹
 *
L
);

297 
	#lua_y›ld
(
L
,
n
è
	`lua_y›ldk
(L, (n), 0, 
NULL
)

	)

304 
	#LUA_GCSTOP
 0

	)

305 
	#LUA_GCRESTART
 1

	)

306 
	#LUA_GCCOLLECT
 2

	)

307 
	#LUA_GCCOUNT
 3

	)

308 
	#LUA_GCCOUNTB
 4

	)

309 
	#LUA_GCSTEP
 5

	)

310 
	#LUA_GCSETPAUSE
 6

	)

311 
	#LUA_GCSETSTEPMUL
 7

	)

312 
	#LUA_GCISRUNNING
 9

	)

314 
LUA_API
 (
lua_gc
è(
lua_S‹
 *
L
, 
wh©
, 
d©a
);

321 
LUA_API
 (
lua_”rÜ
è(
lua_S‹
 *
L
);

323 
LUA_API
 (
lua_Ãxt
è(
lua_S‹
 *
L
, 
idx
);

325 
LUA_API
 (
lua_cÚÿt
è(
lua_S‹
 *
L
, 
n
);

326 
LUA_API
 (
lua_Ën
è(
lua_S‹
 *
L
, 
idx
);

328 
LUA_API
 
	$size_t
 (
lua_¡ršgtÚumb”
è(
lua_S‹
 *
L
, cÚ¡ *
s
);

330 
LUA_API
 
	$lua_AÎoc
 (
lua_g‘®locf
è(
lua_S‹
 *
L
, **
ud
);

331 
LUA_API
 (
lua_£Îocf
è(
lua_S‹
 *
L
, 
lua_AÎoc
 
f
, *
ud
);

341 
	#lua_g‘exŒa¥aû
(
L
è((*)((*)(Lè- 
LUA_EXTRASPACE
))

	)

343 
	#lua_tÚumb”
(
L
,
i
è
	`lua_tÚumb”x
(L,(i),
NULL
)

	)

344 
	#lua_toš‹g”
(
L
,
i
è
	`lua_toš‹g”x
(L,(i),
NULL
)

	)

346 
	#lua_pİ
(
L
,
n
è
	`lua_£‰İ
(L, -Ò)-1)

	)

348 
	#lua_ÃwbË
(
L
è
	`lua_ü—‹bË
(L, 0, 0)

	)

350 
	#lua_»gi¡”
(
L
,
n
,
f
è(
	`lua_pushcfunùiÚ
(L, (f)), 
	`lua_£tglob®
(L, (n)))

	)

352 
	#lua_pushcfunùiÚ
(
L
,
f
è
	`lua_pushcşosu»
(L, (f), 0)

	)

354 
	#lua_isfunùiÚ
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TFUNCTION
)

	)

355 
	#lua_i¡abË
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TTABLE
)

	)

356 
	#lua_i¦ightu£rd©a
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TLIGHTUSERDATA
)

	)

357 
	#lua_i¢
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TNIL
)

	)

358 
	#lua_isboŞ—n
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TBOOLEAN
)

	)

359 
	#lua_i¡h»ad
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TTHREAD
)

	)

360 
	#lua_i¢Úe
(
L
,
n
è(
	`lua_ty³
(L, (n)è=ğ
LUA_TNONE
)

	)

361 
	#lua_i¢ÚeÜn
(
L
, 
n
è(
	`lua_ty³
(L, (n)è<ğ0)

	)

363 
	#lua_pushl™”®
(
L
, 
s
è
	`lua_push¡ršg
(L, "" s)

	)

365 
	#lua_pushglob®bË
(
L
) \

366 (()
	`lua_¿wg‘i
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_GLOBALS
))

	)

368 
	#lua_to¡ršg
(
L
,
i
è
	`lua_tŞ¡ršg
(L, (i), 
NULL
)

	)

371 
	#lua_š£¹
(
L
,
idx
è
	`lua_rÙ©e
(L, (idx), 1)

	)

373 
	#lua_»move
(
L
,
idx
è(
	`lua_rÙ©e
(L, (idx), -1), 
	`lua_pİ
(L, 1))

	)

375 
	#lua_»¶aû
(
L
,
idx
è(
	`lua_cİy
(L, -1, (idx)), 
	`lua_pİ
(L, 1))

	)

385 #ià
	`defšed
(
LUA_COMPAT_APIINTCASTS
)

387 
	#lua_pushunsigÃd
(
L
,
n
è
	`lua_pushš‹g”
(L, (
lua_IÁeg”
)Ò))

	)

388 
	#lua_tounsigÃdx
(
L
,
i
,
is
è((
lua_UnsigÃd
)
	`lua_toš‹g”x
(L,i,is))

	)

389 
	#lua_tounsigÃd
(
L
,
i
è
	`lua_tounsigÃdx
(L,(i),
NULL
)

	)

404 
	#LUA_HOOKCALL
 0

	)

405 
	#LUA_HOOKRET
 1

	)

406 
	#LUA_HOOKLINE
 2

	)

407 
	#LUA_HOOKCOUNT
 3

	)

408 
	#LUA_HOOKTAILCALL
 4

	)

414 
	#LUA_MASKCALL
 (1 << 
LUA_HOOKCALL
)

	)

415 
	#LUA_MASKRET
 (1 << 
LUA_HOOKRET
)

	)

416 
	#LUA_MASKLINE
 (1 << 
LUA_HOOKLINE
)

	)

417 
	#LUA_MASKCOUNT
 (1 << 
LUA_HOOKCOUNT
)

	)

419 
lua_Debug
 
	tlua_Debug
;

423 (*
	tlua_Hook
è(
	tlua_S‹
 *
	tL
, 
	tlua_Debug
 *
	t¬
);

426 
LUA_API
 (
lua_g‘¡ack
è(
lua_S‹
 *
L
, 
Ëv–
, 
lua_Debug
 *
¬
);

427 
LUA_API
 (
lua_g‘šfo
è(
lua_S‹
 *
L
, cÚ¡ *
wh©
, 
lua_Debug
 *
¬
);

428 
LUA_API
 cÚ¡ *(
lua_g‘loÿl
è(
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
);

429 
LUA_API
 cÚ¡ *(
lua_£oÿl
è(
lua_S‹
 *
L
, cÚ¡ 
lua_Debug
 *
¬
, 
n
);

430 
LUA_API
 cÚ¡ *(
lua_g‘upv®ue
è(
lua_S‹
 *
L
, 
funcšdex
, 
n
);

431 
LUA_API
 cÚ¡ *(
lua_£tupv®ue
è(
lua_S‹
 *
L
, 
funcšdex
, 
n
);

433 
LUA_API
 *(
lua_upv®ueid
è(
lua_S‹
 *
L
, 
fidx
, 
n
);

434 
LUA_API
 (
lua_upv®uejoš
è(
lua_S‹
 *
L
, 
fidx1
, 
n1
,

435 
fidx2
, 
n2
);

437 
LUA_API
 (
lua_£thook
è(
lua_S‹
 *
L
, 
lua_Hook
 
func
, 
mask
, 
couÁ
);

438 
LUA_API
 
	$lua_Hook
 (
lua_g‘hook
è(
lua_S‹
 *
L
);

439 
LUA_API
 (
lua_g‘hookmask
è(
lua_S‹
 *
L
);

440 
LUA_API
 (
lua_g‘hookcouÁ
è(
lua_S‹
 *
L
);

443 
	slua_Debug
 {

444 
ev’t
;

445 cÚ¡ *
Çme
;

446 cÚ¡ *
Çmewh©
;

447 cÚ¡ *
wh©
;

448 cÚ¡ *
sourû
;

449 
cu¼’še
;

450 
lšedefšed
;

451 
Ï¡lšedefšed
;

452 
nups
;

453 
Å¬ams
;

454 
isv¬¬g
;

455 
i¡aÿÎ
;

456 
shÜt_¤c
[
LUA_IDSIZE
];

458 
C®lInfo
 *
i_ci
;

465 
LUA_API
 
lua_S‹
 * 
skyÃt_sig_L
;

466 
LUA_API
 (
lua_checksig_
)(
lua_S‹
 *
L
);

467 
	#lua_checksig
(
L
èià(
skyÃt_sig_L
è{ 
	`lua_checksig_
(L); 
	}

	)
}

	@3rd/lua/lua.hpp

6 
	~"lua.h
"

7 
	~"lu®ib.h
"

8 
	~"Ïuxlib.h
"

	@3rd/lua/luac.c

7 
	#luac_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

12 
	~<ùy³.h
>

13 
	~<”ºo.h
>

14 
	~<¡dio.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"lua.h
"

19 
	~"Ïuxlib.h
"

21 
	~"lobjeù.h
"

22 
	~"l¡©e.h
"

23 
	~"lundump.h
"

24 
	~"l¡ršg.h
"

26 
PrštFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, 
fuÎ
);

27 
	#luaU_´št
 
PrštFunùiÚ


	)

29 
	#PROGNAME
 "luac"

	)

30 
	#OUTPUT
 
PROGNAME
 ".out"

	)

32 
	gli¡šg
=0;

33 
	gdumpšg
=1;

34 
	g¡rpšg
=0;

35 
	gOuut
[]={ 
OUTPUT
 };

36 cÚ¡ * 
	gouut
=
Ouut
;

37 cÚ¡ * 
	g´ogÇme
=
PROGNAME
;

39 
	$çl
(cÚ¡ * 
mes§ge
)

41 
	`årštf
(
¡d”r
,"%s: %s\n",
´ogÇme
,
mes§ge
);

42 
	`ex™
(
EXIT_FAILURE
);

43 
	}
}

45 
	$ÿÂÙ
(cÚ¡ * 
wh©
)

47 
	`årštf
(
¡d”r
,"%s: cªnÙ % %s: %s\n",
´ogÇme
,
wh©
,
ouut
,
	`¡»¼Ü
(
”ºo
));

48 
	`ex™
(
EXIT_FAILURE
);

49 
	}
}

51 
	$u§ge
(cÚ¡ * 
mes§ge
)

53 ià(*
mes§ge
=='-')

54 
	`årštf
(
¡d”r
,"%s: uÄecognized o±iÚ '%s'\n",
´ogÇme
,
mes§ge
);

56 
	`årštf
(
¡d”r
,"%s: %s\n",
´ogÇme
,
mes§ge
);

57 
	`årštf
(
¡d”r
,

67 ,
´ogÇme
,
Ouut
);

68 
	`ex™
(
EXIT_FAILURE
);

69 
	}
}

71 
	#IS
(
s
è(
	`¡rcmp
(
¬gv
[
i
],s)==0)

	)

73 
	$dßrgs
(
¬gc
, * 
¬gv
[])

75 
i
;

76 
v”siÚ
=0;

77 ià(
¬gv
[0]!=
NULL
 && *¬gv[0]!=0è
´ogÇme
=argv[0];

78 
i
=1; i<
¬gc
; i++)

80 ià(*
¬gv
[
i
]!='-')

82 ià(
	`IS
("--"))

84 ++
i
;

85 ià(
v”siÚ
) ++version;

88 ià(
	`IS
("-"))

90 ià(
	`IS
("-l"))

91 ++
li¡šg
;

92 ià(
	`IS
("-o"))

94 
ouut
=
¬gv
[++
i
];

95 ià(
ouut
==
NULL
 || *output==0 || (*output=='-' && output[1]!=0))

96 
	`u§ge
("'-o'‚eeds‡rgument");

97 ià(
	`IS
("-")è
ouut
=
NULL
;

99 ià(
	`IS
("-p"))

100 
dumpšg
=0;

101 ià(
	`IS
("-s"))

102 
¡rpšg
=1;

103 ià(
	`IS
("-v"))

104 ++
v”siÚ
;

106 
	`u§ge
(
¬gv
[
i
]);

108 ià(
i
==
¬gc
 && (
li¡šg
 || !
dumpšg
))

110 
dumpšg
=0;

111 
¬gv
[--
i
]=
Ouut
;

113 ià(
v”siÚ
)

115 
	`´štf
("%s\n",
LUA_COPYRIGHT
);

116 ià(
v”siÚ
==
¬gc
-1è
	`ex™
(
EXIT_SUCCESS
);

118  
i
;

119 
	}
}

121 
	#FUNCTION
 "(funùiÚ(ënd)();"

	)

123 cÚ¡ * 
	$»ad”
(
lua_S‹
 *
L
, *
ud
, 
size_t
 *
size
)

125 
	`UNUSED
(
L
);

126 ià((*(*)
ud
)--)

128 *
size
=(
FUNCTION
)-1;

129  
FUNCTION
;

133 *
size
=0;

134  
NULL
;

136 
	}
}

138 
	#tİrÙo
(
L
,
i
è
	`g‘´Ùo
(L->
tİ
+(i))

	)

140 cÚ¡ 
PrÙo
* 
	$combše
(
lua_S‹
* 
L
, 
n
)

142 ià(
n
==1)

143  
	`tİrÙo
(
L
,-1);

146 
PrÙo
* 
f
;

147 
i
=
n
;

148 ià(
	`lua_lßd
(
L
,
»ad”
,&
i
,"=(" 
PROGNAME
 ")",
NULL
)!=
LUA_OK
è
	`çl
(
	`lua_to¡ršg
(L,-1));

149 
f
=
	`tİrÙo
(
L
,-1);

150 
i
=0; i<
n
; i++)

152 
f
->
p
[
i
]=
	`tİrÙo
(
L
,i-
n
-1);

153 ià(
f
->
p
[
i
]->
¥
->
sizeupv®ues
>0èf->p[i]->¥->
upv®ues
[0].
š¡ack
=0;

155 
f
->
¥
->
siz–šešfo
=0;

156  
f
;

158 
	}
}

160 
	$wr™”
(
lua_S‹
* 
L
, cÚ¡ * 
p
, 
size_t
 
size
, * 
u
)

162 
	`UNUSED
(
L
);

163  (
	`fwr™e
(
p
,
size
,1,(
FILE
*)
u
)!=1) && (size!=0);

164 
	}
}

166 
	$pmaš
(
lua_S‹
* 
L
)

168 
¬gc
=()
	`lua_toš‹g”
(
L
,1);

169 ** 
¬gv
=(**)
	`lua_tou£rd©a
(
L
,2);

170 cÚ¡ 
PrÙo
* 
f
;

171 
i
;

172 ià(!
	`lua_check¡ack
(
L
,
¬gc
)è
	`çl
("too many input files");

173 
i
=0; i<
¬gc
; i++)

175 cÚ¡ * 
f’ame
=
	`IS
("-"è? 
NULL
 : 
¬gv
[
i
];

176 ià(
	`luaL_lßdfe
(
L
,
f’ame
)!=
LUA_OK
è
	`çl
(
	`lua_to¡ršg
(L,-1));

178 
f
=
	`combše
(
L
,
¬gc
);

179 ià(
li¡šg
è
	`luaU_´št
(
f
,listing>1);

180 ià(
dumpšg
)

182 
FILE
* 
D
ğ(
ouut
==
NULL
è? 
¡dout
 : 
	`fİ’
(output,"wb");

183 ià(
D
==
NULL
è
	`ÿÂÙ
("open");

184 
	`lua_lock
(
L
);

185 
	`luaU_dump
(
L
,
f
,
wr™”
,
D
,
¡rpšg
);

186 
	`lua_uÆock
(
L
);

187 ià(
	`ã¼Ü
(
D
)è
	`ÿÂÙ
("write");

188 ià(
	`fşo£
(
D
)è
	`ÿÂÙ
("close");

191 
	}
}

193 
	$maš
(
¬gc
, * 
¬gv
[])

195 
lua_S‹
* 
L
;

196 
i
=
	`dßrgs
(
¬gc
,
¬gv
);

197 
¬gc
-=
i
; 
¬gv
+=i;

198 ià(
¬gc
<=0è
	`u§ge
("no input files given");

199 
	`luaS_š™shr
();

200 
L
=
	`luaL_Ãw¡©e
();

201 ià(
L
==
NULL
è
	`çl
("cannot create state:‚otƒnough memory");

202 
	`lua_pushcfunùiÚ
(
L
,&
pmaš
);

203 
	`lua_pushš‹g”
(
L
,
¬gc
);

204 
	`lua_pushlightu£rd©a
(
L
,
¬gv
);

205 ià(
	`lua_pÿÎ
(
L
,2,0,0)!=
LUA_OK
è
	`çl
(
	`lua_to¡ršg
(L,-1));

206 
	`lua_şo£
(
L
);

207  
EXIT_SUCCESS
;

208 
	}
}

216 
	~<ùy³.h
>

217 
	~<¡dio.h
>

219 
	#luac_c


	)

220 
	#LUA_CORE


	)

222 
	~"ldebug.h
"

223 
	~"lobjeù.h
"

224 
	~"lİcodes.h
"

226 
	#VOID
(
p
è((cÚ¡ *)Õ))

	)

228 
	$PrštSŒšg
(cÚ¡ 
TSŒšg
* 
ts
)

230 cÚ¡ * 
s
=
	`g‘¡r
(
ts
);

231 
size_t
 
i
,
n
=
	`ts¦’
(
ts
);

232 
	`´štf
("%c",'"');

233 
i
=0; i<
n
; i++)

235 
c
=()()
s
[
i
];

236 
c
)

238 '"': 
	`´štf
("\\\""); ;

239 '\\': 
	`´štf
("\\\\"); ;

240 '\a': 
	`´štf
("\\a"); ;

241 '\b': 
	`´štf
("\\b"); ;

242 '\f': 
	`´štf
("\\f"); ;

243 '\n': 
	`´štf
("\\n"); ;

244 '\r': 
	`´štf
("\\r"); ;

245 '\t': 
	`´štf
("\\t"); ;

246 '\v': 
	`´štf
("\\v"); ;

247 : ià(
	`i¥ršt
(
c
))

248 
	`´štf
("%c",
c
);

250 
	`´štf
("\\%03d",
c
);

253 
	`´štf
("%c",'"');

254 
	}
}

256 
	$PrštCÚ¡ªt
(cÚ¡ 
PrÙo
* 
f
, 
i
)

258 cÚ¡ 
TV®ue
* 
o
=&
f
->
k
[
i
];

259 
	`‰y³
(
o
))

261 
LUA_TNIL
:

262 
	`´štf
("nil");

264 
LUA_TBOOLEAN
:

265 
	`´štf
(
	`bv®ue
(
o
) ? "true" : "false");

267 
LUA_TNUMFLT
:

269 
buff
[100];

270 
	`¥rštf
(
buff
,
LUA_NUMBER_FMT
,
	`ætv®ue
(
o
));

271 
	`´štf
("%s",
buff
);

272 ià(
buff
[
	`¡r¥n
(buff,"-0123456789")]=='\0'è
	`´štf
(".0");

275 
LUA_TNUMINT
:

276 
	`´štf
(
LUA_INTEGER_FMT
,
	`iv®ue
(
o
));

278 
LUA_TSHRSTR
: 
LUA_TLNGSTR
:

279 
	`PrštSŒšg
(
	`tsv®ue
(
o
));

282 
	`´štf
("?y³=%d",
	`‰y³
(
o
));

285 
	}
}

287 
	#UPVALNAME
(
x
è((
f
->
¥
->
upv®ues
[x].
Çme
è? 
	`g‘¡r
(f->¥->upv®ues[x].Çmeè: "-")

	)

288 
	#MYK
(
x
è(-1-(x))

	)

290 
	$PrštCode
(cÚ¡ 
PrÙo
* 
f
)

292 cÚ¡ 
In¡ruùiÚ
* 
code
=
f
->
¥
->code;

293 
pc
,
n
=
f
->
¥
->
sizecode
;

294 
pc
=0;…c<
n
;…c++)

296 
In¡ruùiÚ
 
i
=
code
[
pc
];

297 
OpCode
 
o
=
	`GET_OPCODE
(
i
);

298 
a
=
	`GETARG_A
(
i
);

299 
b
=
	`GETARG_B
(
i
);

300 
c
=
	`GETARG_C
(
i
);

301 
ax
=
	`GETARG_Ax
(
i
);

302 
bx
=
	`GETARG_Bx
(
i
);

303 
sbx
=
	`GETARG_sBx
(
i
);

304 
lše
=
	`g‘funşše
(
f
,
pc
);

305 
	`´štf
("\t%d\t",
pc
+1);

306 ià(
lše
>0è
	`´štf
("[%d]\t",line); printf("[-]\t");

307 
	`´štf
("%-9s\t",
luaP_İÇmes
[
o
]);

308 
	`g‘OpMode
(
o
))

310 
iABC
:

311 
	`´štf
("%d",
a
);

312 ià(
	`g‘BMode
(
o
)!=
OpArgN
è
	`´štf
(" %d",
	`ISK
(
b
è? (
	`MYK
(
	`INDEXK
(b))) : b);

313 ià(
	`g‘CMode
(
o
)!=
OpArgN
è
	`´štf
(" %d",
	`ISK
(
c
è? (
	`MYK
(
	`INDEXK
(c))) : c);

315 
iABx
:

316 
	`´štf
("%d",
a
);

317 ià(
	`g‘BMode
(
o
)==
OpArgK
è
	`´štf
(" %d",
	`MYK
(
bx
));

318 ià(
	`g‘BMode
(
o
)==
OpArgU
è
	`´štf
(" %d",
bx
);

320 
iAsBx
:

321 
	`´štf
("%d %d",
a
,
sbx
);

323 
iAx
:

324 
	`´štf
("%d",
	`MYK
(
ax
));

327 
o
)

329 
OP_LOADK
:

330 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
bx
);

332 
OP_GETUPVAL
:

333 
OP_SETUPVAL
:

334 
	`´štf
("\t; %s",
	`UPVALNAME
(
b
));

336 
OP_GETTABUP
:

337 
	`´štf
("\t; %s",
	`UPVALNAME
(
b
));

338 ià(
	`ISK
(
c
)è{ 
	`´štf
(" "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

340 
OP_SETTABUP
:

341 
	`´štf
("\t; %s",
	`UPVALNAME
(
a
));

342 ià(
	`ISK
(
b
)è{ 
	`´štf
(" "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(b)); }

343 ià(
	`ISK
(
c
)è{ 
	`´štf
(" "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

345 
OP_GETTABLE
:

346 
OP_SELF
:

347 ià(
	`ISK
(
c
)è{ 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); }

349 
OP_SETTABLE
:

350 
OP_ADD
:

351 
OP_SUB
:

352 
OP_MUL
:

353 
OP_POW
:

354 
OP_DIV
:

355 
OP_IDIV
:

356 
OP_BAND
:

357 
OP_BOR
:

358 
OP_BXOR
:

359 
OP_SHL
:

360 
OP_SHR
:

361 
OP_EQ
:

362 
OP_LT
:

363 
OP_LE
:

364 ià(
	`ISK
(
b
è|| ISK(
c
))

366 
	`´štf
("\t; ");

367 ià(
	`ISK
(
b
)è
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(b)); 
	`´štf
("-");

368 
	`´štf
(" ");

369 ià(
	`ISK
(
c
)è
	`PrštCÚ¡ªt
(
f
,
	`INDEXK
(c)); 
	`´štf
("-");

372 
OP_JMP
:

373 
OP_FORLOOP
:

374 
OP_FORPREP
:

375 
OP_TFORLOOP
:

376 
	`´štf
("\t;Ø%d",
sbx
+
pc
+2);

378 
OP_CLOSURE
:

379 
	`´štf
("\t; %p",
	`VOID
(
f
->
p
[
bx
]));

381 
OP_SETLIST
:

382 ià(
c
==0è
	`´štf
("\t; %d",()
code
[++
pc
]); printf("\t; %d",c);

384 
OP_EXTRAARG
:

385 
	`´štf
("\t; "); 
	`PrštCÚ¡ªt
(
f
,
ax
);

390 
	`´štf
("\n");

392 
	}
}

394 
	#SS
(
x
è((x==1)?"":"s")

	)

395 
	#S
(
x
è()(x),
	`SS
(x)

	)

397 
	$PrštH—d”
(cÚ¡ 
Sh¬edPrÙo
* 
f
)

399 cÚ¡ * 
s
=
f
->
sourû
 ? 
	`g‘¡r
(f->source) : "=?";

400 ià(*
s
=='@' || *s=='=')

401 
s
++;

402 ià(*
s
==
LUA_SIGNATURE
[0])

403 
s
="(bstring)";

405 
s
="(string)";

406 
	`´štf
("\n%s <%s:%d,%d> (%d instruction%s‡t %p)\n",

407 (
f
->
lšedefšed
==0)?"maš":"funùiÚ",
s
,

408 
f
->
lšedefšed
,f->
Ï¡lšedefšed
,

409 
	`S
(
f
->
sizecode
),
	`VOID
(f));

410 
	`´štf
("%d%s…aram%s, %d slot%s, %d upvalue%s, ",

411 ()(
f
->
num·¿ms
),f->
is_v¬¬g
?"+":"",
	`SS
(f->numparams),

412 
	`S
(
f
->
max¡acksize
),S(f->
sizeupv®ues
));

413 
	`´štf
("%d†ocal%s, %d constant%s, %d function%s\n",

414 
	`S
(
f
->
siz–ocv¬s
),S(f->
sizek
),S(f->
siz•
));

415 
	}
}

417 
	$PrštDebug
(cÚ¡ 
PrÙo
* 
f
)

419 cÚ¡ 
Sh¬edPrÙo
 *
¥
 = 
f
->sp;

420 
i
,
n
;

421 
n
=
¥
->
sizek
;

422 
	`´štf
("cÚ¡ªt (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

423 
i
=0; i<
n
; i++)

425 
	`´štf
("\t%d\t",
i
+1);

426 
	`PrštCÚ¡ªt
(
f
,
i
);

427 
	`´štf
("\n");

429 
n
=
¥
->
siz–ocv¬s
;

430 
	`´štf
("loÿl (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

431 
i
=0; i<
n
; i++)

433 
	`´štf
("\t%d\t%s\t%d\t%d\n",

434 
i
,
	`g‘¡r
(
¥
->
locv¬s
[i].
v¬Çme
),¥->locv¬s[i].
¡¬c
+1,¥->locv¬s[i].
’dpc
+1);

436 
n
=
f
->
¥
->
sizeupv®ues
;

437 
	`´štf
("upv®ue (%dèfÜ %p:\n",
n
,
	`VOID
(
f
));

438 
i
=0; i<
n
; i++)

440 
	`´štf
("\t%d\t%s\t%d\t%d\n",

441 
i
,
	`UPVALNAME
(i),
¥
->
upv®ues
[i].
š¡ack
,¥->upv®ues[i].
idx
);

443 
	}
}

445 
	$PrštFunùiÚ
(cÚ¡ 
PrÙo
* 
f
, 
fuÎ
)

447 
i
,
n
=
f
->
¥
->
siz•
;

448 
	`PrštH—d”
(
f
->
¥
);

449 
	`PrštCode
(
f
);

450 ià(
fuÎ
è
	`PrštDebug
(
f
);

451 
i
=0; i<
n
; i++è
	`PrštFunùiÚ
(
f
->
p
[i],
fuÎ
);

452 
	}
}

	@3rd/lua/luaconf.h

8 #iâdeà
luacÚf_h


9 
	#luacÚf_h


	)

11 
	~<lim™s.h
>

12 
	~<¡ddef.h
>

50 #ià!
defšed
(
LUA_USE_C89
è&& defšed(
_WIN32
è&& !defšed(
_WIN32_WCE
)

51 
	#LUA_USE_WINDOWS


	)

55 #ià
defšed
(
LUA_USE_WINDOWS
)

56 
	#LUA_DL_DLL


	)

57 
	#LUA_USE_C89


	)

61 #ià
defšed
(
LUA_USE_LINUX
)

62 
	#LUA_USE_POSIX


	)

63 
	#LUA_USE_DLOPEN


	)

64 
	#LUA_USE_READLINE


	)

68 #ià
defšed
(
LUA_USE_MACOSX
)

69 
	#LUA_USE_POSIX


	)

70 
	#LUA_USE_DLOPEN


	)

71 
	#LUA_USE_READLINE


	)

80 #ià
defšed
(
LUA_USE_C89
è&& !defšed(
LUA_USE_WINDOWS
)

81 
	#LUA_C89_NUMBERS


	)

90 #ià((
INT_MAX
 >> 15) >> 15) >= 1

91 
	#LUAI_BITSINT
 32

	)

94 
	#LUAI_BITSINT
 16

	)

109 
	#LUA_INT_INT
 1

	)

110 
	#LUA_INT_LONG
 2

	)

111 
	#LUA_INT_LONGLONG
 3

	)

114 
	#LUA_FLOAT_FLOAT
 1

	)

115 
	#LUA_FLOAT_DOUBLE
 2

	)

116 
	#LUA_FLOAT_LONGDOUBLE
 3

	)

118 #ià
defšed
(
LUA_32BITS
)

122 #ià
LUAI_BITSINT
 >= 32

123 
	#LUA_INT_TYPE
 
LUA_INT_INT


	)

125 
	#LUA_INT_TYPE
 
LUA_INT_LONG


	)

127 
	#LUA_FLOAT_TYPE
 
LUA_FLOAT_FLOAT


	)

129 #–ià
defšed
(
LUA_C89_NUMBERS
)

133 
	#LUA_INT_TYPE
 
LUA_INT_LONG


	)

134 
	#LUA_FLOAT_TYPE
 
LUA_FLOAT_DOUBLE


	)

142 #ià!
defšed
(
LUA_INT_TYPE
)

143 
	#LUA_INT_TYPE
 
LUA_INT_LONGLONG


	)

146 #ià!
defšed
(
LUA_FLOAT_TYPE
)

147 
	#LUA_FLOAT_TYPE
 
LUA_FLOAT_DOUBLE


	)

168 
	#LUA_PATH_SEP
 ";"

	)

169 
	#LUA_PATH_MARK
 "?"

	)

170 
	#LUA_EXEC_DIR
 "!"

	)

182 
	#LUA_VDIR
 
LUA_VERSION_MAJOR
 "." 
LUA_VERSION_MINOR


	)

183 #ià
defšed
(
_WIN32
)

188 
	#LUA_LDIR
 "!\\lua\\"

	)

189 
	#LUA_CDIR
 "!\\"

	)

190 
	#LUA_SHRDIR
 "!\\..\\sh¬e\\lua\\" 
LUA_VDIR
 "\\"

	)

191 
	#LUA_PATH_DEFAULT
 \

192 
LUA_LDIR
"?.lua;" LUA_LDIR"?\\init.lua;" \

193 
LUA_CDIR
"?.lua;" LUA_CDIR"?\\init.lua;" \

194 
LUA_SHRDIR
"?.lua;" LUA_SHRDIR"?\\init.lua;" \

195 ".\\?.lua;" ".\\?\\š™.lua"

	)

196 
	#LUA_CPATH_DEFAULT
 \

197 
LUA_CDIR
"?.dll;" \

198 
LUA_CDIR
"..\\lib\\lua\\" 
LUA_VDIR
 "\\?.dll;" \

199 
LUA_CDIR
"lßd®l.dÎ;" ".\\?.dÎ"

	)

203 
	#LUA_ROOT
 "/u¤/loÿl/"

	)

204 
	#LUA_LDIR
 
LUA_ROOT
 "sh¬e/lua/" 
LUA_VDIR
 "/"

	)

205 
	#LUA_CDIR
 
LUA_ROOT
 "lib/lua/" 
LUA_VDIR
 "/"

	)

206 
	#LUA_PATH_DEFAULT
 \

207 
LUA_LDIR
"?.lua;" LUA_LDIR"?/init.lua;" \

208 
LUA_CDIR
"?.lua;" LUA_CDIR"?/init.lua;" \

209 "./?.lua;" "./?/š™.lua"

	)

210 
	#LUA_CPATH_DEFAULT
 \

211 
LUA_CDIR
"?.so;" LUA_CDIR"lßd®l.so;" "./?.so"

	)

220 #ià
defšed
(
_WIN32
)

221 
	#LUA_DIRSEP
 "\\"

	)

223 
	#LUA_DIRSEP
 "/"

	)

244 #ià
defšed
(
LUA_BUILD_AS_DLL
)

246 #ià
defšed
(
LUA_CORE
è|| defšed(
LUA_LIB
)

247 
	#LUA_API
 
	`__deş¥ec
(
dÎexpÜt
)

	)

249 
	#LUA_API
 
	`__deş¥ec
(
dÎimpÜt
)

	)

254 
	#LUA_API
 

	)

260 
	#LUALIB_API
 
LUA_API


	)

261 
	#LUAMOD_API
 
LUALIB_API


	)

278 #ià
defšed
(
__GNUC__
è&& ((__GNUC__*100 + 
__GNUC_MINOR__
) >= 302) && \

279 
	$defšed
(
__ELF__
)

280 
	#LUAI_FUNC
 
	`__©Œibu‹__
((
	`visib™y
("hidd’"))è

	)

282 
	#LUAI_FUNC
 

	)

285 
	#LUAI_DDEC
 
LUAI_FUNC


	)

286 
	#LUAI_DDEF


	)

303 #ià
	`defšed
(
LUA_COMPAT_5_2
)

309 
	#LUA_COMPAT_MATHLIB


	)

314 
	#LUA_COMPAT_BITLIB


	)

319 
	#LUA_COMPAT_IPAIRS


	)

326 
	#LUA_COMPAT_APIINTCASTS


	)

331 #ià
	`defšed
(
LUA_COMPAT_5_1
)

334 
	#LUA_COMPAT_MATHLIB


	)

335 
	#LUA_COMPAT_APIINTCASTS


	)

341 
	#LUA_COMPAT_UNPACK


	)

347 
	#LUA_COMPAT_LOADERS


	)

353 
	#lua_ıÿÎ
(
L
,
f
,
u
) \

354 (
	`lua_pushcfunùiÚ
(
L
, (
f
)), \

355 
	`lua_pushlightu£rd©a
(
L
,(
u
)), \

356 
	`lua_pÿÎ
(
L
,1,0,0))

	)

363 
	#LUA_COMPAT_LOG10


	)

369 
	#LUA_COMPAT_LOADSTRING


	)

374 
	#LUA_COMPAT_MAXN


	)

381 
	#lua_¡¾’
(
L
,
i
è
	`lua_¿wËn
(L, (i))

	)

383 
	#lua_objËn
(
L
,
i
è
	`lua_¿wËn
(L, (i))

	)

385 
	#lua_equ®
(
L
,
idx1
,
idx2
è
	`lua_com·»
(L,(idx1),(idx2),
LUA_OPEQ
)

	)

386 
	#lua_Ës¡hª
(
L
,
idx1
,
idx2
è
	`lua_com·»
(L,(idx1),(idx2),
LUA_OPLT
)

	)

392 
	#LUA_COMPAT_MODULE


	)

434 
	#l_æoÜ
(
x
è(
	`l_m©hİ
(
æoÜ
)(x))

	)

436 
	#lua_numb”2¡r
(
s
,
sz
,
n
) \

437 
	`l_¥rštf
((
s
), 
sz
, 
LUA_NUMBER_FMT
, (
LUAI_UACNUMBER
)(
n
))

	)

447 
	#lua_numb”toš‹g”
(
n
,
p
) \

448 ((
n
è>ğ(
LUA_NUMBER
)(
LUA_MININTEGER
) && \

449 (
n
è< -(
LUA_NUMBER
)(
LUA_MININTEGER
) && \

450 (*(
p
èğ(
LUA_INTEGER
)(
n
), 1))

	)

455 #ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_FLOAT


457 
	#LUA_NUMBER
 

	)

459 
	#l_m©hlim
(
n
è(
FLT_
##n)

	)

461 
	#LUAI_UACNUMBER
 

	)

463 
	#LUA_NUMBER_FRMLEN
 ""

	)

464 
	#LUA_NUMBER_FMT
 "%.7g"

	)

466 
	#l_m©hİ
(
İ
èİ##
f


	)

468 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹of
((s), (p))

	)

471 #–ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_LONGDOUBLE


473 
	#LUA_NUMBER
 

	)

475 
	#l_m©hlim
(
n
è(
LDBL_
##n)

	)

477 
	#LUAI_UACNUMBER
 

	)

479 
	#LUA_NUMBER_FRMLEN
 "L"

	)

480 
	#LUA_NUMBER_FMT
 "%.19Lg"

	)

482 
	#l_m©hİ
(
İ
èİ##
l


	)

484 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹Şd
((s), (p))

	)

486 #–ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_DOUBLE


488 
	#LUA_NUMBER
 

	)

490 
	#l_m©hlim
(
n
è(
DBL_
##n)

	)

492 
	#LUAI_UACNUMBER
 

	)

494 
	#LUA_NUMBER_FRMLEN
 ""

	)

495 
	#LUA_NUMBER_FMT
 "%.14g"

	)

497 
	#l_m©hİ
(
İ
è
	)
op

499 
	#lua_¡r2numb”
(
s
,
p
è
	`¡¹od
((s), (p))

	)

526 
	#LUA_INTEGER_FMT
 "%" 
LUA_INTEGER_FRMLEN
 "d"

	)

528 
	#LUAI_UACINT
 
LUA_INTEGER


	)

530 
	#lua_š‹g”2¡r
(
s
,
sz
,
n
) \

531 
	`l_¥rštf
((
s
), 
sz
, 
LUA_INTEGER_FMT
, (
LUAI_UACINT
)(
n
))

	)

537 
	#LUA_UNSIGNED
 
LUAI_UACINT


	)

542 #ià
LUA_INT_TYPE
 =ğ
LUA_INT_INT


544 
	#LUA_INTEGER
 

	)

545 
	#LUA_INTEGER_FRMLEN
 ""

	)

547 
	#LUA_MAXINTEGER
 
INT_MAX


	)

548 
	#LUA_MININTEGER
 
INT_MIN


	)

550 #–ià
LUA_INT_TYPE
 =ğ
LUA_INT_LONG


552 
	#LUA_INTEGER
 

	)

553 
	#LUA_INTEGER_FRMLEN
 "l"

	)

555 
	#LUA_MAXINTEGER
 
LONG_MAX


	)

556 
	#LUA_MININTEGER
 
LONG_MIN


	)

558 #–ià
LUA_INT_TYPE
 =ğ
LUA_INT_LONGLONG


561 #ià
	`defšed
(
LLONG_MAX
)

564 
	#LUA_INTEGER
 

	)

565 
	#LUA_INTEGER_FRMLEN
 "Î"

	)

567 
	#LUA_MAXINTEGER
 
LLONG_MAX


	)

568 
	#LUA_MININTEGER
 
LLONG_MIN


	)

570 #–ià
	`defšed
(
LUA_USE_WINDOWS
)

573 
	#LUA_INTEGER
 
__št64


	)

574 
	#LUA_INTEGER_FRMLEN
 "I64"

	)

576 
	#LUA_MAXINTEGER
 
_I64_MAX


	)

577 
	#LUA_MININTEGER
 
_I64_MIN


	)

605 #ià!
	`defšed
(
LUA_USE_C89
)

606 
	#l_¥rštf
(
s
,
sz
,
f
,
i
è
	`¢´štf
(s,sz,f,i)

	)

608 
	#l_¥rštf
(
s
,
sz
,
f
,
i
è(()(sz), 
	`¥rštf
(s,f,i))

	)

618 #ià!
	`defšed
(
LUA_USE_C89
)

619 
	#lua_¡rx2numb”
(
s
,
p
è
	`lua_¡r2numb”
(s,p)

	)

629 #ià!
	`defšed
(
LUA_USE_C89
)

630 
	#lua_numb”2¡rx
(
L
,
b
,
sz
,
f
,
n
) \

631 (()
L
, 
	`l_¥rštf
(
b
,
sz
,
f
,(
LUAI_UACNUMBER
)(
n
)))

	)

641 #ià
	`defšed
(
LUA_USE_C89
è|| (defšed(
HUGE_VAL
è&& !defšed(
HUGE_VALF
))

642 #undeà
l_m©hİ


643 #undeà
lua_¡r2numb”


644 
	#l_m©hİ
(
İ
è(
lua_Numb”
)İ

	)

645 
	#lua_¡r2numb”
(
s
,
p
è((
lua_Numb”
)
	`¡¹od
((s), (p)))

	)

655 
	#LUA_KCONTEXT
 
±rdiff_t


	)

657 #ià!
	`defšed
(
LUA_USE_C89
è&& defšed(
__STDC_VERSION__
) && \

658 
__STDC_VERSION__
 >= 199901L

659 
	~<¡dšt.h
>

660 #ià
	`defšed
(
INTPTR_MAX
)

661 #undeà
LUA_KCONTEXT


662 
	#LUA_KCONTEXT
 
šŒ_t


	)

672 #ià!
	`defšed
(
lua_g‘loÿËdeıošt
)

673 
	#lua_g‘loÿËdeıošt
(è(
	`loÿËcÚv
()->
decim®_pošt
[0])

	)

699 #ià
	`defšed
(
LUA_USE_APICHECK
)

700 
	~<as£¹.h
>

701 
	#luai_­icheck
(
l
,
e
è
	`as£¹
Ó)

	)

721 #ià
LUAI_BITSINT
 >= 32

722 
	#LUAI_MAXSTACK
 1000000

	)

724 
	#LUAI_MAXSTACK
 15000

	)

733 
	#LUA_EXTRASPACE
 ((*))

	)

741 
	#LUA_IDSIZE
 60

	)

751 #ià
LUA_FLOAT_TYPE
 =ğ
LUA_FLOAT_LONGDOUBLE


752 
	#LUAL_BUFFERSIZE
 8192

	)

754 
	#LUAL_BUFFERSIZE
 (()(0x80 * (*è* (
lua_IÁeg”
)))

	)

765 
	#LUA_QL
(
x
è"'" x "'"

	)

766 
	#LUA_QS
 
	`LUA_QL
("%s")

	)

	@3rd/lua/lualib.h

8 #iâdeà
lu®ib_h


9 
	#lu®ib_h


	)

11 
	~"lua.h
"

15 
	#LUA_VERSUFFIX
 "_" 
LUA_VERSION_MAJOR
 "_" 
LUA_VERSION_MINOR


	)

18 
LUAMOD_API
 (
luaİ’_ba£
è(
lua_S‹
 *
L
);

20 
	#LUA_COLIBNAME
 "cÜoutše"

	)

21 
LUAMOD_API
 (
luaİ’_cÜoutše
è(
lua_S‹
 *
L
);

23 
	#LUA_TABLIBNAME
 "bË"

	)

24 
LUAMOD_API
 (
luaİ’_bË
è(
lua_S‹
 *
L
);

26 
	#LUA_IOLIBNAME
 "io"

	)

27 
LUAMOD_API
 (
luaİ’_io
è(
lua_S‹
 *
L
);

29 
	#LUA_OSLIBNAME
 "os"

	)

30 
LUAMOD_API
 (
luaİ’_os
è(
lua_S‹
 *
L
);

32 
	#LUA_STRLIBNAME
 "¡ršg"

	)

33 
LUAMOD_API
 (
luaİ’_¡ršg
è(
lua_S‹
 *
L
);

35 
	#LUA_UTF8LIBNAME
 "utf8"

	)

36 
LUAMOD_API
 (
luaİ’_utf8
è(
lua_S‹
 *
L
);

38 
	#LUA_BITLIBNAME
 "b™32"

	)

39 
LUAMOD_API
 (
luaİ’_b™32
è(
lua_S‹
 *
L
);

41 
	#LUA_MATHLIBNAME
 "m©h"

	)

42 
LUAMOD_API
 (
luaİ’_m©h
è(
lua_S‹
 *
L
);

44 
	#LUA_DBLIBNAME
 "debug"

	)

45 
LUAMOD_API
 (
luaİ’_debug
è(
lua_S‹
 *
L
);

47 
	#LUA_LOADLIBNAME
 "·ckage"

	)

48 
LUAMOD_API
 (
luaİ’_·ckage
è(
lua_S‹
 *
L
);

50 
	#LUA_CACHELIB


	)

51 
LUAMOD_API
 (
luaİ’_ÿche
è(
lua_S‹
 *
L
);

54 
LUALIB_API
 (
luaL_İ’libs
è(
lua_S‹
 *
L
);

58 #ià!
	`defšed
(
lua_as£¹
)

59 
	#lua_as£¹
(
x
è(()0)

	)

	@3rd/lua/lundump.c

7 
	#lundump_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"ldebug.h
"

18 
	~"ldo.h
"

19 
	~"lfunc.h
"

20 
	~"lmem.h
"

21 
	~"lobjeù.h
"

22 
	~"l¡ršg.h
"

23 
	~"lundump.h
"

24 
	~"lzio.h
"

27 #ià!
defšed
(
luai_v”ifycode
)

28 
	#luai_v”ifycode
(
L
,
b
,
f
è

	)

33 
lua_S‹
 *
	mL
;

34 
ZIO
 *
	mZ
;

35 cÚ¡ *
	mÇme
;

36 } 
	tLßdS‹
;

39 
l_nÜ‘
 
	$”rÜ
(
LßdS‹
 *
S
, cÚ¡ *
why
) {

40 
	`luaO_pushf¡ršg
(
S
->
L
, "%s: % ´ecomped chunk", S->
Çme
, 
why
);

41 
	`luaD_throw
(
S
->
L
, 
LUA_ERRSYNTAX
);

42 
	}
}

49 
	#LßdVeùÜ
(
S
,
b
,
n
è
	`LßdBlock
(S,b,Ò)*((b)[0]))

	)

51 
	$LßdBlock
 (
LßdS‹
 *
S
, *
b
, 
size_t
 
size
) {

52 ià(
	`luaZ_»ad
(
S
->
Z
, 
b
, 
size
) != 0)

53 
	`”rÜ
(
S
, "truncated");

54 
	}
}

57 
	#LßdV¬
(
S
,
x
è
	`LßdVeùÜ
(S,&x,1)

	)

60 
lu_by‹
 
	$LßdBy‹
 (
LßdS‹
 *
S
) {

61 
lu_by‹
 
x
;

62 
	`LßdV¬
(
S
, 
x
);

63  
x
;

64 
	}
}

67 
	$LßdIÁ
 (
LßdS‹
 *
S
) {

68 
x
;

69 
	`LßdV¬
(
S
, 
x
);

70  
x
;

71 
	}
}

74 
lua_Numb”
 
	$LßdNumb”
 (
LßdS‹
 *
S
) {

75 
lua_Numb”
 
x
;

76 
	`LßdV¬
(
S
, 
x
);

77  
x
;

78 
	}
}

81 
lua_IÁeg”
 
	$LßdIÁeg”
 (
LßdS‹
 *
S
) {

82 
lua_IÁeg”
 
x
;

83 
	`LßdV¬
(
S
, 
x
);

84  
x
;

85 
	}
}

88 
TSŒšg
 *
	$LßdSŒšg
 (
LßdS‹
 *
S
) {

89 
size_t
 
size
 = 
	`LßdBy‹
(
S
);

90 ià(
size
 == 0xFF)

91 
	`LßdV¬
(
S
, 
size
);

92 ià(
size
 == 0)

93  
NULL
;

94 ià(--
size
 <ğ
LUAI_MAXSHORTLEN
) {

95 
buff
[
LUAI_MAXSHORTLEN
];

96 
	`LßdVeùÜ
(
S
, 
buff
, 
size
);

97  
	`luaS_Ãwl¡r
(
S
->
L
, 
buff
, 
size
);

100 
TSŒšg
 *
ts
 = 
	`luaS_ü—‹Êg¡robj
(
S
->
L
, 
size
);

101 
	`LßdVeùÜ
(
S
, 
	`g‘¡r
(
ts
), 
size
);

102  
ts
;

104 
	}
}

107 
	$LßdCode
 (
LßdS‹
 *
S
, 
Sh¬edPrÙo
 *
f
) {

108 
n
 = 
	`LßdIÁ
(
S
);

109 
f
->
code
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
In¡ruùiÚ
);

110 
f
->
sizecode
 = 
n
;

111 
	`LßdVeùÜ
(
S
, 
f
->
code
, 
n
);

112 
	}
}

115 
LßdFunùiÚ
(
LßdS‹
 *
S
, 
PrÙo
 *
f
, 
TSŒšg
 *
psourû
);

118 
	$LßdCÚ¡ªts
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

119 
i
;

120 
n
 = 
	`LßdIÁ
(
S
);

121 
f
->
k
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
TV®ue
);

122 
f
->
¥
->
sizek
 = 
n
;

123 
i
 = 0; i < 
n
; i++)

124 
	`£Šv®ue
(&
f
->
k
[
i
]);

125 
i
 = 0; i < 
n
; i++) {

126 
TV®ue
 *
o
 = &
f
->
k
[
i
];

127 
t
 = 
	`LßdBy‹
(
S
);

128 
t
) {

129 
LUA_TNIL
:

130 
	`£Šv®ue
(
o
);

132 
LUA_TBOOLEAN
:

133 
	`£tbv®ue
(
o
, 
	`LßdBy‹
(
S
));

135 
LUA_TNUMFLT
:

136 
	`£tætv®ue
(
o
, 
	`LßdNumb”
(
S
));

138 
LUA_TNUMINT
:

139 
	`£tiv®ue
(
o
, 
	`LßdIÁeg”
(
S
));

141 
LUA_TSHRSTR
:

142 
LUA_TLNGSTR
:

143 
	`£tsv®ue2n
(
S
->
L
, 
o
, 
	`LßdSŒšg
(S));

146 
	`lua_as£¹
(0);

149 
	}
}

152 
	$LßdPrÙos
 (
LßdS‹
 *
S
, 
PrÙo
 *
f
) {

153 
i
;

154 
n
 = 
	`LßdIÁ
(
S
);

155 
f
->
p
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
PrÙo
 *);

156 
f
->
¥
->
siz•
 = 
n
;

157 
i
 = 0; i < 
n
; i++)

158 
f
->
p
[
i
] = 
NULL
;

159 
i
 = 0; i < 
n
; i++) {

160 
f
->
p
[
i
] = 
	`luaF_Ãw´Ùo
(
S
->
L
, 
NULL
);

161 
	`LßdFunùiÚ
(
S
, 
f
->
p
[
i
], f->
¥
->
sourû
);

163 
	}
}

166 
	$LßdUpv®ues
 (
LßdS‹
 *
S
, 
Sh¬edPrÙo
 *
f
) {

167 
i
, 
n
;

168 
n
 = 
	`LßdIÁ
(
S
);

169 
f
->
upv®ues
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
Upv®desc
);

170 
f
->
sizeupv®ues
 = 
n
;

171 
i
 = 0; i < 
n
; i++)

172 
f
->
upv®ues
[
i
].
Çme
 = 
NULL
;

173 
i
 = 0; i < 
n
; i++) {

174 
f
->
upv®ues
[
i
].
š¡ack
 = 
	`LßdBy‹
(
S
);

175 
f
->
upv®ues
[
i
].
idx
 = 
	`LßdBy‹
(
S
);

177 
	}
}

180 
	$LßdDebug
 (
LßdS‹
 *
S
, 
Sh¬edPrÙo
 *
f
) {

181 
i
, 
n
;

182 
n
 = 
	`LßdIÁ
(
S
);

183 
f
->
lšešfo
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, );

184 
f
->
siz–šešfo
 = 
n
;

185 
	`LßdVeùÜ
(
S
, 
f
->
lšešfo
, 
n
);

186 
n
 = 
	`LßdIÁ
(
S
);

187 
f
->
locv¬s
 = 
	`luaM_ÃwveùÜ
(
S
->
L
, 
n
, 
LocV¬
);

188 
f
->
siz–ocv¬s
 = 
n
;

189 
i
 = 0; i < 
n
; i++)

190 
f
->
locv¬s
[
i
].
v¬Çme
 = 
NULL
;

191 
i
 = 0; i < 
n
; i++) {

192 
f
->
locv¬s
[
i
].
v¬Çme
 = 
	`LßdSŒšg
(
S
);

193 
f
->
locv¬s
[
i
].
¡¬c
 = 
	`LßdIÁ
(
S
);

194 
f
->
locv¬s
[
i
].
’dpc
 = 
	`LßdIÁ
(
S
);

196 
n
 = 
	`LßdIÁ
(
S
);

197 
i
 = 0; i < 
n
; i++)

198 
f
->
upv®ues
[
i
].
Çme
 = 
	`LßdSŒšg
(
S
);

199 
	}
}

202 
	$LßdFunùiÚ
 (
LßdS‹
 *
S
, 
PrÙo
 *
å
, 
TSŒšg
 *
psourû
) {

203 
Sh¬edPrÙo
 *
f
 = 
å
->
¥
;

204 
f
->
sourû
 = 
	`LßdSŒšg
(
S
);

205 ià(
f
->
sourû
 =ğ
NULL
)

206 
f
->
sourû
 = 
psourû
;

207 
f
->
lšedefšed
 = 
	`LßdIÁ
(
S
);

208 
f
->
Ï¡lšedefšed
 = 
	`LßdIÁ
(
S
);

209 
f
->
num·¿ms
 = 
	`LßdBy‹
(
S
);

210 
f
->
is_v¬¬g
 = 
	`LßdBy‹
(
S
);

211 
f
->
max¡acksize
 = 
	`LßdBy‹
(
S
);

212 
	`LßdCode
(
S
, 
f
);

213 
	`LßdCÚ¡ªts
(
S
, 
å
);

214 
	`LßdUpv®ues
(
S
, 
f
);

215 
	`LßdPrÙos
(
S
, 
å
);

216 
	`LßdDebug
(
S
, 
f
);

217 
	}
}

220 
	$checkl™”®
 (
LßdS‹
 *
S
, cÚ¡ *
s
, cÚ¡ *
msg
) {

221 
buff
[(
LUA_SIGNATURE
è+ (
LUAC_DATA
)];

222 
size_t
 
Ën
 = 
	`¡¾’
(
s
);

223 
	`LßdVeùÜ
(
S
, 
buff
, 
Ën
);

224 ià(
	`memcmp
(
s
, 
buff
, 
Ën
) != 0)

225 
	`”rÜ
(
S
, 
msg
);

226 
	}
}

229 
	$fchecksize
 (
LßdS‹
 *
S
, 
size_t
 
size
, cÚ¡ *
Šame
) {

230 ià(
	`LßdBy‹
(
S
è!ğ
size
)

231 
	`”rÜ
(
S
, 
	`luaO_pushf¡ršg
(S->
L
, "% sizmism©ch in", 
Šame
));

232 
	}
}

235 
	#checksize
(
S
,
t
è
	`fchecksize
(S,Ñ),#t)

	)

237 
	$checkH—d”
 (
LßdS‹
 *
S
) {

238 
	`checkl™”®
(
S
, 
LUA_SIGNATURE
 + 1, "not‡");

239 ià(
	`LßdBy‹
(
S
è!ğ
LUAC_VERSION
)

240 
	`”rÜ
(
S
, "version mismatch in");

241 ià(
	`LßdBy‹
(
S
è!ğ
LUAC_FORMAT
)

242 
	`”rÜ
(
S
, "format mismatch in");

243 
	`checkl™”®
(
S
, 
LUAC_DATA
, "corrupted");

244 
	`checksize
(
S
, );

245 
	`checksize
(
S
, 
size_t
);

246 
	`checksize
(
S
, 
In¡ruùiÚ
);

247 
	`checksize
(
S
, 
lua_IÁeg”
);

248 
	`checksize
(
S
, 
lua_Numb”
);

249 ià(
	`LßdIÁeg”
(
S
è!ğ
LUAC_INT
)

250 
	`”rÜ
(
S
, "endianness mismatch in");

251 ià(
	`LßdNumb”
(
S
è!ğ
LUAC_NUM
)

252 
	`”rÜ
(
S
, "float format mismatch in");

253 
	}
}

259 
LClosu»
 *
	$luaU_undump
(
lua_S‹
 *
L
, 
ZIO
 *
Z
, cÚ¡ *
Çme
) {

260 
LßdS‹
 
S
;

261 
LClosu»
 *
ş
;

262 ià(*
Çme
 == '@' || *name == '=')

263 
S
.
Çme
 =‚ame + 1;

264 ià(*
Çme
 =ğ
LUA_SIGNATURE
[0])

265 
S
.
Çme
 = "binary string";

267 
S
.
Çme
 =‚ame;

268 
S
.
L
 = L;

269 
S
.
Z
 = Z;

270 
	`checkH—d”
(&
S
);

271 
ş
 = 
	`luaF_ÃwLşosu»
(
L
, 
	`LßdBy‹
(&
S
));

272 
	`£tşLv®ue
(
L
, L->
tİ
, 
ş
);

273 
	`luaD_šùİ
(
L
);

274 
ş
->
p
 = 
	`luaF_Ãw´Ùo
(
L
, 
NULL
);

275 
	`LßdFunùiÚ
(&
S
, 
ş
->
p
, 
NULL
);

276 
	`lua_as£¹
(
ş
->
nupv®ues
 =ğş->
p
->
¥
->
sizeupv®ues
);

277 
	`luai_v”ifycode
(
L
, 
buff
, 
ş
->
p
);

278  
ş
;

279 
	}
}

	@3rd/lua/lundump.h

7 #iâdeà
lundump_h


8 
	#lundump_h


	)

10 
	~"Îim™s.h
"

11 
	~"lobjeù.h
"

12 
	~"lzio.h
"

16 
	#LUAC_DATA
 "\x19\x93\r\n\x1a\n"

	)

18 
	#LUAC_INT
 0x5678

	)

19 
	#LUAC_NUM
 
	`ÿ¡_num
(370.5)

	)

21 
	#MYINT
(
s
è(s[0]-'0')

	)

22 
	#LUAC_VERSION
 (
	`MYINT
(
LUA_VERSION_MAJOR
)*16+MYINT(
LUA_VERSION_MINOR
))

	)

23 
	#LUAC_FORMAT
 0

	)

26 
LUAI_FUNC
 
LClosu»
* 
luaU_undump
 (
lua_S‹
* 
L
, 
ZIO
* 
Z
, cÚ¡ * 
Çme
);

29 
LUAI_FUNC
 
luaU_dump
 (
lua_S‹
* 
L
, cÚ¡ 
PrÙo
* 
f
, 
lua_Wr™”
 
w
,

30 * 
d©a
, 
¡r
);

	@3rd/lua/lutf8lib.c

7 
	#lutf8lib_c


	)

8 
	#LUA_LIB


	)

10 
	~"Í»fix.h
"

13 
	~<as£¹.h
>

14 
	~<lim™s.h
>

15 
	~<¡dlib.h
>

16 
	~<¡ršg.h
>

18 
	~"lua.h
"

20 
	~"Ïuxlib.h
"

21 
	~"lu®ib.h
"

23 
	#MAXUNICODE
 0x10FFFF

	)

25 
	#iscÚt
(
p
è((*Õè& 0xC0è=ğ0x80)

	)

30 
lua_IÁeg”
 
	$u_po¤–©
 (
lua_IÁeg”
 
pos
, 
size_t
 
Ën
) {

31 ià(
pos
 >= 0) …os;

32 ià(0u - (
size_t
)
pos
 > 
Ën
)  0;

33  (
lua_IÁeg”
)
Ën
 + 
pos
 + 1;

34 
	}
}

40 cÚ¡ *
	$utf8_decode
 (cÚ¡ *
o
, *
v®
) {

41 cÚ¡ 
lim™s
[] = {0xFF, 0x7F, 0x7FF, 0xFFFF};

42 cÚ¡ *
s
 = (cÚ¡ *)
o
;

43 
c
 = 
s
[0];

44 
»s
 = 0;

45 ià(
c
 < 0x80)

46 
»s
 = 
c
;

48 
couÁ
 = 0;

49 
c
 & 0x40) {

50 
cc
 = 
s
[++
couÁ
];

51 ià((
cc
 & 0xC0) != 0x80)

52  
NULL
;

53 
»s
 = (» << 6è| (
cc
 & 0x3F);

54 
c
 <<= 1;

56 
»s
 |ğ((
c
 & 0x7Fè<< (
couÁ
 * 5));

57 ià(
couÁ
 > 3 || 
»s
 > 
MAXUNICODE
 ||„e <ğ
lim™s
[count])

58  
NULL
;

59 
s
 +ğ
couÁ
;

61 ià(
v®
è*v® = 
»s
;

62  (cÚ¡ *)
s
 + 1;

63 
	}
}

71 
	$utæ’
 (
lua_S‹
 *
L
) {

72 
n
 = 0;

73 
size_t
 
Ën
;

74 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

75 
lua_IÁeg”
 
posi
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
Ën
);

76 
lua_IÁeg”
 
posj
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, -1), 
Ën
);

77 
	`luaL_¬gcheck
(
L
, 1 <ğ
posi
 && --pos˜<ğ(
lua_IÁeg”
)
Ën
, 2,

79 
	`luaL_¬gcheck
(
L
, --
posj
 < (
lua_IÁeg”
)
Ën
, 3,

81 
posi
 <ğ
posj
) {

82 cÚ¡ *
s1
 = 
	`utf8_decode
(
s
 + 
posi
, 
NULL
);

83 ià(
s1
 =ğ
NULL
) {

84 
	`lua_pushn
(
L
);

85 
	`lua_pushš‹g”
(
L
, 
posi
 + 1);

88 
posi
 = 
s1
 - 
s
;

89 
n
++;

91 
	`lua_pushš‹g”
(
L
, 
n
);

93 
	}
}

100 
	$cod•ošt
 (
lua_S‹
 *
L
) {

101 
size_t
 
Ën
;

102 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

103 
lua_IÁeg”
 
posi
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 2, 1), 
Ën
);

104 
lua_IÁeg”
 
po£
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 3, 
posi
), 
Ën
);

105 
n
;

106 cÚ¡ *
£
;

107 
	`luaL_¬gcheck
(
L
, 
posi
 >= 1, 2, "out of„ange");

108 
	`luaL_¬gcheck
(
L
, 
po£
 <ğ(
lua_IÁeg”
)
Ën
, 3, "out of„ange");

109 ià(
posi
 > 
po£
)  0;

110 ià(
po£
 - 
posi
 >ğ
INT_MAX
)

111  
	`luaL_”rÜ
(
L
, "string sliceoo†ong");

112 
n
 = ()(
po£
 - 
posi
) + 1;

113 
	`luaL_check¡ack
(
L
, 
n
, "string sliceoo†ong");

114 
n
 = 0;

115 
£
 = 
s
 + 
po£
;

116 
s
 +ğ
posi
 - 1; s < 
£
;) {

117 
code
;

118 
s
 = 
	`utf8_decode
(s, &
code
);

119 ià(
s
 =ğ
NULL
)

120  
	`luaL_”rÜ
(
L
, "invalid UTF-8 code");

121 
	`lua_pushš‹g”
(
L
, 
code
);

122 
n
++;

124  
n
;

125 
	}
}

128 
	$pushutfch¬
 (
lua_S‹
 *
L
, 
¬g
) {

129 
lua_IÁeg”
 
code
 = 
	`luaL_checkš‹g”
(
L
, 
¬g
);

130 
	`luaL_¬gcheck
(
L
, 0 <ğ
code
 && cod<ğ
MAXUNICODE
, 
¬g
, "value out of„ange");

131 
	`lua_pushf¡ršg
(
L
, "%U", ()
code
);

132 
	}
}

138 
	$utfch¬
 (
lua_S‹
 *
L
) {

139 
n
 = 
	`lua_g‘tİ
(
L
);

140 ià(
n
 == 1)

141 
	`pushutfch¬
(
L
, 1);

143 
i
;

144 
luaL_Bufãr
 
b
;

145 
	`luaL_buffš™
(
L
, &
b
);

146 
i
 = 1; i <ğ
n
; i++) {

147 
	`pushutfch¬
(
L
, 
i
);

148 
	`luaL_addv®ue
(&
b
);

150 
	`luaL_push»suÉ
(&
b
);

153 
	}
}

160 
	$by‹off£t
 (
lua_S‹
 *
L
) {

161 
size_t
 
Ën
;

162 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

163 
lua_IÁeg”
 
n
 = 
	`luaL_checkš‹g”
(
L
, 2);

164 
lua_IÁeg”
 
posi
 = (
n
 >ğ0è? 1 : 
Ën
 + 1;

165 
posi
 = 
	`u_po¤–©
(
	`luaL_İtš‹g”
(
L
, 3,…osi), 
Ën
);

166 
	`luaL_¬gcheck
(
L
, 1 <ğ
posi
 && --pos˜<ğ(
lua_IÁeg”
)
Ën
, 3,

168 ià(
n
 == 0) {

170 
posi
 > 0 && 
	`iscÚt
(
s
 +…osi))…osi--;

173 ià(
	`iscÚt
(
s
 + 
posi
))

174 
	`luaL_”rÜ
(
L
, "initial…osition is‡ continuation byte");

175 ià(
n
 < 0) {

176 
n
 < 0 && 
posi
 > 0) {

178 
posi
--;

179 } 
posi
 > 0 && 
	`iscÚt
(
s
 +…osi));

180 
n
++;

184 
n
--;

185 
n
 > 0 && 
posi
 < (
lua_IÁeg”
)
Ën
) {

187 
posi
++;

188 } 
	`iscÚt
(
s
 + 
posi
));

189 
n
--;

193 ià(
n
 == 0)

194 
	`lua_pushš‹g”
(
L
, 
posi
 + 1);

196 
	`lua_pushn
(
L
);

198 
	}
}

201 
	$™”_aux
 (
lua_S‹
 *
L
) {

202 
size_t
 
Ën
;

203 cÚ¡ *
s
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

204 
lua_IÁeg”
 
n
 = 
	`lua_toš‹g”
(
L
, 2) - 1;

205 ià(
n
 < 0)

206 
n
 = 0;

207 ià(
n
 < (
lua_IÁeg”
)
Ën
) {

208 
n
++;

209 
	`iscÚt
(
s
 + 
n
))‚++;

211 ià(
n
 >ğ(
lua_IÁeg”
)
Ën
)

214 
code
;

215 cÚ¡ *
Ãxt
 = 
	`utf8_decode
(
s
 + 
n
, &
code
);

216 ià(
Ãxt
 =ğ
NULL
 || 
	`iscÚt
(next))

217  
	`luaL_”rÜ
(
L
, "invalid UTF-8 code");

218 
	`lua_pushš‹g”
(
L
, 
n
 + 1);

219 
	`lua_pushš‹g”
(
L
, 
code
);

222 
	}
}

225 
	$™”_codes
 (
lua_S‹
 *
L
) {

226 
	`luaL_check¡ršg
(
L
, 1);

227 
	`lua_pushcfunùiÚ
(
L
, 
™”_aux
);

228 
	`lua_pushv®ue
(
L
, 1);

229 
	`lua_pushš‹g”
(
L
, 0);

231 
	}
}

235 
	#UTF8PATT
 "[\0-\x7F\xC2-\xF4][\x80-\xBF]*"

	)

238 cÚ¡ 
luaL_Reg
 
	gfuncs
[] = {

239 {"off£t", 
by‹off£t
},

240 {"cod•ošt", 
cod•ošt
},

241 {"ch¬", 
utfch¬
},

242 {"Ën", 
utæ’
},

243 {"codes", 
™”_codes
},

245 {"ch¬·‰”n", 
NULL
},

246 {
NULL
, NULL}

250 
LUAMOD_API
 
	$luaİ’_utf8
 (
lua_S‹
 *
L
) {

251 
	`luaL_Ãwlib
(
L
, 
funcs
);

252 
	`lua_pushl¡ršg
(
L
, 
UTF8PATT
, (UTF8PATT)/() - 1);

253 
	`lua_£tf›ld
(
L
, -2, "charpattern");

255 
	}
}

	@3rd/lua/lvm.c

7 
	#lvm_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

12 
	~<æßt.h
>

13 
	~<lim™s.h
>

14 
	~<m©h.h
>

15 
	~<¡dio.h
>

16 
	~<¡dlib.h
>

17 
	~<¡ršg.h
>

19 
	~"lua.h
"

21 
	~"ldebug.h
"

22 
	~"ldo.h
"

23 
	~"lfunc.h
"

24 
	~"lgc.h
"

25 
	~"lobjeù.h
"

26 
	~"lİcodes.h
"

27 
	~"l¡©e.h
"

28 
	~"l¡ršg.h
"

29 
	~"ÉabË.h
"

30 
	~"Ém.h
"

31 
	~"lvm.h
"

35 
	#MAXTAGLOOP
 2000

	)

44 #ià!
defšed
(
l_štf™sf
)

47 
	#NBM
 (
	`l_m©hlim
(
MANT_DIG
))

	)

56 #ià((((
LUA_MAXINTEGER
 >> (
NBM
 / 4)) >> (NBM / 4)) >> (NBM / 4)) \

57 >> (
	gNBM
 - (3 * (NBM / 4)))) > 0

59 
	#l_štf™sf
(
i
) \

60 (-((
lua_IÁeg”
)1 << 
NBM
è<ğ(
i
è&& (iè<ğ(Öua_IÁeg”)1 << NBM))

	)

67 
lua_S‹
 * 
	gskyÃt_sig_L
 = 
NULL
;

69 
LUA_API
 

70 
	$lua_checksig_
(
lua_S‹
 *
L
) {

71 ià(
skyÃt_sig_L
 =ğ
	`G
(
L
)->
mašth»ad
) {

72 
skyÃt_sig_L
 = 
NULL
;

73 
	`lua_pushn
(
L
);

74 
	`lua_”rÜ
(
L
);

76 
	}
}

82 
	$luaV_tÚumb”_
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_Numb”
 *
n
) {

83 
TV®ue
 
v
;

84 ià(
	`‰isš‹g”
(
obj
)) {

85 *
n
 = 
	`ÿ¡_num
(
	`iv®ue
(
obj
));

88 ià(
	`cvt2num
(
obj
) &&

89 
	`luaO_¡r2num
(
	`sv®ue
(
obj
), &
v
è=ğ
	`v¦’
(obj) + 1) {

90 *
n
 = 
	`nv®ue
(&
v
);

95 
	}
}

104 
	$luaV_toš‹g”
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_IÁeg”
 *
p
, 
mode
) {

105 
TV®ue
 
v
;

106 
agaš
:

107 ià(
	`‰isæßt
(
obj
)) {

108 
lua_Numb”
 
n
 = 
	`ætv®ue
(
obj
);

109 
lua_Numb”
 
f
 = 
	`l_æoÜ
(
n
);

110 ià(
n
 !ğ
f
) {

111 ià(
mode
 == 0)  0;

112 ià(
mode
 > 1)

113 
f
 += 1;

115  
	`lua_numb”toš‹g”
(
f
, 
p
);

117 ià(
	`‰isš‹g”
(
obj
)) {

118 *
p
 = 
	`iv®ue
(
obj
);

121 ià(
	`cvt2num
(
obj
) &&

122 
	`luaO_¡r2num
(
	`sv®ue
(
obj
), &
v
è=ğ
	`v¦’
(obj) + 1) {

123 
obj
 = &
v
;

124 
agaš
;

127 
	}
}

145 
	$fÜlim™
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_IÁeg”
 *
p
,†ua_IÁeg” 
¡•
,

146 *
¡İnow
) {

147 *
¡İnow
 = 0;

148 ià(!
	`luaV_toš‹g”
(
obj
, 
p
, (
¡•
 < 0 ? 2 : 1))) {

149 
lua_Numb”
 
n
;

150 ià(!
	`tÚumb”
(
obj
, &
n
))

152 ià(
	`luai_numÉ
(0, 
n
)) {

153 *
p
 = 
LUA_MAXINTEGER
;

154 ià(
¡•
 < 0è*
¡İnow
 = 1;

157 *
p
 = 
LUA_MININTEGER
;

158 ià(
¡•
 >ğ0è*
¡İnow
 = 1;

162 
	}
}

170 
	$luaV_fšishg‘
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
, 
StkId
 
v®
,

171 cÚ¡ 
TV®ue
 *
¦Ù
) {

172 
loİ
;

173 cÚ¡ 
TV®ue
 *
tm
;

174 
loİ
 = 0;†oİ < 
MAXTAGLOOP
;†oop++) {

175 ià(
¦Ù
 =ğ
NULL
) {

176 
	`lua_as£¹
(!
	`‰i¡abË
(
t
));

177 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
t
, 
TM_INDEX
);

178 ià(
	`‰i¢
(
tm
))

179 
	`luaG_ty³”rÜ
(
L
, 
t
, "index");

183 
	`lua_as£¹
(
	`‰i¢
(
¦Ù
));

184 
tm
 = 
	`ç¡tm
(
L
, 
	`hv®ue
(
t
)->
m‘©abË
, 
TM_INDEX
);

185 ià(
tm
 =ğ
NULL
) {

186 
	`£Šv®ue
(
v®
);

191 ià(
	`‰isfunùiÚ
(
tm
)) {

192 
	`luaT_ÿÎTM
(
L
, 
tm
, 
t
, 
key
, 
v®
, 1);

195 
t
 = 
tm
;

196 ià(
	`luaV_ç¡g‘
(
L
,
t
,
key
,
¦Ù
,
luaH_g‘
)) {

197 
	`£tobj2s
(
L
, 
v®
, 
¦Ù
);

202 
	`luaG_ruÃ¼Ü
(
L
, "'__index' chainoo†ong;…ossible†oop");

203 
	}
}

213 
	$luaV_fšish£t
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

214 
StkId
 
v®
, cÚ¡ 
TV®ue
 *
¦Ù
) {

215 
loİ
;

216 
loİ
 = 0;†oİ < 
MAXTAGLOOP
;†oop++) {

217 cÚ¡ 
TV®ue
 *
tm
;

218 ià(
¦Ù
 !ğ
NULL
) {

219 
TabË
 *
h
 = 
	`hv®ue
(
t
);

220 
	`lua_as£¹
(
	`‰i¢
(
¦Ù
));

221 
tm
 = 
	`ç¡tm
(
L
, 
h
->
m‘©abË
, 
TM_NEWINDEX
);

222 ià(
tm
 =ğ
NULL
) {

223 ià(
¦Ù
 =ğ
luaO_nobjeù
)

224 
¦Ù
 = 
	`luaH_Ãwkey
(
L
, 
h
, 
key
);

226 
	`£tobj2t
(
L
, 
	`ÿ¡
(
TV®ue
 *, 
¦Ù
), 
v®
);

227 
	`šv®id©eTMÿche
(
h
);

228 
	`luaC_b¬r›rback
(
L
, 
h
, 
v®
);

234 ià(
	`‰i¢
(
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
t
, 
TM_NEWINDEX
)))

235 
	`luaG_ty³”rÜ
(
L
, 
t
, "index");

238 ià(
	`‰isfunùiÚ
(
tm
)) {

239 
	`luaT_ÿÎTM
(
L
, 
tm
, 
t
, 
key
, 
v®
, 0);

242 
t
 = 
tm
;

243 ià(
	`luaV_ç¡£t
(
L
, 
t
, 
key
, 
¦Ù
, 
luaH_g‘
, 
v®
))

247 
	`luaG_ruÃ¼Ü
(
L
, "'__newindex' chainoo†ong;…ossible†oop");

248 
	}
}

258 
	$l_¡rcmp
 (cÚ¡ 
TSŒšg
 *
ls
, cÚ¡ TSŒšg *
rs
) {

259 cÚ¡ *
l
 = 
	`g‘¡r
(
ls
);

260 
size_t
 
Î
 = 
	`ts¦’
(
ls
);

261 cÚ¡ *
r
 = 
	`g‘¡r
(
rs
);

262 
size_t
 
Ì
 = 
	`ts¦’
(
rs
);

264 
‹mp
 = 
	`¡rcŞl
(
l
, 
r
);

265 ià(
‹mp
 != 0)

266  
‹mp
;

268 
size_t
 
Ën
 = 
	`¡¾’
(
l
);

269 ià(
Ën
 =ğ
Ì
)

270  (
Ën
 =ğ
Î
) ? 0 : 1;

271 ià(
Ën
 =ğ
Î
)

274 
Ën
++;

275 
l
 +ğ
Ën
; 
Î
 -ğËn; 
r
 +ğËn; 
Ì
 -=†en;

278 
	}
}

291 
	$LTštæßt
 (
lua_IÁeg”
 
i
, 
lua_Numb”
 
f
) {

292 #ià
	`defšed
(
l_štf™sf
)

293 ià(!
	`l_štf™sf
(
i
)) {

294 ià(
f
 >ğ-
	`ÿ¡_num
(
LUA_MININTEGER
))

296 ià(
f
 > 
	`ÿ¡_num
(
LUA_MININTEGER
))

297  (
i
 < 
	`ÿ¡
(
lua_IÁeg”
, 
f
));

302  
	`luai_numÉ
(
	`ÿ¡_num
(
i
), 
f
);

303 
	}
}

310 
	$LEštæßt
 (
lua_IÁeg”
 
i
, 
lua_Numb”
 
f
) {

311 #ià
	`defšed
(
l_štf™sf
)

312 ià(!
	`l_štf™sf
(
i
)) {

313 ià(
f
 >ğ-
	`ÿ¡_num
(
LUA_MININTEGER
))

315 ià(
f
 >ğ
	`ÿ¡_num
(
LUA_MININTEGER
))

316  (
i
 <ğ
	`ÿ¡
(
lua_IÁeg”
, 
f
));

321  
	`luai_numË
(
	`ÿ¡_num
(
i
), 
f
);

322 
	}
}

328 
	$LTnum
 (cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

329 ià(
	`‰isš‹g”
(
l
)) {

330 
lua_IÁeg”
 
li
 = 
	`iv®ue
(
l
);

331 ià(
	`‰isš‹g”
(
r
))

332  
li
 < 
	`iv®ue
(
r
);

334  
	`LTštæßt
(
li
, 
	`ætv®ue
(
r
));

337 
lua_Numb”
 
lf
 = 
	`ætv®ue
(
l
);

338 ià(
	`‰isæßt
(
r
))

339  
	`luai_numÉ
(
lf
, 
	`ætv®ue
(
r
));

340 ià(
	`luai_numi¢ª
(
lf
))

343  !
	`LEštæßt
(
	`iv®ue
(
r
), 
lf
);

345 
	}
}

351 
	$LEnum
 (cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

352 ià(
	`‰isš‹g”
(
l
)) {

353 
lua_IÁeg”
 
li
 = 
	`iv®ue
(
l
);

354 ià(
	`‰isš‹g”
(
r
))

355  
li
 <ğ
	`iv®ue
(
r
);

357  
	`LEštæßt
(
li
, 
	`ætv®ue
(
r
));

360 
lua_Numb”
 
lf
 = 
	`ætv®ue
(
l
);

361 ià(
	`‰isæßt
(
r
))

362  
	`luai_numË
(
lf
, 
	`ætv®ue
(
r
));

363 ià(
	`luai_numi¢ª
(
lf
))

366  !
	`LTštæßt
(
	`iv®ue
(
r
), 
lf
);

368 
	}
}

374 
	$luaV_Ës¡hª
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

375 
»s
;

376 ià(
	`‰i¢umb”
(
l
è&&ti¢umb”(
r
))

377  
	`LTnum
(
l
, 
r
);

378 ià(
	`‰is¡ršg
(
l
è&&tis¡ršg(
r
))

379  
	`l_¡rcmp
(
	`tsv®ue
(
l
),sv®ue(
r
)) < 0;

380 ià((
»s
 = 
	`luaT_ÿÎÜd”TM
(
L
, 
l
, 
r
, 
TM_LT
)) < 0)

381 
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

382  
»s
;

383 
	}
}

394 
	$luaV_Ës£qu®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
) {

395 
»s
;

396 ià(
	`‰i¢umb”
(
l
è&&ti¢umb”(
r
))

397  
	`LEnum
(
l
, 
r
);

398 ià(
	`‰is¡ršg
(
l
è&&tis¡ršg(
r
))

399  
	`l_¡rcmp
(
	`tsv®ue
(
l
),sv®ue(
r
)) <= 0;

400 ià((
»s
 = 
	`luaT_ÿÎÜd”TM
(
L
, 
l
, 
r
, 
TM_LE
)) >= 0)

401  
»s
;

403 
L
->
ci
->
ÿÎ¡©us
 |ğ
CIST_LEQ
;

404 
»s
 = 
	`luaT_ÿÎÜd”TM
(
L
, 
r
, 
l
, 
TM_LT
);

405 
L
->
ci
->
ÿÎ¡©us
 ^ğ
CIST_LEQ
;

406 ià(
»s
 < 0)

407 
	`luaG_Üd””rÜ
(
L
, 
l
, 
r
);

408  !
»s
;

410 
	}
}

417 
	$luaV_equ®obj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
) {

418 cÚ¡ 
TV®ue
 *
tm
;

419 ià(
	`‰y³
(
t1
è!ğ‰y³(
t2
)) {

420 ià(
	`‰nov
(
t1
è!ğ‰nov(
t2
è||ŠovÑ1è!ğ
LUA_TNUMBER
)

423 
lua_IÁeg”
 
i1
, 
i2
;

424  (
	`toš‹g”
(
t1
, &
i1
è&&oš‹g”(
t2
, &
i2
) && i1 == i2);

428 
	`‰y³
(
t1
)) {

429 
LUA_TNIL
:  1;

430 
LUA_TNUMINT
:  (
	`iv®ue
(
t1
è=ğiv®ue(
t2
));

431 
LUA_TNUMFLT
:  
	`luai_numeq
(
	`ætv®ue
(
t1
), fÉv®ue(
t2
));

432 
LUA_TBOOLEAN
:  
	`bv®ue
(
t1
è=ğbv®ue(
t2
);

433 
LUA_TLIGHTUSERDATA
:  
	`pv®ue
(
t1
è=ğpv®ue(
t2
);

434 
LUA_TLCF
:  
	`fv®ue
(
t1
è=ğfv®ue(
t2
);

435 
LUA_TSHRSTR
:  
	`eqshr¡r
(
	`tsv®ue
(
t1
),sv®ue(
t2
));

436 
LUA_TLNGSTR
:  
	`luaS_eqÊg¡r
(
	`tsv®ue
(
t1
),sv®ue(
t2
));

437 
LUA_TUSERDATA
: {

438 ià(
	`uv®ue
(
t1
è=ğuv®ue(
t2
))  1;

439 ià(
L
 =ğ
NULL
)  0;

440 
tm
 = 
	`ç¡tm
(
L
, 
	`uv®ue
(
t1
)->
m‘©abË
, 
TM_EQ
);

441 ià(
tm
 =ğ
NULL
)

442 
tm
 = 
	`ç¡tm
(
L
, 
	`uv®ue
(
t2
)->
m‘©abË
, 
TM_EQ
);

445 
LUA_TTABLE
: {

446 ià(
	`hv®ue
(
t1
è=ğhv®ue(
t2
))  1;

447 ià(
L
 =ğ
NULL
)  0;

448 
tm
 = 
	`ç¡tm
(
L
, 
	`hv®ue
(
t1
)->
m‘©abË
, 
TM_EQ
);

449 ià(
tm
 =ğ
NULL
)

450 
tm
 = 
	`ç¡tm
(
L
, 
	`hv®ue
(
t2
)->
m‘©abË
, 
TM_EQ
);

454  
	`gcv®ue
(
t1
è=ğgcv®ue(
t2
);

456 ià(
tm
 =ğ
NULL
)

458 
	`luaT_ÿÎTM
(
L
, 
tm
, 
t1
, 
t2
, L->
tİ
, 1);

459  !
	`l_isçl£
(
L
->
tİ
);

460 
	}
}

464 
	#to¡ršg
(
L
,
o
) \

465 (
	`‰is¡ršg
(
o
è|| (
	`cvt2¡r
(oè&& (
	`luaO_to¡ršg
(
L
, o), 1)))

	)

467 
	#i£m±y¡r
(
o
è(
	`‰isshr¡ršg
(oè&& 
	`tsv®ue
(o)->
sh¾’
 =ğ0)

	)

470 
	$cİy2buff
 (
StkId
 
tİ
, 
n
, *
buff
) {

471 
size_t
 

 = 0;

473 
size_t
 
l
 = 
	`v¦’
(
tİ
 - 
n
);

474 
	`memıy
(
buff
 + 

, 
	`sv®ue
(
tİ
 - 
n
), 
l
 * ());

475 

 +ğ
l
;

476 } --
n
 > 0);

477 
	}
}

484 
	$luaV_cÚÿt
 (
lua_S‹
 *
L
, 
tÙ®
) {

485 
	`lua_as£¹
(
tÙ®
 >= 2);

487 
StkId
 
tİ
 = 
L
->top;

488 
n
 = 2;

489 ià(!(
	`‰is¡ršg
(
tİ
-2è|| 
	`cvt2¡r
Ñİ-2)è|| !
	`to¡ršg
(
L
,op-1))

490 
	`luaT_ŒybšTM
(
L
, 
tİ
-2,İ-1,İ-2, 
TM_CONCAT
);

491 ià(
	`i£m±y¡r
(
tİ
 - 1))

492 
	`ÿ¡_void
(
	`to¡ršg
(
L
, 
tİ
 - 2));

493 ià(
	`i£m±y¡r
(
tİ
 - 2)) {

494 
	`£tobjs2s
(
L
, 
tİ
 - 2,op - 1);

498 
size_t
 

 = 
	`v¦’
(
tİ
 - 1);

499 
TSŒšg
 *
ts
;

501 
n
 = 1;‚ < 
tÙ®
 && 
	`to¡ršg
(
L
, 
tİ
 -‚ - 1);‚++) {

502 
size_t
 
l
 = 
	`v¦’
(
tİ
 - 
n
 - 1);

503 ià(
l
 >ğ(
MAX_SIZE
/()è- 

)

504 
	`luaG_ruÃ¼Ü
(
L
, "string†ength overflow");

505 

 +ğ
l
;

507 ià(

 <ğ
LUAI_MAXSHORTLEN
) {

508 
buff
[
LUAI_MAXSHORTLEN
];

509 
	`cİy2buff
(
tİ
, 
n
, 
buff
);

510 
ts
 = 
	`luaS_Ãwl¡r
(
L
, 
buff
, 

);

513 
ts
 = 
	`luaS_ü—‹Êg¡robj
(
L
, 

);

514 
	`cİy2buff
(
tİ
, 
n
, 
	`g‘¡r
(
ts
));

516 
	`£tsv®ue2s
(
L
, 
tİ
 - 
n
, 
ts
);

518 
tÙ®
 -ğ
n
-1;

519 
L
->
tİ
 -ğ
n
-1;

520 } 
tÙ®
 > 1);

521 
	}
}

527 
	$luaV_objËn
 (
lua_S‹
 *
L
, 
StkId
 
¿
, cÚ¡ 
TV®ue
 *
rb
) {

528 cÚ¡ 
TV®ue
 *
tm
;

529 
	`‰y³
(
rb
)) {

530 
LUA_TTABLE
: {

531 
TabË
 *
h
 = 
	`hv®ue
(
rb
);

532 
tm
 = 
	`ç¡tm
(
L
, 
h
->
m‘©abË
, 
TM_LEN
);

533 ià(
tm
) ;

534 
	`£tiv®ue
(
¿
, 
	`luaH_g‘n
(
h
));

537 
LUA_TSHRSTR
: {

538 
	`£tiv®ue
(
¿
, 
	`tsv®ue
(
rb
)->
sh¾’
);

541 
LUA_TLNGSTR
: {

542 
	`£tiv®ue
(
¿
, 
	`tsv®ue
(
rb
)->
u
.
ÊgËn
);

546 
tm
 = 
	`luaT_g‘tmbyobj
(
L
, 
rb
, 
TM_LEN
);

547 ià(
	`‰i¢
(
tm
))

548 
	`luaG_ty³”rÜ
(
L
, 
rb
, "get†ength of");

552 
	`luaT_ÿÎTM
(
L
, 
tm
, 
rb
,„b, 
¿
, 1);

553 
	}
}

562 
lua_IÁeg”
 
	$luaV_div
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
m
,†ua_IÁeg” 
n
) {

563 ià(
	`l_ÿ¡S2U
(
n
) + 1u <= 1u) {

564 ià(
n
 == 0)

565 
	`luaG_ruÃ¼Ü
(
L
, "attempto divide by zero");

566  
	`štİ
(-, 0, 
m
);

569 
lua_IÁeg”
 
q
 = 
m
 / 
n
;

570 ià((
m
 ^ 
n
) < 0 && m %‚ != 0)

571 
q
 -= 1;

572  
q
;

574 
	}
}

582 
lua_IÁeg”
 
	$luaV_mod
 (
lua_S‹
 *
L
, 
lua_IÁeg”
 
m
,†ua_IÁeg” 
n
) {

583 ià(
	`l_ÿ¡S2U
(
n
) + 1u <= 1u) {

584 ià(
n
 == 0)

585 
	`luaG_ruÃ¼Ü
(
L
, "attempto…erform 'n%%0'");

589 
lua_IÁeg”
 
r
 = 
m
 % 
n
;

590 ià(
r
 !ğ0 && (
m
 ^ 
n
) < 0)

591 
r
 +ğ
n
;

592  
r
;

594 
	}
}

598 
	#NBITS
 
	`ÿ¡_št
((
lua_IÁeg”
è* 
CHAR_BIT
)

	)

603 
lua_IÁeg”
 
	$luaV_shiál
 (
lua_IÁeg”
 
x
,†ua_IÁeg” 
y
) {

604 ià(
y
 < 0) {

605 ià(
y
 <ğ-
NBITS
)  0;

606  
	`štİ
(>>, 
x
, -
y
);

609 ià(
y
 >ğ
NBITS
)  0;

610  
	`štİ
(<<, 
x
, 
y
);

612 
	}
}

620 
LClosu»
 *
	$g‘ÿched
 (
PrÙo
 *
p
, 
UpV®
 **
’cup
, 
StkId
 
ba£
) {

621 
LClosu»
 *
c
 = 
p
->
ÿche
;

622 ià(
c
 !ğ
NULL
) {

623 
nup
 = 
p
->
¥
->
sizeupv®ues
;

624 
Upv®desc
 *
uv
 = 
p
->
¥
->
upv®ues
;

625 
i
;

626 
i
 = 0; i < 
nup
; i++) {

627 
TV®ue
 *
v
 = 
uv
[
i
].
š¡ack
 ? 
ba£
 + uv[i].
idx
 : 
’cup
[uv[i].idx]->v;

628 ià(
c
->
upv®s
[
i
]->
v
 != v)

629  
NULL
;

632  
c
;

633 
	}
}

642 
	$pushşosu»
 (
lua_S‹
 *
L
, 
PrÙo
 *
p
, 
UpV®
 **
’cup
, 
StkId
 
ba£
,

643 
StkId
 
¿
) {

644 
nup
 = 
p
->
¥
->
sizeupv®ues
;

645 
Upv®desc
 *
uv
 = 
p
->
¥
->
upv®ues
;

646 
i
;

647 
LClosu»
 *
nş
 = 
	`luaF_ÃwLşosu»
(
L
, 
nup
);

648 
nş
->
p
 =…;

649 
	`£tşLv®ue
(
L
, 
¿
, 
nş
);

650 
i
 = 0; i < 
nup
; i++) {

651 ià(
uv
[
i
].
š¡ack
)

652 
nş
->
upv®s
[
i
] = 
	`luaF_fšdupv®
(
L
, 
ba£
 + 
uv
[i].
idx
);

654 
nş
->
upv®s
[
i
] = 
’cup
[
uv
[i].
idx
];

655 
nş
->
upv®s
[
i
]->
»fcouÁ
++;

658 ià(!
	`isbÏck
(
p
))

659 
p
->
ÿche
 = 
nş
;

660 
	}
}

666 
	$luaV_fšishOp
 (
lua_S‹
 *
L
) {

667 
C®lInfo
 *
ci
 = 
L
->ci;

668 
StkId
 
ba£
 = 
ci
->
u
.
l
.base;

669 
In¡ruùiÚ
 
š¡
 = *(
ci
->
u
.
l
.
§vedpc
 - 1);

670 
OpCode
 
İ
 = 
	`GET_OPCODE
(
š¡
);

671 
İ
) {

672 
OP_ADD
: 
OP_SUB
: 
OP_MUL
: 
OP_DIV
: 
OP_IDIV
:

673 
OP_BAND
: 
OP_BOR
: 
OP_BXOR
: 
OP_SHL
: 
OP_SHR
:

674 
OP_MOD
: 
OP_POW
:

675 
OP_UNM
: 
OP_BNOT
: 
OP_LEN
:

676 
OP_GETTABUP
: 
OP_GETTABLE
: 
OP_SELF
: {

677 
	`£tobjs2s
(
L
, 
ba£
 + 
	`GETARG_A
(
š¡
), --L->
tİ
);

680 
OP_LE
: 
OP_LT
: 
OP_EQ
: {

681 
»s
 = !
	`l_isçl£
(
L
->
tİ
 - 1);

682 
L
->
tİ
--;

683 ià(
ci
->
ÿÎ¡©us
 & 
CIST_LEQ
) {

684 
	`lua_as£¹
(
İ
 =ğ
OP_LE
);

685 
ci
->
ÿÎ¡©us
 ^ğ
CIST_LEQ
;

686 
»s
 = !res;

688 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_JMP
);

689 ià(
»s
 !ğ
	`GETARG_A
(
š¡
))

690 
ci
->
u
.
l
.
§vedpc
++;

693 
OP_CONCAT
: {

694 
StkId
 
tİ
 = 
L
->top - 1;

695 
b
 = 
	`GETARG_B
(
š¡
);

696 
tÙ®
 = 
	`ÿ¡_št
(
tİ
 - 1 - (
ba£
 + 
b
));

697 
	`£tobj2s
(
L
, 
tİ
 - 2,op);

698 ià(
tÙ®
 > 1) {

699 
L
->
tİ
 =op - 1;

700 
	`luaV_cÚÿt
(
L
, 
tÙ®
);

703 
	`£tobj2s
(
L
, 
ci
->
u
.
l
.
ba£
 + 
	`GETARG_A
(
š¡
), L->
tİ
 - 1);

704 
L
->
tİ
 = 
ci
->top;

707 
OP_TFORCALL
: {

708 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_TFORLOOP
);

709 
L
->
tİ
 = 
ci
->top;

712 
OP_CALL
: {

713 ià(
	`GETARG_C
(
š¡
) - 1 >= 0)

714 
L
->
tİ
 = 
ci
->top;

717 
OP_TAILCALL
: 
OP_SETTABUP
: 
OP_SETTABLE
:

719 : 
	`lua_as£¹
(0);

721 
	}
}

738 
	#RA
(
i
è(
ba£
+
	`GETARG_A
(i))

	)

739 
	#RB
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgR
, 
ba£
+
	`GETARG_B
(i))

	)

740 
	#RC
(
i
è
	`check_exp
(
	`g‘CMode
(
	`GET_OPCODE
(i)è=ğ
OpArgR
, 
ba£
+
	`GETARG_C
(i))

	)

741 
	#RKB
(
i
è
	`check_exp
(
	`g‘BMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, \

742 
	`ISK
(
	`GETARG_B
(
i
)è? 
k
+
	`INDEXK
(GETARG_B(i)è: 
ba£
+GETARG_B(i))

	)

743 
	#RKC
(
i
è
	`check_exp
(
	`g‘CMode
(
	`GET_OPCODE
(i)è=ğ
OpArgK
, \

744 
	`ISK
(
	`GETARG_C
(
i
)è? 
k
+
	`INDEXK
(GETARG_C(i)è: 
ba£
+GETARG_C(i))

	)

748 
	#dojump
(
ci
,
i
,
e
) \

749 { 
a
 = 
	`GETARG_A
(
i
); \

750 ià(
a
 !ğ0è
	`luaF_şo£
(
L
, 
ci
->
u
.
l
.
ba£
 +‡ - 1); \

751 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
è+ 
e
; }

	)

754 
	#dÚextjump
(
ci
è{ 
i
 = *ci->
u
.
l
.
§vedpc
; 
	`dojump
(ci, i, 1); }

	)

757 
	#PrÙeù
(
x
è{ {x;}; 
ba£
 = 
ci
->
u
.
l
.ba£; }

	)

759 
	#checkGC
(
L
,
c
) \

760 { 
	`luaC_cÚdGC
(
L
, L->
tİ
 = (
c
), \

761 
	`PrÙeù
(
L
->
tİ
 = 
ci
->top)); \

762 
	`luai_th»ady›ld
(
L
); }

	)

766 
	#vmãtch
() { \

767 
i
 = *(
ci
->
u
.
l
.
§vedpc
++); \

768 ià(
L
->
hookmask
 & (
LUA_MASKLINE
 | 
LUA_MASKCOUNT
)) \

769 
	`PrÙeù
(
	`luaG_Œaûexec
(
L
)); \

770 
¿
 = 
	`RA
(
i
); \

771 
	`lua_as£¹
(
ba£
 =ğ
ci
->
u
.
l
.base); \

772 
	`lua_as£¹
(
ba£
 <ğ
L
->
tİ
 && L->tİ < L->
¡ack
 + L->
¡acksize
); \

773 }

	)

775 
	#vmdi¥©ch
(
o
èo)

	)

776 
	#vmÿ£
(
l
èl:

	)

777 
	#vmb»ak
 

	)

784 
	#g‘bËPrÙeùed
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

785 ià(
	`luaV_ç¡g‘
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
)è{ 
	`£tobj2s
(L, 
v
, slot); } \

786 
	`PrÙeù
(
	`luaV_fšishg‘
(
L
,
t
,
k
,
v
,
¦Ù
)); }

	)

790 
	#£‰abËPrÙeùed
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

791 ià(!
	`luaV_ç¡£t
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
,
v
)) \

792 
	`PrÙeù
(
	`luaV_fšish£t
(
L
,
t
,
k
,
v
,
¦Ù
)); }

	)

796 
	$luaV_execu‹
 (
lua_S‹
 *
L
) {

797 
C®lInfo
 *
ci
 = 
L
->ci;

798 
LClosu»
 *
ş
;

799 
TV®ue
 *
k
;

800 
StkId
 
ba£
;

801 
ci
->
ÿÎ¡©us
 |ğ
CIST_FRESH
;

802 
Ãwäame
:

803 
	`lua_as£¹
(
ci
 =ğ
L
->ci);

804 
ş
 = 
	`şLv®ue
(
ci
->
func
);

805 
k
 = 
ş
->
p
->k;

806 
ba£
 = 
ci
->
u
.
l
.base;

809 
In¡ruùiÚ
 
i
;

810 
StkId
 
¿
;

811 
	`vmãtch
();

812 
	`vmdi¥©ch
 (
	`GET_OPCODE
(
i
)) {

813 
	`vmÿ£
(
OP_MOVE
) {

814 
	`£tobjs2s
(
L
, 
¿
, 
	`RB
(
i
));

815 
vmb»ak
;

817 
	`vmÿ£
(
OP_LOADK
) {

818 
TV®ue
 *
rb
 = 
k
 + 
	`GETARG_Bx
(
i
);

819 
	`£tobj2s
(
L
, 
¿
, 
rb
);

820 
vmb»ak
;

822 
	`vmÿ£
(
OP_LOADKX
) {

823 
TV®ue
 *
rb
;

824 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_EXTRAARG
);

825 
rb
 = 
k
 + 
	`GETARG_Ax
(*
ci
->
u
.
l
.
§vedpc
++);

826 
	`£tobj2s
(
L
, 
¿
, 
rb
);

827 
vmb»ak
;

829 
	`vmÿ£
(
OP_LOADBOOL
) {

830 
	`£tbv®ue
(
¿
, 
	`GETARG_B
(
i
));

831 ià(
	`GETARG_C
(
i
)è
ci
->
u
.
l
.
§vedpc
++;

832 
vmb»ak
;

834 
	`vmÿ£
(
OP_LOADNIL
) {

835 
b
 = 
	`GETARG_B
(
i
);

837 
	`£Šv®ue
(
¿
++);

838 } 
b
--);

839 
vmb»ak
;

841 
	`vmÿ£
(
OP_GETUPVAL
) {

842 
b
 = 
	`GETARG_B
(
i
);

843 
	`£tobj2s
(
L
, 
¿
, 
ş
->
upv®s
[
b
]->
v
);

844 
vmb»ak
;

846 
	`vmÿ£
(
OP_GETTABUP
) {

847 
TV®ue
 *
upv®
 = 
ş
->
upv®s
[
	`GETARG_B
(
i
)]->
v
;

848 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

849 
	`g‘bËPrÙeùed
(
L
, 
upv®
, 
rc
, 
¿
);

850 
vmb»ak
;

852 
	`vmÿ£
(
OP_GETTABLE
) {

853 
StkId
 
rb
 = 
	`RB
(
i
);

854 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

855 
	`g‘bËPrÙeùed
(
L
, 
rb
, 
rc
, 
¿
);

856 
vmb»ak
;

858 
	`vmÿ£
(
OP_SETTABUP
) {

859 
TV®ue
 *
upv®
 = 
ş
->
upv®s
[
	`GETARG_A
(
i
)]->
v
;

860 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

861 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

862 
	`£‰abËPrÙeùed
(
L
, 
upv®
, 
rb
, 
rc
);

863 
vmb»ak
;

865 
	`vmÿ£
(
OP_SETUPVAL
) {

866 
UpV®
 *
uv
 = 
ş
->
upv®s
[
	`GETARG_B
(
i
)];

867 
	`£tobj
(
L
, 
uv
->
v
, 
¿
);

868 
	`luaC_upv®b¬r›r
(
L
, 
uv
);

869 
vmb»ak
;

871 
	`vmÿ£
(
OP_SETTABLE
) {

872 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

873 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

874 
	`£‰abËPrÙeùed
(
L
, 
¿
, 
rb
, 
rc
);

875 
vmb»ak
;

877 
	`vmÿ£
(
OP_NEWTABLE
) {

878 
b
 = 
	`GETARG_B
(
i
);

879 
c
 = 
	`GETARG_C
(
i
);

880 
TabË
 *
t
 = 
	`luaH_Ãw
(
L
);

881 
	`£thv®ue
(
L
, 
¿
, 
t
);

882 ià(
b
 !ğ0 || 
c
 != 0)

883 
	`luaH_»size
(
L
, 
t
, 
	`luaO_fb2št
(
b
),†uaO_fb2št(
c
));

884 
	`checkGC
(
L
, 
¿
 + 1);

885 
vmb»ak
;

887 
	`vmÿ£
(
OP_SELF
) {

888 cÚ¡ 
TV®ue
 *
aux
;

889 
StkId
 
rb
 = 
	`RB
(
i
);

890 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

891 
TSŒšg
 *
key
 = 
	`tsv®ue
(
rc
);

892 
	`£tobjs2s
(
L
, 
¿
 + 1, 
rb
);

893 ià(
	`luaV_ç¡g‘
(
L
, 
rb
, 
key
, 
aux
, 
luaH_g‘¡r
)) {

894 
	`£tobj2s
(
L
, 
¿
, 
aux
);

896 
	`PrÙeù
(
	`luaV_fšishg‘
(
L
, 
rb
, 
rc
, 
¿
, 
aux
));

897 
vmb»ak
;

899 
	`vmÿ£
(
OP_ADD
) {

900 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

901 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

902 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

903 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

904 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

905 
	`£tiv®ue
(
¿
, 
	`štİ
(+, 
ib
, 
ic
));

907 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

908 
	`£tætv®ue
(
¿
, 
	`luai_numadd
(
L
, 
nb
, 
nc
));

910 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_ADD
)); }

911 
vmb»ak
;

913 
	`vmÿ£
(
OP_SUB
) {

914 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

915 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

916 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

917 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

918 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

919 
	`£tiv®ue
(
¿
, 
	`štİ
(-, 
ib
, 
ic
));

921 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

922 
	`£tætv®ue
(
¿
, 
	`luai_numsub
(
L
, 
nb
, 
nc
));

924 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_SUB
)); }

925 
vmb»ak
;

927 
	`vmÿ£
(
OP_MUL
) {

928 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

929 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

930 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

931 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

932 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

933 
	`£tiv®ue
(
¿
, 
	`štİ
(*, 
ib
, 
ic
));

935 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

936 
	`£tætv®ue
(
¿
, 
	`luai_nummul
(
L
, 
nb
, 
nc
));

938 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_MUL
)); }

939 
vmb»ak
;

941 
	`vmÿ£
(
OP_DIV
) {

942 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

943 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

944 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

945 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

946 
	`£tætv®ue
(
¿
, 
	`luai_numdiv
(
L
, 
nb
, 
nc
));

948 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_DIV
)); }

949 
vmb»ak
;

951 
	`vmÿ£
(
OP_BAND
) {

952 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

953 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

954 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

955 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

956 
	`£tiv®ue
(
¿
, 
	`štİ
(&, 
ib
, 
ic
));

958 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_BAND
)); }

959 
vmb»ak
;

961 
	`vmÿ£
(
OP_BOR
) {

962 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

963 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

964 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

965 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

966 
	`£tiv®ue
(
¿
, 
	`štİ
(|, 
ib
, 
ic
));

968 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_BOR
)); }

969 
vmb»ak
;

971 
	`vmÿ£
(
OP_BXOR
) {

972 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

973 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

974 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

975 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

976 
	`£tiv®ue
(
¿
, 
	`štİ
(^, 
ib
, 
ic
));

978 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_BXOR
)); }

979 
vmb»ak
;

981 
	`vmÿ£
(
OP_SHL
) {

982 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

983 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

984 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

985 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

986 
	`£tiv®ue
(
¿
, 
	`luaV_shiál
(
ib
, 
ic
));

988 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_SHL
)); }

989 
vmb»ak
;

991 
	`vmÿ£
(
OP_SHR
) {

992 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

993 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

994 
lua_IÁeg”
 
ib
;†ua_IÁeg” 
ic
;

995 ià(
	`toš‹g”
(
rb
, &
ib
è&&oš‹g”(
rc
, &
ic
)) {

996 
	`£tiv®ue
(
¿
, 
	`luaV_shiál
(
ib
, -
ic
));

998 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_SHR
)); }

999 
vmb»ak
;

1001 
	`vmÿ£
(
OP_MOD
) {

1002 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1003 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1004 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

1005 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

1006 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

1007 
	`£tiv®ue
(
¿
, 
	`luaV_mod
(
L
, 
ib
, 
ic
));

1009 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

1010 
lua_Numb”
 
m
;

1011 
	`luai_nummod
(
L
, 
nb
, 
nc
, 
m
);

1012 
	`£tætv®ue
(
¿
, 
m
);

1014 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_MOD
)); }

1015 
vmb»ak
;

1017 
	`vmÿ£
(
OP_IDIV
) {

1018 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1019 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1020 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

1021 ià(
	`‰isš‹g”
(
rb
è&&tisš‹g”(
rc
)) {

1022 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);†ua_IÁeg” 
ic
 = iv®ue(
rc
);

1023 
	`£tiv®ue
(
¿
, 
	`luaV_div
(
L
, 
ib
, 
ic
));

1025 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

1026 
	`£tætv®ue
(
¿
, 
	`luai_numidiv
(
L
, 
nb
, 
nc
));

1028 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_IDIV
)); }

1029 
vmb»ak
;

1031 
	`vmÿ£
(
OP_POW
) {

1032 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1033 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1034 
lua_Numb”
 
nb
;†ua_Numb” 
nc
;

1035 ià(
	`tÚumb”
(
rb
, &
nb
è&&Úumb”(
rc
, &
nc
)) {

1036 
	`£tætv®ue
(
¿
, 
	`luai_numpow
(
L
, 
nb
, 
nc
));

1038 { 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
, 
rc
, 
¿
, 
TM_POW
)); }

1039 
vmb»ak
;

1041 
	`vmÿ£
(
OP_UNM
) {

1042 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1043 
lua_Numb”
 
nb
;

1044 ià(
	`‰isš‹g”
(
rb
)) {

1045 
lua_IÁeg”
 
ib
 = 
	`iv®ue
(
rb
);

1046 
	`£tiv®ue
(
¿
, 
	`štİ
(-, 0, 
ib
));

1048 ià(
	`tÚumb”
(
rb
, &
nb
)) {

1049 
	`£tætv®ue
(
¿
, 
	`luai_numunm
(
L
, 
nb
));

1052 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
,„b, 
¿
, 
TM_UNM
));

1054 
vmb»ak
;

1056 
	`vmÿ£
(
OP_BNOT
) {

1057 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1058 
lua_IÁeg”
 
ib
;

1059 ià(
	`toš‹g”
(
rb
, &
ib
)) {

1060 
	`£tiv®ue
(
¿
, 
	`štİ
(^, ~
	`l_ÿ¡S2U
(0), 
ib
));

1063 
	`PrÙeù
(
	`luaT_ŒybšTM
(
L
, 
rb
,„b, 
¿
, 
TM_BNOT
));

1065 
vmb»ak
;

1067 
	`vmÿ£
(
OP_NOT
) {

1068 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1069 
»s
 = 
	`l_isçl£
(
rb
);

1070 
	`£tbv®ue
(
¿
, 
»s
);

1071 
vmb»ak
;

1073 
	`vmÿ£
(
OP_LEN
) {

1074 
	`PrÙeù
(
	`luaV_objËn
(
L
, 
¿
, 
	`RB
(
i
)));

1075 
vmb»ak
;

1077 
	`vmÿ£
(
OP_CONCAT
) {

1078 
b
 = 
	`GETARG_B
(
i
);

1079 
c
 = 
	`GETARG_C
(
i
);

1080 
StkId
 
rb
;

1081 
L
->
tİ
 = 
ba£
 + 
c
 + 1;

1082 
	`PrÙeù
(
	`luaV_cÚÿt
(
L
, 
c
 - 
b
 + 1));

1083 
¿
 = 
	`RA
(
i
);

1084 
rb
 = 
ba£
 + 
b
;

1085 
	`£tobjs2s
(
L
, 
¿
, 
rb
);

1086 
	`checkGC
(
L
, (
¿
 >ğ
rb
 ?„a + 1 :„b));

1087 
L
->
tİ
 = 
ci
->top;

1088 
vmb»ak
;

1090 
	`vmÿ£
(
OP_JMP
) {

1091 
	`lua_checksig
(
L
);

1092 
	`dojump
(
ci
, 
i
, 0);

1093 
vmb»ak
;

1095 
	`vmÿ£
(
OP_EQ
) {

1096 
TV®ue
 *
rb
 = 
	`RKB
(
i
);

1097 
TV®ue
 *
rc
 = 
	`RKC
(
i
);

1098 
	`PrÙeù
(

1099 ià(
	`luaV_equ®obj
(
L
, 
rb
, 
rc
è!ğ
	`GETARG_A
(
i
))

1100 
ci
->
u
.
l
.
§vedpc
++;

1102 
	`dÚextjump
(
ci
);

1104 
vmb»ak
;

1106 
	`vmÿ£
(
OP_LT
) {

1107 
	`PrÙeù
(

1108 ià(
	`luaV_Ës¡hª
(
L
, 
	`RKB
(
i
), 
	`RKC
(i)è!ğ
	`GETARG_A
(i))

1109 
ci
->
u
.
l
.
§vedpc
++;

1111 
	`dÚextjump
(
ci
);

1113 
vmb»ak
;

1115 
	`vmÿ£
(
OP_LE
) {

1116 
	`PrÙeù
(

1117 ià(
	`luaV_Ës£qu®
(
L
, 
	`RKB
(
i
), 
	`RKC
(i)è!ğ
	`GETARG_A
(i))

1118 
ci
->
u
.
l
.
§vedpc
++;

1120 
	`dÚextjump
(
ci
);

1122 
vmb»ak
;

1124 
	`vmÿ£
(
OP_TEST
) {

1125 ià(
	`GETARG_C
(
i
è? 
	`l_isçl£
(
¿
) : !l_isfalse(ra))

1126 
ci
->
u
.
l
.
§vedpc
++;

1128 
	`dÚextjump
(
ci
);

1129 
vmb»ak
;

1131 
	`vmÿ£
(
OP_TESTSET
) {

1132 
TV®ue
 *
rb
 = 
	`RB
(
i
);

1133 ià(
	`GETARG_C
(
i
è? 
	`l_isçl£
(
rb
) : !l_isfalse(rb))

1134 
ci
->
u
.
l
.
§vedpc
++;

1136 
	`£tobjs2s
(
L
, 
¿
, 
rb
);

1137 
	`dÚextjump
(
ci
);

1139 
vmb»ak
;

1141 
	`vmÿ£
(
OP_CALL
) {

1142 
b
 = 
	`GETARG_B
(
i
);

1143 
ÄesuÉs
 = 
	`GETARG_C
(
i
) - 1;

1144 
	`lua_checksig
(
L
);

1145 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b;

1146 ià(
	`luaD_´eÿÎ
(
L
, 
¿
, 
ÄesuÉs
)) {

1147 ià(
ÄesuÉs
 >= 0)

1148 
L
->
tİ
 = 
ci
->top;

1149 
	`PrÙeù
(()0);

1152 
ci
 = 
L
->ci;

1153 
Ãwäame
;

1155 
vmb»ak
;

1157 
	`vmÿ£
(
OP_TAILCALL
) {

1158 
b
 = 
	`GETARG_B
(
i
);

1159 
	`lua_checksig
(
L
);

1160 ià(
b
 !ğ0è
L
->
tİ
 = 
¿
+b;

1161 
	`lua_as£¹
(
	`GETARG_C
(
i
è- 1 =ğ
LUA_MULTRET
);

1162 ià(
	`luaD_´eÿÎ
(
L
, 
¿
, 
LUA_MULTRET
)) {

1163 
	`PrÙeù
(()0);

1167 
C®lInfo
 *
nci
 = 
L
->
ci
;

1168 
C®lInfo
 *
oci
 = 
nci
->
´evious
;

1169 
StkId
 
nfunc
 = 
nci
->
func
;

1170 
StkId
 
ofunc
 = 
oci
->
func
;

1172 
StkId
 
lim
 = 
nci
->
u
.
l
.
ba£
 + 
	`g‘´Ùo
(
nfunc
)->
¥
->
num·¿ms
;

1173 
aux
;

1175 ià(
ş
->
p
->
¥
->
siz•
 > 0è
	`luaF_şo£
(
L
, 
oci
->
u
.
l
.
ba£
);

1177 
aux
 = 0; 
nfunc
 +‡ux < 
lim
;‡ux++)

1178 
	`£tobjs2s
(
L
, 
ofunc
 + 
aux
, 
nfunc
 +‡ux);

1179 
oci
->
u
.
l
.
ba£
 = 
ofunc
 + (
nci
->u.l.ba£ - 
nfunc
);

1180 
oci
->
tİ
 = 
L
->tİ = 
ofunc
 + (L->tİ - 
nfunc
);

1181 
oci
->
u
.
l
.
§vedpc
 = 
nci
->u.l.savedpc;

1182 
oci
->
ÿÎ¡©us
 |ğ
CIST_TAIL
;

1183 
ci
 = 
L
->c˜ğ
oci
;

1184 
	`lua_as£¹
(
L
->
tİ
 =ğ
oci
->
u
.
l
.
ba£
 + 
	`g‘´Ùo
(
ofunc
)->
¥
->
max¡acksize
);

1185 
Ãwäame
;

1187 
vmb»ak
;

1189 
	`vmÿ£
(
OP_RETURN
) {

1190 
b
 = 
	`GETARG_B
(
i
);

1191 ià(
ş
->
p
->
¥
->
siz•
 > 0è
	`luaF_şo£
(
L
, 
ba£
);

1192 
b
 = 
	`luaD_posÿÎ
(
L
, 
ci
, 
¿
, (b !ğ0 ? b - 1 : 
	`ÿ¡_št
(L->
tİ
 -„a)));

1193 ià(
ci
->
ÿÎ¡©us
 & 
CIST_FRESH
)

1196 
ci
 = 
L
->ci;

1197 ià(
b
è
L
->
tİ
 = 
ci
->top;

1198 
	`lua_as£¹
(
	`isLua
(
ci
));

1199 
	`lua_as£¹
(
	`GET_OPCODE
(*((
ci
)->
u
.
l
.
§vedpc
 - 1)è=ğ
OP_CALL
);

1200 
Ãwäame
;

1203 
	`vmÿ£
(
OP_FORLOOP
) {

1204 
	`lua_checksig
(
L
);

1205 ià(
	`‰isš‹g”
(
¿
)) {

1206 
lua_IÁeg”
 
¡•
 = 
	`iv®ue
(
¿
 + 2);

1207 
lua_IÁeg”
 
idx
 = 
	`štİ
(+, 
	`iv®ue
(
¿
), 
¡•
);

1208 
lua_IÁeg”
 
lim™
 = 
	`iv®ue
(
¿
 + 1);

1209 ià((0 < 
¡•
è? (
idx
 <ğ
lim™
) : (limit <= idx)) {

1210 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1211 
	`chgiv®ue
(
¿
, 
idx
);

1212 
	`£tiv®ue
(
¿
 + 3, 
idx
);

1216 
lua_Numb”
 
¡•
 = 
	`ætv®ue
(
¿
 + 2);

1217 
lua_Numb”
 
idx
 = 
	`luai_numadd
(
L
, 
	`ætv®ue
(
¿
), 
¡•
);

1218 
lua_Numb”
 
lim™
 = 
	`ætv®ue
(
¿
 + 1);

1219 ià(
	`luai_numÉ
(0, 
¡•
è? 
	`luai_numË
(
idx
, 
lim™
)

1220 : 
	`luai_numË
(
lim™
, 
idx
)) {

1221 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1222 
	`chgætv®ue
(
¿
, 
idx
);

1223 
	`£tætv®ue
(
¿
 + 3, 
idx
);

1226 
vmb»ak
;

1228 
	`vmÿ£
(
OP_FORPREP
) {

1229 
TV®ue
 *
š™
 = 
¿
;

1230 
TV®ue
 *
¶im™
 = 
¿
 + 1;

1231 
TV®ue
 *
p¡•
 = 
¿
 + 2;

1232 
lua_IÁeg”
 
im™
;

1233 
¡İnow
;

1234 ià(
	`‰isš‹g”
(
š™
è&&tisš‹g”(
p¡•
) &&

1235 
	`fÜlim™
(
¶im™
, &
im™
, 
	`iv®ue
(
p¡•
), &
¡İnow
)) {

1237 
lua_IÁeg”
 
š™v
 = (
¡İnow
 ? 0 : 
	`iv®ue
(
š™
));

1238 
	`£tiv®ue
(
¶im™
, 
im™
);

1239 
	`£tiv®ue
(
š™
, 
	`štİ
(-, 
š™v
, 
	`iv®ue
(
p¡•
)));

1242 
lua_Numb”
 
nš™
;†ua_Numb” 
Æim™
;†ua_Numb” 
n¡•
;

1243 ià(!
	`tÚumb”
(
¶im™
, &
Æim™
))

1244 
	`luaG_ruÃ¼Ü
(
L
, "'for'†imit must be‡‚umber");

1245 
	`£tætv®ue
(
¶im™
, 
Æim™
);

1246 ià(!
	`tÚumb”
(
p¡•
, &
n¡•
))

1247 
	`luaG_ruÃ¼Ü
(
L
, "'for' step must be‡‚umber");

1248 
	`£tætv®ue
(
p¡•
, 
n¡•
);

1249 ià(!
	`tÚumb”
(
š™
, &
nš™
))

1250 
	`luaG_ruÃ¼Ü
(
L
, "'for' initial value must be‡‚umber");

1251 
	`£tætv®ue
(
š™
, 
	`luai_numsub
(
L
, 
nš™
, 
n¡•
));

1253 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1254 
vmb»ak
;

1256 
	`vmÿ£
(
OP_TFORCALL
) {

1257 
StkId
 
cb
 = 
¿
 + 3;

1258 
	`£tobjs2s
(
L
, 
cb
+2, 
¿
+2);

1259 
	`£tobjs2s
(
L
, 
cb
+1, 
¿
+1);

1260 
	`£tobjs2s
(
L
, 
cb
, 
¿
);

1261 
L
->
tİ
 = 
cb
 + 3;

1262 
	`PrÙeù
(
	`luaD_ÿÎ
(
L
, 
cb
, 
	`GETARG_C
(
i
)));

1263 
L
->
tİ
 = 
ci
->top;

1264 
i
 = *(
ci
->
u
.
l
.
§vedpc
++);

1265 
¿
 = 
	`RA
(
i
);

1266 
	`lua_as£¹
(
	`GET_OPCODE
(
i
è=ğ
OP_TFORLOOP
);

1267 
l_tfÜloİ
;

1269 
	`vmÿ£
(
OP_TFORLOOP
) {

1270 
l_tfÜloİ
:

1271 
	`lua_checksig
(
L
);

1272 ià(!
	`‰i¢
(
¿
 + 1)) {

1273 
	`£tobjs2s
(
L
, 
¿
,„a + 1);

1274 
ci
->
u
.
l
.
§vedpc
 +ğ
	`GETARG_sBx
(
i
);

1276 
vmb»ak
;

1278 
	`vmÿ£
(
OP_SETLIST
) {

1279 
n
 = 
	`GETARG_B
(
i
);

1280 
c
 = 
	`GETARG_C
(
i
);

1281 
Ï¡
;

1282 
TabË
 *
h
;

1283 ià(
n
 =ğ0èÀğ
	`ÿ¡_št
(
L
->
tİ
 - 
¿
) - 1;

1284 ià(
c
 == 0) {

1285 
	`lua_as£¹
(
	`GET_OPCODE
(*
ci
->
u
.
l
.
§vedpc
è=ğ
OP_EXTRAARG
);

1286 
c
 = 
	`GETARG_Ax
(*
ci
->
u
.
l
.
§vedpc
++);

1288 
h
 = 
	`hv®ue
(
¿
);

1289 
Ï¡
 = ((
c
-1)*
LFIELDS_PER_FLUSH
è+ 
n
;

1290 ià(
Ï¡
 > 
h
->
siz—¼ay
)

1291 
	`luaH_»siz—¼ay
(
L
, 
h
, 
Ï¡
);

1292 ; 
n
 > 0;‚--) {

1293 
TV®ue
 *
v®
 = 
¿
+
n
;

1294 
	`luaH_£tšt
(
L
, 
h
, 
Ï¡
--, 
v®
);

1295 
	`luaC_b¬r›rback
(
L
, 
h
, 
v®
);

1297 
L
->
tİ
 = 
ci
->top;

1298 
vmb»ak
;

1300 
	`vmÿ£
(
OP_CLOSURE
) {

1301 
PrÙo
 *
p
 = 
ş
->p->p[
	`GETARG_Bx
(
i
)];

1302 
LClosu»
 *
nş
 = 
	`g‘ÿched
(
p
, 
ş
->
upv®s
, 
ba£
);

1303 ià(
nş
 =ğ
NULL
)

1304 
	`pushşosu»
(
L
, 
p
, 
ş
->
upv®s
, 
ba£
, 
¿
);

1306 
	`£tşLv®ue
(
L
, 
¿
, 
nş
);

1307 
	`checkGC
(
L
, 
¿
 + 1);

1308 
vmb»ak
;

1310 
	`vmÿ£
(
OP_VARARG
) {

1311 
b
 = 
	`GETARG_B
(
i
) - 1;

1312 
j
;

1313 
n
 = 
	`ÿ¡_št
(
ba£
 - 
ci
->
func
è- 
ş
->
p
->
¥
->
num·¿ms
 - 1;

1314 ià(
n
 < 0)

1315 
n
 = 0;

1316 ià(
b
 < 0) {

1317 
b
 = 
n
;

1318 
	`PrÙeù
(
	`luaD_check¡ack
(
L
, 
n
));

1319 
¿
 = 
	`RA
(
i
);

1320 
L
->
tİ
 = 
¿
 + 
n
;

1322 
j
 = 0; j < 
b
 && j < 
n
; j++)

1323 
	`£tobjs2s
(
L
, 
¿
 + 
j
, 
ba£
 - 
n
 + j);

1324 ; 
j
 < 
b
; j++)

1325 
	`£Šv®ue
(
¿
 + 
j
);

1326 
vmb»ak
;

1328 
	`vmÿ£
(
OP_EXTRAARG
) {

1329 
	`lua_as£¹
(0);

1330 
vmb»ak
;

1334 
	}
}

	@3rd/lua/lvm.h

7 #iâdeà
lvm_h


8 
	#lvm_h


	)

11 
	~"ldo.h
"

12 
	~"lobjeù.h
"

13 
	~"Ém.h
"

16 #ià!
defšed
(
LUA_NOCVTN2S
)

17 
	#cvt2¡r
(
o
è
	`‰i¢umb”
(o)

	)

19 
	#cvt2¡r
(
o
è0

	)

23 #ià!
defšed
(
LUA_NOCVTS2N
)

24 
	#cvt2num
(
o
è
	`‰is¡ršg
(o)

	)

26 
	#cvt2num
(
o
è0

	)

35 #ià!
defšed
(
LUA_FLOORN2I
)

36 
	#LUA_FLOORN2I
 0

	)

40 
	#tÚumb”
(
o
,
n
) \

41 (
	`‰isæßt
(
o
è? (*(
n
èğ
	`ætv®ue
(o), 1è: 
	`luaV_tÚumb”_
(o,n))

	)

43 
	#toš‹g”
(
o
,
i
) \

44 (
	`‰isš‹g”
(
o
è? (*(
i
èğ
	`iv®ue
(o), 1è: 
	`luaV_toš‹g”
(o,i,
LUA_FLOORN2I
))

	)

46 
	#štİ
(
İ
,
v1
,
v2
è
	`l_ÿ¡U2S
(
	`l_ÿ¡S2U
(v1èİ†_ÿ¡S2U(v2))

	)

48 
	#luaV_¿wequ®obj
(
t1
,
t2
è
	`luaV_equ®obj
(
NULL
,t1,t2)

	)

58 
	#luaV_ç¡g‘
(
L
,
t
,
k
,
¦Ù
,
f
) \

59 (!
	`‰i¡abË
(
t
) \

60 ? (
¦Ù
 = 
NULL
, 0) \

61 : (
¦Ù
 = 
	`f
(
	`hv®ue
(
t
), 
k
), \

62 !
	`‰i¢
(
¦Ù
))è

	)

67 
	#luaV_g‘bË
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

68 ià(
	`luaV_ç¡g‘
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
)è{ 
	`£tobj2s
(L, 
v
, slot); } \

69 
	`luaV_fšishg‘
(
L
,
t
,
k
,
v
,
¦Ù
); }

	)

80 
	#luaV_ç¡£t
(
L
,
t
,
k
,
¦Ù
,
f
,
v
) \

81 (!
	`‰i¡abË
(
t
) \

82 ? (
¦Ù
 = 
NULL
, 0) \

83 : (
¦Ù
 = 
	`f
(
	`hv®ue
(
t
), 
k
), \

84 
	`‰i¢
(
¦Ù
) ? 0 \

85 : (
	`luaC_b¬r›rback
(
L
, 
	`hv®ue
(
t
), 
v
), \

86 
	`£tobj2t
(
L
, 
	`ÿ¡
(
TV®ue
 *,
¦Ù
), 
v
), \

87 1)))

	)

90 
	#luaV_£‰abË
(
L
,
t
,
k
,
v
è{ cÚ¡ 
TV®ue
 *
¦Ù
; \

91 ià(!
	`luaV_ç¡£t
(
L
,
t
,
k
,
¦Ù
,
luaH_g‘
,
v
)) \

92 
	`luaV_fšish£t
(
L
,
t
,
k
,
v
,
¦Ù
); }

	)

96 
LUAI_FUNC
 
luaV_equ®obj
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t1
, cÚ¡ TV®u*
t2
);

97 
LUAI_FUNC
 
luaV_Ës¡hª
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
);

98 
LUAI_FUNC
 
luaV_Ës£qu®
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
l
, cÚ¡ TV®u*
r
);

99 
LUAI_FUNC
 
luaV_tÚumb”_
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_Numb”
 *
n
);

100 
LUAI_FUNC
 
luaV_toš‹g”
 (cÚ¡ 
TV®ue
 *
obj
, 
lua_IÁeg”
 *
p
, 
mode
);

101 
LUAI_FUNC
 
luaV_fšishg‘
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

102 
StkId
 
v®
, cÚ¡ 
TV®ue
 *
¦Ù
);

103 
LUAI_FUNC
 
luaV_fšish£t
 (
lua_S‹
 *
L
, cÚ¡ 
TV®ue
 *
t
, TV®u*
key
,

104 
StkId
 
v®
, cÚ¡ 
TV®ue
 *
¦Ù
);

105 
LUAI_FUNC
 
luaV_fšishOp
 (
lua_S‹
 *
L
);

106 
LUAI_FUNC
 
luaV_execu‹
 (
lua_S‹
 *
L
);

107 
LUAI_FUNC
 
luaV_cÚÿt
 (
lua_S‹
 *
L
, 
tÙ®
);

108 
LUAI_FUNC
 
lua_IÁeg”
 
luaV_div
 (
lua_S‹
 *
L
,†ua_IÁeg” 
x
,†ua_IÁeg” 
y
);

109 
LUAI_FUNC
 
lua_IÁeg”
 
luaV_mod
 (
lua_S‹
 *
L
,†ua_IÁeg” 
x
,†ua_IÁeg” 
y
);

110 
LUAI_FUNC
 
lua_IÁeg”
 
luaV_shiál
 (lua_IÁeg” 
x
,†ua_IÁeg” 
y
);

111 
LUAI_FUNC
 
luaV_objËn
 (
lua_S‹
 *
L
, 
StkId
 
¿
, cÚ¡ 
TV®ue
 *
rb
);

	@3rd/lua/lzio.c

7 
	#lzio_c


	)

8 
	#LUA_CORE


	)

10 
	~"Í»fix.h
"

13 
	~<¡ršg.h
>

15 
	~"lua.h
"

17 
	~"Îim™s.h
"

18 
	~"lmem.h
"

19 
	~"l¡©e.h
"

20 
	~"lzio.h
"

23 
	$luaZ_fl
 (
ZIO
 *
z
) {

24 
size_t
 
size
;

25 
lua_S‹
 *
L
 = 
z
->L;

26 cÚ¡ *
buff
;

27 
	`lua_uÆock
(
L
);

28 
buff
 = 
z
->
	`»ad”
(
L
, z->
d©a
, &
size
);

29 
	`lua_lock
(
L
);

30 ià(
buff
 =ğ
NULL
 || 
size
 == 0)

31  
EOZ
;

32 
z
->
n
 = 
size
 - 1;

33 
z
->
p
 = 
buff
;

34  
	`ÿ¡_uch¬
(*(
z
->
p
++));

35 
	}
}

38 
	$luaZ_š™
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
lua_R—d”
 
»ad”
, *
d©a
) {

39 
z
->
L
 = L;

40 
z
->
»ad”
 =„eader;

41 
z
->
d©a
 = data;

42 
z
->
n
 = 0;

43 
z
->
p
 = 
NULL
;

44 
	}
}

48 
size_t
 
	$luaZ_»ad
 (
ZIO
 *
z
, *
b
, 
size_t
 
n
) {

49 
n
) {

50 
size_t
 
m
;

51 ià(
z
->
n
 == 0) {

52 ià(
	`luaZ_fl
(
z
è=ğ
EOZ
)

53  
n
;

55 
z
->
n
++;

56 
z
->
p
--;

59 
m
 = (
n
 <ğ
z
->n) ?‚ : z->n;

60 
	`memıy
(
b
, 
z
->
p
, 
m
);

61 
z
->
n
 -ğ
m
;

62 
z
->
p
 +ğ
m
;

63 
b
 = (*)b + 
m
;

64 
n
 -ğ
m
;

67 
	}
}

	@3rd/lua/lzio.h

8 #iâdeà
lzio_h


9 
	#lzio_h


	)

11 
	~"lua.h
"

13 
	~"lmem.h
"

16 
	#EOZ
 (-1è

	)

18 
Zio
 
	tZIO
;

20 
	#zg‘c
(
z
è(((z)->
n
--)>0 ? 
	`ÿ¡_uch¬
(*(z)->
p
++è: 
	`luaZ_fl
(z))

	)

23 
	sMbufãr
 {

24 *
	mbufãr
;

25 
size_t
 
	mn
;

26 
size_t
 
	mbuffsize
;

27 } 
	tMbufãr
;

29 
	#luaZ_š™bufãr
(
L
, 
buff
è((buff)->
bufãr
 = 
NULL
, (buff)->
buffsize
 = 0)

	)

31 
	#luaZ_bufãr
(
buff
è((buff)->
bufãr
)

	)

32 
	#luaZ_sizebufãr
(
buff
è((buff)->
buffsize
)

	)

33 
	#luaZ_bufæ’
(
buff
è((buff)->
n
)

	)

35 
	#luaZ_bufäemove
(
buff
,
i
è((buff)->
n
 -ğ(i))

	)

36 
	#luaZ_»£tbufãr
(
buff
è((buff)->
n
 = 0)

	)

39 
	#luaZ_»sizebufãr
(
L
, 
buff
, 
size
) \

40 ((
buff
)->
bufãr
 = 
	`luaM_»®locvch¬
(
L
, (buff)->buffer, \

41 (
buff
)->
buffsize
, 
size
), \

42 (
buff
)->
buffsize
 = 
size
)

	)

44 
	#luaZ_ä“bufãr
(
L
, 
buff
è
	`luaZ_»sizebufãr
(L, buff, 0)

	)

47 
LUAI_FUNC
 
luaZ_š™
 (
lua_S‹
 *
L
, 
ZIO
 *
z
, 
lua_R—d”
 
»ad”
,

48 *
d©a
);

49 
LUAI_FUNC
 
size_t
 
luaZ_»ad
 (
ZIO
* 
z
, *
b
, size_ˆ
n
);

55 
	sZio
 {

56 
size_t
 
	mn
;

57 cÚ¡ *
	mp
;

58 
lua_R—d”
 
	m»ad”
;

59 *
	md©a
;

60 
lua_S‹
 *
	mL
;

64 
LUAI_FUNC
 
luaZ_fl
 (
ZIO
 *
z
);

	@lualib-src/boy/crc32.c

1 
	~"üc32.h
"

3 
	$Crc32_Compu‹Buf
(cÚ¡ *
buf
, 
size_t
 
bufL’
) {

4 cÚ¡ 
ücTabË
[256] = {

42 
üc32
;

43 *
by‹Buf
;

44 
size_t
 
i
;

46 
üc32
 = 0 ^ 0xFFFFFFFF;

47 
by‹Buf
 = (*è
buf
;

48 
i
 = 0; i < 
bufL’
; i++) {

49 
üc32
 = (üc32 >> 8è^ 
ücTabË
[(üc32 ^ 
by‹Buf
[
i
]) & 0xFF];

51 
»t
 = ()((
üc32
 ^ 0xFFFFFFFF) & 0x7FFFFFFF);

52  
»t
;

53 
	}
}

	@lualib-src/boy/crc32.h

1 #iâdeà
_BOY_CRC32_H_


2 
	#_BOY_CRC32_H_


	)

4 
	~<¡ddef.h
>

6 
Crc32_Compu‹Buf
(cÚ¡ *
buf
, 
size_t
 
bufL’
);

	@lualib-src/boy/lboy.c

1 
	~"lua.h
"

2 
	~"Ïuxlib.h
"

3 
	~"üc32.h
"

5 
	~<¡dio.h
>

7 
	$lüc32
(
lua_S‹
 *
L
) {

8 
size_t
 
Ën
=0;

9 cÚ¡ * 
buf
 = 
	`lua_tŞ¡ršg
(
L
,-1,&
Ën
);

10 iàĞ
buf
 =ğ
NULL
 ){

11  
	`luaL_¬g”rÜ
(
L
, 1, "string is‚il");

13 
»t
 = 
	`Crc32_Compu‹Buf
(
buf
,
Ën
);

14 
»tSŒ
[5] = {0};

15 
»tSŒ
[3] = 
»t
 & 0xFF;

16 
»tSŒ
[2] = (
»t
 >> 8)&0xFF;

17 
»tSŒ
[1] = (
»t
 >> 16)&0xFF;

18 
»tSŒ
[0] = (
»t
 >> 24)&0xFF;

19 ià(
»tSŒ
[2] == 13 &&„etStr[3] == 10 ){

20 
»tSŒ
[3] = 9;

22 
	`lua_push¡ršg
(
L
,
»tSŒ
);

24 
	}
}

26 
LUAMOD_API
 
	$luaİ’_boylib
(
lua_S‹
 *
L
) {

27 
luaL_Reg
 
funcs
[] = {

28 {"üc32",
lüc32
},

29 { 
NULL
, NULL },

31 
	`luaL_Ãwlib
(
L
,
funcs
);

33 
	}
}

	@lualib-src/lsha1.c

85 
	#LUA_LIB


	)

87 
	~<¡dio.h
>

88 
	~<¡ršg.h
>

89 
	~<¡dšt.h
>

92 
ušt32_t
 
	m¡©e
[5];

93 
ušt32_t
 
	mcouÁ
[2];

94 
ušt8_t
 
	mbufãr
[64];

95 } 
	tSHA1_CTX
;

97 
	#SHA1_DIGEST_SIZE
 20

	)

99 
SHA1_T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
ušt8_t
 
bufãr
[64]);

101 
	#rŞ
(
v®ue
, 
b™s
è(((v®ueè<< (b™s)è| ((v®ueè>> (32 - (b™s))))

	)

106 #ifdeà
WORDS_BIGENDIAN


107 
	#blk0
(
i
è
block
.
l
[i]

	)

109 
	#blk0
(
i
è(
block
.
l
[i] = (
	`rŞ
(block.l[i],24)&0xFF00FF00) \

110 |(
	`rŞ
(
block
.
l
[
i
],8)&0x00FF00FF))

	)

112 
	#blk
(
i
è(
block
.
l
[i&15] = 
	`rŞ
(block.l[(i+13)&15]^block.l[(i+8)&15] \

113 ^
block
.
l
[(
i
+2)&15]^block.l[i&15],1))

	)

116 
	#R0
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk0
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

117 
	#R1
(
v
,
w
,
x
,
y
,
z
,
i
èz+=((w&(x^y))^y)+
	`blk
(i)+0x5A827999+
	`rŞ
(v,5);wôŞ(w,30);

	)

118 
	#R2
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0x6ED9EBA1+
	`rŞ
(v,5);wôŞ(w,30);

	)

119 
	#R3
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(((w|x)&y)|(w&x))+
	`blk
(i)+0x8F1BBCDC+
	`rŞ
(v,5);wôŞ(w,30);

	)

120 
	#R4
(
v
,
w
,
x
,
y
,
z
,
i
èz+=(w^x^y)+
	`blk
(i)+0xCA62C1D6+
	`rŞ
(v,5);wôŞ(w,30);

	)

124 
	$SHA1_T¿nsfÜm
(
ušt32_t
 
¡©e
[5], cÚ¡ 
ušt8_t
 
bufãr
[64])

126 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
e
;

128 
ušt8_t
 
c
[64];

129 
ušt32_t
 
l
[16];

130 } 
	tCHAR64LONG16
;

131 
CHAR64LONG16
 
block
;

133 
	`memıy
(&
block
, 
bufãr
, 64);

136 
a
 = 
¡©e
[0];

137 
b
 = 
¡©e
[1];

138 
c
 = 
¡©e
[2];

139 
d
 = 
¡©e
[3];

140 
e
 = 
¡©e
[4];

143 
	`R0
(
a
,
b
,
c
,
d
,
e
, 0); R0(e,a,b,c,d, 1); R0(d,e,a,b,c, 2); R0(c,d,e,a,b, 3);

144 
	`R0
(
b
,
c
,
d
,
e
,
a
, 4); R0(a,b,c,d,e, 5); R0(e,a,b,c,d, 6); R0(d,e,a,b,c, 7);

145 
	`R0
(
c
,
d
,
e
,
a
,
b
, 8); R0(b,c,d,e,a, 9); R0(a,b,c,d,e,10); R0(e,a,b,c,d,11);

146 
	`R0
(
d
,
e
,
a
,
b
,
c
,12); R0(c,d,e,a,b,13); R0(b,c,d,e,a,14); R0(a,b,c,d,e,15);

147 
	`R1
(
e
,
a
,
b
,
c
,
d
,16); R1(d,e,a,b,c,17); R1(c,d,e,a,b,18); R1(b,c,d,e,a,19);

148 
	`R2
(
a
,
b
,
c
,
d
,
e
,20); R2(e,a,b,c,d,21); R2(d,e,a,b,c,22); R2(c,d,e,a,b,23);

149 
	`R2
(
b
,
c
,
d
,
e
,
a
,24); R2(a,b,c,d,e,25); R2(e,a,b,c,d,26); R2(d,e,a,b,c,27);

150 
	`R2
(
c
,
d
,
e
,
a
,
b
,28); R2(b,c,d,e,a,29); R2(a,b,c,d,e,30); R2(e,a,b,c,d,31);

151 
	`R2
(
d
,
e
,
a
,
b
,
c
,32); R2(c,d,e,a,b,33); R2(b,c,d,e,a,34); R2(a,b,c,d,e,35);

152 
	`R2
(
e
,
a
,
b
,
c
,
d
,36); R2(d,e,a,b,c,37); R2(c,d,e,a,b,38); R2(b,c,d,e,a,39);

153 
	`R3
(
a
,
b
,
c
,
d
,
e
,40); R3(e,a,b,c,d,41); R3(d,e,a,b,c,42); R3(c,d,e,a,b,43);

154 
	`R3
(
b
,
c
,
d
,
e
,
a
,44); R3(a,b,c,d,e,45); R3(e,a,b,c,d,46); R3(d,e,a,b,c,47);

155 
	`R3
(
c
,
d
,
e
,
a
,
b
,48); R3(b,c,d,e,a,49); R3(a,b,c,d,e,50); R3(e,a,b,c,d,51);

156 
	`R3
(
d
,
e
,
a
,
b
,
c
,52); R3(c,d,e,a,b,53); R3(b,c,d,e,a,54); R3(a,b,c,d,e,55);

157 
	`R3
(
e
,
a
,
b
,
c
,
d
,56); R3(d,e,a,b,c,57); R3(c,d,e,a,b,58); R3(b,c,d,e,a,59);

158 
	`R4
(
a
,
b
,
c
,
d
,
e
,60); R4(e,a,b,c,d,61); R4(d,e,a,b,c,62); R4(c,d,e,a,b,63);

159 
	`R4
(
b
,
c
,
d
,
e
,
a
,64); R4(a,b,c,d,e,65); R4(e,a,b,c,d,66); R4(d,e,a,b,c,67);

160 
	`R4
(
c
,
d
,
e
,
a
,
b
,68); R4(b,c,d,e,a,69); R4(a,b,c,d,e,70); R4(e,a,b,c,d,71);

161 
	`R4
(
d
,
e
,
a
,
b
,
c
,72); R4(c,d,e,a,b,73); R4(b,c,d,e,a,74); R4(a,b,c,d,e,75);

162 
	`R4
(
e
,
a
,
b
,
c
,
d
,76); R4(d,e,a,b,c,77); R4(c,d,e,a,b,78); R4(b,c,d,e,a,79);

165 
¡©e
[0] +ğ
a
;

166 
¡©e
[1] +ğ
b
;

167 
¡©e
[2] +ğ
c
;

168 
¡©e
[3] +ğ
d
;

169 
¡©e
[4] +ğ
e
;

172 
a
 = 
b
 = 
c
 = 
d
 = 
e
 = 0;

173 
	}
}

177 
	$§t_SHA1_In™
(
SHA1_CTX
* 
cÚ‹xt
)

180 
cÚ‹xt
->
¡©e
[0] = 0x67452301;

181 
cÚ‹xt
->
¡©e
[1] = 0xEFCDAB89;

182 
cÚ‹xt
->
¡©e
[2] = 0x98BADCFE;

183 
cÚ‹xt
->
¡©e
[3] = 0x10325476;

184 
cÚ‹xt
->
¡©e
[4] = 0xC3D2E1F0;

185 
cÚ‹xt
->
couÁ
[0] = context->count[1] = 0;

186 
	}
}

190 
	$§t_SHA1_Upd©e
(
SHA1_CTX
* 
cÚ‹xt
, cÚ¡ 
ušt8_t
* 
d©a
, cÚ¡ 
size_t
 
Ën
)

192 
size_t
 
i
, 
j
;

194 #ifdeà
VERBOSE


195 
	`SHAPrštCÚ‹xt
(
cÚ‹xt
, "before");

198 
j
 = (
cÚ‹xt
->
couÁ
[0] >> 3) & 63;

199 ià((
cÚ‹xt
->
couÁ
[0] +ğ
Ën
 << 3) < (len << 3)) context->count[1]++;

200 
cÚ‹xt
->
couÁ
[1] +ğ(
Ën
 >> 29);

201 ià((
j
 + 
Ën
) > 63) {

202 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], 
d©a
, (
i
 = 64-j));

203 
	`SHA1_T¿nsfÜm
(
cÚ‹xt
->
¡©e
, cÚ‹xt->
bufãr
);

204  ; 
i
 + 63 < 
Ën
; i += 64) {

205 
	`SHA1_T¿nsfÜm
(
cÚ‹xt
->
¡©e
, 
d©a
 + 
i
);

207 
j
 = 0;

209 
i
 = 0;

210 
	`memıy
(&
cÚ‹xt
->
bufãr
[
j
], &
d©a
[
i
], 
Ën
 - i);

212 #ifdeà
VERBOSE


213 
	`SHAPrštCÚ‹xt
(
cÚ‹xt
, "after ");

215 
	}
}

219 
	$§t_SHA1_Fš®
(
SHA1_CTX
* 
cÚ‹xt
, 
ušt8_t
 
dige¡
[
SHA1_DIGEST_SIZE
])

221 
ušt32_t
 
i
;

222 
ušt8_t
 
fš®couÁ
[8];

224 
i
 = 0; i < 8; i++) {

225 
fš®couÁ
[
i
] = ()((
cÚ‹xt
->
couÁ
[(i >= 4 ? 0 : 1)]

226 >> ((3-(
i
 & 3)) * 8) ) & 255);

228 
	`§t_SHA1_Upd©e
(
cÚ‹xt
, (
ušt8_t
 *)"\200", 1);

229 (
cÚ‹xt
->
couÁ
[0] & 504) != 448) {

230 
	`§t_SHA1_Upd©e
(
cÚ‹xt
, (
ušt8_t
 *)"\0", 1);

232 
	`§t_SHA1_Upd©e
(
cÚ‹xt
, 
fš®couÁ
, 8);

233 
i
 = 0; i < 
SHA1_DIGEST_SIZE
; i++) {

234 
dige¡
[
i
] = (
ušt8_t
)

235 ((
cÚ‹xt
->
¡©e
[
i
>>2] >> ((3-(i & 3)) * 8) ) & 255);

239 
i
 = 0;

240 
	`mem£t
(
cÚ‹xt
->
bufãr
, 0, 64);

241 
	`mem£t
(
cÚ‹xt
->
¡©e
, 0, 20);

242 
	`mem£t
(
cÚ‹xt
->
couÁ
, 0, 8);

243 
	`mem£t
(
fš®couÁ
, 0, 8);

244 
	}
}

246 
	~<lua.h
>

247 
	~<Ïuxlib.h
>

250 
	$lsha1
(
lua_S‹
 *
L
) {

251 
size_t
 
sz
 = 0;

252 cÚ¡ 
ušt8_t
 * 
bufãr
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

253 
ušt8_t
 
dige¡
[
SHA1_DIGEST_SIZE
];

254 
SHA1_CTX
 
ùx
;

255 
	`§t_SHA1_In™
(&
ùx
);

256 
	`§t_SHA1_Upd©e
(&
ùx
, 
bufãr
, 
sz
);

257 
	`§t_SHA1_Fš®
(&
ùx
, 
dige¡
);

258 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
dige¡
, 
SHA1_DIGEST_SIZE
);

261 
	}
}

263 
	#BLOCKSIZE
 64

	)

265 
šlše
 

266 
	$xÜ_key
(
ušt8_t
 
key
[
BLOCKSIZE
], 
ušt32_t
 
xÜ
) {

267 
i
;

268 
i
=0;i<
BLOCKSIZE
;i+=(
ušt32_t
)) {

269 
ušt32_t
 * 
k
 = (ušt32_ˆ*)&
key
[
i
];

270 *
k
 ^ğ
xÜ
;

272 
	}
}

274 
LUAMOD_API
 

275 
	$lhmac_sha1
(
lua_S‹
 *
L
) {

276 
size_t
 
key_sz
 = 0;

277 cÚ¡ 
ušt8_t
 * 
key
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
key_sz
);

278 
size_t
 
‹xt_sz
 = 0;

279 cÚ¡ 
ušt8_t
 * 
‹xt
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 2, &
‹xt_sz
);

280 
SHA1_CTX
 
ùx1
, 
ùx2
;

281 
ušt8_t
 
dige¡1
[
SHA1_DIGEST_SIZE
];

282 
ušt8_t
 
dige¡2
[
SHA1_DIGEST_SIZE
];

283 
ušt8_t
 
rkey
[
BLOCKSIZE
];

284 
	`mem£t
(
rkey
, 0, 
BLOCKSIZE
);

286 ià(
key_sz
 > 
BLOCKSIZE
) {

287 
SHA1_CTX
 
ùx
;

288 
	`§t_SHA1_In™
(&
ùx
);

289 
	`§t_SHA1_Upd©e
(&
ùx
, 
key
, 
key_sz
);

290 
	`§t_SHA1_Fš®
(&
ùx
, 
rkey
);

291 
key_sz
 = 
SHA1_DIGEST_SIZE
;

293 
	`memıy
(
rkey
, 
key
, 
key_sz
);

296 
	`xÜ_key
(
rkey
, 0x5c5c5c5c);

297 
	`§t_SHA1_In™
(&
ùx1
);

298 
	`§t_SHA1_Upd©e
(&
ùx1
, 
rkey
, 
BLOCKSIZE
);

300 
	`xÜ_key
(
rkey
, 0x5c5c5c5c ^ 0x36363636);

301 
	`§t_SHA1_In™
(&
ùx2
);

302 
	`§t_SHA1_Upd©e
(&
ùx2
, 
rkey
, 
BLOCKSIZE
);

303 
	`§t_SHA1_Upd©e
(&
ùx2
, 
‹xt
, 
‹xt_sz
);

304 
	`§t_SHA1_Fš®
(&
ùx2
, 
dige¡2
);

306 
	`§t_SHA1_Upd©e
(&
ùx1
, 
dige¡2
, 
SHA1_DIGEST_SIZE
);

307 
	`§t_SHA1_Fš®
(&
ùx1
, 
dige¡1
);

309 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
dige¡1
, 
SHA1_DIGEST_SIZE
);

312 
	}
}

	@lualib-src/lua-bson.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

6 
	~<time.h
>

7 
	~<uni¡d.h
>

9 
	~<¡dšt.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dboŞ.h
>

13 
	~<ùy³.h
>

14 
	~"©omic.h
"

16 
	#DEFAULT_CAP
 64

	)

17 
	#MAX_NUMBER
 1024

	)

19 
	#MAX_DEPTH
 128

	)

21 
	#BSON_REAL
 1

	)

22 
	#BSON_STRING
 2

	)

23 
	#BSON_DOCUMENT
 3

	)

24 
	#BSON_ARRAY
 4

	)

25 
	#BSON_BINARY
 5

	)

26 
	#BSON_UNDEFINED
 6

	)

27 
	#BSON_OBJECTID
 7

	)

28 
	#BSON_BOOLEAN
 8

	)

29 
	#BSON_DATE
 9

	)

30 
	#BSON_NULL
 10

	)

31 
	#BSON_REGEX
 11

	)

32 
	#BSON_DBPOINTER
 12

	)

33 
	#BSON_JSCODE
 13

	)

34 
	#BSON_SYMBOL
 14

	)

35 
	#BSON_CODEWS
 15

	)

36 
	#BSON_INT32
 16

	)

37 
	#BSON_TIMESTAMP
 17

	)

38 
	#BSON_INT64
 18

	)

39 
	#BSON_MINKEY
 255

	)

40 
	#BSON_MAXKEY
 127

	)

42 
	#BSON_TYPE_SHIFT
 5

	)

44 
	gbsÚ_num¡rs
[
MAX_NUMBER
][4];

45 
	gbsÚ_num¡r_Ën
[
MAX_NUMBER
];

47 
	sbsÚ
 {

48 
	msize
;

49 
	mÿp
;

50 
ušt8_t
 *
	m±r
;

51 
ušt8_t
 
	mbufãr
[
DEFAULT_CAP
];

54 
	sbsÚ_»ad”
 {

55 cÚ¡ 
ušt8_t
 * 
	m±r
;

56 
	msize
;

59 
šlše
 
št32_t


60 
	$g‘_Ëngth
(cÚ¡ 
ušt8_t
 * 
d©a
) {

61 cÚ¡ 
ušt8_t
 * 
b
 = (cÚ¡ ušt8_ˆ*)
d©a
;

62 
št32_t
 
Ën
 = 
b
[0] | b[1]<<8 | b[2]<<16 | b[3]<<24;

63  
Ën
;

64 
	}
}

66 
šlše
 

67 
	$bsÚ_de¡roy
(
bsÚ
 *
b
) {

68 ià(
b
->
±r
 !ğb->
bufãr
) {

69 
	`ä“
(
b
->
±r
);

71 
	}
}

73 
šlše
 

74 
	$bsÚ_ü—‹
(
bsÚ
 *
b
) {

75 
b
->
size
 = 0;

76 
b
->
ÿp
 = 
DEFAULT_CAP
;

77 
b
->
±r
 = b->
bufãr
;

78 
	}
}

80 
šlše
 

81 
	$bsÚ_»£rve
(
bsÚ
 *
b
, 
sz
) {

82 ià(
b
->
size
 + 
sz
 <ğb->
ÿp
)

85 
b
->
ÿp
 *= 2;

86 } 
b
->
ÿp
 <ğb->
size
 + 
sz
);

88 ià(
b
->
±r
 =ğb->
bufãr
) {

89 
b
->
±r
 = 
	`m®loc
(b->
ÿp
);

90 
	`memıy
(
b
->
±r
, b->
bufãr
, b->
size
);

92 
b
->
±r
 = 
	`»®loc
(b->±r, b->
ÿp
);

94 
	}
}

96 
šlše
 

97 
	$check_»ad”
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
, 
sz
) {

98 ià(
br
->
size
 < 
sz
) {

99 
	`luaL_”rÜ
(
L
, "Inv®id bsÚ block (%d:%d)", 
br
->
size
, 
sz
);

101 
	}
}

103 
šlše
 

104 
	$»ad_by‹
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
) {

105 
	`check_»ad”
(
L
, 
br
, 1);

106 cÚ¡ 
ušt8_t
 * 
b
 = 
br
->
±r
;

107 
r
 = 
b
[0];

108 ++
br
->
±r
;

109 --
br
->
size
;

111  
r
;

112 
	}
}

114 
šlše
 
št32_t


115 
	$»ad_št32
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
) {

116 
	`check_»ad”
(
L
, 
br
, 4);

117 cÚ¡ 
ušt8_t
 * 
b
 = 
br
->
±r
;

118 
ušt32_t
 
v
 = 
b
[0] | b[1]<<8 | b[2]<<16 | b[3]<<24;

119 
br
->
±r
+=4;

120 
br
->
size
-=4;

121  (
št32_t
)
v
;

122 
	}
}

124 
šlše
 
št64_t


125 
	$»ad_št64
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
) {

126 
	`check_»ad”
(
L
, 
br
, 8);

127 cÚ¡ 
ušt8_t
 * 
b
 = 
br
->
±r
;

128 
ušt32_t
 
lo
 = 
b
[0] | b[1]<<8 | b[2]<<16 | b[3]<<24;

129 
ušt32_t
 
hi
 = 
b
[4] | b[5]<<8 | b[6]<<16 | b[7]<<24;

130 
ušt64_t
 
v
 = (ušt64_t)
lo
 | (ušt64_t)
hi
<<32;

131 
br
->
±r
+=8;

132 
br
->
size
-=8;

133  (
št64_t
)
v
;

134 
	}
}

136 
šlše
 
lua_Numb”


137 
	$»ad_doubË
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
) {

138 
	`check_»ad”
(
L
, 
br
, 8);

140 
ušt64_t
 
i
;

141 
d
;

142 } 
v
;

143 cÚ¡ 
ušt8_t
 * 
b
 = 
br
->
±r
;

144 
ušt32_t
 
lo
 = 
b
[0] | b[1]<<8 | b[2]<<16 | b[3]<<24;

145 
ušt32_t
 
hi
 = 
b
[4] | b[5]<<8 | b[6]<<16 | b[7]<<24;

146 
v
.
i
 = (
ušt64_t
)
lo
 | (ušt64_t)
hi
<<32;

147 
br
->
±r
+=8;

148 
br
->
size
-=8;

149  
v
.
d
;

150 
	}
}

152 
šlše
 const *

153 
	$»ad_by‹s
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
, 
sz
) {

154 cÚ¡ * 
r
 = 
br
->
±r
;

155 
	`check_»ad”
(
L
, 
br
, 
sz
);

156 
br
->
±r
+=
sz
;

157 
br
->
size
-=
sz
;

158  
r
;

159 
	}
}

161 
šlše
 const *

162 
	$»ad_c¡ršg
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
, 
size_t
 *
sz
) {

163 
i
;

164 
i
=0;;i++) {

165 ià(
i
==
br
->
size
) {

166 
	`luaL_”rÜ
(
L
, "Invalid bson block : cstring");

168 ià(
br
->
±r
[
i
] == '\0') {

172 *
sz
 = 
i
;

173 cÚ¡ * 
r
 = (cÚ¡ *)
br
->
±r
;

174 
br
->
±r
 +ğ
i
+1;

175 
br
->
size
 -ğ
i
+1;

176  
r
;

177 
	}
}

179 
šlše
 

180 
	$wr™e_by‹
(
bsÚ
 *
b
, 
ušt8_t
 
v
) {

181 
	`bsÚ_»£rve
(
b
,1);

182 
b
->
±r
[b->
size
++] = 
v
;

183 
	}
}

185 
šlše
 

186 
	$wr™e_št32
(
bsÚ
 *
b
, 
št32_t
 
v
) {

187 
ušt32_t
 
uv
 = (ušt32_t)
v
;

188 
	`bsÚ_»£rve
(
b
,4);

189 
b
->
±r
[b->
size
++] = 
uv
 & 0xff;

190 
b
->
±r
[b->
size
++] = (
uv
 >> 8)&0xff;

191 
b
->
±r
[b->
size
++] = (
uv
 >> 16)&0xff;

192 
b
->
±r
[b->
size
++] = (
uv
 >> 24)&0xff;

193 
	}
}

195 
šlše
 

196 
	$wr™e_Ëngth
(
bsÚ
 *
b
, 
št32_t
 
v
, 
off
) {

197 
ušt32_t
 
uv
 = (ušt32_t)
v
;

198 
b
->
±r
[
off
++] = 
uv
 & 0xff;

199 
b
->
±r
[
off
++] = (
uv
 >> 8)&0xff;

200 
b
->
±r
[
off
++] = (
uv
 >> 16)&0xff;

201 
b
->
±r
[
off
++] = (
uv
 >> 24)&0xff;

202 
	}
}

204 
	#MAXUNICODE
 0x10FFFF

	)

207 
	$utf8_cİy
(cÚ¡ *
s
, *
d
, 
size_t
 
lim™
) {

208 cÚ¡ 
lim™s
[] = {0xFF, 0x7F, 0x7FF, 0xFFFF};

209 
c
 = 
s
[0];

210 
»s
 = 0;

211 ià(
lim™
 < 1)

213 
d
[0] = 
s
[0];

214 ià(
c
 < 0x80) {

217 
couÁ
 = 0;

218 
c
 & 0x40) {

219 
cc
 = 
s
[++
couÁ
];

220 ià(
lim™
 <ğ
couÁ
 || (
cc
 & 0xC0) != 0x80)

222 
d
[
couÁ
] = 
s
[count];

223 
»s
 = (» << 6è| (
cc
 & 0x3F);

224 
c
 <<= 1;

226 
»s
 |ğ((
c
 & 0x7Fè<< (
couÁ
 * 5));

227 ià(
couÁ
 > 3 || 
»s
 > 
MAXUNICODE
 ||„e <ğ
lim™s
[count])

229  
couÁ
+1;

231 
	}
}

234 
	$wr™e_¡ršg
(
bsÚ
 *
b
, 
lua_S‹
 *
L
, cÚ¡ *
key
, 
size_t
 
sz
) {

235 
	`bsÚ_»£rve
(
b
,
sz
+1);

236 *
d¡
 = (*)(
b
->
±r
 + b->
size
);

237 cÚ¡ *
¤c
 = 
key
;

238 
size_t
 
n
 = 
sz
;

239 
n
 > 0) {

240 
c
 = 
	`utf8_cİy
(
¤c
, 
d¡
, 
n
);

241 ià(
c
 == 0) {

242 
	`luaL_”rÜ
(
L
, "Invalid utf8 string");

244 
¤c
 +ğ
c
;

245 
d¡
 +ğ
c
;

246 
n
 -ğ
c
;

248 
b
->
±r
[b->
size
+
sz
] = '\0';

249 
b
->
size
+=
sz
+1;

250 
	}
}

252 
šlše
 

253 
	$»£rve_Ëngth
(
bsÚ
 *
b
) {

254 
sz
 = 
b
->
size
;

255 
	`bsÚ_»£rve
(
b
,4);

256 
b
->
size
 +=4;

257  
sz
;

258 
	}
}

260 
šlše
 

261 
	$wr™e_št64
(
bsÚ
 *
b
, 
št64_t
 
v
) {

262 
ušt64_t
 
uv
 = (ušt64_t)
v
;

263 
i
;

264 
	`bsÚ_»£rve
(
b
,8);

265 
i
=0;i<64;i+=8) {

266 
b
->
±r
[b->
size
++] = (
uv
>>
i
) & 0xff;

268 
	}
}

270 
šlše
 

271 
	$wr™e_doubË
(
bsÚ
 *
b
, 
lua_Numb”
 
d
) {

273 
d
;

274 
ušt64_t
 
i
;

275 } 
v
;

276 
v
.
d
 = d;

277 
i
;

278 
	`bsÚ_»£rve
(
b
,8);

279 
i
=0;i<64;i+=8) {

280 
b
->
±r
[b->
size
++] = (
v
.
i
>>i) & 0xff;

282 
	}
}

284 
šlše
 

285 
	$­³nd_key
(
bsÚ
 *
bs
, 
lua_S‹
 *
L
, 
ty³
, cÚ¡ *
key
, 
size_t
 
sz
) {

286 
	`wr™e_by‹
(
bs
, 
ty³
);

287 
	`wr™e_¡ršg
(
bs
, 
L
, 
key
, 
sz
);

288 
	}
}

290 
šlše
 

291 
	$is_32b™
(
št64_t
 
v
) {

292  
v
 >ğ
INT32_MIN
 && v <ğ
INT32_MAX
;

293 
	}
}

296 
	$­³nd_numb”
(
bsÚ
 *
bs
, 
lua_S‹
 *
L
, cÚ¡ *
key
, 
size_t
 
sz
) {

297 ià(
	`lua_isš‹g”
(
L
, -1)) {

298 
št64_t
 
i
 = 
	`lua_toš‹g”
(
L
, -1);

299 ià(
	`is_32b™
(
i
)) {

300 
	`­³nd_key
(
bs
, 
L
, 
BSON_INT32
, 
key
, 
sz
);

301 
	`wr™e_št32
(
bs
, 
i
);

303 
	`­³nd_key
(
bs
, 
L
, 
BSON_INT64
, 
key
, 
sz
);

304 
	`wr™e_št64
(
bs
, 
i
);

307 
lua_Numb”
 
d
 = 
	`lua_tÚumb”
(
L
,-1);

308 
	`­³nd_key
(
bs
, 
L
, 
BSON_REAL
, 
key
, 
sz
);

309 
	`wr™e_doubË
(
bs
, 
d
);

311 
	}
}

313 
­³nd_bË
(
bsÚ
 *
bs
, 
lua_S‹
 *
L
, cÚ¡ *
key
, 
size_t
 
sz
, 
d•th
);

316 
	$wr™e_bš¬y
(
bsÚ
 *
b
, cÚ¡ * 
bufãr
, 
size_t
 
sz
) {

317 
Ëngth
 = 
	`»£rve_Ëngth
(
b
);

318 
	`bsÚ_»£rve
(
b
,
sz
);

319 
	`memıy
(
b
->
±r
 + b->
size
, 
bufãr
, 
sz
);

320 
b
->
size
+=
sz
;

321 
	`wr™e_Ëngth
(
b
, 
sz
-1, 
Ëngth
);

322 
	}
}

325 
	$­³nd_Úe
(
bsÚ
 *
bs
, 
lua_S‹
 *
L
, cÚ¡ *
key
, 
size_t
 
sz
, 
d•th
) {

326 
vt
 = 
	`lua_ty³
(
L
,-1);

327 
vt
) {

328 
LUA_TNUMBER
:

329 
	`­³nd_numb”
(
bs
, 
L
, 
key
, 
sz
);

331 
LUA_TUSERDATA
: {

332 
	`­³nd_key
(
bs
, 
L
, 
BSON_DOCUMENT
, 
key
, 
sz
);

333 
št32_t
 * 
doc
 = 
	`lua_tou£rd©a
(
L
,-1);

334 
št32_t
 
sz
 = *
doc
;

335 
	`bsÚ_»£rve
(
bs
,
sz
);

336 
	`memıy
(
bs
->
±r
 + bs->
size
, 
doc
, 
sz
);

337 
bs
->
size
 +ğ
sz
;

340 
LUA_TSTRING
: {

341 
size_t
 
Ën
;

342 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
,-1,&
Ën
);

343 ià(
Ën
 > 1 && 
¡r
[0]==0) {

344 
subt
 = (
ušt8_t
)
¡r
[1];

345 
	`­³nd_key
(
bs
, 
L
, 
subt
, 
key
, 
sz
);

346 
subt
) {

347 
BSON_BINARY
:

348 
	`wr™e_bš¬y
(
bs
, 
¡r
+2, 
Ën
-2);

350 
BSON_OBJECTID
:

351 ià(
Ën
 != 2+12) {

352 
	`luaL_”rÜ
(
L
, "Inv®id objeù id %s", 
¡r
+2);

355 
BSON_JSCODE
:

356 
BSON_DBPOINTER
:

357 
BSON_SYMBOL
:

358 
BSON_CODEWS
:

359 
	`bsÚ_»£rve
(
bs
,
Ën
-2);

360 
	`memıy
(
bs
->
±r
 + bs->
size
, 
¡r
+2, 
Ën
-2);

361 
bs
->
size
 +ğ
Ën
-2;

363 
BSON_DATE
: {

364 ià(
Ën
 != 2+4) {

365 
	`luaL_”rÜ
(
L
, "Invalid date");

367 cÚ¡ 
ušt32_t
 * 
ts
 = (cÚ¡ ušt32_ˆ*)(
¡r
 + 2);

368 
št64_t
 
v
 = (št64_t)*
ts
 * 1000;

369 
	`wr™e_št64
(
bs
, 
v
);

372 
BSON_TIMESTAMP
: {

373 ià(
Ën
 != 2+8) {

374 
	`luaL_”rÜ
(
L
, "Invalidimestamp");

376 cÚ¡ 
ušt32_t
 * 
šc
 = (cÚ¡ ušt32_ˆ*)(
¡r
 + 2);

377 cÚ¡ 
ušt32_t
 * 
ts
 = (cÚ¡ ušt32_ˆ*)(
¡r
 + 6);

378 
	`wr™e_št32
(
bs
, *
šc
);

379 
	`wr™e_št32
(
bs
, *
ts
);

382 
BSON_REGEX
: {

383 
¡r
+=2;

384 
Ën
-=3;

385 
size_t
 
i
;

386 
i
=0;i<
Ën
;i++) {

387 ià(
¡r
[
Ën
-
i
-1]==0) {

391 
	`wr™e_¡ršg
(
bs
, 
L
, 
¡r
, 
Ën
-
i
-1);

392 
	`wr™e_¡ršg
(
bs
, 
L
, 
¡r
 + 
Ën
-
i
, i);

395 
BSON_MINKEY
:

396 
BSON_MAXKEY
:

397 
BSON_NULL
:

400 
	`luaL_”rÜ
(
L
,"Inv®id subty³ %d", 
subt
);

403 
size_t
 
Ën
;

404 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
,-1,&
Ën
);

405 
	`­³nd_key
(
bs
, 
L
, 
BSON_STRING
, 
key
, 
sz
);

406 
off
 = 
	`»£rve_Ëngth
(
bs
);

407 
	`wr™e_¡ršg
(
bs
, 
L
, 
¡r
, 
Ën
);

408 
	`wr™e_Ëngth
(
bs
, 
Ën
+1, 
off
);

412 
LUA_TTABLE
:

413 
	`­³nd_bË
(
bs
, 
L
, 
key
, 
sz
, 
d•th
+1);

415 
LUA_TBOOLEAN
:

416 
	`­³nd_key
(
bs
, 
L
, 
BSON_BOOLEAN
, 
key
, 
sz
);

417 
	`wr™e_by‹
(
bs
, 
	`lua_toboŞ—n
(
L
,-1));

419 
LUA_TNIL
:

420 
	`luaL_”rÜ
(
L
, "Bson‡rray has‡ hole (nil), Use bson.null instead");

422 
	`luaL_”rÜ
(
L
, "Inv®id v®uty³ : %s", 
	`lua_ty³Çme
(L,
vt
));

424 
	}
}

426 
šlše
 

427 
	$bsÚ_num¡r
Ğ*
¡r
, 
i
 ) {

428 iàĞ
i
 < 
MAX_NUMBER
) {

429 
	`memıy
Ğ
¡r
, 
bsÚ_num¡rs
[
i
], 4 );

430  
bsÚ_num¡r_Ën
[
i
];

432  
	`¥rštf
Ğ
¡r
,"%u", 
i
 );

434 
	}
}

437 
	$·ck_¬¿y
(
lua_S‹
 *
L
, 
bsÚ
 *
b
, 
d•th
, 
size_t
 
Ën
) {

438 
Ëngth
 = 
	`»£rve_Ëngth
(
b
);

439 
size_t
 
i
;

440 
i
=1;i<=
Ën
;i++) {

441 
numb”key
[32];

442 
size_t
 
sz
 = 
	`bsÚ_num¡r
(
numb”key
, 
i
 - 1);

443 cÚ¡ * 
key
 = 
numb”key
;

444 
	`lua_g‘i
(
L
, -1, 
i
);

445 
	`­³nd_Úe
(
b
, 
L
, 
key
, 
sz
, 
d•th
);

446 
	`lua_pİ
(
L
, 1);

448 
	`wr™e_by‹
(
b
,0);

449 
	`wr™e_Ëngth
(
b
, b->
size
 - 
Ëngth
,†ength);

450 
	}
}

453 
	$·ck_diù_d©a
(
lua_S‹
 *
L
, 
bsÚ
 *
b
, 
d•th
, 
kt
) {

454 cÚ¡ * 
key
 = 
NULL
;

455 
size_t
 
sz
;

456 
kt
) {

457 
LUA_TNUMBER
:

460 
	`lua_pushv®ue
(
L
,-2);

461 
	`lua_š£¹
(
L
,-2);

462 
key
 = 
	`lua_tŞ¡ršg
(
L
,-2,&
sz
);

463 
	`­³nd_Úe
(
b
,
L
,
key
,
sz
,
d•th
);

464 
	`lua_pİ
(
L
,2);

467 
LUA_TSTRING
:

468 
key
 = 
	`lua_tŞ¡ršg
(
L
,-2,&
sz
);

470 if(
	`isdig™
(
key
[0])){

471 
	`luaL_”rÜ
(
L
, "Bson dictionary's key can't be stringhathe‚umber is‡the begining");

474 
	`­³nd_Úe
(
b
, 
L
, 
key
, 
sz
, 
d•th
);

475 
	`lua_pİ
(
L
,1);

478 
	`luaL_”rÜ
(
L
, "Inv®id keyy³ : %s", 
	`lua_ty³Çme
(L, 
kt
));

481 
	}
}

484 
	$·ck_sim¶e_diù
(
lua_S‹
 *
L
, 
bsÚ
 *
b
, 
d•th
) {

485 
Ëngth
 = 
	`»£rve_Ëngth
(
b
);

486 
	`lua_pushn
(
L
);

487 
	`lua_Ãxt
(
L
,-2) != 0) {

488 
kt
 = 
	`lua_ty³
(
L
, -2);

489 
	`·ck_diù_d©a
(
L
, 
b
, 
d•th
, 
kt
);

491 
	`wr™e_by‹
(
b
,0);

492 
	`wr™e_Ëngth
(
b
, b->
size
 - 
Ëngth
,†ength);

493 
	}
}

496 
	$·ck_m‘a_diù
(
lua_S‹
 *
L
, 
bsÚ
 *
b
, 
d•th
) {

497 
Ëngth
 = 
	`»£rve_Ëngth
(
b
);

499 
	`lua_pushv®ue
(
L
, -2);

500 
	`lua_ÿÎ
(
L
, 1, 3);

502 
	`lua_pushv®ue
(
L
, -2);

503 
	`lua_pushv®ue
(
L
, -2);

504 
	`lua_cİy
(
L
, -5, -3);

505 
	`lua_ÿÎ
(
L
, 2, 2);

507 
kt
 = 
	`lua_ty³
(
L
, -2);

508 ià(
kt
 =ğ
LUA_TNIL
) {

509 
	`lua_pİ
(
L
, 4);

512 
	`·ck_diù_d©a
(
L
, 
b
, 
d•th
, 
kt
);

514 
	`wr™e_by‹
(
b
,0);

515 
	`wr™e_Ëngth
(
b
, b->
size
 - 
Ëngth
,†ength);

516 
	}
}

518 
boŞ


519 
	$is_¿w¬¿y
(
lua_S‹
 *
L
) {

520 
size_t
 
Ën
 = 
	`lua_¿wËn
(
L
, -1);

521 ià(
Ën
 > 0) {

522 
	`lua_pushš‹g”
(
L
, 
Ën
);

523 ià(
	`lua_Ãxt
(
L
,-2) == 0) {

524  
Œue
;

526 
	`lua_pİ
(
L
,2);

529  
çl£
;

530 
	}
}

533 
	$­³nd_bË
(
bsÚ
 *
bs
, 
lua_S‹
 *
L
, cÚ¡ *
key
, 
size_t
 
sz
, 
d•th
) {

534 ià(
d•th
 > 
MAX_DEPTH
) {

535 
	`luaL_”rÜ
(
L
, "Too depth whileƒncoding bson");

537 
	`luaL_check¡ack
(
L
, 16, 
NULL
);

538 ià(
	`luaL_g‘m‘af›ld
(
L
, -1, "__Ën"è!ğ
LUA_TNIL
) {

539 
	`lua_pushv®ue
(
L
, -2);

540 
	`lua_ÿÎ
(
L
, 1, 1);

541 ià(!
	`lua_isš‹g”
(
L
, -1)) {

542 
	`luaL_”rÜ
(
L
, "__len should„eturn integer");

544 
size_t
 
Ën
 = 
	`lua_toš‹g”
(
L
, -1);

545 
	`lua_pİ
(
L
, 1);

546 
	`­³nd_key
(
bs
, 
L
, 
BSON_ARRAY
, 
key
, 
sz
);

547 
	`·ck_¬¿y
(
L
, 
bs
, 
d•th
, 
Ën
);

548 } ià(
	`luaL_g‘m‘af›ld
(
L
, -1, "__·œs"è!ğ
LUA_TNIL
) {

549 
	`­³nd_key
(
bs
, 
L
, 
BSON_DOCUMENT
, 
key
, 
sz
);

550 
	`·ck_m‘a_diù
(
L
, 
bs
, 
d•th
);

551 } ià(
	`is_¿w¬¿y
(
L
)) {

552 
	`­³nd_key
(
bs
, 
L
, 
BSON_ARRAY
, 
key
, 
sz
);

553 
	`·ck_¬¿y
(
L
, 
bs
, 
d•th
, 
	`lua_¿wËn
(L, -1));

555 
	`­³nd_key
(
bs
, 
L
, 
BSON_DOCUMENT
, 
key
, 
sz
);

556 
	`·ck_sim¶e_diù
(
L
, 
bs
, 
d•th
);

558 
	}
}

561 
	$·ck_Üd”ed_diù
(
lua_S‹
 *
L
, 
bsÚ
 *
b
, 
n
, 
d•th
) {

562 
Ëngth
 = 
	`»£rve_Ëngth
(
b
);

563 
i
;

564 
size_t
 
sz
;

566 cÚ¡ * 
key
 = 
	`lua_tŞ¡ršg
(
L
, 
n
, &
sz
);

567 
i
=0;i<
n
;i+=2) {

568 ià(
key
 =ğ
NULL
) {

569 
	`luaL_”rÜ
(
L
, "Argum’ˆ%d‚“d‡ sŒšg", 
i
+1);

571 
	`lua_pushv®ue
(
L
, 
i
+1);

572 
	`­³nd_Úe
(
b
, 
L
, 
key
, 
sz
, 
d•th
);

573 
	`lua_pİ
(
L
,1);

574 
key
 = 
	`lua_tŞ¡ršg
(
L
, 
i
+2, &
sz
);

576 
	`wr™e_by‹
(
b
,0);

577 
	`wr™e_Ëngth
(
b
, b->
size
 - 
Ëngth
,†ength);

578 
	}
}

581 
	$Éo¡ršg
(
lua_S‹
 *
L
) {

582 
size_t
 
sz
 = 
	`lua_¿wËn
(
L
, 1);

583 * 
ud
 = 
	`lua_tou£rd©a
(
L
,1);

584 
	`lua_pushl¡ršg
(
L
, 
ud
, 
sz
);

586 
	}
}

589 
	$Î’
(
lua_S‹
 *
L
) {

590 
size_t
 
sz
 = 
	`lua_¿wËn
(
L
, 1);

591 
	`lua_pushš‹g”
(
L
, 
sz
);

593 
	}
}

596 
	$make_objeù
(
lua_S‹
 *
L
, 
ty³
, cÚ¡ * 
±r
, 
size_t
 
Ën
) {

597 
luaL_Bufãr
 
b
;

598 
	`luaL_buffš™
(
L
, &
b
);

599 
	`luaL_addch¬
(&
b
, 0);

600 
	`luaL_addch¬
(&
b
, 
ty³
);

601 
	`luaL_addl¡ršg
(&
b
, 
±r
, 
Ën
);

602 
	`luaL_push»suÉ
(&
b
);

603 
	}
}

606 
	$uÅack_diù
(
lua_S‹
 *
L
, 
bsÚ_»ad”
 *
br
, 
boŞ
 
¬¿y
) {

607 
	`luaL_check¡ack
(
L
, 16, 
NULL
);

608 
sz
 = 
	`»ad_št32
(
L
, 
br
);

609 cÚ¡ * 
by‹s
 = 
	`»ad_by‹s
(
L
, 
br
, 
sz
-5);

610 
bsÚ_»ad”
 
t
 = { 
by‹s
, 
sz
-5 };

611 
’d
 = 
	`»ad_by‹
(
L
, 
br
);

612 ià(
’d
 != '\0') {

613 
	`luaL_”rÜ
(
L
, "Invalid documentƒnd");

616 
	`lua_ÃwbË
(
L
);

619 ià(
t
.
size
 == 0)

621 
bt
 = 
	`»ad_by‹
(
L
, &
t
);

622 
size_t
 
kËn
 = 0;

623 cÚ¡ * 
key
 = 
	`»ad_c¡ršg
(
L
, &
t
, &
kËn
);

624 ià(
¬¿y
) {

625 
id
 = 
	`¡¹Ş
(
key
, 
NULL
, 10) + 1;

626 
	`lua_pushš‹g”
(
L
,
id
);

629 if(
	`isdig™
(
key
[0])){

630 
id
 = 
	`¡¹Ş
(
key
, 
NULL
, 10);

631 
	`lua_pushš‹g”
(
L
,
id
);

633 
	`lua_pushl¡ršg
(
L
, 
key
, 
kËn
);

638 
bt
) {

639 
BSON_REAL
:

640 
	`lua_pushnumb”
(
L
, 
	`»ad_doubË
(L, &
t
));

642 
BSON_BOOLEAN
:

643 
	`lua_pushboŞ—n
(
L
, 
	`»ad_by‹
(L, &
t
));

645 
BSON_STRING
: {

646 
sz
 = 
	`»ad_št32
(
L
, &
t
);

647 ià(
sz
 <= 0) {

648 
	`luaL_”rÜ
(
L
, "Inv®id bsÚ sŒšg ,†’gth = %d", 
sz
);

650 
	`lua_pushl¡ršg
(
L
, 
	`»ad_by‹s
(L, &
t
, 
sz
), sz-1);

653 
BSON_DOCUMENT
:

654 
	`uÅack_diù
(
L
, &
t
, 
çl£
);

656 
BSON_ARRAY
:

657 
	`uÅack_diù
(
L
, &
t
, 
Œue
);

659 
BSON_BINARY
: {

660 
sz
 = 
	`»ad_št32
(
L
, &
t
);

661 
subty³
 = 
	`»ad_by‹
(
L
, &
t
);

663 
luaL_Bufãr
 
b
;

664 
	`luaL_buffš™
(
L
, &
b
);

665 
	`luaL_addch¬
(&
b
, 0);

666 
	`luaL_addch¬
(&
b
, 
BSON_BINARY
);

667 
	`luaL_addch¬
(&
b
, 
subty³
);

668 
	`luaL_addl¡ršg
(&
b
, 
	`»ad_by‹s
(
L
, &
t
, 
sz
), sz);

669 
	`luaL_push»suÉ
(&
b
);

672 
BSON_OBJECTID
:

673 
	`make_objeù
(
L
, 
BSON_OBJECTID
, 
	`»ad_by‹s
(L, &
t
, 12), 12);

675 
BSON_DATE
: {

676 
št64_t
 
d©e
 = 
	`»ad_št64
(
L
, &
t
);

677 
ušt32_t
 
v
 = 
d©e
 / 1000;

678 
	`make_objeù
(
L
, 
BSON_DATE
, &
v
, 4);

681 
BSON_MINKEY
:

682 
BSON_MAXKEY
:

683 
BSON_NULL
: {

684 
key
[] = { 0, 
bt
 };

685 
	`lua_pushl¡ršg
(
L
, 
key
, (key));

688 
BSON_REGEX
: {

689 
size_t
 
¾’1
=0;

690 
size_t
 
¾’2
=0;

691 cÚ¡ * 
r1
 = 
	`»ad_c¡ršg
(
L
, &
t
, &
¾’1
);

692 cÚ¡ * 
r2
 = 
	`»ad_c¡ršg
(
L
, &
t
, &
¾’2
);

693 
luaL_Bufãr
 
b
;

694 
	`luaL_buffš™
(
L
, &
b
);

695 
	`luaL_addch¬
(&
b
, 0);

696 
	`luaL_addch¬
(&
b
, 
BSON_REGEX
);

697 
	`luaL_addl¡ršg
(&
b
, 
r1
, 
¾’1
);

698 
	`luaL_addch¬
(&
b
,0);

699 
	`luaL_addl¡ršg
(&
b
, 
r2
, 
¾’2
);

700 
	`luaL_addch¬
(&
b
,0);

701 
	`luaL_push»suÉ
(&
b
);

704 
BSON_INT32
:

705 
	`lua_pushš‹g”
(
L
, 
	`»ad_št32
(L, &
t
));

707 
BSON_TIMESTAMP
: {

708 
št32_t
 
šc
 = 
	`»ad_št32
(
L
, &
t
);

709 
št32_t
 
ts
 = 
	`»ad_št32
(
L
, &
t
);

711 
luaL_Bufãr
 
b
;

712 
	`luaL_buffš™
(
L
, &
b
);

713 
	`luaL_addch¬
(&
b
, 0);

714 
	`luaL_addch¬
(&
b
, 
BSON_TIMESTAMP
);

715 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)&
šc
, 4);

716 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)&
ts
, 4);

717 
	`luaL_push»suÉ
(&
b
);

720 
BSON_INT64
:

721 
	`lua_pushš‹g”
(
L
, 
	`»ad_št64
(L, &
t
));

723 
BSON_DBPOINTER
: {

724 cÚ¡ * 
±r
 = 
t
.ptr;

725 
sz
 = 
	`»ad_št32
(
L
, &
t
);

726 
	`»ad_by‹s
(
L
, &
t
, 
sz
+12);

727 
	`make_objeù
(
L
, 
BSON_DBPOINTER
, 
±r
, 
sz
 + 16);

730 
BSON_JSCODE
:

731 
BSON_SYMBOL
: {

732 cÚ¡ * 
±r
 = 
t
.ptr;

733 
sz
 = 
	`»ad_št32
(
L
, &
t
);

734 
	`»ad_by‹s
(
L
, &
t
, 
sz
);

735 
	`make_objeù
(
L
, 
bt
, 
±r
, 
sz
 + 4);

738 
BSON_CODEWS
: {

739 cÚ¡ * 
±r
 = 
t
.ptr;

740 
sz
 = 
	`»ad_št32
(
L
, &
t
);

741 
	`»ad_by‹s
(
L
, &
t
, 
sz
-4);

742 
	`make_objeù
(
L
, 
bt
, 
±r
, 
sz
);

747 
	`luaL_”rÜ
(
L
, "Inv®id bsÚy³ : %d", 
bt
);

748 
	`lua_pİ
(
L
,1);

751 
	`lua_¿w£t
(
L
,-3);

753 
	}
}

756 
	$lmakešdex
(
lua_S‹
 *
L
) {

757 
št32_t
 *
bsÚ
 = 
	`luaL_checkud©a
(
L
,1,"bson");

758 cÚ¡ 
ušt8_t
 * 
¡¬t
 = (cÚ¡ ušt8_ˆ*)
bsÚ
;

759 
bsÚ_»ad”
 
br
 = { 
¡¬t
+4, 
	`g‘_Ëngth
(start) - 5 };

760 
	`lua_ÃwbË
(
L
);

763 ià(
br
.
size
 == 0)

765 
bt
 = 
	`»ad_by‹
(
L
, &
br
);

766 
size_t
 
kËn
 = 0;

767 cÚ¡ * 
key
 = 
	`»ad_c¡ršg
(
L
, &
br
, &
kËn
);

768 
f›ld_size
 = 0;

769 
bt
) {

770 
BSON_INT64
:

771 
BSON_TIMESTAMP
:

772 
BSON_DATE
:

773 
BSON_REAL
:

774 
f›ld_size
 = 8;

776 
BSON_BOOLEAN
:

777 
f›ld_size
 = 1;

779 
BSON_JSCODE
:

780 
BSON_SYMBOL
:

781 
BSON_STRING
: {

782 
sz
 = 
	`»ad_št32
(
L
, &
br
);

783 
	`»ad_by‹s
(
L
, &
br
, 
sz
);

786 
BSON_CODEWS
:

787 
BSON_ARRAY
:

788 
BSON_DOCUMENT
: {

789 
sz
 = 
	`»ad_št32
(
L
, &
br
);

790 
	`»ad_by‹s
(
L
, &
br
, 
sz
-4);

793 
BSON_BINARY
: {

794 
sz
 = 
	`»ad_št32
(
L
, &
br
);

795 
	`»ad_by‹s
(
L
, &
br
, 
sz
+1);

798 
BSON_OBJECTID
:

799 
f›ld_size
 = 12;

801 
BSON_MINKEY
:

802 
BSON_MAXKEY
:

803 
BSON_NULL
:

805 
BSON_REGEX
: {

806 
size_t
 
¾’1
=0;

807 
size_t
 
¾’2
=0;

808 
	`»ad_c¡ršg
(
L
, &
br
, &
¾’1
);

809 
	`»ad_c¡ršg
(
L
, &
br
, &
¾’2
);

812 
BSON_INT32
:

813 
f›ld_size
 = 4;

815 
BSON_DBPOINTER
: {

816 
sz
 = 
	`»ad_št32
(
L
, &
br
);

817 
	`»ad_by‹s
(
L
, &
br
, 
sz
+12);

822 
	`luaL_”rÜ
(
L
, "Inv®id bsÚy³ : %d", 
bt
);

823 
	`lua_pİ
(
L
,1);

826 ià(
f›ld_size
 > 0) {

827 
id
 = 
bt
 | ()(
br
.
±r
 - 
¡¬t
è<< 
BSON_TYPE_SHIFT
;

828 
	`»ad_by‹s
(
L
, &
br
, 
f›ld_size
);

829 
	`lua_pushl¡ršg
(
L
, 
key
, 
kËn
);

830 
	`lua_pushš‹g”
(
L
,
id
);

831 
	`lua_¿w£t
(
L
,-3);

834 
	`lua_£tu£rv®ue
(
L
,1);

835 
	`lua_£‰İ
(
L
,1);

838 
	}
}

841 
	$»¶aû_objeù
(
lua_S‹
 *
L
, 
ty³
, 
bsÚ
 * 
bs
) {

842 
size_t
 
Ën
 = 0;

843 cÚ¡ * 
d©a
 = 
	`luaL_checkl¡ršg
(
L
,3, &
Ën
);

844 ià(
Ën
 < 6 || 
d©a
[0] !ğ0 || d©a[1] !ğ
ty³
) {

845 
	`luaL_”rÜ
(
L
, "Ty³ mism©ch,‚“d bsÚy³ %d", 
ty³
);

847 
ty³
) {

848 
BSON_OBJECTID
:

849 ià(
Ën
 != 2+12) {

850 
	`luaL_”rÜ
(
L
, "Invalid object id");

852 
	`memıy
(
bs
->
±r
, 
d©a
+2, 12);

854 
BSON_DATE
: {

855 ià(
Ën
 != 2+4) {

856 
	`luaL_”rÜ
(
L
, "Invalid date");

858 cÚ¡ 
ušt32_t
 * 
ts
 = (cÚ¡ ušt32_ˆ*)(
d©a
 + 2);

859 
št64_t
 
v
 = (št64_t)*
ts
 * 1000;

860 
	`wr™e_št64
(
bs
, 
v
);

863 
BSON_TIMESTAMP
: {

864 ià(
Ën
 != 2+8) {

865 
	`luaL_”rÜ
(
L
, "Invalidimestamp");

867 cÚ¡ 
ušt32_t
 * 
šc
 = (cÚ¡ ušt32_ˆ*)(
d©a
 + 2);

868 cÚ¡ 
ušt32_t
 * 
ts
 = (cÚ¡ ušt32_ˆ*)(
d©a
 + 6);

869 
	`wr™e_št32
(
bs
, *
šc
);

870 
	`wr™e_št32
(
bs
, *
ts
);

874 
	}
}

877 
	$Ì•Ïû
(
lua_S‹
 *
L
) {

878 
	`lua_g‘u£rv®ue
(
L
,1);

879 ià(!
	`lua_i¡abË
(
L
,-1)) {

880  
	`luaL_”rÜ
(
L
, "call makeindex first");

882 
	`lua_pushv®ue
(
L
,2);

883 ià(
	`lua_¿wg‘
(
L
, -2è!ğ
LUA_TNUMBER
) {

884  
	`luaL_”rÜ
(
L
, "Cª'ˆ»¶aû key : %s", 
	`lua_to¡ršg
(L,2));

886 
id
 = 
	`lua_toš‹g”
(
L
, -1);

887 
ty³
 = 
id
 & ((1<<(
BSON_TYPE_SHIFT
)) - 1);

888 
off£t
 = 
id
 >> 
BSON_TYPE_SHIFT
;

889 
ušt8_t
 * 
¡¬t
 = 
	`lua_tou£rd©a
(
L
,1);

890 
bsÚ
 
b
 = { 0,16, 
¡¬t
 + 
off£t
 };

891 
ty³
) {

892 
BSON_REAL
:

893 
	`wr™e_doubË
(&
b
, 
	`luaL_checknumb”
(
L
, 3));

895 
BSON_BOOLEAN
:

896 
	`wr™e_by‹
(&
b
, 
	`lua_toboŞ—n
(
L
,3));

898 
BSON_OBJECTID
:

899 
BSON_DATE
:

900 
BSON_TIMESTAMP
:

901 
	`»¶aû_objeù
(
L
, 
ty³
, &
b
);

903 
BSON_INT32
: {

904 ià(!
	`lua_isš‹g”
(
L
, 3)) {

905 
	`luaL_”rÜ
(
L
, "%àmu¡ b¨32b™ iÁeg” ", 
	`lua_tÚumb”
(L, 3));

907 
št32_t
 
i
 = 
	`lua_toš‹g”
(
L
,3);

908 
	`wr™e_št32
(&
b
, 
i
);

911 
BSON_INT64
: {

912 ià(!
	`lua_isš‹g”
(
L
, 3)) {

913 
	`luaL_”rÜ
(
L
, "%àmu¡ b¨64b™ iÁeg” ", 
	`lua_tÚumb”
(L, 3));

915 
št64_t
 
i
 = 
	`lua_toš‹g”
(
L
,3);

916 
	`wr™e_št64
(&
b
, 
i
);

920 
	`luaL_”rÜ
(
L
, "Cª'ˆ»¶aûy³ %d", 
ty³
);

924 
	}
}

927 
	$ldecode
(
lua_S‹
 *
L
) {

928 cÚ¡ 
št32_t
 * 
d©a
 = 
	`lua_tou£rd©a
(
L
,1);

929 ià(
d©a
 =ğ
NULL
) {

930 
d©a
 = (cÚ¡ 
št32_t
*)
	`lua_to¡ršg
(
L
,1);

932 iàĞ
d©a
 =ğ
NULL
 ){

935 cÚ¡ 
ušt8_t
 * 
b
 = (cÚ¡ ušt8_ˆ*)
d©a
;

936 
št32_t
 
Ën
 = 
	`g‘_Ëngth
(
b
);

937 
bsÚ_»ad”
 
br
 = { 
b
 , 
Ën
 };

939 
	`uÅack_diù
(
L
, &
br
, 
çl£
);

942 
	}
}

945 
	$bsÚ_m‘a
(
lua_S‹
 *
L
) {

946 ià(
	`luaL_Ãwm‘©abË
(
L
, "bson")) {

947 
luaL_Reg
 
l
[] = {

948 { "decode", 
ldecode
 },

949 { "makešdex", 
lmakešdex
 },

950 { 
NULL
, NULL },

952 
	`luaL_Ãwlib
(
L
,
l
);

953 
	`lua_£tf›ld
(
L
, -2, "__index");

954 
	`lua_pushcfunùiÚ
(
L
, 
Éo¡ršg
);

955 
	`lua_£tf›ld
(
L
, -2, "__tostring");

956 
	`lua_pushcfunùiÚ
(
L
, 
Î’
);

957 
	`lua_£tf›ld
(
L
, -2, "__len");

958 
	`lua_pushcfunùiÚ
(
L
, 
Ì•Ïû
);

959 
	`lua_£tf›ld
(
L
, -2, "__newindex");

961 
	`lua_£tm‘©abË
(
L
, -2);

962 
	}
}

965 
	$’code_bsÚ
(
lua_S‹
 *
L
) {

966 
bsÚ
 *
b
 = 
	`lua_tou£rd©a
(
L
, 2);

967 
	`lua_£‰İ
(
L
, 1);

968 ià(
	`luaL_g‘m‘af›ld
(
L
, -1, "__·œs"è!ğ
LUA_TNIL
) {

969 
	`·ck_m‘a_diù
(
L
, 
b
, 0);

971 
	`·ck_sim¶e_diù
(
L
, 
b
, 0);

973 * 
ud
 = 
	`lua_Ãwu£rd©a
(
L
, 
b
->
size
);

974 
	`memıy
(
ud
, 
b
->
±r
, b->
size
);

976 
	}
}

979 
	$Ëncode
(
lua_S‹
 *
L
) {

980 
bsÚ
 
b
;

981 
	`lua_£‰İ
(
L
,1);

982 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

983 
	`bsÚ_ü—‹
(&
b
);

984 
	`lua_pushcfunùiÚ
(
L
, 
’code_bsÚ
);

985 
	`lua_pushv®ue
(
L
, 1);

986 
	`lua_pushlightu£rd©a
(
L
, &
b
);

987 ià(
	`lua_pÿÎ
(
L
, 2, 1, 0è!ğ
LUA_OK
) {

988 
	`bsÚ_de¡roy
(&
b
);

989  
	`lua_”rÜ
(
L
);

991 
	`bsÚ_de¡roy
(&
b
);

992 
	`bsÚ_m‘a
(
L
);

994 
	}
}

997 
	$’code_bsÚ_byÜd”
(
lua_S‹
 *
L
) {

998 
n
 = 
	`lua_g‘tİ
(
L
);

999 
bsÚ
 *
b
 = 
	`lua_tou£rd©a
(
L
, 
n
);

1000 
	`lua_£‰İ
(
L
, --
n
);

1001 
	`·ck_Üd”ed_diù
(
L
, 
b
, 
n
, 0);

1002 
	`lua_£‰İ
(
L
,0);

1003 * 
ud
 = 
	`lua_Ãwu£rd©a
(
L
, 
b
->
size
);

1004 
	`memıy
(
ud
, 
b
->
±r
, b->
size
);

1006 
	}
}

1009 
	$Ëncode_Üd”
(
lua_S‹
 *
L
) {

1010 
bsÚ
 
b
;

1011 
n
 = 
	`lua_g‘tİ
(
L
);

1012 ià(
n
%2 != 0) {

1013  
	`luaL_”rÜ
(
L
, "Invalid ordered dict");

1015 
	`bsÚ_ü—‹
(&
b
);

1016 
	`lua_pushv®ue
(
L
, 1);

1017 
	`lua_pushcfunùiÚ
(
L
, 
’code_bsÚ_byÜd”
);

1018 
	`lua_»¶aû
(
L
, 1);

1019 
	`lua_pushlightu£rd©a
(
L
, &
b
);

1020 ià(
	`lua_pÿÎ
(
L
, 
n
+1, 1, 0è!ğ
LUA_OK
) {

1021 
	`bsÚ_de¡roy
(&
b
);

1022  
	`lua_”rÜ
(
L
);

1024 
	`bsÚ_de¡roy
(&
b
);

1025 
	`bsÚ_m‘a
(
L
);

1027 
	}
}

1030 
	$ld©e
(
lua_S‹
 *
L
) {

1031 
d
 = 
	`luaL_checkš‹g”
(
L
,1);

1032 
luaL_Bufãr
 
b
;

1033 
	`luaL_buffš™
(
L
, &
b
);

1034 
	`luaL_addch¬
(&
b
, 0);

1035 
	`luaL_addch¬
(&
b
, 
BSON_DATE
);

1036 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)&
d
, (d));

1037 
	`luaL_push»suÉ
(&
b
);

1040 
	}
}

1043 
	$Éime¡amp
(
lua_S‹
 *
L
) {

1044 
d
 = 
	`luaL_checkš‹g”
(
L
,1);

1045 
luaL_Bufãr
 
b
;

1046 
	`luaL_buffš™
(
L
, &
b
);

1047 
	`luaL_addch¬
(&
b
, 0);

1048 
	`luaL_addch¬
(&
b
, 
BSON_TIMESTAMP
);

1049 ià(
	`lua_i¢ÚeÜn
(
L
,2)) {

1050 
ušt32_t
 
šc
 = 0;

1051 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)&
šc
, (inc));

1052 ++
šc
;

1054 
ušt32_t
 
i
 = (ušt32_t)
	`lua_toš‹g”
(
L
,2);

1055 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)&
i
, (i));

1057 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)&
d
, (d));

1058 
	`luaL_push»suÉ
(&
b
);

1061 
	}
}

1064 
	$Ìegex
(
lua_S‹
 *
L
) {

1065 
	`luaL_check¡ršg
(
L
,1);

1066 ià(
	`lua_g‘tİ
(
L
) < 2) {

1067 
	`lua_pushl™”®
(
L
,"");

1069 
luaL_Bufãr
 
b
;

1070 
	`luaL_buffš™
(
L
, &
b
);

1071 
	`luaL_addch¬
(&
b
, 0);

1072 
	`luaL_addch¬
(&
b
, 
BSON_REGEX
);

1073 
	`lua_pushv®ue
(
L
,1);

1074 
	`luaL_addv®ue
(&
b
);

1075 
	`luaL_addch¬
(&
b
,0);

1076 
	`lua_pushv®ue
(
L
,2);

1077 
	`luaL_addv®ue
(&
b
);

1078 
	`luaL_addch¬
(&
b
,0);

1079 
	`luaL_push»suÉ
(&
b
);

1082 
	}
}

1085 
	$lbš¬y
(
lua_S‹
 *
L
) {

1086 
	`lua_£‰İ
(
L
,1);

1087 
luaL_Bufãr
 
b
;

1088 
	`luaL_buffš™
(
L
, &
b
);

1089 
	`luaL_addch¬
(&
b
, 0);

1090 
	`luaL_addch¬
(&
b
, 
BSON_BINARY
);

1091 
	`luaL_addch¬
(&
b
, 0);

1092 
	`luaL_addv®ue
(&
b
);

1093 
	`luaL_push»suÉ
(&
b
);

1096 
	}
}

1099 
	$lsubty³
(
lua_S‹
 *
L
, 
subty³
, cÚ¡ 
ušt8_t
 * 
buf
, 
size_t
 
sz
) {

1100 
subty³
) {

1101 
BSON_BINARY
:

1102 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(6));

1103 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
+1, 
sz
-1);

1104 
	`lua_pushš‹g”
(
L
, 
buf
[0]);

1106 
BSON_OBJECTID
: {

1107 ià(
sz
 != 12) {

1108  
	`luaL_”rÜ
(
L
, "Invalid object id");

1110 
oid
[24];

1111 
i
;

1112 cÚ¡ 
ušt8_t
 * 
id
 = 
buf
;

1113 *
hex
 = "0123456789abcdef";

1114 
i
=0;i<12;i++) {

1115 
oid
[
i
*2] = 
hex
[
id
[i] >> 4];

1116 
oid
[
i
*2+1] = 
hex
[
id
[i] & 0xf];

1118 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(7));

1119 
	`lua_pushl¡ršg
(
L
, 
oid
, 24);

1123 
BSON_DATE
: {

1124 ià(
sz
 != 4) {

1125  
	`luaL_”rÜ
(
L
, "Invalid date");

1127 
d
 = *(cÚ¡ *)
buf
;

1128 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(9));

1129 
	`lua_pushš‹g”
(
L
, 
d
);

1132 
BSON_TIMESTAMP
: {

1133 ià(
sz
 != 8) {

1134  
	`luaL_”rÜ
(
L
, "Invalidimestamp");

1136 cÚ¡ 
ušt32_t
 * 
ts
 = (cÚ¡ ušt32_ˆ*)
buf
;

1137 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(8));

1138 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
ts
[1]);

1139 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
ts
[0]);

1142 
BSON_REGEX
: {

1143 --
sz
;

1144 
size_t
 
i
;

1145 cÚ¡ 
ušt8_t
 *
¡r
 = 
buf
;

1146 
i
=0;i<
sz
;i++) {

1147 ià(
¡r
[
sz
-
i
-1]==0) {

1151 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(10));

1152 ià(
i
==
sz
) {

1153  
	`luaL_”rÜ
(
L
, "Invalid„egex");

1155 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
¡r
, 
sz
 - 
i
 - 1);

1156 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
¡r
+
sz
-
i
, i);

1159 
BSON_MINKEY
:

1160 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(11));

1162 
BSON_MAXKEY
:

1163 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(12));

1165 
BSON_NULL
:

1166 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(4));

1168 
BSON_JSCODE
:

1169 
BSON_DBPOINTER
:

1170 
BSON_SYMBOL
:

1171 
BSON_CODEWS
:

1172 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(13));

1173 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 
sz
);

1176  
	`luaL_”rÜ
(
L
, "Inv®id subty³ %d", 
subty³
);

1178 
	}
}

1181 
	$Éy³
(
lua_S‹
 *
L
) {

1182 
t
 = 
	`lua_ty³
(
L
,1);

1183 
ty³
 = 0;

1184 
t
) {

1185 
LUA_TNUMBER
:

1186 
ty³
 = 1;

1188 
LUA_TBOOLEAN
:

1189 
ty³
 = 2;

1191 
LUA_TTABLE
:

1192 
ty³
 = 3;

1194 
LUA_TNIL
:

1195 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(4));

1197 
LUA_TSTRING
: {

1198 
size_t
 
Ën
 = 0;

1199 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
,1,&
Ën
);

1200 ià(
¡r
[0] =ğ0 && 
Ën
 >= 2) {

1201  
	`lsubty³
(
L
, (
ušt8_t
)
¡r
[1], (cÚ¡ ušt8_ˆ*)¡r+2, 
Ën
-2);

1203 
ty³
 = 5;

1208  
	`luaL_”rÜ
(
L
, "Inv®idy³ %s",
	`lua_ty³Çme
(L,
t
));

1210 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
ty³
));

1211 
	`lua_pushv®ue
(
L
,1);

1213 
	}
}

1216 
	$ty³şosu»
(
lua_S‹
 *
L
) {

1217 cÚ¡ * 
ty³Çme
[] = {

1232 
i
;

1233 
n
 = (
ty³Çme
)/(typename[0]);

1234 
i
=0;i<
n
;i++) {

1235 
	`lua_push¡ršg
(
L
,
ty³Çme
[
i
]);

1237 
	`lua_pushcşosu»
(
L
, 
Éy³
, 
n
);

1238 
	}
}

1240 
ušt8_t
 
	goid_h—d”
[5];

1241 
ušt32_t
 
	goid_couÁ”
;

1244 
	$š™_oid_h—d”
() {

1245 ià(
oid_couÁ”
) {

1249 
pid_t
 
pid
 = 
	`g‘pid
();

1250 
ušt32_t
 
h
 = 0;

1251 
ho¡Çme
[256];

1252 ià(
	`g‘ho¡Çme
(
ho¡Çme
, (hostname))==0) {

1253 
i
;

1254 
i
=0;i<(
ho¡Çme
) && hostname[i];i++) {

1255 
h
 = h ^ ((h<<5)+(h>>2)+
ho¡Çme
[
i
]);

1257 
h
 ^ğ
i
;

1259 
oid_h—d”
[0] = 
h
 & 0xff;

1260 
oid_h—d”
[1] = (
h
>>8) & 0xff;

1261 
oid_h—d”
[2] = (
h
>>16) & 0xff;

1262 
oid_h—d”
[3] = 
pid
 & 0xff;

1263 
oid_h—d”
[4] = (
pid
 >> 8) & 0xff;

1265 
ušt32_t
 
c
 = 
h
 ^ 
	`time
(
NULL
è^ (
ušŒ_t
)&h;

1266 ià(
c
 == 0) {

1267 
c
 = 1;

1269 
oid_couÁ”
 = 
c
;

1270 
	}
}

1272 
šlše
 

1273 
	$hextošt
(
c
) {

1274 ià(
c
>='0' && c<='9')

1275  
c
-'0';

1276 ià(
c
>='a' && c<='z')

1277  
c
-'a'+10;

1278 ià(
c
>='A' && c<='Z')

1279  
c
-'A'+10;

1281 
	}
}

1284 
	$lobjeùid
(
lua_S‹
 *
L
) {

1285 
ušt8_t
 
oid
[14] = { 0, 
BSON_OBJECTID
 };

1286 ià(
	`lua_is¡ršg
(
L
,1)) {

1287 
size_t
 
Ën
;

1288 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
,1,&
Ën
);

1289 ià(
Ën
 != 24) {

1290  
	`luaL_”rÜ
(
L
, "Inv®id objeùid %s", 
¡r
);

1292 
i
;

1293 
i
=0;i<12;i++) {

1294 
oid
[
i
+2] = 
	`hextošt
(
¡r
[i*2]) << 4 | hextoint(str[i*2+1]);

1297 
time_t
 
ti
 = 
	`time
(
NULL
);

1299 
ušt32_t
 
id
 = 
	`ATOM_FINC
(&
oid_couÁ”
);

1301 
oid
[2] = (
ti
>>24) & 0xff;

1302 
oid
[3] = (
ti
>>16) & 0xff;

1303 
oid
[4] = (
ti
>>8) & 0xff;

1304 
oid
[5] = 
ti
 & 0xff;

1305 
	`memıy
(
oid
+6 , 
oid_h—d”
, 5);

1306 
oid
[11] = (
id
>>16) & 0xff;

1307 
oid
[12] = (
id
>>8) & 0xff;

1308 
oid
[13] = 
id
 & 0xff;

1310 
	`lua_pushl¡ršg
Ğ
L
, (cÚ¡ *)
oid
, 14);

1313 
	}
}

1315 
LUAMOD_API
 

1316 
	$luaİ’_bsÚ
(
lua_S‹
 *
L
) {

1317 
	`luaL_checkv”siÚ
(
L
);

1318 
i
;

1319 
i
=0;i<
MAX_NUMBER
;i++) {

1320 
tmp
[8];

1321 
bsÚ_num¡r_Ën
[
i
] = 
	`¥rštf
(
tmp
,"%d",i);

1322 
	`memıy
(
bsÚ_num¡rs
[
i
], 
tmp
, 
bsÚ_num¡r_Ën
[i]);

1324 
luaL_Reg
 
l
[] = {

1325 { "’code", 
Ëncode
 },

1326 { "’code_Üd”", 
Ëncode_Üd”
 },

1327 { "d©e", 
ld©e
 },

1328 { "time¡amp", 
Éime¡amp
 },

1329 { "»gex", 
Ìegex
 },

1330 { "bš¬y", 
lbš¬y
 },

1331 { "objeùid", 
lobjeùid
 },

1332 { "decode", 
ldecode
 },

1333 { 
NULL
, NULL },

1336 
	`luaL_Ãwlib
(
L
,
l
);

1338 
	`ty³şosu»
(
L
);

1339 
	`lua_£tf›ld
(
L
,-2,"type");

1340 
nuÎ
[] = { 0, 
BSON_NULL
 };

1341 
	`lua_pushl¡ršg
(
L
, 
nuÎ
, (null));

1342 
	`lua_£tf›ld
(
L
,-2,"null");

1343 
mškey
[] = { 0, 
BSON_MINKEY
 };

1344 
	`lua_pushl¡ršg
(
L
, 
mškey
, (minkey));

1345 
	`lua_£tf›ld
(
L
,-2,"minkey");

1346 
maxkey
[] = { 0, 
BSON_MAXKEY
 };

1347 
	`lua_pushl¡ršg
(
L
, 
maxkey
, (maxkey));

1348 
	`lua_£tf›ld
(
L
,-2,"maxkey");

1349 
	`š™_oid_h—d”
();

1352 
	}
}

	@lualib-src/lua-clientsocket.c

5 
	#LUA_LIB


	)

7 
	~<lua.h
>

8 
	~<Ïuxlib.h
>

9 
	~<¡ršg.h
>

10 
	~<¡dšt.h
>

11 
	~<±h»ad.h
>

12 
	~<¡dlib.h
>

14 
	~<Ãtš‘/š.h
>

15 
	~<sys/ty³s.h
>

16 
	~<sys/sock‘.h
>

17 
	~<¬·/š‘.h
>

18 
	~<uni¡d.h
>

19 
	~<”ºo.h
>

20 
	~<fú.h
>

22 
	#CACHE_SIZE
 0x1000

	)

25 
	$lcÚÃù
(
lua_S‹
 *
L
) {

26 cÚ¡ * 
addr
 = 
	`luaL_check¡ršg
(
L
, 1);

27 
pÜt
 = 
	`luaL_checkš‹g”
(
L
, 2);

28 
fd
 = 
	`sock‘
(
AF_INET
,
SOCK_STREAM
,0);

29 
sockaddr_š
 
my_addr
;

31 
my_addr
.
sš_addr
.
s_addr
=
	`š‘_addr
(
addr
);

32 
my_addr
.
sš_çmy
=
AF_INET
;

33 
my_addr
.
sš_pÜt
=
	`htÚs
(
pÜt
);

35 
r
 = 
	`cÚÃù
(
fd
,(
sockaddr
 *)&
my_addr
,(
sockaddr_š
));

37 ià(
r
 == -1) {

38  
	`luaL_”rÜ
(
L
, "CÚÃù % %d faed", 
addr
, 
pÜt
);

41 
æag
 = 
	`fú
(
fd
, 
F_GETFL
, 0);

42 
	`fú
(
fd
, 
F_SETFL
, 
æag
 | 
O_NONBLOCK
);

44 
	`lua_pushš‹g”
(
L
, 
fd
);

47 
	}
}

50 
	$lşo£
(
lua_S‹
 *
L
) {

51 
fd
 = 
	`luaL_checkš‹g”
(
L
, 1);

52 
	`şo£
(
fd
);

55 
	}
}

58 
	$block_£nd
(
lua_S‹
 *
L
, 
fd
, cÚ¡ * 
bufãr
, 
sz
) {

59 
sz
 > 0) {

60 
r
 = 
	`£nd
(
fd
, 
bufãr
, 
sz
, 0);

61 ià(
r
 < 0) {

62 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
)

64 
	`luaL_”rÜ
(
L
, "sock‘ƒ¼Ü: %s", 
	`¡»¼Ü
(
”ºo
));

66 
bufãr
 +ğ
r
;

67 
sz
 -ğ
r
;

69 
	}
}

76 
	$l£nd
(
lua_S‹
 *
L
) {

77 
size_t
 
sz
 = 0;

78 
fd
 = 
	`luaL_checkš‹g”
(
L
,1);

79 cÚ¡ * 
msg
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

81 
	`block_£nd
(
L
, 
fd
, 
msg
, ()
sz
);

84 
	}
}

96 
	ssock‘_bufãr
 {

97 * 
	mbufãr
;

98 
	msz
;

102 
	$Ìecv
(
lua_S‹
 *
L
) {

103 
fd
 = 
	`luaL_checkš‹g”
(
L
,1);

105 
bufãr
[
CACHE_SIZE
];

106 
r
 = 
	`»cv
(
fd
, 
bufãr
, 
CACHE_SIZE
, 0);

107 ià(
r
 == 0) {

108 
	`lua_pushl™”®
(
L
, "");

112 ià(
r
 < 0) {

113 ià(
”ºo
 =ğ
EAGAIN
 ||ƒ¼nØ=ğ
EINTR
) {

116 
	`luaL_”rÜ
(
L
, "sock‘ƒ¼Ü: %s", 
	`¡»¼Ü
(
”ºo
));

118 
	`lua_pushl¡ršg
(
L
, 
bufãr
, 
r
);

120 
	}
}

123 
	$lu¦“p
(
lua_S‹
 *
L
) {

124 
n
 = 
	`luaL_checknumb”
(
L
, 1);

125 
	`u¦“p
(
n
);

127 
	}
}

131 
	#QUEUE_SIZE
 1024

	)

133 
	squeue
 {

134 
±h»ad_mu‹x_t
 
	mlock
;

135 
	mh—d
;

136 
	m
;

137 * 
	mqueue
[
QUEUE_SIZE
];

141 
	$»adlše_¡dš
(* 
¬g
) {

142 
queue
 * 
q
 = 
¬g
;

143 
tmp
[1024];

144 !
	`ãof
(
¡dš
)) {

145 ià(
	`fg‘s
(
tmp
,Ñmp),
¡dš
è=ğ
NULL
) {

147 
	`ex™
(1);

149 
n
 = 
	`¡¾’
(
tmp
) -1;

151 * 
¡r
 = 
	`m®loc
(
n
+1);

152 
	`memıy
(
¡r
, 
tmp
, 
n
);

153 
¡r
[
n
] = 0;

155 
	`±h»ad_mu‹x_lock
(&
q
->
lock
);

156 
q
->
queue
[q->

] = 
¡r
;

158 ià(++
q
->

 >ğ
QUEUE_SIZE
) {

159 
q
->

 = 0;

161 ià(
q
->
h—d
 =ğq->

) {

163 
	`ex™
(1);

165 
	`±h»ad_mu‹x_uÆock
(&
q
->
lock
);

167  
NULL
;

168 
	}
}

171 
	$Ì—d¡dš
(
lua_S‹
 *
L
) {

172 
queue
 *
q
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

173 
	`±h»ad_mu‹x_lock
(&
q
->
lock
);

174 ià(
q
->
h—d
 =ğq->

) {

175 
	`±h»ad_mu‹x_uÆock
(&
q
->
lock
);

178 * 
¡r
 = 
q
->
queue
[q->
h—d
];

179 ià(++
q
->
h—d
 >ğ
QUEUE_SIZE
) {

180 
q
->
h—d
 = 0;

182 
	`±h»ad_mu‹x_uÆock
(&
q
->
lock
);

183 
	`lua_push¡ršg
(
L
, 
¡r
);

184 
	`ä“
(
¡r
);

186 
	}
}

188 
LUAMOD_API
 

189 
	$luaİ’_ş›Á_sock‘
(
lua_S‹
 *
L
) {

190 
	`luaL_checkv”siÚ
(
L
);

191 
luaL_Reg
 
l
[] = {

192 { "cÚÃù", 
lcÚÃù
 },

193 { "»cv", 
Ìecv
 },

194 { "£nd", 
l£nd
 },

195 { "şo£", 
lşo£
 },

196 { "u¦“p", 
lu¦“p
 },

197 { 
NULL
, NULL },

199 
	`luaL_Ãwlib
(
L
, 
l
);

201 
queue
 * 
q
 = 
	`lua_Ãwu£rd©a
(
L
, (*q));

202 
	`mem£t
(
q
, 0, (*q));

203 
	`±h»ad_mu‹x_š™
(&
q
->
lock
, 
NULL
);

204 
	`lua_pushcşosu»
(
L
, 
Ì—d¡dš
, 1);

205 
	`lua_£tf›ld
(
L
, -2, "readstdin");

207 
±h»ad_t
 
pid
 ;

208 
	`±h»ad_ü—‹
(&
pid
, 
NULL
, 
»adlše_¡dš
, 
q
);

211 
	}
}

	@lualib-src/lua-cluster.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

5 
	~<¡ršg.h
>

6 
	~<as£¹.h
>

8 
	~"skyÃt.h
"

21 
	#TEMP_LENGTH
 0x8200

	)

22 
	#MULTI_PART
 0x8000

	)

25 
	$fl_ušt32
(
ušt8_t
 * 
buf
, 
ušt32_t
 
n
) {

26 
buf
[0] = 
n
 & 0xff;

27 
buf
[1] = (
n
 >> 8) & 0xff;

28 
buf
[2] = (
n
 >> 16) & 0xff;

29 
buf
[3] = (
n
 >> 24) & 0xff;

30 
	}
}

33 
	$fl_h—d”
(
lua_S‹
 *
L
, 
ušt8_t
 *
buf
, 
sz
) {

34 
	`as£¹
(
sz
 < 0x10000);

35 
buf
[0] = (
sz
 >> 8) & 0xff;

36 
buf
[1] = 
sz
 & 0xff;

37 
	}
}

78 
	$·ck»q_numb”
(
lua_S‹
 *
L
, 
£ssiÚ
, * 
msg
, 
ušt32_t
 
sz
, 
is_push
) {

79 
ušt32_t
 
addr
 = (ušt32_t)
	`lua_toš‹g”
(
L
,1);

80 
ušt8_t
 
buf
[
TEMP_LENGTH
];

81 ià(
sz
 < 
MULTI_PART
) {

82 
	`fl_h—d”
(
L
, 
buf
, 
sz
+9);

83 
buf
[2] = 0;

84 
	`fl_ušt32
(
buf
+3, 
addr
);

85 
	`fl_ušt32
(
buf
+7, 
is_push
 ? 0 : (
ušt32_t
)
£ssiÚ
);

86 
	`memıy
(
buf
+11,
msg
,
sz
);

88 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 
sz
+11);

91 
·¹
 = (
sz
 - 1è/ 
MULTI_PART
 + 1;

92 
	`fl_h—d”
(
L
, 
buf
, 13);

93 
buf
[2] = 
is_push
 ? 0x41 : 1;

94 
	`fl_ušt32
(
buf
+3, 
addr
);

95 
	`fl_ušt32
(
buf
+7, (
ušt32_t
)
£ssiÚ
);

96 
	`fl_ušt32
(
buf
+11, 
sz
);

97 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 15);

98  
·¹
;

100 
	}
}

103 
	$·ck»q_¡ršg
(
lua_S‹
 *
L
, 
£ssiÚ
, * 
msg
, 
ušt32_t
 
sz
, 
is_push
) {

104 
size_t
 
Çm–’
 = 0;

105 cÚ¡ *
Çme
 = 
	`lua_tŞ¡ršg
(
L
, 1, &
Çm–’
);

106 ià(
Çme
 =ğ
NULL
 || 
Çm–’
 < 1 ||‚amelen > 255) {

107 
	`skyÃt_ä“
(
msg
);

108 
	`luaL_”rÜ
(
L
, "Çmi toØlÚg %s", 
Çme
);

111 
ušt8_t
 
buf
[
TEMP_LENGTH
];

112 ià(
sz
 < 
MULTI_PART
) {

113 
	`fl_h—d”
(
L
, 
buf
, 
sz
+6+
Çm–’
);

114 
buf
[2] = 0x80;

115 
buf
[3] = (
ušt8_t
)
Çm–’
;

116 
	`memıy
(
buf
+4, 
Çme
, 
Çm–’
);

117 
	`fl_ušt32
(
buf
+4+
Çm–’
, 
is_push
 ? 0 : (
ušt32_t
)
£ssiÚ
);

118 
	`memıy
(
buf
+8+
Çm–’
,
msg
,
sz
);

120 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 
sz
+8+
Çm–’
);

123 
·¹
 = (
sz
 - 1è/ 
MULTI_PART
 + 1;

124 
	`fl_h—d”
(
L
, 
buf
, 10+
Çm–’
);

125 
buf
[2] = 
is_push
 ? 0xc1 : 0x81;

126 
buf
[3] = (
ušt8_t
)
Çm–’
;

127 
	`memıy
(
buf
+4, 
Çme
, 
Çm–’
);

128 
	`fl_ušt32
(
buf
+4+
Çm–’
, (
ušt32_t
)
£ssiÚ
);

129 
	`fl_ušt32
(
buf
+8+
Çm–’
, 
sz
);

131 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 12+
Çm–’
);

132  
·¹
;

134 
	}
}

137 
	$·ck»q_muÉi
(
lua_S‹
 *
L
, 
£ssiÚ
, * 
msg
, 
ušt32_t
 
sz
) {

138 
ušt8_t
 
buf
[
TEMP_LENGTH
];

139 
·¹
 = (
sz
 - 1è/ 
MULTI_PART
 + 1;

140 
i
;

141 *
±r
 = 
msg
;

142 
i
=0;i<
·¹
;i++) {

143 
ušt32_t
 
s
;

144 ià(
sz
 > 
MULTI_PART
) {

145 
s
 = 
MULTI_PART
;

146 
buf
[2] = 2;

148 
s
 = 
sz
;

149 
buf
[2] = 3;

151 
	`fl_h—d”
(
L
, 
buf
, 
s
+5);

152 
	`fl_ušt32
(
buf
+3, (
ušt32_t
)
£ssiÚ
);

153 
	`memıy
(
buf
+7, 
±r
, 
s
);

154 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 
s
+7);

155 
	`lua_¿w£ti
(
L
, -2, 
i
+1);

156 
sz
 -ğ
s
;

157 
±r
 +ğ
s
;

159 
	}
}

162 
	$·ck»que¡
(
lua_S‹
 *
L
, 
is_push
) {

163 *
msg
 = 
	`lua_tou£rd©a
(
L
,3);

164 ià(
msg
 =ğ
NULL
) {

165  
	`luaL_”rÜ
(
L
, "Invalid„equest message");

167 
ušt32_t
 
sz
 = (ušt32_t)
	`luaL_checkš‹g”
(
L
,4);

168 
£ssiÚ
 = 
	`luaL_checkš‹g”
(
L
,2);

169 ià(
£ssiÚ
 <= 0) {

170 
	`skyÃt_ä“
(
msg
);

171  
	`luaL_”rÜ
(
L
, "Inv®id„eque¡ sessiÚ %d", 
£ssiÚ
);

173 
addr_ty³
 = 
	`lua_ty³
(
L
,1);

174 
muÉak
;

175 ià(
addr_ty³
 =ğ
LUA_TNUMBER
) {

176 
muÉak
 = 
	`·ck»q_numb”
(
L
, 
£ssiÚ
, 
msg
, 
sz
, 
is_push
);

178 
muÉak
 = 
	`·ck»q_¡ršg
(
L
, 
£ssiÚ
, 
msg
, 
sz
, 
is_push
);

180 
ušt32_t
 
Ãw_£ssiÚ
 = (ušt32_t)
£ssiÚ
 + 1;

181 ià(
Ãw_£ssiÚ
 > 
INT32_MAX
) {

182 
Ãw_£ssiÚ
 = 1;

184 
	`lua_pushš‹g”
(
L
, 
Ãw_£ssiÚ
);

185 ià(
muÉak
) {

186 
	`lua_ü—‹bË
(
L
, 
muÉak
, 0);

187 
	`·ck»q_muÉi
(
L
, 
£ssiÚ
, 
msg
, 
sz
);

188 
	`skyÃt_ä“
(
msg
);

191 
	`skyÃt_ä“
(
msg
);

194 
	}
}

197 
	$Íack»que¡
(
lua_S‹
 *
L
) {

198  
	`·ck»que¡
(
L
, 0);

199 
	}
}

202 
	$Íackpush
(
lua_S‹
 *
L
) {

203  
	`·ck»que¡
(
L
, 1);

204 
	}
}

215 
šlše
 
ušt32_t


216 
	$uÅack_ušt32
(cÚ¡ 
ušt8_t
 * 
buf
) {

217  
buf
[0] | buf[1]<<8 | buf[2]<<16 | buf[3]<<24;

218 
	}
}

221 
	$uÅack»q_numb”
(
lua_S‹
 *
L
, cÚ¡ 
ušt8_t
 * 
buf
, 
sz
) {

222 ià(
sz
 < 9) {

223  
	`luaL_”rÜ
(
L
, "Inv®id clu¡” mes§g(size=%d)", 
sz
);

225 
ušt32_t
 
add»ss
 = 
	`uÅack_ušt32
(
buf
+1);

226 
ušt32_t
 
£ssiÚ
 = 
	`uÅack_ušt32
(
buf
+5);

227 
	`lua_pushš‹g”
(
L
, 
add»ss
);

228 
	`lua_pushš‹g”
(
L
, 
£ssiÚ
);

229 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
+9, 
sz
-9);

230 ià(
£ssiÚ
 == 0) {

231 
	`lua_pushn
(
L
);

232 
	`lua_pushboŞ—n
(
L
,1);

237 
	}
}

240 
	$uÅackm»q_numb”
(
lua_S‹
 *
L
, cÚ¡ 
ušt8_t
 * 
buf
, 
sz
, 
is_push
) {

241 ià(
sz
 != 13) {

242  
	`luaL_”rÜ
(
L
, "Inv®id clu¡” mes§gsiz%d (muÉ˜»q mu¡ b13)", 
sz
);

244 
ušt32_t
 
add»ss
 = 
	`uÅack_ušt32
(
buf
+1);

245 
ušt32_t
 
£ssiÚ
 = 
	`uÅack_ušt32
(
buf
+5);

246 
ušt32_t
 
size
 = 
	`uÅack_ušt32
(
buf
+9);

247 
	`lua_pushš‹g”
(
L
, 
add»ss
);

248 
	`lua_pushš‹g”
(
L
, 
£ssiÚ
);

249 
	`lua_pushš‹g”
(
L
, 
size
);

250 
	`lua_pushboŞ—n
(
L
, 1);

251 
	`lua_pushboŞ—n
(
L
, 
is_push
);

254 
	}
}

257 
	$uÅackm»q_·¹
(
lua_S‹
 *
L
, cÚ¡ 
ušt8_t
 * 
buf
, 
sz
) {

258 ià(
sz
 < 5) {

259  
	`luaL_”rÜ
(
L
, "Invalid cluster multi…art message");

261 
·ddšg
 = (
buf
[0] == 2);

262 
ušt32_t
 
£ssiÚ
 = 
	`uÅack_ušt32
(
buf
+1);

263 
	`lua_pushboŞ—n
(
L
, 0);

264 
	`lua_pushš‹g”
(
L
, 
£ssiÚ
);

265 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
+5, 
sz
-5);

266 
	`lua_pushboŞ—n
(
L
, 
·ddšg
);

269 
	}
}

272 
	$uÅack»q_¡ršg
(
lua_S‹
 *
L
, cÚ¡ 
ušt8_t
 * 
buf
, 
sz
) {

273 ià(
sz
 < 2) {

274  
	`luaL_”rÜ
(
L
, "Inv®id clu¡” mes§g(size=%d)", 
sz
);

276 
size_t
 
Çmesz
 = 
buf
[1];

277 ià(
sz
 < 
Çmesz
 + 6) {

278  
	`luaL_”rÜ
(
L
, "Inv®id clu¡” mes§g(size=%d)", 
sz
);

280 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
+2, 
Çmesz
);

281 
ušt32_t
 
£ssiÚ
 = 
	`uÅack_ušt32
(
buf
 + 
Çmesz
 + 2);

282 
	`lua_pushš‹g”
(
L
, (
ušt32_t
)
£ssiÚ
);

283 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
+2+
Çmesz
+4, 
sz
 -‚amesz - 6);

284 ià(
£ssiÚ
 == 0) {

285 
	`lua_pushn
(
L
);

286 
	`lua_pushboŞ—n
(
L
,1);

291 
	}
}

294 
	$uÅackm»q_¡ršg
(
lua_S‹
 *
L
, cÚ¡ 
ušt8_t
 * 
buf
, 
sz
, 
is_push
) {

295 ià(
sz
 < 2) {

296  
	`luaL_”rÜ
(
L
, "Inv®id clu¡” mes§g(size=%d)", 
sz
);

298 
size_t
 
Çmesz
 = 
buf
[1];

299 ià(
sz
 < 
Çmesz
 + 10) {

300  
	`luaL_”rÜ
(
L
, "Inv®id clu¡” mes§g(size=%d)", 
sz
);

302 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
+2, 
Çmesz
);

303 
ušt32_t
 
£ssiÚ
 = 
	`uÅack_ušt32
(
buf
 + 
Çmesz
 + 2);

304 
ušt32_t
 
size
 = 
	`uÅack_ušt32
(
buf
 + 
Çmesz
 + 6);

305 
	`lua_pushš‹g”
(
L
, 
£ssiÚ
);

306 
	`lua_pushš‹g”
(
L
, 
size
);

307 
	`lua_pushboŞ—n
(
L
, 1);

308 
	`lua_pushboŞ—n
(
L
, 
is_push
);

311 
	}
}

314 
	$luÅack»que¡
(
lua_S‹
 *
L
) {

315 
size_t
 
ssz
;

316 cÚ¡ *
msg
 = 
	`luaL_checkl¡ršg
(
L
,1,&
ssz
);

317 
sz
 = ()
ssz
;

318 
msg
[0]) {

320  
	`uÅack»q_numb”
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
);

322  
	`uÅackm»q_numb”
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
, 0);

324  
	`uÅackm»q_numb”
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
, 1);

327  
	`uÅackm»q_·¹
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
);

329  
	`uÅack»q_¡ršg
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
);

331  
	`uÅackm»q_¡ršg
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
, 0 );

333  
	`uÅackm»q_¡ršg
(
L
, (cÚ¡ 
ušt8_t
 *)
msg
, 
sz
, 1 );

335  
	`luaL_”rÜ
(
L
, "Inv®id„eq…ackagty³ %d", 
msg
[0]);

337 
	}
}

363 
	$Íack»¥Ú£
(
lua_S‹
 *
L
) {

364 
ušt32_t
 
£ssiÚ
 = (ušt32_t)
	`luaL_checkš‹g”
(
L
,1);

367 
ok
 = 
	`lua_toboŞ—n
(
L
,2);

368 * 
msg
;

369 
size_t
 
sz
;

371 ià(
	`lua_ty³
(
L
,3è=ğ
LUA_TSTRING
) {

372 
msg
 = (*)
	`lua_tŞ¡ršg
(
L
, 3, &
sz
);

374 
msg
 = 
	`lua_tou£rd©a
(
L
,3);

375 
sz
 = (
size_t
)
	`luaL_checkš‹g”
(
L
, 4);

378 ià(!
ok
) {

379 ià(
sz
 > 
MULTI_PART
) {

381 
sz
 = 
MULTI_PART
;

384 ià(
sz
 > 
MULTI_PART
) {

386 
·¹
 = (
sz
 - 1è/ 
MULTI_PART
 + 1;

387 
	`lua_ü—‹bË
(
L
, 
·¹
+1, 0);

388 
ušt8_t
 
buf
[
TEMP_LENGTH
];

391 
	`fl_h—d”
(
L
, 
buf
, 9);

392 
	`fl_ušt32
(
buf
+2, 
£ssiÚ
);

393 
buf
[6] = 2;

394 
	`fl_ušt32
(
buf
+7, (
ušt32_t
)
sz
);

395 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 11);

396 
	`lua_¿w£ti
(
L
, -2, 1);

398 * 
±r
 = 
msg
;

399 
i
;

400 
i
=0;i<
·¹
;i++) {

401 
s
;

402 ià(
sz
 > 
MULTI_PART
) {

403 
s
 = 
MULTI_PART
;

404 
buf
[6] = 3;

406 
s
 = 
sz
;

407 
buf
[6] = 4;

409 
	`fl_h—d”
(
L
, 
buf
, 
s
+5);

410 
	`fl_ušt32
(
buf
+2, 
£ssiÚ
);

411 
	`memıy
(
buf
+7,
±r
,
s
);

412 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 
s
+7);

413 
	`lua_¿w£ti
(
L
, -2, 
i
+2);

414 
sz
 -ğ
s
;

415 
±r
 +ğ
s
;

421 
ušt8_t
 
buf
[
TEMP_LENGTH
];

422 
	`fl_h—d”
(
L
, 
buf
, 
sz
+5);

423 
	`fl_ušt32
(
buf
+2, 
£ssiÚ
);

424 
buf
[6] = 
ok
;

425 
	`memıy
(
buf
+7,
msg
,
sz
);

427 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
, 
sz
+7);

430 
	}
}

440 
	$luÅack»¥Ú£
(
lua_S‹
 *
L
) {

441 
size_t
 
sz
;

442 cÚ¡ * 
buf
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

443 ià(
sz
 < 5) {

446 
ušt32_t
 
£ssiÚ
 = 
	`uÅack_ušt32
((cÚ¡ 
ušt8_t
 *)
buf
);

447 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
£ssiÚ
);

448 
buf
[4]) {

450 
	`lua_pushboŞ—n
(
L
, 0);

451 
	`lua_pushl¡ršg
(
L
, 
buf
+5, 
sz
-5);

455 
	`lua_pushboŞ—n
(
L
, 1);

456 
	`lua_pushl¡ršg
(
L
, 
buf
+5, 
sz
-5);

459 ià(
sz
 != 9) {

462 
sz
 = 
	`uÅack_ušt32
((cÚ¡ 
ušt8_t
 *)
buf
+5);

463 
	`lua_pushboŞ—n
(
L
, 1);

464 
	`lua_pushš‹g”
(
L
, 
sz
);

465 
	`lua_pushboŞ—n
(
L
, 1);

468 
	`lua_pushboŞ—n
(
L
, 1);

469 
	`lua_pushl¡ršg
(
L
, 
buf
+5, 
sz
-5);

470 
	`lua_pushboŞ—n
(
L
, 1);

475 
	}
}

478 
	$lcÚÿt
(
lua_S‹
 *
L
) {

479 ià(!
	`lua_i¡abË
(
L
,1))

481 ià(
	`lua_g‘i
(
L
,1,1è!ğ
LUA_TNUMBER
)

483 
sz
 = 
	`lua_toš‹g”
(
L
,-1);

484 
	`lua_pİ
(
L
,1);

485 * 
buff
 = 
	`skyÃt_m®loc
(
sz
);

486 
idx
 = 2;

487 
off£t
 = 0;

488 
	`lua_g‘i
(
L
,1,
idx
è=ğ
LUA_TSTRING
) {

489 
size_t
 
s
;

490 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
s
);

491 ià(
s
+
off£t
 > 
sz
) {

492 
	`skyÃt_ä“
(
buff
);

495 
	`memıy
(
buff
+
off£t
, 
¡r
, 
s
);

496 
	`lua_pİ
(
L
,1);

497 
off£t
 +ğ
s
;

498 ++
idx
;

500 ià(
off£t
 !ğ
sz
) {

501 
	`skyÃt_ä“
(
buff
);

505 
	`lua_pushlightu£rd©a
(
L
, 
buff
);

506 
	`lua_pushš‹g”
(
L
, 
sz
);

508 
	}
}

510 
LUAMOD_API
 

511 
	$luaİ’_skyÃt_şu¡”_cÜe
(
lua_S‹
 *
L
) {

512 
luaL_Reg
 
l
[] = {

513 { "·ck»que¡", 
Íack»que¡
 },

514 { "·ckpush", 
Íackpush
 },

515 { "uÅack»que¡", 
luÅack»que¡
 },

516 { "·ck»¥Ú£", 
Íack»¥Ú£
 },

517 { "uÅack»¥Ú£", 
luÅack»¥Ú£
 },

518 { "cÚÿt", 
lcÚÿt
 },

519 { 
NULL
, NULL },

521 
	`luaL_checkv”siÚ
(
L
);

522 
	`luaL_Ãwlib
(
L
,
l
);

525 
	}
}

	@lualib-src/lua-crypt.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

6 
	~<time.h
>

7 
	~<¡dšt.h
>

8 
	~<¡ršg.h
>

9 
	~<¡dlib.h
>

11 
	#SMALL_CHUNK
 256

	)

15 
ušt32_t
 
	gSB1
[64] = {

34 
ušt32_t
 
	gSB2
[64] = {

53 
ušt32_t
 
	gSB3
[64] = {

72 
ušt32_t
 
	gSB4
[64] = {

91 
ušt32_t
 
	gSB5
[64] = {

110 
ušt32_t
 
	gSB6
[64] = {

129 
ušt32_t
 
	gSB7
[64] = {

148 
ušt32_t
 
	gSB8
[64] = {

169 
ušt32_t
 
	gLHs
[16] = {

176 
ušt32_t
 
	gRHs
[16] = {

185 
	#GET_UINT32
(
n
,
b
,
i
) \

187 (
n
èğĞ(
ušt32_t
è(
b
)[(
i
) ] << 24 ) \

188 | ( (
ušt32_t
è(
b
)[(
i
) + 1] << 16 ) \

189 | ( (
ušt32_t
è(
b
)[(
i
) + 2] << 8 ) \

190 | ( (
ušt32_t
è(
b
)[(
i
) + 3] ); \

191 }

	)

193 
	#PUT_UINT32
(
n
,
b
,
i
) \

195 (
b
)[(
i
è] = (
ušt8_t
èĞ(
n
) >> 24 ); \

196 (
b
)[(
i
è+ 1] = (
ušt8_t
èĞ(
n
) >> 16 ); \

197 (
b
)[(
i
è+ 2] = (
ušt8_t
èĞ(
n
) >> 8 ); \

198 (
b
)[(
i
è+ 3] = (
ušt8_t
èĞ(
n
) ); \

199 }

	)

203 
	#DES_IP
(
X
,
Y
) \

205 
T
 = ((
X
 >> 4è^ 
Y
) & 0x0F0F0F0F; Y ^= T; X ^= (T << 4); \

206 
T
 = ((
X
 >> 16è^ 
Y
) & 0x0000FFFF; Y ^= T; X ^= (T << 16); \

207 
T
 = ((
Y
 >> 2è^ 
X
) & 0x33333333; X ^= T; Y ^= (T << 2); \

208 
T
 = ((
Y
 >> 8è^ 
X
) & 0x00FF00FF; X ^= T; Y ^= (T << 8); \

209 
Y
 = ((Y << 1) | (Y >> 31)) & 0xFFFFFFFF; \

210 
T
 = (
X
 ^ 
Y
) & 0xAAAAAAAA; Y ^= T; X ^= T; \

211 
X
 = ((X << 1) | (X >> 31)) & 0xFFFFFFFF; \

212 }

	)

216 
	#DES_FP
(
X
,
Y
) \

218 
X
 = ((X << 31) | (X >> 1)) & 0xFFFFFFFF; \

219 
T
 = (
X
 ^ 
Y
) & 0xAAAAAAAA; X ^= T; Y ^= T; \

220 
Y
 = ((Y << 31) | (Y >> 1)) & 0xFFFFFFFF; \

221 
T
 = ((
Y
 >> 8è^ 
X
) & 0x00FF00FF; X ^= T; Y ^= (T << 8); \

222 
T
 = ((
Y
 >> 2è^ 
X
) & 0x33333333; X ^= T; Y ^= (T << 2); \

223 
T
 = ((
X
 >> 16è^ 
Y
) & 0x0000FFFF; Y ^= T; X ^= (T << 16); \

224 
T
 = ((
X
 >> 4è^ 
Y
) & 0x0F0F0F0F; Y ^= T; X ^= (T << 4); \

225 }

	)

229 
	#DES_ROUND
(
X
,
Y
) \

231 
T
 = *
SK
++ ^ 
X
; \

232 
Y
 ^ğ
SB8
[ (
T
 ) & 0x3F ] ^ \

233 
SB6
[ (
T
 >> 8) & 0x3F ] ^ \

234 
SB4
[ (
T
 >> 16) & 0x3F ] ^ \

235 
SB2
[ (
T
 >> 24) & 0x3F ]; \

237 
T
 = *
SK
++ ^ ((
X
 << 28) | (X >> 4)); \

238 
Y
 ^ğ
SB7
[ (
T
 ) & 0x3F ] ^ \

239 
SB5
[ (
T
 >> 8) & 0x3F ] ^ \

240 
SB3
[ (
T
 >> 16) & 0x3F ] ^ \

241 
SB1
[ (
T
 >> 24) & 0x3F ]; \

242 }

	)

247 
	$des_maš_ks
Ğ
ušt32_t
 
SK
[32], cÚ¡ 
ušt8_t
 
key
[8] ) {

248 
i
;

249 
ušt32_t
 
X
, 
Y
, 
T
;

251 
	`GET_UINT32
Ğ
X
, 
key
, 0 );

252 
	`GET_UINT32
Ğ
Y
, 
key
, 4 );

256 
T
 = ((
Y
 >> 4è^ 
X
) & 0x0F0F0F0F; X ^= T; Y ^= (T << 4);

257 
T
 = ((
Y
 ) ^ 
X
) & 0x10101010; X ^= T; Y ^= (T );

259 
X
 = (
LHs
[ (X ) & 0xF] << 3) | (LHs[ (X >> 8) & 0xF ] << 2)

260 | (
LHs
[ (
X
 >> 16) & 0xF] << 1) | (LHs[ (X >> 24) & 0xF ] )

261 | (
LHs
[ (
X
 >> 5) & 0xF] << 7) | (LHs[ (X >> 13) & 0xF ] << 6)

262 | (
LHs
[ (
X
 >> 21) & 0xF] << 5) | (LHs[ (X >> 29) & 0xF ] << 4);

264 
Y
 = (
RHs
[ (Y >> 1) & 0xF] << 3) | (RHs[ (Y >> 9) & 0xF ] << 2)

265 | (
RHs
[ (
Y
 >> 17) & 0xF] << 1) | (RHs[ (Y >> 25) & 0xF ] )

266 | (
RHs
[ (
Y
 >> 4) & 0xF] << 7) | (RHs[ (Y >> 12) & 0xF ] << 6)

267 | (
RHs
[ (
Y
 >> 20) & 0xF] << 5) | (RHs[ (Y >> 28) & 0xF ] << 4);

269 
X
 &= 0x0FFFFFFF;

270 
Y
 &= 0x0FFFFFFF;

274  
i
 = 0; i < 16; i++ )

276 ifĞ
i
 < 2 || i == 8 || i == 15 )

278 
X
 = ((X << 1) | (X >> 27)) & 0x0FFFFFFF;

279 
Y
 = ((Y << 1) | (Y >> 27)) & 0x0FFFFFFF;

283 
X
 = ((X << 2) | (X >> 26)) & 0x0FFFFFFF;

284 
Y
 = ((Y << 2) | (Y >> 26)) & 0x0FFFFFFF;

287 *
SK
++ = ((
X
 << 4) & 0x24000000) | ((X << 28) & 0x10000000)

288 | ((
X
 << 14) & 0x08000000) | ((X << 18) & 0x02080000)

289 | ((
X
 << 6) & 0x01000000) | ((X << 9) & 0x00200000)

290 | ((
X
 >> 1) & 0x00100000) | ((X << 10) & 0x00040000)

291 | ((
X
 << 2) & 0x00020000) | ((X >> 10) & 0x00010000)

292 | ((
Y
 >> 13) & 0x00002000) | ((Y >> 4) & 0x00001000)

293 | ((
Y
 << 6) & 0x00000800) | ((Y >> 1) & 0x00000400)

294 | ((
Y
 >> 14) & 0x00000200) | ((Y ) & 0x00000100)

295 | ((
Y
 >> 5) & 0x00000020) | ((Y >> 10) & 0x00000010)

296 | ((
Y
 >> 3) & 0x00000008) | ((Y >> 18) & 0x00000004)

297 | ((
Y
 >> 26) & 0x00000002) | ((Y >> 24) & 0x00000001);

299 *
SK
++ = ((
X
 << 15) & 0x20000000) | ((X << 17) & 0x10000000)

300 | ((
X
 << 10) & 0x08000000) | ((X << 22) & 0x04000000)

301 | ((
X
 >> 2) & 0x02000000) | ((X << 1) & 0x01000000)

302 | ((
X
 << 16) & 0x00200000) | ((X << 11) & 0x00100000)

303 | ((
X
 << 3) & 0x00080000) | ((X >> 6) & 0x00040000)

304 | ((
X
 << 15) & 0x00020000) | ((X >> 4) & 0x00010000)

305 | ((
Y
 >> 2) & 0x00002000) | ((Y << 8) & 0x00001000)

306 | ((
Y
 >> 14) & 0x00000808) | ((Y >> 9) & 0x00000400)

307 | ((
Y
 ) & 0x00000200) | ((Y << 7) & 0x00000100)

308 | ((
Y
 >> 7) & 0x00000020) | ((Y >> 3) & 0x00000011)

309 | ((
Y
 << 2) & 0x00000004) | ((Y >> 21) & 0x00000002);

311 
	}
}

316 
	$des_üy±
ĞcÚ¡ 
ušt32_t
 
SK
[32], cÚ¡ 
ušt8_t
 
šput
[8], ušt8_ˆ
ouut
[8] ) {

317 
ušt32_t
 
X
, 
Y
, 
T
;

319 
	`GET_UINT32
Ğ
X
, 
šput
, 0 );

320 
	`GET_UINT32
Ğ
Y
, 
šput
, 4 );

322 
	`DES_IP
Ğ
X
, 
Y
 );

324 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

325 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

326 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

327 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

328 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

329 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

330 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

331 
	`DES_ROUND
Ğ
Y
, 
X
 ); DES_ROUND( X, Y );

333 
	`DES_FP
Ğ
Y
, 
X
 );

335 
	`PUT_UINT32
Ğ
Y
, 
ouut
, 0 );

336 
	`PUT_UINT32
Ğ
X
, 
ouut
, 4 );

337 
	}
}

340 
	$Ìªdomkey
(
lua_S‹
 *
L
) {

341 
tmp
[8];

342 
i
;

343 
x
 = 0;

344 
i
=0;i<8;i++) {

345 
tmp
[
i
] = 
	`¿ndom
() & 0xff;

346 
x
 ^ğ
tmp
[
i
];

348 ià(
x
==0) {

349 
tmp
[0] |= 1;

351 
	`lua_pushl¡ršg
(
L
, 
tmp
, 8);

353 
	}
}

356 
	$des_key
(
lua_S‹
 *
L
, 
ušt32_t
 
SK
[32]) {

357 
size_t
 
keysz
 = 0;

358 cÚ¡ * 
key
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
keysz
);

359 ià(
keysz
 != 8) {

360 
	`luaL_”rÜ
(
L
, "Inv®id key siz%d,‚“d 8 by‹s", ()
keysz
);

362 
	`des_maš_ks
(
SK
, 
key
);

363 
	}
}

366 
	$lde£ncode
(
lua_S‹
 *
L
) {

367 
ušt32_t
 
SK
[32];

368 
	`des_key
(
L
, 
SK
);

370 
size_t
 
‹xtsz
 = 0;

371 cÚ¡ 
ušt8_t
 * 
‹xt
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 2, &
‹xtsz
);

372 
size_t
 
chunksz
 = (
‹xtsz
 + 8) & ~7;

373 
ušt8_t
 
tmp
[
SMALL_CHUNK
];

374 
ušt8_t
 *
bufãr
 = 
tmp
;

375 ià(
chunksz
 > 
SMALL_CHUNK
) {

376 
bufãr
 = 
	`lua_Ãwu£rd©a
(
L
, 
chunksz
);

378 
i
;

379 
i
=0;i<()
‹xtsz
-7;i+=8) {

380 
	`des_üy±
(
SK
, 
‹xt
+
i
, 
bufãr
+i);

382 
by‹s
 = 
‹xtsz
 - 
i
;

383 
ušt8_t
 

[8];

384 
j
;

385 
j
=0;j<8;j++) {

386 ià(
j
 < 
by‹s
) {

387 

[
j
] = 
‹xt
[
i
+j];

388 } ià(
j
==
by‹s
) {

389 

[
j
] = 0x80;

391 

[
j
] = 0;

394 
	`des_üy±
(
SK
, 

, 
bufãr
+
i
);

395 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
bufãr
, 
chunksz
);

398 
	}
}

401 
	$ldesdecode
(
lua_S‹
 *
L
) {

402 
ušt32_t
 
ESK
[32];

403 
	`des_key
(
L
, 
ESK
);

404 
ušt32_t
 
SK
[32];

405 
i
;

406  
i
 = 0; i < 32; i += 2 ) {

407 
SK
[
i
] = 
ESK
[30 - i];

408 
SK
[
i
 + 1] = 
ESK
[31 - i];

410 
size_t
 
‹xtsz
 = 0;

411 cÚ¡ 
ušt8_t
 *
‹xt
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 2, &
‹xtsz
);

412 ià((
‹xtsz
 & 7) ||extsz == 0) {

413  
	`luaL_”rÜ
(
L
, "Inv®id de üy±exˆËngth %d", ()
‹xtsz
);

415 
ušt8_t
 
tmp
[
SMALL_CHUNK
];

416 
ušt8_t
 *
bufãr
 = 
tmp
;

417 ià(
‹xtsz
 > 
SMALL_CHUNK
) {

418 
bufãr
 = 
	`lua_Ãwu£rd©a
(
L
, 
‹xtsz
);

420 
i
=0;i<
‹xtsz
;i+=8) {

421 
	`des_üy±
(
SK
, 
‹xt
+
i
, 
bufãr
+i);

423 
·ddšg
 = 1;

424 
i
=
‹xtsz
-1;i>=textsz-8;i--) {

425 ià(
bufãr
[
i
] == 0) {

426 
·ddšg
++;

427 } ià(
bufãr
[
i
] == 0x80) {

430  
	`luaL_”rÜ
(
L
, "Invalid des cryptext");

433 ià(
·ddšg
 > 8) {

434  
	`luaL_”rÜ
(
L
, "Invalid des cryptext");

436 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
bufãr
, 
‹xtsz
 - 
·ddšg
);

438 
	}
}

442 
	$Hash
(cÚ¡ * 
¡r
, 
sz
, 
ušt8_t
 
key
[8]) {

443 
ušt32_t
 
djb_hash
 = 5381L;

444 
ušt32_t
 
js_hash
 = 1315423911L;

446 
i
;

447 
i
=0;i<
sz
;i++) {

448 
ušt8_t
 
c
 = (ušt8_t)
¡r
[
i
];

449 
djb_hash
 +ğ(djb_hash << 5è+ 
c
;

450 
js_hash
 ^ğ((js_hash << 5è+ 
c
 + (js_hash >> 2));

453 
key
[0] = 
djb_hash
 & 0xff;

454 
key
[1] = (
djb_hash
 >> 8) & 0xff;

455 
key
[2] = (
djb_hash
 >> 16) & 0xff;

456 
key
[3] = (
djb_hash
 >> 24) & 0xff;

458 
key
[4] = 
js_hash
 & 0xff;

459 
key
[5] = (
js_hash
 >> 8) & 0xff;

460 
key
[6] = (
js_hash
 >> 16) & 0xff;

461 
key
[7] = (
js_hash
 >> 24) & 0xff;

462 
	}
}

465 
	$lhashkey
(
lua_S‹
 *
L
) {

466 
size_t
 
sz
 = 0;

467 cÚ¡ * 
key
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

468 
ušt8_t
 
»®key
[8];

469 
	`Hash
(
key
,()
sz
,
»®key
);

470 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
»®key
, 8);

472 
	}
}

475 
	$Éohex
(
lua_S‹
 *
L
) {

476 
hex
[] = "0123456789abcdef";

477 
size_t
 
sz
 = 0;

478 cÚ¡ 
ušt8_t
 * 
‹xt
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

479 
tmp
[
SMALL_CHUNK
];

480 *
bufãr
 = 
tmp
;

481 ià(
sz
 > 
SMALL_CHUNK
/2) {

482 
bufãr
 = 
	`lua_Ãwu£rd©a
(
L
, 
sz
 * 2);

484 
i
;

485 
i
=0;i<
sz
;i++) {

486 
bufãr
[
i
*2] = 
hex
[
‹xt
[i] >> 4];

487 
bufãr
[
i
*2+1] = 
hex
[
‹xt
[i] & 0xf];

489 
	`lua_pushl¡ršg
(
L
, 
bufãr
, 
sz
 * 2);

491 
	}
}

493 
	#HEX
(
v
,
c
è{ 
tmp
 = (èc; iàÑm°>ğ'0' &&m°<ğ'9'è{ v =mp-'0'; } { v =m°- 'a' + 10; } }

	)

496 
	$läomhex
(
lua_S‹
 *
L
) {

497 
size_t
 
sz
 = 0;

498 cÚ¡ * 
‹xt
 = 
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

499 ià(
sz
 & 1) {

500  
	`luaL_”rÜ
(
L
, "Inv®id hexexˆsiz%d", ()
sz
);

502 
tmp
[
SMALL_CHUNK
];

503 *
bufãr
 = 
tmp
;

504 ià(
sz
 > 
SMALL_CHUNK
*2) {

505 
bufãr
 = 
	`lua_Ãwu£rd©a
(
L
, 
sz
 / 2);

507 
i
;

508 
i
=0;i<
sz
;i+=2) {

509 
ušt8_t
 
hi
,
low
;

510 
	`HEX
(
hi
, 
‹xt
[
i
]);

511 
	`HEX
(
low
, 
‹xt
[
i
+1]);

512 ià(
hi
 > 16 || 
low
 > 16) {

513  
	`luaL_”rÜ
(
L
, "Inv®id hexext", 
‹xt
);

515 
bufãr
[
i
/2] = 
hi
<<4 | 
low
;

517 
	`lua_pushl¡ršg
(
L
, 
bufãr
, 
i
/2);

519 
	}
}

522 cÚ¡ 
ušt32_t
 
	gk
[64] = {

541 cÚ¡ 
ušt32_t
 
	gr
[] = {7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22, 7, 12, 17, 22,

547 
	#LEFTROTATE
(
x
, 
c
è(((xè<< (c)è| ((xè>> (32 - (c))))

	)

550 
	$dige¡_md5
(
ušt32_t
 
w
[16], ušt32_ˆ
»suÉ
[4]) {

551 
ušt32_t
 
a
, 
b
, 
c
, 
d
, 
f
, 
g
, 
‹mp
;

552 
i
;

554 
a
 = 0x67452301u;

555 
b
 = 0xefcdab89u;

556 
c
 = 0x98badcfeu;

557 
d
 = 0x10325476u;

559 
i
 = 0; i<64; i++) {

560 ià(
i
 < 16) {

561 
f
 = (
b
 & 
c
è| ((~bè& 
d
);

562 
g
 = 
i
;

563 } ià(
i
 < 32) {

564 
f
 = (
d
 & 
b
è| ((~dè& 
c
);

565 
g
 = (5*
i
 + 1) % 16;

566 } ià(
i
 < 48) {

567 
f
 = 
b
 ^ 
c
 ^ 
d
;

568 
g
 = (3*
i
 + 5) % 16;

570 
f
 = 
c
 ^ (
b
 | (~
d
));

571 
g
 = (7*
i
) % 16;

574 
‹mp
 = 
d
;

575 
d
 = 
c
;

576 
c
 = 
b
;

577 
b
 = b + 
	`LEFTROTATE
((
a
 + 
f
 + 
k
[
i
] + 
w
[
g
]), 
r
[i]);

578 
a
 = 
‹mp
;

581 
»suÉ
[0] = 
a
;

582 
»suÉ
[1] = 
b
;

583 
»suÉ
[2] = 
c
;

584 
»suÉ
[3] = 
d
;

585 
	}
}

589 
	$hmac
(
ušt32_t
 
x
[2], ušt32_ˆ
y
[2], ušt32_ˆ
»suÉ
[2]) {

590 
ušt32_t
 
w
[16];

591 
ušt32_t
 
r
[4];

592 
i
;

593 
i
=0;i<16;i+=4) {

594 
w
[
i
] = 
x
[1];

595 
w
[
i
+1] = 
x
[0];

596 
w
[
i
+2] = 
y
[1];

597 
w
[
i
+3] = 
y
[0];

600 
	`dige¡_md5
(
w
,
r
);

602 
»suÉ
[0] = 
r
[2]^r[3];

603 
»suÉ
[1] = 
r
[0]^r[1];

604 
	}
}

607 
	$hmac_md5
(
ušt32_t
 
x
[2], ušt32_ˆ
y
[2], ušt32_ˆ
»suÉ
[2]) {

608 
ušt32_t
 
w
[16];

609 
ušt32_t
 
r
[4];

610 
i
;

611 
i
=0;i<12;i+=4) {

612 
w
[
i
] = 
x
[0];

613 
w
[
i
+1] = 
x
[1];

614 
w
[
i
+2] = 
y
[0];

615 
w
[
i
+3] = 
y
[1];

618 
w
[12] = 0x80;

619 
w
[13] = 0;

620 
w
[14] = 384;

621 
w
[15] = 0;

623 
	`dige¡_md5
(
w
,
r
);

625 
»suÉ
[0] = (
r
[0] + 0x67452301u) ^ (r[2] + 0x98badcfeu);

626 
»suÉ
[1] = (
r
[1] + 0xefcdab89u) ^ (r[3] + 0x10325476u);

627 
	}
}

630 
	$»ad64
(
lua_S‹
 *
L
, 
ušt32_t
 
xx
[2], ušt32_ˆ
yy
[2]) {

631 
size_t
 
sz
 = 0;

632 cÚ¡ 
ušt8_t
 *
x
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

633 ià(
sz
 != 8) {

634 
	`luaL_”rÜ
(
L
, "Invalid uint64 x");

636 cÚ¡ 
ušt8_t
 *
y
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

637 ià(
sz
 != 8) {

638 
	`luaL_”rÜ
(
L
, "Invalid uint64 y");

640 
xx
[0] = 
x
[0] | x[1]<<8 | x[2]<<16 | x[3]<<24;

641 
xx
[1] = 
x
[4] | x[5]<<8 | x[6]<<16 | x[7]<<24;

642 
yy
[0] = 
y
[0] | y[1]<<8 | y[2]<<16 | y[3]<<24;

643 
yy
[1] = 
y
[4] | y[5]<<8 | y[6]<<16 | y[7]<<24;

644 
	}
}

647 
	$pushqwÜd
(
lua_S‹
 *
L
, 
ušt32_t
 
»suÉ
[2]) {

648 
ušt8_t
 
tmp
[8];

649 
tmp
[0] = 
»suÉ
[0] & 0xff;

650 
tmp
[1] = (
»suÉ
[0] >> 8 )& 0xff;

651 
tmp
[2] = (
»suÉ
[0] >> 16 )& 0xff;

652 
tmp
[3] = (
»suÉ
[0] >> 24 )& 0xff;

653 
tmp
[4] = 
»suÉ
[1] & 0xff;

654 
tmp
[5] = (
»suÉ
[1] >> 8 )& 0xff;

655 
tmp
[6] = (
»suÉ
[1] >> 16 )& 0xff;

656 
tmp
[7] = (
»suÉ
[1] >> 24 )& 0xff;

658 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
tmp
, 8);

660 
	}
}

663 
	$lhmac64
(
lua_S‹
 *
L
) {

664 
ušt32_t
 
x
[2], 
y
[2];

665 
	`»ad64
(
L
, 
x
, 
y
);

666 
ušt32_t
 
»suÉ
[2];

667 
	`hmac
(
x
,
y
,
»suÉ
);

668  
	`pushqwÜd
(
L
, 
»suÉ
);

669 
	}
}

678 
	$lhmac64_md5
(
lua_S‹
 *
L
) {

679 
ušt32_t
 
x
[2], 
y
[2];

680 
	`»ad64
(
L
, 
x
, 
y
);

681 
ušt32_t
 
»suÉ
[2];

682 
	`hmac_md5
(
x
,
y
,
»suÉ
);

683  
	`pushqwÜd
(
L
, 
»suÉ
);

684 
	}
}

691 
	$lhmac_hash
(
lua_S‹
 *
L
) {

692 
ušt32_t
 
key
[2];

693 
size_t
 
sz
 = 0;

694 cÚ¡ 
ušt8_t
 *
x
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

695 ià(
sz
 != 8) {

696 
	`luaL_”rÜ
(
L
, "Invalid uint64 key");

698 
key
[0] = 
x
[0] | x[1]<<8 | x[2]<<16 | x[3]<<24;

699 
key
[1] = 
x
[4] | x[5]<<8 | x[6]<<16 | x[7]<<24;

700 cÚ¡ * 
‹xt
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

701 
ušt8_t
 
h
[8];

702 
	`Hash
(
‹xt
,()
sz
,
h
);

703 
ušt32_t
 
h‹xt
[2];

704 
h‹xt
[0] = 
h
[0] | h[1]<<8 | h[2]<<16 | h[3]<<24;

705 
h‹xt
[1] = 
h
[4] | h[5]<<8 | h[6]<<16 | h[7]<<24;

706 
ušt32_t
 
»suÉ
[2];

707 
	`hmac
(
h‹xt
,
key
,
»suÉ
);

708  
	`pushqwÜd
(
L
, 
»suÉ
);

709 
	}
}

714 
	#P
 0xffffffffffffffc5uÎ

	)

716 
šlše
 
ušt64_t


717 
	$mul_mod_p
(
ušt64_t
 
a
, ušt64_ˆ
b
) {

718 
ušt64_t
 
m
 = 0;

719 
b
) {

720 if(
b
&1) {

721 
ušt64_t
 
t
 = 
P
-
a
;

722 iàĞ
m
 >ğ
t
) {

723 
m
 -ğ
t
;

725 
m
 +ğ
a
;

728 ià(
a
 >ğ
P
 -‡) {

729 
a
 =‡ * 2 - 
P
;

731 
a
 =‡ * 2;

733 
b
>>=1;

735  
m
;

736 
	}
}

738 
šlše
 
ušt64_t


739 
	$pow_mod_p
(
ušt64_t
 
a
, ušt64_ˆ
b
) {

740 ià(
b
==1) {

741  
a
;

743 
ušt64_t
 
t
 = 
	`pow_mod_p
(
a
, 
b
>>1);

744 
t
 = 
	`mul_mod_p
(t,t);

745 ià(
b
 % 2) {

746 
t
 = 
	`mul_mod_p
Ñ, 
a
);

748  
t
;

749 
	}
}

752 
ušt64_t


753 
	$powmodp
(
ušt64_t
 
a
, ušt64_ˆ
b
) {

754 ià(
a
 > 
P
)

755 
a
%=
P
;

756  
	`pow_mod_p
(
a
,
b
);

757 
	}
}

760 
	$push64
(
lua_S‹
 *
L
, 
ušt64_t
 
r
) {

761 
ušt8_t
 
tmp
[8];

762 
tmp
[0] = 
r
 & 0xff;

763 
tmp
[1] = (
r
 >> 8 )& 0xff;

764 
tmp
[2] = (
r
 >> 16 )& 0xff;

765 
tmp
[3] = (
r
 >> 24 )& 0xff;

766 
tmp
[4] = (
r
 >> 32 )& 0xff;

767 
tmp
[5] = (
r
 >> 40 )& 0xff;

768 
tmp
[6] = (
r
 >> 48 )& 0xff;

769 
tmp
[7] = (
r
 >> 56 )& 0xff;

771 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
tmp
, 8);

772 
	}
}

775 
	$ldh£ü‘
(
lua_S‹
 *
L
) {

776 
ušt32_t
 
x
[2], 
y
[2];

777 
	`»ad64
(
L
, 
x
, 
y
);

778 
ušt64_t
 
xx
 = (ušt64_t)
x
[0] | (uint64_t)x[1]<<32;

779 
ušt64_t
 
yy
 = (ušt64_t)
y
[0] | (uint64_t)y[1]<<32;

780 ià(
xx
 =ğ0 || 
yy
 == 0)

781  
	`luaL_”rÜ
(
L
, "Can't be 0");

782 
ušt64_t
 
r
 = 
	`powmodp
(
xx
, 
yy
);

784 
	`push64
(
L
, 
r
);

787 
	}
}

789 
	#G
 5

	)

792 
	$ldhexchªge
(
lua_S‹
 *
L
) {

793 
size_t
 
sz
 = 0;

794 cÚ¡ 
ušt8_t
 *
x
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

795 ià(
sz
 != 8) {

796 
	`luaL_”rÜ
(
L
, "Invalid dh uint64 key");

798 
ušt32_t
 
xx
[2];

799 
xx
[0] = 
x
[0] | x[1]<<8 | x[2]<<16 | x[3]<<24;

800 
xx
[1] = 
x
[4] | x[5]<<8 | x[6]<<16 | x[7]<<24;

802 
ušt64_t
 
x64
 = (ušt64_t)
xx
[0] | (uint64_t)xx[1]<<32;

803 ià(
x64
 == 0)

804  
	`luaL_”rÜ
(
L
, "Can't be 0");

806 
ušt64_t
 
r
 = 
	`powmodp
(
G
, 
x64
);

807 
	`push64
(
L
, 
r
);

809 
	}
}

814 
	$lb64’code
(
lua_S‹
 *
L
) {

815 cÚ¡ * 
’codšg
 = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";

816 
size_t
 
sz
 = 0;

817 cÚ¡ 
ušt8_t
 * 
‹xt
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

818 
’code_sz
 = (
sz
 + 2)/3*4;

819 
tmp
[
SMALL_CHUNK
];

820 *
bufãr
 = 
tmp
;

821 ià(
’code_sz
 > 
SMALL_CHUNK
) {

822 
bufãr
 = 
	`lua_Ãwu£rd©a
(
L
, 
’code_sz
);

824 
i
,
j
;

825 
j
=0;

826 
i
=0;i<()
sz
-2;i+=3) {

827 
ušt32_t
 
v
 = 
‹xt
[
i
] << 16 |ext[i+1] << 8 |ext[i+2];

828 
bufãr
[
j
] = 
’codšg
[
v
 >> 18];

829 
bufãr
[
j
+1] = 
’codšg
[(
v
 >> 12) & 0x3f];

830 
bufãr
[
j
+2] = 
’codšg
[(
v
 >> 6) & 0x3f];

831 
bufãr
[
j
+3] = 
’codšg
[(
v
) & 0x3f];

832 
j
+=4;

834 
·ddšg
 = 
sz
-
i
;

835 
ušt32_t
 
v
;

836 
·ddšg
) {

838 
v
 = 
‹xt
[
i
];

839 
bufãr
[
j
] = 
’codšg
[
v
 >> 2];

840 
bufãr
[
j
+1] = 
’codšg
[(
v
 & 3) << 4];

841 
bufãr
[
j
+2] = '=';

842 
bufãr
[
j
+3] = '=';

845 
v
 = 
‹xt
[
i
] << 8 |ext[i+1];

846 
bufãr
[
j
] = 
’codšg
[
v
 >> 10];

847 
bufãr
[
j
+1] = 
’codšg
[(
v
 >> 4) & 0x3f];

848 
bufãr
[
j
+2] = 
’codšg
[(
v
 & 0xf) << 2];

849 
bufãr
[
j
+3] = '=';

852 
	`lua_pushl¡ršg
(
L
, 
bufãr
, 
’code_sz
);

854 
	}
}

856 
šlše
 

857 
	$b64šdex
(
ušt8_t
 
c
) {

858 cÚ¡ 
decodšg
[] = {62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,-2,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51};

859 
decodšg_size
 = (
decodšg
)/(decoding[0]);

860 ià(
c
<43) {

863 
c
 -= 43;

864 ià(
c
>=
decodšg_size
)

866  
decodšg
[
c
];

867 
	}
}

870 
	$lb64decode
(
lua_S‹
 *
L
) {

871 
size_t
 
sz
 = 0;

872 cÚ¡ 
ušt8_t
 * 
‹xt
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

873 
decode_sz
 = (
sz
+3)/4*3;

874 
tmp
[
SMALL_CHUNK
];

875 *
bufãr
 = 
tmp
;

876 ià(
decode_sz
 > 
SMALL_CHUNK
) {

877 
bufãr
 = 
	`lua_Ãwu£rd©a
(
L
, 
decode_sz
);

879 
i
,
j
;

880 
ouut
 = 0;

881 
i
=0;i<
sz
;) {

882 
·ddšg
 = 0;

883 
c
[4];

884 
j
=0;j<4;) {

885 ià(
i
>=
sz
) {

886  
	`luaL_”rÜ
(
L
, "Invalid base64ext");

888 
c
[
j
] = 
	`b64šdex
(
‹xt
[
i
]);

889 ià(
c
[
j
] == -1) {

890 ++
i
;

893 ià(
c
[
j
] == -2) {

894 ++
·ddšg
;

896 ++
i
;

897 ++
j
;

899 
ušt32_t
 
v
;

900 
·ddšg
) {

902 
v
 = ()
c
[0] << 18 | c[1] << 12 | c[2] << 6 | c[3];

903 
bufãr
[
ouut
] = 
v
 >> 16;

904 
bufãr
[
ouut
+1] = (
v
 >> 8) & 0xff;

905 
bufãr
[
ouut
+2] = 
v
 & 0xff;

906 
ouut
 += 3;

909 ià(
c
[3] != -2 || (c[2] & 3)!=0) {

910  
	`luaL_”rÜ
(
L
, "Invalid base64ext");

912 
v
 = ()
c
[0] << 10 | c[1] << 4 | c[2] >> 2 ;

913 
bufãr
[
ouut
] = 
v
 >> 8;

914 
bufãr
[
ouut
+1] = 
v
 & 0xff;

915 
ouut
 += 2;

918 ià(
c
[3] != -2 || c[2] != -2 || (c[1] & 0xf) !=0) {

919  
	`luaL_”rÜ
(
L
, "Invalid base64ext");

921 
v
 = ()
c
[0] << 2 | c[1] >> 4;

922 
bufãr
[
ouut
] = 
v
;

923 ++ 
ouut
;

926  
	`luaL_”rÜ
(
L
, "Invalid base64ext");

929 
	`lua_pushl¡ršg
(
L
, 
bufãr
, 
ouut
);

931 
	}
}

934 
	$lxÜ_¡r
(
lua_S‹
 *
L
) {

935 
size_t
 
Ën1
,
Ën2
;

936 cÚ¡ *
s1
 = 
	`luaL_checkl¡ršg
(
L
,1,&
Ën1
);

937 cÚ¡ *
s2
 = 
	`luaL_checkl¡ršg
(
L
,2,&
Ën2
);

938 ià(
Ën2
 == 0) {

939  
	`luaL_”rÜ
(
L
, "Can't xorƒmpty string");

941 
luaL_Bufãr
 
b
;

942 * 
bufãr
 = 
	`luaL_buffš™size
(
L
, &
b
, 
Ën1
);

943 
i
;

944 
i
=0;i<
Ën1
;i++) {

945 
bufãr
[
i
] = 
s1
[i] ^ 
s2
[˜% 
Ën2
];

947 
	`luaL_addsize
(&
b
, 
Ën1
);

948 
	`luaL_push»suÉ
(&
b
);

950 
	}
}

953 
lsha1
(
lua_S‹
 *
L
);

954 
lhmac_sha1
(
lua_S‹
 *
L
);

956 
LUAMOD_API
 

957 
	$luaİ’_skyÃt_üy±
(
lua_S‹
 *
L
) {

958 
	`luaL_checkv”siÚ
(
L
);

959 
š™
 = 0;

960 ià(!
š™
) {

962 
š™
 = 1 ;

963 
	`¤ªdom
(
	`time
(
NULL
));

965 
luaL_Reg
 
l
[] = {

966 { "hashkey", 
lhashkey
 },

967 { "¿ndomkey", 
Ìªdomkey
 },

968 { "de£ncode", 
lde£ncode
 },

969 { "desdecode", 
ldesdecode
 },

970 { "hex’code", 
Éohex
 },

971 { "hexdecode", 
läomhex
 },

972 { "hmac64", 
lhmac64
 },

973 { "hmac64_md5", 
lhmac64_md5
 },

974 { "dhexchªge", 
ldhexchªge
 },

975 { "dh£ü‘", 
ldh£ü‘
 },

976 { "ba£64’code", 
lb64’code
 },

977 { "ba£64decode", 
lb64decode
 },

978 { "sha1", 
lsha1
 },

979 { "hmac_sha1", 
lhmac_sha1
 },

980 { "hmac_hash", 
lhmac_hash
 },

981 { "xÜ_¡r", 
lxÜ_¡r
 },

982 { 
NULL
, NULL },

984 
	`luaL_Ãwlib
(
L
,
l
);

986 
	}
}

988 
LUAMOD_API
 

989 
	$luaİ’_ş›Á_üy±
(
lua_S‹
 *
L
) {

990  
	`luaİ’_skyÃt_üy±
(
L
);

991 
	}
}

	@lualib-src/lua-datasheet.c

1 
	~<lua.h
>

2 
	~<Ïuxlib.h
>

3 
	~<¡dšt.h
>

5 
	#NODECACHE
 "_ùabË"

	)

6 
	#PROXYCACHE
 "_´oxy"

	)

7 
	#TABLES
 "_ùabËs"

	)

9 
	#VALUE_NIL
 0

	)

10 
	#VALUE_INTEGER
 1

	)

11 
	#VALUE_REAL
 2

	)

12 
	#VALUE_BOOLEAN
 3

	)

13 
	#VALUE_TABLE
 4

	)

14 
	#VALUE_STRING
 5

	)

15 
	#VALUE_INVALID
 6

	)

17 
	#INVALID_OFFSET
 0xffffffff

	)

19 
	s´oxy
 {

20 cÚ¡ * 
	md©a
;

21 
	mšdex
;

24 
	sdocum’t
 {

25 
ušt32_t
 
	m¡¹bl
;

26 
ušt32_t
 
	mn
;

27 
ušt32_t
 
	mšdex
[1];

32 
	sbË
 {

33 
ušt32_t
 
	m¬¿y
;

34 
ušt32_t
 
	mdiù
;

35 
ušt8_t
 
	mty³
[1];

40 
šlše
 cÚ¡ 
bË
 *

41 
	$g‘bË
(cÚ¡ 
docum’t
 *
doc
, 
šdex
) {

42 ià(
doc
->
šdex
[šdex] =ğ
INVALID_OFFSET
) {

43  
NULL
;

45  (cÚ¡ 
bË
 *)((cÚ¡ *)
doc
 + (
ušt32_t
è+ (ušt32_tè+ doc->
n
 * (ušt32_tè+ doc->
šdex
[index]);

46 
	}
}

49 
	$ü—‹_´oxy
(
lua_S‹
 *
L
, cÚ¡ *
d©a
, 
šdex
) {

50 cÚ¡ 
bË
 * 
t
 = 
	`g‘bË
(
d©a
, 
šdex
);

51 ià(
t
 =ğ
NULL
) {

52 
	`luaL_”rÜ
(
L
, "Inv®id index %d", 
šdex
);

54 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
NODECACHE
);

55 ià(
	`lua_¿wg‘p
(
L
, -1, 
t
è=ğ
LUA_TTABLE
) {

56 
	`lua_»¶aû
(
L
, -2);

59 
	`lua_pİ
(
L
, 1);

60 
	`lua_ÃwbË
(
L
);

61 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

62 
	`lua_£tm‘©abË
(
L
, -2);

63 
	`lua_pushv®ue
(
L
, -1);

65 
	`lua_¿w£
(
L
, -3, 
t
);

67 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
PROXYCACHE
);

69 
	`lua_pushv®ue
(
L
, -2);

71 
´oxy
 * 
p
 = 
	`lua_Ãwu£rd©a
(
L
, (proxy));

73 
p
->
d©a
 = data;

74 
p
->
šdex
 = index;

75 
	`lua_¿w£t
(
L
, -3);

77 
	`lua_pİ
(
L
, 1);

79 
	`lua_»¶aû
(
L
, -2);

81 
	}
}

84 
	$ş—r_bË
(
lua_S‹
 *
L
) {

85 
t
 = 
	`lua_g‘tİ
(
L
);

86 ià(
	`lua_ty³
(
L
, 
t
è!ğ
LUA_TTABLE
) {

87 
	`luaL_”rÜ
(
L
, "Invalid cache");

89 
	`lua_pushn
(
L
);

90 
	`lua_Ãxt
(
L
, 
t
) != 0) {

92 
	`lua_pİ
(
L
, 1);

93 
	`lua_pushv®ue
(
L
, -1);

94 
	`lua_pushn
(
L
);

96 
	`lua_¿w£t
(
L
, 
t
);

99 
	}
}

102 
	$upd©e_ÿche
(
lua_S‹
 *
L
, cÚ¡ *
d©a
, cÚ¡ * 
Ãwd©a
) {

103 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
NODECACHE
);

104 
t
 = 
	`lua_g‘tİ
(
L
);

105 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
PROXYCACHE
);

106 
±
 = 
t
 + 1;

107 
	`lua_ÃwbË
(
L
);

108 
Á
 = 
±
 + 1;

109 
	`lua_pushn
(
L
);

110 
	`lua_Ãxt
(
L
, 
t
) != 0) {

112 
	`lua_pushv®ue
(
L
, -1);

113 ià(
	`lua_¿wg‘
(
L
, 
±
è=ğ
LUA_TUSERDATA
) {

115 
´oxy
 * 
p
 = 
	`lua_tou£rd©a
(
L
, -1);

116 ià(
p
->
d©a
 == data) {

118 
p
->
d©a
 = 
Ãwd©a
;

119 cÚ¡ 
bË
 * 
Ãwt
 = 
	`g‘bË
(
Ãwd©a
, 
p
->
šdex
);

120 
	`lua_pİ
(
L
, 1);

122 
	`ş—r_bË
(
L
);

123 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

125 
	`lua_£tm‘©abË
(
L
, -2);

127 ià(
Ãwt
) {

128 
	`lua_¿w£
(
L
, 
Á
, 
Ãwt
);

130 
	`lua_pİ
(
L
, 1);

133 
	`lua_pushv®ue
(
L
, -1);

134 
	`lua_pushn
(
L
);

135 
	`lua_¿w£t
(
L
, 
t
);

137 
	`lua_pİ
(
L
, 2);

140 
	`lua_pİ
(
L
, 2);

145 
	`lua_pushn
(
L
);

146 
	`lua_Ãxt
(
L
, 
Á
) != 0) {

147 
	`lua_pushv®ue
(
L
, -2);

148 
	`lua_š£¹
(
L
, -2);

150 
	`lua_¿w£t
(
L
, 
t
);

153 
	`lua_pİ
(
L
, 3);

154 
	}
}

157 
	$lupd©e
(
lua_S‹
 *
L
) {

158 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
PROXYCACHE
);

159 
	`lua_pushv®ue
(
L
, 1);

161 ià(
	`lua_¿wg‘
(
L
, -2è!ğ
LUA_TUSERDATA
) {

162 
	`luaL_”rÜ
(
L
, "Inv®id…roxyabË %p", 
	`lua_tİoš‹r
(L, 1));

164 
´oxy
 * 
p
 = 
	`lua_tou£rd©a
(
L
, -1);

165 
	`luaL_checkty³
(
L
, 2, 
LUA_TLIGHTUSERDATA
);

166 cÚ¡ * 
Ãwd©a
 = 
	`lua_tou£rd©a
(
L
, 2);

167 
	`upd©e_ÿche
(
L
, 
p
->
d©a
, 
Ãwd©a
);

169 
	}
}

171 
šlše
 
ušt32_t


172 
	$g‘ušt32
(cÚ¡ *
v
) {

174 
ušt32_t
 
d
;

175 
ušt8_t
 
t
[4];

176 } 
‹¡
 = { 1 };

177 ià(
‹¡
.
t
[0] == 0) {

179 
‹¡
.
d
 = *(cÚ¡ 
ušt32_t
 *)
v
;

180  
‹¡
.
t
[0] |est.t[1] << 4 |est.t[2] << 8 |est.t[3] << 12;

182  *(cÚ¡ 
ušt32_t
 *)
v
;

184 
	}
}

186 
šlše
 

187 
	$g‘æßt
(cÚ¡ *
v
) {

189 
ušt32_t
 
d
;

190 
f
;

191 
ušt8_t
 
t
[4];

192 } 
‹¡
 = { 1 };

193 ià(
‹¡
.
t
[0] == 0) {

195 
‹¡
.
d
 = *(cÚ¡ 
ušt32_t
 *)
v
;

196 
‹¡
.
d
 =e¡.
t
[0] |est.t[1] << 4 |est.t[2] << 8 |est.t[3] << 12;

197  
‹¡
.
f
;

199  *(cÚ¡ *)
v
;

201 
	}
}

204 
	$pushv®ue
(
lua_S‹
 *
L
, cÚ¡ *
v
, 
ty³
, cÚ¡ 
docum’t
 * 
doc
) {

205 
ty³
) {

206 
VALUE_NIL
:

207 
	`lua_pushn
(
L
);

209 
VALUE_INTEGER
:

210 
	`lua_pushš‹g”
(
L
, (
št32_t
)
	`g‘ušt32
(
v
));

212 
VALUE_REAL
:

213 
	`lua_pushnumb”
(
L
, 
	`g‘æßt
(
v
));

215 
VALUE_BOOLEAN
:

216 
	`lua_pushboŞ—n
(
L
, 
	`g‘ušt32
(
v
));

218 
VALUE_TABLE
:

219 
	`ü—‹_´oxy
(
L
, 
doc
, 
	`g‘ušt32
(
v
));

221 
VALUE_STRING
:

222 
	`lua_push¡ršg
(
L
, (cÚ¡ *)
doc
 + doc->
¡¹bl
 + 
	`g‘ušt32
(
v
));

225 
	`luaL_”rÜ
(
L
, "Inv®idy³ %d‡ˆ%p", 
ty³
, 
v
);

227 
	}
}

230 
	$cİybË
(
lua_S‹
 *
L
, 
tbl
, 
´oxy
 *
p
) {

231 cÚ¡ 
docum’t
 * 
doc
 = (cÚ¡ docum’ˆ*)
p
->
d©a
;

232 ià(
p
->
šdex
 < 0 ||…->šdex >ğ
doc
->
n
) {

233 
	`luaL_”rÜ
(
L
, "Inv®id…roxy (šdex = %d,Ù® = %d)", 
p
->
šdex
, ()
doc
->
n
);

235 cÚ¡ 
bË
 * 
t
 = 
	`g‘bË
(
doc
, 
p
->
šdex
);

236 ià(
t
 =ğ
NULL
) {

237 
	`luaL_”rÜ
(
L
, "Inv®id…roxy (šdex = %d)", 
p
->
šdex
);

239 cÚ¡ 
ušt32_t
 * 
v
 = (cÚ¡ ušt32_ˆ*)((cÚ¡ *)
t
 + (ušt32_tè+ (ušt32_tè+ (Ñ->
¬¿y
 +->
diù
 + 3) & ~3));

240 
i
;

241 
i
=0;i<
t
->
¬¿y
;i++) {

242 
	`pushv®ue
(
L
, 
v
++, 
t
->
ty³
[
i
], 
doc
);

243 
	`lua_¿w£ti
(
L
, 
tbl
, 
i
+1);

245 
i
=0;i<
t
->
diù
;i++) {

246 
	`pushv®ue
(
L
, 
v
++, 
VALUE_STRING
, 
doc
);

247 
	`pushv®ue
(
L
, 
v
++, 
t
->
ty³
[t->
¬¿y
+
i
], 
doc
);

248 
	`lua_¿w£t
(
L
, 
tbl
);

250 
	}
}

253 
	$Êew
(
lua_S‹
 *
L
) {

254 
	`luaL_checkty³
(
L
, 1, 
LUA_TLIGHTUSERDATA
);

255 cÚ¡ * 
d©a
 = 
	`lua_tou£rd©a
(
L
, 1);

257 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
TABLES
);

258 
	`lua_pushv®ue
(
L
, 1);

259 
	`lua_¿w£
(
L
, -2, 
d©a
);

261 
	`ü—‹_´oxy
(
L
, 
d©a
, 0);

263 
	}
}

266 
	$cİyäomd©a
(
lua_S‹
 *
L
) {

267 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, 
PROXYCACHE
);

268 
	`lua_pushv®ue
(
L
, 1);

270 ià(
	`lua_¿wg‘
(
L
, -2è!ğ
LUA_TUSERDATA
) {

271 
	`luaL_”rÜ
(
L
, "Inv®id…roxyabË %p", 
	`lua_tİoš‹r
(L, 1));

273 
´oxy
 * 
p
 = 
	`lua_tou£rd©a
(
L
, -1);

274 
	`lua_pİ
(
L
, 2);

275 
	`cİybË
(
L
, 1, 
p
);

276 
	`lua_pushn
(
L
);

277 
	`lua_£tm‘©abË
(
L
, 1);

278 
	}
}

281 
	$lšdex
(
lua_S‹
 *
L
) {

282 
	`cİyäomd©a
(
L
);

283 
	`lua_¿wg‘
(
L
, 1);

285 
	}
}

288 
	$Êext
(
lua_S‹
 *
L
) {

289 
	`luaL_checkty³
(
L
, 1, 
LUA_TTABLE
);

290 
	`lua_£‰İ
(
L
, 2);

291 ià(
	`lua_Ãxt
(
L
, 1))

294 
	`lua_pushn
(
L
);

297 
	}
}

300 
	$Íaœs
(
lua_S‹
 *
L
) {

301 
	`cİyäomd©a
(
L
);

302 
	`lua_pushcfunùiÚ
(
L
, 
Êext
);

303 
	`lua_pushv®ue
(
L
, 1);

304 
	`lua_pushn
(
L
);

306 
	}
}

309 
	$Î’
(
lua_S‹
 *
L
) {

310 
	`cİyäomd©a
(
L
);

311 
	`lua_pushš‹g”
(
L
, 
	`lua_¿wËn
(L, 1));

313 
	}
}

316 
	$Ãw_w—k_bË
(
lua_S‹
 *
L
, cÚ¡ *
mode
) {

317 
	`lua_ÃwbË
(
L
);

319 
	`lua_ü—‹bË
(
L
, 0, 1);

320 
	`lua_push¡ršg
(
L
, 
mode
);

321 
	`lua_£tf›ld
(
L
, -2, "__mode");

323 
	`lua_£tm‘©abË
(
L
, -2);

324 
	}
}

327 
	$g’_m‘©abË
(
lua_S‹
 *
L
) {

328 
	`Ãw_w—k_bË
(
L
, "kv");

329 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
NODECACHE
);

331 
	`Ãw_w—k_bË
(
L
, "k");

332 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
PROXYCACHE
);

334 
	`lua_ÃwbË
(
L
);

335 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, 
TABLES
);

337 
	`lua_ü—‹bË
(
L
, 0, 1);

339 
	`lua_ü—‹bË
(
L
, 0, 2);

340 
luaL_Reg
 
l
[] = {

341 { "__šdex", 
lšdex
 },

342 { "__·œs", 
Íaœs
 },

343 { "__Ën", 
Î’
 },

344 { 
NULL
, NULL },

346 
	`lua_pushv®ue
(
L
, -1);

347 
	`luaL_£tfuncs
(
L
, 
l
, 1);

348 
	}
}

351 
	$l¡ršgpoš‹r
(
lua_S‹
 *
L
) {

352 cÚ¡ * 
¡r
 = 
	`luaL_check¡ršg
(
L
, 1);

353 
	`lua_pushlightu£rd©a
(
L
, (*)
¡r
);

355 
	}
}

357 
LUAMOD_API
 

358 
	$luaİ’_skyÃt_d©ash“t_cÜe
(
lua_S‹
 *
L
) {

359 
	`luaL_checkv”siÚ
(
L
);

360 
luaL_Reg
 
l
[] = {

361 { "Ãw", 
Êew
 },

362 { "upd©e", 
lupd©e
 },

363 { 
NULL
, NULL },

366 
	`luaL_ÃwlibbË
(
L
,
l
);

367 
	`g’_m‘©abË
(
L
);

368 
	`luaL_£tfuncs
(
L
, 
l
, 1);

369 
	`lua_pushcfunùiÚ
(
L
, 
l¡ršgpoš‹r
);

370 
	`lua_£tf›ld
(
L
, -2, "stringpointer");

372 
	}
}

	@lualib-src/lua-debugchannel.c

1 
	#LUA_LIB


	)

4 
	~<lua.h
>

5 
	~<Ïuxlib.h
>

6 
	~<uni¡d.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~"¥šlock.h
"

11 
	#METANAME
 "debugchªÃl"

	)

13 
	scommªd
 {

14 
commªd
 * 
	mÃxt
;

15 
size_t
 
	msz
;

18 
	schªÃl
 {

19 
¥šlock
 
	mlock
;

20 
	m»f
;

21 
commªd
 * 
	mh—d
;

22 
commªd
 * 
	m
;

25 
chªÃl
 *

26 
	$chªÃl_Ãw
() {

27 
chªÃl
 * 
c
 = 
	`m®loc
((*c));

28 
	`mem£t
(
c
, 0 , (*c));

29 
c
->
»f
 = 1;

30 
	`SPIN_INIT
(
c
)

32  
c
;

33 
	}
}

35 
chªÃl
 *

36 
	$chªÃl_cÚÃù
(
chªÃl
 *
c
) {

37 
chªÃl
 * 
»t
 = 
NULL
;

38 
	`SPIN_LOCK
(
c
)

39 ià(
c
->
»f
 == 1) {

40 ++
c
->
»f
;

41 
»t
 = 
c
;

43 
	`SPIN_UNLOCK
(
c
)

44  
»t
;

45 
	}
}

47 
chªÃl
 *

48 
	$chªÃl_»Ëa£
(
chªÃl
 *
c
) {

49 
	`SPIN_LOCK
(
c
)

50 --
c
->
»f
;

51 ià(
c
->
»f
 > 0) {

52 
	`SPIN_UNLOCK
(
c
)

53  
c
;

56 
commªd
 * 
p
 = 
c
->
h—d
;

57 
c
->
h—d
 = 
NULL
;

58 
c
->

 = 
NULL
;

59 
p
) {

60 
commªd
 *
Ãxt
 = 
p
->next;

61 
	`ä“
(
p
);

62 
p
 = 
Ãxt
;

64 
	`SPIN_UNLOCK
(
c
)

65 
	`SPIN_DESTROY
(
c
)

66 
	`ä“
(
c
);

67  
NULL
;

68 
	}
}

71 
commªd
 *

72 
	$chªÃl_»ad
(
chªÃl
 *
c
, 
timeout
) {

73 
commªd
 * 
»t
 = 
NULL
;

74 
	`SPIN_LOCK
(
c
)

75 ià(
c
->
h—d
 =ğ
NULL
) {

76 
	`SPIN_UNLOCK
(
c
)

77 
ti
 = ()(
timeout
 * 100000);

78 
	`u¦“p
(
ti
);

79  
NULL
;

81 
»t
 = 
c
->
h—d
;

82 
c
->
h—d
 = 
»t
->
Ãxt
;

83 ià(
c
->
h—d
 =ğ
NULL
) {

84 
c
->

 = 
NULL
;

86 
	`SPIN_UNLOCK
(
c
)

88  
»t
;

89 
	}
}

92 
	$chªÃl_wr™e
(
chªÃl
 *
c
, cÚ¡ * 
s
, 
size_t
 
sz
) {

93 
commªd
 * 
cmd
 = 
	`m®loc
((*cmd)+ 
sz
);

94 
cmd
->
sz
 = sz;

95 
cmd
->
Ãxt
 = 
NULL
;

96 
	`memıy
(
cmd
+1, 
s
, 
sz
);

97 
	`SPIN_LOCK
(
c
)

98 ià(
c
->

 =ğ
NULL
) {

99 
c
->
h—d
 = c->

 = 
cmd
;

101 
c
->

->
Ãxt
 = 
cmd
;

102 
c
->

 = 
cmd
;

104 
	`SPIN_UNLOCK
(
c
)

105 
	}
}

107 
	schªÃl_box
 {

108 
chªÃl
 *
	mc
;

112 
	$Ì—d
(
lua_S‹
 *
L
) {

113 
chªÃl_box
 *
cb
 = 
	`luaL_checkud©a
(
L
,1, 
METANAME
);

114 
ti
 = 
	`luaL_İŠumb”
(
L
, 2, 0);

115 
commªd
 * 
c
 = 
	`chªÃl_»ad
(
cb
->c, 
ti
);

116 ià(
c
 =ğ
NULL
)

118 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)(
c
+1), c->
sz
);

119 
	`ä“
(
c
);

121 
	}
}

124 
	$lwr™e
(
lua_S‹
 *
L
) {

125 
chªÃl_box
 *
cb
 = 
	`luaL_checkud©a
(
L
,1, 
METANAME
);

126 
size_t
 
sz
;

127 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

128 
	`chªÃl_wr™e
(
cb
->
c
, 
¡r
, 
sz
);

130 
	}
}

133 
	$Ì–—£
(
lua_S‹
 *
L
) {

134 
chªÃl_box
 *
cb
 = 
	`lua_tou£rd©a
(
L
, 1);

135 ià(
cb
) {

136 ià(
	`chªÃl_»Ëa£
(
cb
->
c
è=ğ
NULL
) {

137 
cb
->
c
 = 
NULL
;

142 
	}
}

144 
chªÃl
 *

145 
	$Ãw_chªÃl
(
lua_S‹
 *
L
, 
chªÃl
 *
c
) {

146 ià(
c
 =ğ
NULL
) {

147 
c
 = 
	`chªÃl_Ãw
();

149 
c
 = 
	`chªÃl_cÚÃù
(c);

151 ià(
c
 =ğ
NULL
) {

152 
	`luaL_”rÜ
(
L
, "new channel failed");

155 
chªÃl_box
 * 
cb
 = 
	`lua_Ãwu£rd©a
(
L
, (*cb));

156 
cb
->
c
 = c;

157 ià(
	`luaL_Ãwm‘©abË
(
L
, 
METANAME
)) {

158 
luaL_Reg
 
l
[]={

159 { "»ad", 
Ì—d
 },

160 { "wr™e", 
lwr™e
 },

161 { 
NULL
, NULL },

163 
	`luaL_Ãwlib
(
L
,
l
);

164 
	`lua_£tf›ld
(
L
, -2, "__index");

165 
	`lua_pushcfunùiÚ
(
L
, 
Ì–—£
);

166 
	`lua_£tf›ld
(
L
, -2, "__gc");

168 
	`lua_£tm‘©abË
(
L
, -2);

169  
c
;

170 
	}
}

173 
	$lü—‹
(
lua_S‹
 *
L
) {

174 
chªÃl
 *
c
 = 
	`Ãw_chªÃl
(
L
, 
NULL
);

175 
	`lua_pushlightu£rd©a
(
L
, 
c
);

177 
	}
}

180 
	$lcÚÃù
(
lua_S‹
 *
L
) {

181 
chªÃl
 *
c
 = 
	`lua_tou£rd©a
(
L
, 1);

182 ià(
c
 =ğ
NULL
)

183  
	`luaL_”rÜ
(
L
, "Invalid channel…ointer");

184 
	`Ãw_chªÃl
(
L
, 
c
);

187 
	}
}

189 cÚ¡ 
	gHOOKKEY
 = 0;

197 
lua_S‹
 *
	$g‘th»ad
 (
lua_S‹
 *
L
, *
¬g
) {

198 ià(
	`lua_i¡h»ad
(
L
, 1)) {

199 *
¬g
 = 1;

200  
	`lua_tÙh»ad
(
L
, 1);

203 *
¬g
 = 0;

204  
L
;

206 
	}
}

212 
	$hookf
 (
lua_S‹
 *
L
, 
lua_Debug
 *
¬
) {

213 cÚ¡ *cÚ¡ 
hookÇmes
[] =

215 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

216 
	`lua_pushth»ad
(
L
);

217 ià(
	`lua_¿wg‘
(
L
, -2è=ğ
LUA_TFUNCTION
) {

218 
	`lua_push¡ršg
(
L
, 
hookÇmes
[()
¬
->
ev’t
]);

219 ià(
¬
->
cu¼’še
 >= 0)

220 
	`lua_pushš‹g”
(
L
, 
¬
->
cu¼’še
);

221 
	`lua_pushn
(
L
);

222 
	`lua_ÿÎ
(
L
, 2, 1);

223 
y›ld
 = 
	`lua_toboŞ—n
(
L
, -1);

224 
	`lua_pİ
(
L
,1);

225 ià(
y›ld
) {

226 
	`lua_y›ld
(
L
, 0);

229 
	}
}

234 
	$makemask
 (cÚ¡ *
smask
, 
couÁ
) {

235 
mask
 = 0;

236 ià(
	`¡rchr
(
smask
, 'c')è
mask
 |ğ
LUA_MASKCALL
;

237 ià(
	`¡rchr
(
smask
, 'r')è
mask
 |ğ
LUA_MASKRET
;

238 ià(
	`¡rchr
(
smask
, 'l')è
mask
 |ğ
LUA_MASKLINE
;

239 ià(
couÁ
 > 0è
mask
 |ğ
LUA_MASKCOUNT
;

240  
mask
;

241 
	}
}

243 
	$db_£thook
 (
lua_S‹
 *
L
) {

244 
¬g
, 
mask
, 
couÁ
;

245 
lua_Hook
 
func
;

246 
lua_S‹
 *
L1
 = 
	`g‘th»ad
(
L
, &
¬g
);

247 ià(
	`lua_i¢ÚeÜn
(
L
, 
¬g
+1)) {

248 
	`lua_£‰İ
(
L
, 
¬g
+1);

249 
func
 = 
NULL
; 
mask
 = 0; 
couÁ
 = 0;

252 cÚ¡ *
smask
 = 
	`luaL_check¡ršg
(
L
, 
¬g
+2);

253 
	`luaL_checkty³
(
L
, 
¬g
+1, 
LUA_TFUNCTION
);

254 
couÁ
 = ()
	`luaL_İtš‹g”
(
L
, 
¬g
 + 3, 0);

255 
func
 = 
hookf
; 
mask
 = 
	`makemask
(
smask
, 
couÁ
);

257 ià(
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
è=ğ
LUA_TNIL
) {

258 
	`lua_ü—‹bË
(
L
, 0, 2);

259 
	`lua_pushv®ue
(
L
, -1);

260 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, &
HOOKKEY
);

261 
	`lua_push¡ršg
(
L
, "k");

262 
	`lua_£tf›ld
(
L
, -2, "__mode");

263 
	`lua_pushv®ue
(
L
, -1);

264 
	`lua_£tm‘©abË
(
L
, -2);

266 
	`lua_pushth»ad
(
L1
); 
	`lua_xmove
(L1, 
L
, 1);

267 
	`lua_pushv®ue
(
L
, 
¬g
 + 1);

268 
	`lua_¿w£t
(
L
, -3);

269 
	`lua_£thook
(
L1
, 
func
, 
mask
, 
couÁ
);

271 
	}
}

273 
LUAMOD_API
 

274 
	$luaİ’_skyÃt_debugchªÃl
(
lua_S‹
 *
L
) {

275 
luaL_Reg
 
l
[] = {

276 { "ü—‹", 
lü—‹
 },

277 { "cÚÃù", 
lcÚÃù
 },

278 { "»Ëa£", 
Ì–—£
 },

279 { "£thook", 
db_£thook
 },

280 { 
NULL
, NULL },

282 
	`luaL_checkv”siÚ
(
L
);

283 
	`luaL_Ãwlib
(
L
,
l
);

285 
	}
}

	@lualib-src/lua-memory.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

6 
	~"m®loc_hook.h
"

7 
	~"luash¹bl.h
"

10 
	$ÉÙ®
(
lua_S‹
 *
L
) {

11 
size_t
 
t
 = 
	`m®loc_u£d_memÜy
();

12 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
t
);

15 
	}
}

18 
	$lblock
(
lua_S‹
 *
L
) {

19 
size_t
 
t
 = 
	`m®loc_memÜy_block
();

20 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
t
);

23 
	}
}

26 
	$ldumpšfo
(
lua_S‹
 *
L
) {

27 
	`memÜy_šfo_dump
();

30 
	}
}

33 
	$ldump
(
lua_S‹
 *
L
) {

34 
	`dump_c_mem
();

37 
	}
}

40 
	$Ëx·ndsh¹bl
(
lua_S‹
 *
L
) {

41 
n
 = 
	`luaL_checkš‹g”
(
L
, 1);

42 
	`luaS_ex·ndshr
(
n
);

44 
	}
}

47 
	$lcu¼’t
(
lua_S‹
 *
L
) {

48 
	`lua_pushš‹g”
(
L
, 
	`m®loc_cu¼’t_memÜy
());

50 
	}
}

52 
LUAMOD_API
 

53 
	$luaİ’_skyÃt_memÜy
(
lua_S‹
 *
L
) {

54 
	`luaL_checkv”siÚ
(
L
);

56 
luaL_Reg
 
l
[] = {

57 { "tÙ®", 
ÉÙ®
 },

58 { "block", 
lblock
 },

59 { "dumpšfo", 
ldumpšfo
 },

60 { "dump", 
ldump
 },

61 { "šfo", 
dump_mem_lua
 },

62 { "ssšfo", 
luaS_shršfo
 },

63 { "s£x·nd", 
Ëx·ndsh¹bl
 },

64 { "cu¼’t", 
lcu¼’t
 },

65 { 
NULL
, NULL },

68 
	`luaL_Ãwlib
(
L
,
l
);

71 
	}
}

	@lualib-src/lua-mongo.c

1 
	#LUA_LIB


	)

3 
	~"skyÃt_m®loc.h
"

5 
	~<lua.h
>

6 
	~<Ïuxlib.h
>

8 
	~<¡dšt.h
>

9 
	~<¡dlib.h
>

10 
	~<¡dio.h
>

11 
	~<¡ršg.h
>

13 
	#OP_REPLY
 1

	)

14 
	#OP_MSG
 1000

	)

15 
	#OP_UPDATE
 2001

	)

16 
	#OP_INSERT
 2002

	)

17 
	#OP_QUERY
 2004

	)

18 
	#OP_GET_MORE
 2005

	)

19 
	#OP_DELETE
 2006

	)

20 
	#OP_KILL_CURSORS
 2007

	)

22 
	#REPLY_CURSORNOTFOUND
 1

	)

23 
	#REPLY_QUERYFAILURE
 2

	)

24 
	#REPLY_AWAITCAPABLE
 8

25 

	)

26 
	#DEFAULT_CAP
 128

	)

28 
	scÚÃùiÚ
 {

29 
	msock
;

30 
	mid
;

33 
	s»¥Ú£
 {

34 
	mæags
;

35 
št32_t
 
	mcursÜ_id
[2];

36 
	m¡¬tšg_äom
;

37 
	mnumb”
;

40 
	sbufãr
 {

41 
	msize
;

42 
	mÿp
;

43 
ušt8_t
 * 
	m±r
;

44 
ušt8_t
 
	mbufãr
[
DEFAULT_CAP
];

47 
šlše
 
ušt32_t


48 
	$l™e_’dŸn
(
ušt32_t
 
v
) {

50 
ušt32_t
 
v
;

51 
ušt8_t
 
b
[4];

52 } 
u
;

53 
u
.
v
 = v;

54  
u
.
b
[0] | u.b[1] << 8 | u.b[2] << 16 | u.b[3] << 24;

55 
	}
}

57 * 
	tdocum’t
;

59 
šlše
 
ušt32_t


60 
	$g‘_Ëngth
(
docum’t
 
bufãr
) {

62 
ušt32_t
 
v
;

63 
ušt8_t
 
b
[4];

64 } 
u
;

65 
	`memıy
(&
u
.
v
, 
bufãr
, 4);

66  
u
.
b
[0] | u.b[1] << 8 | u.b[2] << 16 | u.b[3] << 24;

67 
	}
}

69 
šlše
 

70 
	$bufãr_de¡roy
(
bufãr
 *
b
) {

71 ià(
b
->
±r
 !ğb->
bufãr
) {

72 
	`skyÃt_ä“
(
b
->
±r
);

74 
	}
}

76 
šlše
 

77 
	$bufãr_ü—‹
(
bufãr
 *
b
) {

78 
b
->
size
 = 0;

79 
b
->
ÿp
 = 
DEFAULT_CAP
;

80 
b
->
±r
 = b->
bufãr
;

81 
	}
}

83 
šlše
 

84 
	$bufãr_»£rve
(
bufãr
 *
b
, 
sz
) {

85 ià(
b
->
size
 + 
sz
 <ğb->
ÿp
)

88 
b
->
ÿp
 *= 2;

89 } 
b
->
ÿp
 <ğb->
size
 + 
sz
);

91 ià(
b
->
±r
 =ğb->
bufãr
) {

92 
b
->
±r
 = 
	`skyÃt_m®loc
(b->
ÿp
);

93 
	`memıy
(
b
->
±r
, b->
bufãr
, b->
size
);

95 
b
->
±r
 = 
	`skyÃt_»®loc
(b->±r, b->
ÿp
);

97 
	}
}

99 
šlše
 

100 
	$wr™e_št32
(
bufãr
 *
b
, 
št32_t
 
v
) {

101 
ušt32_t
 
uv
 = (ušt32_t)
v
;

102 
	`bufãr_»£rve
(
b
,4);

103 
b
->
±r
[b->
size
++] = 
uv
 & 0xff;

104 
b
->
±r
[b->
size
++] = (
uv
 >> 8)&0xff;

105 
b
->
±r
[b->
size
++] = (
uv
 >> 16)&0xff;

106 
b
->
±r
[b->
size
++] = (
uv
 >> 24)&0xff;

107 
	}
}

109 
šlše
 

110 
	$wr™e_by‹s
(
bufãr
 *
b
, cÚ¡ * 
buf
, 
sz
) {

111 
	`bufãr_»£rve
(
b
,
sz
);

112 
	`memıy
(
b
->
±r
 + b->
size
, 
buf
, 
sz
);

113 
b
->
size
 +ğ
sz
;

114 
	}
}

117 
	$wr™e_¡ršg
(
bufãr
 *
b
, cÚ¡ *
key
, 
size_t
 
sz
) {

118 
	`bufãr_»£rve
(
b
,
sz
+1);

119 
	`memıy
(
b
->
±r
 + b->
size
, 
key
, 
sz
);

120 
b
->
±r
[b->
size
+
sz
] = '\0';

121 
b
->
size
+=
sz
+1;

122 
	}
}

124 
šlše
 

125 
	$»£rve_Ëngth
(
bufãr
 *
b
) {

126 
sz
 = 
b
->
size
;

127 
	`bufãr_»£rve
(
b
,4);

128 
b
->
size
 +=4;

129  
sz
;

130 
	}
}

132 
šlše
 

133 
	$wr™e_Ëngth
(
bufãr
 *
b
, 
št32_t
 
v
, 
off
) {

134 
ušt32_t
 
uv
 = (ušt32_t)
v
;

135 
b
->
±r
[
off
++] = 
uv
 & 0xff;

136 
b
->
±r
[
off
++] = (
uv
 >> 8)&0xff;

137 
b
->
±r
[
off
++] = (
uv
 >> 16)&0xff;

138 
b
->
±r
[
off
++] = (
uv
 >> 24)&0xff;

139 
	}
}

150 
	$İ_qu”y
(
lua_S‹
 *
L
) {

151 
id
 = 
	`luaL_checkš‹g”
(
L
,1);

152 
docum’t
 
qu”y
 = 
	`lua_tou£rd©a
(
L
,6);

153 ià(
qu”y
 =ğ
NULL
) {

154  
	`luaL_”rÜ
(
L
, "require query document");

156 
docum’t
 
£ËùÜ
 = 
	`lua_tou£rd©a
(
L
,7);

157 
æags
 = 
	`luaL_checkš‹g”
(
L
, 2);

158 
size_t
 
nsz
 = 0;

159 cÚ¡ *
Çme
 = 
	`luaL_checkl¡ršg
(
L
,3,&
nsz
);

160 
sk
 = 
	`luaL_checkš‹g”
(
L
, 4);

161 
numb”
 = 
	`luaL_checkš‹g”
(
L
, 5);

163 
luaL_Bufãr
 
b
;

164 
	`luaL_buffš™
(
L
,&
b
);

166 
bufãr
 
buf
;

167 
	`bufãr_ü—‹
(&
buf
);

168 
Ën
 = 
	`»£rve_Ëngth
(&
buf
);

169 
	`wr™e_št32
(&
buf
, 
id
);

170 
	`wr™e_št32
(&
buf
, 0);

171 
	`wr™e_št32
(&
buf
, 
OP_QUERY
);

172 
	`wr™e_št32
(&
buf
, 
æags
);

173 
	`wr™e_¡ršg
(&
buf
, 
Çme
, 
nsz
);

174 
	`wr™e_št32
(&
buf
, 
sk
);

175 
	`wr™e_št32
(&
buf
, 
numb”
);

177 
št32_t
 
qu”y_Ën
 = 
	`g‘_Ëngth
(
qu”y
);

178 
tÙ®
 = 
buf
.
size
 + 
qu”y_Ën
;

179 
št32_t
 
£ËùÜ_Ën
 = 0;

180 ià(
£ËùÜ
) {

181 
£ËùÜ_Ën
 = 
	`g‘_Ëngth
(
£ËùÜ
);

182 
tÙ®
 +ğ
£ËùÜ_Ën
;

185 
	`wr™e_Ëngth
(&
buf
, 
tÙ®
, 
Ën
);

186 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
buf
.
±r
, buf.
size
);

187 
	`bufãr_de¡roy
(&
buf
);

189 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
qu”y
, 
qu”y_Ën
);

191 ià(
£ËùÜ
) {

192 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
£ËùÜ
, 
£ËùÜ_Ën
);

195 
	`luaL_push»suÉ
(&
b
);

198 
	}
}

208 
	$İ_»¶y
(
lua_S‹
 *
L
) {

209 
size_t
 
d©a_Ën
 = 0;

210 cÚ¡ * 
d©a
 = 
	`luaL_checkl¡ršg
(
L
,1,&
d©a_Ën
);

213 
št32_t
 
»que¡_id
;

214 
št32_t
 
»¥Ú£_id
;

216 
št32_t
 
İcode
;

217 
št32_t
 
æags
;

218 
št32_t
 
cursÜ_id
[2];

219 
št32_t
 
¡¬tšg
;

220 
št32_t
 
numb”
;

221 } cÚ¡ *
»¶y
 = (cÚ¡ *)
d©a
;

223 ià(
d©a_Ën
 < (*
»¶y
)) {

224 
	`lua_pushboŞ—n
(
L
, 0);

228 
id
 = 
	`l™e_’dŸn
(
»¶y
->
»¥Ú£_id
);

229 
æags
 = 
	`l™e_’dŸn
(
»¶y
->flags);

230 ià(
æags
 & 
REPLY_QUERYFAILURE
) {

231 
	`lua_pushboŞ—n
(
L
,0);

232 
	`lua_pushš‹g”
(
L
, 
id
);

233 
	`lua_pushlightu£rd©a
(
L
, (*)(
»¶y
+1));

237 
¡¬tšg_äom
 = 
	`l™e_’dŸn
(
»¶y
->
¡¬tšg
);

238 
numb”
 = 
	`l™e_’dŸn
(
»¶y
->number);

239 
sz
 = ()
d©a_Ën
 - (*
»¶y
);

240 cÚ¡ 
ušt8_t
 * 
doc
 = (cÚ¡ ušt8_ˆ*)(
»¶y
+1);

242 ià(
	`lua_i¡abË
(
L
,2)) {

243 
i
 = 1;

244 
sz
 > 4) {

245 
	`lua_pushlightu£rd©a
(
L
, (*)
doc
);

246 
	`lua_¿w£ti
(
L
, 2, 
i
);

248 
št32_t
 
doc_Ën
 = 
	`g‘_Ëngth
((
docum’t
)
doc
);

250 
doc
 +ğ
doc_Ën
;

251 
sz
 -ğ
doc_Ën
;

253 ++
i
;

255 ià(
i
 !ğ
numb”
 + 1) {

256 
	`lua_pushboŞ—n
(
L
,0);

257 
	`lua_pushš‹g”
(
L
, 
id
);

260 
c
 = 
	`lua_¿wËn
(
L
, 2);

261 ;
i
<=
c
;i++) {

262 
	`lua_pushn
(
L
);

263 
	`lua_¿w£ti
(
L
, 2, 
i
);

266 ià(
sz
 >= 4) {

267 
sz
 -ğ
	`g‘_Ëngth
((
docum’t
)
doc
);

270 ià(
sz
 != 0) {

271  
	`luaL_”rÜ
(
L
, "Invalid„esult bson document");

273 
	`lua_pushboŞ—n
(
L
,1);

274 
	`lua_pushš‹g”
(
L
, 
id
);

275 ià(
numb”
 == 0)

276 
	`lua_pushn
(
L
);

278 
	`lua_pushlightu£rd©a
(
L
, (*)(
»¶y
+1));

279 ià(
»¶y
->
cursÜ_id
[0] == 0 &&„eply->cursor_id[1]==0) {

281 
	`lua_pushn
(
L
);

283 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)(
»¶y
->
cursÜ_id
), 8);

285 
	`lua_pushš‹g”
(
L
, 
¡¬tšg_äom
);

288 
	}
}

295 
	$İ_kl
(
lua_S‹
 *
L
) {

296 
size_t
 
cursÜ_Ën
 = 0;

297 cÚ¡ * 
cursÜ_id
 = 
	`luaL_tŞ¡ršg
(
L
, 1, &
cursÜ_Ën
);

298 ià(
cursÜ_Ën
 != 8) {

299  
	`luaL_”rÜ
(
L
, "Invalid cursor id");

302 
bufãr
 
buf
;

303 
	`bufãr_ü—‹
(&
buf
);

305 
Ën
 = 
	`»£rve_Ëngth
(&
buf
);

306 
	`wr™e_št32
(&
buf
, 0);

307 
	`wr™e_št32
(&
buf
, 0);

308 
	`wr™e_št32
(&
buf
, 
OP_KILL_CURSORS
);

310 
	`wr™e_št32
(&
buf
, 0);

311 
	`wr™e_št32
(&
buf
, 1);

312 
	`wr™e_by‹s
(&
buf
, 
cursÜ_id
, 8);

314 
	`wr™e_Ëngth
(&
buf
, buf.
size
, 
Ën
);

316 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
.
±r
, buf.
size
);

317 
	`bufãr_de¡roy
(&
buf
);

320 
	}
}

330 
	$İ_d–‘e
(
lua_S‹
 *
L
) {

331 
docum’t
 
£ËùÜ
 = 
	`lua_tou£rd©a
(
L
,3);

332 ià(
£ËùÜ
 =ğ
NULL
) {

333 
	`luaL_”rÜ
(
L
, "Invalid…aram");

335 
size_t
 
sz
 = 0;

336 cÚ¡ * 
Çme
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

338 
luaL_Bufãr
 
b
;

339 
	`luaL_buffš™
(
L
,&
b
);

341 
bufãr
 
buf
;

342 
	`bufãr_ü—‹
(&
buf
);

343 
Ën
 = 
	`»£rve_Ëngth
(&
buf
);

344 
	`wr™e_št32
(&
buf
, 0);

345 
	`wr™e_št32
(&
buf
, 0);

346 
	`wr™e_št32
(&
buf
, 
OP_DELETE
);

347 
	`wr™e_št32
(&
buf
, 0);

348 
	`wr™e_¡ršg
(&
buf
, 
Çme
, 
sz
);

349 
	`wr™e_št32
(&
buf
, 
	`lua_toš‹g”
(
L
,2));

351 
št32_t
 
£ËùÜ_Ën
 = 
	`g‘_Ëngth
(
£ËùÜ
);

352 
tÙ®
 = 
buf
.
size
 + 
£ËùÜ_Ën
;

353 
	`wr™e_Ëngth
(&
buf
, 
tÙ®
, 
Ën
);

355 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
buf
.
±r
, buf.
size
);

356 
	`bufãr_de¡roy
(&
buf
);

358 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
£ËùÜ
, 
£ËùÜ_Ën
);

359 
	`luaL_push»suÉ
(&
b
);

362 
	}
}

373 
	$İ_g‘_mÜe
(
lua_S‹
 *
L
) {

374 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

375 
size_t
 
sz
 = 0;

376 cÚ¡ * 
Çme
 = 
	`luaL_checkl¡ršg
(
L
,2,&
sz
);

377 
numb”
 = 
	`luaL_checkš‹g”
(
L
, 3);

378 
size_t
 
cursÜ_Ën
 = 0;

379 cÚ¡ * 
cursÜ_id
 = 
	`luaL_tŞ¡ršg
(
L
, 4, &
cursÜ_Ën
);

380 ià(
cursÜ_Ën
 != 8) {

381  
	`luaL_”rÜ
(
L
, "Invalid cursor id");

384 
bufãr
 
buf
;

385 
	`bufãr_ü—‹
(&
buf
);

386 
Ën
 = 
	`»£rve_Ëngth
(&
buf
);

387 
	`wr™e_št32
(&
buf
, 
id
);

388 
	`wr™e_št32
(&
buf
, 0);

389 
	`wr™e_št32
(&
buf
, 
OP_GET_MORE
);

390 
	`wr™e_št32
(&
buf
, 0);

391 
	`wr™e_¡ršg
(&
buf
, 
Çme
, 
sz
);

392 
	`wr™e_št32
(&
buf
, 
numb”
);

393 
	`wr™e_by‹s
(&
buf
, 
cursÜ_id
, 8);

394 
	`wr™e_Ëngth
(&
buf
, buf.
size
, 
Ën
);

396 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
buf
.
±r
, buf.
size
);

397 
	`bufãr_de¡roy
(&
buf
);

400 
	}
}

408 
	$İ_upd©e
(
lua_S‹
 *
L
) {

409 
docum’t
 
£ËùÜ
 = 
	`lua_tou£rd©a
(
L
,3);

410 
docum’t
 
upd©e
 = 
	`lua_tou£rd©a
(
L
,4);

411 ià(
£ËùÜ
 =ğ
NULL
 || 
upd©e
 == NULL) {

412 
	`luaL_”rÜ
(
L
, "Invalid…aram");

414 
size_t
 
sz
 = 0;

415 cÚ¡ * 
Çme
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

417 
luaL_Bufãr
 
b
;

418 
	`luaL_buffš™
(
L
, &
b
);

420 
bufãr
 
buf
;

421 
	`bufãr_ü—‹
(&
buf
);

423 
Ën
 = 
	`»£rve_Ëngth
(&
buf
);

424 
	`wr™e_št32
(&
buf
, 0);

425 
	`wr™e_št32
(&
buf
, 0);

426 
	`wr™e_št32
(&
buf
, 
OP_UPDATE
);

427 
	`wr™e_št32
(&
buf
, 0);

428 
	`wr™e_¡ršg
(&
buf
, 
Çme
, 
sz
);

429 
	`wr™e_št32
(&
buf
, 
	`lua_toš‹g”
(
L
,2));

431 
št32_t
 
£ËùÜ_Ën
 = 
	`g‘_Ëngth
(
£ËùÜ
);

432 
št32_t
 
upd©e_Ën
 = 
	`g‘_Ëngth
(
upd©e
);

434 
tÙ®
 = 
buf
.
size
 + 
£ËùÜ_Ën
 + 
upd©e_Ën
;

435 
	`wr™e_Ëngth
(&
buf
, 
tÙ®
, 
Ën
);

437 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
buf
.
±r
, buf.
size
);

438 
	`bufãr_de¡roy
(&
buf
);

440 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
£ËùÜ
, 
£ËùÜ_Ën
);

441 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
upd©e
, 
upd©e_Ën
);

443 
	`luaL_push»suÉ
(&
b
);

446 
	}
}

449 
	$docum’t_Ëngth
(
lua_S‹
 *
L
) {

450 ià(
	`lua_isu£rd©a
(
L
, 3)) {

451 
docum’t
 
doc
 = 
	`lua_tou£rd©a
(
L
,3);

452  
	`g‘_Ëngth
(
doc
);

454 ià(
	`lua_i¡abË
(
L
,3)) {

455 
tÙ®
 = 0;

456 
s
 = 
	`lua_¿wËn
(
L
,3);

457 
i
;

458 
i
=1;i<=
s
;i++) {

459 
	`lua_¿wg‘i
(
L
, 3, 
i
);

460 
docum’t
 
doc
 = 
	`lua_tou£rd©a
(
L
,-1);

461 ià(
doc
 =ğ
NULL
) {

462 
	`lua_pİ
(
L
,1);

463  
	`luaL_”rÜ
(
L
, "Inv®id docum’ˆ© %d", 
i
);

465 
tÙ®
 +ğ
	`g‘_Ëngth
(
doc
);

466 
	`lua_pİ
(
L
,1);

469  
tÙ®
;

471  
	`luaL_”rÜ
(
L
, "Insert‚eed documents");

472 
	}
}

479 
	$İ_š£¹
(
lua_S‹
 *
L
) {

480 
size_t
 
sz
 = 0;

481 cÚ¡ * 
Çme
 = 
	`luaL_checkl¡ršg
(
L
,2,&
sz
);

482 
dsz
 = 
	`docum’t_Ëngth
(
L
);

484 
luaL_Bufãr
 
b
;

485 
	`luaL_buffš™
(
L
, &
b
);

487 
bufãr
 
buf
;

488 
	`bufãr_ü—‹
(&
buf
);

490 
Ën
 = 
	`»£rve_Ëngth
(&
buf
);

491 
	`wr™e_št32
(&
buf
, 0);

492 
	`wr™e_št32
(&
buf
, 0);

493 
	`wr™e_št32
(&
buf
, 
OP_INSERT
);

494 
	`wr™e_št32
(&
buf
, 
	`lua_toš‹g”
(
L
,1));

495 
	`wr™e_¡ršg
(&
buf
, 
Çme
, 
sz
);

497 
tÙ®
 = 
buf
.
size
 + 
dsz
;

498 
	`wr™e_Ëngth
(&
buf
, 
tÙ®
, 
Ën
);

500 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
buf
.
±r
, buf.
size
);

501 
	`bufãr_de¡roy
(&
buf
);

503 ià(
	`lua_isu£rd©a
(
L
,3)) {

504 
docum’t
 
doc
 = 
	`lua_tou£rd©a
(
L
,3);

505 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
doc
, 
	`g‘_Ëngth
(doc));

507 
s
 = 
	`lua_¿wËn
(
L
, 3);

508 
i
;

509 
i
=1;i<=
s
;i++) {

510 
	`lua_¿wg‘i
(
L
,3,
i
);

511 
docum’t
 
doc
 = 
	`lua_tou£rd©a
(
L
,-1);

512 
	`lua_pİ
(
L
,1);

513 
	`luaL_addl¡ršg
(&
b
, (cÚ¡ *)
doc
, 
	`g‘_Ëngth
(doc));

517 
	`luaL_push»suÉ
(&
b
);

520 
	}
}

525 
	$»¶y_Ëngth
(
lua_S‹
 *
L
) {

526 cÚ¡ * 
¿wËn_¡r
 = 
	`luaL_check¡ršg
(
L
, 1);

527 
¿wËn
 = 0;

528 
	`memıy
(&
¿wËn
, 
¿wËn_¡r
, ());

529 
Ëngth
 = 
	`l™e_’dŸn
(
¿wËn
);

530 
	`lua_pushš‹g”
(
L
, 
Ëngth
 - 4);

532 
	}
}

534 
LUAMOD_API
 

535 
	$luaİ’_skyÃt_mÚgo_driv”
(
lua_S‹
 *
L
) {

536 
	`luaL_checkv”siÚ
(
L
);

537 
luaL_Reg
 
l
[] ={

538 { "qu”y", 
İ_qu”y
 },

539 { "»¶y", 
İ_»¶y
 },

540 { "kl", 
İ_kl
 },

541 { "d–‘e", 
İ_d–‘e
 },

542 { "mÜe", 
İ_g‘_mÜe
 },

543 { "upd©e", 
İ_upd©e
 },

544 { "š£¹", 
İ_š£¹
 },

545 { "Ëngth", 
»¶y_Ëngth
 },

546 { 
NULL
, NULL },

549 
	`luaL_Ãwlib
(
L
,
l
);

551 
	}
}

	@lualib-src/lua-multicast.c

1 
	#LUA_LIB


	)

3 
	~"skyÃt.h
"

5 
	~<lua.h
>

6 
	~<Ïuxlib.h
>

7 
	~<¡dšt.h
>

8 
	~<¡ršg.h
>

10 
	~"©omic.h
"

12 
	smc_·ckage
 {

13 
	m»ã»nû
;

14 
ušt32_t
 
	msize
;

15 *
	md©a
;

19 
	$·ck
(
lua_S‹
 *
L
, *
d©a
, 
size_t
 
size
) {

20 
mc_·ckage
 * 
·ck
 = 
	`skyÃt_m®loc
((mc_package));

21 
·ck
->
»ã»nû
 = 0;

22 
·ck
->
size
 = (
ušt32_t
)size;

23 
·ck
->
d©a
 = data;

24 
mc_·ckage
 ** 
»t
 = 
	`skyÃt_m®loc
((*ret));

25 *
»t
 = 
·ck
;

26 
	`lua_pushlightu£rd©a
(
L
, 
»t
);

27 
	`lua_pushš‹g”
(
L
, (
»t
));

29 
	}
}

38 
	$mc_·ckloÿl
(
lua_S‹
 *
L
) {

39 * 
d©a
 = 
	`lua_tou£rd©a
(
L
, 1);

40 
size_t
 
size
 = (size_t)
	`luaL_checkš‹g”
(
L
, 2);

41 ià(
size
 !ğ(
ušt32_t
)size) {

42  
	`luaL_”rÜ
(
L
, "Size should be 32bit integer");

44  
	`·ck
(
L
, 
d©a
, 
size
);

45 
	}
}

54 
	$mc_·ck»mÙe
(
lua_S‹
 *
L
) {

55 * 
d©a
 = 
	`lua_tou£rd©a
(
L
, 1);

56 
size_t
 
size
 = (size_t)
	`luaL_checkš‹g”
(
L
, 2);

57 ià(
size
 !ğ(
ušt32_t
)size) {

58  
	`luaL_”rÜ
(
L
, "Size should be 32bit integer");

60 * 
msg
 = 
	`skyÃt_m®loc
(
size
);

61 
	`memıy
(
msg
, 
d©a
, 
size
);

62  
	`·ck
(
L
, 
msg
, 
size
);

63 
	}
}

72 
	$mc_uÅackloÿl
(
lua_S‹
 *
L
) {

73 
mc_·ckage
 ** 
·ck
 = 
	`lua_tou£rd©a
(
L
,1);

74 
sz
 = 
	`luaL_checkš‹g”
(
L
,2);

75 ià(
sz
 !ğ(
·ck
)) {

76  
	`luaL_”rÜ
(
L
, "Inv®id muÉiÿ¡…ackagsiz%d", 
sz
);

78 
	`lua_pushlightu£rd©a
(
L
, *
·ck
);

79 
	`lua_pushlightu£rd©a
(
L
, (*
·ck
)->
d©a
);

80 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)((*
·ck
)->
size
));

82 
	}
}

91 
	$mc_bšd»ãr
(
lua_S‹
 *
L
) {

92 
mc_·ckage
 ** 
·ck
 = 
	`lua_tou£rd©a
(
L
,1);

93 
»f
 = 
	`luaL_checkš‹g”
(
L
,2);

94 ià((*
·ck
)->
»ã»nû
 != 0) {

95  
	`luaL_”rÜ
(
L
, "Can't bind‡ multicast…ackage morehan once");

97 (*
·ck
)->
»ã»nû
 = 
»f
;

99 
	`lua_pushlightu£rd©a
(
L
, *
·ck
);

101 
	`skyÃt_ä“
(
·ck
);

104 
	}
}

110 
	$mc_şo£loÿl
(
lua_S‹
 *
L
) {

111 
mc_·ckage
 *
·ck
 = 
	`lua_tou£rd©a
(
L
,1);

113 
»f
 = 
	`ATOM_DEC
(&
·ck
->
»ã»nû
);

114 ià(
»f
 <= 0) {

115 
	`skyÃt_ä“
(
·ck
->
d©a
);

116 
	`skyÃt_ä“
(
·ck
);

117 ià(
»f
 < 0) {

118  
	`luaL_”rÜ
(
L
, "Inv®id muÉiÿ¡…ackag»ã»nû %d", 
»f
);

123 
	}
}

130 
	$mc_»mÙe
(
lua_S‹
 *
L
) {

131 
mc_·ckage
 **
±r
 = 
	`lua_tou£rd©a
(
L
,1);

132 
mc_·ckage
 *
·ck
 = *
±r
;

133 
	`lua_pushlightu£rd©a
(
L
, 
·ck
->
d©a
);

134 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)(
·ck
->
size
));

135 
	`skyÃt_ä“
(
·ck
);

137 
	}
}

140 
	$mc_Ãxtid
(
lua_S‹
 *
L
) {

141 
ušt32_t
 
id
 = (ušt32_t)
	`luaL_checkš‹g”
(
L
, 1);

142 
id
 += 256;

143 
	`lua_pushš‹g”
(
L
, (
ušt32_t
)
id
);

146 
	}
}

148 
LUAMOD_API
 

149 
	$luaİ’_skyÃt_muÉiÿ¡_cÜe
(
lua_S‹
 *
L
) {

150 
luaL_Reg
 
l
[] = {

151 { "·ck", 
mc_·ckloÿl
 },

152 { "uÅack", 
mc_uÅackloÿl
 },

153 { "bšd", 
mc_bšd»ãr
 },

154 { "şo£", 
mc_şo£loÿl
 },

155 { "»mÙe", 
mc_»mÙe
 },

156 { "·ck»mÙe", 
mc_·ck»mÙe
 },

157 { "Ãxtid", 
mc_Ãxtid
 },

158 { 
NULL
, NULL },

160 
	`luaL_checkv”siÚ
(
L
);

161 
	`luaL_Ãwlib
(
L
,
l
);

163 
	}
}

	@lualib-src/lua-mysqlaux.c

1 
	#LUA_LIB


	)

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

7 
	~<lua.h
>

8 
	~<Ïuxlib.h
>

10 
	$num_esÿ³_sql_¡r
(*
d¡
, *
¤c
, 
size_t
 
size
)

12 
n
 =0;

13 
size
) {

16 ià((*
¤c
 & 0x80) == 0) {

17 *
¤c
) {

27 
n
++;

33 
¤c
++;

34 
size
--;

36  
n
;

37 
	}
}

39 
	$esÿ³_sql_¡r
(*
d¡
, *
¤c
, 
size_t
 
size
)

42 
size
) {

43 ià((*
¤c
 & 0x80) == 0) {

44 *
¤c
) {

46 *
d¡
++ = '\\';

47 *
d¡
++ = '0';

51 *
d¡
++ = '\\';

52 *
d¡
++ = 'b';

56 *
d¡
++ = '\\';

57 *
d¡
++ = 'n';

61 *
d¡
++ = '\\';

62 *
d¡
++ = 'r';

66 *
d¡
++ = '\\';

67 *
d¡
++ = 't';

71 *
d¡
++ = '\\';

72 *
d¡
++ = 'Z';

76 *
d¡
++ = '\\';

77 *
d¡
++ = '\\';

81 *
d¡
++ = '\\';

82 *
d¡
++ = '\'';

86 *
d¡
++ = '\\';

87 *
d¡
++ = '"';

91 *
d¡
++ = *
¤c
;

95 *
d¡
++ = *
¤c
;

97 
¤c
++;

98 
size
--;

101  
d¡
;

102 
	}
}

108 
	$quÙe_sql_¡r
(
lua_S‹
 *
L
)

110 
size_t
 
Ën
, 
dËn
, 
esÿ³
;

111 *
p
;

112 *
¤c
, *
d¡
;

114 ià(
	`lua_g‘tİ
(
L
) != 1) {

115  
	`luaL_”rÜ
(
L
, "expecting one‡rgument");

118 
¤c
 = (*è
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

120 ià(
Ën
 == 0) {

121 
d¡
 = (*) "''";

122 
dËn
 = ("''") - 1;

123 
	`lua_pushl¡ršg
(
L
, (*è
d¡
, 
dËn
);

127 
esÿ³
 = 
	`num_esÿ³_sql_¡r
(
NULL
, 
¤c
, 
Ën
);

129 
dËn
 = ("''"è- 1 + 
Ën
 + 
esÿ³
;

130 
p
 = 
	`lua_Ãwu£rd©a
(
L
, 
dËn
);

132 
d¡
 = 
p
;

134 *
p
++ = '\'';

136 ià(
esÿ³
 == 0) {

137 
	`memıy
(
p
, 
¤c
, 
Ën
);

138 
p
+=
Ën
;

140 
p
 = (*è
	`esÿ³_sql_¡r
Õ, 
¤c
, 
Ën
);

143 *
p
++ = '\'';

145 ià(
p
 !ğ
d¡
 + 
dËn
) {

146  
	`luaL_”rÜ
(
L
, "quote sql stringƒrror");

149 
	`lua_pushl¡ršg
(
L
, (*è
d¡
, 
p
 - dst);

152 
	}
}

155 
luaL_Reg
 
	gmysqÏuxlib
[] = {

156 {"quÙe_sql_¡r",
quÙe_sql_¡r
},

157 {
NULL
, NULL}

161 
LUAMOD_API
 
	$luaİ’_skyÃt_mysqÏux_c
 (
lua_S‹
 *
L
) {

162 
	`lua_ÃwbË
(
L
);

163 
	`luaL_£tfuncs
(
L
, 
mysqÏuxlib
, 0);

165 
	}
}

	@lualib-src/lua-netpack.c

1 
	#LUA_LIB


	)

3 
	~"skyÃt_m®loc.h
"

5 
	~"skyÃt_sock‘.h
"

7 
	~<lua.h
>

8 
	~<Ïuxlib.h
>

10 
	~<as£¹.h
>

11 
	~<¡dšt.h
>

12 
	~<¡dlib.h
>

13 
	~<¡ršg.h
>

15 
	#QUEUESIZE
 1024

	)

16 
	#HASHSIZE
 4096

	)

17 
	#SMALLSTRING
 2048

	)

19 
	#TYPE_DATA
 1

	)

20 
	#TYPE_MORE
 2

	)

21 
	#TYPE_ERROR
 3

	)

22 
	#TYPE_OPEN
 4

	)

23 
	#TYPE_CLOSE
 5

	)

24 
	#TYPE_WARNING
 6

	)

30 
	sÃack
 {

31 
	mid
;

32 
	msize
;

33 * 
	mbufãr
;

36 
	suncom¶‘e
 {

37 
Ãack
 
	m·ck
;

38 
uncom¶‘e
 * 
	mÃxt
;

39 
	m»ad
;

40 
	mh—d”
;

43 
	squeue
 {

44 
	mÿp
;

45 
	mh—d
;

46 
	m
;

47 
uncom¶‘e
 * 
	mhash
[
HASHSIZE
];

48 
Ãack
 
	mqueue
[
QUEUESIZE
];

52 
	$ş—r_li¡
(
uncom¶‘e
 * 
uc
) {

53 
uc
) {

54 
	`skyÃt_ä“
(
uc
->
·ck
.
bufãr
);

55 * 
tmp
 = 
uc
;

56 
uc
 = uc->
Ãxt
;

57 
	`skyÃt_ä“
(
tmp
);

59 
	}
}

62 
	$lş—r
(
lua_S‹
 *
L
) {

63 
queue
 * 
q
 = 
	`lua_tou£rd©a
(
L
, 1);

64 ià(
q
 =ğ
NULL
) {

67 
i
;

68 
i
=0;i<
HASHSIZE
;i++) {

69 
	`ş—r_li¡
(
q
->
hash
[
i
]);

70 
q
->
hash
[
i
] = 
NULL
;

72 ià(
q
->
h—d
 > q->

) {

73 
q
->

 +ğq->
ÿp
;

75 
i
=
q
->
h—d
;i<q->

;i++) {

76 
Ãack
 *
Å
 = &
q
->
queue
[
i
 % q->
ÿp
];

77 
	`skyÃt_ä“
(
Å
->
bufãr
);

79 
q
->
h—d
 = q->

 = 0;

82 
	}
}

84 
šlše
 

85 
	$hash_fd
(
fd
) {

86 
a
 = 
fd
 >> 24;

87 
b
 = 
fd
 >> 12;

88 
c
 = 
fd
;

89  ()(((
ušt32_t
)(
a
 + 
b
 + 
c
)è% 
HASHSIZE
);

90 
	}
}

92 
uncom¶‘e
 *

93 
	$fšd_uncom¶‘e
(
queue
 *
q
, 
fd
) {

94 ià(
q
 =ğ
NULL
)

95  
NULL
;

96 
h
 = 
	`hash_fd
(
fd
);

97 
uncom¶‘e
 * 
uc
 = 
q
->
hash
[
h
];

98 ià(
uc
 =ğ
NULL
)

99  
NULL
;

100 ià(
uc
->
·ck
.
id
 =ğ
fd
) {

101 
q
->
hash
[
h
] = 
uc
->
Ãxt
;

102  
uc
;

104 
uncom¶‘e
 * 
Ï¡
 = 
uc
;

105 
Ï¡
->
Ãxt
) {

106 
uc
 = 
Ï¡
->
Ãxt
;

107 ià(
uc
->
·ck
.
id
 =ğ
fd
) {

108 
Ï¡
->
Ãxt
 = 
uc
->next;

109  
uc
;

111 
Ï¡
 = 
uc
;

113  
NULL
;

114 
	}
}

116 
queue
 *

117 
	$g‘_queue
(
lua_S‹
 *
L
) {

118 
queue
 *
q
 = 
	`lua_tou£rd©a
(
L
,1);

119 ià(
q
 =ğ
NULL
) {

120 
q
 = 
	`lua_Ãwu£rd©a
(
L
, (
queue
));

121 
q
->
ÿp
 = 
QUEUESIZE
;

122 
q
->
h—d
 = 0;

123 
q
->

 = 0;

124 
i
;

125 
i
=0;i<
HASHSIZE
;i++) {

126 
q
->
hash
[
i
] = 
NULL
;

128 
	`lua_»¶aû
(
L
, 1);

130  
q
;

131 
	}
}

134 
	$ex·nd_queue
(
lua_S‹
 *
L
, 
queue
 *
q
) {

135 
queue
 *
nq
 = 
	`lua_Ãwu£rd©a
(
L
, (queueè+ 
q
->
ÿp
 * (
Ãack
));

136 
nq
->
ÿp
 = 
q
->ÿ°+ 
QUEUESIZE
;

137 
nq
->
h—d
 = 0;

138 
nq
->

 = 
q
->
ÿp
;

139 
	`memıy
(
nq
->
hash
, 
q
->hash, (nq->hash));

140 
	`mem£t
(
q
->
hash
, 0, (q->hash));

141 
i
;

142 
i
=0;i<
q
->
ÿp
;i++) {

143 
idx
 = (
q
->
h—d
 + 
i
è% q->
ÿp
;

144 
nq
->
queue
[
i
] = 
q
->queue[
idx
];

146 
q
->
h—d
 = q->

 = 0;

147 
	`lua_»¶aû
(
L
,1);

148 
	}
}

151 
	$push_d©a
(
lua_S‹
 *
L
, 
fd
, *
bufãr
, 
size
, 
şÚe
) {

152 ià(
şÚe
) {

153 * 
tmp
 = 
	`skyÃt_m®loc
(
size
);

154 
	`memıy
(
tmp
, 
bufãr
, 
size
);

155 
bufãr
 = 
tmp
;

157 
queue
 *
q
 = 
	`g‘_queue
(
L
);

158 
Ãack
 *
Å
 = &
q
->
queue
[q->

];

159 ià(++
q
->

 >ğq->
ÿp
)

160 
q
->

 -ğq->
ÿp
;

161 
Å
->
id
 = 
fd
;

162 
Å
->
bufãr
 = buffer;

163 
Å
->
size
 = size;

164 ià(
q
->
h—d
 =ğq->

) {

165 
	`ex·nd_queue
(
L
, 
q
);

167 
	}
}

169 
uncom¶‘e
 *

170 
	$§ve_uncom¶‘e
(
lua_S‹
 *
L
, 
fd
) {

171 
queue
 *
q
 = 
	`g‘_queue
(
L
);

172 
h
 = 
	`hash_fd
(
fd
);

173 
uncom¶‘e
 * 
uc
 = 
	`skyÃt_m®loc
((uncomplete));

174 
	`mem£t
(
uc
, 0, (*uc));

175 
uc
->
Ãxt
 = 
q
->
hash
[
h
];

176 
uc
->
·ck
.
id
 = 
fd
;

177 
q
->
hash
[
h
] = 
uc
;

179  
uc
;

180 
	}
}

182 
šlše
 

183 
	$»ad_size
(
ušt8_t
 * 
bufãr
) {

184 
r
 = ()
bufãr
[0] << 8 | ()buffer[1];

185  
r
;

186 
	}
}

189 
	$push_mÜe
(
lua_S‹
 *
L
, 
fd
, 
ušt8_t
 *
bufãr
, 
size
) {

190 ià(
size
 == 1) {

191 
uncom¶‘e
 * 
uc
 = 
	`§ve_uncom¶‘e
(
L
, 
fd
);

192 
uc
->
»ad
 = -1;

193 
uc
->
h—d”
 = *
bufãr
;

196 
·ck_size
 = 
	`»ad_size
(
bufãr
);

197 
bufãr
 += 2;

198 
size
 -= 2;

200 ià(
size
 < 
·ck_size
) {

201 
uncom¶‘e
 * 
uc
 = 
	`§ve_uncom¶‘e
(
L
, 
fd
);

202 
uc
->
»ad
 = 
size
;

203 
uc
->
·ck
.
size
 = 
·ck_size
;

204 
uc
->
·ck
.
bufãr
 = 
	`skyÃt_m®loc
(
·ck_size
);

205 
	`memıy
(
uc
->
·ck
.
bufãr
, bufãr, 
size
);

208 
	`push_d©a
(
L
, 
fd
, 
bufãr
, 
·ck_size
, 1);

210 
bufãr
 +ğ
·ck_size
;

211 
size
 -ğ
·ck_size
;

212 ià(
size
 > 0) {

213 
	`push_mÜe
(
L
, 
fd
, 
bufãr
, 
size
);

215 
	}
}

218 
	$şo£_uncom¶‘e
(
lua_S‹
 *
L
, 
fd
) {

219 
queue
 *
q
 = 
	`lua_tou£rd©a
(
L
,1);

220 
uncom¶‘e
 * 
uc
 = 
	`fšd_uncom¶‘e
(
q
, 
fd
);

221 ià(
uc
) {

222 
	`skyÃt_ä“
(
uc
->
·ck
.
bufãr
);

223 
	`skyÃt_ä“
(
uc
);

225 
	}
}

228 
	$f‹r_d©a_
(
lua_S‹
 *
L
, 
fd
, 
ušt8_t
 * 
bufãr
, 
size
) {

229 
queue
 *
q
 = 
	`lua_tou£rd©a
(
L
,1);

230 
uncom¶‘e
 * 
uc
 = 
	`fšd_uncom¶‘e
(
q
, 
fd
);

231 ià(
uc
) {

233 ià(
uc
->
»ad
 < 0) {

235 
	`as£¹
(
uc
->
»ad
 == -1);

236 
·ck_size
 = *
bufãr
;

237 
·ck_size
 |ğ
uc
->
h—d”
 << 8 ;

238 ++
bufãr
;

239 --
size
;

240 
uc
->
·ck
.
size
 = 
·ck_size
;

241 
uc
->
·ck
.
bufãr
 = 
	`skyÃt_m®loc
(
·ck_size
);

242 
uc
->
»ad
 = 0;

244 
Ãed
 = 
uc
->
·ck
.
size
 - uc->
»ad
;

245 ià(
size
 < 
Ãed
) {

246 
	`memıy
(
uc
->
·ck
.
bufãr
 + uc->
»ad
, bufãr, 
size
);

247 
uc
->
»ad
 +ğ
size
;

248 
h
 = 
	`hash_fd
(
fd
);

249 
uc
->
Ãxt
 = 
q
->
hash
[
h
];

250 
q
->
hash
[
h
] = 
uc
;

253 
	`memıy
(
uc
->
·ck
.
bufãr
 + uc->
»ad
, bufãr, 
Ãed
);

254 
bufãr
 +ğ
Ãed
;

255 
size
 -ğ
Ãed
;

256 ià(
size
 == 0) {

257 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_DATA
));

258 
	`lua_pushš‹g”
(
L
, 
fd
);

259 
	`lua_pushlightu£rd©a
(
L
, 
uc
->
·ck
.
bufãr
);

260 
	`lua_pushš‹g”
(
L
, 
uc
->
·ck
.
size
);

261 
	`skyÃt_ä“
(
uc
);

265 
	`push_d©a
(
L
, 
fd
, 
uc
->
·ck
.
bufãr
, uc->·ck.
size
, 0);

266 
	`skyÃt_ä“
(
uc
);

267 
	`push_mÜe
(
L
, 
fd
, 
bufãr
, 
size
);

268 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_MORE
));

271 ià(
size
 == 1) {

272 
uncom¶‘e
 * 
uc
 = 
	`§ve_uncom¶‘e
(
L
, 
fd
);

273 
uc
->
»ad
 = -1;

274 
uc
->
h—d”
 = *
bufãr
;

277 
·ck_size
 = 
	`»ad_size
(
bufãr
);

278 
bufãr
+=2;

279 
size
-=2;

281 ià(
size
 < 
·ck_size
) {

282 
uncom¶‘e
 * 
uc
 = 
	`§ve_uncom¶‘e
(
L
, 
fd
);

283 
uc
->
»ad
 = 
size
;

284 
uc
->
·ck
.
size
 = 
·ck_size
;

285 
uc
->
·ck
.
bufãr
 = 
	`skyÃt_m®loc
(
·ck_size
);

286 
	`memıy
(
uc
->
·ck
.
bufãr
, bufãr, 
size
);

289 ià(
size
 =ğ
·ck_size
) {

291 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_DATA
));

292 
	`lua_pushš‹g”
(
L
, 
fd
);

293 * 
»suÉ
 = 
	`skyÃt_m®loc
(
·ck_size
);

294 
	`memıy
(
»suÉ
, 
bufãr
, 
size
);

295 
	`lua_pushlightu£rd©a
(
L
, 
»suÉ
);

296 
	`lua_pushš‹g”
(
L
, 
size
);

300 
	`push_d©a
(
L
, 
fd
, 
bufãr
, 
·ck_size
, 1);

301 
bufãr
 +ğ
·ck_size
;

302 
size
 -ğ
·ck_size
;

303 
	`push_mÜe
(
L
, 
fd
, 
bufãr
, 
size
);

304 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_MORE
));

307 
	}
}

309 
šlše
 

310 
	$f‹r_d©a
(
lua_S‹
 *
L
, 
fd
, 
ušt8_t
 * 
bufãr
, 
size
) {

311 
»t
 = 
	`f‹r_d©a_
(
L
, 
fd
, 
bufãr
, 
size
);

314 
	`skyÃt_ä“
(
bufãr
);

315  
»t
;

316 
	}
}

319 
	$push¡ršg
(
lua_S‹
 *
L
, cÚ¡ * 
msg
, 
size
) {

320 ià(
msg
) {

321 
	`lua_pushl¡ršg
(
L
, 
msg
, 
size
);

323 
	`lua_pushl™”®
(
L
, "");

325 
	}
}

338 
	$lf‹r
(
lua_S‹
 *
L
) {

339 
skyÃt_sock‘_mes§ge
 *
mes§ge
 = 
	`lua_tou£rd©a
(
L
,2);

340 
size
 = 
	`luaL_checkš‹g”
(
L
,3);

341 * 
bufãr
 = 
mes§ge
->buffer;

342 ià(
bufãr
 =ğ
NULL
) {

343 
bufãr
 = (*)(
mes§ge
+1);

344 
size
 -ğ(*
mes§ge
);

346 
size
 = -1;

349 
	`lua_£‰İ
(
L
, 1);

351 
mes§ge
->
ty³
) {

352 
SKYNET_SOCKET_TYPE_DATA
:

354 
	`as£¹
(
size
 == -1);

355  
	`f‹r_d©a
(
L
, 
mes§ge
->
id
, (
ušt8_t
 *)
bufãr
, mes§ge->
ud
);

356 
SKYNET_SOCKET_TYPE_CONNECT
:

359 
SKYNET_SOCKET_TYPE_CLOSE
:

361 
	`şo£_uncom¶‘e
(
L
, 
mes§ge
->
id
);

362 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_CLOSE
));

363 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
id
);

365 
SKYNET_SOCKET_TYPE_ACCEPT
:

366 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_OPEN
));

368 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
ud
);

369 
	`push¡ršg
(
L
, 
bufãr
, 
size
);

371 
SKYNET_SOCKET_TYPE_ERROR
:

373 
	`şo£_uncom¶‘e
(
L
, 
mes§ge
->
id
);

374 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_ERROR
));

375 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
id
);

376 
	`push¡ršg
(
L
, 
bufãr
, 
size
);

378 
SKYNET_SOCKET_TYPE_WARNING
:

379 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(
TYPE_WARNING
));

380 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
id
);

381 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
ud
);

387 
	}
}

397 
	$Íİ
(
lua_S‹
 *
L
) {

398 
queue
 * 
q
 = 
	`lua_tou£rd©a
(
L
, 1);

399 ià(
q
 =ğ
NULL
 || q->
h—d
 =ğq->

)

401 
Ãack
 *
Å
 = &
q
->
queue
[q->
h—d
];

402 ià(++
q
->
h—d
 >ğq->
ÿp
) {

403 
q
->
h—d
 = 0;

405 
	`lua_pushš‹g”
(
L
, 
Å
->
id
);

406 
	`lua_pushlightu£rd©a
(
L
, 
Å
->
bufãr
);

407 
	`lua_pushš‹g”
(
L
, 
Å
->
size
);

410 
	}
}

419 
	$tŞ¡ršg
(
lua_S‹
 *
L
, 
size_t
 *
sz
, 
šdex
) {

420 cÚ¡ * 
±r
;

421 ià(
	`lua_isu£rd©a
(
L
,
šdex
)) {

422 
±r
 = (cÚ¡ *)
	`lua_tou£rd©a
(
L
,
šdex
);

423 *
sz
 = (
size_t
)
	`luaL_checkš‹g”
(
L
, 
šdex
+1);

425 
±r
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, 
sz
);

427  
±r
;

428 
	}
}

430 
šlše
 

431 
	$wr™e_size
(
ušt8_t
 * 
bufãr
, 
Ën
) {

432 
bufãr
[0] = (
Ën
 >> 8) & 0xff;

433 
bufãr
[1] = 
Ën
 & 0xff;

434 
	}
}

437 
	$Íack
(
lua_S‹
 *
L
) {

438 
size_t
 
Ën
;

439 cÚ¡ * 
±r
 = 
	`tŞ¡ršg
(
L
, &
Ën
, 1);

440 ià(
Ën
 >= 0x10000) {

441  
	`luaL_”rÜ
(
L
, "Inv®id sizÑoØlÚgèoàd©¨: %d", ()
Ën
);

444 
ušt8_t
 * 
bufãr
 = 
	`skyÃt_m®loc
(
Ën
 + 2);

445 
	`wr™e_size
(
bufãr
, 
Ën
);

446 
	`memıy
(
bufãr
+2, 
±r
, 
Ën
);

448 
	`lua_pushlightu£rd©a
(
L
, 
bufãr
);

449 
	`lua_pushš‹g”
(
L
, 
Ën
 + 2);

452 
	}
}

455 
	$Éo¡ršg
(
lua_S‹
 *
L
) {

456 * 
±r
 = 
	`lua_tou£rd©a
(
L
, 1);

457 
size
 = 
	`luaL_checkš‹g”
(
L
, 2);

458 ià(
±r
 =ğ
NULL
) {

459 
	`lua_pushl™”®
(
L
, "");

461 
	`lua_pushl¡ršg
(
L
, (cÚ¡ *)
±r
, 
size
);

462 
	`skyÃt_ä“
(
±r
);

465 
	}
}

467 
LUAMOD_API
 

468 
	$luaİ’_skyÃt_Ãack
(
lua_S‹
 *
L
) {

469 
	`luaL_checkv”siÚ
(
L
);

470 
luaL_Reg
 
l
[] = {

471 { "pİ", 
Íİ
 },

472 { "·ck", 
Íack
 },

473 { "ş—r", 
lş—r
 },

474 { "to¡ršg", 
Éo¡ršg
 },

475 { 
NULL
, NULL },

477 
	`luaL_Ãwlib
(
L
,
l
);

480 
	`lua_pushl™”®
(
L
, "data");

481 
	`lua_pushl™”®
(
L
, "more");

482 
	`lua_pushl™”®
(
L
, "error");

483 
	`lua_pushl™”®
(
L
, "open");

484 
	`lua_pushl™”®
(
L
, "close");

485 
	`lua_pushl™”®
(
L
, "warning");

487 
	`lua_pushcşosu»
(
L
, 
lf‹r
, 6);

488 
	`lua_£tf›ld
(
L
, -2, "filter");

491 
	}
}

	@lualib-src/lua-profile.c

1 
	#LUA_LIB


	)

3 
	~<¡dio.h
>

4 
	~<lua.h
>

5 
	~<Ïuxlib.h
>

7 
	~<time.h
>

9 #ià
defšed
(
__APPLE__
)

10 
	~<mach/sk.h
>

11 
	~<mach/mach.h
>

14 
	#NANOSEC
 1000000000

	)

15 
	#MICROSEC
 1000000

	)

20 
	$g‘_time
() {

21 #ià !
	`defšed
(
__APPLE__
)

22 
time¥ec
 
ti
;

23 
	`şock_g‘time
(
CLOCK_THREAD_CPUTIME_ID
, &
ti
);

25 
£c
 = 
ti
.
tv_£c
 & 0xffff;

26 
n£c
 = 
ti
.
tv_n£c
;

28  ()
£c
 + ()
n£c
 / 
NANOSEC
;

30 
sk_th»ad_times_šfo
 
aTaskInfo
;

31 
mach_msg_ty³_numb”_t
 
aTaskInfoCouÁ
 = 
TASK_THREAD_TIMES_INFO_COUNT
;

32 ià(
KERN_SUCCESS
 !ğ
	`sk_šfo
(
	`mach_sk_£lf
(), 
TASK_THREAD_TIMES_INFO
, (
sk_šfo_t
 )&
aTaskInfo
, &
aTaskInfoCouÁ
)) {

36 
£c
 = 
aTaskInfo
.
u£r_time
.
£cÚds
 & 0xffff;

37 
m£c
 = 
aTaskInfo
.
u£r_time
.
miüo£cÚds
;

39  ()
£c
 + ()
m£c
 / 
MICROSEC
;

41 
	}
}

43 
šlše
 

44 
	$diff_time
(
¡¬t
) {

45 
now
 = 
	`g‘_time
();

46 ià(
now
 < 
¡¬t
) {

47  
now
 + 0x10000 - 
¡¬t
;

49  
now
 - 
¡¬t
;

51 
	}
}

54 
	$l¡¬t
(
lua_S‹
 *
L
) {

55 ià(
	`lua_g‘tİ
(
L
) != 0) {

56 
	`lua_£‰İ
(
L
,1);

57 
	`luaL_checkty³
(
L
, 1, 
LUA_TTHREAD
);

59 
	`lua_pushth»ad
(
L
);

61 
	`lua_pushv®ue
(
L
, 1);

62 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(2));

63 ià(!
	`lua_i¢
(
L
, -1)) {

64  
	`luaL_”rÜ
(
L
, "Th»ad %°¡¬ˆ´ofmÜthª onû", 
	`lua_tİoš‹r
(L, 1));

66 
	`lua_pushv®ue
(
L
, 1);

67 
	`lua_pushnumb”
(
L
, 0);

68 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(2));

70 
	`lua_pushv®ue
(
L
, 1);

71 
ti
 = 
	`g‘_time
();

72 #ifdeà
DEBUG_LOG


73 
	`årštf
(
¡d”r
, "PROFILE [%p] s¹\n", 
L
);

75 
	`lua_pushnumb”
(
L
, 
ti
);

76 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(1));

79 
	}
}

82 
	$l¡İ
(
lua_S‹
 *
L
) {

83 ià(
	`lua_g‘tİ
(
L
) != 0) {

84 
	`lua_£‰İ
(
L
,1);

85 
	`luaL_checkty³
(
L
, 1, 
LUA_TTHREAD
);

87 
	`lua_pushth»ad
(
L
);

89 
	`lua_pushv®ue
(
L
, 1);

90 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(1));

91 ià(
	`lua_ty³
(
L
, -1è!ğ
LUA_TNUMBER
) {

92  
	`luaL_”rÜ
(
L
, "Call…rofile.start() before…rofile.stop()");

94 
ti
 = 
	`diff_time
(
	`lua_tÚumb”
(
L
, -1));

95 
	`lua_pushv®ue
(
L
, 1);

96 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(2));

97 
tÙ®_time
 = 
	`lua_tÚumb”
(
L
, -1);

99 
	`lua_pushv®ue
(
L
, 1);

100 
	`lua_pushn
(
L
);

101 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(1));

103 
	`lua_pushv®ue
(
L
, 1);

104 
	`lua_pushn
(
L
);

105 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(2));

107 
tÙ®_time
 +ğ
ti
;

108 
	`lua_pushnumb”
(
L
, 
tÙ®_time
);

109 #ifdeà
DEBUG_LOG


110 
	`årštf
(
¡d”r
, "PROFILE [%p] stİ (%lf/%lf)\n", 
	`lua_tÙh»ad
(
L
,1), 
ti
, 
tÙ®_time
);

114 
	}
}

117 
	$timšg_»sume
(
lua_S‹
 *
L
) {

118 
	`lua_pushv®ue
(
L
, -1);

119 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(2));

120 ià(
	`lua_i¢
(
L
, -1)) {

121 
	`lua_pİ
(
L
,2);

123 
	`lua_pİ
(
L
,1);

124 
ti
 = 
	`g‘_time
();

125 #ifdeà
DEBUG_LOG


126 
	`årštf
(
¡d”r
, "PROFILE [%p]„esum%lf\n", 
	`lua_tÙh»ad
(
L
, -1), 
ti
);

128 
	`lua_pushnumb”
(
L
, 
ti
);

129 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(1));

132 
lua_CFunùiÚ
 
co_»sume
 = 
	`lua_tocfunùiÚ
(
L
, 
	`lua_upv®uešdex
(3));

134  
	`co_»sume
(
L
);

135 
	}
}

138 
	$Ìesume
(
lua_S‹
 *
L
) {

139 
	`lua_pushv®ue
(
L
,1);

141  
	`timšg_»sume
(
L
);

142 
	}
}

145 
	$Ìesume_co
(
lua_S‹
 *
L
) {

146 
	`luaL_checkty³
(
L
, 2, 
LUA_TTHREAD
);

147 
	`lua_rÙ©e
(
L
, 2, -1);

149  
	`timšg_»sume
(
L
);

150 
	}
}

153 
	$timšg_y›ld
(
lua_S‹
 *
L
) {

154 #ifdeà
DEBUG_LOG


155 
lua_S‹
 *
äom
 = 
	`lua_tÙh»ad
(
L
, -1);

157 
	`lua_pushv®ue
(
L
, -1);

158 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(2));

159 ià(
	`lua_i¢
(
L
, -1)) {

160 
	`lua_pİ
(
L
,2);

162 
ti
 = 
	`lua_tÚumb”
(
L
, -1);

163 
	`lua_pİ
(
L
,1);

165 
	`lua_pushv®ue
(
L
, -1);

166 
	`lua_¿wg‘
(
L
, 
	`lua_upv®uešdex
(1));

167 
¡¬‰ime
 = 
	`lua_tÚumb”
(
L
, -1);

168 
	`lua_pİ
(
L
,1);

170 
diff
 = 
	`diff_time
(
¡¬‰ime
);

171 
ti
 +ğ
diff
;

172 #ifdeà
DEBUG_LOG


173 
	`årštf
(
¡d”r
, "PROFILE [%p] y›ld (%lf/%lf)\n", 
äom
, 
diff
, 
ti
);

176 
	`lua_pushv®ue
(
L
, -1);

177 
	`lua_pushnumb”
(
L
, 
ti
);

178 
	`lua_¿w£t
(
L
, 
	`lua_upv®uešdex
(2));

179 
	`lua_pİ
(
L
, 1);

182 
lua_CFunùiÚ
 
co_y›ld
 = 
	`lua_tocfunùiÚ
(
L
, 
	`lua_upv®uešdex
(3));

184  
	`co_y›ld
(
L
);

185 
	}
}

188 
	$ly›ld
(
lua_S‹
 *
L
) {

189 
	`lua_pushth»ad
(
L
);

191  
	`timšg_y›ld
(
L
);

192 
	}
}

195 
	$ly›ld_co
(
lua_S‹
 *
L
) {

196 
	`luaL_checkty³
(
L
, 1, 
LUA_TTHREAD
);

197 
	`lua_rÙ©e
(
L
, 1, -1);

199  
	`timšg_y›ld
(
L
);

200 
	}
}

202 
LUAMOD_API
 

203 
	$luaİ’_skyÃt_´ofe
(
lua_S‹
 *
L
) {

204 
	`luaL_checkv”siÚ
(
L
);

205 
luaL_Reg
 
l
[] = {

206 { "¡¬t", 
l¡¬t
 },

207 { "¡İ", 
l¡İ
 },

208 { "»sume", 
Ìesume
 },

209 { "y›ld", 
ly›ld
 },

210 { "»sume_co", 
Ìesume_co
 },

211 { "y›ld_co", 
ly›ld_co
 },

212 { 
NULL
, NULL },

214 
	`luaL_ÃwlibbË
(
L
,
l
);

215 
	`lua_ÃwbË
(
L
);

216 
	`lua_ÃwbË
(
L
);

218 
	`lua_ÃwbË
(
L
);

219 
	`lua_pushl™”®
(
L
, "kv");

220 
	`lua_£tf›ld
(
L
, -2, "__mode");

222 
	`lua_pushv®ue
(
L
, -1);

223 
	`lua_£tm‘©abË
(
L
, -3);

224 
	`lua_£tm‘©abË
(
L
, -3);

226 
	`lua_pushn
(
L
);

227 
	`luaL_£tfuncs
(
L
,
l
,3);

229 
libbË
 = 
	`lua_g‘tİ
(
L
);

231 
	`lua_g‘glob®
(
L
, "coroutine");

232 
	`lua_g‘f›ld
(
L
, -1, "resume");

234 
lua_CFunùiÚ
 
co_»sume
 = 
	`lua_tocfunùiÚ
(
L
, -1);

235 ià(
co_»sume
 =ğ
NULL
)

236  
	`luaL_”rÜ
(
L
, "Can't get coroutine.resume");

237 
	`lua_pİ
(
L
,1);

239 
	`lua_g‘f›ld
(
L
, 
libbË
, "resume");

240 
	`lua_pushcfunùiÚ
(
L
, 
co_»sume
);

241 
	`lua_£tupv®ue
(
L
, -2, 3);

242 
	`lua_pİ
(
L
,1);

244 
	`lua_g‘f›ld
(
L
, 
libbË
, "resume_co");

245 
	`lua_pushcfunùiÚ
(
L
, 
co_»sume
);

246 
	`lua_£tupv®ue
(
L
, -2, 3);

247 
	`lua_pİ
(
L
,1);

249 
	`lua_g‘f›ld
(
L
, -1, "yield");

251 
lua_CFunùiÚ
 
co_y›ld
 = 
	`lua_tocfunùiÚ
(
L
, -1);

252 ià(
co_y›ld
 =ğ
NULL
)

253  
	`luaL_”rÜ
(
L
, "Can't get coroutine.yield");

254 
	`lua_pİ
(
L
,1);

256 
	`lua_g‘f›ld
(
L
, 
libbË
, "yield");

257 
	`lua_pushcfunùiÚ
(
L
, 
co_y›ld
);

258 
	`lua_£tupv®ue
(
L
, -2, 3);

259 
	`lua_pİ
(
L
,1);

261 
	`lua_g‘f›ld
(
L
, 
libbË
, "yield_co");

262 
	`lua_pushcfunùiÚ
(
L
, 
co_y›ld
);

263 
	`lua_£tupv®ue
(
L
, -2, 3);

264 
	`lua_pİ
(
L
,1);

266 
	`lua_£‰İ
(
L
, 
libbË
);

269 
	}
}

	@lualib-src/lua-randseq.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

6 
	~<¡dlib.h
>

8 
	sRªdomSeq
{

9 
	mm_šdex
;

10 
	mm_š‹rmedŸ‹Off£t
;

13 
	$³rmu‹QPR
(
x
){

14 cÚ¡ 
´ime
 = 4294967291u;

15 ià(
x
 >ğ
´ime
)

16  
x
;

17 
»sidue
 = ((è
x
 * xè% 
´ime
;

18  (
x
 <ğ
´ime
 / 2è? 
»sidue
 :…rime -„esidue;

19 
	}
}

21 
RªdomSeq
* 
	$ü—‹RªdomSeq
(
£edBa£
,
£edOff£t
){

22 
RªdomSeq
 *
»t
 = 
	`m®loc
((RandomSeq));

23 
»t
->
m_šdex
 = 
	`³rmu‹QPR
Õ”mu‹QPR(
£edBa£
) + 0x682f0161);

24 
»t
->
m_š‹rmedŸ‹Off£t
 = 
	`³rmu‹QPR
Õ”mu‹QPR(
£edOff£t
) + 0x46790905);

25  
»t
;

26 
	}
}

28 
	$Ãxt
(
RªdomSeq
* 
rs
){

29  
	`³rmu‹QPR
(Õ”mu‹QPR(
rs
->
m_šdex
++è+„s->
m_š‹rmedŸ‹Off£t
) & 0x5bf03635);

30 
	}
}

32 
	$de¡ÜyRªdomSeq
(
RªdomSeq
* 
rs
){

33 
	`ä“
(
rs
);

34 
	}
}

37 
	$lü—‹
(
lua_S‹
 *
L
){

38 
sb
 = 
	`luaL_checkš‹g”
(
L
,1);

39 
so
 = 
	`luaL_checkš‹g”
(
L
,2);

40 
RªdomSeq
* 
»t
 = 
	`ü—‹RªdomSeq
(
sb
,
so
);

41 
	`lua_pushlightu£rd©a
(
L
,
»t
);

43 
	}
}

46 
	$lde¡Üy
(
lua_S‹
 *
L
){

47 
RªdomSeq
 *
rs
 = 
	`lua_tou£rd©a
(
L
,1);

48 
	`de¡ÜyRªdomSeq
(
rs
);

49 
rs
 = 
NULL
;

51 
	}
}

54 
	$Êext
(
lua_S‹
 *
L
){

55 
RªdomSeq
 *
rs
 = 
	`lua_tou£rd©a
(
L
,1);

56 
ÃxtUšt
 = 
	`Ãxt
(
rs
);

57 
	`lua_pushš‹g”
(
L
,
ÃxtUšt
);

59 
	}
}

61 
LUAMOD_API
 

62 
	$luaİ’_¿nd£q
(
lua_S‹
 *
L
) {

63 
	`luaL_checkv”siÚ
(
L
);

64 
luaL_Reg
 
l
[] = {

65 { "ü—‹", 
lü—‹
},

66 { "de¡Üy", 
lde¡Üy
},

67 { "ÃxtIÁ", 
Êext
},

68 { 
NULL
, NULL },

71 
	`luaL_Ãwlib
(
L
,
l
);

74 
	}
}

	@lualib-src/lua-seri.c

5 
	#LUA_LIB


	)

7 
	~"skyÃt_m®loc.h
"

9 
	~<lua.h
>

10 
	~<Ïuxlib.h
>

11 
	~<¡dlib.h
>

12 
	~<¡dšt.h
>

13 
	~<as£¹.h
>

14 
	~<¡ršg.h
>

16 
	#TYPE_NIL
 0

	)

17 
	#TYPE_BOOLEAN
 1

	)

19 
	#TYPE_NUMBER
 2

	)

21 
	#TYPE_NUMBER_ZERO
 0

	)

22 
	#TYPE_NUMBER_BYTE
 1

	)

23 
	#TYPE_NUMBER_WORD
 2

	)

24 
	#TYPE_NUMBER_DWORD
 4

	)

25 
	#TYPE_NUMBER_QWORD
 6

	)

26 
	#TYPE_NUMBER_REAL
 8

	)

28 
	#TYPE_USERDATA
 3

	)

29 
	#TYPE_SHORT_STRING
 4

	)

31 
	#TYPE_LONG_STRING
 5

	)

32 
	#TYPE_TABLE
 6

	)

34 
	#MAX_COOKIE
 32

	)

35 
	#COMBINE_TYPE
(
t
,
v
è(Ñè| (vè<< 3)

	)

37 
	#BLOCK_SIZE
 128

	)

38 
	#MAX_DEPTH
 32

	)

40 
	sblock
 {

41 
block
 * 
	mÃxt
;

42 
	mbufãr
[
BLOCK_SIZE
];

45 
	swr™e_block
 {

46 
block
 * 
	mh—d
;

47 
block
 * 
	mcu¼’t
;

48 
	mËn
;

49 
	m±r
;

52 
	s»ad_block
 {

53 * 
	mbufãr
;

54 
	mËn
;

55 
	m±r
;

58 
šlše
 
block
 *

59 
	$blk_®loc
() {

60 
block
 *
b
 = 
	`skyÃt_m®loc
((block));

61 
b
->
Ãxt
 = 
NULL
;

62  
b
;

63 
	}
}

65 
šlše
 

66 
	$wb_push
(
wr™e_block
 *
b
, cÚ¡ *
buf
, 
sz
) {

67 cÚ¡ * 
bufãr
 = 
buf
;

68 ià(
b
->
±r
 =ğ
BLOCK_SIZE
) {

69 
_agaš
:

70 
b
->
cu¼’t
 = b->cu¼’t->
Ãxt
 = 
	`blk_®loc
();

71 
b
->
±r
 = 0;

73 ià(
b
->
±r
 <ğ
BLOCK_SIZE
 - 
sz
) {

74 
	`memıy
(
b
->
cu¼’t
->
bufãr
 + b->
±r
, bufãr, 
sz
);

75 
b
->
±r
+=
sz
;

76 
b
->
Ën
+=
sz
;

78 
cİy
 = 
BLOCK_SIZE
 - 
b
->
±r
;

79 
	`memıy
(
b
->
cu¼’t
->
bufãr
 + b->
±r
, bufãr, 
cİy
);

80 
bufãr
 +ğ
cİy
;

81 
b
->
Ën
 +ğ
cİy
;

82 
sz
 -ğ
cİy
;

83 
_agaš
;

85 
	}
}

88 
	$wb_š™
(
wr™e_block
 *
wb
 , 
block
 *
b
) {

89 
wb
->
h—d
 = 
b
;

90 
	`as£¹
(
b
->
Ãxt
 =ğ
NULL
);

91 
wb
->
Ën
 = 0;

92 
wb
->
cu¼’t
 = wb->
h—d
;

93 
wb
->
±r
 = 0;

94 
	}
}

97 
	$wb_ä“
(
wr™e_block
 *
wb
) {

98 
block
 *
blk
 = 
wb
->
h—d
;

99 
blk
 = blk->
Ãxt
;

100 
blk
) {

101 
block
 * 
Ãxt
 = 
blk
->next;

102 
	`skyÃt_ä“
(
blk
);

103 
blk
 = 
Ãxt
;

105 
wb
->
h—d
 = 
NULL
;

106 
wb
->
cu¼’t
 = 
NULL
;

107 
wb
->
±r
 = 0;

108 
wb
->
Ën
 = 0;

109 
	}
}

112 
	$rb®l_š™
(
»ad_block
 * 
rb
, * 
bufãr
, 
size
) {

113 
rb
->
bufãr
 = buffer;

114 
rb
->
Ën
 = 
size
;

115 
rb
->
±r
 = 0;

116 
	}
}

119 
	$rb_»ad
(
»ad_block
 *
rb
, 
sz
) {

120 ià(
rb
->
Ën
 < 
sz
) {

121  
NULL
;

124 
±r
 = 
rb
->ptr;

125 
rb
->
±r
 +ğ
sz
;

126 
rb
->
Ën
 -ğ
sz
;

127  
rb
->
bufãr
 + 
±r
;

128 
	}
}

130 
šlše
 

131 
	$wb_n
(
wr™e_block
 *
wb
) {

132 
ušt8_t
 
n
 = 
TYPE_NIL
;

133 
	`wb_push
(
wb
, &
n
, 1);

134 
	}
}

136 
šlše
 

137 
	$wb_boŞ—n
(
wr™e_block
 *
wb
, 
boŞ—n
) {

138 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
TYPE_BOOLEAN
 , 
boŞ—n
 ? 1 : 0);

139 
	`wb_push
(
wb
, &
n
, 1);

140 
	}
}

142 
šlše
 

143 
	$wb_š‹g”
(
wr™e_block
 *
wb
, 
lua_IÁeg”
 
v
) {

144 
ty³
 = 
TYPE_NUMBER
;

145 ià(
v
 == 0) {

146 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
ty³
 , 
TYPE_NUMBER_ZERO
);

147 
	`wb_push
(
wb
, &
n
, 1);

148 } ià(
v
 !ğ(
št32_t
)v) {

149 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
ty³
 , 
TYPE_NUMBER_QWORD
);

150 
št64_t
 
v64
 = 
v
;

151 
	`wb_push
(
wb
, &
n
, 1);

152 
	`wb_push
(
wb
, &
v64
, (v64));

153 } ià(
v
 < 0) {

154 
št32_t
 
v32
 = (št32_t)
v
;

155 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
ty³
 , 
TYPE_NUMBER_DWORD
);

156 
	`wb_push
(
wb
, &
n
, 1);

157 
	`wb_push
(
wb
, &
v32
, (v32));

158 } ià(
v
<0x100) {

159 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
ty³
 , 
TYPE_NUMBER_BYTE
);

160 
	`wb_push
(
wb
, &
n
, 1);

161 
ušt8_t
 
by‹
 = (ušt8_t)
v
;

162 
	`wb_push
(
wb
, &
by‹
, (byte));

163 } ià(
v
<0x10000) {

164 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
ty³
 , 
TYPE_NUMBER_WORD
);

165 
	`wb_push
(
wb
, &
n
, 1);

166 
ušt16_t
 
wÜd
 = (ušt16_t)
v
;

167 
	`wb_push
(
wb
, &
wÜd
, (word));

169 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
ty³
 , 
TYPE_NUMBER_DWORD
);

170 
	`wb_push
(
wb
, &
n
, 1);

171 
ušt32_t
 
v32
 = (ušt32_t)
v
;

172 
	`wb_push
(
wb
, &
v32
, (v32));

174 
	}
}

176 
šlše
 

177 
	$wb_»®
(
wr™e_block
 *
wb
, 
v
) {

178 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
TYPE_NUMBER
 , 
TYPE_NUMBER_REAL
);

179 
	`wb_push
(
wb
, &
n
, 1);

180 
	`wb_push
(
wb
, &
v
, (v));

181 
	}
}

183 
šlše
 

184 
	$wb_poš‹r
(
wr™e_block
 *
wb
, *
v
) {

185 
ušt8_t
 
n
 = 
TYPE_USERDATA
;

186 
	`wb_push
(
wb
, &
n
, 1);

187 
	`wb_push
(
wb
, &
v
, (v));

188 
	}
}

190 
šlše
 

191 
	$wb_¡ršg
(
wr™e_block
 *
wb
, cÚ¡ *
¡r
, 
Ën
) {

192 ià(
Ën
 < 
MAX_COOKIE
) {

193 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
TYPE_SHORT_STRING
, 
Ën
);

194 
	`wb_push
(
wb
, &
n
, 1);

195 ià(
Ën
 > 0) {

196 
	`wb_push
(
wb
, 
¡r
, 
Ën
);

199 
ušt8_t
 
n
;

200 ià(
Ën
 < 0x10000) {

201 
n
 = 
	`COMBINE_TYPE
(
TYPE_LONG_STRING
, 2);

202 
	`wb_push
(
wb
, &
n
, 1);

203 
ušt16_t
 
x
 = (ušt16_tè
Ën
;

204 
	`wb_push
(
wb
, &
x
, 2);

206 
n
 = 
	`COMBINE_TYPE
(
TYPE_LONG_STRING
, 4);

207 
	`wb_push
(
wb
, &
n
, 1);

208 
ušt32_t
 
x
 = (ušt32_tè
Ën
;

209 
	`wb_push
(
wb
, &
x
, 4);

211 
	`wb_push
(
wb
, 
¡r
, 
Ën
);

213 
	}
}

215 
·ck_Úe
(
lua_S‹
 *
L
, 
wr™e_block
 *
b
, 
šdex
, 
d•th
);

218 
	$wb_bË_¬¿y
(
lua_S‹
 *
L
, 
wr™e_block
 * 
wb
, 
šdex
, 
d•th
) {

219 
¬¿y_size
 = 
	`lua_¿wËn
(
L
,
šdex
);

220 ià(
¬¿y_size
 >ğ
MAX_COOKIE
-1) {

221 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
TYPE_TABLE
, 
MAX_COOKIE
-1);

222 
	`wb_push
(
wb
, &
n
, 1);

223 
	`wb_š‹g”
(
wb
, 
¬¿y_size
);

225 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
TYPE_TABLE
, 
¬¿y_size
);

226 
	`wb_push
(
wb
, &
n
, 1);

229 
i
;

230 
i
=1;i<=
¬¿y_size
;i++) {

231 
	`lua_¿wg‘i
(
L
,
šdex
,
i
);

232 
	`·ck_Úe
(
L
, 
wb
, -1, 
d•th
);

233 
	`lua_pİ
(
L
,1);

236  
¬¿y_size
;

237 
	}
}

240 
	$wb_bË_hash
(
lua_S‹
 *
L
, 
wr™e_block
 * 
wb
, 
šdex
, 
d•th
, 
¬¿y_size
) {

241 
	`lua_pushn
(
L
);

242 
	`lua_Ãxt
(
L
, 
šdex
) != 0) {

243 ià(
	`lua_ty³
(
L
,-2è=ğ
LUA_TNUMBER
) {

244 ià(
	`lua_isš‹g”
(
L
, -2)) {

245 
lua_IÁeg”
 
x
 = 
	`lua_toš‹g”
(
L
,-2);

246 ià(
x
>0 && x<=
¬¿y_size
) {

247 
	`lua_pİ
(
L
,1);

252 
	`·ck_Úe
(
L
,
wb
,-2,
d•th
);

253 
	`·ck_Úe
(
L
,
wb
,-1,
d•th
);

254 
	`lua_pİ
(
L
, 1);

256 
	`wb_n
(
wb
);

257 
	}
}

260 
	$wb_bË_m‘­aœs
(
lua_S‹
 *
L
, 
wr™e_block
 *
wb
, 
šdex
, 
d•th
) {

261 
ušt8_t
 
n
 = 
	`COMBINE_TYPE
(
TYPE_TABLE
, 0);

262 
	`wb_push
(
wb
, &
n
, 1);

263 
	`lua_pushv®ue
(
L
, 
šdex
);

264 
	`lua_ÿÎ
(
L
, 1, 3);

266 
	`lua_pushv®ue
(
L
, -2);

267 
	`lua_pushv®ue
(
L
, -2);

268 
	`lua_cİy
(
L
, -5, -3);

269 
	`lua_ÿÎ
(
L
, 2, 2);

270 
ty³
 = 
	`lua_ty³
(
L
, -2);

271 ià(
ty³
 =ğ
LUA_TNIL
) {

272 
	`lua_pİ
(
L
, 4);

275 
	`·ck_Úe
(
L
, 
wb
, -2, 
d•th
);

276 
	`·ck_Úe
(
L
, 
wb
, -1, 
d•th
);

277 
	`lua_pİ
(
L
, 1);

279 
	`wb_n
(
wb
);

280 
	}
}

283 
	$wb_bË
(
lua_S‹
 *
L
, 
wr™e_block
 *
wb
, 
šdex
, 
d•th
) {

284 
	`luaL_check¡ack
(
L
, 
LUA_MINSTACK
, 
NULL
);

285 ià(
šdex
 < 0) {

286 
šdex
 = 
	`lua_g‘tİ
(
L
) + index + 1;

288 ià(
	`luaL_g‘m‘af›ld
(
L
, 
šdex
, "__·œs"è!ğ
LUA_TNIL
) {

289 
	`wb_bË_m‘­aœs
(
L
, 
wb
, 
šdex
, 
d•th
);

291 
¬¿y_size
 = 
	`wb_bË_¬¿y
(
L
, 
wb
, 
šdex
, 
d•th
);

292 
	`wb_bË_hash
(
L
, 
wb
, 
šdex
, 
d•th
, 
¬¿y_size
);

294 
	}
}

297 
	$·ck_Úe
(
lua_S‹
 *
L
, 
wr™e_block
 *
b
, 
šdex
, 
d•th
) {

298 ià(
d•th
 > 
MAX_DEPTH
) {

299 
	`wb_ä“
(
b
);

300 
	`luaL_”rÜ
(
L
, "serialize can't…ackoo depthable");

302 
ty³
 = 
	`lua_ty³
(
L
,
šdex
);

303 
ty³
) {

304 
LUA_TNIL
:

305 
	`wb_n
(
b
);

307 
LUA_TNUMBER
: {

308 ià(
	`lua_isš‹g”
(
L
, 
šdex
)) {

309 
lua_IÁeg”
 
x
 = 
	`lua_toš‹g”
(
L
,
šdex
);

310 
	`wb_š‹g”
(
b
, 
x
);

312 
lua_Numb”
 
n
 = 
	`lua_tÚumb”
(
L
,
šdex
);

313 
	`wb_»®
(
b
,
n
);

317 
LUA_TBOOLEAN
:

318 
	`wb_boŞ—n
(
b
, 
	`lua_toboŞ—n
(
L
,
šdex
));

320 
LUA_TSTRING
: {

321 
size_t
 
sz
 = 0;

322 cÚ¡ *
¡r
 = 
	`lua_tŞ¡ršg
(
L
,
šdex
,&
sz
);

323 
	`wb_¡ršg
(
b
, 
¡r
, ()
sz
);

326 
LUA_TLIGHTUSERDATA
:

327 
	`wb_poš‹r
(
b
, 
	`lua_tou£rd©a
(
L
,
šdex
));

329 
LUA_TTABLE
: {

330 ià(
šdex
 < 0) {

331 
šdex
 = 
	`lua_g‘tİ
(
L
) + index + 1;

333 
	`wb_bË
(
L
, 
b
, 
šdex
, 
d•th
+1);

337 
	`wb_ä“
(
b
);

338 
	`luaL_”rÜ
(
L
, "UnsuµÜˆty³ % tØ£rŸlize", 
	`lua_ty³Çme
(L, 
ty³
));

340 
	}
}

343 
	$·ck_äom
(
lua_S‹
 *
L
, 
wr™e_block
 *
b
, 
äom
) {

344 
n
 = 
	`lua_g‘tİ
(
L
è- 
äom
;

345 
i
;

346 
i
=1;i<=
n
;i++) {

347 
	`·ck_Úe
(
L
, 
b
 , 
äom
 + 
i
, 0);

349 
	}
}

351 
šlše
 

352 
	$šv®id_¡»am_lše
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
, 
lše
) {

353 
Ën
 = 
rb
->len;

354 
	`luaL_”rÜ
(
L
, "Inv®id s”Ÿliz¡»am %d (lše:%d)", 
Ën
, 
lše
);

355 
	}
}

357 
	#šv®id_¡»am
(
L
,
rb
è
	`šv®id_¡»am_lše
(L,rb,
__LINE__
)

	)

359 
lua_IÁeg”


360 
	$g‘_š‹g”
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
, 
cook›
) {

361 
cook›
) {

362 
TYPE_NUMBER_ZERO
:

364 
TYPE_NUMBER_BYTE
: {

365 
ušt8_t
 
n
;

366 
ušt8_t
 * 
²
 = 
	`rb_»ad
(
rb
,(
n
));

367 ià(
²
 =ğ
NULL
)

368 
	`šv®id_¡»am
(
L
,
rb
);

369 
n
 = *
²
;

370  
n
;

372 
TYPE_NUMBER_WORD
: {

373 
ušt16_t
 
n
;

374 
ušt16_t
 * 
²
 = 
	`rb_»ad
(
rb
,(
n
));

375 ià(
²
 =ğ
NULL
)

376 
	`šv®id_¡»am
(
L
,
rb
);

377 
	`memıy
(&
n
, 
²
, (n));

378  
n
;

380 
TYPE_NUMBER_DWORD
: {

381 
št32_t
 
n
;

382 
št32_t
 * 
²
 = 
	`rb_»ad
(
rb
,(
n
));

383 ià(
²
 =ğ
NULL
)

384 
	`šv®id_¡»am
(
L
,
rb
);

385 
	`memıy
(&
n
, 
²
, (n));

386  
n
;

388 
TYPE_NUMBER_QWORD
: {

389 
št64_t
 
n
;

390 
št64_t
 * 
²
 = 
	`rb_»ad
(
rb
,(
n
));

391 ià(
²
 =ğ
NULL
)

392 
	`šv®id_¡»am
(
L
,
rb
);

393 
	`memıy
(&
n
, 
²
, (n));

394  
n
;

397 
	`šv®id_¡»am
(
L
,
rb
);

400 
	}
}

403 
	$g‘_»®
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
) {

404 
n
;

405 * 
²
 = 
	`rb_»ad
(
rb
,(
n
));

406 ià(
²
 =ğ
NULL
)

407 
	`šv®id_¡»am
(
L
,
rb
);

408 
	`memıy
(&
n
, 
²
, (n));

409  
n
;

410 
	}
}

413 
	$g‘_poš‹r
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
) {

414 * 
u£rd©a
 = 0;

415 ** 
v
 = (**)
	`rb_»ad
(
rb
,(
u£rd©a
));

416 ià(
v
 =ğ
NULL
) {

417 
	`šv®id_¡»am
(
L
,
rb
);

419 
	`memıy
(&
u£rd©a
, 
v
, (userdata));

420  
u£rd©a
;

421 
	}
}

424 
	$g‘_bufãr
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
, 
Ën
) {

425 * 
p
 = 
	`rb_»ad
(
rb
,
Ën
);

426 ià(
p
 =ğ
NULL
) {

427 
	`šv®id_¡»am
(
L
,
rb
);

429 
	`lua_pushl¡ršg
(
L
,
p
,
Ën
);

430 
	}
}

432 
uÅack_Úe
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
);

435 
	$uÅack_bË
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
, 
¬¿y_size
) {

436 ià(
¬¿y_size
 =ğ
MAX_COOKIE
-1) {

437 
ušt8_t
 
ty³
;

438 
ušt8_t
 *
t
 = 
	`rb_»ad
(
rb
, (
ty³
));

439 ià(
t
==
NULL
) {

440 
	`šv®id_¡»am
(
L
,
rb
);

442 
ty³
 = *
t
;

443 
cook›
 = 
ty³
 >> 3;

444 ià((
ty³
 & 7è!ğ
TYPE_NUMBER
 || 
cook›
 =ğ
TYPE_NUMBER_REAL
) {

445 
	`šv®id_¡»am
(
L
,
rb
);

447 
¬¿y_size
 = 
	`g‘_š‹g”
(
L
,
rb
,
cook›
);

449 
	`luaL_check¡ack
(
L
,
LUA_MINSTACK
,
NULL
);

450 
	`lua_ü—‹bË
(
L
,
¬¿y_size
,0);

451 
i
;

452 
i
=1;i<=
¬¿y_size
;i++) {

453 
	`uÅack_Úe
(
L
,
rb
);

454 
	`lua_¿w£ti
(
L
,-2,
i
);

457 
	`uÅack_Úe
(
L
,
rb
);

458 ià(
	`lua_i¢
(
L
,-1)) {

459 
	`lua_pİ
(
L
,1);

462 
	`uÅack_Úe
(
L
,
rb
);

463 
	`lua_¿w£t
(
L
,-3);

465 
	}
}

468 
	$push_v®ue
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
, 
ty³
, 
cook›
) {

469 
ty³
) {

470 
TYPE_NIL
:

471 
	`lua_pushn
(
L
);

473 
TYPE_BOOLEAN
:

474 
	`lua_pushboŞ—n
(
L
,
cook›
);

476 
TYPE_NUMBER
:

477 ià(
cook›
 =ğ
TYPE_NUMBER_REAL
) {

478 
	`lua_pushnumb”
(
L
,
	`g‘_»®
(L,
rb
));

480 
	`lua_pushš‹g”
(
L
, 
	`g‘_š‹g”
(L, 
rb
, 
cook›
));

483 
TYPE_USERDATA
:

484 
	`lua_pushlightu£rd©a
(
L
,
	`g‘_poš‹r
(L,
rb
));

486 
TYPE_SHORT_STRING
:

487 
	`g‘_bufãr
(
L
,
rb
,
cook›
);

489 
TYPE_LONG_STRING
: {

490 ià(
cook›
 == 2) {

491 
ušt16_t
 *
¶’
 = 
	`rb_»ad
(
rb
, 2);

492 ià(
¶’
 =ğ
NULL
) {

493 
	`šv®id_¡»am
(
L
,
rb
);

495 
ušt16_t
 
n
;

496 
	`memıy
(&
n
, 
¶’
, (n));

497 
	`g‘_bufãr
(
L
,
rb
,
n
);

499 ià(
cook›
 != 4) {

500 
	`šv®id_¡»am
(
L
,
rb
);

502 
ušt32_t
 *
¶’
 = 
	`rb_»ad
(
rb
, 4);

503 ià(
¶’
 =ğ
NULL
) {

504 
	`šv®id_¡»am
(
L
,
rb
);

506 
ušt32_t
 
n
;

507 
	`memıy
(&
n
, 
¶’
, (n));

508 
	`g‘_bufãr
(
L
,
rb
,
n
);

512 
TYPE_TABLE
: {

513 
	`uÅack_bË
(
L
,
rb
,
cook›
);

517 
	`šv®id_¡»am
(
L
,
rb
);

521 
	}
}

524 
	$uÅack_Úe
(
lua_S‹
 *
L
, 
»ad_block
 *
rb
) {

525 
ušt8_t
 
ty³
;

526 
ušt8_t
 *
t
 = 
	`rb_»ad
(
rb
, (
ty³
));

527 ià(
t
==
NULL
) {

528 
	`šv®id_¡»am
(
L
, 
rb
);

530 
ty³
 = *
t
;

531 
	`push_v®ue
(
L
, 
rb
, 
ty³
 & 0x7,ype>>3);

532 
	}
}

535 
	$£ri
(
lua_S‹
 *
L
, 
block
 *
b
, 
Ën
) {

536 
ušt8_t
 * 
bufãr
 = 
	`skyÃt_m®loc
(
Ën
);

537 
ušt8_t
 * 
±r
 = 
bufãr
;

538 
sz
 = 
Ën
;

539 
Ën
>0) {

540 ià(
Ën
 >ğ
BLOCK_SIZE
) {

541 
	`memıy
(
±r
, 
b
->
bufãr
, 
BLOCK_SIZE
);

542 
±r
 +ğ
BLOCK_SIZE
;

543 
Ën
 -ğ
BLOCK_SIZE
;

544 
b
 = b->
Ãxt
;

546 
	`memıy
(
±r
, 
b
->
bufãr
, 
Ën
);

551 
	`lua_pushlightu£rd©a
(
L
, 
bufãr
);

552 
	`lua_pushš‹g”
(
L
, 
sz
);

553 
	}
}

556 
	$lua£ri_uÅack
(
lua_S‹
 *
L
) {

557 ià(
	`lua_i¢ÚeÜn
(
L
,1)) {

560 * 
bufãr
;

561 
Ën
;

562 ià(
	`lua_ty³
(
L
,1è=ğ
LUA_TSTRING
) {

563 
size_t
 
sz
;

564 
bufãr
 = (*)
	`lua_tŞ¡ršg
(
L
,1,&
sz
);

565 
Ën
 = ()
sz
;

567 
bufãr
 = 
	`lua_tou£rd©a
(
L
,1);

568 
Ën
 = 
	`luaL_checkš‹g”
(
L
,2);

570 ià(
Ën
 == 0) {

573 ià(
bufãr
 =ğ
NULL
) {

574  
	`luaL_”rÜ
(
L
, "deserialize‚ull…ointer");

577 
	`lua_£‰İ
(
L
,1);

578 
»ad_block
 
rb
;

579 
	`rb®l_š™
(&
rb
, 
bufãr
, 
Ën
);

581 
i
;

582 
i
=0;;i++) {

583 ià(
i
%8==7) {

584 
	`luaL_check¡ack
(
L
,
LUA_MINSTACK
,
NULL
);

586 
ušt8_t
 
ty³
 = 0;

587 
ušt8_t
 *
t
 = 
	`rb_»ad
(&
rb
, (
ty³
));

588 ià(
t
==
NULL
)

590 
ty³
 = *
t
;

591 
	`push_v®ue
(
L
, &
rb
, 
ty³
 & 0x7,ype>>3);

596  
	`lua_g‘tİ
(
L
) - 1;

597 
	}
}

599 
LUAMOD_API
 

600 
	$lua£ri_·ck
(
lua_S‹
 *
L
) {

601 
block
 
‹mp
;

602 
‹mp
.
Ãxt
 = 
NULL
;

603 
wr™e_block
 
wb
;

604 
	`wb_š™
(&
wb
, &
‹mp
);

605 
	`·ck_äom
(
L
,&
wb
,0);

606 
	`as£¹
(
wb
.
h—d
 =ğ&
‹mp
);

607 
	`£ri
(
L
, &
‹mp
, 
wb
.
Ën
);

609 
	`wb_ä“
(&
wb
);

612 
	}
}

	@lualib-src/lua-seri.h

1 #iâdeà
LUA_SERIALIZE_H


2 
	#LUA_SERIALIZE_H


	)

4 
	~<lua.h
>

6 
lua£ri_·ck
(
lua_S‹
 *
L
);

7 
lua£ri_uÅack
(
lua_S‹
 *
L
);

	@lualib-src/lua-sharedata.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

5 
	~<¡dšt.h
>

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<as£¹.h
>

9 
	~"©omic.h
"

11 
	#KEYTYPE_INTEGER
 0

	)

12 
	#KEYTYPE_STRING
 1

	)

14 
	#VALUETYPE_NIL
 0

	)

15 
	#VALUETYPE_REAL
 1

	)

16 
	#VALUETYPE_STRING
 2

	)

17 
	#VALUETYPE_BOOLEAN
 3

	)

18 
	#VALUETYPE_TABLE
 4

	)

19 
	#VALUETYPE_INTEGER
 5

	)

21 
	gbË
;

23 
	uv®ue
 {

24 
lua_Numb”
 
	mn
;

25 
lua_IÁeg”
 
	md
;

26 
bË
 * 
	mtbl
;

27 
	m¡ršg
;

28 
	mboŞ—n
;

31 
	snode
 {

32 
v®ue
 
	mv
;

33 
	mkey
;

34 
	mÃxt
;

35 
ušt32_t
 
	mkeyhash
;

36 
ušt8_t
 
	mkeyty³
;

37 
ušt8_t
 
	mv®u‘y³
;

38 
ušt8_t
 
	mnocŞlidšg
;

41 
	s¡©e
 {

42 
	mdœty
;

43 
	m»f
;

44 
bË
 * 
	mroÙ
;

47 
	sbË
 {

48 
	msiz—¼ay
;

49 
	msizehash
;

50 
ušt8_t
 *
	m¬¿yty³
;

51 
v®ue
 * 
	m¬¿y
;

52 
node
 * 
	mhash
;

53 
lua_S‹
 * 
	mL
;

56 
	scÚ‹xt
 {

57 
lua_S‹
 * 
	mL
;

58 
bË
 * 
	mtbl
;

59 
	m¡ršg_šdex
;

62 
	sù¾
 {

63 
bË
 * 
	mroÙ
;

64 
bË
 * 
	mupd©e
;

68 
	$couÁsize
(
lua_S‹
 *
L
, 
siz—¼ay
) {

69 
n
 = 0;

70 
	`lua_pushn
(
L
);

71 
	`lua_Ãxt
(
L
, 1) != 0) {

72 
ty³
 = 
	`lua_ty³
(
L
, -2);

73 ++
n
;

74 ià(
ty³
 =ğ
LUA_TNUMBER
) {

75 ià(!
	`lua_isš‹g”
(
L
, -2)) {

76 
	`luaL_”rÜ
(
L
, "Inv®id key %f", 
	`lua_tÚumb”
(L, -2));

78 
lua_IÁeg”
 
nkey
 = 
	`lua_toš‹g”
(
L
, -2);

79 ià(
nkey
 > 0 &&‚key <ğ
siz—¼ay
) {

80 --
n
;

82 } ià(
ty³
 !ğ
LUA_TSTRING
 &&y³ !ğ
LUA_TTABLE
) {

83 
	`luaL_”rÜ
(
L
, "Inv®id keyy³ %s", 
	`lua_ty³Çme
(L, 
ty³
));

85 
	`lua_pİ
(
L
, 1);

88  
n
;

89 
	}
}

91 
ušt32_t


92 
	$ÿlchash
(cÚ¡ * 
¡r
, 
size_t
 
l
) {

93 
ušt32_t
 
h
 = (ušt32_t)
l
;

94 
size_t
 
l1
;

95 
size_t
 
¡•
 = (
l
 >> 5) + 1;

96 
l1
 = 
l
;†1 >ğ
¡•
;†1 -= step) {

97 
h
 = h ^ ((h<<5è+ (h>>2è+ (
ušt8_t
)(
¡r
[
l1
 - 1]));

99  
h
;

100 
	}
}

103 
	$¡ršgšdex
(
cÚ‹xt
 *
ùx
, cÚ¡ * 
¡r
, 
size_t
 
sz
) {

104 
lua_S‹
 *
L
 = 
ùx
->L;

105 
	`lua_pushl¡ršg
(
L
, 
¡r
, 
sz
);

106 
	`lua_pushv®ue
(
L
, -1);

107 
	`lua_¿wg‘
(
L
, 1);

108 
šdex
;

110 ià(
	`lua_i¢
(
L
, -1)) {

111 
šdex
 = ++
ùx
->
¡ršg_šdex
;

112 
	`lua_pİ
(
L
, 1);

113 
	`lua_pushš‹g”
(
L
, 
šdex
);

114 
	`lua_¿w£t
(
L
, 1);

116 
šdex
 = 
	`lua_toš‹g”
(
L
, -1);

117 
	`lua_pİ
(
L
, 2);

119  
šdex
;

120 
	}
}

122 
cÚvbË
(
lua_S‹
 *
L
);

125 
	$£tv®ue
(
cÚ‹xt
 * 
ùx
, 
lua_S‹
 *
L
, 
šdex
, 
node
 *
n
) {

126 
vt
 = 
	`lua_ty³
(
L
, 
šdex
);

127 
vt
) {

128 
LUA_TNIL
:

129 
n
->
v®u‘y³
 = 
VALUETYPE_NIL
;

131 
LUA_TNUMBER
:

132 ià(
	`lua_isš‹g”
(
L
, 
šdex
)) {

133 
n
->
v
.
d
 = 
	`lua_toš‹g”
(
L
, 
šdex
);

134 
n
->
v®u‘y³
 = 
VALUETYPE_INTEGER
;

136 
n
->
v
.Àğ
	`lua_tÚumb”
(
L
, 
šdex
);

137 
n
->
v®u‘y³
 = 
VALUETYPE_REAL
;

140 
LUA_TSTRING
: {

141 
size_t
 
sz
 = 0;

142 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
, 
šdex
, &
sz
);

143 
n
->
v
.
¡ršg
 = 
	`¡ršgšdex
(
ùx
, 
¡r
, 
sz
);

144 
n
->
v®u‘y³
 = 
VALUETYPE_STRING
;

147 
LUA_TBOOLEAN
:

148 
n
->
v
.
boŞ—n
 = 
	`lua_toboŞ—n
(
L
, 
šdex
);

149 
n
->
v®u‘y³
 = 
VALUETYPE_BOOLEAN
;

151 
LUA_TTABLE
: {

152 
bË
 *
tbl
 = 
ùx
->tbl;

153 
ùx
->
tbl
 = (
bË
 *)
	`m®loc
((table));

154 ià(
ùx
->
tbl
 =ğ
NULL
) {

155 
ùx
->
tbl
 =bl;

156 
	`luaL_”rÜ
(
L
, "memoryƒrror");

159 
	`mem£t
(
ùx
->
tbl
, 0, (
bË
));

160 
absidx
 = 
	`lua_absšdex
(
L
, 
šdex
);

162 
	`lua_pushcfunùiÚ
(
L
, 
cÚvbË
);

163 
	`lua_pushv®ue
(
L
, 
absidx
);

164 
	`lua_pushlightu£rd©a
(
L
, 
ùx
);

166 
	`lua_ÿÎ
(
L
, 2, 0);

168 
n
->
v
.
tbl
 = 
ùx
->tbl;

169 
n
->
v®u‘y³
 = 
VALUETYPE_TABLE
;

171 
ùx
->
tbl
 =bl;

176 
	`luaL_”rÜ
(
L
, "UnsuµÜˆv®uty³ %s", 
	`lua_ty³Çme
(L, 
vt
));

179 
	}
}

182 
	$£¼ay
(
cÚ‹xt
 *
ùx
, 
lua_S‹
 *
L
, 
šdex
, 
key
) {

183 
node
 
n
;

184 
	`£tv®ue
(
ùx
, 
L
, 
šdex
, &
n
);

185 
bË
 *
tbl
 = 
ùx
->tbl;

186 --
key
;

187 
tbl
->
¬¿yty³
[
key
] = 
n
.
v®u‘y³
;

188 
tbl
->
¬¿y
[
key
] = 
n
.
v
;

189 
	}
}

192 
	$ishashkey
(
cÚ‹xt
 * 
ùx
, 
lua_S‹
 *
L
, 
šdex
, *
key
, 
ušt32_t
 *
keyhash
, *
keyty³
) {

193 
siz—¼ay
 = 
ùx
->
tbl
->sizearray;

194 
kt
 = 
	`lua_ty³
(
L
, 
šdex
);

195 ià(
kt
 =ğ
LUA_TNUMBER
) {

196 *
key
 = 
	`lua_toš‹g”
(
L
, 
šdex
);

197 ià(*
key
 > 0 && *key <ğ
siz—¼ay
) {

200 *
keyhash
 = (
ušt32_t
)*
key
;

201 *
keyty³
 = 
KEYTYPE_INTEGER
;

203 
size_t
 
sz
 = 0;

204 cÚ¡ * 
s
 = 
	`lua_tŞ¡ršg
(
L
, 
šdex
, &
sz
);

205 *
keyhash
 = 
	`ÿlchash
(
s
, 
sz
);

206 *
key
 = 
	`¡ršgšdex
(
ùx
, 
s
, 
sz
);

207 *
keyty³
 = 
KEYTYPE_STRING
;

210 
	}
}

213 
	$fÊocŞlidšg
(
lua_S‹
 *
L
, 
cÚ‹xt
 *
ùx
) {

214 
bË
 * 
tbl
 = 
ùx
->tbl;

215 
	`lua_pushn
(
L
);

216 
	`lua_Ãxt
(
L
, 1) != 0) {

217 
key
;

218 
keyty³
;

219 
ušt32_t
 
keyhash
;

220 ià(!
	`ishashkey
(
ùx
, 
L
, -2, &
key
, &
keyhash
, &
keyty³
)) {

221 
	`£¼ay
(
ùx
, 
L
, -1, 
key
);

223 
node
 * 
n
 = &
tbl
->
hash
[
keyhash
 %bl->
sizehash
];

224 ià(
n
->
v®u‘y³
 =ğ
VALUETYPE_NIL
) {

225 
n
->
key
 = key;

226 
n
->
keyty³
 = keytype;

227 
n
->
keyhash
 = keyhash;

228 
n
->
Ãxt
 = -1;

229 
n
->
nocŞlidšg
 = 1;

230 
	`£tv®ue
(
ùx
, 
L
, -1, 
n
);

233 
	`lua_pİ
(
L
,1);

235 
	}
}

238 
	$flcŞlidšg
(
lua_S‹
 *
L
, 
cÚ‹xt
 *
ùx
) {

239 
bË
 * 
tbl
 = 
ùx
->tbl;

240 
sizehash
 = 
tbl
->sizehash;

241 
em±y¦Ù
 = 0;

242 
i
;

243 
	`lua_pushn
(
L
);

244 
	`lua_Ãxt
(
L
, 1) != 0) {

245 
key
;

246 
keyty³
;

247 
ušt32_t
 
keyhash
;

248 ià(
	`ishashkey
(
ùx
, 
L
, -2, &
key
, &
keyhash
, &
keyty³
)) {

249 
node
 * 
mašpos
 = &
tbl
->
hash
[
keyhash
 %bl->
sizehash
];

250 ià(!(
mašpos
->
keyty³
 =ğkeyty³ && mašpos->
key
 == key)) {

252 
node
 * 
n
 = 
NULL
;

253 
i
=
em±y¦Ù
;i<
sizehash
;i++) {

254 ià(
tbl
->
hash
[
i
].
v®u‘y³
 =ğ
VALUETYPE_NIL
) {

255 
n
 = &
tbl
->
hash
[
i
];

259 
	`as£¹
(
n
);

260 
n
->
Ãxt
 = 
mašpos
->next;

261 
mašpos
->
Ãxt
 = 
n
 - 
tbl
->
hash
;

262 
mašpos
->
nocŞlidšg
 = 0;

263 
n
->
key
 = key;

264 
n
->
keyty³
 = keytype;

265 
n
->
keyhash
 = keyhash;

266 
n
->
nocŞlidšg
 = 0;

267 
	`£tv®ue
(
ùx
, 
L
, -1, 
n
);

270 
	`lua_pİ
(
L
,1);

272 
	}
}

277 
	$cÚvbË
(
lua_S‹
 *
L
) {

278 
i
;

279 
cÚ‹xt
 *
ùx
 = 
	`lua_tou£rd©a
(
L
,2);

280 
bË
 *
tbl
 = 
ùx
->tbl;

282 
tbl
->
L
 = 
ùx
->L;

284 
siz—¼ay
 = 
	`lua_¿wËn
(
L
, 1);

285 ià(
siz—¼ay
) {

286 
tbl
->
¬¿yty³
 = (
ušt8_t
 *)
	`m®loc
(
siz—¼ay
 * (uint8_t));

287 ià(
tbl
->
¬¿yty³
 =ğ
NULL
) {

288 
mem”rÜ
;

290 
i
=0;i<
siz—¼ay
;i++) {

291 
tbl
->
¬¿yty³
[
i
] = 
VALUETYPE_NIL
;

293 
tbl
->
¬¿y
 = (
v®ue
 *)
	`m®loc
(
siz—¼ay
 * (value));

294 ià(
tbl
->
¬¿y
 =ğ
NULL
) {

295 
mem”rÜ
;

297 
tbl
->
siz—¼ay
 = sizearray;

299 
sizehash
 = 
	`couÁsize
(
L
, 
siz—¼ay
);

300 ià(
sizehash
) {

301 
tbl
->
hash
 = (
node
 *)
	`m®loc
(
sizehash
 * (node));

302 ià(
tbl
->
hash
 =ğ
NULL
) {

303 
mem”rÜ
;

305 
i
=0;i<
sizehash
;i++) {

306 
tbl
->
hash
[
i
].
v®u‘y³
 = 
VALUETYPE_NIL
;

307 
tbl
->
hash
[
i
].
nocŞlidšg
 = 0;

309 
tbl
->
sizehash
 = sizehash;

311 
	`fÊocŞlidšg
(
L
, 
ùx
);

312 
	`flcŞlidšg
(
L
, 
ùx
);

314 
i
;

315 
i
=1;i<=
siz—¼ay
;i++) {

316 
	`lua_¿wg‘i
(
L
, 1, 
i
);

317 
	`£¼ay
(
ùx
, 
L
, -1, 
i
);

318 
	`lua_pİ
(
L
,1);

323 
mem”rÜ
:

324  
	`luaL_”rÜ
(
L
, "memoryƒrror");

325 
	}
}

328 
	$d–‘e_tbl
(
bË
 *
tbl
) {

329 
i
;

330 
i
=0;i<
tbl
->
siz—¼ay
;i++) {

331 ià(
tbl
->
¬¿yty³
[
i
] =ğ
VALUETYPE_TABLE
) {

332 
	`d–‘e_tbl
(
tbl
->
¬¿y
[
i
].tbl);

335 
i
=0;i<
tbl
->
sizehash
;i++) {

336 ià(
tbl
->
hash
[
i
].
v®u‘y³
 =ğ
VALUETYPE_TABLE
) {

337 
	`d–‘e_tbl
(
tbl
->
hash
[
i
].
v
.tbl);

340 
	`ä“
(
tbl
->
¬¿yty³
);

341 
	`ä“
(
tbl
->
¬¿y
);

342 
	`ä“
(
tbl
->
hash
);

343 
	`ä“
(
tbl
);

344 
	}
}

347 
	$pcÚv
(
lua_S‹
 *
L
) {

348 
cÚ‹xt
 *
ùx
 = 
	`lua_tou£rd©a
(
L
,1);

349 
lua_S‹
 * 
pL
 = 
	`lua_tou£rd©a
(
L
, 2);

350 
»t
;

352 
	`lua_£‰İ
(
L
, 0);

356 
	`lua_ÃwbË
(
L
);

358 
	`lua_pushcfunùiÚ
(
pL
, 
cÚvbË
);

359 
	`lua_pushv®ue
(
pL
,1);

360 
	`lua_pushlightu£rd©a
(
pL
, 
ùx
);

362 
»t
 = 
	`lua_pÿÎ
(
pL
, 2, 0, 0);

363 ià(
»t
 !ğ
LUA_OK
) {

364 
size_t
 
sz
 = 0;

365 cÚ¡ * 
”rÜ
 = 
	`lua_tŞ¡ršg
(
pL
, -1, &
sz
);

366 
	`lua_pushl¡ršg
(
L
, 
”rÜ
, 
sz
);

367 
	`lua_”rÜ
(
L
);

371 
	`luaL_check¡ack
(
L
, 
ùx
->
¡ršg_šdex
 + 3, 
NULL
);

372 
	`lua_£‰İ
(
L
,1);

375 
	}
}

378 
	$cÚv”t_¡ršgm­
(
cÚ‹xt
 *
ùx
, 
bË
 *
tbl
) {

379 
lua_S‹
 *
L
 = 
ùx
->L;

380 
	`lua_check¡ack
(
L
, 
ùx
->
¡ršg_šdex
 + 
LUA_MINSTACK
);

381 
	`lua_£‰İ
(
L
, 
ùx
->
¡ršg_šdex
 + 1);

382 
	`lua_pushv®ue
(
L
, 1);

383 
¡©e
 * 
s
 = 
	`lua_Ãwu£rd©a
(
L
, (*s));

384 
s
->
dœty
 = 0;

385 
s
->
»f
 = 0;

386 
s
->
roÙ
 = 
tbl
;

387 
	`lua_»¶aû
(
L
, 1);

388 
	`lua_»¶aû
(
L
, -2);

390 
	`lua_pushn
(
L
);

392 
	`lua_Ãxt
(
L
, -2) != 0) {

393 
idx
 = 
	`lua_toš‹g”
(
L
, -1);

394 
	`lua_pİ
(
L
, 1);

395 
	`lua_pushv®ue
(
L
, -1);

396 
	`lua_»¶aû
(
L
, 
idx
);

399 
	`lua_pİ
(
L
, 1);

401 
	`lua_gc
(
L
, 
LUA_GCCOLLECT
, 0);

402 
	}
}

405 
	$ÊewcÚf
(
lua_S‹
 *
L
) {

406 
»t
;

407 
cÚ‹xt
 
ùx
;

408 
bË
 * 
tbl
 = 
NULL
;

409 
	`luaL_checkty³
(
L
,1,
LUA_TTABLE
);

410 
ùx
.
L
 = 
	`luaL_Ãw¡©e
();

411 
ùx
.
tbl
 = 
NULL
;

412 
ùx
.
¡ršg_šdex
 = 1;

413 ià(
ùx
.
L
 =ğ
NULL
) {

414 
	`lua_pushl™”®
(
L
, "memoryƒrror");

415 
”rÜ
;

417 
tbl
 = (
bË
 *)
	`m®loc
((table));

418 ià(
tbl
 =ğ
NULL
) {

420 
	`lua_şo£
(
ùx
.
L
);

421 
ùx
.
L
 = 
NULL
;

422 
	`lua_pushl™”®
(
L
, "memoryƒrror");

423 
”rÜ
;

425 
	`mem£t
(
tbl
, 0, (
bË
));

426 
ùx
.
tbl
 =bl;

428 
	`lua_pushcfunùiÚ
(
ùx
.
L
, 
pcÚv
);

429 
	`lua_pushlightu£rd©a
(
ùx
.
L
 , &ctx);

430 
	`lua_pushlightu£rd©a
(
ùx
.
L
 , L);

432 
»t
 = 
	`lua_pÿÎ
(
ùx
.
L
, 2, 1, 0);

434 ià(
»t
 !ğ
LUA_OK
) {

435 
size_t
 
sz
 = 0;

436 cÚ¡ * 
”rÜ
 = 
	`lua_tŞ¡ršg
(
ùx
.
L
, -1, &
sz
);

437 
	`lua_pushl¡ršg
(
L
, 
”rÜ
, 
sz
);

438 
”rÜ
;

441 
	`cÚv”t_¡ršgm­
(&
ùx
, 
tbl
);

443 
	`lua_pushlightu£rd©a
(
L
, 
tbl
);

446 
”rÜ
:

447 ià(
ùx
.
L
) {

448 
	`lua_şo£
(
ùx
.
L
);

450 ià(
tbl
) {

451 
	`d–‘e_tbl
(
tbl
);

453 
	`lua_”rÜ
(
L
);

455 
	}
}

457 
bË
 *

458 
	$g‘_bË
(
lua_S‹
 *
L
, 
šdex
) {

459 
bË
 *
tbl
 = 
	`lua_tou£rd©a
(
L
,
šdex
);

460 ià(
tbl
 =ğ
NULL
) {

461 
	`luaL_”rÜ
(
L
, "Need‡ conf object");

463  
tbl
;

464 
	}
}

467 
	$ld–‘ecÚf
(
lua_S‹
 *
L
) {

468 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

469 
	`lua_şo£
(
tbl
->
L
);

470 
	`d–‘e_tbl
(
tbl
);

472 
	}
}

475 
	$pushv®ue
(
lua_S‹
 *
L
,†ua_S‹ *
sL
, 
ušt8_t
 
vt
, 
v®ue
 *
v
) {

476 
vt
) {

477 
VALUETYPE_REAL
:

478 
	`lua_pushnumb”
(
L
, 
v
->
n
);

480 
VALUETYPE_INTEGER
:

481 
	`lua_pushš‹g”
(
L
, 
v
->
d
);

483 
VALUETYPE_STRING
: {

484 
size_t
 
sz
 = 0;

485 cÚ¡ *
¡r
 = 
	`lua_tŞ¡ršg
(
sL
, 
v
->
¡ršg
, &
sz
);

486 
	`lua_pushl¡ršg
(
L
, 
¡r
, 
sz
);

489 
VALUETYPE_BOOLEAN
:

490 
	`lua_pushboŞ—n
(
L
, 
v
->
boŞ—n
);

492 
VALUETYPE_TABLE
:

493 
	`lua_pushlightu£rd©a
(
L
, 
v
->
tbl
);

496 
	`lua_pushn
(
L
);

499 
	}
}

501 
node
 *

502 
	$lookup_key
(
bË
 *
tbl
, 
ušt32_t
 
keyhash
, 
key
, 
keyty³
, cÚ¡ *
¡r
, 
size_t
 
sz
) {

503 ià(
tbl
->
sizehash
 == 0)

504  
NULL
;

505 
node
 *
n
 = &
tbl
->
hash
[
keyhash
 %bl->
sizehash
];

506 ià(
keyhash
 !ğ
n
->keyhash &&‚->
nocŞlidšg
)

507  
NULL
;

509 ià(
keyhash
 =ğ
n
->keyhash) {

510 ià(
n
->
keyty³
 =ğ
KEYTYPE_INTEGER
) {

511 ià(
keyty³
 =ğ
KEYTYPE_INTEGER
 && 
n
->
key
 == key) {

512  
n
;

516 ià(
keyty³
 =ğ
KEYTYPE_STRING
) {

517 
size_t
 
sz2
 = 0;

518 cÚ¡ * 
¡r2
 = 
	`lua_tŞ¡ršg
(
tbl
->
L
, 
n
->
key
, &
sz2
);

519 ià(
sz
 =ğ
sz2
 && 
	`memcmp
(
¡r
,
¡r2
,sz) == 0) {

520  
n
;

525 ià(
n
->
Ãxt
 < 0) {

526  
NULL
;

528 
n
 = &
tbl
->
hash
[n->
Ãxt
];

530 
	}
}

533 
	$lšdexcÚf
(
lua_S‹
 *
L
) {

534 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

535 
kt
 = 
	`lua_ty³
(
L
,2);

536 
ušt32_t
 
keyhash
;

537 
key
 = 0;

538 
keyty³
;

539 
size_t
 
sz
 = 0;

540 cÚ¡ * 
¡r
 = 
NULL
;

541 ià(
kt
 =ğ
LUA_TNUMBER
) {

542 ià(!
	`lua_isš‹g”
(
L
, 2)) {

543  
	`luaL_”rÜ
(
L
, "Inv®id key %f", 
	`lua_tÚumb”
(L, 2));

545 
key
 = ()
	`lua_toš‹g”
(
L
, 2);

546 ià(
key
 > 0 && key <ğ
tbl
->
siz—¼ay
) {

547 --
key
;

548 
	`pushv®ue
(
L
, 
tbl
->L,bl->
¬¿yty³
[
key
], &tbl->
¬¿y
[key]);

551 
keyty³
 = 
KEYTYPE_INTEGER
;

552 
keyhash
 = (
ušt32_t
)
key
;

554 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

555 
keyhash
 = 
	`ÿlchash
(
¡r
, 
sz
);

556 
keyty³
 = 
KEYTYPE_STRING
;

559 
node
 *
n
 = 
	`lookup_key
(
tbl
, 
keyhash
, 
key
, 
keyty³
, 
¡r
, 
sz
);

560 ià(
n
) {

561 
	`pushv®ue
(
L
, 
tbl
->L, 
n
->
v®u‘y³
, &n->
v
);

566 
	}
}

569 
	$pushkey
(
lua_S‹
 *
L
,†ua_S‹ *
sL
, 
node
 *
n
) {

570 ià(
n
->
keyty³
 =ğ
KEYTYPE_INTEGER
) {

571 
	`lua_pushš‹g”
(
L
, 
n
->
key
);

573 
size_t
 
sz
 = 0;

574 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
sL
, 
n
->
key
, &
sz
);

575 
	`lua_pushl¡ršg
(
L
, 
¡r
, 
sz
);

577 
	}
}

580 
	$pushfœ¡hash
(
lua_S‹
 *
L
, 
bË
 * 
tbl
) {

581 ià(
tbl
->
sizehash
) {

582 
	`pushkey
(
L
, 
tbl
->L, &tbl->
hash
[0]);

587 
	}
}

590 
	$Êextkey
(
lua_S‹
 *
L
) {

591 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

592 ià(
	`lua_i¢ÚeÜn
(
L
,2)) {

593 ià(
tbl
->
siz—¼ay
 > 0) {

594 
i
;

595 
i
=0;i<
tbl
->
siz—¼ay
;i++) {

596 ià(
tbl
->
¬¿yty³
[
i
] !ğ
VALUETYPE_NIL
) {

597 
	`lua_pushš‹g”
(
L
, 
i
+1);

602  
	`pushfœ¡hash
(
L
, 
tbl
);

604 
kt
 = 
	`lua_ty³
(
L
,2);

605 
ušt32_t
 
keyhash
;

606 
key
 = 0;

607 
keyty³
;

608 
size_t
 
sz
=0;

609 cÚ¡ *
¡r
 = 
NULL
;

610 
siz—¼ay
 = 
tbl
->sizearray;

611 ià(
kt
 =ğ
LUA_TNUMBER
) {

612 ià(!
	`lua_isš‹g”
(
L
, 2)) {

615 
key
 = ()
	`lua_toš‹g”
(
L
, 2);

616 ià(
key
 > 0 && key <ğ
siz—¼ay
) {

617 
lua_IÁeg”
 
i
;

618 
i
=
key
;i<
siz—¼ay
;i++) {

619 ià(
tbl
->
¬¿yty³
[
i
] !ğ
VALUETYPE_NIL
) {

620 
	`lua_pushš‹g”
(
L
, 
i
+1);

624  
	`pushfœ¡hash
(
L
, 
tbl
);

626 
keyhash
 = (
ušt32_t
)
key
;

627 
keyty³
 = 
KEYTYPE_INTEGER
;

629 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, 2, &
sz
);

630 
keyhash
 = 
	`ÿlchash
(
¡r
, 
sz
);

631 
keyty³
 = 
KEYTYPE_STRING
;

634 
node
 *
n
 = 
	`lookup_key
(
tbl
, 
keyhash
, 
key
, 
keyty³
, 
¡r
, 
sz
);

635 ià(
n
) {

636 ++
n
;

637 
šdex
 = 
n
-
tbl
->
hash
;

638 ià(
šdex
 =ğ
tbl
->
sizehash
) {

641 
	`pushkey
(
L
, 
tbl
->L, 
n
);

646 
	}
}

649 
	$Î’
(
lua_S‹
 *
L
) {

650 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

651 
	`lua_pushš‹g”
(
L
, 
tbl
->
siz—¼ay
);

653 
	}
}

656 
	$lhashËn
(
lua_S‹
 *
L
) {

657 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

658 
	`lua_pushš‹g”
(
L
, 
tbl
->
sizehash
);

660 
	}
}

663 
	$»Ëa£obj
(
lua_S‹
 *
L
) {

664 
ù¾
 *
c
 = 
	`lua_tou£rd©a
(
L
, 1);

665 
bË
 *
tbl
 = 
c
->
roÙ
;

666 
¡©e
 *
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

667 
	`ATOM_DEC
(&
s
->
»f
);

668 
c
->
roÙ
 = 
NULL
;

669 
c
->
upd©e
 = 
NULL
;

672 
	}
}

675 
	$lboxcÚf
(
lua_S‹
 *
L
) {

676 
bË
 * 
tbl
 = 
	`g‘_bË
(
L
,1);

677 
¡©e
 * 
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

678 
	`ATOM_INC
(&
s
->
»f
);

680 
ù¾
 * 
c
 = 
	`lua_Ãwu£rd©a
(
L
, (*c));

681 
c
->
roÙ
 = 
tbl
;

682 
c
->
upd©e
 = 
NULL
;

683 ià(
	`luaL_Ãwm‘©abË
(
L
, "confctrl")) {

684 
	`lua_pushcfunùiÚ
(
L
, 
»Ëa£obj
);

685 
	`lua_£tf›ld
(
L
, -2, "__gc");

687 
	`lua_£tm‘©abË
(
L
, -2);

690 
	}
}

693 
	$lm¬kdœty
(
lua_S‹
 *
L
) {

694 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

695 
¡©e
 * 
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

696 
s
->
dœty
 = 1;

698 
	}
}

701 
	$lisdœty
(
lua_S‹
 *
L
) {

702 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

703 
¡©e
 * 
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

704 
d
 = 
s
->
dœty
;

705 
	`lua_pushboŞ—n
(
L
, 
d
);

708 
	}
}

711 
	$lg‘»f
(
lua_S‹
 *
L
) {

712 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

713 
¡©e
 * 
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

714 
	`lua_pushš‹g”
(
L
 , 
s
->
»f
);

717 
	}
}

720 
	$lšüef
(
lua_S‹
 *
L
) {

721 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

722 
¡©e
 * 
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

723 
»f
 = 
	`ATOM_INC
(&
s
->ref);

724 
	`lua_pushš‹g”
(
L
 , 
»f
);

727 
	}
}

730 
	$ldeüef
(
lua_S‹
 *
L
) {

731 
bË
 *
tbl
 = 
	`g‘_bË
(
L
,1);

732 
¡©e
 * 
s
 = 
	`lua_tou£rd©a
(
tbl
->
L
, 1);

733 
»f
 = 
	`ATOM_DEC
(&
s
->ref);

734 
	`lua_pushš‹g”
(
L
 , 
»f
);

737 
	}
}

740 
	$Ê“dupd©e
(
lua_S‹
 *
L
) {

741 
ù¾
 * 
c
 = 
	`lua_tou£rd©a
(
L
, 1);

742 ià(
c
->
upd©e
) {

743 
	`lua_pushlightu£rd©a
(
L
, 
c
->
upd©e
);

744 
	`lua_g‘u£rv®ue
(
L
, 1);

748 
	}
}

751 
	$lupd©e
(
lua_S‹
 *
L
) {

752 
	`luaL_checkty³
(
L
, 1, 
LUA_TUSERDATA
);

753 
	`luaL_checkty³
(
L
, 2, 
LUA_TLIGHTUSERDATA
);

754 
	`luaL_checkty³
(
L
, 3, 
LUA_TTABLE
);

755 
ù¾
 * 
c
ğ
	`lua_tou£rd©a
(
L
, 1);

756 
bË
 *
n
 = 
	`lua_tou£rd©a
(
L
, 2);

757 ià(
c
->
roÙ
 =ğ
n
) {

758  
	`luaL_”rÜ
(
L
, "You should update‡‚ew object");

760 
	`lua_£‰İ
(
L
, 3);

761 
	`lua_£tu£rv®ue
(
L
, 1);

762 
c
->
upd©e
 = 
n
;

765 
	}
}

767 
LUAMOD_API
 

768 
	$luaİ’_skyÃt_sh¬ed©a_cÜe
(
lua_S‹
 *
L
) {

769 
luaL_Reg
 
l
[] = {

771 { "Ãw", 
ÊewcÚf
 },

772 { "d–‘e", 
ld–‘ecÚf
 },

773 { "m¬kdœty", 
lm¬kdœty
 },

774 { "g‘»f", 
lg‘»f
 },

775 { "šüef", 
lšüef
 },

776 { "deüef", 
ldeüef
 },

779 { "box", 
lboxcÚf
 },

780 { "šdex", 
lšdexcÚf
 },

781 { "Ãxtkey", 
Êextkey
 },

782 { "Ën", 
Î’
 },

783 { "hashËn", 
lhashËn
 },

784 { "isdœty", 
lisdœty
 },

785 { "Ãedupd©e", 
Ê“dupd©e
 },

786 { "upd©e", 
lupd©e
 },

787 { 
NULL
, NULL },

789 
	`luaL_checkv”siÚ
(
L
);

790 
	`luaL_Ãwlib
(
L
, 
l
);

793 
	}
}

	@lualib-src/lua-skynet.c

1 
	#LUA_LIB


	)

3 
	~"skyÃt.h
"

4 
	~"lua-£ri.h
"

6 
	#KNRM
 "\x1B[0m"

	)

7 
	#KRED
 "\x1B[31m"

	)

9 
	~<lua.h
>

10 
	~<Ïuxlib.h
>

11 
	~<¡dlib.h
>

12 
	~<¡ršg.h
>

13 
	~<as£¹.h
>

15 
	s¢lua
 {

16 
lua_S‹
 * 
	mL
;

17 
skyÃt_cÚ‹xt
 * 
	mùx
;

18 cÚ¡ * 
	m´–ßd
;

22 
	$Œaûback
 (
lua_S‹
 *
L
) {

23 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, 1);

24 ià(
msg
)

25 
	`luaL_Œaûback
(
L
, L, 
msg
, 1);

27 
	`lua_pushl™”®
(
L
, "(noƒrror message)");

30 
	}
}

33 
	$_cb
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, * 
ud
, 
ty³
, 
£ssiÚ
, 
ušt32_t
 
sourû
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

34 
lua_S‹
 *
L
 = 
ud
;

35 
Œaû
 = 1;

36 
r
;

37 
tİ
 = 
	`lua_g‘tİ
(
L
);

38 ià(
tİ
 == 0) {

39 
	`lua_pushcfunùiÚ
(
L
, 
Œaûback
);

40 
	`lua_¿wg‘p
(
L
, 
LUA_REGISTRYINDEX
, 
_cb
);

42 
	`as£¹
(
tİ
 == 2);

44 
	`lua_pushv®ue
(
L
,2);

46 
	`lua_pushš‹g”
(
L
, 
ty³
);

47 
	`lua_pushlightu£rd©a
(
L
, (*)
msg
);

48 
	`lua_pushš‹g”
(
L
,
sz
);

49 
	`lua_pushš‹g”
(
L
, 
£ssiÚ
);

50 
	`lua_pushš‹g”
(
L
, 
sourû
);

52 
r
 = 
	`lua_pÿÎ
(
L
, 5, 0 , 
Œaû
);

54 ià(
r
 =ğ
LUA_OK
) {

57 cÚ¡ * 
£lf
 = 
	`skyÃt_commªd
(
cÚ‹xt
, "REG", 
NULL
);

58 
r
) {

59 
LUA_ERRRUN
:

60 
	`skyÃt_”rÜ
(
cÚ‹xt
, "lu¨ÿÎ [%xØ% : %d msgsz = %d]ƒ¼Ü : " 
KRED
 "%s" 
KNRM
, 
sourû
 , 
£lf
, 
£ssiÚ
, 
sz
, 
	`lua_to¡ršg
(
L
,-1));

62 
LUA_ERRMEM
:

63 
	`skyÃt_”rÜ
(
cÚ‹xt
, "lu¨memÜyƒ¼Ü : [%xØ% : %d]", 
sourû
 , 
£lf
, 
£ssiÚ
);

65 
LUA_ERRERR
:

66 
	`skyÃt_”rÜ
(
cÚ‹xt
, "lu¨”rÜ iÀ”rÜ : [%xØ% : %d]", 
sourû
 , 
£lf
, 
£ssiÚ
);

68 
LUA_ERRGCMM
:

69 
	`skyÃt_”rÜ
(
cÚ‹xt
, "lu¨gø”rÜ : [%xØ% : %d]", 
sourû
 , 
£lf
, 
£ssiÚ
);

73 
	`lua_pİ
(
L
,1);

76 
	}
}

79 
	$fÜw¬d_cb
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, * 
ud
, 
ty³
, 
£ssiÚ
, 
ušt32_t
 
sourû
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

80 
	`_cb
(
cÚ‹xt
, 
ud
, 
ty³
, 
£ssiÚ
, 
sourû
, 
msg
, 
sz
);

83 
	}
}

86 
	$lÿÎback
(
lua_S‹
 *
L
) {

87 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

88 
fÜw¬d
 = 
	`lua_toboŞ—n
(
L
, 2);

89 
	`luaL_checkty³
(
L
,1,
LUA_TFUNCTION
);

90 
	`lua_£‰İ
(
L
,1);

91 
	`lua_¿w£
(
L
, 
LUA_REGISTRYINDEX
, 
_cb
);

93 
	`lua_¿wg‘i
(
L
, 
LUA_REGISTRYINDEX
, 
LUA_RIDX_MAINTHREAD
);

94 
lua_S‹
 *
gL
 = 
	`lua_tÙh»ad
(
L
,-1);

96 ià(
fÜw¬d
) {

97 
	`skyÃt_ÿÎback
(
cÚ‹xt
, 
gL
, 
fÜw¬d_cb
);

99 
	`skyÃt_ÿÎback
(
cÚ‹xt
, 
gL
, 
_cb
);

103 
	}
}

106 
	$lcommªd
(
lua_S‹
 *
L
) {

107 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

108 cÚ¡ * 
cmd
 = 
	`luaL_check¡ršg
(
L
,1);

109 cÚ¡ * 
»suÉ
;

110 cÚ¡ * 
·rm
 = 
NULL
;

111 ià(
	`lua_g‘tİ
(
L
) == 2) {

112 
·rm
 = 
	`luaL_check¡ršg
(
L
,2);

115 
»suÉ
 = 
	`skyÃt_commªd
(
cÚ‹xt
, 
cmd
, 
·rm
);

116 ià(
»suÉ
) {

117 
	`lua_push¡ršg
(
L
, 
»suÉ
);

121 
	}
}

124 
	$lštcommªd
(
lua_S‹
 *
L
) {

125 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

126 cÚ¡ * 
cmd
 = 
	`luaL_check¡ršg
(
L
,1);

127 cÚ¡ * 
»suÉ
;

128 cÚ¡ * 
·rm
 = 
NULL
;

129 
tmp
[64];

130 ià(
	`lua_g‘tİ
(
L
) == 2) {

131 ià(
	`lua_i¢umb”
(
L
, 2)) {

132 
št32_t
 
n
 = (št32_t)
	`luaL_checkš‹g”
(
L
,2);

133 
	`¥rštf
(
tmp
, "%d", 
n
);

134 
·rm
 = 
tmp
;

136 
·rm
 = 
	`luaL_check¡ršg
(
L
,2);

140 
»suÉ
 = 
	`skyÃt_commªd
(
cÚ‹xt
, 
cmd
, 
·rm
);

141 ià(
»suÉ
) {

142 *
’d±r
 = 
NULL
;

143 
lua_IÁeg”
 
r
 = 
	`¡¹Şl
(
»suÉ
, &
’d±r
, 0);

144 ià(
’d±r
 =ğ
NULL
 || *endptr != '\0') {

146 
n
 = 
	`¡¹od
(
»suÉ
, &
’d±r
);

147 ià(
’d±r
 =ğ
NULL
 || *endptr != '\0') {

148  
	`luaL_”rÜ
(
L
, "Inv®id„esuÉ %s", 
»suÉ
);

150 
	`lua_pushnumb”
(
L
, 
n
);

153 
	`lua_pushš‹g”
(
L
, 
r
);

158 
	}
}

161 
	$lg’id
(
lua_S‹
 *
L
) {

162 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

163 
£ssiÚ
 = 
	`skyÃt_£nd
(
cÚ‹xt
, 0, 0, 
PTYPE_TAG_ALLOCSESSION
 , 0 , 
NULL
, 0);

164 
	`lua_pushš‹g”
(
L
, 
£ssiÚ
);

166 
	}
}

169 
	$g‘_de¡_¡ršg
(
lua_S‹
 *
L
, 
šdex
) {

170 cÚ¡ * 
de¡_¡ršg
 = 
	`lua_to¡ršg
(
L
, 
šdex
);

171 ià(
de¡_¡ršg
 =ğ
NULL
) {

172 
	`luaL_”rÜ
(
L
, "de¡‡dd»s ty³ (%sèmu¡ b¨¡ršg o¸numb”.", 
	`lua_ty³Çme
(L, 
	`lua_ty³
(L,
šdex
)));

174  
de¡_¡ršg
;

175 
	}
}

178 
	$£nd_mes§ge
(
lua_S‹
 *
L
, 
sourû
, 
idx_ty³
) {

179 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

180 
ušt32_t
 
de¡
 = (ušt32_t)
	`lua_toš‹g”
(
L
, 1);

181 cÚ¡ * 
de¡_¡ršg
 = 
NULL
;

182 ià(
de¡
 == 0) {

183 ià(
	`lua_ty³
(
L
,1è=ğ
LUA_TNUMBER
) {

184  
	`luaL_”rÜ
(
L
, "Invalid service‡ddress 0");

186 
de¡_¡ršg
 = 
	`g‘_de¡_¡ršg
(
L
, 1);

189 
ty³
 = 
	`luaL_checkš‹g”
(
L
, 
idx_ty³
+0);

190 
£ssiÚ
 = 0;

191 ià(
	`lua_i¢
(
L
,
idx_ty³
+1)) {

192 
ty³
 |ğ
PTYPE_TAG_ALLOCSESSION
;

194 
£ssiÚ
 = 
	`luaL_checkš‹g”
(
L
,
idx_ty³
+1);

197 
mty³
 = 
	`lua_ty³
(
L
,
idx_ty³
+2);

198 
mty³
) {

199 
LUA_TSTRING
: {

200 
size_t
 
Ën
 = 0;

201 * 
msg
 = (*)
	`lua_tŞ¡ršg
(
L
,
idx_ty³
+2,&
Ën
);

202 ià(
Ën
 == 0) {

203 
msg
 = 
NULL
;

205 ià(
de¡_¡ršg
) {

206 
£ssiÚ
 = 
	`skyÃt_£ndÇme
(
cÚ‹xt
, 
sourû
, 
de¡_¡ršg
, 
ty³
, sessiÚ , 
msg
, 
Ën
);

208 
£ssiÚ
 = 
	`skyÃt_£nd
(
cÚ‹xt
, 
sourû
, 
de¡
, 
ty³
, sessiÚ , 
msg
, 
Ën
);

212 
LUA_TLIGHTUSERDATA
: {

213 * 
msg
 = 
	`lua_tou£rd©a
(
L
,
idx_ty³
+2);

214 
size
 = 
	`luaL_checkš‹g”
(
L
,
idx_ty³
+3);

215 ià(
de¡_¡ršg
) {

216 
£ssiÚ
 = 
	`skyÃt_£ndÇme
(
cÚ‹xt
, 
sourû
, 
de¡_¡ršg
, 
ty³
 | 
PTYPE_TAG_DONTCOPY
, sessiÚ, 
msg
, 
size
);

218 
£ssiÚ
 = 
	`skyÃt_£nd
(
cÚ‹xt
, 
sourû
, 
de¡
, 
ty³
 | 
PTYPE_TAG_DONTCOPY
, sessiÚ, 
msg
, 
size
);

223 
	`luaL_”rÜ
(
L
, "šv®id…¬am %s", 
	`lua_ty³Çme
(L, 
	`lua_ty³
(L,
idx_ty³
+2)));

225 ià(
£ssiÚ
 < 0) {

230 
	`lua_pushš‹g”
(
L
,
£ssiÚ
);

232 
	}
}

244 
	$l£nd
(
lua_S‹
 *
L
) {

245  
	`£nd_mes§ge
(
L
, 0, 2);

246 
	}
}

259 
	$Ìedœeù
(
lua_S‹
 *
L
) {

260 
ušt32_t
 
sourû
 = (ušt32_t)
	`luaL_checkš‹g”
(
L
,2);

261  
	`£nd_mes§ge
(
L
, 
sourû
, 3);

262 
	}
}

265 
	$Ë¼Ü
(
lua_S‹
 *
L
) {

266 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

267 
n
 = 
	`lua_g‘tİ
(
L
);

268 ià(
n
 <= 1) {

269 
	`lua_£‰İ
(
L
, 1);

270 cÚ¡ * 
s
 = 
	`luaL_tŞ¡ršg
(
L
, 1, 
NULL
);

271 
	`skyÃt_”rÜ
(
cÚ‹xt
, "%s", 
s
);

274 
luaL_Bufãr
 
b
;

275 
	`luaL_buffš™
(
L
, &
b
);

276 
i
;

277 
i
=1; i<=
n
; i++) {

278 
	`luaL_tŞ¡ršg
(
L
, 
i
, 
NULL
);

279 
	`luaL_addv®ue
(&
b
);

280 ià(
i
<
n
) {

281 
	`luaL_addch¬
(&
b
, ' ');

284 
	`luaL_push»suÉ
(&
b
);

285 
	`skyÃt_”rÜ
(
cÚ‹xt
, "%s", 
	`lua_to¡ršg
(
L
, -1));

287 
	}
}

290 
	$Éo¡ršg
(
lua_S‹
 *
L
) {

291 ià(
	`lua_i¢ÚeÜn
(
L
,1)) {

294 * 
msg
 = 
	`lua_tou£rd©a
(
L
,1);

295 
sz
 = 
	`luaL_checkš‹g”
(
L
,2);

296 
	`lua_pushl¡ršg
(
L
,
msg
,
sz
);

298 
	}
}

301 
	$lh¬bÜ
(
lua_S‹
 *
L
) {

302 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

303 
ušt32_t
 
hªdË
 = (ušt32_t)
	`luaL_checkš‹g”
(
L
,1);

304 
h¬bÜ
 = 0;

305 
»mÙe
 = 
	`skyÃt_i¤emÙe
(
cÚ‹xt
, 
hªdË
, &
h¬bÜ
);

306 
	`lua_pushš‹g”
(
L
,
h¬bÜ
);

307 
	`lua_pushboŞ—n
(
L
, 
»mÙe
);

310 
	}
}

313 
	$Íack¡ršg
(
lua_S‹
 *
L
) {

314 
	`lua£ri_·ck
(
L
);

315 * 
¡r
 = (*)
	`lua_tou£rd©a
(
L
, -2);

316 
sz
 = 
	`lua_toš‹g”
(
L
, -1);

317 
	`lua_pushl¡ršg
(
L
, 
¡r
, 
sz
);

318 
	`skyÃt_ä“
(
¡r
);

320 
	}
}

323 
	$É¿sh
(
lua_S‹
 *
L
) {

324 
t
 = 
	`lua_ty³
(
L
,1);

325 
t
) {

326 
LUA_TSTRING
: {

329 
LUA_TLIGHTUSERDATA
: {

330 * 
msg
 = 
	`lua_tou£rd©a
(
L
,1);

331 
	`luaL_checkš‹g”
(
L
,2);

332 
	`skyÃt_ä“
(
msg
);

336 
	`luaL_”rÜ
(
L
, "skyÃt.Œash inv®id…¬am %s", 
	`lua_ty³Çme
(L,
t
));

340 
	}
}

343 
	$Êow
(
lua_S‹
 *
L
) {

344 
ušt64_t
 
ti
 = 
	`skyÃt_now
();

345 
	`lua_pushš‹g”
(
L
, 
ti
);

347 
	}
}

349 
LUAMOD_API
 

350 
	$luaİ’_skyÃt_cÜe
(
lua_S‹
 *
L
) {

351 
	`luaL_checkv”siÚ
(
L
);

353 
luaL_Reg
 
l
[] = {

354 { "£nd" , 
l£nd
 },

355 { "g’id", 
lg’id
 },

356 { "»dœeù", 
Ìedœeù
 },

357 { "commªd" , 
lcommªd
 },

358 { "štcommªd", 
lštcommªd
 },

359 { "”rÜ", 
Ë¼Ü
 },

360 { "to¡ršg", 
Éo¡ršg
 },

361 { "h¬bÜ", 
lh¬bÜ
 },

362 { "·ck", 
lua£ri_·ck
 },

363 { "uÅack", 
lua£ri_uÅack
 },

364 { "·ck¡ršg", 
Íack¡ršg
 },

365 { "Œash" , 
É¿sh
 },

366 { "ÿÎback", 
lÿÎback
 },

367 { "now", 
Êow
 },

368 { 
NULL
, NULL },

371 
	`luaL_ÃwlibbË
(
L
, 
l
);

373 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "skynet_context");

374 
skyÃt_cÚ‹xt
 *
ùx
 = 
	`lua_tou£rd©a
(
L
,-1);

375 ià(
ùx
 =ğ
NULL
) {

376  
	`luaL_”rÜ
(
L
, "Init skynet context first");

379 
	`luaL_£tfuncs
(
L
,
l
,1);

382 
	}
}

	@lualib-src/lua-socket.c

1 
	#LUA_LIB


	)

3 
	~"skyÃt_m®loc.h
"

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

7 
	~<¡dboŞ.h
>

8 
	~<¡dšt.h
>

9 
	~<as£¹.h
>

11 
	~<lua.h
>

12 
	~<Ïuxlib.h
>

14 
	~<sys/sock‘.h
>

15 
	~<¬·/š‘.h
>

17 
	~"skyÃt_sock‘.h
"

19 
	#BACKLOG
 32

	)

21 
	#LARGE_PAGE_NODE
 12

	)

22 
	#BUFFER_LIMIT
 (256 * 1024)

	)

24 
	sbufãr_node
 {

25 * 
	mmsg
;

26 
	msz
;

27 
bufãr_node
 *
	mÃxt
;

30 
	ssock‘_bufãr
 {

31 
	msize
;

32 
	moff£t
;

33 
bufãr_node
 *
	mh—d
;

34 
bufãr_node
 *
	m
;

38 
	$lä“poŞ
(
lua_S‹
 *
L
) {

39 
bufãr_node
 * 
poŞ
 = 
	`lua_tou£rd©a
(
L
, 1);

40 
sz
 = 
	`lua_¿wËn
(
L
,1è/ (*
poŞ
);

41 
i
;

42 
i
=0;i<
sz
;i++) {

43 
bufãr_node
 *
node
 = &
poŞ
[
i
];

44 ià(
node
->
msg
) {

45 
	`skyÃt_ä“
(
node
->
msg
);

46 
node
->
msg
 = 
NULL
;

50 
	}
}

53 
	$ÊewpoŞ
(
lua_S‹
 *
L
, 
sz
) {

54 
bufãr_node
 * 
poŞ
 = 
	`lua_Ãwu£rd©a
(
L
, (bufãr_nodeè* 
sz
);

55 
i
;

56 
i
=0;i<
sz
;i++) {

57 
poŞ
[
i
].
msg
 = 
NULL
;

58 
poŞ
[
i
].
sz
 = 0;

59 
poŞ
[
i
].
Ãxt
 = &pool[i+1];

61 
poŞ
[
sz
-1].
Ãxt
 = 
NULL
;

62 ià(
	`luaL_Ãwm‘©abË
(
L
, "buffer_pool")) {

63 
	`lua_pushcfunùiÚ
(
L
, 
lä“poŞ
);

64 
	`lua_£tf›ld
(
L
, -2, "__gc");

66 
	`lua_£tm‘©abË
(
L
, -2);

68 
	}
}

71 
	$Êewbufãr
(
lua_S‹
 *
L
) {

72 
sock‘_bufãr
 * 
sb
 = 
	`lua_Ãwu£rd©a
(
L
, (*sb));

73 
sb
->
size
 = 0;

74 
sb
->
off£t
 = 0;

75 
sb
->
h—d
 = 
NULL
;

76 
sb
->

 = 
NULL
;

79 
	}
}

99 
	$Íushbufãr
(
lua_S‹
 *
L
) {

100 
sock‘_bufãr
 *
sb
 = 
	`lua_tou£rd©a
(
L
,1);

101 ià(
sb
 =ğ
NULL
) {

102  
	`luaL_”rÜ
(
L
, "need buffer object‡t…aram 1");

104 * 
msg
 = 
	`lua_tou£rd©a
(
L
,3);

105 ià(
msg
 =ğ
NULL
) {

106  
	`luaL_”rÜ
(
L
, "need message block‡t…aram 3");

108 
poŞ_šdex
 = 2;

109 
	`luaL_checkty³
(
L
,
poŞ_šdex
,
LUA_TTABLE
);

110 
sz
 = 
	`luaL_checkš‹g”
(
L
,4);

111 
	`lua_¿wg‘i
(
L
,
poŞ_šdex
,1);

112 
bufãr_node
 * 
ä“_node
 = 
	`lua_tou£rd©a
(
L
,-1);

113 
	`lua_pİ
(
L
,1);

114 ià(
ä“_node
 =ğ
NULL
) {

115 
tsz
 = 
	`lua_¿wËn
(
L
,
poŞ_šdex
);

116 ià(
tsz
 == 0)

117 
tsz
++;

118 
size
 = 8;

119 ià(
tsz
 <ğ
LARGE_PAGE_NODE
-3) {

120 
size
 <<ğ
tsz
;

122 
size
 <<ğ
LARGE_PAGE_NODE
-3;

124 
	`ÊewpoŞ
(
L
, 
size
);

125 
ä“_node
 = 
	`lua_tou£rd©a
(
L
,-1);

126 
	`lua_¿w£ti
(
L
, 
poŞ_šdex
, 
tsz
+1);

128 
	`lua_pushlightu£rd©a
(
L
, 
ä“_node
->
Ãxt
);

129 
	`lua_¿w£ti
(
L
, 
poŞ_šdex
, 1);

130 
ä“_node
->
msg
 = msg;

131 
ä“_node
->
sz
 = sz;

132 
ä“_node
->
Ãxt
 = 
NULL
;

134 ià(
sb
->
h—d
 =ğ
NULL
) {

135 
	`as£¹
(
sb
->

 =ğ
NULL
);

136 
sb
->
h—d
 = sb->

 = 
ä“_node
;

138 
sb
->

->
Ãxt
 = 
ä“_node
;

139 
sb
->

 = 
ä“_node
;

141 
sb
->
size
 +ğ
sz
;

143 
	`lua_pushš‹g”
(
L
, 
sb
->
size
);

146 
	}
}

149 
	$»tuº_ä“_node
(
lua_S‹
 *
L
, 
poŞ
, 
sock‘_bufãr
 *
sb
) {

150 
bufãr_node
 *
ä“_node
 = 
sb
->
h—d
;

151 
sb
->
off£t
 = 0;

152 
sb
->
h—d
 = 
ä“_node
->
Ãxt
;

153 ià(
sb
->
h—d
 =ğ
NULL
) {

154 
sb
->

 = 
NULL
;

156 
	`lua_¿wg‘i
(
L
,
poŞ
,1);

157 
ä“_node
->
Ãxt
 = 
	`lua_tou£rd©a
(
L
,-1);

158 
	`lua_pİ
(
L
,1);

159 
	`skyÃt_ä“
(
ä“_node
->
msg
);

160 
ä“_node
->
msg
 = 
NULL
;

162 
ä“_node
->
sz
 = 0;

163 
	`lua_pushlightu£rd©a
(
L
, 
ä“_node
);

164 
	`lua_¿w£ti
(
L
, 
poŞ
, 1);

165 
	}
}

168 
	$pİ_l¡ršg
(
lua_S‹
 *
L
, 
sock‘_bufãr
 *
sb
, 
sz
, 
sk
) {

169 
bufãr_node
 * 
cu¼’t
 = 
sb
->
h—d
;

170 ià(
sz
 < 
cu¼’t
->sz - 
sb
->
off£t
) {

171 
	`lua_pushl¡ršg
(
L
, 
cu¼’t
->
msg
 + 
sb
->
off£t
, 
sz
-
sk
);

172 
sb
->
off£t
+=
sz
;

175 ià(
sz
 =ğ
cu¼’t
->sz - 
sb
->
off£t
) {

176 
	`lua_pushl¡ršg
(
L
, 
cu¼’t
->
msg
 + 
sb
->
off£t
, 
sz
-
sk
);

177 
	`»tuº_ä“_node
(
L
,2,
sb
);

181 
luaL_Bufãr
 
b
;

182 
	`luaL_buffš™
(
L
, &
b
);

184 
by‹s
 = 
cu¼’t
->
sz
 - 
sb
->
off£t
;

185 ià(
by‹s
 >ğ
sz
) {

186 ià(
sz
 > 
sk
) {

187 
	`luaL_addl¡ršg
(&
b
, 
cu¼’t
->
msg
 + 
sb
->
off£t
, 
sz
 - 
sk
);

189 
sb
->
off£t
 +ğ
sz
;

190 ià(
by‹s
 =ğ
sz
) {

191 
	`»tuº_ä“_node
(
L
,2,
sb
);

195 
»®_sz
 = 
sz
 - 
sk
;

196 ià(
»®_sz
 > 0) {

197 
	`luaL_addl¡ršg
(&
b
, 
cu¼’t
->
msg
 + 
sb
->
off£t
, (
»®_sz
 < 
by‹s
) ?„eal_sz : bytes);

199 
	`»tuº_ä“_node
(
L
,2,
sb
);

200 
sz
-=
by‹s
;

201 ià(
sz
==0)

203 
cu¼’t
 = 
sb
->
h—d
;

204 
	`as£¹
(
cu¼’t
);

206 
	`luaL_push»suÉ
(&
b
);

207 
	}
}

210 
	$lh—d”
(
lua_S‹
 *
L
) {

211 
size_t
 
Ën
;

212 cÚ¡ 
ušt8_t
 * 
s
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
Ën
);

213 ià(
Ën
 > 4 ||†en < 1) {

214  
	`luaL_”rÜ
(
L
, "Inv®id„—d %s", 
s
);

216 
i
;

217 
size_t
 
sz
 = 0;

218 
i
=0;i<()
Ën
;i++) {

219 
sz
 <<= 8;

220 
sz
 |ğ
s
[
i
];

223 
	`lua_pushš‹g”
(
L
, (
lua_IÁeg”
)
sz
);

226 
	}
}

234 
	$Íİbufãr
(
lua_S‹
 *
L
) {

235 
sock‘_bufãr
 * 
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

236 ià(
sb
 =ğ
NULL
) {

237  
	`luaL_”rÜ
(
L
, "Need buffer object‡t…aram 1");

239 
	`luaL_checkty³
(
L
,2,
LUA_TTABLE
);

240 
sz
 = 
	`luaL_checkš‹g”
(
L
,3);

241 ià(
sb
->
size
 < 
sz
 || sz == 0) {

242 
	`lua_pushn
(
L
);

244 
	`pİ_l¡ršg
(
L
,
sb
,
sz
,0);

245 
sb
->
size
 -ğ
sz
;

247 
	`lua_pushš‹g”
(
L
, 
sb
->
size
);

250 
	}
}

257 
	$lş—rbufãr
(
lua_S‹
 *
L
) {

258 
sock‘_bufãr
 * 
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

259 ià(
sb
 =ğ
NULL
) {

260 ià(
	`lua_i¢
(
L
, 1)) {

263  
	`luaL_”rÜ
(
L
, "Need buffer object‡t…aram 1");

265 
	`luaL_checkty³
(
L
,2,
LUA_TTABLE
);

266 
sb
->
h—d
) {

267 
	`»tuº_ä“_node
(
L
,2,
sb
);

269 
sb
->
size
 = 0;

271 
	}
}

274 
	$Ì—d®l
(
lua_S‹
 *
L
) {

275 
sock‘_bufãr
 * 
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

276 ià(
sb
 =ğ
NULL
) {

277  
	`luaL_”rÜ
(
L
, "Need buffer object‡t…aram 1");

279 
	`luaL_checkty³
(
L
,2,
LUA_TTABLE
);

280 
luaL_Bufãr
 
b
;

281 
	`luaL_buffš™
(
L
, &
b
);

282 
sb
->
h—d
) {

283 
bufãr_node
 *
cu¼’t
 = 
sb
->
h—d
;

284 
	`luaL_addl¡ršg
(&
b
, 
cu¼’t
->
msg
 + 
sb
->
off£t
, cu¼’t->
sz
 - sb->offset);

285 
	`»tuº_ä“_node
(
L
,2,
sb
);

287 
	`luaL_push»suÉ
(&
b
);

288 
sb
->
size
 = 0;

290 
	}
}

293 
	$ldrİ
(
lua_S‹
 *
L
) {

294 * 
msg
 = 
	`lua_tou£rd©a
(
L
,1);

295 
	`luaL_checkš‹g”
(
L
,2);

296 
	`skyÃt_ä“
(
msg
);

298 
	}
}

300 
boŞ


301 
	$check_£p
(
bufãr_node
 * 
node
, 
äom
, cÚ¡ *
£p
, 
£¶’
) {

303 
sz
 = 
node
->sz - 
äom
;

304 ià(
sz
 >ğ
£¶’
) {

305  
	`memcmp
(
node
->
msg
+
äom
,
£p
,
£¶’
) == 0;

307 ià(
sz
 > 0) {

308 ià(
	`memcmp
(
node
->
msg
 + 
äom
, 
£p
, 
sz
)) {

309  
çl£
;

312 
node
 =‚ode->
Ãxt
;

313 
£p
 +ğ
sz
;

314 
£¶’
 -ğ
sz
;

315 
äom
 = 0;

317 
	}
}

325 
	$Ì—dlše
(
lua_S‹
 *
L
) {

326 
sock‘_bufãr
 * 
sb
 = 
	`lua_tou£rd©a
(
L
, 1);

327 ià(
sb
 =ğ
NULL
) {

328  
	`luaL_”rÜ
(
L
, "Need buffer object‡t…aram 1");

331 
boŞ
 
check
 = !
	`lua_i¡abË
(
L
, 2);

332 
size_t
 
£¶’
 = 0;

333 cÚ¡ *
£p
 = 
	`luaL_checkl¡ršg
(
L
,3,&
£¶’
);

334 
i
;

335 
bufãr_node
 *
cu¼’t
 = 
sb
->
h—d
;

336 ià(
cu¼’t
 =ğ
NULL
)

338 
äom
 = 
sb
->
off£t
;

339 
by‹s
 = 
cu¼’t
->
sz
 - 
äom
;

340 
i
=0;i<=
sb
->
size
 - ()
£¶’
;i++) {

341 ià(
	`check_£p
(
cu¼’t
, 
äom
, 
£p
, 
£¶’
)) {

342 ià(
check
) {

343 
	`lua_pushboŞ—n
(
L
,
Œue
);

345 
	`pİ_l¡ršg
(
L
, 
sb
, 
i
+
£¶’
, seplen);

346 
sb
->
size
 -ğ
i
+
£¶’
;

350 ++
äom
;

351 --
by‹s
;

352 ià(
by‹s
 == 0) {

353 
cu¼’t
 = cu¼’t->
Ãxt
;

354 
äom
 = 0;

355 ià(
cu¼’t
 =ğ
NULL
)

357 
by‹s
 = 
cu¼’t
->
sz
;

361 
	}
}

364 
	$l¡r2p
(
lua_S‹
 *
L
) {

365 
size_t
 
sz
 = 0;

366 cÚ¡ * 
¡r
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

367 *
±r
 = 
	`skyÃt_m®loc
(
sz
);

368 
	`memıy
(
±r
, 
¡r
, 
sz
);

369 
	`lua_pushlightu£rd©a
(
L
, 
±r
);

370 
	`lua_pushš‹g”
(
L
, ()
sz
);

372 
	}
}

383 
	$luÅack
(
lua_S‹
 *
L
) {

384 
skyÃt_sock‘_mes§ge
 *
mes§ge
 = 
	`lua_tou£rd©a
(
L
,1);

385 
size
 = 
	`luaL_checkš‹g”
(
L
,2);

387 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
ty³
);

388 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
id
);

389 
	`lua_pushš‹g”
(
L
, 
mes§ge
->
ud
);

390 ià(
mes§ge
->
bufãr
 =ğ
NULL
) {

391 
	`lua_pushl¡ršg
(
L
, (*)(
mes§ge
+1),
size
 - (*message));

393 
	`lua_pushlightu£rd©a
(
L
, 
mes§ge
->
bufãr
);

395 ià(
mes§ge
->
ty³
 =ğ
SKYNET_SOCKET_TYPE_UDP
) {

396 
addrsz
 = 0;

397 cÚ¡ * 
addr¡ršg
 = 
	`skyÃt_sock‘_udp_add»ss
(
mes§ge
, &
addrsz
);

398 ià(
addr¡ršg
) {

399 
	`lua_pushl¡ršg
(
L
, 
addr¡ršg
, 
addrsz
);

404 
	}
}

407 
	$add»ss_pÜt
(
lua_S‹
 *
L
, *
tmp
, cÚ¡ * 
addr
, 
pÜt_šdex
, *
pÜt
) {

408 cÚ¡ * 
ho¡
;

409 ià(
	`lua_i¢ÚeÜn
(
L
,
pÜt_šdex
)) {

410 
ho¡
 = 
	`¡rchr
(
addr
, '[');

411 ià(
ho¡
) {

413 ++
ho¡
;

414 cÚ¡ * 
£p
 = 
	`¡rchr
(
addr
,']');

415 ià(
£p
 =ğ
NULL
) {

416 
	`luaL_”rÜ
(
L
, "Inv®id‡dd»s %s.",
addr
);

418 
	`memıy
(
tmp
, 
ho¡
, 
£p
-host);

419 
tmp
[
£p
-
ho¡
] = '\0';

420 
ho¡
 = 
tmp
;

421 
£p
 = 
	`¡rchr
(sep + 1, ':');

422 ià(
£p
 =ğ
NULL
) {

423 
	`luaL_”rÜ
(
L
, "Inv®id‡dd»s %s.",
addr
);

425 *
pÜt
 = 
	`¡¹oul
(
£p
+1,
NULL
,10);

428 cÚ¡ * 
£p
 = 
	`¡rchr
(
addr
,':');

429 ià(
£p
 =ğ
NULL
) {

430 
	`luaL_”rÜ
(
L
, "Inv®id‡dd»s %s.",
addr
);

432 
	`memıy
(
tmp
, 
addr
, 
£p
-addr);

433 
tmp
[
£p
-
addr
] = '\0';

434 
ho¡
 = 
tmp
;

435 *
pÜt
 = 
	`¡¹oul
(
£p
+1,
NULL
,10);

438 
ho¡
 = 
addr
;

439 *
pÜt
 = 
	`luaL_İtš‹g”
(
L
,
pÜt_šdex
, 0);

441  
ho¡
;

442 
	}
}

445 
	$lcÚÃù
(
lua_S‹
 *
L
) {

446 
size_t
 
sz
 = 0;

447 cÚ¡ * 
addr
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

448 
tmp
[
sz
];

449 
pÜt
 = 0;

450 cÚ¡ * 
ho¡
 = 
	`add»ss_pÜt
(
L
, 
tmp
, 
addr
, 2, &
pÜt
);

451 ià(
pÜt
 == 0) {

452  
	`luaL_”rÜ
(
L
, "Invalid…ort");

454 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

455 
id
 = 
	`skyÃt_sock‘_cÚÃù
(
ùx
, 
ho¡
, 
pÜt
);

456 
	`lua_pushš‹g”
(
L
, 
id
);

459 
	}
}

462 
	$lşo£
(
lua_S‹
 *
L
) {

463 
id
 = 
	`luaL_checkš‹g”
(
L
,1);

464 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

465 
	`skyÃt_sock‘_şo£
(
ùx
, 
id
);

467 
	}
}

470 
	$lshutdown
(
lua_S‹
 *
L
) {

471 
id
 = 
	`luaL_checkš‹g”
(
L
,1);

472 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

473 
	`skyÃt_sock‘_shutdown
(
ùx
, 
id
);

475 
	}
}

478 
	$Îi¡’
(
lua_S‹
 *
L
) {

479 cÚ¡ * 
ho¡
 = 
	`luaL_check¡ršg
(
L
,1);

480 
pÜt
 = 
	`luaL_checkš‹g”
(
L
,2);

481 
backlog
 = 
	`luaL_İtš‹g”
(
L
,3,
BACKLOG
);

482 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

483 
id
 = 
	`skyÃt_sock‘_li¡’
(
ùx
, 
ho¡
,
pÜt
,
backlog
);

484 ià(
id
 < 0) {

485  
	`luaL_”rÜ
(
L
, "Listenƒrror");

488 
	`lua_pushš‹g”
(
L
,
id
);

490 
	}
}

492 
size_t


493 
	$couÁ_size
(
lua_S‹
 *
L
, 
šdex
) {

494 
size_t
 
’
 = 0;

495 
i
;

496 
i
=1;
	`lua_g‘i
(
L
, 
šdex
, iè!ğ
LUA_TNIL
; ++i) {

497 
size_t
 
Ën
;

498 
	`luaL_checkl¡ršg
(
L
, -1, &
Ën
);

499 
’
 +ğ
Ën
;

500 
	`lua_pİ
(
L
,1);

502 
	`lua_pİ
(
L
,1);

503  
’
;

504 
	}
}

507 
	$cÚÿt_bË
(
lua_S‹
 *
L
, 
šdex
, *
bufãr
, 
size_t
 
’
) {

508 *
±r
 = 
bufãr
;

509 
i
;

510 
i
=1;
	`lua_g‘i
(
L
, 
šdex
, iè!ğ
LUA_TNIL
; ++i) {

511 
size_t
 
Ën
;

512 cÚ¡ * 
¡r
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
Ën
);

513 ià(
¡r
 =ğ
NULL
 || 
’
 < 
Ën
) {

516 
	`memıy
(
±r
, 
¡r
, 
Ën
);

517 
±r
 +ğ
Ën
;

518 
’
 -ğ
Ën
;

519 
	`lua_pİ
(
L
,1);

521 ià(
’
 != 0) {

522 
	`skyÃt_ä“
(
bufãr
);

523 
	`luaL_”rÜ
(
L
, "Invalid stringsable");

525 
	`lua_pİ
(
L
,1);

526 
	}
}

529 
	$g‘_bufãr
(
lua_S‹
 *
L
, 
šdex
, *
sz
) {

530 *
bufãr
;

531 
	`lua_ty³
(
L
, 
šdex
)) {

532 cÚ¡ * 
¡r
;

533 
size_t
 
Ën
;

534 
LUA_TUSERDATA
:

535 
LUA_TLIGHTUSERDATA
:

536 
bufãr
 = 
	`lua_tou£rd©a
(
L
,
šdex
);

537 *
sz
 = 
	`luaL_checkš‹g”
(
L
,
šdex
+1);

539 
LUA_TTABLE
:

541 
Ën
 = 
	`couÁ_size
(
L
, 
šdex
);

542 
bufãr
 = 
	`skyÃt_m®loc
(
Ën
);

543 
	`cÚÿt_bË
(
L
, 
šdex
, 
bufãr
, 
Ën
);

544 *
sz
 = ()
Ën
;

547 
¡r
 = 
	`luaL_checkl¡ršg
(
L
, 
šdex
, &
Ën
);

548 
bufãr
 = 
	`skyÃt_m®loc
(
Ën
);

549 
	`memıy
(
bufãr
, 
¡r
, 
Ën
);

550 *
sz
 = ()
Ën
;

553  
bufãr
;

554 
	}
}

557 
	$l£nd
(
lua_S‹
 *
L
) {

558 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

559 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

560 
sz
 = 0;

561 *
bufãr
 = 
	`g‘_bufãr
(
L
, 2, &
sz
);

562 
”r
 = 
	`skyÃt_sock‘_£nd
(
ùx
, 
id
, 
bufãr
, 
sz
);

563 
	`lua_pushboŞ—n
(
L
, !
”r
);

565 
	}
}

568 
	$l£ndlow
(
lua_S‹
 *
L
) {

569 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

570 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

571 
sz
 = 0;

572 *
bufãr
 = 
	`g‘_bufãr
(
L
, 2, &
sz
);

573 
”r
 = 
	`skyÃt_sock‘_£nd_low´iÜ™y
(
ùx
, 
id
, 
bufãr
, 
sz
);

574 
	`lua_pushboŞ—n
(
L
, !
”r
);

576 
	}
}

579 
	$lbšd
(
lua_S‹
 *
L
) {

580 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

581 
fd
 = 
	`luaL_checkš‹g”
(
L
, 1);

582 
id
 = 
	`skyÃt_sock‘_bšd
(
ùx
,
fd
);

583 
	`lua_pushš‹g”
(
L
,
id
);

585 
	}
}

588 
	$l¡¬t
(
lua_S‹
 *
L
) {

589 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

590 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

591 
	`skyÃt_sock‘_¡¬t
(
ùx
,
id
);

593 
	}
}

596 
	$Êod–ay
(
lua_S‹
 *
L
) {

597 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

598 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

599 
	`skyÃt_sock‘_nod–ay
(
ùx
,
id
);

601 
	}
}

604 
	$ludp
(
lua_S‹
 *
L
) {

605 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

606 
size_t
 
sz
 = 0;

607 cÚ¡ * 
addr
 = 
	`lua_tŞ¡ršg
(
L
,1,&
sz
);

608 
tmp
[
sz
];

609 
pÜt
 = 0;

610 cÚ¡ * 
ho¡
 = 
NULL
;

611 ià(
addr
) {

612 
ho¡
 = 
	`add»ss_pÜt
(
L
, 
tmp
, 
addr
, 2, &
pÜt
);

615 
id
 = 
	`skyÃt_sock‘_udp
(
ùx
, 
ho¡
, 
pÜt
);

616 ià(
id
 < 0) {

617  
	`luaL_”rÜ
(
L
, "udp init failed");

619 
	`lua_pushš‹g”
(
L
, 
id
);

621 
	}
}

624 
	$ludp_cÚÃù
(
lua_S‹
 *
L
) {

625 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

626 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

627 
size_t
 
sz
 = 0;

628 cÚ¡ * 
addr
 = 
	`luaL_checkl¡ršg
(
L
,2,&
sz
);

629 
tmp
[
sz
];

630 
pÜt
 = 0;

631 cÚ¡ * 
ho¡
 = 
NULL
;

632 ià(
addr
) {

633 
ho¡
 = 
	`add»ss_pÜt
(
L
, 
tmp
, 
addr
, 3, &
pÜt
);

636 ià(
	`skyÃt_sock‘_udp_cÚÃù
(
ùx
, 
id
, 
ho¡
, 
pÜt
)) {

637  
	`luaL_”rÜ
(
L
, "udp connect failed");

641 
	}
}

644 
	$ludp_£nd
(
lua_S‹
 *
L
) {

645 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

646 
id
 = 
	`luaL_checkš‹g”
(
L
, 1);

647 cÚ¡ * 
add»ss
 = 
	`luaL_check¡ršg
(
L
, 2);

648 
sz
 = 0;

649 *
bufãr
 = 
	`g‘_bufãr
(
L
, 3, &
sz
);

650 
”r
 = 
	`skyÃt_sock‘_udp_£nd
(
ùx
, 
id
, 
add»ss
, 
bufãr
, 
sz
);

652 
	`lua_pushboŞ—n
(
L
, !
”r
);

655 
	}
}

658 
	$ludp_add»ss
(
lua_S‹
 *
L
) {

659 
size_t
 
sz
 = 0;

660 cÚ¡ 
ušt8_t
 * 
addr
 = (cÚ¡ ušt8_ˆ*)
	`luaL_checkl¡ršg
(
L
, 1, &
sz
);

661 
ušt16_t
 
pÜt
 = 0;

662 
	`memıy
(&
pÜt
, 
addr
+1, (
ušt16_t
));

663 
pÜt
 = 
	`Áohs
(port);

664 cÚ¡ * 
¤c
 = 
addr
+3;

665 
tmp
[256];

666 
çmy
;

667 ià(
sz
 == 1+2+4) {

668 
çmy
 = 
AF_INET
;

670 ià(
sz
 != 1+2+16) {

671  
	`luaL_”rÜ
(
L
, "Invalid udp‡ddress");

673 
çmy
 = 
AF_INET6
;

675 ià(
	`š‘_Áİ
(
çmy
, 
¤c
, 
tmp
, Ñmp)è=ğ
NULL
) {

676  
	`luaL_”rÜ
(
L
, "Invalid udp‡ddress");

678 
	`lua_push¡ršg
(
L
, 
tmp
);

679 
	`lua_pushš‹g”
(
L
, 
pÜt
);

681 
	}
}

683 
LUAMOD_API
 

684 
	$luaİ’_skyÃt_sock‘driv”
(
lua_S‹
 *
L
) {

685 
	`luaL_checkv”siÚ
(
L
);

686 
luaL_Reg
 
l
[] = {

687 { "bufãr", 
Êewbufãr
 },

688 { "push", 
Íushbufãr
 },

689 { "pİ", 
Íİbufãr
 },

690 { "drİ", 
ldrİ
 },

691 { "»ad®l", 
Ì—d®l
 },

692 { "ş—r", 
lş—rbufãr
 },

693 { "»adlše", 
Ì—dlše
 },

694 { "¡r2p", 
l¡r2p
 },

695 { "h—d”", 
lh—d”
 },

697 { "uÅack", 
luÅack
 },

698 { 
NULL
, NULL },

700 
	`luaL_Ãwlib
(
L
,
l
);

701 
luaL_Reg
 
l2
[] = {

702 { "cÚÃù", 
lcÚÃù
 },

703 { "şo£", 
lşo£
 },

704 { "shutdown", 
lshutdown
 },

705 { "li¡’", 
Îi¡’
 },

706 { "£nd", 
l£nd
 },

707 { "l£nd", 
l£ndlow
 },

708 { "bšd", 
lbšd
 },

709 { "¡¬t", 
l¡¬t
 },

710 { "nod–ay", 
Êod–ay
 },

711 { "udp", 
ludp
 },

712 { "udp_cÚÃù", 
ludp_cÚÃù
 },

713 { "udp_£nd", 
ludp_£nd
 },

714 { "udp_add»ss", 
ludp_add»ss
 },

715 { 
NULL
, NULL },

717 
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "skynet_context");

718 
skyÃt_cÚ‹xt
 *
ùx
 = 
	`lua_tou£rd©a
(
L
,-1);

719 ià(
ùx
 =ğ
NULL
) {

720  
	`luaL_”rÜ
(
L
, "Init skynet context first");

723 
	`luaL_£tfuncs
(
L
,
l2
,1);

726 
	}
}

	@lualib-src/lua-stm.c

1 
	#LUA_LIB


	)

3 
	~<lua.h
>

4 
	~<Ïuxlib.h
>

5 
	~<¡dlib.h
>

6 
	~<¡dšt.h
>

7 
	~<as£¹.h
>

8 
	~<¡ršg.h
>

10 
	~"rwlock.h
"

11 
	~"skyÃt_m®loc.h
"

12 
	~"©omic.h
"

14 
	s¡m_objeù
 {

15 
rwlock
 
	mlock
;

16 
	m»ã»nû
;

17 
¡m_cİy
 * 
	mcİy
;

20 
	s¡m_cİy
 {

21 
	m»ã»nû
;

22 
ušt32_t
 
	msz
;

23 * 
	mmsg
;

27 
¡m_cİy
 *

28 
	$¡m_Ãwcİy
(* 
msg
, 
št32_t
 
sz
) {

29 
¡m_cİy
 * 
cİy
 = 
	`skyÃt_m®loc
((*copy));

30 
cİy
->
»ã»nû
 = 1;

31 
cİy
->
sz
 = sz;

32 
cİy
->
msg
 = msg;

34  
cİy
;

35 
	}
}

37 
¡m_objeù
 *

38 
	$¡m_Ãw
(* 
msg
, 
št32_t
 
sz
) {

39 
¡m_objeù
 * 
obj
 = 
	`skyÃt_m®loc
((*obj));

40 
	`rwlock_š™
(&
obj
->
lock
);

41 
obj
->
»ã»nû
 = 1;

42 
obj
->
cİy
 = 
	`¡m_Ãwcİy
(
msg
, 
sz
);

44  
obj
;

45 
	}
}

48 
	$¡m_»Ëa£cİy
(
¡m_cİy
 *
cİy
) {

49 ià(
cİy
 =ğ
NULL
)

51 ià(
	`ATOM_DEC
(&
cİy
->
»ã»nû
) == 0) {

52 
	`skyÃt_ä“
(
cİy
->
msg
);

53 
	`skyÃt_ä“
(
cİy
);

55 
	}
}

58 
	$¡m_»Ëa£
(
¡m_objeù
 *
obj
) {

59 
	`as£¹
(
obj
->
cİy
);

60 
	`rwlock_wlock
(&
obj
->
lock
);

62 
	`¡m_»Ëa£cİy
(
obj
->
cİy
);

63 
obj
->
cİy
 = 
NULL
;

64 ià(--
obj
->
»ã»nû
 > 0) {

66 
	`rwlock_wuÆock
(&
obj
->
lock
);

70 
	`skyÃt_ä“
(
obj
);

71 
	}
}

74 
	$¡m_»Ëa£»ad”
(
¡m_objeù
 *
obj
) {

75 
	`rwlock_¾ock
(&
obj
->
lock
);

76 ià(
	`ATOM_DEC
(&
obj
->
»ã»nû
) == 0) {

78 
	`as£¹
(
obj
->
cİy
 =ğ
NULL
);

79 
	`skyÃt_ä“
(
obj
);

82 
	`rwlock_ruÆock
(&
obj
->
lock
);

83 
	}
}

86 
	$¡m_g¿b
(
¡m_objeù
 *
obj
) {

87 
	`rwlock_¾ock
(&
obj
->
lock
);

88 
»f
 = 
	`ATOM_FINC
(&
obj
->
»ã»nû
);

89 
	`rwlock_ruÆock
(&
obj
->
lock
);

90 
	`as£¹
(
»f
 > 0);

91 
	}
}

93 
¡m_cİy
 *

94 
	$¡m_cİy
(
¡m_objeù
 *
obj
) {

95 
	`rwlock_¾ock
(&
obj
->
lock
);

96 
¡m_cİy
 * 
»t
 = 
obj
->
cİy
;

97 ià(
»t
) {

98 
»f
 = 
	`ATOM_FINC
(&
»t
->
»ã»nû
);

99 
	`as£¹
(
»f
 > 0);

101 
	`rwlock_ruÆock
(&
obj
->
lock
);

103  
»t
;

104 
	}
}

107 
	$¡m_upd©e
(
¡m_objeù
 *
obj
, *
msg
, 
št32_t
 
sz
) {

108 
¡m_cİy
 *
cİy
 = 
	`¡m_Ãwcİy
(
msg
, 
sz
);

109 
	`rwlock_wlock
(&
obj
->
lock
);

110 
¡m_cİy
 *
Şdcİy
 = 
obj
->
cİy
;

111 
obj
->
cİy
 = copy;

112 
	`rwlock_wuÆock
(&
obj
->
lock
);

114 
	`¡m_»Ëa£cİy
(
Şdcİy
);

115 
	}
}

119 
	sbox¡m
 {

120 
¡m_objeù
 * 
	mobj
;

124 
	$lcİy
(
lua_S‹
 *
L
) {

125 
box¡m
 * 
box
 = 
	`lua_tou£rd©a
(
L
, 1);

126 
	`¡m_g¿b
(
box
->
obj
);

127 
	`lua_pushlightu£rd©a
(
L
, 
box
->
obj
);

129 
	}
}

132 
	$Êewwr™”
(
lua_S‹
 *
L
) {

133 * 
msg
;

134 
size_t
 
sz
;

135 ià(
	`lua_isu£rd©a
(
L
,1)) {

136 
msg
 = 
	`lua_tou£rd©a
(
L
, 1);

137 
sz
 = (
size_t
)
	`luaL_checkš‹g”
(
L
, 2);

139 cÚ¡ * 
tmp
 = 
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

140 
msg
 = 
	`skyÃt_m®loc
(
sz
);

141 
	`memıy
(
msg
, 
tmp
, 
sz
);

143 
box¡m
 * 
box
 = 
	`lua_Ãwu£rd©a
(
L
, (*box));

144 
box
->
obj
 = 
	`¡m_Ãw
(
msg
,
sz
);

145 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

146 
	`lua_£tm‘©abË
(
L
, -2);

149 
	}
}

152 
	$ld–‘ewr™”
(
lua_S‹
 *
L
) {

153 
box¡m
 * 
box
 = 
	`lua_tou£rd©a
(
L
, 1);

154 
	`¡m_»Ëa£
(
box
->
obj
);

155 
box
->
obj
 = 
NULL
;

158 
	}
}

161 
	$lupd©e
(
lua_S‹
 *
L
) {

162 
box¡m
 * 
box
 = 
	`lua_tou£rd©a
(
L
, 1);

163 * 
msg
;

164 
size_t
 
sz
;

165 ià(
	`lua_isu£rd©a
(
L
, 2)) {

166 
msg
 = 
	`lua_tou£rd©a
(
L
, 2);

167 
sz
 = (
size_t
)
	`luaL_checkš‹g”
(
L
, 3);

169 cÚ¡ * 
tmp
 = 
	`luaL_checkl¡ršg
(
L
,2,&
sz
);

170 
msg
 = 
	`skyÃt_m®loc
(
sz
);

171 
	`memıy
(
msg
, 
tmp
, 
sz
);

173 
	`¡m_upd©e
(
box
->
obj
, 
msg
, 
sz
);

176 
	}
}

178 
	sbox»ad”
 {

179 
¡m_objeù
 *
	mobj
;

180 
¡m_cİy
 *
	mÏ¡cİy
;

184 
	$Êew»ad”
(
lua_S‹
 *
L
) {

185 
box»ad”
 * 
box
 = 
	`lua_Ãwu£rd©a
(
L
, (*box));

186 
box
->
obj
 = 
	`lua_tou£rd©a
(
L
, 1);

187 
box
->
Ï¡cİy
 = 
NULL
;

188 
	`lua_pushv®ue
(
L
, 
	`lua_upv®uešdex
(1));

189 
	`lua_£tm‘©abË
(
L
, -2);

192 
	}
}

195 
	$ld–‘”—d”
(
lua_S‹
 *
L
) {

196 
box»ad”
 * 
box
 = 
	`lua_tou£rd©a
(
L
, 1);

197 
	`¡m_»Ëa£»ad”
(
box
->
obj
);

198 
box
->
obj
 = 
NULL
;

199 
	`¡m_»Ëa£cİy
(
box
->
Ï¡cİy
);

200 
box
->
Ï¡cİy
 = 
NULL
;

203 
	}
}

206 
	$Ì—d
(
lua_S‹
 *
L
) {

207 
box»ad”
 * 
box
 = 
	`lua_tou£rd©a
(
L
, 1);

208 
	`luaL_checkty³
(
L
, 2, 
LUA_TFUNCTION
);

210 
¡m_cİy
 * 
cİy
 = 
	`¡m_cİy
(
box
->
obj
);

211 ià(
cİy
 =ğ
box
->
Ï¡cİy
) {

213 
	`¡m_»Ëa£cİy
(
cİy
);

214 
	`lua_pushboŞ—n
(
L
, 0);

218 
	`¡m_»Ëa£cİy
(
box
->
Ï¡cİy
);

219 
box
->
Ï¡cİy
 = 
cİy
;

220 ià(
cİy
) {

221 
	`lua_£‰İ
(
L
, 3);

222 
	`lua_»¶aû
(
L
, 1);

223 
	`lua_£‰İ
(
L
, 2);

224 
	`lua_pushlightu£rd©a
(
L
, 
cİy
->
msg
);

225 
	`lua_pushš‹g”
(
L
, 
cİy
->
sz
);

226 
	`lua_pushv®ue
(
L
, 1);

227 
	`lua_ÿÎ
(
L
, 3, 
LUA_MULTRET
);

228 
	`lua_pushboŞ—n
(
L
, 1);

229 
	`lua_»¶aû
(
L
, 1);

230  
	`lua_g‘tİ
(
L
);

232 
	`lua_pushboŞ—n
(
L
, 0);

235 
	}
}

237 
LUAMOD_API
 

238 
	$luaİ’_skyÃt_¡m
(
lua_S‹
 *
L
) {

239 
	`luaL_checkv”siÚ
(
L
);

240 
	`lua_ü—‹bË
(
L
, 0, 3);

242 
	`lua_pushcfunùiÚ
(
L
, 
lcİy
);

243 
	`lua_£tf›ld
(
L
, -2, "copy");

245 
luaL_Reg
 
wr™”
[] = {

246 { "Ãw", 
Êewwr™”
 },

247 { 
NULL
, NULL },

249 
	`lua_ü—‹bË
(
L
, 0, 2);

250 
	`lua_pushcfunùiÚ
(
L
, 
ld–‘ewr™”
),

251 
	`lua_£tf›ld
(
L
, -2, "__gc");

252 
	`lua_pushcfunùiÚ
(
L
, 
lupd©e
),

253 
	`lua_£tf›ld
(
L
, -2, "__call");

254 
	`luaL_£tfuncs
(
L
, 
wr™”
, 1);

256 
luaL_Reg
 
»ad”
[] = {

257 { "Ãwcİy", 
Êew»ad”
 },

258 { 
NULL
, NULL },

260 
	`lua_ü—‹bË
(
L
, 0, 2);

261 
	`lua_pushcfunùiÚ
(
L
, 
ld–‘”—d”
),

262 
	`lua_£tf›ld
(
L
, -2, "__gc");

263 
	`lua_pushcfunùiÚ
(
L
, 
Ì—d
),

264 
	`lua_£tf›ld
(
L
, -2, "__call");

265 
	`luaL_£tfuncs
(
L
, 
»ad”
, 1);

268 
	}
}

	@lualib-src/lua_a_star.c

1 
	~"lua_a_¡¬.h
"

	@lualib-src/lua_a_star.h

1 #iâdeà
KING_BUFFALO_UTILS_A_STAART


2 
	#KING_BUFFALO_UTILS_A_STAART


	)

	@lualib-src/sproto/lsproto.c

1 
	#LUA_LIB


	)

3 
	~<¡ršg.h
>

4 
	~<¡dlib.h
>

5 
	~"msvcšt.h
"

7 
	~"lua.h
"

8 
	~"Ïuxlib.h
"

9 
	~"¥rÙo.h
"

11 
	#MAX_GLOBALSPROTO
 16

	)

12 
	#ENCODE_BUFFERSIZE
 2050

	)

14 
	#ENCODE_MAXSIZE
 0x1000000

	)

15 
	#ENCODE_DEEPLEVEL
 64

	)

17 #iâdeà
luaL_Ãwlib


23 
LUALIB_API
 
	$luaL_£tfuncs
 (
lua_S‹
 *
L
, cÚ¡ 
luaL_Reg
 *
l
, 
nup
) {

24 #ifdeà
luaL_checkv”siÚ


25 
	`luaL_checkv”siÚ
(
L
);

27 
	`luaL_check¡ack
(
L
, 
nup
, "too many upvalues");

28 ; 
l
->
Çme
 !ğ
NULL
;†++) {

29 
i
;

30 
i
 = 0; i < 
nup
; i++)

31 
	`lua_pushv®ue
(
L
, -
nup
);

32 
	`lua_pushcşosu»
(
L
, 
l
->
func
, 
nup
);

33 
	`lua_£tf›ld
(
L
, -(
nup
 + 2), 
l
->
Çme
);

35 
	`lua_pİ
(
L
, 
nup
);

36 
	}
}

38 
	#luaL_ÃwlibbË
(
L
,
l
) \

39 
	`lua_ü—‹bË
(
L
, 0, (
l
)/(Ö)[0]è- 1)

	)

41 
	#luaL_Ãwlib
(
L
,
l
è(
	`luaL_ÃwlibbË
(L,l), 
	`luaL_£tfuncs
(L,l,0))

	)

44 #ià
LUA_VERSION_NUM
 < 503

46 #ià
LUA_VERSION_NUM
 < 502

47 
št64_t
 
	$lua_toš‹g”x
(
lua_S‹
 *
L
, 
idx
, *
i¢um
) {

48 ià(
	`lua_i¢umb”
(
L
, 
idx
)) {

49 ià(
i¢um
) *isnum = 1;

50  (
št64_t
)
	`lua_toš‹g”
(
L
, 
idx
);

53 ià(
i¢um
) *isnum = 0;

56 
	}
}

60 
	#lua_g‘i
 
lua_¿wg‘i


	)

61 
	#lua_£ti
 
lua_¿w£ti


	)

66 
	$Êew´Ùo
(
lua_S‹
 *
L
) {

67 
¥rÙo
 * 
¥
;

68 
size_t
 
sz
;

69 * 
bufãr
 = (*)
	`luaL_checkl¡ršg
(
L
,1,&
sz
);

70 
¥
 = 
	`¥rÙo_ü—‹
(
bufãr
, 
sz
);

71 ià(
¥
) {

72 
	`lua_pushlightu£rd©a
(
L
, 
¥
);

76 
	}
}

79 
	$ld–‘•rÙo
(
lua_S‹
 *
L
) {

80 
¥rÙo
 * 
¥
 = 
	`lua_tou£rd©a
(
L
,1);

81 ià(
¥
 =ğ
NULL
) {

82  
	`luaL_¬g”rÜ
(
L
, 1, "Need‡ sproto object");

84 
	`¥rÙo_»Ëa£
(
¥
);

86 
	}
}

89 
	$lqu”yty³
(
lua_S‹
 *
L
) {

90 cÚ¡ * 
ty³_Çme
;

91 
¥rÙo
 *
¥
 = 
	`lua_tou£rd©a
(
L
,1);

92 
¥rÙo_ty³
 *
¡
;

93 ià(
¥
 =ğ
NULL
) {

94  
	`luaL_¬g”rÜ
(
L
, 1, "Need‡ sproto object");

96 
ty³_Çme
 = 
	`luaL_check¡ršg
(
L
,2);

97 
¡
 = 
	`¥rÙo_ty³
(
¥
, 
ty³_Çme
);

98 ià(
¡
) {

99 
	`lua_pushlightu£rd©a
(
L
, 
¡
);

103 
	}
}

105 
	s’code_ud
 {

106 
lua_S‹
 *
	mL
;

107 
¥rÙo_ty³
 *
	m¡
;

108 
	mtbl_šdex
;

109 cÚ¡ * 
	m¬¿y_g
;

110 
	m¬¿y_šdex
;

111 
	md“p
;

112 
	m™”_šdex
;

116 
	$’code
(cÚ¡ 
¥rÙo_¬g
 *
¬gs
) {

117 
’code_ud
 *
£lf
 = 
¬gs
->
ud
;

118 
lua_S‹
 *
L
 = 
£lf
->L;

119 ià(
£lf
->
d“p
 >ğ
ENCODE_DEEPLEVEL
)

120  
	`luaL_”rÜ
(
L
, "Theable isoo deep");

121 ià(
¬gs
->
šdex
 > 0) {

122 ià(
¬gs
->
gÇme
 !ğ
£lf
->
¬¿y_g
) {

124 
£lf
->
¬¿y_g
 = 
¬gs
->
gÇme
;

125 
	`lua_g‘f›ld
(
L
, 
£lf
->
tbl_šdex
, 
¬gs
->
gÇme
);

126 ià(
	`lua_i¢
(
L
, -1)) {

127 ià(
£lf
->
¬¿y_šdex
) {

128 
	`lua_»¶aû
(
L
, 
£lf
->
¬¿y_šdex
);

130 
£lf
->
¬¿y_šdex
 = 0;

131  
SPROTO_CB_NOARRAY
;

133 ià(!
	`lua_i¡abË
(
L
, -1)) {

134  
	`luaL_”rÜ
(
L
, ".*%s(%d) should be‡able (Is‡ %s)",

135 
¬gs
->
gÇme
,‡rgs->
šdex
, 
	`lua_ty³Çme
(
L
, 
	`lua_ty³
(L, -1)));

137 ià(
£lf
->
¬¿y_šdex
) {

138 
	`lua_»¶aû
(
L
, 
£lf
->
¬¿y_šdex
);

140 
£lf
->
¬¿y_šdex
 = 
	`lua_g‘tİ
(
L
);

143 ià(
¬gs
->
maššdex
 >= 0) {

147 
	`lua_pushv®ue
(
L
,
£lf
->
™”_šdex
);

148 ià(!
	`lua_Ãxt
(
L
, 
£lf
->
¬¿y_šdex
)) {

150 
	`lua_pushn
(
L
);

151 
	`lua_»¶aû
(
L
, 
£lf
->
™”_šdex
);

152  
SPROTO_CB_NIL
;

154 
	`lua_š£¹
(
L
, -2);

155 
	`lua_»¶aû
(
L
, 
£lf
->
™”_šdex
);

157 
	`lua_g‘i
(
L
, 
£lf
->
¬¿y_šdex
, 
¬gs
->
šdex
);

160 
	`lua_g‘f›ld
(
L
, 
£lf
->
tbl_šdex
, 
¬gs
->
gÇme
);

162 ià(
	`lua_i¢
(
L
, -1)) {

163 
	`lua_pİ
(
L
,1);

164  
SPROTO_CB_NIL
;

166 
¬gs
->
ty³
) {

167 
SPROTO_TINTEGER
: {

168 
št64_t
 
v
;

169 
lua_IÁeg”
 
vh
;

170 
i¢um
;

171 ià(
¬gs
->
exŒa
) {

173 
lua_Numb”
 
vn
 = 
	`lua_tÚumb”
(
L
, -1);

175 
v
 = (
št64_t
)(
vn
 * 
¬gs
->
exŒa
 + 0.5);

177 
v
 = 
	`lua_toš‹g”x
(
L
, -1, &
i¢um
);

178 if(!
i¢um
) {

179  
	`luaL_”rÜ
(
L
, ".%s[%d] is‚ot‡n integer (Is‡ %s)",

180 
¬gs
->
gÇme
,‡rgs->
šdex
, 
	`lua_ty³Çme
(
L
, 
	`lua_ty³
(L, -1)));

183 
	`lua_pİ
(
L
,1);

185 
vh
 = 
v
 >> 31;

186 ià(
vh
 == 0 || vh == -1) {

187 *(
ušt32_t
 *)
¬gs
->
v®ue
 = (ušt32_t)
v
;

191 *(
ušt64_t
 *)
¬gs
->
v®ue
 = (ušt64_t)
v
;

195 
SPROTO_TBOOLEAN
: {

196 
v
 = 
	`lua_toboŞ—n
(
L
, -1);

197 ià(!
	`lua_isboŞ—n
(
L
,-1)) {

198  
	`luaL_”rÜ
(
L
, ".%s[%d] is‚ot‡ boolean (Is‡ %s)",

199 
¬gs
->
gÇme
,‡rgs->
šdex
, 
	`lua_ty³Çme
(
L
, 
	`lua_ty³
(L, -1)));

201 *(*)
¬gs
->
v®ue
 = 
v
;

202 
	`lua_pİ
(
L
,1);

205 
SPROTO_TSTRING
: {

206 
size_t
 
sz
 = 0;

207 cÚ¡ * 
¡r
;

208 ià(!
	`lua_is¡ršg
(
L
, -1)) {

209  
	`luaL_”rÜ
(
L
, ".%s[%d] is‚ot‡ string (Is‡ %s)",

210 
¬gs
->
gÇme
,‡rgs->
šdex
, 
	`lua_ty³Çme
(
L
, 
	`lua_ty³
(L, -1)));

212 
¡r
 = 
	`lua_tŞ¡ršg
(
L
, -1, &
sz
);

214 ià(
sz
 > 
¬gs
->
Ëngth
)

215  
SPROTO_CB_ERROR
;

216 
	`memıy
(
¬gs
->
v®ue
, 
¡r
, 
sz
);

217 
	`lua_pİ
(
L
,1);

218  
sz
;

220 
SPROTO_TSTRUCT
: {

221 
’code_ud
 
sub
;

222 
r
;

223 
tİ
 = 
	`lua_g‘tİ
(
L
);

224 ià(!
	`lua_i¡abË
(
L
, 
tİ
)) {

225  
	`luaL_”rÜ
(
L
, ".%s[%d] is‚ot‡able (Is‡ %s)",

226 
¬gs
->
gÇme
,‡rgs->
šdex
, 
	`lua_ty³Çme
(
L
, 
	`lua_ty³
(L, -1)));

228 
sub
.
L
 = L;

229 
sub
.
¡
 = 
¬gs
->
subty³
;

230 
sub
.
tbl_šdex
 = 
tİ
;

231 
sub
.
¬¿y_g
 = 
NULL
;

232 
sub
.
¬¿y_šdex
 = 0;

233 
sub
.
d“p
 = 
£lf
->deep + 1;

234 
	`lua_pushn
(
L
);

235 
sub
.
™”_šdex
 = sub.
tbl_šdex
 + 1;

236 
r
 = 
	`¥rÙo_’code
(
¬gs
->
subty³
,‡rgs->
v®ue
,‡rgs->
Ëngth
, 
’code
, &
sub
);

237 
	`lua_£‰İ
(
L
, 
tİ
-1);

238 ià(
r
 < 0)

239  
SPROTO_CB_ERROR
;

240  
r
;

243  
	`luaL_”rÜ
(
L
, "Inv®id f›ldy³ %d", 
¬gs
->
ty³
);

245 
	}
}

248 
	$ex·nd_bufãr
(
lua_S‹
 *
L
, 
osz
, 
nsz
) {

249 *
ouut
;

251 
osz
 *= 2;

252 } 
osz
 < 
nsz
);

253 ià(
osz
 > 
ENCODE_MAXSIZE
) {

254 
	`luaL_”rÜ
(
L
, "objeù i toØÏrg(>%d)", 
ENCODE_MAXSIZE
);

255  
NULL
;

257 
ouut
 = 
	`lua_Ãwu£rd©a
(
L
, 
osz
);

258 
	`lua_»¶aû
(
L
, 
	`lua_upv®uešdex
(1));

259 
	`lua_pushš‹g”
(
L
, 
osz
);

260 
	`lua_»¶aû
(
L
, 
	`lua_upv®uešdex
(2));

262  
ouut
;

263 
	}
}

272 
	$Ëncode
(
lua_S‹
 *
L
) {

273 
’code_ud
 
£lf
;

274 * 
bufãr
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

275 
sz
 = 
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(2));

276 
tbl_šdex
 = 2;

277 
¥rÙo_ty³
 * 
¡
 = 
	`lua_tou£rd©a
(
L
, 1);

278 ià(
¡
 =ğ
NULL
) {

279 
	`luaL_checkty³
(
L
, 
tbl_šdex
, 
LUA_TNIL
);

280 
	`lua_push¡ršg
(
L
, "");

283 
	`luaL_checkty³
(
L
, 
tbl_šdex
, 
LUA_TTABLE
);

284 
	`luaL_check¡ack
(
L
, 
ENCODE_DEEPLEVEL
*2 + 8, 
NULL
);

285 
£lf
.
L
 = L;

286 
£lf
.
¡
 = st;

287 
£lf
.
tbl_šdex
 =bl_index;

289 
r
;

290 
£lf
.
¬¿y_g
 = 
NULL
;

291 
£lf
.
¬¿y_šdex
 = 0;

292 
£lf
.
d“p
 = 0;

294 
	`lua_£‰İ
(
L
, 
tbl_šdex
);

295 
	`lua_pushn
(
L
);

296 
£lf
.
™”_šdex
 = 
tbl_šdex
+1;

298 
r
 = 
	`¥rÙo_’code
(
¡
, 
bufãr
, 
sz
, 
’code
, &
£lf
);

299 ià(
r
<0) {

300 
bufãr
 = 
	`ex·nd_bufãr
(
L
, 
sz
, sz*2);

301 
sz
 *= 2;

303 
	`lua_pushl¡ršg
(
L
, 
bufãr
, 
r
);

307 
	}
}

309 
	sdecode_ud
 {

310 
lua_S‹
 *
	mL
;

311 cÚ¡ * 
	m¬¿y_g
;

312 
	m¬¿y_šdex
;

313 
	m»suÉ_šdex
;

314 
	md“p
;

315 
	mmaššdex_g
;

316 
	mkey_šdex
;

320 
	$decode
(cÚ¡ 
¥rÙo_¬g
 *
¬gs
) {

321 
decode_ud
 * 
£lf
 = 
¬gs
->
ud
;

322 
lua_S‹
 *
L
 = 
£lf
->L;

323 ià(
£lf
->
d“p
 >ğ
ENCODE_DEEPLEVEL
)

324  
	`luaL_”rÜ
(
L
, "Theable isoo deep");

325 ià(
¬gs
->
šdex
 != 0) {

327 ià(
¬gs
->
gÇme
 !ğ
£lf
->
¬¿y_g
) {

328 
£lf
->
¬¿y_g
 = 
¬gs
->
gÇme
;

329 
	`lua_ÃwbË
(
L
);

330 
	`lua_pushv®ue
(
L
, -1);

331 
	`lua_£tf›ld
(
L
, 
£lf
->
»suÉ_šdex
, 
¬gs
->
gÇme
);

332 ià(
£lf
->
¬¿y_šdex
) {

333 
	`lua_»¶aû
(
L
, 
£lf
->
¬¿y_šdex
);

335 
£lf
->
¬¿y_šdex
 = 
	`lua_g‘tİ
(
L
);

337 ià(
¬gs
->
šdex
 < 0) {

343 
¬gs
->
ty³
) {

344 
SPROTO_TINTEGER
: {

346 ià(
¬gs
->
exŒa
) {

348 
št64_t
 
v
 = *(št64_t*)
¬gs
->
v®ue
;

349 
lua_Numb”
 
vn
 = (lua_Numb”)
v
;

350 
vn
 /ğ
¬gs
->
exŒa
;

351 
	`lua_pushnumb”
(
L
, 
vn
);

353 
št64_t
 
v
 = *(št64_t*)
¬gs
->
v®ue
;

354 
	`lua_pushš‹g”
(
L
, 
v
);

358 
SPROTO_TBOOLEAN
: {

359 
v
 = *(
ušt64_t
*)
¬gs
->
v®ue
;

360 
	`lua_pushboŞ—n
(
L
,
v
);

363 
SPROTO_TSTRING
: {

364 
	`lua_pushl¡ršg
(
L
, 
¬gs
->
v®ue
,‡rgs->
Ëngth
);

367 
SPROTO_TSTRUCT
: {

368 
decode_ud
 
sub
;

369 
r
;

370 
	`lua_ÃwbË
(
L
);

371 
sub
.
L
 = L;

372 
sub
.
»suÉ_šdex
 = 
	`lua_g‘tİ
(
L
);

373 
sub
.
d“p
 = 
£lf
->deep + 1;

374 
sub
.
¬¿y_šdex
 = 0;

375 
sub
.
¬¿y_g
 = 
NULL
;

376 ià(
¬gs
->
maššdex
 >= 0) {

378 
sub
.
maššdex_g
 = 
¬gs
->
maššdex
;

379 
	`lua_pushn
(
L
);

380 
sub
.
key_šdex
 = 
	`lua_g‘tİ
(
L
);

382 
r
 = 
	`¥rÙo_decode
(
¬gs
->
subty³
,‡rgs->
v®ue
,‡rgs->
Ëngth
, 
decode
, &
sub
);

383 ià(
r
 < 0)

384  
SPROTO_CB_ERROR
;

385 ià(
r
 !ğ
¬gs
->
Ëngth
)

386  
r
;

387 
	`lua_pushv®ue
(
L
, 
sub
.
key_šdex
);

388 ià(
	`lua_i¢
(
L
, -1)) {

389 
	`luaL_”rÜ
(
L
, "Cª'ˆfšd maš index (g=%dèš [%s]", 
¬gs
->
maššdex
,‡rgs->
gÇme
);

391 
	`lua_pushv®ue
(
L
, 
sub
.
»suÉ_šdex
);

392 
	`lua_£‰abË
(
L
, 
£lf
->
¬¿y_šdex
);

393 
	`lua_£‰İ
(
L
, 
sub
.
»suÉ_šdex
-1);

396 
sub
.
maššdex_g
 = -1;

397 
sub
.
key_šdex
 = 0;

398 
r
 = 
	`¥rÙo_decode
(
¬gs
->
subty³
,‡rgs->
v®ue
,‡rgs->
Ëngth
, 
decode
, &
sub
);

399 ià(
r
 < 0)

400  
SPROTO_CB_ERROR
;

401 ià(
r
 !ğ
¬gs
->
Ëngth
)

402  
r
;

403 
	`lua_£‰İ
(
L
, 
sub
.
»suÉ_šdex
);

408 
	`luaL_”rÜ
(
L
, "Invalidype");

410 ià(
¬gs
->
šdex
 > 0) {

411 
	`lua_£ti
(
L
, 
£lf
->
¬¿y_šdex
, 
¬gs
->
šdex
);

413 ià(
£lf
->
maššdex_g
 =ğ
¬gs
->
gid
) {

416 
	`lua_pushv®ue
(
L
,-1);

417 
	`lua_»¶aû
(
L
, 
£lf
->
key_šdex
);

419 
	`lua_£tf›ld
(
L
, 
£lf
->
»suÉ_šdex
, 
¬gs
->
gÇme
);

423 
	}
}

426 
	$g‘bufãr
(
lua_S‹
 *
L
, 
šdex
, 
size_t
 *
sz
) {

427 cÚ¡ * 
bufãr
 = 
NULL
;

428 
t
 = 
	`lua_ty³
(
L
, 
šdex
);

429 ià(
t
 =ğ
LUA_TSTRING
) {

430 
bufãr
 = 
	`lua_tŞ¡ršg
(
L
, 
šdex
, 
sz
);

432 ià(
t
 !ğ
LUA_TUSERDATA
 && !ğ
LUA_TLIGHTUSERDATA
) {

433 
	`luaL_¬g”rÜ
(
L
, 
šdex
, "Need‡ string or userdata");

434  
NULL
;

436 
bufãr
 = 
	`lua_tou£rd©a
(
L
, 
šdex
);

437 *
sz
 = 
	`luaL_checkš‹g”
(
L
, 
šdex
+1);

439  
bufãr
;

440 
	}
}

448 
	$ldecode
(
lua_S‹
 *
L
) {

449 
¥rÙo_ty³
 * 
¡
 = 
	`lua_tou£rd©a
(
L
, 1);

450 cÚ¡ * 
bufãr
;

451 
decode_ud
 
£lf
;

452 
size_t
 
sz
;

453 
r
;

454 ià(
¡
 =ğ
NULL
) {

458 
sz
 = 0;

459 
bufãr
 = 
	`g‘bufãr
(
L
, 2, &
sz
);

460 ià(!
	`lua_i¡abË
(
L
, -1)) {

461 
	`lua_ÃwbË
(
L
);

463 
	`luaL_check¡ack
(
L
, 
ENCODE_DEEPLEVEL
*3 + 8, 
NULL
);

464 
£lf
.
L
 = L;

465 
£lf
.
»suÉ_šdex
 = 
	`lua_g‘tİ
(
L
);

466 
£lf
.
¬¿y_šdex
 = 0;

467 
£lf
.
¬¿y_g
 = 
NULL
;

468 
£lf
.
d“p
 = 0;

469 
£lf
.
maššdex_g
 = -1;

470 
£lf
.
key_šdex
 = 0;

471 
r
 = 
	`¥rÙo_decode
(
¡
, 
bufãr
, ()
sz
, 
decode
, &
£lf
);

472 ià(
r
 < 0) {

473  
	`luaL_”rÜ
(
L
, "decodeƒrror");

475 
	`lua_£‰İ
(
L
, 
£lf
.
»suÉ_šdex
);

476 
	`lua_pushš‹g”
(
L
, 
r
);

478 
	}
}

481 
	$ldumµrÙo
(
lua_S‹
 *
L
) {

482 
¥rÙo
 * 
¥
 = 
	`lua_tou£rd©a
(
L
, 1);

483 ià(
¥
 =ğ
NULL
) {

484  
	`luaL_¬g”rÜ
(
L
, 1, "Need‡ sproto_type object");

486 
	`¥rÙo_dump
(
¥
);

489 
	}
}

497 
	$Íack
(
lua_S‹
 *
L
) {

498 
size_t
 
sz
=0;

499 cÚ¡ * 
bufãr
 = 
	`g‘bufãr
(
L
, 1, &
sz
);

501 
size_t
 
maxsz
 = (
sz
 + 2047) / 2048 * 2 + sz + 2;

502 * 
ouut
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

503 
by‹s
;

504 
osz
 = 
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(2));

505 ià(
osz
 < 
maxsz
) {

506 
ouut
 = 
	`ex·nd_bufãr
(
L
, 
osz
, 
maxsz
);

508 
by‹s
 = 
	`¥rÙo_·ck
(
bufãr
, 
sz
, 
ouut
, 
maxsz
);

509 ià(
by‹s
 > 
maxsz
) {

510  
	`luaL_”rÜ
(
L
, "·ckšgƒ¼Ü,„‘uº sizğ%d", 
by‹s
);

512 
	`lua_pushl¡ršg
(
L
, 
ouut
, 
by‹s
);

515 
	}
}

518 
	$luÅack
(
lua_S‹
 *
L
) {

519 
size_t
 
sz
=0;

520 cÚ¡ * 
bufãr
 = 
	`g‘bufãr
(
L
, 1, &
sz
);

521 * 
ouut
 = 
	`lua_tou£rd©a
(
L
, 
	`lua_upv®uešdex
(1));

522 
osz
 = 
	`lua_toš‹g”
(
L
, 
	`lua_upv®uešdex
(2));

523 
r
 = 
	`¥rÙo_uÅack
(
bufãr
, 
sz
, 
ouut
, 
osz
);

524 ià(
r
 < 0)

525  
	`luaL_”rÜ
(
L
, "Invalid unpack stream");

526 ià(
r
 > 
osz
) {

527 
ouut
 = 
	`ex·nd_bufãr
(
L
, 
osz
, 
r
);

528 
r
 = 
	`¥rÙo_uÅack
(
bufãr
, 
sz
, 
ouut
,„);

529 ià(
r
 < 0)

530  
	`luaL_”rÜ
(
L
, "Invalid unpack stream");

532 
	`lua_pushl¡ršg
(
L
, 
ouut
, 
r
);

534 
	}
}

537 
	$pushfunùiÚ_w™hbufãr
(
lua_S‹
 *
L
, cÚ¡ * 
Çme
, 
lua_CFunùiÚ
 
func
) {

538 
	`lua_Ãwu£rd©a
(
L
, 
ENCODE_BUFFERSIZE
);

539 
	`lua_pushš‹g”
(
L
, 
ENCODE_BUFFERSIZE
);

540 
	`lua_pushcşosu»
(
L
, 
func
, 2);

541 
	`lua_£tf›ld
(
L
, -2, 
Çme
);

542 
	}
}

545 
	$ÍrÙocŞ
(
lua_S‹
 *
L
) {

546 
¥rÙo
 * 
¥
 = 
	`lua_tou£rd©a
(
L
, 1);

547 
¥rÙo_ty³
 * 
»que¡
;

548 
¥rÙo_ty³
 * 
»¥Ú£
;

549 
t
;

550 
g
;

551 ià(
¥
 =ğ
NULL
) {

552  
	`luaL_¬g”rÜ
(
L
, 1, "Need‡ sproto_type object");

554 
t
 = 
	`lua_ty³
(
L
,2);

555 ià(
t
 =ğ
LUA_TNUMBER
) {

556 cÚ¡ * 
Çme
;

557 
g
 = 
	`lua_toš‹g”
(
L
, 2);

558 
Çme
 = 
	`¥rÙo_´ÙÚame
(
¥
, 
g
);

559 ià(
Çme
 =ğ
NULL
)

561 
	`lua_push¡ršg
(
L
, 
Çme
);

563 cÚ¡ * 
Çme
 = 
	`lua_to¡ršg
(
L
, 2);

564 ià(
Çme
 =ğ
NULL
) {

565  
	`luaL_¬g”rÜ
(
L
, 2, "Should be‚umber or string");

567 
g
 = 
	`¥rÙo_´ÙÙag
(
¥
, 
Çme
);

568 ià(
g
 < 0)

570 
	`lua_pushš‹g”
(
L
, 
g
);

572 
»que¡
 = 
	`¥rÙo_´Ùoqu”y
(
¥
, 
g
, 
SPROTO_REQUEST
);

573 ià(
»que¡
 =ğ
NULL
) {

574 
	`lua_pushn
(
L
);

576 
	`lua_pushlightu£rd©a
(
L
, 
»que¡
);

578 
»¥Ú£
 = 
	`¥rÙo_´Ùoqu”y
(
¥
, 
g
, 
SPROTO_RESPONSE
);

579 ià(
»¥Ú£
 =ğ
NULL
) {

580 ià(
	`¥rÙo_´ÙÜe¥Ú£
(
¥
, 
g
)) {

581 
	`lua_pushlightu£rd©a
(
L
, 
NULL
);

583 
	`lua_pushn
(
L
);

586 
	`lua_pushlightu£rd©a
(
L
, 
»¥Ú£
);

589 
	}
}

594 
¥rÙo
 * 
	gG_¥rÙo
[
MAX_GLOBALSPROTO
];

597 
	$l§v•rÙo
(
lua_S‹
 *
L
) {

598 
¥rÙo
 * 
¥
 = 
	`lua_tou£rd©a
(
L
, 1);

599 
šdex
 = 
	`luaL_İtš‹g”
(
L
, 2, 0);

600 ià(
šdex
 < 0 || index >ğ
MAX_GLOBALSPROTO
) {

601  
	`luaL_”rÜ
(
L
, "Inv®id glob® slÙ index %d", 
šdex
);

604 
G_¥rÙo
[
šdex
] = 
¥
;

606 
	}
}

609 
	$Îßd´Ùo
(
lua_S‹
 *
L
) {

610 
šdex
 = 
	`luaL_İtš‹g”
(
L
, 1, 0);

611 
¥rÙo
 * 
¥
;

612 ià(
šdex
 < 0 || index >ğ
MAX_GLOBALSPROTO
) {

613  
	`luaL_”rÜ
(
L
, "Inv®id glob® slÙ index %d", 
šdex
);

615 
¥
 = 
G_¥rÙo
[
šdex
];

616 ià(
¥
 =ğ
NULL
) {

617  
	`luaL_”rÜ
(
L
, "n s´ÙØ© index %d", 
šdex
);

620 
	`lua_pushlightu£rd©a
(
L
, 
¥
);

623 
	}
}

626 
	$push_deçuÉ
(cÚ¡ 
¥rÙo_¬g
 *
¬gs
, 
¬¿y
) {

627 
lua_S‹
 *
L
 = 
¬gs
->
ud
;

628 
¬gs
->
ty³
) {

629 
SPROTO_TINTEGER
:

630 ià(
¬gs
->
exŒa
)

631 
	`lua_pushnumb”
(
L
, 0.0);

633 
	`lua_pushš‹g”
(
L
, 0);

635 
SPROTO_TBOOLEAN
:

636 
	`lua_pushboŞ—n
(
L
, 0);

638 
SPROTO_TSTRING
:

639 
	`lua_pushl™”®
(
L
, "");

641 
SPROTO_TSTRUCT
:

642 ià(
¬¿y
) {

643 
	`lua_push¡ršg
(
L
, 
	`¥rÙo_Çme
(
¬gs
->
subty³
));

645 
	`lua_ü—‹bË
(
L
, 0, 1);

646 
	`lua_push¡ršg
(
L
, 
	`¥rÙo_Çme
(
¬gs
->
subty³
));

647 
	`lua_£tf›ld
(
L
, -2, "__type");

651 
	`luaL_”rÜ
(
L
, "Inv®idy³ %d", 
¬gs
->
ty³
);

654 
	}
}

657 
	$’code_deçuÉ
(cÚ¡ 
¥rÙo_¬g
 *
¬gs
) {

658 
lua_S‹
 *
L
 = 
¬gs
->
ud
;

659 
	`lua_push¡ršg
(
L
, 
¬gs
->
gÇme
);

660 ià(
¬gs
->
šdex
 > 0) {

661 
	`lua_ÃwbË
(
L
);

662 
	`push_deçuÉ
(
¬gs
, 1);

663 
	`lua_£tf›ld
(
L
, -2, "__array");

664 
	`lua_¿w£t
(
L
, -3);

665  
SPROTO_CB_NOARRAY
;

667 
	`push_deçuÉ
(
¬gs
, 0);

668 
	`lua_¿w£t
(
L
, -3);

669  
SPROTO_CB_NIL
;

671 
	}
}

678 
	$ldeçuÉ
(
lua_S‹
 *
L
) {

679 
»t
;

681 
dummy
[64];

682 
¥rÙo_ty³
 * 
¡
 = 
	`lua_tou£rd©a
(
L
, 1);

683 ià(
¡
 =ğ
NULL
) {

684  
	`luaL_¬g”rÜ
(
L
, 1, "Need‡ sproto_type object");

686 
	`lua_ÃwbË
(
L
);

687 
»t
 = 
	`¥rÙo_’code
(
¡
, 
dummy
, (dummy), 
’code_deçuÉ
, 
L
);

688 ià(
»t
<0) {

690 
sz
 = (
dummy
) * 2;

691 * 
tmp
 = 
	`lua_Ãwu£rd©a
(
L
, 
sz
);

692 
	`lua_š£¹
(
L
, -2);

694 
»t
 = 
	`¥rÙo_’code
(
¡
, 
tmp
, 
sz
, 
’code_deçuÉ
, 
L
);

695 ià(
»t
 >= 0)

697 
sz
 *= 2;

698 
tmp
 = 
	`lua_Ãwu£rd©a
(
L
, 
sz
);

699 
	`lua_»¶aû
(
L
, -3);

703 
	}
}

705 
LUAMOD_API
 

706 
	$luaİ’_¥rÙo_cÜe
(
lua_S‹
 *
L
) {

707 #ifdeà
luaL_checkv”siÚ


708 
	`luaL_checkv”siÚ
(
L
);

710 
luaL_Reg
 
l
[] = {

711 { "Ãw´Ùo", 
Êew´Ùo
 },

712 { "d–‘•rÙo", 
ld–‘•rÙo
 },

713 { "dumµrÙo", 
ldumµrÙo
 },

714 { "qu”yty³", 
lqu”yty³
 },

715 { "decode", 
ldecode
 },

716 { "´ÙocŞ", 
ÍrÙocŞ
 },

717 { "lßd´Ùo", 
Îßd´Ùo
 },

718 { "§v•rÙo", 
l§v•rÙo
 },

719 { "deçuÉ", 
ldeçuÉ
 },

720 { 
NULL
, NULL },

722 
	`luaL_Ãwlib
(
L
,
l
);

723 
	`pushfunùiÚ_w™hbufãr
(
L
, "’code", 
Ëncode
);

724 
	`pushfunùiÚ_w™hbufãr
(
L
, "·ck", 
Íack
);

725 
	`pushfunùiÚ_w™hbufãr
(
L
, "uÅack", 
luÅack
);

727 
	}
}

	@lualib-src/sproto/msvcint.h

1 #iâdeà
msvc_št_h


2 
	#msvc_št_h


	)

4 #ifdeà
_MSC_VER


5 
	#šlše
 
__šlše


	)

6 #iâdeà
_MSC_STDINT_H_


7 #ià(
_MSC_VER
 < 1300)

8 sigÃd 
	tšt8_t
;

9 sigÃd 
	tšt16_t
;

10 sigÃd 
	tšt32_t
;

11 
	tušt8_t
;

12 
	tušt16_t
;

13 
	tušt32_t
;

15 sigÃd 
	t__št8
 
	tšt8_t
;

16 sigÃd 
	t__št16
 
	tšt16_t
;

17 sigÃd 
	t__št32
 
	tšt32_t
;

18 
	t__št8
 
	tušt8_t
;

19 
	t__št16
 
	tušt16_t
;

20 
	t__št32
 
	tušt32_t
;

22 sigÃd 
	t__št64
 
	tšt64_t
;

23 
	t__št64
 
	tušt64_t
;

28 
	~<¡dšt.h
>

	@lualib-src/sproto/sproto.c

1 
	~<¡dlib.h
>

2 
	~<¡ršg.h
>

3 
	~<¡dio.h
>

4 
	~<as£¹.h
>

5 
	~"msvcšt.h
"

7 
	~"¥rÙo.h
"

9 
	#SPROTO_TARRAY
 0x80

	)

10 
	#CHUNK_SIZE
 1000

	)

11 
	#SIZEOF_LENGTH
 4

	)

12 
	#SIZEOF_HEADER
 2

	)

13 
	#SIZEOF_FIELD
 2

	)

15 
	sf›ld
 {

16 
	mg
;

17 
	mty³
;

18 cÚ¡ * 
	mÇme
;

19 
¥rÙo_ty³
 * 
	m¡
;

20 
	mkey
;

21 
	mexŒa
;

24 
	s¥rÙo_ty³
 {

25 cÚ¡ * 
	mÇme
;

26 
	mn
;

27 
	mba£
;

28 
	mmaxn
;

29 
f›ld
 *
	mf
;

32 
	s´ÙocŞ
 {

33 cÚ¡ *
	mÇme
;

34 
	mg
;

35 
	mcÚfœm
;

36 
¥rÙo_ty³
 * 
	mp
[2];

39 
	schunk
 {

40 
chunk
 * 
	mÃxt
;

43 
	spoŞ
 {

44 
chunk
 * 
	mh—d”
;

45 
chunk
 * 
	mcu¼’t
;

46 
	mcu¼’t_u£d
;

49 
	s¥rÙo
 {

50 
poŞ
 
	mmemÜy
;

51 
	mty³_n
;

52 
	m´ÙocŞ_n
;

53 
¥rÙo_ty³
 * 
	mty³
;

54 
´ÙocŞ
 * 
	m´Ùo
;

58 
	$poŞ_š™
(
poŞ
 *
p
) {

59 
p
->
h—d”
 = 
NULL
;

60 
p
->
cu¼’t
 = 
NULL
;

61 
p
->
cu¼’t_u£d
 = 0;

62 
	}
}

65 
	$poŞ_»Ëa£
(
poŞ
 *
p
) {

66 
chunk
 * 
tmp
 = 
p
->
h—d”
;

67 
tmp
) {

68 
chunk
 * 
n
 = 
tmp
->
Ãxt
;

69 
	`ä“
(
tmp
);

70 
tmp
 = 
n
;

72 
	}
}

75 
	$poŞ_Ãwchunk
(
poŞ
 *
p
, 
size_t
 
sz
) {

76 
chunk
 * 
t
 = 
	`m®loc
(
sz
 + (chunk));

77 ià(
t
 =ğ
NULL
)

78  
NULL
;

79 
t
->
Ãxt
 = 
p
->
h—d”
;

80 
p
->
h—d”
 = 
t
;

81  
t
+1;

82 
	}
}

85 
	$poŞ_®loc
(
poŞ
 *
p
, 
size_t
 
sz
) {

87 
sz
 = (sz + 7) & ~7;

88 ià(
sz
 >ğ
CHUNK_SIZE
) {

89  
	`poŞ_Ãwchunk
(
p
, 
sz
);

91 ià(
p
->
cu¼’t
 =ğ
NULL
) {

92 ià(
	`poŞ_Ãwchunk
(
p
, 
CHUNK_SIZE
è=ğ
NULL
)

93  
NULL
;

94 
p
->
cu¼’t
 =…->
h—d”
;

96 ià(
sz
 + 
p
->
cu¼’t_u£d
 <ğ
CHUNK_SIZE
) {

97 * 
»t
 = (*)(
p
->
cu¼’t
+1è+…->
cu¼’t_u£d
;

98 
p
->
cu¼’t_u£d
 +ğ
sz
;

99  
»t
;

102 ià(
sz
 >ğ
p
->
cu¼’t_u£d
) {

103  
	`poŞ_Ãwchunk
(
p
, 
sz
);

105 * 
»t
 = 
	`poŞ_Ãwchunk
(
p
, 
CHUNK_SIZE
);

106 
p
->
cu¼’t
 =…->
h—d”
;

107 
p
->
cu¼’t_u£d
 = 
sz
;

108  
»t
;

110 
	}
}

112 
šlše
 

113 
	$towÜd
(cÚ¡ 
ušt8_t
 * 
p
) {

114  
p
[0] |…[1]<<8;

115 
	}
}

117 
šlše
 
ušt32_t


118 
	$todwÜd
(cÚ¡ 
ušt8_t
 *
p
) {

119  
p
[0] |…[1]<<8 |…[2]<<16 |…[3]<<24;

120 
	}
}

123 
	$couÁ_¬¿y
(cÚ¡ 
ušt8_t
 * 
¡»am
) {

124 
ušt32_t
 
Ëngth
 = 
	`todwÜd
(
¡»am
);

125 
n
 = 0;

126 
¡»am
 +ğ
SIZEOF_LENGTH
;

127 
Ëngth
 > 0) {

128 
ušt32_t
 
nsz
;

129 ià(
Ëngth
 < 
SIZEOF_LENGTH
)

131 
nsz
 = 
	`todwÜd
(
¡»am
);

132 
nsz
 +ğ
SIZEOF_LENGTH
;

133 ià(
nsz
 > 
Ëngth
)

135 ++
n
;

136 
¡»am
 +ğ
nsz
;

137 
Ëngth
 -ğ
nsz
;

140  
n
;

141 
	}
}

144 
	$¡ruù_f›ld
(cÚ¡ 
ušt8_t
 * 
¡»am
, 
size_t
 
sz
) {

145 cÚ¡ 
ušt8_t
 * 
f›ld
;

146 
â
, 
h—d”
, 
i
;

147 ià(
sz
 < 
SIZEOF_LENGTH
)

149 
â
 = 
	`towÜd
(
¡»am
);

150 
h—d”
 = 
SIZEOF_HEADER
 + 
SIZEOF_FIELD
 * 
â
;

151 ià(
sz
 < 
h—d”
)

153 
f›ld
 = 
¡»am
 + 
SIZEOF_HEADER
;

154 
sz
 -ğ
h—d”
;

155 
¡»am
 +ğ
h—d”
;

156 
i
=0;i<
â
;i++) {

157 
v®ue
ğ
	`towÜd
(
f›ld
 + 
i
 * 
SIZEOF_FIELD
);

158 
ušt32_t
 
dsz
;

159 ià(
v®ue
 != 0)

161 ià(
sz
 < 
SIZEOF_LENGTH
)

163 
dsz
 = 
	`todwÜd
(
¡»am
);

164 ià(
sz
 < 
SIZEOF_LENGTH
 + 
dsz
)

166 
¡»am
 +ğ
SIZEOF_LENGTH
 + 
dsz
;

167 
sz
 -ğ
SIZEOF_LENGTH
 + 
dsz
;

170  
â
;

171 
	}
}

174 
	$impÜt_¡ršg
(
¥rÙo
 *
s
, cÚ¡ 
ušt8_t
 * 
¡»am
) {

175 
ušt32_t
 
sz
 = 
	`todwÜd
(
¡»am
);

176 * 
bufãr
 = 
	`poŞ_®loc
(&
s
->
memÜy
, 
sz
+1);

177 
	`memıy
(
bufãr
, 
¡»am
+
SIZEOF_LENGTH
, 
sz
);

178 
bufãr
[
sz
] = '\0';

179  
bufãr
;

180 
	}
}

183 
	$ÿlc_pow
(
ba£
, 
n
) {

184 
r
;

185 ià(
n
 == 0)

187 
r
 = 
	`ÿlc_pow
(
ba£
 * ba£ , 
n
 / 2);

188 ià(
n
&1) {

189 
r
 *ğ
ba£
;

191  
r
;

192 
	}
}

194 cÚ¡ 
ušt8_t
 *

195 
	$impÜt_f›ld
(
¥rÙo
 *
s
, 
f›ld
 *
f
, cÚ¡ 
ušt8_t
 * 
¡»am
) {

196 
ušt32_t
 
sz
;

197 cÚ¡ 
ušt8_t
 * 
»suÉ
;

198 
â
;

199 
i
;

200 
¬¿y
 = 0;

201 
g
 = -1;

202 
f
->
g
 = -1;

203 
f
->
ty³
 = -1;

204 
f
->
Çme
 = 
NULL
;

205 
f
->
¡
 = 
NULL
;

206 
f
->
key
 = -1;

207 
f
->
exŒa
 = 0;

209 
sz
 = 
	`todwÜd
(
¡»am
);

210 
¡»am
 +ğ
SIZEOF_LENGTH
;

211 
»suÉ
 = 
¡»am
 + 
sz
;

212 
â
 = 
	`¡ruù_f›ld
(
¡»am
, 
sz
);

213 ià(
â
 < 0)

214  
NULL
;

215 
¡»am
 +ğ
SIZEOF_HEADER
;

216 
i
=0;i<
â
;i++) {

217 
v®ue
;

218 ++
g
;

219 
v®ue
 = 
	`towÜd
(
¡»am
 + 
SIZEOF_FIELD
 * 
i
);

220 ià(
v®ue
 & 1) {

221 
g
+ğ
v®ue
/2;

224 ià(
g
 == 0) {

225 ià(
v®ue
 != 0)

226  
NULL
;

227 
f
->
Çme
 = 
	`impÜt_¡ršg
(
s
, 
¡»am
 + 
â
 * 
SIZEOF_FIELD
);

230 ià(
v®ue
 == 0)

231  
NULL
;

232 
v®ue
 = value/2 - 1;

233 
g
) {

235 ià(
v®ue
 >ğ
SPROTO_TSTRUCT
)

236  
NULL
;

237 
f
->
ty³
 = 
v®ue
;

240 ià(
f
->
ty³
 =ğ
SPROTO_TINTEGER
) {

241 
f
->
exŒa
 = 
	`ÿlc_pow
(10, 
v®ue
);

242 } ià(
f
->
ty³
 =ğ
SPROTO_TSTRING
) {

243 
f
->
exŒa
 = 
v®ue
;

245 ià(
v®ue
 >ğ
s
->
ty³_n
)

246  
NULL
;

247 ià(
f
->
ty³
 >= 0)

248  
NULL
;

249 
f
->
ty³
 = 
SPROTO_TSTRUCT
;

250 
f
->
¡
 = &
s
->
ty³
[
v®ue
];

254 
f
->
g
 = 
v®ue
;

257 ià(
v®ue
)

258 
¬¿y
 = 
SPROTO_TARRAY
;

261 
f
->
key
 = 
v®ue
;

264  
NULL
;

267 ià(
f
->
g
 < 0 || f->
ty³
 < 0 || f->
Çme
 =ğ
NULL
)

268  
NULL
;

269 
f
->
ty³
 |ğ
¬¿y
;

271  
»suÉ
;

272 
	}
}

287 cÚ¡ 
ušt8_t
 *

288 
	$impÜt_ty³
(
¥rÙo
 *
s
, 
¥rÙo_ty³
 *
t
, cÚ¡ 
ušt8_t
 * 
¡»am
) {

289 cÚ¡ 
ušt8_t
 * 
»suÉ
;

290 
ušt32_t
 
sz
 = 
	`todwÜd
(
¡»am
);

291 
i
;

292 
â
;

293 
n
;

294 
maxn
;

295 
Ï¡
;

296 
¡»am
 +ğ
SIZEOF_LENGTH
;

297 
»suÉ
 = 
¡»am
 + 
sz
;

298 
â
 = 
	`¡ruù_f›ld
(
¡»am
, 
sz
);

299 ià(
â
 <= 0 || fn > 2)

300  
NULL
;

301 
i
=0;i<
â
*
SIZEOF_FIELD
;i+=SIZEOF_FIELD) {

303 
v
 = 
	`towÜd
(
¡»am
 + 
SIZEOF_HEADER
 + 
i
);

304 ià(
v
 != 0)

305  
NULL
;

307 
	`mem£t
(
t
, 0, (*t));

308 
¡»am
 +ğ
SIZEOF_HEADER
 + 
â
 * 
SIZEOF_FIELD
;

309 
t
->
Çme
 = 
	`impÜt_¡ršg
(
s
, 
¡»am
);

310 ià(
â
 == 1) {

311  
»suÉ
;

313 
¡»am
 +ğ
	`todwÜd
(¡»am)+
SIZEOF_LENGTH
;

314 
n
 = 
	`couÁ_¬¿y
(
¡»am
);

315 ià(
n
<0)

316  
NULL
;

317 
¡»am
 +ğ
SIZEOF_LENGTH
;

318 
maxn
 = 
n
;

319 
Ï¡
 = -1;

320 
t
->
n
 =‚;

321 
t
->
f
 = 
	`poŞ_®loc
(&
s
->
memÜy
, (
f›ld
è* 
n
);

322 
i
=0;i<
n
;i++) {

323 
g
;

324 
f›ld
 *
f
 = &
t
->f[
i
];

325 
¡»am
 = 
	`impÜt_f›ld
(
s
, 
f
, stream);

326 ià(
¡»am
 =ğ
NULL
)

327  
NULL
;

328 
g
 = 
f
->tag;

329 ià(
g
 <ğ
Ï¡
)

330  
NULL
;

331 ià(
g
 > 
Ï¡
+1) {

332 ++
maxn
;

334 
Ï¡
 = 
g
;

336 
t
->
maxn
 = maxn;

337 
t
->
ba£
 =->
f
[0].
g
;

338 
n
 = 
t
->
f
[n-1].
g
 -->
ba£
 + 1;

339 ià(
n
 !ğ
t
->n) {

340 
t
->
ba£
 = -1;

342  
»suÉ
;

343 
	}
}

353 cÚ¡ 
ušt8_t
 *

354 
	$impÜt_´ÙocŞ
(
¥rÙo
 *
s
, 
´ÙocŞ
 *
p
, cÚ¡ 
ušt8_t
 * 
¡»am
) {

355 cÚ¡ 
ušt8_t
 * 
»suÉ
;

356 
ušt32_t
 
sz
 = 
	`todwÜd
(
¡»am
);

357 
â
;

358 
i
;

359 
g
;

360 
¡»am
 +ğ
SIZEOF_LENGTH
;

361 
»suÉ
 = 
¡»am
 + 
sz
;

362 
â
 = 
	`¡ruù_f›ld
(
¡»am
, 
sz
);

363 
¡»am
 +ğ
SIZEOF_HEADER
;

364 
p
->
Çme
 = 
NULL
;

365 
p
->
g
 = -1;

366 
p
->p[
SPROTO_REQUEST
] = 
NULL
;

367 
p
->p[
SPROTO_RESPONSE
] = 
NULL
;

368 
p
->
cÚfœm
 = 0;

369 
g
 = 0;

370 
i
=0;i<
â
;i++,
g
++) {

371 
v®ue
 = 
	`towÜd
(
¡»am
 + 
SIZEOF_FIELD
 * 
i
);

372 ià(
v®ue
 & 1) {

373 
g
 +ğ(
v®ue
-1)/2;

376 
v®ue
 = value/2 - 1;

377 
i
) {

379 ià(
v®ue
 != -1) {

380  
NULL
;

382 
p
->
Çme
 = 
	`impÜt_¡ršg
(
s
, 
¡»am
 + 
SIZEOF_FIELD
 *
â
);

385 ià(
v®ue
 < 0) {

386  
NULL
;

388 
p
->
g
 = 
v®ue
;

391 ià(
v®ue
 < 0 || v®ue>=
s
->
ty³_n
)

392  
NULL
;

393 
p
->p[
SPROTO_REQUEST
] = &
s
->
ty³
[
v®ue
];

396 ià(
v®ue
 < 0 || v®ue>=
s
->
ty³_n
)

397  
NULL
;

398 
p
->p[
SPROTO_RESPONSE
] = &
s
->
ty³
[
v®ue
];

401 
p
->
cÚfœm
 = 
v®ue
;

404  
NULL
;

408 ià(
p
->
Çme
 =ğ
NULL
 ||…->
g
<0) {

409  
NULL
;

412  
»suÉ
;

413 
	}
}

415 
¥rÙo
 *

416 
	$ü—‹_äom_bundË
(
¥rÙo
 *
s
, cÚ¡ 
ušt8_t
 * 
¡»am
, 
size_t
 
sz
) {

417 cÚ¡ 
ušt8_t
 * 
cÚ‹Á
;

418 cÚ¡ 
ušt8_t
 * 
ty³d©a
 = 
NULL
;

419 cÚ¡ 
ušt8_t
 * 
´ÙocŞd©a
 = 
NULL
;

420 
â
 = 
	`¡ruù_f›ld
(
¡»am
, 
sz
);

421 
i
;

422 ià(
â
 < 0 || fn > 2)

423  
NULL
;

425 
¡»am
 +ğ
SIZEOF_HEADER
;

426 
cÚ‹Á
 = 
¡»am
 + 
â
*
SIZEOF_FIELD
;

428 
i
=0;i<
â
;i++) {

429 
v®ue
 = 
	`towÜd
(
¡»am
 + 
i
*
SIZEOF_FIELD
);

430 
n
;

431 ià(
v®ue
 != 0)

432  
NULL
;

433 
n
 = 
	`couÁ_¬¿y
(
cÚ‹Á
);

434 ià(
n
<0)

435  
NULL
;

436 ià(
i
 == 0) {

437 
ty³d©a
 = 
cÚ‹Á
+
SIZEOF_LENGTH
;

438 
s
->
ty³_n
 = 
n
;

439 
s
->
ty³
 = 
	`poŞ_®loc
(&s->
memÜy
, 
n
 * (*s->type));

441 
´ÙocŞd©a
 = 
cÚ‹Á
+
SIZEOF_LENGTH
;

442 
s
->
´ÙocŞ_n
 = 
n
;

443 
s
->
´Ùo
 = 
	`poŞ_®loc
(&s->
memÜy
, 
n
 * (*s->proto));

445 
cÚ‹Á
 +ğ
	`todwÜd
(cÚ‹Áè+ 
SIZEOF_LENGTH
;

448 
i
=0;i<
s
->
ty³_n
;i++) {

449 
ty³d©a
 = 
	`impÜt_ty³
(
s
, &s->
ty³
[
i
],ypedata);

450 ià(
ty³d©a
 =ğ
NULL
) {

451  
NULL
;

454 
i
=0;i<
s
->
´ÙocŞ_n
;i++) {

455 
´ÙocŞd©a
 = 
	`impÜt_´ÙocŞ
(
s
, &s->
´Ùo
[
i
],…rotocoldata);

456 ià(
´ÙocŞd©a
 =ğ
NULL
) {

457  
NULL
;

461  
s
;

462 
	}
}

464 
¥rÙo
 *

465 
	$¥rÙo_ü—‹
(cÚ¡ * 
´Ùo
, 
size_t
 
sz
) {

466 
poŞ
 
mem
;

467 
¥rÙo
 * 
s
;

468 
	`poŞ_š™
(&
mem
);

469 
s
 = 
	`poŞ_®loc
(&
mem
, (*s));

470 ià(
s
 =ğ
NULL
)

471  
NULL
;

472 
	`mem£t
(
s
, 0, (*s));

473 
s
->
memÜy
 = 
mem
;

474 ià(
	`ü—‹_äom_bundË
(
s
, 
´Ùo
, 
sz
è=ğ
NULL
) {

475 
	`poŞ_»Ëa£
(&
s
->
memÜy
);

476  
NULL
;

478  
s
;

479 
	}
}

482 
	$¥rÙo_»Ëa£
(
¥rÙo
 * 
s
) {

483 ià(
s
 =ğ
NULL
)

485 
	`poŞ_»Ëa£
(&
s
->
memÜy
);

486 
	}
}

489 
	$¥rÙo_dump
(
¥rÙo
 *
s
) {

490 
i
,
j
;

491 
	`´štf
("==ğ%dy³ ===\n", 
s
->
ty³_n
);

492 
i
=0;i<
s
->
ty³_n
;i++) {

493 
¥rÙo_ty³
 *
t
 = &
s
->
ty³
[
i
];

494 
	`´štf
("%s\n", 
t
->
Çme
);

495 
j
=0;j<
t
->
n
;j++) {

496 
¬¿y
[2] = { 0, 0 };

497 cÚ¡ * 
ty³_Çme
 = 
NULL
;

498 
f›ld
 *
f
 = &
t
->f[
j
];

499 
ty³
 = 
f
->ty³ & ~
SPROTO_TARRAY
;

500 ià(
f
->
ty³
 & 
SPROTO_TARRAY
) {

501 
¬¿y
[0] = '*';

503 
¬¿y
[0] = 0;

505 ià(
ty³
 =ğ
SPROTO_TSTRUCT
) {

506 
ty³_Çme
 = 
f
->
¡
->
Çme
;

508 
ty³
) {

509 
SPROTO_TINTEGER
:

510 ià(
f
->
exŒa
) {

511 
ty³_Çme
 = "decimal";

513 
ty³_Çme
 = "integer";

516 
SPROTO_TBOOLEAN
:

517 
ty³_Çme
 = "boolean";

519 
SPROTO_TSTRING
:

520 ià(
f
->
exŒa
 =ğ
SPROTO_TSTRING_BINARY
)

521 
ty³_Çme
 = "binary";

523 
ty³_Çme
 = "string";

526 
ty³_Çme
 = "invalid";

530 
	`´štf
("\t% (%dè%s%s", 
f
->
Çme
, f->
g
, 
¬¿y
, 
ty³_Çme
);

531 ià(
ty³
 =ğ
SPROTO_TINTEGER
 && 
f
->
exŒa
 > 0) {

532 
	`´štf
("(%d)", 
f
->
exŒa
);

534 ià(
f
->
key
 >= 0) {

535 
	`´štf
("[%d]", 
f
->
key
);

537 
	`´štf
("\n");

540 
	`´štf
("==ğ%d…rÙocŞ ===\n", 
s
->
´ÙocŞ_n
);

541 
i
=0;i<
s
->
´ÙocŞ_n
;i++) {

542 
´ÙocŞ
 *
p
 = &
s
->
´Ùo
[
i
];

543 ià(
p
->p[
SPROTO_REQUEST
]) {

544 
	`´štf
("\t% (%dè»que¡:%s", 
p
->
Çme
,…->
g
,…->p[
SPROTO_REQUEST
]->name);

546 
	`´štf
("\t% (%dè»que¡:ÒuÎ)", 
p
->
Çme
,…->
g
);

548 ià(
p
->p[
SPROTO_RESPONSE
]) {

549 
	`´štf
("„e¥Ú£:%s", 
p
->p[
SPROTO_RESPONSE
]->
Çme
);

550 } ià(
p
->
cÚfœm
) {

551 
	`´štf
("„esponse‚il");

553 
	`´štf
("\n");

555 
	}
}

559 
	$¥rÙo_´ÙÙag
(cÚ¡ 
¥rÙo
 *
¥
, cÚ¡ * 
Çme
) {

560 
i
;

561 
i
=0;i<
¥
->
´ÙocŞ_n
;i++) {

562 ià(
	`¡rcmp
(
Çme
, 
¥
->
´Ùo
[
i
].name) == 0) {

563  
¥
->
´Ùo
[
i
].
g
;

567 
	}
}

569 
´ÙocŞ
 *

570 
	$qu”y_´Ùo
(cÚ¡ 
¥rÙo
 *
¥
, 
g
) {

571 
begš
 = 0, 
’d
 = 
¥
->
´ÙocŞ_n
;

572 
begš
<
’d
) {

573 
mid
 = (
begš
+
’d
)/2;

574 
t
 = 
¥
->
´Ùo
[
mid
].
g
;

575 ià(
t
==
g
) {

576  &
¥
->
´Ùo
[
mid
];

578 ià(
g
 > 
t
) {

579 
begš
 = 
mid
+1;

581 
’d
 = 
mid
;

584  
NULL
;

585 
	}
}

587 
¥rÙo_ty³
 *

588 
	$¥rÙo_´Ùoqu”y
(cÚ¡ 
¥rÙo
 *
¥
, 
´Ùo
, 
wh©
) {

589 
´ÙocŞ
 * 
p
;

590 ià(
wh©
 <0 || what >1) {

591  
NULL
;

593 
p
 = 
	`qu”y_´Ùo
(
¥
, 
´Ùo
);

594 ià(
p
) {

595  
p
->p[
wh©
];

597  
NULL
;

598 
	}
}

601 
	$¥rÙo_´ÙÜe¥Ú£
(cÚ¡ 
¥rÙo
 * 
¥
, 
´Ùo
) {

602 
´ÙocŞ
 * 
p
 = 
	`qu”y_´Ùo
(
¥
, 
´Ùo
);

603  (
p
!=
NULL
 && (p->p[
SPROTO_RESPONSE
] ||…->
cÚfœm
));

604 
	}
}

607 
	$¥rÙo_´ÙÚame
(cÚ¡ 
¥rÙo
 *
¥
, 
´Ùo
) {

608 
´ÙocŞ
 * 
p
 = 
	`qu”y_´Ùo
(
¥
, 
´Ùo
);

609 ià(
p
) {

610  
p
->
Çme
;

612  
NULL
;

613 
	}
}

615 
¥rÙo_ty³
 *

616 
	$¥rÙo_ty³
(cÚ¡ 
¥rÙo
 *
¥
, cÚ¡ * 
ty³_Çme
) {

617 
i
;

618 
i
=0;i<
¥
->
ty³_n
;i++) {

619 ià(
	`¡rcmp
(
ty³_Çme
, 
¥
->
ty³
[
i
].
Çme
) == 0) {

620  &
¥
->
ty³
[
i
];

623  
NULL
;

624 
	}
}

627 
	$¥rÙo_Çme
(
¥rÙo_ty³
 * 
¡
) {

628  
¡
->
Çme
;

629 
	}
}

631 
f›ld
 *

632 
	$fšdg
(cÚ¡ 
¥rÙo_ty³
 *
¡
, 
g
) {

633 
begš
, 
’d
;

634 ià(
¡
->
ba£
 >=0 ) {

635 
g
 -ğ
¡
->
ba£
;

636 ià(
g
 < 0 ||ag >ğ
¡
->
n
)

637  
NULL
;

638  &
¡
->
f
[
g
];

640 
begš
 = 0;

641 
’d
 = 
¡
->
n
;

642 
begš
 < 
’d
) {

643 
mid
 = (
begš
+
’d
)/2;

644 
f›ld
 *
f
 = &
¡
->f[
mid
];

645 
t
 = 
f
->
g
;

646 ià(
t
 =ğ
g
) {

647  
f
;

649 ià(
g
 > 
t
) {

650 
begš
 = 
mid
 + 1;

652 
’d
 = 
mid
;

655  
NULL
;

656 
	}
}

662 
šlše
 

663 
	$fl_size
(
ušt8_t
 * 
d©a
, 
sz
) {

664 
d©a
[0] = 
sz
 & 0xff;

665 
d©a
[1] = (
sz
 >> 8) & 0xff;

666 
d©a
[2] = (
sz
 >> 16) & 0xff;

667 
d©a
[3] = (
sz
 >> 24) & 0xff;

668  
sz
 + 
SIZEOF_LENGTH
;

669 
	}
}

672 
	$’code_š‹g”
(
ušt32_t
 
v
, 
ušt8_t
 * 
d©a
, 
size
) {

673 ià(
size
 < 
SIZEOF_LENGTH
 + (
v
))

675 
d©a
[4] = 
v
 & 0xff;

676 
d©a
[5] = (
v
 >> 8) & 0xff;

677 
d©a
[6] = (
v
 >> 16) & 0xff;

678 
d©a
[7] = (
v
 >> 24) & 0xff;

679  
	`fl_size
(
d©a
, (
v
));

680 
	}
}

683 
	$’code_ušt64
(
ušt64_t
 
v
, 
ušt8_t
 * 
d©a
, 
size
) {

684 ià(
size
 < 
SIZEOF_LENGTH
 + (
v
))

686 
d©a
[4] = 
v
 & 0xff;

687 
d©a
[5] = (
v
 >> 8) & 0xff;

688 
d©a
[6] = (
v
 >> 16) & 0xff;

689 
d©a
[7] = (
v
 >> 24) & 0xff;

690 
d©a
[8] = (
v
 >> 32) & 0xff;

691 
d©a
[9] = (
v
 >> 40) & 0xff;

692 
d©a
[10] = (
v
 >> 48) & 0xff;

693 
d©a
[11] = (
v
 >> 56) & 0xff;

694  
	`fl_size
(
d©a
, (
v
));

695 
	}
}

721 
	$’code_objeù
(
¥rÙo_ÿÎback
 
cb
, 
¥rÙo_¬g
 *
¬gs
, 
ušt8_t
 *
d©a
, 
size
) {

722 
sz
;

723 ià(
size
 < 
SIZEOF_LENGTH
)

725 
¬gs
->
v®ue
 = 
d©a
+
SIZEOF_LENGTH
;

726 
¬gs
->
Ëngth
 = 
size
-
SIZEOF_LENGTH
;

727 
sz
 = 
	`cb
(
¬gs
);

728 ià(
sz
 < 0) {

729 ià(
sz
 =ğ
SPROTO_CB_NIL
)

733 
	`as£¹
(
sz
 <ğ
size
-
SIZEOF_LENGTH
);

734  
	`fl_size
(
d©a
, 
sz
);

735 
	}
}

737 
šlše
 

738 
	$ušt32_to_ušt64
(
Ãg©ive
, 
ušt8_t
 *
bufãr
) {

739 ià(
Ãg©ive
) {

740 
bufãr
[4] = 0xff;

741 
bufãr
[5] = 0xff;

742 
bufãr
[6] = 0xff;

743 
bufãr
[7] = 0xff;

745 
bufãr
[4] = 0;

746 
bufãr
[5] = 0;

747 
bufãr
[6] = 0;

748 
bufãr
[7] = 0;

750 
	}
}

752 
ušt8_t
 *

753 
	$’code_š‹g”_¬¿y
(
¥rÙo_ÿÎback
 
cb
, 
¥rÙo_¬g
 *
¬gs
, 
ušt8_t
 *
bufãr
, 
size
, *
nß¼ay
) {

754 
ušt8_t
 * 
h—d”
 = 
bufãr
;

755 
š’
;

756 
šdex
;

757 ià(
size
 < 1)

758  
NULL
;

759 
bufãr
++;

760 
size
--;

761 
š’
 = (
ušt32_t
);

762 
šdex
 = 1;

763 *
nß¼ay
 = 0;

766 
sz
;

768 
ušt64_t
 
u64
;

769 
ušt32_t
 
u32
;

770 } 
u
;

771 
¬gs
->
v®ue
 = &
u
;

772 
¬gs
->
Ëngth
 = (
u
);

773 
¬gs
->
šdex
 = index;

774 
sz
 = 
	`cb
(
¬gs
);

775 ià(
sz
 <= 0) {

776 ià(
sz
 =ğ
SPROTO_CB_NIL
)

778 ià(
sz
 =ğ
SPROTO_CB_NOARRAY
) {

779 *
nß¼ay
 = 1;

782  
NULL
;

784 ià(
size
 < (
ušt64_t
))

785  
NULL
;

786 ià(
sz
 =ğ(
ušt32_t
)) {

787 
ušt32_t
 
v
 = 
u
.
u32
;

788 
bufãr
[0] = 
v
 & 0xff;

789 
bufãr
[1] = (
v
 >> 8) & 0xff;

790 
bufãr
[2] = (
v
 >> 16) & 0xff;

791 
bufãr
[3] = (
v
 >> 24) & 0xff;

793 ià(
š’
 =ğ(
ušt64_t
)) {

794 
	`ušt32_to_ušt64
(
v
 & 0x80000000, 
bufãr
);

797 
ušt64_t
 
v
;

798 ià(
sz
 !ğ(
ušt64_t
))

799  
NULL
;

800 ià(
š’
 =ğ(
ušt32_t
)) {

801 
i
;

803 
size
 -ğ(
šdex
-1è* (
ušt32_t
);

804 ià(
size
 < (
ušt64_t
))

805  
NULL
;

806 
bufãr
 +ğ(
šdex
-1è* (
ušt32_t
);

807 
i
=
šdex
-2;i>=0;i--) {

808 
Ãg©ive
;

809 
	`memıy
(
h—d”
+1+
i
*(
ušt64_t
), h—d”+1+i*(
ušt32_t
), (uint32_t));

810 
Ãg©ive
 = 
h—d”
[1+
i
*(
ušt64_t
)+3] & 0x80;

811 
	`ušt32_to_ušt64
(
Ãg©ive
, 
h—d”
+1+
i
*(
ušt64_t
));

813 
š’
 = (
ušt64_t
);

816 
v
 = 
u
.
u64
;

817 
bufãr
[0] = 
v
 & 0xff;

818 
bufãr
[1] = (
v
 >> 8) & 0xff;

819 
bufãr
[2] = (
v
 >> 16) & 0xff;

820 
bufãr
[3] = (
v
 >> 24) & 0xff;

821 
bufãr
[4] = (
v
 >> 32) & 0xff;

822 
bufãr
[5] = (
v
 >> 40) & 0xff;

823 
bufãr
[6] = (
v
 >> 48) & 0xff;

824 
bufãr
[7] = (
v
 >> 56) & 0xff;

827 
size
 -ğ
š’
;

828 
bufãr
 +ğ
š’
;

829 
šdex
++;

832 ià(
bufãr
 =ğ
h—d”
 + 1) {

833  
h—d”
;

835 *
h—d”
 = (
ušt8_t
)
š’
;

836  
bufãr
;

837 
	}
}

840 
	$’code_¬¿y
(
¥rÙo_ÿÎback
 
cb
, 
¥rÙo_¬g
 *
¬gs
, 
ušt8_t
 *
d©a
, 
size
) {

841 
ušt8_t
 * 
bufãr
;

842 
sz
;

843 ià(
size
 < 
SIZEOF_LENGTH
)

845 
size
 -ğ
SIZEOF_LENGTH
;

846 
bufãr
 = 
d©a
 + 
SIZEOF_LENGTH
;

847 
¬gs
->
ty³
) {

848 
SPROTO_TINTEGER
: {

849 
nß¼ay
;

850 
bufãr
 = 
	`’code_š‹g”_¬¿y
(
cb
,
¬gs
,bufãr,
size
, &
nß¼ay
);

851 ià(
bufãr
 =ğ
NULL
)

854 ià(
nß¼ay
) {

859 
SPROTO_TBOOLEAN
:

860 
¬gs
->
šdex
 = 1;

862 
v
 = 0;

863 
¬gs
->
v®ue
 = &
v
;

864 
¬gs
->
Ëngth
 = (
v
);

865 
sz
 = 
	`cb
(
¬gs
);

866 ià(
sz
 < 0) {

867 ià(
sz
 =ğ
SPROTO_CB_NIL
)

869 ià(
sz
 =ğ
SPROTO_CB_NOARRAY
)

873 ià(
size
 < 1)

875 
bufãr
[0] = 
v
 ? 1: 0;

876 
size
 -= 1;

877 
bufãr
 += 1;

878 ++
¬gs
->
šdex
;

882 
¬gs
->
šdex
 = 1;

884 ià(
size
 < 
SIZEOF_LENGTH
)

886 
size
 -ğ
SIZEOF_LENGTH
;

887 
¬gs
->
v®ue
 = 
bufãr
+
SIZEOF_LENGTH
;

888 
¬gs
->
Ëngth
 = 
size
;

889 
sz
 = 
	`cb
(
¬gs
);

890 ià(
sz
 < 0) {

891 ià(
sz
 =ğ
SPROTO_CB_NIL
) {

894 ià(
sz
 =ğ
SPROTO_CB_NOARRAY
)

898 
	`fl_size
(
bufãr
, 
sz
);

899 
bufãr
 +ğ
SIZEOF_LENGTH
+
sz
;

900 
size
 -=
sz
;

901 ++
¬gs
->
šdex
;

905 
sz
 = 
bufãr
 - (
d©a
 + 
SIZEOF_LENGTH
);

906  
	`fl_size
(
d©a
, 
sz
);

907 
	}
}

910 
	$¥rÙo_’code
(cÚ¡ 
¥rÙo_ty³
 *
¡
, * 
bufãr
, 
size
, 
¥rÙo_ÿÎback
 
cb
, *
ud
) {

911 
¥rÙo_¬g
 
¬gs
;

912 
ušt8_t
 * 
h—d”
 = 
bufãr
;

913 
ušt8_t
 * 
d©a
;

914 
h—d”_sz
 = 
SIZEOF_HEADER
 + 
¡
->
maxn
 * 
SIZEOF_FIELD
;

915 
i
;

916 
šdex
;

917 
Ï¡g
;

918 
d©asz
;

919 ià(
size
 < 
h—d”_sz
)

921 
¬gs
.
ud
 = ud;

922 
d©a
 = 
h—d”
 + 
h—d”_sz
;

923 
size
 -ğ
h—d”_sz
;

924 
šdex
 = 0;

925 
Ï¡g
 = -1;

926 
i
=0;i<
¡
->
n
;i++) {

927 
f›ld
 *
f
 = &
¡
->f[
i
];

928 
ty³
 = 
f
->type;

929 
v®ue
 = 0;

930 
sz
 = -1;

931 
¬gs
.
gÇme
 = 
f
->
Çme
;

932 
¬gs
.
gid
 = 
f
->
g
;

933 
¬gs
.
subty³
 = 
f
->
¡
;

934 
¬gs
.
maššdex
 = 
f
->
key
;

935 
¬gs
.
exŒa
 = 
f
->extra;

936 ià(
ty³
 & 
SPROTO_TARRAY
) {

937 
¬gs
.
ty³
 =y³ & ~
SPROTO_TARRAY
;

938 
sz
 = 
	`’code_¬¿y
(
cb
, &
¬gs
, 
d©a
, 
size
);

940 
¬gs
.
ty³
 =ype;

941 
¬gs
.
šdex
 = 0;

942 
ty³
) {

943 
SPROTO_TINTEGER
:

944 
SPROTO_TBOOLEAN
: {

946 
ušt64_t
 
u64
;

947 
ušt32_t
 
u32
;

948 } 
u
;

949 
¬gs
.
v®ue
 = &
u
;

950 
¬gs
.
Ëngth
 = (
u
);

951 
sz
 = 
	`cb
(&
¬gs
);

952 ià(
sz
 < 0) {

953 ià(
sz
 =ğ
SPROTO_CB_NIL
)

955 ià(
sz
 =ğ
SPROTO_CB_NOARRAY
)

959 ià(
sz
 =ğ(
ušt32_t
)) {

960 ià(
u
.
u32
 < 0x7fff) {

961 
v®ue
 = (
u
.
u32
+1) * 2;

962 
sz
 = 2;

964 
sz
 = 
	`’code_š‹g”
(
u
.
u32
, 
d©a
, 
size
);

966 } ià(
sz
 =ğ(
ušt64_t
)) {

967 
sz
ğ
	`’code_ušt64
(
u
.
u64
, 
d©a
, 
size
);

973 
SPROTO_TSTRUCT
:

974 
SPROTO_TSTRING
:

975 
sz
 = 
	`’code_objeù
(
cb
, &
¬gs
, 
d©a
, 
size
);

979 ià(
sz
 < 0)

981 ià(
sz
 > 0) {

982 
ušt8_t
 * 
»cÜd
;

983 
g
;

984 ià(
v®ue
 == 0) {

985 
d©a
 +ğ
sz
;

986 
size
 -ğ
sz
;

988 
»cÜd
 = 
h—d”
+
SIZEOF_HEADER
+
SIZEOF_FIELD
*
šdex
;

989 
g
 = 
f
->g - 
Ï¡g
 - 1;

990 ià(
g
 > 0) {

992 
g
 = (tag - 1) * 2 + 1;

993 ià(
g
 > 0xffff)

995 
»cÜd
[0] = 
g
 & 0xff;

996 
»cÜd
[1] = (
g
 >> 8) & 0xff;

997 ++
šdex
;

998 
»cÜd
 +ğ
SIZEOF_FIELD
;

1000 ++
šdex
;

1001 
»cÜd
[0] = 
v®ue
 & 0xff;

1002 
»cÜd
[1] = (
v®ue
 >> 8) & 0xff;

1003 
Ï¡g
 = 
f
->
g
;

1006 
h—d”
[0] = 
šdex
 & 0xff;

1007 
h—d”
[1] = (
šdex
 >> 8) & 0xff;

1009 
d©asz
 = 
d©a
 - (
h—d”
 + 
h—d”_sz
);

1010 
d©a
 = 
h—d”
 + 
h—d”_sz
;

1011 ià(
šdex
 !ğ
¡
->
maxn
) {

1012 
	`memmove
(
h—d”
 + 
SIZEOF_HEADER
 + 
šdex
 * 
SIZEOF_FIELD
, 
d©a
, 
d©asz
);

1014  
SIZEOF_HEADER
 + 
šdex
 * 
SIZEOF_FIELD
 + 
d©asz
;

1015 
	}
}

1018 
	$decode_¬¿y_objeù
(
¥rÙo_ÿÎback
 
cb
, 
¥rÙo_¬g
 *
¬gs
, 
ušt8_t
 * 
¡»am
, 
sz
) {

1019 
ušt32_t
 
hsz
;

1020 
šdex
 = 1;

1021 
sz
 > 0) {

1022 ià(
sz
 < 
SIZEOF_LENGTH
)

1024 
hsz
 = 
	`todwÜd
(
¡»am
);

1025 
¡»am
 +ğ
SIZEOF_LENGTH
;

1026 
sz
 -ğ
SIZEOF_LENGTH
;

1027 ià(
hsz
 > 
sz
)

1029 
¬gs
->
šdex
 = index;

1030 
¬gs
->
v®ue
 = 
¡»am
;

1031 
¬gs
->
Ëngth
 = 
hsz
;

1032 ià(
	`cb
(
¬gs
))

1034 
sz
 -ğ
hsz
;

1035 
¡»am
 +ğ
hsz
;

1036 ++
šdex
;

1039 
	}
}

1041 
šlše
 
ušt64_t


1042 
	$ex·nd64
(
ušt32_t
 
v
) {

1043 
ušt64_t
 
v®ue
 = 
v
;

1044 ià(
v®ue
 & 0x80000000) {

1045 
v®ue
 |ğ(
ušt64_t
)~0 << 32 ;

1047  
v®ue
;

1048 
	}
}

1051 
	$decode_¬¿y
(
¥rÙo_ÿÎback
 
cb
, 
¥rÙo_¬g
 *
¬gs
, 
ušt8_t
 * 
¡»am
) {

1052 
ušt32_t
 
sz
 = 
	`todwÜd
(
¡»am
);

1053 
ty³
 = 
¬gs
->type;

1054 
i
;

1055 ià(
sz
 == 0) {

1057 
¬gs
->
šdex
 = -1;

1058 
¬gs
->
v®ue
 = 
NULL
;

1059 
¬gs
->
Ëngth
 = 0;

1060 
	`cb
(
¬gs
);

1063 
¡»am
 +ğ
SIZEOF_LENGTH
;

1064 
ty³
) {

1065 
SPROTO_TINTEGER
: {

1066 
Ën
 = *
¡»am
;

1067 ++
¡»am
;

1068 --
sz
;

1069 ià(
Ën
 =ğ(
ušt32_t
)) {

1070 ià(
sz
 % (
ušt32_t
) != 0)

1072 
i
=0;i<
sz
/(
ušt32_t
);i++) {

1073 
ušt64_t
 
v®ue
 = 
	`ex·nd64
(
	`todwÜd
(
¡»am
 + 
i
*(
ušt32_t
)));

1074 
¬gs
->
šdex
 = 
i
+1;

1075 
¬gs
->
v®ue
 = &value;

1076 
¬gs
->
Ëngth
 = (
v®ue
);

1077 
	`cb
(
¬gs
);

1079 } ià(
Ën
 =ğ(
ušt64_t
)) {

1080 ià(
sz
 % (
ušt64_t
) != 0)

1082 
i
=0;i<
sz
/(
ušt64_t
);i++) {

1083 
ušt64_t
 
low
 = 
	`todwÜd
(
¡»am
 + 
i
*(uint64_t));

1084 
ušt64_t
 
hi
 = 
	`todwÜd
(
¡»am
 + 
i
*(ušt64_tè+ (
ušt32_t
));

1085 
ušt64_t
 
v®ue
 = 
low
 | 
hi
 << 32;

1086 
¬gs
->
šdex
 = 
i
+1;

1087 
¬gs
->
v®ue
 = &value;

1088 
¬gs
->
Ëngth
 = (
v®ue
);

1089 
	`cb
(
¬gs
);

1096 
SPROTO_TBOOLEAN
:

1097 
i
=0;i<
sz
;i++) {

1098 
ušt64_t
 
v®ue
 = 
¡»am
[
i
];

1099 
¬gs
->
šdex
 = 
i
+1;

1100 
¬gs
->
v®ue
 = &value;

1101 
¬gs
->
Ëngth
 = (
v®ue
);

1102 
	`cb
(
¬gs
);

1105 
SPROTO_TSTRING
:

1106 
SPROTO_TSTRUCT
:

1107  
	`decode_¬¿y_objeù
(
cb
, 
¬gs
, 
¡»am
, 
sz
);

1112 
	}
}

1115 
	$¥rÙo_decode
(cÚ¡ 
¥rÙo_ty³
 *
¡
, cÚ¡ * 
d©a
, 
size
, 
¥rÙo_ÿÎback
 
cb
, *
ud
) {

1116 
¥rÙo_¬g
 
¬gs
;

1117 
tÙ®
 = 
size
;

1118 
ušt8_t
 * 
¡»am
;

1119 
ušt8_t
 * 
d©a¡»am
;

1120 
â
;

1121 
i
;

1122 
g
;

1123 ià(
size
 < 
SIZEOF_HEADER
)

1127 
¡»am
 = (*)
d©a
;

1128 
â
 = 
	`towÜd
(
¡»am
);

1129 
¡»am
 +ğ
SIZEOF_HEADER
;

1130 
size
 -ğ
SIZEOF_HEADER
 ;

1131 ià(
size
 < 
â
 * 
SIZEOF_FIELD
)

1133 
d©a¡»am
 = 
¡»am
 + 
â
 * 
SIZEOF_FIELD
;

1134 
size
 -ğ
â
 * 
SIZEOF_FIELD
;

1135 
¬gs
.
ud
 = ud;

1137 
g
 = -1;

1138 
i
=0;i<
â
;i++) {

1139 
ušt8_t
 * 
cu¼’td©a
;

1140 
f›ld
 * 
f
;

1141 
v®ue
 = 
	`towÜd
(
¡»am
 + 
i
 * 
SIZEOF_FIELD
);

1142 ++ 
g
;

1143 ià(
v®ue
 & 1) {

1144 
g
 +ğ
v®ue
/2;

1147 
v®ue
 = value/2 - 1;

1148 
cu¼’td©a
 = 
d©a¡»am
;

1149 ià(
v®ue
 < 0) {

1150 
ušt32_t
 
sz
;

1151 ià(
size
 < 
SIZEOF_LENGTH
)

1153 
sz
 = 
	`todwÜd
(
d©a¡»am
);

1154 ià(
size
 < 
sz
 + 
SIZEOF_LENGTH
)

1156 
d©a¡»am
 +ğ
sz
+
SIZEOF_LENGTH
;

1157 
size
 -ğ
sz
+
SIZEOF_LENGTH
;

1159 
f
 = 
	`fšdg
(
¡
, 
g
);

1160 ià(
f
 =ğ
NULL
)

1162 
¬gs
.
gÇme
 = 
f
->
Çme
;

1163 
¬gs
.
gid
 = 
f
->
g
;

1164 
¬gs
.
ty³
 = 
f
->ty³ & ~
SPROTO_TARRAY
;

1165 
¬gs
.
subty³
 = 
f
->
¡
;

1166 
¬gs
.
šdex
 = 0;

1167 
¬gs
.
maššdex
 = 
f
->
key
;

1168 
¬gs
.
exŒa
 = 
f
->extra;

1169 ià(
v®ue
 < 0) {

1170 ià(
f
->
ty³
 & 
SPROTO_TARRAY
) {

1171 ià(
	`decode_¬¿y
(
cb
, &
¬gs
, 
cu¼’td©a
)) {

1175 
f
->
ty³
) {

1176 
SPROTO_TINTEGER
: {

1177 
ušt32_t
 
sz
 = 
	`todwÜd
(
cu¼’td©a
);

1178 ià(
sz
 =ğ(
ušt32_t
)) {

1179 
ušt64_t
 
v
 = 
	`ex·nd64
(
	`todwÜd
(
cu¼’td©a
 + 
SIZEOF_LENGTH
));

1180 
¬gs
.
v®ue
 = &
v
;

1181 
¬gs
.
Ëngth
 = (
v
);

1182 
	`cb
(&
¬gs
);

1183 } ià(
sz
 !ğ(
ušt64_t
)) {

1186 
ušt32_t
 
low
 = 
	`todwÜd
(
cu¼’td©a
 + 
SIZEOF_LENGTH
);

1187 
ušt32_t
 
hi
 = 
	`todwÜd
(
cu¼’td©a
 + 
SIZEOF_LENGTH
 + (uint32_t));

1188 
ušt64_t
 
v
 = (ušt64_t)
low
 | (ušt64_tè
hi
 << 32;

1189 
¬gs
.
v®ue
 = &
v
;

1190 
¬gs
.
Ëngth
 = (
v
);

1191 
	`cb
(&
¬gs
);

1195 
SPROTO_TSTRING
:

1196 
SPROTO_TSTRUCT
: {

1197 
ušt32_t
 
sz
 = 
	`todwÜd
(
cu¼’td©a
);

1198 
¬gs
.
v®ue
 = 
cu¼’td©a
+
SIZEOF_LENGTH
;

1199 
¬gs
.
Ëngth
 = 
sz
;

1200 ià(
	`cb
(&
¬gs
))

1208 } ià(
f
->
ty³
 !ğ
SPROTO_TINTEGER
 && f->ty³ !ğ
SPROTO_TBOOLEAN
) {

1211 
ušt64_t
 
v
 = 
v®ue
;

1212 
¬gs
.
v®ue
 = &
v
;

1213 
¬gs
.
Ëngth
 = (
v
);

1214 
	`cb
(&
¬gs
);

1217  
tÙ®
 - 
size
;

1218 
	}
}

1223 
	$·ck_£g
(cÚ¡ 
ušt8_t
 *
¤c
, ušt8_ˆ* 
bufãr
, 
sz
, 
n
) {

1224 
ušt8_t
 
h—d”
 = 0;

1225 
nÙz”o
 = 0;

1226 
i
;

1227 
ušt8_t
 * 
obufãr
 = 
bufãr
;

1228 ++
bufãr
;

1229 --
sz
;

1230 ià(
sz
 < 0)

1231 
obufãr
 = 
NULL
;

1233 
i
=0;i<8;i++) {

1234 ià(
¤c
[
i
] != 0) {

1235 
nÙz”o
++;

1236 
h—d”
 |ğ1<<
i
;

1237 ià(
sz
 > 0) {

1238 *
bufãr
 = 
¤c
[
i
];

1239 ++
bufãr
;

1240 --
sz
;

1244 ià((
nÙz”o
 =ğ7 ||‚Ùz”Ø=ğ6è&& 
n
 > 0) {

1245 
nÙz”o
 = 8;

1247 ià(
nÙz”o
 == 8) {

1248 ià(
n
 > 0) {

1254 ià(
obufãr
) {

1255 *
obufãr
 = 
h—d”
;

1257  
nÙz”o
 + 1;

1258 
	}
}

1260 
šlše
 

1261 
	$wr™e_ff
(cÚ¡ 
ušt8_t
 * 
¤c
, ušt8_ˆ* 
des
, 
n
) {

1262 
i
;

1263 
®ign8_n
 = (
n
+7)&(~7);

1265 
des
[0] = 0xff;

1266 
des
[1] = 
®ign8_n
/8 - 1;

1267 
	`memıy
(
des
+2, 
¤c
, 
n
);

1268 
i
=0; i< 
®ign8_n
-
n
; i++){

1269 
des
[
n
+2+
i
] = 0;

1271 
	}
}

1274 
	$¥rÙo_·ck
(cÚ¡ * 
¤cv
, 
¤csz
, * 
bufãrv
, 
bufsz
) {

1275 
ušt8_t
 
tmp
[8];

1276 
i
;

1277 cÚ¡ 
ušt8_t
 * 
ff_¤c¡¬t
 = 
NULL
;

1278 
ušt8_t
 * 
ff_des¡¬t
 = 
NULL
;

1279 
ff_n
 = 0;

1280 
size
 = 0;

1281 cÚ¡ 
ušt8_t
 * 
¤c
 = 
¤cv
;

1282 
ušt8_t
 * 
bufãr
 = 
bufãrv
;

1283 
i
=0;i<
¤csz
;i+=8) {

1284 
n
;

1285 
·ddšg
 = 
i
+8 - 
¤csz
;

1286 ià(
·ddšg
 > 0) {

1287 
j
;

1288 
	`memıy
(
tmp
, 
¤c
, 8-
·ddšg
);

1289 
j
=0;j<
·ddšg
;j++) {

1290 
tmp
[7-
j
] = 0;

1292 
¤c
 = 
tmp
;

1294 
n
 = 
	`·ck_£g
(
¤c
, 
bufãr
, 
bufsz
, 
ff_n
);

1295 
bufsz
 -ğ
n
;

1296 ià(
n
 == 10) {

1298 
ff_¤c¡¬t
 = 
¤c
;

1299 
ff_des¡¬t
 = 
bufãr
;

1300 
ff_n
 = 1;

1301 } ià(
n
==8 && 
ff_n
>0) {

1302 ++
ff_n
;

1303 ià(
ff_n
 == 256) {

1304 ià(
bufsz
 >= 0) {

1305 
	`wr™e_ff
(
ff_¤c¡¬t
, 
ff_des¡¬t
, 256*8);

1307 
ff_n
 = 0;

1310 ià(
ff_n
 > 0) {

1311 ià(
bufsz
 >= 0) {

1312 
	`wr™e_ff
(
ff_¤c¡¬t
, 
ff_des¡¬t
, 
ff_n
*8);

1314 
ff_n
 = 0;

1317 
¤c
 += 8;

1318 
bufãr
 +ğ
n
;

1319 
size
 +ğ
n
;

1321 if(
bufsz
 >= 0){

1322 if(
ff_n
 == 1)

1323 
	`wr™e_ff
(
ff_¤c¡¬t
, 
ff_des¡¬t
, 8);

1324 ià(
ff_n
 > 1)

1325 
	`wr™e_ff
(
ff_¤c¡¬t
, 
ff_des¡¬t
, 
¤csz
 - (
šŒ_t
)(ff_¤c¡¬ˆ- (cÚ¡ 
ušt8_t
*)
¤cv
));

1327  
size
;

1328 
	}
}

1331 
	$¥rÙo_uÅack
(cÚ¡ * 
¤cv
, 
¤csz
, * 
bufãrv
, 
bufsz
) {

1332 cÚ¡ 
ušt8_t
 * 
¤c
 = 
¤cv
;

1333 
ušt8_t
 * 
bufãr
 = 
bufãrv
;

1334 
size
 = 0;

1335 
¤csz
 > 0) {

1336 
ušt8_t
 
h—d”
 = 
¤c
[0];

1337 --
¤csz
;

1338 ++
¤c
;

1339 ià(
h—d”
 == 0xff) {

1340 
n
;

1341 ià(
¤csz
 < 0) {

1344 
n
 = (
¤c
[0] + 1) * 8;

1345 ià(
¤csz
 < 
n
 + 1)

1347 
¤csz
 -ğ
n
 + 1;

1348 ++
¤c
;

1349 ià(
bufsz
 >ğ
n
) {

1350 
	`memıy
(
bufãr
, 
¤c
, 
n
);

1352 
bufsz
 -ğ
n
;

1353 
bufãr
 +ğ
n
;

1354 
¤c
 +ğ
n
;

1355 
size
 +ğ
n
;

1357 
i
;

1358 
i
=0;i<8;i++) {

1359 
nz
 = (
h—d”
 >> 
i
) & 1;

1360 ià(
nz
) {

1361 ià(
¤csz
 < 0)

1363 ià(
bufsz
 > 0) {

1364 *
bufãr
 = *
¤c
;

1365 --
bufsz
;

1366 ++
bufãr
;

1368 ++
¤c
;

1369 --
¤csz
;

1371 ià(
bufsz
 > 0) {

1372 *
bufãr
 = 0;

1373 --
bufsz
;

1374 ++
bufãr
;

1377 ++
size
;

1381  
size
;

1382 
	}
}

	@lualib-src/sproto/sproto.h

1 #iâdeà
¥rÙo_h


2 
	#¥rÙo_h


	)

4 
	~<¡ddef.h
>

6 
	g¥rÙo
;

7 
	g¥rÙo_ty³
;

9 
	#SPROTO_REQUEST
 0

	)

10 
	#SPROTO_RESPONSE
 1

	)

13 
	#SPROTO_TINTEGER
 0

	)

14 
	#SPROTO_TBOOLEAN
 1

	)

15 
	#SPROTO_TSTRING
 2

	)

16 
	#SPROTO_TSTRUCT
 3

	)

19 
	#SPROTO_TSTRING_STRING
 0

	)

20 
	#SPROTO_TSTRING_BINARY
 1

	)

22 
	#SPROTO_CB_ERROR
 -1

	)

23 
	#SPROTO_CB_NIL
 -2

	)

24 
	#SPROTO_CB_NOARRAY
 -3

	)

26 
¥rÙo
 * 
¥rÙo_ü—‹
(cÚ¡ * 
´Ùo
, 
size_t
 
sz
);

27 
¥rÙo_»Ëa£
(
¥rÙo
 *);

29 
¥rÙo_´ÙÙag
(cÚ¡ 
¥rÙo
 *, cÚ¡ * 
Çme
);

30 cÚ¡ * 
¥rÙo_´ÙÚame
(cÚ¡ 
¥rÙo
 *, 
´Ùo
);

32 
¥rÙo_ty³
 * 
¥rÙo_´Ùoqu”y
(cÚ¡ 
¥rÙo
 *, 
´Ùo
, 
wh©
);

33 
¥rÙo_´ÙÜe¥Ú£
(cÚ¡ 
¥rÙo
 *, 
´Ùo
);

35 
¥rÙo_ty³
 * s´Ùo_ty³(cÚ¡ 
¥rÙo
 *, cÚ¡ * 
ty³_Çme
);

37 
¥rÙo_·ck
(cÚ¡ * 
¤c
, 
¤csz
, * 
bufãr
, 
bufsz
);

38 
¥rÙo_uÅack
(cÚ¡ * 
¤c
, 
¤csz
, * 
bufãr
, 
bufsz
);

40 
	s¥rÙo_¬g
 {

41 *
	mud
;

42 cÚ¡ *
	mgÇme
;

43 
	mgid
;

44 
	mty³
;

45 
¥rÙo_ty³
 *
	msubty³
;

46 *
	mv®ue
;

47 
	mËngth
;

48 
	mšdex
;

49 
	mmaššdex
;

50 
	mexŒa
;

53 (*
	t¥rÙo_ÿÎback
)(cÚ¡ 
	t¥rÙo_¬g
 *
	t¬gs
);

55 
	`¥rÙo_decode
(cÚ¡ 
¥rÙo_ty³
 *, cÚ¡ * 
d©a
, 
size
, 
¥rÙo_ÿÎback
 
cb
, *
ud
);

56 
	`¥rÙo_’code
(cÚ¡ 
¥rÙo_ty³
 *, * 
bufãr
, 
size
, 
¥rÙo_ÿÎback
 
cb
, *
ud
);

59 
	`¥rÙo_dump
(
¥rÙo
 *);

60 cÚ¡ * 
	`¥rÙo_Çme
(
¥rÙo_ty³
 *);

	@lualib-src/wordfilterCpp/wordfilter.cpp

1 
	~<m­
>

2 
	~<time.h
>

3 
	~<c¡ršg
>

4 
	~<io¡»am
>

7 
	~<lua.h
>

8 
	~<Ïuxlib.h
>

9 
	~<¡dlib.h
>

12 
	snode
{

13 
¡d
::
m­
<,
node
*> 
m
;

14 
boŞ
 
bL—f
;

15 
c
;

18 
	$´štEm±y
(
em±yCouÁ
){

19 
i
 = 0; i <
em±yCouÁ
; i++) {

20 
¡d
::
cout
 << ' ';

22 
	}
}

23 
	$__´štNode
(cÚ¡ 
node
 *
n
,
em±yCouÁ
){

24 autØ
™
=
n
->
m
.
	`begš
(); iˆ!ğn->m.
	`’d
(); it++ ) {

25 
	`´štEm±y
(
em±yCouÁ
);

26 
¡d
::
cout
 << 
em±yCouÁ
 << "->" << 
™
->
£cÚd
->
c
 << std::
’dl
;

27 
	`__´štNode
(
™
->
£cÚd
, 
em±yCouÁ
+1);

29 
	}
}

30 
	$´štNode
(cÚ¡ 
node
 *
n
){

31 
	`__´štNode
(
n
,1);

32 
	}
}

34 "C" 
	$addkeywÜd
(
node
 *
roÙNode
,cÚ¡ * 
szSŒ
){

35 
l
 = 
	`¡¾’
(
szSŒ
);

36 
node
 *
²
 = 
roÙNode
;

37 
i
 = 0; i <
l
; i++) {

38 
c
 = 
szSŒ
[
i
];

39 
node
 *
n
 = 
²
->
m
[
c
];

40 iàĞ
n
 =ğ
NULL
 ){

41 
n
 = 
Ãw
 
	`node
();

42 
n
->
c
 = c;

43 
n
->
bL—f
 = 
çl£
;

44 
²
->
m
[
c
] = 
n
;

46 
²
 = 
n
;

48 
²
->
bL—f
 = 
Œue
;

49 
	}
}

51 "C" 
	$»¶aû
(
node
 *
roÙNode
, * 
szSŒ
){

52 
l
 = 
	`¡¾’
(
szSŒ
);

53 
i
=0;

54  
i
 < 
l
 ){

55 
x
 = 
i
;

56 
y
 = 
x
;

57 
c
 = 
szSŒ
[
i
];

58 
node
 *
n
 = 
roÙNode
;

59 iàĞ
n
->
m
[
c
] ){

60 
n
 !ğ
NULL
 &&‚->
m
[
c
] != NULL ) {

61 
n
 =‚->
m
[
c
];

62 ++ 
y
;

63 
c
 = 
szSŒ
[
y
];

67 iàĞ
n
 !ğ
NULL
 &&‚->
bL—f
 ){

68 iàĞ
y
 > 
x
 && y <ğ
l
 ){

69 
ii
 = 
x
; i˜<
y
; ++ii) {

70 
szSŒ
[
ii
] = '*';

72 
i
 = 
y
-1;

75 ++ 
i
;

77 
	}
}

80 
	$lü—‹
(
lua_S‹
 *
L
){

81 
node
 *
»t
 = 
Ãw
 
	`node
();

82 
	`lua_pushlightu£rd©a
(
L
,
»t
);

84 
	}
}

87 
	$lde¡Üy
(
lua_S‹
 *
L
){

88 
node
 *
»t
 = (nod*)
	`lua_tou£rd©a
(
L
,1);

89 
d–‘e
 
»t
;

91 
	}
}

94 
	$ÏddKeyWÜd
(
lua_S‹
 *
L
){

95 
node
 *
n
 = (node*)
	`lua_tou£rd©a
(
L
,1);

96 iàĞ
n
 =ğ
NULL
)  0;

97 cÚ¡ * 
szSŒ
 = 
	`lua_to¡ršg
(
L
,2);

98 iàĞ
szSŒ
 =ğ
NULL
 )  0;

99 
	`addkeywÜd
(
n
,
szSŒ
);

100 
	`lua_pushš‹g”
(
L
,1);

102 
	}
}

106 
	$Ì•Ïû
(
lua_S‹
 *
L
){

107 
node
 *
n
 = (node*)
	`lua_tou£rd©a
(
L
,1);

108 iàĞ
n
 =ğ
NULL
)  0;

109 cÚ¡ * 
szSŒ
 = 
	`lua_to¡ršg
(
L
,2);

110 iàĞ
szSŒ
 =ğ
NULL
 )  0;

112 
size_t
 
¡rL’
 = 
	`¡¾’
(
szSŒ
)+1;

113 *
»tSŒ
 = (*)
	`m®loc
(()*(
¡rL’
));

114 
»tSŒ
[
¡rL’
-1] = 0;

115 
	`¡rıy
(
»tSŒ
,
szSŒ
);

116 
	`»¶aû
(
n
,
»tSŒ
);

118 
	`lua_push¡ršg
(
L
,
»tSŒ
);

119 
	`ä“
(
»tSŒ
);

121 
	}
}

124 
	$luaİ’_wÜdf‹r
(
lua_S‹
 *
L
) {

125 
	`luaL_checkv”siÚ
(
L
);

126 
luaL_Reg
 
l
[] = {

127 { "ü—‹", 
lü—‹
},

128 { "de¡Üy", 
lde¡Üy
},

129 { "addkeywÜd",
ÏddKeyWÜd
},

130 { "»¶aû",
Ì•Ïû
},

131 { 
NULL
, NULL },

134 
	`luaL_Ãwlib
(
L
,
l
);

136 
	}
}

	@service-src/databuffer.h

1 #iâdeà
skyÃt_d©abufãr_h


2 
	#skyÃt_d©abufãr_h


	)

4 
	~<¡dlib.h
>

5 
	~<¡ršg.h
>

6 
	~<as£¹.h
>

8 
	#MESSAGEPOOL
 1023

	)

10 
	smes§ge
 {

11 * 
	mbufãr
;

12 
	msize
;

13 
mes§ge
 * 
	mÃxt
;

16 
	sd©abufãr
 {

17 
	mh—d”
;

18 
	moff£t
;

19 
	msize
;

20 
mes§ge
 * 
	mh—d
;

21 
mes§ge
 * 
	m
;

24 
	smes§g•oŞ_li¡
 {

25 
mes§g•oŞ_li¡
 *
	mÃxt
;

26 
mes§ge
 
	mpoŞ
[
MESSAGEPOOL
];

29 
	smes§g•oŞ
 {

30 
mes§g•oŞ_li¡
 * 
	mpoŞ
;

31 
mes§ge
 * 
	mä“li¡
;

37 
	$mes§g•oŞ_ä“
(
mes§g•oŞ
 *
poŞ
) {

38 
mes§g•oŞ_li¡
 *
p
 = 
poŞ
->pool;

39 
p
) {

40 
mes§g•oŞ_li¡
 *
tmp
 = 
p
;

41 
p
õ->
Ãxt
;

42 
	`skyÃt_ä“
(
tmp
);

44 
poŞ
->poŞ = 
NULL
;

45 
poŞ
->
ä“li¡
 = 
NULL
;

46 
	}
}

48 
šlše
 

49 
	$_»tuº_mes§ge
(
d©abufãr
 *
db
, 
mes§g•oŞ
 *
mp
) {

50 
mes§ge
 *
m
 = 
db
->
h—d
;

51 ià(
m
->
Ãxt
 =ğ
NULL
) {

52 
	`as£¹
(
db
->

 =ğ
m
);

53 
db
->
h—d
 = db->

 = 
NULL
;

55 
db
->
h—d
 = 
m
->
Ãxt
;

57 
	`skyÃt_ä“
(
m
->
bufãr
);

58 
m
->
bufãr
 = 
NULL
;

59 
m
->
size
 = 0;

60 
m
->
Ãxt
 = 
mp
->
ä“li¡
;

61 
mp
->
ä“li¡
 = 
m
;

62 
	}
}

65 
	$d©abufãr_»ad
(
d©abufãr
 *
db
, 
mes§g•oŞ
 *
mp
, * 
bufãr
, 
sz
) {

66 
	`as£¹
(
db
->
size
 >ğ
sz
);

67 
db
->
size
 -ğ
sz
;

69 
mes§ge
 *
cu¼’t
 = 
db
->
h—d
;

70 
bsz
 = 
cu¼’t
->
size
 - 
db
->
off£t
;

71 ià(
bsz
 > 
sz
) {

72 
	`memıy
(
bufãr
, 
cu¼’t
->bufã¸+ 
db
->
off£t
, 
sz
);

73 
db
->
off£t
 +ğ
sz
;

76 ià(
bsz
 =ğ
sz
) {

77 
	`memıy
(
bufãr
, 
cu¼’t
->bufã¸+ 
db
->
off£t
, 
sz
);

78 
db
->
off£t
 = 0;

79 
	`_»tuº_mes§ge
(
db
, 
mp
);

82 
	`memıy
(
bufãr
, 
cu¼’t
->bufã¸+ 
db
->
off£t
, 
bsz
);

83 
	`_»tuº_mes§ge
(
db
, 
mp
);

84 
db
->
off£t
 = 0;

85 
bufãr
+=
bsz
;

86 
sz
-=
bsz
;

89 
	}
}

92 
	$d©abufãr_push
(
d©abufãr
 *
db
, 
mes§g•oŞ
 *
mp
, *
d©a
, 
sz
) {

93 
mes§ge
 * 
m
;

94 ià(
mp
->
ä“li¡
) {

95 
m
 = 
mp
->
ä“li¡
;

96 
mp
->
ä“li¡
 = 
m
->
Ãxt
;

98 
mes§g•oŞ_li¡
 * 
m¶
 = 
	`skyÃt_m®loc
((*mpl));

99 
mes§ge
 * 
‹mp
 = 
m¶
->
poŞ
;

100 
i
;

101 
i
=1;i<
MESSAGEPOOL
;i++) {

102 
‹mp
[
i
].
bufãr
 = 
NULL
;

103 
‹mp
[
i
].
size
 = 0;

104 
‹mp
[
i
].
Ãxt
 = &temp[i+1];

106 
‹mp
[
MESSAGEPOOL
-1].
Ãxt
 = 
NULL
;

107 
m¶
->
Ãxt
 = 
mp
->
poŞ
;

108 
mp
->
poŞ
 = 
m¶
;

109 
m
 = &
‹mp
[0];

110 
mp
->
ä“li¡
 = &
‹mp
[1];

112 
m
->
bufãr
 = 
d©a
;

113 
m
->
size
 = 
sz
;

114 
m
->
Ãxt
 = 
NULL
;

115 
db
->
size
 +ğ
sz
;

116 ià(
db
->
h—d
 =ğ
NULL
) {

117 
	`as£¹
(
db
->

 =ğ
NULL
);

118 
db
->
h—d
 = db->

 = 
m
;

120 
db
->

->
Ãxt
 = 
m
;

121 
db
->

 = 
m
;

123 
	}
}

126 
	$d©abufãr_»adh—d”
(
d©abufãr
 *
db
, 
mes§g•oŞ
 *
mp
, 
h—d”_size
) {

127 ià(
db
->
h—d”
 == 0) {

129 ià(
db
->
size
 < 
h—d”_size
) {

132 
ušt8_t
 
¶’
[4];

133 
	`d©abufãr_»ad
(
db
,
mp
,(*)
¶’
,
h—d”_size
);

135 ià(
h—d”_size
 == 2) {

136 
db
->
h—d”
 = 
¶’
[0] << 8 |…len[1];

138 
db
->
h—d”
 = 
¶’
[0] << 24 |…len[1] << 16 |…len[2] << 8 |…len[3];

141 ià(
db
->
size
 < db->
h—d”
)

143  
db
->
h—d”
;

144 
	}
}

146 
šlše
 

147 
	$d©abufãr_»£t
(
d©abufãr
 *
db
) {

148 
db
->
h—d”
 = 0;

149 
	}
}

152 
	$d©abufãr_ş—r
(
d©abufãr
 *
db
, 
mes§g•oŞ
 *
mp
) {

153 
db
->
h—d
) {

154 
	`_»tuº_mes§ge
(
db
,
mp
);

156 
	`mem£t
(
db
, 0, (*db));

157 
	}
}

	@service-src/hashid.h

1 #iâdeà
skyÃt_hashid_h


2 
	#skyÃt_hashid_h


	)

4 
	~<as£¹.h
>

5 
	~<¡dlib.h
>

6 
	~<¡ršg.h
>

8 
	shashid_node
 {

9 
	mid
;

10 
hashid_node
 *
	mÃxt
;

13 
	shashid
 {

14 
	mhashmod
;

15 
	mÿp
;

16 
	mcouÁ
;

17 
hashid_node
 *
	mid
;

18 
hashid_node
 **
	mhash
;

22 
	$hashid_š™
(
hashid
 *
hi
, 
max
) {

23 
i
;

24 
hashÿp
;

25 
hashÿp
 = 16;

26 
hashÿp
 < 
max
) {

27 
hashÿp
 *= 2;

29 
hi
->
hashmod
 = 
hashÿp
 - 1;

30 
hi
->
ÿp
 = 
max
;

31 
hi
->
couÁ
 = 0;

32 
hi
->
id
 = 
	`skyÃt_m®loc
(
max
 * (
hashid_node
));

33 
i
=0;i<
max
;i++) {

34 
hi
->
id
[
i
].id = -1;

35 
hi
->
id
[
i
].
Ãxt
 = 
NULL
;

37 
hi
->
hash
 = 
	`skyÃt_m®loc
(
hashÿp
 * (
hashid_node
 *));

38 
	`mem£t
(
hi
->
hash
, 0, 
hashÿp
 * (
hashid_node
 *));

39 
	}
}

42 
	$hashid_ş—r
(
hashid
 *
hi
) {

43 
	`skyÃt_ä“
(
hi
->
id
);

44 
	`skyÃt_ä“
(
hi
->
hash
);

45 
hi
->
id
 = 
NULL
;

46 
hi
->
hash
 = 
NULL
;

47 
hi
->
hashmod
 = 1;

48 
hi
->
ÿp
 = 0;

49 
hi
->
couÁ
 = 0;

50 
	}
}

53 
	$hashid_lookup
(
hashid
 *
hi
, 
id
) {

54 
h
 = 
id
 & 
hi
->
hashmod
;

55 
hashid_node
 * 
c
 = 
hi
->
hash
[
h
];

56 
c
) {

57 ià(
c
->
id
 == id)

58  
c
 - 
hi
->
id
;

59 
c
 = c->
Ãxt
;

62 
	}
}

65 
	$hashid_»move
(
hashid
 *
hi
, 
id
) {

66 
h
 = 
id
 & 
hi
->
hashmod
;

67 
hashid_node
 * 
c
 = 
hi
->
hash
[
h
];

68 ià(
c
 =ğ
NULL
)

70 ià(
c
->
id
 == id) {

71 
hi
->
hash
[
h
] = 
c
->
Ãxt
;

72 
_ş—r
;

74 
c
->
Ãxt
) {

75 ià(
c
->
Ãxt
->
id
 == id) {

76 
hashid_node
 * 
‹mp
 = 
c
->
Ãxt
;

77 
c
->
Ãxt
 = 
‹mp
->next;

78 
c
 = 
‹mp
;

79 
_ş—r
;

81 
c
 = c->
Ãxt
;

84 
_ş—r
:

85 
c
->
id
 = -1;

86 
c
->
Ãxt
 = 
NULL
;

87 --
hi
->
couÁ
;

88  
c
 - 
hi
->
id
;

89 
	}
}

92 
	$hashid_š£¹
(
hashid
 * 
hi
, 
id
) {

93 
hashid_node
 *
c
 = 
NULL
;

94 
i
;

95 
i
=0;i<
hi
->
ÿp
;i++) {

96 
šdex
 = (
i
+
id
è% 
hi
->
ÿp
;

97 ià(
hi
->
id
[
šdex
].id == -1) {

98 
c
 = &
hi
->
id
[
šdex
];

102 
	`as£¹
(
c
);

103 ++
hi
->
couÁ
;

104 
c
->
id
 = id;

105 
	`as£¹
(
c
->
Ãxt
 =ğ
NULL
);

106 
h
 = 
id
 & 
hi
->
hashmod
;

107 ià(
hi
->
hash
[
h
]) {

108 
c
->
Ãxt
 = 
hi
->
hash
[
h
];

110 
hi
->
hash
[
h
] = 
c
;

112  
c
 - 
hi
->
id
;

113 
	}
}

115 
šlše
 

116 
	$hashid_fuÎ
(
hashid
 *
hi
) {

117  
hi
->
couÁ
 =ğhi->
ÿp
;

118 
	}
}

	@service-src/service_gate.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_sock‘.h
"

3 
	~"d©abufãr.h
"

4 
	~"hashid.h
"

6 
	~<¡dlib.h
>

7 
	~<¡ršg.h
>

8 
	~<as£¹.h
>

9 
	~<¡dšt.h
>

10 
	~<¡dio.h
>

11 
	~<¡d¬g.h
>

13 
	#BACKLOG
 32

	)

15 
	scÚÃùiÚ
 {

16 
	mid
;

17 
ušt32_t
 
	mag’t
;

18 
ušt32_t
 
	mş›Á
;

19 
	m»mÙe_Çme
[32];

20 
d©abufãr
 
	mbufãr
;

23 
	sg©e
 {

24 
skyÃt_cÚ‹xt
 *
	mùx
;

25 
	mli¡’_id
;

26 
ušt32_t
 
	mw©chdog
;

27 
ušt32_t
 
	mbrok”
;

28 
	mş›Á_g
;

29 
	mh—d”_size
;

30 
	mmax_cÚÃùiÚ
;

31 
hashid
 
	mhash
;

32 
cÚÃùiÚ
 *
	mcÚn
;

34 
mes§g•oŞ
 
	mmp
;

37 
g©e
 *

38 
	$g©e_ü—‹
() {

39 
g©e
 * 
g
 = 
	`skyÃt_m®loc
((*g));

40 
	`mem£t
(
g
,0,(*g));

41 
g
->
li¡’_id
 = -1;

42  
g
;

43 
	}
}

46 
	$g©e_»Ëa£
(
g©e
 *
g
) {

47 
i
;

48 
skyÃt_cÚ‹xt
 *
ùx
 = 
g
->ctx;

49 
i
=0;i<
g
->
max_cÚÃùiÚ
;i++) {

50 
cÚÃùiÚ
 *
c
 = &
g
->
cÚn
[
i
];

51 ià(
c
->
id
 >=0) {

52 
	`skyÃt_sock‘_şo£
(
ùx
, 
c
->
id
);

55 ià(
g
->
li¡’_id
 >= 0) {

56 
	`skyÃt_sock‘_şo£
(
ùx
, 
g
->
li¡’_id
);

58 
	`mes§g•oŞ_ä“
(&
g
->
mp
);

59 
	`hashid_ş—r
(&
g
->
hash
);

60 
	`skyÃt_ä“
(
g
->
cÚn
);

61 
	`skyÃt_ä“
(
g
);

62 
	}
}

65 
	$_·rm
(*
msg
, 
sz
, 
commªd_sz
) {

66 
commªd_sz
 < 
sz
) {

67 ià(
msg
[
commªd_sz
] != ' ')

69 ++
commªd_sz
;

71 
i
;

72 
i
=
commªd_sz
;i<
sz
;i++) {

73 
msg
[
i
-
commªd_sz
] = msg[i];

75 
msg
[
i
-
commªd_sz
] = '\0';

76 
	}
}

79 
	$_fÜw¬d_ag’t
(
g©e
 * 
g
, 
fd
, 
ušt32_t
 
ag’ddr
, ušt32_ˆ
ş›Áaddr
) {

80 
id
 = 
	`hashid_lookup
(&
g
->
hash
, 
fd
);

81 ià(
id
 >=0) {

82 
cÚÃùiÚ
 * 
ag’t
 = &
g
->
cÚn
[
id
];

83 
ag’t
->ag’ˆğ
ag’ddr
;

84 
ag’t
->
ş›Á
 = 
ş›Áaddr
;

86 
	}
}

89 
	$_ù¾
(
g©e
 * 
g
, cÚ¡ * 
msg
, 
sz
) {

90 
skyÃt_cÚ‹xt
 * 
ùx
 = 
g
->ctx;

91 
tmp
[
sz
+1];

92 
	`memıy
(
tmp
, 
msg
, 
sz
);

93 
tmp
[
sz
] = '\0';

94 * 
commªd
 = 
tmp
;

95 
i
;

96 ià(
sz
 == 0)

98 
i
=0;i<
sz
;i++) {

99 ià(
commªd
[
i
]==' ') {

103 ià(
	`memcmp
(
commªd
,"kick",
i
)==0) {

104 
	`_·rm
(
tmp
, 
sz
, 
i
);

105 
uid
 = 
	`¡¹Ş
(
commªd
 , 
NULL
, 10);

106 
id
 = 
	`hashid_lookup
(&
g
->
hash
, 
uid
);

107 ià(
id
>=0) {

108 
	`skyÃt_sock‘_şo£
(
ùx
, 
uid
);

112 ià(
	`memcmp
(
commªd
,"fÜw¬d",
i
)==0) {

113 
	`_·rm
(
tmp
, 
sz
, 
i
);

114 * 
ş›Á
 = 
tmp
;

115 * 
id¡r
 = 
	`¡r£p
(&
ş›Á
, " ");

116 ià(
ş›Á
 =ğ
NULL
) {

119 
id
 = 
	`¡¹Ş
(
id¡r
 , 
NULL
, 10);

120 * 
ag’t
 = 
	`¡r£p
(&
ş›Á
, " ");

121 ià(
ş›Á
 =ğ
NULL
) {

124 
ušt32_t
 
ag’t_hªdË
 = 
	`¡¹oul
(
ag’t
+1, 
NULL
, 16);

125 
ušt32_t
 
ş›Á_hªdË
 = 
	`¡¹oul
(
ş›Á
+1, 
NULL
, 16);

126 
	`_fÜw¬d_ag’t
(
g
, 
id
, 
ag’t_hªdË
, 
ş›Á_hªdË
);

129 ià(
	`memcmp
(
commªd
,"brok”",
i
)==0) {

130 
	`_·rm
(
tmp
, 
sz
, 
i
);

131 
g
->
brok”
 = 
	`skyÃt_qu”yÇme
(
ùx
, 
commªd
);

134 ià(
	`memcmp
(
commªd
,"¡¬t",
i
) == 0) {

135 
	`_·rm
(
tmp
, 
sz
, 
i
);

136 
uid
 = 
	`¡¹Ş
(
commªd
 , 
NULL
, 10);

137 
id
 = 
	`hashid_lookup
(&
g
->
hash
, 
uid
);

138 ià(
id
>=0) {

139 
	`skyÃt_sock‘_¡¬t
(
ùx
, 
uid
);

143 ià(
	`memcmp
(
commªd
, "şo£", 
i
) == 0) {

144 ià(
g
->
li¡’_id
 >= 0) {

145 
	`skyÃt_sock‘_şo£
(
ùx
, 
g
->
li¡’_id
);

146 
g
->
li¡’_id
 = -1;

150 
	`skyÃt_”rÜ
(
ùx
, "[g©e] UnkowÀcommªd : %s", 
commªd
);

151 
	}
}

154 
	$_»pÜt
(
g©e
 * 
g
, cÚ¡ * 
d©a
, ...) {

155 ià(
g
->
w©chdog
 == 0) {

158 
skyÃt_cÚ‹xt
 * 
ùx
 = 
g
->ctx;

159 
va_li¡
 
­
;

160 
	`va_¡¬t
(
­
, 
d©a
);

161 
tmp
[1024];

162 
n
 = 
	`v¢´štf
(
tmp
, Ñmp), 
d©a
, 
­
);

163 
	`va_’d
(
­
);

165 
	`skyÃt_£nd
(
ùx
, 0, 
g
->
w©chdog
, 
PTYPE_TEXT
, 0, 
tmp
, 
n
);

166 
	}
}

169 
	$_fÜw¬d
(
g©e
 *
g
, 
cÚÃùiÚ
 * 
c
, 
size
) {

170 
skyÃt_cÚ‹xt
 * 
ùx
 = 
g
->ctx;

171 ià(
g
->
brok”
) {

172 * 
‹mp
 = 
	`skyÃt_m®loc
(
size
);

173 
	`d©abufãr_»ad
(&
c
->
bufãr
,&
g
->
mp
,
‹mp
, 
size
);

174 
	`skyÃt_£nd
(
ùx
, 0, 
g
->
brok”
, g->
ş›Á_g
 | 
PTYPE_TAG_DONTCOPY
, 1, 
‹mp
, 
size
);

177 ià(
c
->
ag’t
) {

178 * 
‹mp
 = 
	`skyÃt_m®loc
(
size
);

179 
	`d©abufãr_»ad
(&
c
->
bufãr
,&
g
->
mp
,
‹mp
, 
size
);

180 
	`skyÃt_£nd
(
ùx
, 
c
->
ş›Á
, c->
ag’t
, 
g
->
ş›Á_g
 | 
PTYPE_TAG_DONTCOPY
, 1 , 
‹mp
, 
size
);

181 } ià(
g
->
w©chdog
) {

182 * 
tmp
 = 
	`skyÃt_m®loc
(
size
 + 32);

183 
n
 = 
	`¢´štf
(
tmp
,32,"%d d©¨",
c
->
id
);

184 
	`d©abufãr_»ad
(&
c
->
bufãr
,&
g
->
mp
,
tmp
+
n
,
size
);

185 
	`skyÃt_£nd
(
ùx
, 0, 
g
->
w©chdog
, 
PTYPE_TEXT
 | 
PTYPE_TAG_DONTCOPY
, 1, 
tmp
, 
size
 + 
n
);

187 
	}
}

190 
	$di¥©ch_mes§ge
(
g©e
 *
g
, 
cÚÃùiÚ
 *
c
, 
id
, * 
d©a
, 
sz
) {

191 
	`d©abufãr_push
(&
c
->
bufãr
,&
g
->
mp
, 
d©a
, 
sz
);

193 
size
 = 
	`d©abufãr_»adh—d”
(&
c
->
bufãr
, &
g
->
mp
, g->
h—d”_size
);

194 ià(
size
 < 0) {

196 } ià(
size
 > 0) {

197 ià(
size
 >= 0x1000000) {

198 
skyÃt_cÚ‹xt
 * 
ùx
 = 
g
->ctx;

199 
	`d©abufãr_ş—r
(&
c
->
bufãr
,&
g
->
mp
);

200 
	`skyÃt_sock‘_şo£
(
ùx
, 
id
);

201 
	`skyÃt_”rÜ
(
ùx
, "Recv socket message > 16M");

204 
	`_fÜw¬d
(
g
, 
c
, 
size
);

205 
	`d©abufãr_»£t
(&
c
->
bufãr
);

209 
	}
}

212 
	$di¥©ch_sock‘_mes§ge
(
g©e
 *
g
, cÚ¡ 
skyÃt_sock‘_mes§ge
 * 
mes§ge
, 
sz
) {

213 
skyÃt_cÚ‹xt
 * 
ùx
 = 
g
->ctx;

214 
mes§ge
->
ty³
) {

215 
SKYNET_SOCKET_TYPE_DATA
: {

216 
id
 = 
	`hashid_lookup
(&
g
->
hash
, 
mes§ge
->id);

217 ià(
id
>=0) {

218 
cÚÃùiÚ
 *
c
 = &
g
->
cÚn
[
id
];

219 
	`di¥©ch_mes§ge
(
g
, 
c
, 
mes§ge
->
id
, mes§ge->
bufãr
, mes§ge->
ud
);

221 
	`skyÃt_”rÜ
(
ùx
, "Drİ unknowÀcÚÃùiÚ %d mes§ge", 
mes§ge
->
id
);

222 
	`skyÃt_sock‘_şo£
(
ùx
, 
mes§ge
->
id
);

223 
	`skyÃt_ä“
(
mes§ge
->
bufãr
);

227 
SKYNET_SOCKET_TYPE_CONNECT
: {

228 ià(
mes§ge
->
id
 =ğ
g
->
li¡’_id
) {

232 
id
 = 
	`hashid_lookup
(&
g
->
hash
, 
mes§ge
->id);

233 ià(
id
<0) {

234 
	`skyÃt_”rÜ
(
ùx
, "Clo£ unknowÀcÚÃùiÚ %d", 
mes§ge
->
id
);

235 
	`skyÃt_sock‘_şo£
(
ùx
, 
mes§ge
->
id
);

239 
SKYNET_SOCKET_TYPE_CLOSE
:

240 
SKYNET_SOCKET_TYPE_ERROR
: {

241 
id
 = 
	`hashid_»move
(&
g
->
hash
, 
mes§ge
->id);

242 ià(
id
>=0) {

243 
cÚÃùiÚ
 *
c
 = &
g
->
cÚn
[
id
];

244 
	`d©abufãr_ş—r
(&
c
->
bufãr
,&
g
->
mp
);

245 
	`mem£t
(
c
, 0, (*c));

246 
c
->
id
 = -1;

247 
	`_»pÜt
(
g
, "%d clo£", 
mes§ge
->
id
);

251 
SKYNET_SOCKET_TYPE_ACCEPT
:

253 
	`as£¹
(
g
->
li¡’_id
 =ğ
mes§ge
->
id
);

254 ià(
	`hashid_fuÎ
(&
g
->
hash
)) {

255 
	`skyÃt_sock‘_şo£
(
ùx
, 
mes§ge
->
ud
);

257 
cÚÃùiÚ
 *
c
 = &
g
->
cÚn
[
	`hashid_š£¹
(&g->
hash
, 
mes§ge
->
ud
)];

258 ià(
sz
 >ğ(
c
->
»mÙe_Çme
)) {

259 
sz
 = (
c
->
»mÙe_Çme
) - 1;

261 
c
->
id
 = 
mes§ge
->
ud
;

262 
	`memıy
(
c
->
»mÙe_Çme
, 
mes§ge
+1, 
sz
);

263 
c
->
»mÙe_Çme
[
sz
] = '\0';

264 
	`_»pÜt
(
g
, "%d o³À%d %s:0",
c
->
id
, c->id, c->
»mÙe_Çme
);

265 
	`skyÃt_”rÜ
(
ùx
, "sock‘ o³n: %x", 
c
->
id
);

268 
SKYNET_SOCKET_TYPE_WARNING
:

269 
	`skyÃt_”rÜ
(
ùx
, "fd (%dè£nd bufã¸(%d)K", 
mes§ge
->
id
, mes§ge->
ud
);

272 
	}
}

275 
	$_cb
(
skyÃt_cÚ‹xt
 * 
ùx
, * 
ud
, 
ty³
, 
£ssiÚ
, 
ušt32_t
 
sourû
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

276 
g©e
 *
g
 = 
ud
;

277 
ty³
) {

278 
PTYPE_TEXT
:

279 
	`_ù¾
(
g
 , 
msg
 , ()
sz
);

281 
PTYPE_CLIENT
: {

282 ià(
sz
 <=4 ) {

283 
	`skyÃt_”rÜ
(
ùx
, "Inv®id cl›Á mes§gäom %x",
sourû
);

287 cÚ¡ 
ušt8_t
 * 
idbuf
 = 
msg
 + 
sz
 - 4;

288 
ušt32_t
 
uid
 = 
idbuf
[0] | idbuf[1] << 8 | idbuf[2] << 16 | idbuf[3] << 24;

289 
id
 = 
	`hashid_lookup
(&
g
->
hash
, 
uid
);

290 ià(
id
>=0) {

292 
	`skyÃt_sock‘_£nd
(
ùx
, 
uid
, (*)
msg
, 
sz
-4);

296 
	`skyÃt_”rÜ
(
ùx
, "Inv®id cl›Á id %d from %x",()
uid
,
sourû
);

300 
PTYPE_SOCKET
:

302 
	`di¥©ch_sock‘_mes§ge
(
g
, 
msg
, ()(
sz
-(
skyÃt_sock‘_mes§ge
)));

306 
	}
}

309 
	$¡¬t_li¡’
(
g©e
 *
g
, * 
li¡’_addr
) {

310 
skyÃt_cÚ‹xt
 * 
ùx
 = 
g
->ctx;

311 * 
pÜt¡r
 = 
	`¡rchr
(
li¡’_addr
,':');

312 cÚ¡ * 
ho¡
 = "";

313 
pÜt
;

314 ià(
pÜt¡r
 =ğ
NULL
) {

315 
pÜt
 = 
	`¡¹Ş
(
li¡’_addr
, 
NULL
, 10);

316 ià(
pÜt
 <= 0) {

317 
	`skyÃt_”rÜ
(
ùx
, "Inv®id g©add»s %s",
li¡’_addr
);

321 
pÜt
 = 
	`¡¹Ş
(
pÜt¡r
 + 1, 
NULL
, 10);

322 ià(
pÜt
 <= 0) {

323 
	`skyÃt_”rÜ
(
ùx
, "Inv®id g©add»s %s",
li¡’_addr
);

326 
pÜt¡r
[0] = '\0';

327 
ho¡
 = 
li¡’_addr
;

329 
g
->
li¡’_id
 = 
	`skyÃt_sock‘_li¡’
(
ùx
, 
ho¡
, 
pÜt
, 
BACKLOG
);

330 ià(
g
->
li¡’_id
 < 0) {

333 
	`skyÃt_sock‘_¡¬t
(
ùx
, 
g
->
li¡’_id
);

335 
	}
}

338 
	$g©e_š™
(
g©e
 *
g
 , 
skyÃt_cÚ‹xt
 * 
ùx
, * 
·rm
) {

339 ià(
·rm
 =ğ
NULL
)

341 
max
 = 0;

342 
sz
 = 
	`¡¾’
(
·rm
)+1;

343 
w©chdog
[
sz
];

344 
bšdšg
[
sz
];

345 
ş›Á_g
 = 0;

346 
h—d”
;

347 
n
 = 
	`ssÿnf
(
·rm
, "%ø% % %d %d", &
h—d”
, 
w©chdog
, 
bšdšg
, &
ş›Á_g
, &
max
);

348 ià(
n
<4) {

349 
	`skyÃt_”rÜ
(
ùx
, "Inv®id g©·rm %s",
·rm
);

352 ià(
max
 <=0 ) {

353 
	`skyÃt_”rÜ
(
ùx
, "Need max connection");

356 ià(
h—d”
 != 'S' && header !='L') {

357 
	`skyÃt_”rÜ
(
ùx
, "Invalid data header style");

361 ià(
ş›Á_g
 == 0) {

362 
ş›Á_g
 = 
PTYPE_CLIENT
;

364 ià(
w©chdog
[0] == '!') {

365 
g
->
w©chdog
 = 0;

367 
g
->
w©chdog
 = 
	`skyÃt_qu”yÇme
(
ùx
, watchdog);

368 ià(
g
->
w©chdog
 == 0) {

369 
	`skyÃt_”rÜ
(
ùx
, "Inv®id w©chdog %s",
w©chdog
);

374 
g
->
ùx
 = ctx;

376 
	`hashid_š™
(&
g
->
hash
, 
max
);

377 
g
->
cÚn
 = 
	`skyÃt_m®loc
(
max
 * (
cÚÃùiÚ
));

378 
	`mem£t
(
g
->
cÚn
, 0, 
max
 *(
cÚÃùiÚ
));

379 
g
->
max_cÚÃùiÚ
 = 
max
;

380 
i
;

381 
i
=0;i<
max
;i++) {

382 
g
->
cÚn
[
i
].
id
 = -1;

385 
g
->
ş›Á_g
 = client_tag;

386 
g
->
h—d”_size
 = 
h—d”
=='S' ? 2 : 4;

388 
	`skyÃt_ÿÎback
(
ùx
,
g
,
_cb
);

390  
	`¡¬t_li¡’
(
g
,
bšdšg
);

391 
	}
}

	@service-src/service_harbor.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_h¬bÜ.h
"

3 
	~"skyÃt_sock‘.h
"

4 
	~"skyÃt_hªdË.h
"

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<¡dboŞ.h
>

19 
	~<¡ršg.h
>

20 
	~<as£¹.h
>

21 
	~<¡dšt.h
>

22 
	~<uni¡d.h
>

24 
	#HASH_SIZE
 4096

	)

25 
	#DEFAULT_QUEUE_SIZE
 1024

	)

28 
	#HEADER_COOKIE_LENGTH
 12

	)

34 
	s»mÙe_mes§ge_h—d”
 {

35 
ušt32_t
 
	msourû
;

36 
ušt32_t
 
	mde¡š©iÚ
;

37 
ušt32_t
 
	m£ssiÚ
;

40 
	sh¬bÜ_msg
 {

41 
»mÙe_mes§ge_h—d”
 
	mh—d”
;

42 * 
	mbufãr
;

43 
size_t
 
	msize
;

46 
	sh¬bÜ_msg_queue
 {

47 
	msize
;

48 
	mh—d
;

49 
	m
;

50 
h¬bÜ_msg
 * 
	md©a
;

53 
	skeyv®ue
 {

54 
keyv®ue
 * 
	mÃxt
;

55 
	mkey
[
GLOBALNAME_LENGTH
];

56 
ušt32_t
 
	mhash
;

57 
ušt32_t
 
	mv®ue
;

58 
h¬bÜ_msg_queue
 * 
	mqueue
;

61 
	shashm­
 {

62 
keyv®ue
 *
	mnode
[
HASH_SIZE
];

65 
	#STATUS_WAIT
 0

	)

66 
	#STATUS_HANDSHAKE
 1

	)

67 
	#STATUS_HEADER
 2

	)

68 
	#STATUS_CONTENT
 3

	)

69 
	#STATUS_DOWN
 4

	)

71 
	s¦ave
 {

72 
	mfd
;

73 
h¬bÜ_msg_queue
 *
	mqueue
;

74 
	m¡©us
;

75 
	mËngth
;

76 
	m»ad
;

77 
ušt8_t
 
	msize
[4];

78 * 
	m»cv_bufãr
;

81 
	sh¬bÜ
 {

82 
skyÃt_cÚ‹xt
 *
	mùx
;

83 
	mid
;

84 
ušt32_t
 
	m¦ave
;

85 
hashm­
 * 
	mm­
;

86 
¦ave
 
	ms
[
REMOTE_MAX
];

92 
	$push_queue_msg
(
h¬bÜ_msg_queue
 * 
queue
, 
h¬bÜ_msg
 * 
m
) {

95 ià(((
queue
->

 + 1è% queue->
size
è=ğqueue->
h—d
) {

96 
h¬bÜ_msg
 * 
Ãw_bufãr
 = 
	`skyÃt_m®loc
(
queue
->
size
 * 2 * (harbor_msg));

97 
i
;

98 
i
=0;i<
queue
->
size
-1;i++) {

99 
Ãw_bufãr
[
i
] = 
queue
->
d©a
[(i+queue->
h—d
è% queue->
size
];

101 
	`skyÃt_ä“
(
queue
->
d©a
);

102 
queue
->
d©a
 = 
Ãw_bufãr
;

103 
queue
->
h—d
 = 0;

104 
queue
->

 = queue->
size
 - 1;

105 
queue
->
size
 *= 2;

107 
h¬bÜ_msg
 * 
¦Ù
 = &
queue
->
d©a
[queue->

];

108 *
¦Ù
 = *
m
;

109 
queue
->

 = (queue-> + 1è% queue->
size
;

110 
	}
}

113 
	$push_queue
(
h¬bÜ_msg_queue
 * 
queue
, * 
bufãr
, 
size_t
 
sz
, 
»mÙe_mes§ge_h—d”
 * 
h—d”
) {

114 
h¬bÜ_msg
 
m
;

115 
m
.
h—d”
 = *header;

116 
m
.
bufãr
 = buffer;

117 
m
.
size
 = 
sz
;

118 
	`push_queue_msg
(
queue
, &
m
);

119 
	}
}

121 
h¬bÜ_msg
 *

122 
	$pİ_queue
(
h¬bÜ_msg_queue
 * 
queue
) {

123 ià(
queue
->
h—d
 =ğqueue->

) {

124  
NULL
;

126 
h¬bÜ_msg
 * 
¦Ù
 = &
queue
->
d©a
[queue->
h—d
];

127 
queue
->
h—d
 = (queue->h—d + 1è% queue->
size
;

128  
¦Ù
;

129 
	}
}

131 
h¬bÜ_msg_queue
 *

132 
	$Ãw_queue
() {

133 
h¬bÜ_msg_queue
 * 
queue
 = 
	`skyÃt_m®loc
((*queue));

134 
queue
->
size
 = 
DEFAULT_QUEUE_SIZE
;

135 
queue
->
h—d
 = 0;

136 
queue
->

 = 0;

137 
queue
->
d©a
 = 
	`skyÃt_m®loc
(
DEFAULT_QUEUE_SIZE
 * (
h¬bÜ_msg
));

139  
queue
;

140 
	}
}

143 
	$»Ëa£_queue
(
h¬bÜ_msg_queue
 *
queue
) {

144 ià(
queue
 =ğ
NULL
)

146 
h¬bÜ_msg
 * 
m
;

147 (
m
=
	`pİ_queue
(
queue
)è!ğ
NULL
) {

148 
	`skyÃt_ä“
(
m
->
bufãr
);

150 
	`skyÃt_ä“
(
queue
->
d©a
);

151 
	`skyÃt_ä“
(
queue
);

152 
	}
}

154 
keyv®ue
 *

155 
	$hash_£¬ch
(
hashm­
 * 
hash
, cÚ¡ 
Çme
[
GLOBALNAME_LENGTH
]) {

156 
ušt32_t
 *
±r
 = (ušt32_t*è
Çme
;

157 
ušt32_t
 
h
 = 
±r
[0] ^…tr[1] ^…tr[2] ^…tr[3];

158 
keyv®ue
 * 
node
 = 
hash
->node[
h
 % 
HASH_SIZE
];

159 
node
) {

160 ià(
node
->
hash
 =ğ
h
 && 
	`¡ºcmp
Òode->
key
, 
Çme
, 
GLOBALNAME_LENGTH
) == 0) {

161  
node
;

163 
node
 =‚ode->
Ãxt
;

165  
NULL
;

166 
	}
}

190 
keyv®ue
 *

191 
	$hash_š£¹
(
hashm­
 * 
hash
, cÚ¡ 
Çme
[
GLOBALNAME_LENGTH
]) {

192 
ušt32_t
 *
±r
 = (ušt32_ˆ*)
Çme
;

193 
ušt32_t
 
h
 = 
±r
[0] ^…tr[1] ^…tr[2] ^…tr[3];

194 
keyv®ue
 ** 
pkv
 = &
hash
->
node
[
h
 % 
HASH_SIZE
];

195 
keyv®ue
 * 
node
 = 
	`skyÃt_m®loc
((*node));

196 
	`memıy
(
node
->
key
, 
Çme
, 
GLOBALNAME_LENGTH
);

197 
node
->
Ãxt
 = *
pkv
;

198 
node
->
queue
 = 
NULL
;

199 
node
->
hash
 = 
h
;

200 
node
->
v®ue
 = 0;

201 *
pkv
 = 
node
;

203  
node
;

204 
	}
}

206 
hashm­
 *

207 
	$hash_Ãw
() {

208 
hashm­
 * 
h
 = 
	`skyÃt_m®loc
((hashmap));

209 
	`mem£t
(
h
,0,(*h));

210  
h
;

211 
	}
}

214 
	$hash_d–‘e
(
hashm­
 *
hash
) {

215 
i
;

216 
i
=0;i<
HASH_SIZE
;i++) {

217 
keyv®ue
 * 
node
 = 
hash
->node[
i
];

218 
node
) {

219 
keyv®ue
 * 
Ãxt
 = 
node
->next;

220 
	`»Ëa£_queue
(
node
->
queue
);

221 
	`skyÃt_ä“
(
node
);

222 
node
 = 
Ãxt
;

225 
	`skyÃt_ä“
(
hash
);

226 
	}
}

231 
	$şo£_h¬bÜ
(
h¬bÜ
 *
h
, 
id
) {

232 
¦ave
 *
s
 = &
h
->s[
id
];

233 
s
->
¡©us
 = 
STATUS_DOWN
;

234 ià(
s
->
fd
) {

235 
	`skyÃt_sock‘_şo£
(
h
->
ùx
, 
s
->
fd
);

237 ià(
s
->
queue
) {

238 
	`»Ëa£_queue
(
s
->
queue
);

239 
s
->
queue
 = 
NULL
;

241 
	}
}

244 
	$»pÜt_h¬bÜ_down
(
h¬bÜ
 *
h
, 
id
) {

245 
down
[64];

246 
n
 = 
	`¥rštf
(
down
, "D %d",
id
);

248 
	`skyÃt_£nd
(
h
->
ùx
, 0, h->
¦ave
, 
PTYPE_TEXT
, 0, 
down
, 
n
);

249 
	}
}

251 
h¬bÜ
 *

252 
	$h¬bÜ_ü—‹
() {

253 
h¬bÜ
 * 
h
 = 
	`skyÃt_m®loc
((*h));

254 
	`mem£t
(
h
,0,(*h));

255 
h
->
m­
 = 
	`hash_Ãw
();

256  
h
;

257 
	}
}

260 
	$h¬bÜ_»Ëa£
(
h¬bÜ
 *
h
) {

261 
i
;

262 
i
=1;i<
REMOTE_MAX
;i++) {

263 
¦ave
 *
s
 = &
h
->s[
i
];

264 ià(
s
->
fd
 && s->
¡©us
 !ğ
STATUS_DOWN
) {

265 
	`şo£_h¬bÜ
(
h
,
i
);

270 
	`hash_d–‘e
(
h
->
m­
);

271 
	`skyÃt_ä“
(
h
);

272 
	}
}

274 
šlše
 

275 
	$to_big’dŸn
(
ušt8_t
 *
bufãr
, 
ušt32_t
 
n
) {

276 
bufãr
[0] = (
n
 >> 24) & 0xff;

277 
bufãr
[1] = (
n
 >> 16) & 0xff;

278 
bufãr
[2] = (
n
 >> 8) & 0xff;

279 
bufãr
[3] = 
n
 & 0xff;

280 
	}
}

282 
šlše
 

283 
	$h—d”_to_mes§ge
(cÚ¡ 
»mÙe_mes§ge_h—d”
 * 
h—d”
, 
ušt8_t
 * 
mes§ge
) {

284 
	`to_big’dŸn
(
mes§ge
 , 
h—d”
->
sourû
);

285 
	`to_big’dŸn
(
mes§ge
+4 , 
h—d”
->
de¡š©iÚ
);

286 
	`to_big’dŸn
(
mes§ge
+8 , 
h—d”
->
£ssiÚ
);

287 
	}
}

289 
šlše
 
ušt32_t


290 
	$äom_big’dŸn
(
ušt32_t
 
n
) {

292 
ušt32_t
 
big
;

293 
ušt8_t
 
by‹s
[4];

294 } 
u
;

295 
u
.
big
 = 
n
;

296  
u
.
by‹s
[0] << 24 | u.bytes[1] << 16 | u.bytes[2] << 8 | u.bytes[3];

297 
	}
}

299 
šlše
 

300 
	$mes§ge_to_h—d”
(cÚ¡ 
ušt32_t
 *
mes§ge
, 
»mÙe_mes§ge_h—d”
 *
h—d”
) {

301 
h—d”
->
sourû
 = 
	`äom_big’dŸn
(
mes§ge
[0]);

302 
h—d”
->
de¡š©iÚ
 = 
	`äom_big’dŸn
(
mes§ge
[1]);

303 
h—d”
->
£ssiÚ
 = 
	`äom_big’dŸn
(
mes§ge
[2]);

304 
	}
}

309 
	$fÜw¬d_loÿl_mess§ge
(
h¬bÜ
 *
h
, *
msg
, 
sz
) {

310 cÚ¡ * 
cook›
 = 
msg
;

311 
cook›
 +ğ
sz
 - 
HEADER_COOKIE_LENGTH
;

312 
»mÙe_mes§ge_h—d”
 
h—d”
;

313 
	`mes§ge_to_h—d”
((cÚ¡ 
ušt32_t
 *)
cook›
, &
h—d”
);

315 
ušt32_t
 
de¡š©iÚ
 = 
h—d”
.destination;

316 
ty³
 = 
de¡š©iÚ
 >> 
HANDLE_REMOTE_SHIFT
;

317 
de¡š©iÚ
 = (de¡š©iÚ & 
HANDLE_MASK
è| ((
ušt32_t
)
h
->
id
 << 
HANDLE_REMOTE_SHIFT
);

319 ià(
	`skyÃt_£nd
(
h
->
ùx
, 
h—d”
.
sourû
, 
de¡š©iÚ
, 
ty³
 | 
PTYPE_TAG_DONTCOPY
 , ()h—d”.
£ssiÚ
, (*)
msg
, 
sz
-
HEADER_COOKIE_LENGTH
) < 0) {

320 ià(
ty³
 !ğ
PTYPE_ERROR
) {

322 
	`skyÃt_£nd
(
h
->
ùx
, 
de¡š©iÚ
, 
h—d”
.
sourû
 , 
PTYPE_ERROR
, ()h—d”.
£ssiÚ
, 
NULL
, 0);

324 
	`skyÃt_”rÜ
(
h
->
ùx
, "UnknowÀde¡š©iÚ :%x from :%xy³(%d)", 
de¡š©iÚ
, 
h—d”
.
sourû
, 
ty³
);

326 
	}
}

329 
	$£nd_»mÙe
(
skyÃt_cÚ‹xt
 * 
ùx
, 
fd
, cÚ¡ * 
bufãr
, 
size_t
 
sz
, 
»mÙe_mes§ge_h—d”
 * 
cook›
) {

330 
size_t
 
sz_h—d”
 = 
sz
+(*
cook›
);

331 ià(
sz_h—d”
 > 
UINT32_MAX
) {

332 
	`skyÃt_”rÜ
(
ùx
, "»mÙmes§gäom :%08xØ:%08x i toØÏrge.", 
cook›
->
sourû
, cook›->
de¡š©iÚ
);

335 
ušt8_t
 * 
£ndbuf
 = 
	`skyÃt_m®loc
(
sz_h—d”
+4);

336 
	`to_big’dŸn
(
£ndbuf
, (
ušt32_t
)
sz_h—d”
);

337 
	`memıy
(
£ndbuf
+4, 
bufãr
, 
sz
);

338 
	`h—d”_to_mes§ge
(
cook›
, 
£ndbuf
+4+
sz
);

341 
	`skyÃt_sock‘_£nd
(
ùx
, 
fd
, 
£ndbuf
, 
sz_h—d”
+4);

342 
	}
}

345 
	$di¥©ch_Çme_queue
(
h¬bÜ
 *
h
, 
keyv®ue
 * 
node
) {

346 
h¬bÜ_msg_queue
 * 
queue
 = 
node
->queue;

347 
ušt32_t
 
hªdË
 = 
node
->
v®ue
;

348 
h¬bÜ_id
 = 
hªdË
 >> 
HANDLE_REMOTE_SHIFT
;

349 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
h
->
ùx
;

350 
¦ave
 *
s
 = &
h
->s[
h¬bÜ_id
];

351 
fd
 = 
s
->fd;

352 ià(
fd
 == 0) {

353 ià(
s
->
¡©us
 =ğ
STATUS_DOWN
) {

354 
tmp
 [
GLOBALNAME_LENGTH
+1];

355 
	`memıy
(
tmp
, 
node
->
key
, 
GLOBALNAME_LENGTH
);

356 
tmp
[
GLOBALNAME_LENGTH
] = '\0';

357 
	`skyÃt_”rÜ
(
cÚ‹xt
, "Drİ mes§gtØ% (š h¬bÜ %d)",
tmp
,
h¬bÜ_id
);

359 ià(
s
->
queue
 =ğ
NULL
) {

360 
s
->
queue
 = 
node
->queue;

361 
node
->
queue
 = 
NULL
;

363 
h¬bÜ_msg
 * 
m
;

364 (
m
 = 
	`pİ_queue
(
queue
))!=
NULL
) {

365 
	`push_queue_msg
(
s
->
queue
, 
m
);

368 ià(
h¬bÜ_id
 =ğ(
h
->
¦ave
 >> 
HANDLE_REMOTE_SHIFT
)) {

370 
h¬bÜ_msg
 * 
m
;

371 (
m
 = 
	`pİ_queue
(
s
->
queue
)è!ğ
NULL
) {

372 
ty³
 = 
m
->
h—d”
.
de¡š©iÚ
 >> 
HANDLE_REMOTE_SHIFT
;

373 
	`skyÃt_£nd
(
cÚ‹xt
, 
m
->
h—d”
.
sourû
, 
hªdË
 , 
ty³
 | 
PTYPE_TAG_DONTCOPY
, m->h—d”.
£ssiÚ
, m->
bufãr
, m->
size
);

375 
	`»Ëa£_queue
(
s
->
queue
);

376 
s
->
queue
 = 
NULL
;

381 
h¬bÜ_msg
 * 
m
;

382 (
m
 = 
	`pİ_queue
(
queue
)è!ğ
NULL
) {

383 
m
->
h—d”
.
de¡š©iÚ
 |ğ(
hªdË
 & 
HANDLE_MASK
);

384 
	`£nd_»mÙe
(
cÚ‹xt
, 
fd
, 
m
->
bufãr
, m->
size
, &m->
h—d”
);

385 
	`skyÃt_ä“
(
m
->
bufãr
);

387 
	}
}

390 
	$di¥©ch_queue
(
h¬bÜ
 *
h
, 
id
) {

391 
¦ave
 *
s
 = &
h
->s[
id
];

392 
fd
 = 
s
->fd;

393 
	`as£¹
(
fd
 != 0);

395 
h¬bÜ_msg_queue
 *
queue
 = 
s
->queue;

396 ià(
queue
 =ğ
NULL
)

399 
h¬bÜ_msg
 * 
m
;

400 (
m
 = 
	`pİ_queue
(
queue
)è!ğ
NULL
) {

401 
	`£nd_»mÙe
(
h
->
ùx
, 
fd
, 
m
->
bufãr
, m->
size
, &m->
h—d”
);

402 
	`skyÃt_ä“
(
m
->
bufãr
);

404 
	`»Ëa£_queue
(
queue
);

405 
s
->
queue
 = 
NULL
;

406 
	}
}

409 
	$push_sock‘_d©a
(
h¬bÜ
 *
h
, cÚ¡ 
skyÃt_sock‘_mes§ge
 * 
mes§ge
) {

410 
	`as£¹
(
mes§ge
->
ty³
 =ğ
SKYNET_SOCKET_TYPE_DATA
);

411 
fd
 = 
mes§ge
->
id
;

412 
i
;

413 
id
 = 0;

414 
¦ave
 * 
s
 = 
NULL
;

415 
i
=1;i<
REMOTE_MAX
;i++) {

416 ià(
h
->
s
[
i
].
fd
 == fd) {

417 
s
 = &
h
->s[
i
];

418 
id
 = 
i
;

422 ià(
s
 =ğ
NULL
) {

423 
	`skyÃt_”rÜ
(
h
->
ùx
, "Inv®id sock‘ fd (%dèd©a", 
fd
);

426 
ušt8_t
 * 
bufãr
 = (ušt8_ˆ*)
mes§ge
->buffer;

427 
size
 = 
mes§ge
->
ud
;

430 
s
->
¡©us
) {

431 
STATUS_HANDSHAKE
: {

433 
ušt8_t
 
»mÙe_id
 = 
bufãr
[0];

434 ià(
»mÙe_id
 !ğ
id
) {

435 
	`skyÃt_”rÜ
(
h
->
ùx
, "Inv®id shakehªd id (%dèäom fd = %d , h¬bÜ = %d", 
id
, 
fd
, 
»mÙe_id
);

436 
	`şo£_h¬bÜ
(
h
,
id
);

439 ++
bufãr
;

440 --
size
;

441 
s
->
¡©us
 = 
STATUS_HEADER
;

443 
	`di¥©ch_queue
(
h
, 
id
);

445 ià(
size
 == 0) {

450 
STATUS_HEADER
: {

452 
Ãed
 = 4 - 
s
->
»ad
;

453 ià(
size
 < 
Ãed
) {

454 
	`memıy
(
s
->
size
 + s->
»ad
, 
bufãr
, size);

455 
s
->
»ad
 +ğ
size
;

458 
	`memıy
(
s
->
size
 + s->
»ad
, 
bufãr
, 
Ãed
);

459 
bufãr
 +ğ
Ãed
;

460 
size
 -ğ
Ãed
;

462 ià(
s
->
size
[0] != 0) {

463 
	`skyÃt_”rÜ
(
h
->
ùx
, "Mes§gi toØlÚg from h¬bÜ %d", 
id
);

464 
	`şo£_h¬bÜ
(
h
,
id
);

467 
s
->
Ëngth
 = s->
size
[1] << 16 | s->size[2] << 8 | s->size[3];

468 
s
->
»ad
 = 0;

469 
s
->
»cv_bufãr
 = 
	`skyÃt_m®loc
(s->
Ëngth
);

470 
s
->
¡©us
 = 
STATUS_CONTENT
;

471 ià(
size
 == 0) {

477 
STATUS_CONTENT
: {

478 
Ãed
 = 
s
->
Ëngth
 - s->
»ad
;

479 ià(
size
 < 
Ãed
) {

480 
	`memıy
(
s
->
»cv_bufãr
 + s->
»ad
, 
bufãr
, 
size
);

481 
s
->
»ad
 +ğ
size
;

484 
	`memıy
(
s
->
»cv_bufãr
 + s->
»ad
, 
bufãr
, 
Ãed
);

485 
	`fÜw¬d_loÿl_mess§ge
(
h
, 
s
->
»cv_bufãr
, s->
Ëngth
);

486 
s
->
Ëngth
 = 0;

487 
s
->
»ad
 = 0;

488 
s
->
»cv_bufãr
 = 
NULL
;

489 
size
 -ğ
Ãed
;

490 
bufãr
 +ğ
Ãed
;

491 
s
->
¡©us
 = 
STATUS_HEADER
;

492 ià(
size
 == 0)

500 
	}
}

503 
	$upd©e_Çme
(
h¬bÜ
 *
h
, cÚ¡ 
Çme
[
GLOBALNAME_LENGTH
], 
ušt32_t
 
hªdË
) {

504 
keyv®ue
 * 
node
 = 
	`hash_£¬ch
(
h
->
m­
, 
Çme
);

505 ià(
node
 =ğ
NULL
) {

506 
node
 = 
	`hash_š£¹
(
h
->
m­
, 
Çme
);

508 
node
->
v®ue
 = 
hªdË
;

509 ià(
node
->
queue
) {

510 
	`di¥©ch_Çme_queue
(
h
, 
node
);

511 
	`»Ëa£_queue
(
node
->
queue
);

512 
node
->
queue
 = 
NULL
;

514 
	}
}

517 
	$»mÙe_£nd_hªdË
(
h¬bÜ
 *
h
, 
ušt32_t
 
sourû
, ušt32_ˆ
de¡š©iÚ
, 
ty³
, 
£ssiÚ
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

518 
h¬bÜ_id
 = 
de¡š©iÚ
 >> 
HANDLE_REMOTE_SHIFT
;

519 
skyÃt_cÚ‹xt
 * 
cÚ‹xt
 = 
h
->
ùx
;

520 ià(
h¬bÜ_id
 =ğ
h
->
id
) {

522 
	`skyÃt_£nd
(
cÚ‹xt
, 
sourû
, 
de¡š©iÚ
 , 
ty³
 | 
PTYPE_TAG_DONTCOPY
, 
£ssiÚ
, (*)
msg
, 
sz
);

526 
¦ave
 * 
s
 = &
h
->s[
h¬bÜ_id
];

527 ià(
s
->
fd
 =ğ0 || s->
¡©us
 =ğ
STATUS_HANDSHAKE
) {

528 ià(
s
->
¡©us
 =ğ
STATUS_DOWN
) {

531 
	`skyÃt_£nd
(
cÚ‹xt
, 
de¡š©iÚ
, 
sourû
, 
PTYPE_ERROR
, 0 , 
NULL
, 0);

532 
	`skyÃt_”rÜ
(
cÚ‹xt
, "Drİ mes§gtØh¬bÜ %d from %xØ%x (£ssiÚ = %d, msgsz = %d)",
h¬bÜ_id
, 
sourû
, 
de¡š©iÚ
,
£ssiÚ
,()
sz
);

534 ià(
s
->
queue
 =ğ
NULL
) {

535 
s
->
queue
 = 
	`Ãw_queue
();

537 
»mÙe_mes§ge_h—d”
 
h—d”
;

538 
h—d”
.
sourû
 = source;

539 
h—d”
.
de¡š©iÚ
 = (
ty³
 << 
HANDLE_REMOTE_SHIFT
è| (de¡š©iÚ & 
HANDLE_MASK
);

540 
h—d”
.
£ssiÚ
 = (
ušt32_t
)session;

541 
	`push_queue
(
s
->
queue
, (*)
msg
, 
sz
, &
h—d”
);

545 
»mÙe_mes§ge_h—d”
 
cook›
;

546 
cook›
.
sourû
 = source;

547 
cook›
.
de¡š©iÚ
 = (de¡š©iÚ & 
HANDLE_MASK
è| ((
ušt32_t
)
ty³
 << 
HANDLE_REMOTE_SHIFT
);

548 
cook›
.
£ssiÚ
 = (
ušt32_t
)session;

549 
	`£nd_»mÙe
(
cÚ‹xt
, 
s
->
fd
, 
msg
,
sz
,&
cook›
);

553 
	}
}

556 
	$»mÙe_£nd_Çme
(
h¬bÜ
 *
h
, 
ušt32_t
 
sourû
, cÚ¡ 
Çme
[
GLOBALNAME_LENGTH
], 
ty³
, 
£ssiÚ
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

557 
keyv®ue
 * 
node
 = 
	`hash_£¬ch
(
h
->
m­
, 
Çme
);

558 ià(
node
 =ğ
NULL
) {

559 
node
 = 
	`hash_š£¹
(
h
->
m­
, 
Çme
);

561 ià(
node
->
v®ue
 == 0) {

562 ià(
node
->
queue
 =ğ
NULL
) {

563 
node
->
queue
 = 
	`Ãw_queue
();

565 
»mÙe_mes§ge_h—d”
 
h—d”
;

566 
h—d”
.
sourû
 = source;

567 
h—d”
.
de¡š©iÚ
 = 
ty³
 << 
HANDLE_REMOTE_SHIFT
;

568 
h—d”
.
£ssiÚ
 = (
ušt32_t
)session;

569 
	`push_queue
(
node
->
queue
, (*)
msg
, 
sz
, &
h—d”
);

570 
qu”y
[2+
GLOBALNAME_LENGTH
+1] = "Q ";

571 
qu”y
[2+
GLOBALNAME_LENGTH
] = 0;

572 
	`memıy
(
qu”y
+2, 
Çme
, 
GLOBALNAME_LENGTH
);

573 
	`skyÃt_£nd
(
h
->
ùx
, 0, h->
¦ave
, 
PTYPE_TEXT
, 0, 
qu”y
, 
	`¡¾’
(query));

576  
	`»mÙe_£nd_hªdË
(
h
, 
sourû
, 
node
->
v®ue
, 
ty³
, 
£ssiÚ
, 
msg
, 
sz
);

578 
	}
}

581 
	$hªdshake
(
h¬bÜ
 *
h
, 
id
) {

582 
¦ave
 *
s
 = &
h
->s[
id
];

583 
ušt8_t
 * 
hªdshake
 = 
	`skyÃt_m®loc
(1);

584 
hªdshake
[0] = (
ušt8_t
)
h
->
id
;

585 
	`skyÃt_sock‘_£nd
(
h
->
ùx
, 
s
->
fd
, 
hªdshake
, 1);

586 
	}
}

589 
	$h¬bÜ_commªd
(
h¬bÜ
 * 
h
, cÚ¡ * 
msg
, 
size_t
 
sz
, 
£ssiÚ
, 
ušt32_t
 
sourû
) {

590 cÚ¡ * 
Çme
 = 
msg
 + 2;

591 
s
 = ()
sz
;

592 
s
 -= 2;

593 
msg
[0]) {

595 ià(
s
 <=0 || s>ğ
GLOBALNAME_LENGTH
) {

596 
	`skyÃt_”rÜ
(
h
->
ùx
, "Inv®id glob®‚am%s", 
Çme
);

599 
»mÙe_Çme
 
º
;

600 
	`mem£t
(&
º
, 0, (rn));

601 
	`memıy
(
º
.
Çme
,‚ame, 
s
);

602 
º
.
hªdË
 = 
sourû
;

603 
	`upd©e_Çme
(
h
, 
º
.
Çme
,„n.
hªdË
);

608 
bufãr
[
s
+1];

609 
	`memıy
(
bufãr
, 
Çme
, 
s
);

610 
bufãr
[
s
] = 0;

611 
fd
=0, 
id
=0;

612 
	`ssÿnf
(
bufãr
, "%d %d",&
fd
,&
id
);

613 ià(
fd
 =ğ0 || 
id
 <ğ0 || id>=
REMOTE_MAX
) {

614 
	`skyÃt_”rÜ
(
h
->
ùx
, "Inv®id commªd %ø%s", 
msg
[0], 
bufãr
);

617 
¦ave
 * sÏvğ&
h
->
s
[
id
];

618 ià(
¦ave
->
fd
 != 0) {

619 
	`skyÃt_”rÜ
(
h
->
ùx
, "H¬bÜ %d‡Ì—yƒxi¡", 
id
);

622 
¦ave
->
fd
 = fd;

624 
	`skyÃt_sock‘_¡¬t
(
h
->
ùx
, 
fd
);

625 
	`hªdshake
(
h
, 
id
);

626 ià(
msg
[0] == 'S') {

627 
¦ave
->
¡©us
 = 
STATUS_HANDSHAKE
;

629 
¦ave
->
¡©us
 = 
STATUS_HEADER
;

630 
	`di¥©ch_queue
(
h
,
id
);

635 
	`skyÃt_”rÜ
(
h
->
ùx
, "UnknowÀcommªd %s", 
msg
);

638 
	}
}

641 
	$h¬bÜ_id
(
h¬bÜ
 *
h
, 
fd
) {

642 
i
;

643 
i
=1;i<
REMOTE_MAX
;i++) {

644 
¦ave
 *
s
 = &
h
->s[
i
];

645 ià(
s
->
fd
 == fd) {

646  
i
;

650 
	}
}

653 
	$mašloİ
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, * 
ud
, 
ty³
, 
£ssiÚ
, 
ušt32_t
 
sourû
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

654 
h¬bÜ
 * 
h
 = 
ud
;

655 
ty³
) {

656 
PTYPE_SOCKET
: {

657 cÚ¡ 
skyÃt_sock‘_mes§ge
 * 
mes§ge
 = 
msg
;

658 
mes§ge
->
ty³
) {

659 
SKYNET_SOCKET_TYPE_DATA
:

660 
	`push_sock‘_d©a
(
h
, 
mes§ge
);

661 
	`skyÃt_ä“
(
mes§ge
->
bufãr
);

663 
SKYNET_SOCKET_TYPE_ERROR
:

664 
SKYNET_SOCKET_TYPE_CLOSE
: {

665 
id
 = 
	`h¬bÜ_id
(
h
, 
mes§ge
->id);

666 ià(
id
) {

667 
	`»pÜt_h¬bÜ_down
(
h
,
id
);

669 
	`skyÃt_”rÜ
(
cÚ‹xt
, "UnkowÀfd (%dèşo£d", 
mes§ge
->
id
);

673 
SKYNET_SOCKET_TYPE_CONNECT
:

676 
SKYNET_SOCKET_TYPE_WARNING
: {

677 
id
 = 
	`h¬bÜ_id
(
h
, 
mes§ge
->id);

678 ià(
id
) {

679 
	`skyÃt_”rÜ
(
cÚ‹xt
, "mes§ghavn'ˆ£ndØH¬bÜ (%dè»ach %d K", 
id
, 
mes§ge
->
ud
);

684 
	`skyÃt_”rÜ
(
cÚ‹xt
, "»cv inv®id sock‘ mes§gty³ %d", 
ty³
);

689 
PTYPE_HARBOR
: {

690 
	`h¬bÜ_commªd
(
h
, 
msg
,
sz
,
£ssiÚ
,
sourû
);

695 cÚ¡ 
»mÙe_mes§ge
 *
rmsg
 = 
msg
;

696 ià(
rmsg
->
de¡š©iÚ
.
hªdË
 == 0) {

697 ià(
	`»mÙe_£nd_Çme
(
h
, 
sourû
 , 
rmsg
->
de¡š©iÚ
.
Çme
, 
ty³
, 
£ssiÚ
,„msg->
mes§ge
,„msg->
sz
)) {

701 ià(
	`»mÙe_£nd_hªdË
(
h
, 
sourû
 , 
rmsg
->
de¡š©iÚ
.
hªdË
, 
ty³
, 
£ssiÚ
,„msg->
mes§ge
,„msg->
sz
)) {

705 
	`skyÃt_ä“
((*)
rmsg
->
mes§ge
);

709 
	}
}

712 
	$h¬bÜ_š™
(
h¬bÜ
 *
h
, 
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
¬gs
) {

713 
h
->
ùx
 = ctx;

714 
h¬bÜ_id
 = 0;

715 
ušt32_t
 
¦ave
 = 0;

716 
	`ssÿnf
(
¬gs
,"%d %u", &
h¬bÜ_id
, &
¦ave
);

717 ià(
¦ave
 == 0) {

720 
h
->
id
 = 
h¬bÜ_id
;

721 
h
->
¦ave
 = slave;

722 
	`skyÃt_ÿÎback
(
ùx
, 
h
, 
mašloİ
);

723 
	`skyÃt_h¬bÜ_¡¬t
(
ùx
);

726 
	}
}

	@service-src/service_logger.c

1 
	~"skyÃt.h
"

3 
	~<¡dio.h
>

4 
	~<¡dlib.h
>

5 
	~<¡dšt.h
>

6 
	~<¡ršg.h
>

7 
	~<time.h
>

10 
	#DAY_STR_LEN
 15

	)

11 
	#SECONDS_ONE_DAY
 86400

	)

13 
	slogg”
 {

14 
FILE
 * 
	mhªdË
;

15 * 
	mf’ame
;

16 * 
	mÜigFn
;

17 
	mşo£
;

18 
	mmday
;

19 
time_t
 
	mtoday0hour
;

22 
logg”
 *

23 
	$logg”_ü—‹
() {

24 
logg”
 * 
š¡
 = 
	`skyÃt_m®loc
((*inst));

25 
š¡
->
hªdË
 = 
NULL
;

26 
š¡
->
şo£
 = 0;

27 
š¡
->
f’ame
 = 
NULL
;

28 
š¡
->
ÜigFn
 = 
NULL
;

29 
š¡
->
mday
 = 0;

30 
š¡
->
today0hour
 = 0;

32  
š¡
;

33 
	}
}

36 
	$logg”_»Ëa£
(
logg”
 * 
š¡
) {

37 ià(
š¡
->
şo£
) {

38 
	`fşo£
(
š¡
->
hªdË
);

40 
	`skyÃt_ä“
(
š¡
->
f’ame
);

41 
	`skyÃt_ä“
(
š¡
->
ÜigFn
);

42 
	`skyÃt_ä“
(
š¡
);

43 
	}
}

46 
	$logg”_cb
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, *
ud
, 
ty³
, 
£ssiÚ
, 
ušt32_t
 
sourû
, cÚ¡ * 
msg
, 
size_t
 
sz
) {

47 
logg”
 * 
š¡
 = 
ud
;

48 
time_t
 
£cÚds
 = 
	`time
(
NULL
);

49 
tm
 
tim’ow
;

50 
	`loÿÉime_r
(&
£cÚds
,&
tim’ow
);

51 
dt
 = 
	`difáime
(
£cÚds
,
š¡
->
today0hour
);

52 
FILE
 * 
nhªdË
;

53 
ty³
) {

54 
PTYPE_SYSTEM
:

55 ià(
š¡
->
f’ame
) {

56 
š¡
->
hªdË
 = 
	`äeİ’
(š¡->
f’ame
, "a", inst->handle);

59 
PTYPE_TEXT
:

60 ià(
dt
 > 
SECONDS_ONE_DAY
 ){

61 
â
[256] = {0};

62 
	`¥rštf
(
â
,"%s_%d-%02d-%02d.log",
š¡
->
ÜigFn
,(1900+
tim’ow
.
tm_y—r
),Ñim’ow.
tm_mÚ
+1),tim’ow.
tm_mday
);

63 
nhªdË
 = 
	`fİ’
(
â
,"a");

64 ià(
nhªdË
 !ğ
NULL
) {

65 
š¡
->
today0hour
 +ğ
SECONDS_ONE_DAY
;

66 
	`fşo£
(
š¡
->
hªdË
);

67 
š¡
->
hªdË
 = 
NULL
;

68 
š¡
->
hªdË
 = 
nhªdË
;

69 
	`¡rıy
(
š¡
->
f’ame
,
â
);

72 ià(
š¡
->
hªdË
 !ğ
NULL
) {

73 
	`årštf
(
š¡
->
hªdË
, "%02d:%02d:%02d",
tim’ow
.
tm_hour
,tim’ow.
tm_mš
,tim’ow.
tm_£c
);

74 
	`årštf
(
š¡
->
hªdË
, " [%x] ",
sourû
);

75 
	`fwr™e
(
msg
, 
sz
 , 1, 
š¡
->
hªdË
);

76 
	`årštf
(
š¡
->
hªdË
, "\n");

77 
	`fæush
(
š¡
->
hªdË
);

82 
	}
}

85 
	$logg”_š™
(
logg”
 * 
š¡
, 
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
·rm
) {

86 ià(
·rm
) {

87 
š¡
->
f’ame
 = 
	`skyÃt_m®loc
(
	`¡¾’
(
·rm
)+1+
DAY_STR_LEN
);

88 
š¡
->
ÜigFn
 = 
	`skyÃt_m®loc
(
	`¡¾’
(
·rm
)+1);

89 
	`¡rıy
(
š¡
->
ÜigFn
,
·rm
);

91 
time_t
 
£cÚds
;

92 
£cÚds
 = 
	`time
((
time_t
*)
NULL
);

93 
tm
 
tim’ow
;

94 
	`loÿÉime_r
(&
£cÚds
,&
tim’ow
);

95 
	`¥rštf
(
š¡
->
f’ame
,"%s_%d-%02d-%02d.log",
·rm
,(1900+
tim’ow
.
tm_y—r
),Ñim’ow.
tm_mÚ
+1),tim’ow.
tm_mday
);

96 
tim’ow
.
tm_£c
 = 0;

97 
tim’ow
.
tm_hour
 = 0;

98 
tim’ow
.
tm_mš
 = 0;

99 
š¡
->
today0hour
 = 
	`mktime
(&
tim’ow
);

100 
š¡
->
şo£
 = 1;

102 
š¡
->
hªdË
 = 
	`fİ’
(š¡->
f’ame
,"a");

103 ià(
š¡
->
hªdË
 =ğ
NULL
) {

108 
š¡
->
hªdË
 = 
¡dout
;

110 ià(
š¡
->
hªdË
) {

111 
	`skyÃt_ÿÎback
(
ùx
, 
š¡
, 
logg”_cb
);

112 
	`skyÃt_commªd
(
ùx
, "REG", ".logger");

116 
	}
}

	@service-src/service_logger_test.c

1 
	~<¡dio.h
>

3 
	~"£rviû_logg”.c
"

5 
	$maš
(){

7 
	}
}

	@service-src/service_snlua.c

1 
	~"skyÃt.h
"

3 
	~<lua.h
>

4 
	~<lu®ib.h
>

5 
	~<Ïuxlib.h
>

7 
	~<as£¹.h
>

8 
	~<¡ršg.h
>

9 
	~<¡dlib.h
>

10 
	~<¡dio.h
>

12 
	#MEMORY_WARNING_REPORT
 (1024 * 1024 * 32)

	)

14 
	s¢lua
 {

15 
lua_S‹
 * 
	mL
;

16 
skyÃt_cÚ‹xt
 * 
	mùx
;

17 
size_t
 
	mmem
;

18 
size_t
 
	mmem_»pÜt
;

19 
size_t
 
	mmem_lim™
;

23 #ifdeà
LUA_CACHELIB


25 
	#codeÿche
 
luaİ’_ÿche


	)

30 
	$ş—rdummy
(
lua_S‹
 *
L
) {

32 
	}
}

35 
	$codeÿche
(
lua_S‹
 *
L
) {

36 
luaL_Reg
 
l
[] = {

37 { "ş—r", 
ş—rdummy
 },

38 { "mode", 
ş—rdummy
 },

39 { 
NULL
, NULL },

41 
	`luaL_Ãwlib
(
L
,
l
);

42 
	`lua_g‘glob®
(
L
, "loadfile");

43 
	`lua_£tf›ld
(
L
, -2, "loadfile");

45 
	}
}

50 
	$Œaûback
 (
lua_S‹
 *
L
) {

51 cÚ¡ *
msg
 = 
	`lua_to¡ršg
(
L
, 1);

52 ià(
msg
)

53 
	`luaL_Œaûback
(
L
, L, 
msg
, 1);

55 
	`lua_pushl™”®
(
L
, "(noƒrror message)");

58 
	}
}

61 
	$»pÜt_Ïunch”_”rÜ
(
skyÃt_cÚ‹xt
 *
ùx
) {

63 
	`skyÃt_£ndÇme
(
ùx
, 0, ".Ïunch”", 
PTYPE_TEXT
, 0, "ERROR", 5);

64 
	}
}

67 
	$İt¡ršg
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ *
key
, cÚ¡ * 
¡r
) {

68 cÚ¡ * 
»t
 = 
	`skyÃt_commªd
(
ùx
, "GETENV", 
key
);

69 ià(
»t
 =ğ
NULL
) {

70  
¡r
;

72  
»t
;

73 
	}
}

76 
	$š™_cb
(
¢lua
 *
l
, 
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
¬gs
, 
size_t
 
sz
) {

77 
lua_S‹
 *
L
 = 
l
->L;

78 
l
->
ùx
 = ctx;

79 
	`lua_gc
(
L
, 
LUA_GCSTOP
, 0);

80 
	`lua_pushboŞ—n
(
L
, 1);

81 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, "LUA_NOENV");

82 
	`luaL_İ’libs
(
L
);

83 
	`lua_pushlightu£rd©a
(
L
, 
ùx
);

84 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, "skynet_context");

85 
	`luaL_»quœef
(
L
, "skyÃt.codeÿche", 
codeÿche
 , 0);

86 
	`lua_pİ
(
L
,1);

88 cÚ¡ *
·th
 = 
	`İt¡ršg
(
ùx
, "lua_path","./lualib/?.lua;./lualib/?/init.lua");

89 
	`lua_push¡ršg
(
L
, 
·th
);

90 
	`lua_£tglob®
(
L
, "LUA_PATH");

91 cÚ¡ *
ı©h
 = 
	`İt¡ršg
(
ùx
, "lua_cpath","./luaclib/?.so");

92 
	`lua_push¡ršg
(
L
, 
ı©h
);

93 
	`lua_£tglob®
(
L
, "LUA_CPATH");

94 cÚ¡ *
£rviû
 = 
	`İt¡ršg
(
ùx
, "luaservice", "./service/?.lua");

95 
	`lua_push¡ršg
(
L
, 
£rviû
);

96 
	`lua_£tglob®
(
L
, "LUA_SERVICE");

97 cÚ¡ *
´–ßd
 = 
	`skyÃt_commªd
(
ùx
, "GETENV", "preload");

98 
	`lua_push¡ršg
(
L
, 
´–ßd
);

99 
	`lua_£tglob®
(
L
, "LUA_PRELOAD");

101 
	`lua_pushcfunùiÚ
(
L
, 
Œaûback
);

102 
	`as£¹
(
	`lua_g‘tİ
(
L
) == 1);

104 cÚ¡ * 
lßd”
 = 
	`İt¡ršg
(
ùx
, "lualoader", "./lualib/loader.lua");

106 
r
 = 
	`luaL_lßdfe
(
L
,
lßd”
);

107 ià(
r
 !ğ
LUA_OK
) {

108 
	`skyÃt_”rÜ
(
ùx
, "Cª'ˆlßd % : %s", 
lßd”
, 
	`lua_to¡ršg
(
L
, -1));

109 
	`»pÜt_Ïunch”_”rÜ
(
ùx
);

112 
	`lua_pushl¡ršg
(
L
, 
¬gs
, 
sz
);

113 
r
 = 
	`lua_pÿÎ
(
L
,1,0,1);

114 ià(
r
 !ğ
LUA_OK
) {

115 
	`skyÃt_”rÜ
(
ùx
, "lu¨lßd”ƒ¼Ü : %s", 
	`lua_to¡ršg
(
L
, -1));

116 
	`»pÜt_Ïunch”_”rÜ
(
ùx
);

119 
	`lua_£‰İ
(
L
,0);

120 ià(
	`lua_g‘f›ld
(
L
, 
LUA_REGISTRYINDEX
, "memlim™"è=ğ
LUA_TNUMBER
) {

121 
size_t
 
lim™
 = 
	`lua_toš‹g”
(
L
, -1);

122 
l
->
mem_lim™
 = 
lim™
;

123 
	`skyÃt_”rÜ
(
ùx
, "S‘ memÜy†im™Ø%.2àM", ()
lim™
 / (1024 * 1024));

124 
	`lua_pushn
(
L
);

125 
	`lua_£tf›ld
(
L
, 
LUA_REGISTRYINDEX
, "memlimit");

127 
	`lua_pİ
(
L
, 1);

129 
	`lua_gc
(
L
, 
LUA_GCRESTART
, 0);

132 
	}
}

135 
	$Ïunch_cb
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, *
ud
, 
ty³
, 
£ssiÚ
, 
ušt32_t
 
sourû
 , cÚ¡ * 
msg
, 
size_t
 
sz
) {

136 
	`as£¹
(
ty³
 =ğ0 && 
£ssiÚ
 == 0);

137 
¢lua
 *
l
 = 
ud
;

138 
	`skyÃt_ÿÎback
(
cÚ‹xt
, 
NULL
, NULL);

139 
”r
 = 
	`š™_cb
(
l
, 
cÚ‹xt
, 
msg
, 
sz
);

140 ià(
”r
) {

141 
	`skyÃt_commªd
(
cÚ‹xt
, "EXIT", 
NULL
);

145 
	}
}

148 
	$¢lua_š™
(
¢lua
 *
l
, 
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
¬gs
) {

149 
sz
 = 
	`¡¾’
(
¬gs
);

150 * 
tmp
 = 
	`skyÃt_m®loc
(
sz
);

151 
	`memıy
(
tmp
, 
¬gs
, 
sz
);

152 
	`skyÃt_ÿÎback
(
ùx
, 
l
 , 
Ïunch_cb
);

153 cÚ¡ * 
£lf
 = 
	`skyÃt_commªd
(
ùx
, "REG", 
NULL
);

154 
ušt32_t
 
hªdË_id
 = 
	`¡¹oul
(
£lf
+1, 
NULL
, 16);

156 
	`skyÃt_£nd
(
ùx
, 0, 
hªdË_id
, 
PTYPE_TAG_DONTCOPY
,0, 
tmp
, 
sz
);

158 
	}
}

161 
	$ÏÎoc
(* 
ud
, *
±r
, 
size_t
 
osize
, size_ˆ
nsize
) {

162 
¢lua
 *
l
 = 
ud
;

163 
size_t
 
mem
 = 
l
->mem;

164 
l
->
mem
 +ğ
nsize
;

165 ià(
±r
)

166 
l
->
mem
 -ğ
osize
;

167 ià(
l
->
mem_lim™
 !ğ0 &&†->
mem
 >†->mem_limit) {

168 ià(
±r
 =ğ
NULL
 || 
nsize
 > 
osize
) {

169 
l
->
mem
 = mem;

170  
NULL
;

173 ià(
l
->
mem
 >†->
mem_»pÜt
) {

174 
l
->
mem_»pÜt
 *= 2;

175 
	`skyÃt_”rÜ
(
l
->
ùx
, "MemÜy w¬nšg %.2àM", (î->
mem
 / (1024 * 1024));

177  
	`skyÃt_ÏÎoc
(
±r
, 
osize
, 
nsize
);

178 
	}
}

180 
¢lua
 *

181 
	$¢lua_ü—‹
() {

182 
¢lua
 * 
l
 = 
	`skyÃt_m®loc
((*l));

183 
	`mem£t
(
l
,0,(*l));

184 
l
->
mem_»pÜt
 = 
MEMORY_WARNING_REPORT
;

185 
l
->
mem_lim™
 = 0;

186 
l
->
L
 = 
	`lua_Ãw¡©e
(
ÏÎoc
,†);

187  
l
;

188 
	}
}

191 
	$¢lua_»Ëa£
(
¢lua
 *
l
) {

192 
	`lua_şo£
(
l
->
L
);

193 
	`skyÃt_ä“
(
l
);

194 
	}
}

197 
	$¢lua_sigÇl
(
¢lua
 *
l
, 
sigÇl
) {

198 
	`skyÃt_”rÜ
(
l
->
ùx
, "»cv‡ sigÇÈ%d", 
sigÇl
);

199 ià(
sigÇl
 == 0) {

200 #ifdeà
lua_checksig


202 
skyÃt_sig_L
 = 
l
->
L
;

204 } ià(
sigÇl
 == 1) {

205 
	`skyÃt_”rÜ
(
l
->
ùx
, "Cu¼’ˆMemÜy %.3fK", (î->
mem
 / 1024);

207 
	}
}

	@skynet-src/atomic.h

1 #iâdeà
SKYNET_ATOMIC_H


2 
	#SKYNET_ATOMIC_H


	)

4 
	#ATOM_CAS
(
±r
, 
ov®
, 
nv®
è
	`__sync_boŞ_com·»_ªd_sw­
ÕŒ, ov®,‚v®)

	)

5 
	#ATOM_CAS_POINTER
(
±r
, 
ov®
, 
nv®
è
	`__sync_boŞ_com·»_ªd_sw­
ÕŒ, ov®,‚v®)

	)

6 
	#ATOM_INC
(
±r
è
	`__sync_add_ªd_ãtch
ÕŒ, 1)

	)

7 
	#ATOM_FINC
(
±r
è
	`__sync_ãtch_ªd_add
ÕŒ, 1)

	)

8 
	#ATOM_DEC
(
±r
è
	`__sync_sub_ªd_ãtch
ÕŒ, 1)

	)

9 
	#ATOM_FDEC
(
±r
è
	`__sync_ãtch_ªd_sub
ÕŒ, 1)

	)

10 
	#ATOM_ADD
(
±r
,
n
è
	`__sync_add_ªd_ãtch
ÕŒ,‚)

	)

11 
	#ATOM_SUB
(
±r
,
n
è
	`__sync_sub_ªd_ãtch
ÕŒ,‚)

	)

12 
	#ATOM_AND
(
±r
,
n
è
	`__sync_ªd_ªd_ãtch
ÕŒ,‚)

	)

	@skynet-src/luashrtbl.h

1 #iâdeà
LUA_SHORT_STRING_TABLE_H


2 
	#LUA_SHORT_STRING_TABLE_H


	)

4 
	~"l¡ršg.h
"

7 #iâdeà
ENABLE_SHORT_STRING_TABLE


9 
šlše
 
	$luaS_shršfo
(
lua_S‹
 *
L
è{  0; 
	}
}

10 
šlše
 
	$luaS_š™shr
(è{
	}
}

11 
šlše
 
	$luaS_ex™shr
(è{
	}
}

12 
šlše
 
	$luaS_ex·ndshr
(
n
è{
	}
}

	@skynet-src/malloc_hook.c

1 
	~<¡dio.h
>

2 
	~<¡ršg.h
>

3 
	~<as£¹.h
>

4 
	~<¡dlib.h
>

5 
	~<lua.h
>

6 
	~<¡dio.h
>

8 
	~"m®loc_hook.h
"

9 
	~"skyÃt.h
"

10 
	~"©omic.h
"

15 
	#MEMORY_ALLOCTAG
 0x20140605

	)

16 
	#MEMORY_FREETAG
 0x0badf00d

	)

18 
size_t
 
	g_u£d_memÜy
 = 0;

19 
size_t
 
	g_memÜy_block
 = 0;

21 
	smem_d©a
 {

22 
ušt32_t
 
	mhªdË
;

23 
ssize_t
 
	m®loÿ‹d
;

26 
	smem_cook›
 {

27 
ušt32_t
 
	mhªdË
;

28 #ifdeà
MEMORY_CHECK


29 
ušt32_t
 
	mdogg
;

33 
	#SLOT_SIZE
 0x10000

	)

34 
	#PREFIX_SIZE
 (
mem_cook›
)

	)

36 
mem_d©a
 
	gmem_¡©s
[
SLOT_SIZE
];

39 #iâdeà
NOUSE_JEMALLOC


41 
	~"jem®loc.h
"

44 
	#¿w_»®loc
 
je_»®loc


	)

45 
	#¿w_ä“
 
je_ä“


	)

47 
ssize_t
*

48 
	$g‘_®loÿ‹d_f›ld
(
ušt32_t
 
hªdË
) {

49 
h
 = ()(
hªdË
 & (
SLOT_SIZE
 - 1));

50 
mem_d©a
 *
d©a
 = &
mem_¡©s
[
h
];

51 
ušt32_t
 
Şd_hªdË
 = 
d©a
->
hªdË
;

52 
ssize_t
 
Şd_®loc
 = 
d©a
->
®loÿ‹d
;

53 if(
Şd_hªdË
 =ğ0 || 
Şd_®loc
 <= 0) {

55 if(!
	`ATOM_CAS
(&
d©a
->
hªdË
, 
Şd_hªdË
, handle)) {

58 ià(
Şd_®loc
 < 0) {

59 
	`ATOM_CAS
(&
d©a
->
®loÿ‹d
, 
Şd_®loc
, 0);

62 if(
d©a
->
hªdË
 != handle) {

65  &
d©a
->
®loÿ‹d
;

66 
	}
}

68 
šlše
 

69 
	$upd©e_xm®loc_¡©_®loc
(
ušt32_t
 
hªdË
, 
size_t
 
__n
) {

70 
	`ATOM_ADD
(&
_u£d_memÜy
, 
__n
);

71 
	`ATOM_INC
(&
_memÜy_block
);

72 
ssize_t
* 
®loÿ‹d
 = 
	`g‘_®loÿ‹d_f›ld
(
hªdË
);

73 if(
®loÿ‹d
) {

74 
	`ATOM_ADD
(
®loÿ‹d
, 
__n
);

76 
	}
}

78 
šlše
 

79 
	$upd©e_xm®loc_¡©_ä“
(
ušt32_t
 
hªdË
, 
size_t
 
__n
) {

80 
	`ATOM_SUB
(&
_u£d_memÜy
, 
__n
);

81 
	`ATOM_DEC
(&
_memÜy_block
);

82 
ssize_t
* 
®loÿ‹d
 = 
	`g‘_®loÿ‹d_f›ld
(
hªdË
);

83 if(
®loÿ‹d
) {

84 
	`ATOM_SUB
(
®loÿ‹d
, 
__n
);

86 
	}
}

88 
šlše
 *

89 
	$fl_´efix
(* 
±r
) {

90 
ušt32_t
 
hªdË
 = 
	`skyÃt_cu¼’t_hªdË
();

91 
size_t
 
size
 = 
	`je_m®loc_u§bË_size
(
±r
);

92 
mem_cook›
 *
p
 = (mem_cook› *)(
±r
 + 
size
 - (mem_cookie));

93 
	`memıy
(&
p
->
hªdË
, &handle, (handle));

94 #ifdeà
MEMORY_CHECK


95 
ušt32_t
 
dogg
 = 
MEMORY_ALLOCTAG
;

96 
	`memıy
(&
p
->
dogg
, &dogtag, (dogtag));

98 
	`upd©e_xm®loc_¡©_®loc
(
hªdË
, 
size
);

99  
±r
;

100 
	}
}

102 
šlše
 *

103 
	$ş—n_´efix
(* 
±r
) {

104 
size_t
 
size
 = 
	`je_m®loc_u§bË_size
(
±r
);

105 
mem_cook›
 *
p
 = (mem_cook› *)(
±r
 + 
size
 - (mem_cookie));

106 
ušt32_t
 
hªdË
;

107 
	`memıy
(&
hªdË
, &
p
->handle, (handle));

108 #ifdeà
MEMORY_CHECK


109 
ušt32_t
 
dogg
;

110 
	`memıy
(&
dogg
, &
p
->dogtag, (dogtag));

111 ià(
dogg
 =ğ
MEMORY_FREETAG
) {

112 
	`årštf
(
¡d”r
, "xm®loc: doubË f»š :%08x\n", 
hªdË
);

114 
	`as£¹
(
dogg
 =ğ
MEMORY_ALLOCTAG
);

115 
dogg
 = 
MEMORY_FREETAG
;

116 
	`memıy
(&
p
->
dogg
, &dogtag, (dogtag));

118 
	`upd©e_xm®loc_¡©_ä“
(
hªdË
, 
size
);

119  
±r
;

120 
	}
}

122 
	$m®loc_oom
(
size_t
 
size
) {

123 
	`årštf
(
¡d”r
, "xmalloc: Out of memoryryingo‡llocate %zu bytes\n",

124 
size
);

125 
	`fæush
(
¡d”r
);

126 
	`abÜt
();

127 
	}
}

130 
	$memÜy_šfo_dump
() {

131 
	`je_m®loc_¡©s_´št
(0,0,0);

132 
	}
}

134 
size_t


135 
	$m®lùl_št64
(cÚ¡ * 
Çme
, 
size_t
* 
Ãwv®
) {

136 
size_t
 
v
 = 0;

137 
size_t
 
Ën
 = (
v
);

138 if(
Ãwv®
) {

139 
	`je_m®lùl
(
Çme
, &
v
, &
Ën
, 
Ãwv®
, (
size_t
));

141 
	`je_m®lùl
(
Çme
, &
v
, &
Ën
, 
NULL
, 0);

144  
v
;

145 
	}
}

148 
	$m®lùl_İt
(cÚ¡ * 
Çme
, * 
Ãwv®
) {

149 
v
 = 0;

150 
size_t
 
Ën
 = (
v
);

151 if(
Ãwv®
) {

152 
»t
 = 
	`je_m®lùl
(
Çme
, &
v
, &
Ën
, 
Ãwv®
, ());

153 if(
»t
 == 0) {

154 
	`skyÃt_”rÜ
(
NULL
, "£ˆÃw v®ue(%dèfÜ (%sèsucûed\n", *
Ãwv®
, 
Çme
);

156 
	`skyÃt_”rÜ
(
NULL
, "£ˆÃw v®ue(%dèfÜ (%sèçed:ƒ¼Ü -> %d\n", *
Ãwv®
, 
Çme
, 
»t
);

159 
	`je_m®lùl
(
Çme
, &
v
, &
Ën
, 
NULL
, 0);

162  
v
;

163 
	}
}

168 
	$skyÃt_m®loc
(
size_t
 
size
) {

169 * 
±r
 = 
	`je_m®loc
(
size
 + 
PREFIX_SIZE
);

170 if(!
±r
è
	`m®loc_oom
(
size
);

171  
	`fl_´efix
(
±r
);

172 
	}
}

175 
	$skyÃt_»®loc
(*
±r
, 
size_t
 
size
) {

176 ià(
±r
 =ğ
NULL
è 
	`skyÃt_m®loc
(
size
);

178 * 
¿w±r
 = 
	`ş—n_´efix
(
±r
);

179 *
Ãw±r
 = 
	`je_»®loc
(
¿w±r
, 
size
+
PREFIX_SIZE
);

180 if(!
Ãw±r
è
	`m®loc_oom
(
size
);

181  
	`fl_´efix
(
Ãw±r
);

182 
	}
}

185 
	$skyÃt_ä“
(*
±r
) {

186 ià(
±r
 =ğ
NULL
) ;

187 * 
¿w±r
 = 
	`ş—n_´efix
(
±r
);

188 
	`je_ä“
(
¿w±r
);

189 
	}
}

192 
	$skyÃt_ÿÎoc
(
size_t
 
nmemb
,size_ˆ
size
) {

193 * 
±r
 = 
	`je_ÿÎoc
(
nmemb
 + ((
PREFIX_SIZE
+
size
-1)/size), size );

194 if(!
±r
è
	`m®loc_oom
(
size
);

195  
	`fl_´efix
(
±r
);

196 
	}
}

199 
	$skyÃt_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
) {

200 * 
±r
 = 
	`je_mem®ign
(
®ignm’t
, 
size
 + 
PREFIX_SIZE
);

201 if(!
±r
è
	`m®loc_oom
(
size
);

202  
	`fl_´efix
(
±r
);

203 
	}
}

208 
	#¿w_»®loc
 
»®loc


	)

209 
	#¿w_ä“
 
ä“


	)

212 
	$memÜy_šfo_dump
() {

213 
	`skyÃt_”rÜ
(
NULL
, "No jemalloc");

214 
	}
}

216 
size_t


217 
	$m®lùl_št64
(cÚ¡ * 
Çme
, 
size_t
* 
Ãwv®
) {

218 
	`skyÃt_”rÜ
(
NULL
, "NØjem®loø: m®lùl_št64 %s.", 
Çme
);

220 
	}
}

223 
	$m®lùl_İt
(cÚ¡ * 
Çme
, * 
Ãwv®
) {

224 
	`skyÃt_”rÜ
(
NULL
, "NØjem®loø: m®lùl_İˆ%s.", 
Çme
);

226 
	}
}

230 
size_t


231 
	$m®loc_u£d_memÜy
() {

232  
_u£d_memÜy
;

233 
	}
}

235 
size_t


236 
	$m®loc_memÜy_block
() {

237  
_memÜy_block
;

238 
	}
}

241 
	$dump_c_mem
() {

242 
i
;

243 
size_t
 
tÙ®
 = 0;

244 
	`skyÃt_”rÜ
(
NULL
, "dump‡ll service mem:");

245 
i
=0; i<
SLOT_SIZE
; i++) {

246 
mem_d©a
* 
d©a
 = &
mem_¡©s
[
i
];

247 if(
d©a
->
hªdË
 !ğ0 && d©a->
®loÿ‹d
 != 0) {

248 
tÙ®
 +ğ
d©a
->
®loÿ‹d
;

249 
	`skyÃt_”rÜ
(
NULL
, "0x%x -> %zdkb", 
d©a
->
hªdË
, d©a->
®loÿ‹d
 >> 10);

252 
	`skyÃt_”rÜ
(
NULL
, "+tÙ®: %zdkb",
tÙ®
 >> 10);

253 
	}
}

256 
	$skyÃt_¡rdup
(cÚ¡ *
¡r
) {

257 
size_t
 
sz
 = 
	`¡¾’
(
¡r
);

258 * 
»t
 = 
	`skyÃt_m®loc
(
sz
+1);

259 
	`memıy
(
»t
, 
¡r
, 
sz
+1);

260  
»t
;

261 
	}
}

264 
	$skyÃt_ÏÎoc
(*
±r
, 
size_t
 
osize
, size_ˆ
nsize
) {

265 ià(
nsize
 == 0) {

266 
	`¿w_ä“
(
±r
);

267  
NULL
;

269  
	`¿w_»®loc
(
±r
, 
nsize
);

271 
	}
}

274 
	$dump_mem_lua
(
lua_S‹
 *
L
) {

275 
i
;

276 
	`lua_ÃwbË
(
L
);

277 
i
=0; i<
SLOT_SIZE
; i++) {

278 
mem_d©a
* 
d©a
 = &
mem_¡©s
[
i
];

279 if(
d©a
->
hªdË
 !ğ0 && d©a->
®loÿ‹d
 != 0) {

280 
	`lua_pushš‹g”
(
L
, 
d©a
->
®loÿ‹d
);

281 
	`lua_¿w£ti
(
L
, -2, (
lua_IÁeg”
)
d©a
->
hªdË
);

285 
	}
}

287 
size_t


288 
	$m®loc_cu¼’t_memÜy
() {

289 
ušt32_t
 
hªdË
 = 
	`skyÃt_cu¼’t_hªdË
();

290 
i
;

291 
i
=0; i<
SLOT_SIZE
; i++) {

292 
mem_d©a
* 
d©a
 = &
mem_¡©s
[
i
];

293 if(
d©a
->
hªdË
 =ğ(
ušt32_t
)hªdË && d©a->
®loÿ‹d
 != 0) {

294  (
size_t
è
d©a
->
®loÿ‹d
;

298 
	}
}

301 
	$skyÃt_debug_memÜy
(cÚ¡ *
šfo
) {

303 
ušt32_t
 
hªdË
 = 
	`skyÃt_cu¼’t_hªdË
();

304 
size_t
 
mem
 = 
	`m®loc_cu¼’t_memÜy
();

305 
	`årštf
(
¡d”r
, "[:%08x] % %p\n", 
hªdË
, 
šfo
, (*)
mem
);

306 
	}
}

	@skynet-src/malloc_hook.h

1 #iâdeà
SKYNET_MALLOC_HOOK_H


2 
	#SKYNET_MALLOC_HOOK_H


	)

4 
	~<¡dlib.h
>

5 
	~<lua.h
>

7 
size_t
 
m®loc_u£d_memÜy
();

8 
size_t
 
m®loc_memÜy_block
();

9 
memÜy_šfo_dump
();

10 
size_t
 
m®lùl_št64
(cÚ¡ * 
Çme
, size_t* 
Ãwv®
);

11 
m®lùl_İt
(cÚ¡ * 
Çme
, * 
Ãwv®
);

12 
dump_c_mem
();

13 
dump_mem_lua
(
lua_S‹
 *
L
);

14 
size_t
 
m®loc_cu¼’t_memÜy
();

	@skynet-src/rwlock.h

1 #iâdeà
SKYNET_RWLOCK_H


2 
	#SKYNET_RWLOCK_H


	)

4 #iâdeà
USE_PTHREAD_LOCK


6 
	srwlock
 {

7 
	mwr™e
;

8 
	m»ad
;

11 
šlše
 

12 
	$rwlock_š™
(
rwlock
 *
lock
) {

13 
lock
->
wr™e
 = 0;

14 
lock
->
»ad
 = 0;

15 
	}
}

17 
šlše
 

18 
	$rwlock_¾ock
(
rwlock
 *
lock
) {

20 
lock
->
wr™e
) {

21 
	`__sync_synchrÚize
();

23 
	`__sync_add_ªd_ãtch
(&
lock
->
»ad
,1);

24 ià(
lock
->
wr™e
) {

25 
	`__sync_sub_ªd_ãtch
(&
lock
->
»ad
,1);

30 
	}
}

32 
šlše
 

33 
	$rwlock_wlock
(
rwlock
 *
lock
) {

34 
	`__sync_lock_‹¡_ªd_£t
(&
lock
->
wr™e
,1)) {}

35 
lock
->
»ad
) {

36 
	`__sync_synchrÚize
();

38 
	}
}

40 
šlše
 

41 
	$rwlock_wuÆock
(
rwlock
 *
lock
) {

42 
	`__sync_lock_»Ëa£
(&
lock
->
wr™e
);

43 
	}
}

45 
šlše
 

46 
	$rwlock_ruÆock
(
rwlock
 *
lock
) {

47 
	`__sync_sub_ªd_ãtch
(&
lock
->
»ad
,1);

48 
	}
}

52 
	~<±h»ad.h
>

57 
	srwlock
 {

58 
±h»ad_rwlock_t
 
	mlock
;

61 
šlše
 

62 
	$rwlock_š™
(
rwlock
 *
lock
) {

63 
	`±h»ad_rwlock_š™
(&
lock
->lock, 
NULL
);

64 
	}
}

66 
šlše
 

67 
	$rwlock_¾ock
(
rwlock
 *
lock
) {

68 
	`±h»ad_rwlock_rdlock
(&
lock
->lock);

69 
	}
}

71 
šlše
 

72 
	$rwlock_wlock
(
rwlock
 *
lock
) {

73 
	`±h»ad_rwlock_w¾ock
(&
lock
->lock);

74 
	}
}

76 
šlše
 

77 
	$rwlock_wuÆock
(
rwlock
 *
lock
) {

78 
	`±h»ad_rwlock_uÆock
(&
lock
->lock);

79 
	}
}

81 
šlše
 

82 
	$rwlock_ruÆock
(
rwlock
 *
lock
) {

83 
	`±h»ad_rwlock_uÆock
(&
lock
->lock);

84 
	}
}

	@skynet-src/skynet.h

1 #iâdeà
SKYNET_H


2 
	#SKYNET_H


	)

4 
	~"skyÃt_m®loc.h
"

6 
	~<¡ddef.h
>

7 
	~<¡dšt.h
>

9 
	#PTYPE_TEXT
 0

	)

10 
	#PTYPE_RESPONSE
 1

	)

11 
	#PTYPE_MULTICAST
 2

	)

12 
	#PTYPE_CLIENT
 3

	)

13 
	#PTYPE_SYSTEM
 4

	)

14 
	#PTYPE_HARBOR
 5

	)

15 
	#PTYPE_SOCKET
 6

	)

17 
	#PTYPE_ERROR
 7

	)

19 
	#PTYPE_RESERVED_QUEUE
 8

	)

20 
	#PTYPE_RESERVED_DEBUG
 9

	)

21 
	#PTYPE_RESERVED_LUA
 10

	)

22 
	#PTYPE_RESERVED_SNAX
 11

	)

24 
	#PTYPE_TAG_DONTCOPY
 0x10000

	)

25 
	#PTYPE_TAG_ALLOCSESSION
 0x20000

	)

27 
	gskyÃt_cÚ‹xt
;

29 
skyÃt_”rÜ
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ *
msg
, ...);

30 cÚ¡ * 
skyÃt_commªd
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
cmd
 , cÚ¡ * 
·rm
);

31 
ušt32_t
 
skyÃt_qu”yÇme
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
Çme
);

32 
skyÃt_£nd
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, 
ušt32_t
 
sourû
, ušt32_ˆ
de¡š©iÚ
 , 
ty³
, 
£ssiÚ
, * 
msg
, 
size_t
 
sz
);

33 
skyÃt_£ndÇme
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, 
ušt32_t
 
sourû
, cÚ¡ * 
de¡š©iÚ
 , 
ty³
, 
£ssiÚ
, * 
msg
, 
size_t
 
sz
);

35 
skyÃt_i¤emÙe
(
skyÃt_cÚ‹xt
 *, 
ušt32_t
 
hªdË
, * 
h¬bÜ
);

37 (*
	tskyÃt_cb
)(
	tskyÃt_cÚ‹xt
 * 
	tcÚ‹xt
, *
	tud
, 
	tty³
, 
	t£ssiÚ
, 
	tušt32_t
 
	tsourû
 , cÚ¡ * 
	tmsg
, 
	tsize_t
 
	tsz
);

38 
	`skyÃt_ÿÎback
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, *
ud
, 
skyÃt_cb
 
cb
);

40 
ušt32_t
 
	`skyÃt_cu¼’t_hªdË
();

41 
ušt64_t
 
	`skyÃt_now
();

42 
	`skyÃt_debug_memÜy
(cÚ¡ *
šfo
);

	@skynet-src/skynet_daemon.c

1 
	~<¡dio.h
>

2 
	~<uni¡d.h
>

3 
	~<sys/ty³s.h
>

4 
	~<sys/fe.h
>

5 
	~<sigÇl.h
>

6 
	~<”ºo.h
>

7 
	~<¡dlib.h
>

8 
	~<fú.h
>

10 
	~"skyÃt_d«mÚ.h
"

13 
	$check_pid
(cÚ¡ *
pidfe
) {

14 
pid
 = 0;

15 
FILE
 *
f
 = 
	`fİ’
(
pidfe
,"r");

16 ià(
f
 =ğ
NULL
)

18 
n
 = 
	`fsÿnf
(
f
,"%d", &
pid
);

19 
	`fşo£
(
f
);

21 ià(
n
 !=1 || 
pid
 =ğ0 ||…id =ğ
	`g‘pid
()) {

25 ià(
	`kl
(
pid
, 0è&& 
”ºo
 =ğ
ESRCH
)

28  
pid
;

29 
	}
}

32 
	$wr™e_pid
(cÚ¡ *
pidfe
) {

33 
FILE
 *
f
;

34 
pid
 = 0;

35 
fd
 = 
	`İ’
(
pidfe
, 
O_RDWR
|
O_CREAT
, 0644);

36 ià(
fd
 == -1) {

37 
	`årštf
(
¡d”r
, "Cª'ˆü—‹…idf[%s].\n", 
pidfe
);

40 
f
 = 
	`fdİ’
(
fd
, "r+");

41 ià(
f
 =ğ
NULL
) {

42 
	`årštf
(
¡d”r
, "Cª'ˆİ’…idf[%s].\n", 
pidfe
);

46 ià(
	`æock
(
fd
, 
LOCK_EX
|
LOCK_NB
) == -1) {

47 
n
 = 
	`fsÿnf
(
f
, "%d", &
pid
);

48 
	`fşo£
(
f
);

49 ià(
n
 != 1) {

50 
	`årštf
(
¡d”r
, "Can't†ock‡nd„ead…idfile.\n");

52 
	`årštf
(
¡d”r
, "Cª'ˆlock…idfe,†ock i h–d by…id %d.\n", 
pid
);

57 
pid
 = 
	`g‘pid
();

58 ià(!
	`årštf
(
f
,"%d\n", 
pid
)) {

59 
	`årštf
(
¡d”r
, "Can't write…id.\n");

60 
	`şo£
(
fd
);

63 
	`fæush
(
f
);

65  
pid
;

66 
	}
}

69 
	$»dœeù_fds
() {

70 
nfd
 = 
	`İ’
("/dev/nuÎ", 
O_RDWR
);

71 ià(
nfd
 == -1) {

72 
	`³¼Ü
("Unableo open /dev/null: ");

75 ià(
	`dup2
(
nfd
, 0) < 0) {

76 
	`³¼Ü
("Unableo dup2 stdin(0): ");

79 ià(
	`dup2
(
nfd
, 1) < 0) {

80 
	`³¼Ü
("Unableo dup2 stdout(1): ");

83 ià(
	`dup2
(
nfd
, 2) < 0) {

84 
	`³¼Ü
("Unableo dup2 stderr(2): ");

88 
	`şo£
(
nfd
);

91 
	}
}

94 
	$d«mÚ_š™
(cÚ¡ *
pidfe
) {

95 
pid
 = 
	`check_pid
(
pidfe
);

97 ià(
pid
) {

98 
	`årštf
(
¡d”r
, "SkyÃˆi ®»ady„uÂšg,…id = %d.\n", 
pid
);

102 #ifdeà
__APPLE__


103 
	`årštf
(
¡d”r
, "'daemon' is deprecated: first deprecated in OS X 10.5 , use†aunchd instead.\n");

105 ià(
	`d«mÚ
(1,1)) {

106 
	`årštf
(
¡d”r
, "Can't daemonize.\n");

111 
pid
 = 
	`wr™e_pid
(
pidfe
);

112 ià(
pid
 == 0) {

116 ià(
	`»dœeù_fds
()) {

121 
	}
}

124 
	$d«mÚ_ex™
(cÚ¡ *
pidfe
) {

125  
	`uÆšk
(
pidfe
);

126 
	}
}

	@skynet-src/skynet_daemon.h

1 #iâdeà
skyÃt_d«mÚ_h


2 
	#skyÃt_d«mÚ_h


	)

4 
d«mÚ_š™
(cÚ¡ *
pidfe
);

5 
d«mÚ_ex™
(cÚ¡ *
pidfe
);

	@skynet-src/skynet_env.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_’v.h
"

3 
	~"¥šlock.h
"

5 
	~<lua.h
>

6 
	~<Ïuxlib.h
>

8 
	~<¡dlib.h
>

9 
	~<as£¹.h
>

11 
	sskyÃt_’v
 {

12 
¥šlock
 
	mlock
;

13 
lua_S‹
 *
	mL
;

16 
skyÃt_’v
 *
	gE
 = 
NULL
;

19 
	$skyÃt_g‘’v
(cÚ¡ *
key
) {

20 
	`SPIN_LOCK
(
E
)

22 
lua_S‹
 *
L
 = 
E
->L;

24 
	`lua_g‘glob®
(
L
, 
key
);

25 cÚ¡ * 
»suÉ
 = 
	`lua_to¡ršg
(
L
, -1);

26 
	`lua_pİ
(
L
, 1);

28 
	`SPIN_UNLOCK
(
E
)

30  
»suÉ
;

31 
	}
}

34 
	$skyÃt_£‹nv
(cÚ¡ *
key
, cÚ¡ *
v®ue
) {

35 
	`SPIN_LOCK
(
E
)

37 
lua_S‹
 *
L
 = 
E
->L;

38 
	`lua_g‘glob®
(
L
, 
key
);

39 
	`as£¹
(
	`lua_i¢
(
L
, -1));

40 
	`lua_pİ
(
L
,1);

41 
	`lua_push¡ršg
(
L
,
v®ue
);

42 
	`lua_£tglob®
(
L
,
key
);

44 
	`SPIN_UNLOCK
(
E
)

45 
	}
}

48 
	$skyÃt_’v_š™
() {

49 
E
 = 
	`skyÃt_m®loc
((*E));

50 
	`SPIN_INIT
(
E
)

51 
E
->
L
 = 
	`luaL_Ãw¡©e
();

52 
	}
}

	@skynet-src/skynet_env.h

1 #iâdeà
SKYNET_ENV_H


2 
	#SKYNET_ENV_H


	)

4 cÚ¡ * 
skyÃt_g‘’v
(cÚ¡ *
key
);

5 
skyÃt_£‹nv
(cÚ¡ *
key
, cÚ¡ *
v®ue
);

7 
skyÃt_’v_š™
();

	@skynet-src/skynet_error.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_hªdË.h
"

3 
	~"skyÃt_mq.h
"

4 
	~"skyÃt_£rv”.h
"

6 
	~<¡d¬g.h
>

7 
	~<¡dio.h
>

8 
	~<¡ršg.h
>

9 
	~<¡dlib.h
>

11 
	#LOG_MESSAGE_SIZE
 256

	)

14 
	$skyÃt_”rÜ
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ *
msg
, ...) {

15 
ušt32_t
 
logg”
 = 0;

16 ià(
logg”
 == 0) {

17 
logg”
 = 
	`skyÃt_hªdË_fšdÇme
("logger");

19 ià(
logg”
 == 0) {

23 
tmp
[
LOG_MESSAGE_SIZE
];

24 *
d©a
 = 
NULL
;

26 
va_li¡
 
­
;

28 
	`va_¡¬t
(
­
,
msg
);

29 
Ën
 = 
	`v¢´štf
(
tmp
, 
LOG_MESSAGE_SIZE
, 
msg
, 
­
);

30 
	`va_’d
(
­
);

31 ià(
Ën
 >=0 &&†’ < 
LOG_MESSAGE_SIZE
) {

32 
d©a
 = 
	`skyÃt_¡rdup
(
tmp
);

34 
max_size
 = 
LOG_MESSAGE_SIZE
;

36 
max_size
 *= 2;

37 
d©a
 = 
	`skyÃt_m®loc
(
max_size
);

38 
	`va_¡¬t
(
­
,
msg
);

39 
Ën
 = 
	`v¢´štf
(
d©a
, 
max_size
, 
msg
, 
­
);

40 
	`va_’d
(
­
);

41 ià(
Ën
 < 
max_size
) {

44 
	`skyÃt_ä“
(
d©a
);

47 ià(
Ën
 < 0) {

48 
	`skyÃt_ä“
(
d©a
);

49 
	`³¼Ü
("vsnprintfƒrror :");

54 
skyÃt_mes§ge
 
smsg
;

55 ià(
cÚ‹xt
 =ğ
NULL
) {

56 
smsg
.
sourû
 = 0;

58 
smsg
.
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
cÚ‹xt
);

60 
smsg
.
£ssiÚ
 = 0;

61 
smsg
.
d©a
 = data;

62 
smsg
.
sz
 = 
Ën
 | ((
size_t
)
PTYPE_TEXT
 << 
MESSAGE_TYPE_SHIFT
);

63 
	`skyÃt_cÚ‹xt_push
(
logg”
, &
smsg
);

64 
	}
}

	@skynet-src/skynet_handle.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_hªdË.h
"

4 
	~"skyÃt_£rv”.h
"

5 
	~"rwlock.h
"

7 
	~<¡dlib.h
>

8 
	~<as£¹.h
>

9 
	~<¡ršg.h
>

11 
	#DEFAULT_SLOT_SIZE
 4

	)

12 
	#MAX_SLOT_SIZE
 0x40000000

	)

14 
	shªdË_Çme
 {

15 * 
	mÇme
;

16 
ušt32_t
 
	mhªdË
;

19 
	shªdË_¡Üage
 {

20 
rwlock
 
	mlock
;

22 
ušt32_t
 
	mh¬bÜ
;

23 
ušt32_t
 
	mhªdË_šdex
;

24 
	m¦Ù_size
;

25 
skyÃt_cÚ‹xt
 ** 
	m¦Ù
;

27 
	mÇme_ÿp
;

28 
	mÇme_couÁ
;

29 
hªdË_Çme
 *
	mÇme
;

32 
hªdË_¡Üage
 *
	gH
 = 
NULL
;

34 
ušt32_t


35 
	$skyÃt_hªdË_»gi¡”
(
skyÃt_cÚ‹xt
 *
ùx
) {

36 
hªdË_¡Üage
 *
s
 = 
H
;

38 
	`rwlock_wlock
(&
s
->
lock
);

41 
i
;

42 
i
=0;i<
s
->
¦Ù_size
;i++) {

43 
ušt32_t
 
hªdË
 = (
i
+
s
->
hªdË_šdex
è& 
HANDLE_MASK
;

44 
hash
 = 
hªdË
 & (
s
->
¦Ù_size
-1);

45 ià(
s
->
¦Ù
[
hash
] =ğ
NULL
) {

46 
s
->
¦Ù
[
hash
] = 
ùx
;

47 
s
->
hªdË_šdex
 = 
hªdË
 + 1;

49 
	`rwlock_wuÆock
(&
s
->
lock
);

51 
hªdË
 |ğ
s
->
h¬bÜ
;

52  
hªdË
;

55 
	`as£¹
((
s
->
¦Ù_size
*2 - 1è<ğ
HANDLE_MASK
);

56 
skyÃt_cÚ‹xt
 ** 
Ãw_¦Ù
 = 
	`skyÃt_m®loc
(
s
->
¦Ù_size
 * 2 * (skynet_context *));

57 
	`mem£t
(
Ãw_¦Ù
, 0, 
s
->
¦Ù_size
 * 2 * (
skyÃt_cÚ‹xt
 *));

58 
i
=0;i<
s
->
¦Ù_size
;i++) {

59 
hash
 = 
	`skyÃt_cÚ‹xt_hªdË
(
s
->
¦Ù
[
i
]è& (s->
¦Ù_size
 * 2 - 1);

60 
	`as£¹
(
Ãw_¦Ù
[
hash
] =ğ
NULL
);

61 
Ãw_¦Ù
[
hash
] = 
s
->
¦Ù
[
i
];

63 
	`skyÃt_ä“
(
s
->
¦Ù
);

64 
s
->
¦Ù
 = 
Ãw_¦Ù
;

65 
s
->
¦Ù_size
 *= 2;

67 
	}
}

70 
	$skyÃt_hªdË_»tœe
(
ušt32_t
 
hªdË
) {

71 
»t
 = 0;

72 
hªdË_¡Üage
 *
s
 = 
H
;

74 
	`rwlock_wlock
(&
s
->
lock
);

76 
ušt32_t
 
hash
 = 
hªdË
 & (
s
->
¦Ù_size
-1);

77 
skyÃt_cÚ‹xt
 * 
ùx
 = 
s
->
¦Ù
[
hash
];

79 ià(
ùx
 !ğ
NULL
 && 
	`skyÃt_cÚ‹xt_hªdË
(ùxè=ğ
hªdË
) {

80 
s
->
¦Ù
[
hash
] = 
NULL
;

81 
»t
 = 1;

82 
i
;

83 
j
=0, 
n
=
s
->
Çme_couÁ
;

84 
i
=0; i<
n
; ++i) {

85 ià(
s
->
Çme
[
i
].
hªdË
 == handle) {

86 
	`skyÃt_ä“
(
s
->
Çme
[
i
].name);

88 } ià(
i
!=
j
) {

89 
s
->
Çme
[
j
] = s->Çme[
i
];

91 ++
j
;

93 
s
->
Çme_couÁ
 = 
j
;

95 
ùx
 = 
NULL
;

98 
	`rwlock_wuÆock
(&
s
->
lock
);

100 ià(
ùx
) {

102 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

105  
»t
;

106 
	}
}

109 
	$skyÃt_hªdË_»tœ—Î
() {

110 
hªdË_¡Üage
 *
s
 = 
H
;

112 
n
=0;

113 
i
;

114 
i
=0;i<
s
->
¦Ù_size
;i++) {

115 
	`rwlock_¾ock
(&
s
->
lock
);

116 
skyÃt_cÚ‹xt
 * 
ùx
 = 
s
->
¦Ù
[
i
];

117 
ušt32_t
 
hªdË
 = 0;

118 ià(
ùx
)

119 
hªdË
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

120 
	`rwlock_ruÆock
(&
s
->
lock
);

121 ià(
hªdË
 != 0) {

122 ià(
	`skyÃt_hªdË_»tœe
(
hªdË
)) {

123 ++
n
;

127 ià(
n
==0)

130 
	}
}

132 
skyÃt_cÚ‹xt
 *

133 
	$skyÃt_hªdË_g¿b
(
ušt32_t
 
hªdË
) {

134 
hªdË_¡Üage
 *
s
 = 
H
;

135 
skyÃt_cÚ‹xt
 * 
»suÉ
 = 
NULL
;

137 
	`rwlock_¾ock
(&
s
->
lock
);

139 
ušt32_t
 
hash
 = 
hªdË
 & (
s
->
¦Ù_size
-1);

140 
skyÃt_cÚ‹xt
 * 
ùx
 = 
s
->
¦Ù
[
hash
];

141 ià(
ùx
 && 
	`skyÃt_cÚ‹xt_hªdË
(ùxè=ğ
hªdË
) {

142 
»suÉ
 = 
ùx
;

143 
	`skyÃt_cÚ‹xt_g¿b
(
»suÉ
);

146 
	`rwlock_ruÆock
(&
s
->
lock
);

148  
»suÉ
;

149 
	}
}

151 
ušt32_t


152 
	$skyÃt_hªdË_fšdÇme
(cÚ¡ * 
Çme
) {

153 
hªdË_¡Üage
 *
s
 = 
H
;

155 
	`rwlock_¾ock
(&
s
->
lock
);

157 
ušt32_t
 
hªdË
 = 0;

159 
begš
 = 0;

160 
’d
 = 
s
->
Çme_couÁ
 - 1;

161 
begš
<=
’d
) {

162 
mid
 = (
begš
+
’d
)/2;

163 
hªdË_Çme
 *
n
 = &
s
->
Çme
[
mid
];

164 
c
 = 
	`¡rcmp
(
n
->
Çme
,‚ame);

165 ià(
c
==0) {

166 
hªdË
 = 
n
->handle;

169 ià(
c
<0) {

170 
begš
 = 
mid
 + 1;

172 
’d
 = 
mid
 - 1;

176 
	`rwlock_ruÆock
(&
s
->
lock
);

178  
hªdË
;

179 
	}
}

182 
	$_š£¹_Çme_befÜe
(
hªdË_¡Üage
 *
s
, *
Çme
, 
ušt32_t
 
hªdË
, 
befÜe
) {

183 ià(
s
->
Çme_couÁ
 >ğs->
Çme_ÿp
) {

184 
s
->
Çme_ÿp
 *= 2;

185 
	`as£¹
(
s
->
Çme_ÿp
 <ğ
MAX_SLOT_SIZE
);

186 
hªdË_Çme
 * 
n
 = 
	`skyÃt_m®loc
(
s
->
Çme_ÿp
 * (handle_name));

187 
i
;

188 
i
=0;i<
befÜe
;i++) {

189 
n
[
i
] = 
s
->
Çme
[i];

191 
i
=
befÜe
;i<
s
->
Çme_couÁ
;i++) {

192 
n
[
i
+1] = 
s
->
Çme
[i];

194 
	`skyÃt_ä“
(
s
->
Çme
);

195 
s
->
Çme
 = 
n
;

197 
i
;

198 
i
=
s
->
Çme_couÁ
;i>
befÜe
;i--) {

199 
s
->
Çme
[
i
] = s->name[i-1];

202 
s
->
Çme
[
befÜe
].name =‚ame;

203 
s
->
Çme
[
befÜe
].
hªdË
 = handle;

204 
s
->
Çme_couÁ
 ++;

205 
	}
}

208 
	$_š£¹_Çme
(
hªdË_¡Üage
 *
s
, cÚ¡ * 
Çme
, 
ušt32_t
 
hªdË
) {

209 
begš
 = 0;

210 
’d
 = 
s
->
Çme_couÁ
 - 1;

211 
begš
<=
’d
) {

212 
mid
 = (
begš
+
’d
)/2;

213 
hªdË_Çme
 *
n
 = &
s
->
Çme
[
mid
];

214 
c
 = 
	`¡rcmp
(
n
->
Çme
,‚ame);

215 ià(
c
==0) {

216  
NULL
;

218 ià(
c
<0) {

219 
begš
 = 
mid
 + 1;

221 
’d
 = 
mid
 - 1;

224 * 
»suÉ
 = 
	`skyÃt_¡rdup
(
Çme
);

226 
	`_š£¹_Çme_befÜe
(
s
, 
»suÉ
, 
hªdË
, 
begš
);

228  
»suÉ
;

229 
	}
}

232 
	$skyÃt_hªdË_ÇmehªdË
(
ušt32_t
 
hªdË
, cÚ¡ *
Çme
) {

233 
	`rwlock_wlock
(&
H
->
lock
);

235 cÚ¡ * 
»t
 = 
	`_š£¹_Çme
(
H
, 
Çme
, 
hªdË
);

237 
	`rwlock_wuÆock
(&
H
->
lock
);

239  
»t
;

240 
	}
}

243 
	$skyÃt_hªdË_š™
(
h¬bÜ
) {

244 
	`as£¹
(
H
==
NULL
);

245 
hªdË_¡Üage
 * 
s
 = 
	`skyÃt_m®loc
((*
H
));

246 
s
->
¦Ù_size
 = 
DEFAULT_SLOT_SIZE
;

247 
s
->
¦Ù
 = 
	`skyÃt_m®loc
(s->
¦Ù_size
 * (
skyÃt_cÚ‹xt
 *));

248 
	`mem£t
(
s
->
¦Ù
, 0, s->
¦Ù_size
 * (
skyÃt_cÚ‹xt
 *));

250 
	`rwlock_š™
(&
s
->
lock
);

252 
s
->
h¬bÜ
 = (
ušt32_t
è(h¬bÜ & 0xffè<< 
HANDLE_REMOTE_SHIFT
;

253 
s
->
hªdË_šdex
 = 1;

254 
s
->
Çme_ÿp
 = 2;

255 
s
->
Çme_couÁ
 = 0;

256 
s
->
Çme
 = 
	`skyÃt_m®loc
(s->
Çme_ÿp
 * (
hªdË_Çme
));

258 
H
 = 
s
;

261 
	}
}

	@skynet-src/skynet_handle.h

1 #iâdeà
SKYNET_CONTEXT_HANDLE_H


2 
	#SKYNET_CONTEXT_HANDLE_H


	)

4 
	~<¡dšt.h
>

7 
	#HANDLE_MASK
 0xffffff

	)

8 
	#HANDLE_REMOTE_SHIFT
 24

	)

10 
	gskyÃt_cÚ‹xt
;

12 
ušt32_t
 
skyÃt_hªdË_»gi¡”
(
skyÃt_cÚ‹xt
 *);

13 
skyÃt_hªdË_»tœe
(
ušt32_t
 
hªdË
);

14 
skyÃt_cÚ‹xt
 * 
skyÃt_hªdË_g¿b
(
ušt32_t
 
hªdË
);

15 
skyÃt_hªdË_»tœ—Î
();

17 
ušt32_t
 
skyÃt_hªdË_fšdÇme
(cÚ¡ * 
Çme
);

18 cÚ¡ * 
skyÃt_hªdË_ÇmehªdË
(
ušt32_t
 
hªdË
, cÚ¡ *
Çme
);

20 
skyÃt_hªdË_š™
(
h¬bÜ
);

	@skynet-src/skynet_harbor.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_h¬bÜ.h
"

3 
	~"skyÃt_£rv”.h
"

4 
	~"skyÃt_mq.h
"

5 
	~"skyÃt_hªdË.h
"

7 
	~<¡ršg.h
>

8 
	~<¡dio.h
>

9 
	~<as£¹.h
>

11 
skyÃt_cÚ‹xt
 * 
	gREMOTE
 = 0;

12 
	gHARBOR
 = ~0;

15 
	$skyÃt_h¬bÜ_£nd
(
»mÙe_mes§ge
 *
rmsg
, 
ušt32_t
 
sourû
, 
£ssiÚ
) {

16 
ty³
 = 
rmsg
->
sz
 >> 
MESSAGE_TYPE_SHIFT
;

17 
rmsg
->
sz
 &ğ
MESSAGE_TYPE_MASK
;

18 
	`as£¹
(
ty³
 !ğ
PTYPE_SYSTEM
 &&y³ !ğ
PTYPE_HARBOR
 && 
REMOTE
);

19 
	`skyÃt_cÚ‹xt_£nd
(
REMOTE
, 
rmsg
, (*rmsgè, 
sourû
, 
ty³
 , 
£ssiÚ
);

20 
	}
}

23 
	$skyÃt_h¬bÜ_mes§ge_i¤emÙe
(
ušt32_t
 
hªdË
) {

24 
	`as£¹
(
HARBOR
 != ~0);

25 
h
 = (
hªdË
 & ~
HANDLE_MASK
);

26  
h
 !ğ
HARBOR
 && h !=0;

27 
	}
}

30 
	$skyÃt_h¬bÜ_š™
(
h¬bÜ
) {

31 
HARBOR
 = ()
h¬bÜ
 << 
HANDLE_REMOTE_SHIFT
;

32 
	}
}

35 
	$skyÃt_h¬bÜ_¡¬t
(*
ùx
) {

38 
	`skyÃt_cÚ‹xt_»£rve
(
ùx
);

39 
REMOTE
 = 
ùx
;

40 
	}
}

43 
	$skyÃt_h¬bÜ_ex™
() {

44 
skyÃt_cÚ‹xt
 * 
ùx
 = 
REMOTE
;

45 
REMOTE
ğ
NULL
;

46 ià(
ùx
) {

47 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

49 
	}
}

	@skynet-src/skynet_harbor.h

1 #iâdeà
SKYNET_HARBOR_H


2 
	#SKYNET_HARBOR_H


	)

4 
	~<¡dšt.h
>

5 
	~<¡dlib.h
>

7 
	#GLOBALNAME_LENGTH
 16

	)

8 
	#REMOTE_MAX
 256

	)

10 
	s»mÙe_Çme
 {

11 
	mÇme
[
GLOBALNAME_LENGTH
];

12 
ušt32_t
 
	mhªdË
;

15 
	s»mÙe_mes§ge
 {

16 
»mÙe_Çme
 
	mde¡š©iÚ
;

17 cÚ¡ * 
	mmes§ge
;

18 
size_t
 
	msz
;

21 
skyÃt_h¬bÜ_£nd
(
»mÙe_mes§ge
 *
rmsg
, 
ušt32_t
 
sourû
, 
£ssiÚ
);

22 
skyÃt_h¬bÜ_mes§ge_i¤emÙe
(
ušt32_t
 
hªdË
);

23 
skyÃt_h¬bÜ_š™
(
h¬bÜ
);

24 
skyÃt_h¬bÜ_¡¬t
(* 
ùx
);

25 
skyÃt_h¬bÜ_ex™
();

	@skynet-src/skynet_imp.h

1 #iâdeà
SKYNET_IMP_H


2 
	#SKYNET_IMP_H


	)

4 
	sskyÃt_cÚfig
 {

5 
	mth»ad
;

6 
	mh¬bÜ
;

7 
	m´ofe
;

8 cÚ¡ * 
	md«mÚ
;

9 cÚ¡ * 
	mmoduË_·th
;

10 cÚ¡ * 
	mboÙ¡¿p
;

11 cÚ¡ * 
	mlogg”
;

12 cÚ¡ * 
	mlog£rviû
;

15 
	#THREAD_WORKER
 0

	)

16 
	#THREAD_MAIN
 1

	)

17 
	#THREAD_SOCKET
 2

	)

18 
	#THREAD_TIMER
 3

	)

19 
	#THREAD_MONITOR
 4

	)

21 
skyÃt_¡¬t
(
skyÃt_cÚfig
 * 
cÚfig
);

	@skynet-src/skynet_log.c

1 
	~"skyÃt_log.h
"

2 
	~"skyÃt_tim”.h
"

3 
	~"skyÃt.h
"

4 
	~"skyÃt_sock‘.h
"

5 
	~<¡ršg.h
>

6 
	~<time.h
>

8 
FILE
 *

9 
	$skyÃt_log_İ’
(
skyÃt_cÚ‹xt
 * 
ùx
, 
ušt32_t
 
hªdË
) {

10 cÚ¡ * 
log·th
 = 
	`skyÃt_g‘’v
("logpath");

11 ià(
log·th
 =ğ
NULL
)

12  
NULL
;

13 
size_t
 
sz
 = 
	`¡¾’
(
log·th
);

14 
tmp
[
sz
 + 16];

15 
	`¥rštf
(
tmp
, "%s/%08x.log", 
log·th
, 
hªdË
);

16 
FILE
 *
f
 = 
	`fİ’
(
tmp
, "ab");

17 ià(
f
) {

18 
ušt32_t
 
¡¬‰ime
 = 
	`skyÃt_¡¬‰ime
();

19 
ušt64_t
 
cu¼’‰ime
 = 
	`skyÃt_now
();

20 
time_t
 
ti
 = 
¡¬‰ime
 + 
cu¼’‰ime
/100;

21 
	`skyÃt_”rÜ
(
ùx
, "O³Àlog f%s", 
tmp
);

22 
	`årštf
(
f
, "İ’ime: %u %s", (
ušt32_t
)
cu¼’‰ime
, 
	`ùime
(&
ti
));

23 
	`fæush
(
f
);

25 
	`skyÃt_”rÜ
(
ùx
, "O³Àlog f% ç", 
tmp
);

27  
f
;

28 
	}
}

31 
	$skyÃt_log_şo£
(
skyÃt_cÚ‹xt
 * 
ùx
, 
FILE
 *
f
, 
ušt32_t
 
hªdË
) {

32 
	`skyÃt_”rÜ
(
ùx
, "Clo£†og f:%08x", 
hªdË
);

33 
	`årštf
(
f
, "şo£ime: %u\n", (
ušt32_t
)
	`skyÃt_now
());

34 
	`fşo£
(
f
);

35 
	}
}

38 
	$log_blob
(
FILE
 *
f
, * 
bufãr
, 
size_t
 
sz
) {

39 
size_t
 
i
;

40 
ušt8_t
 * 
buf
 = 
bufãr
;

41 
i
=0;i!=
sz
;i++) {

42 
	`årštf
(
f
, "%02x", 
buf
[
i
]);

44 
	}
}

47 
	$log_sock‘
(
FILE
 * 
f
, 
skyÃt_sock‘_mes§ge
 * 
mes§ge
, 
size_t
 
sz
) {

48 
	`årštf
(
f
, "[sock‘] %d %d %d ", 
mes§ge
->
ty³
, mes§ge->
id
, mes§ge->
ud
);

50 ià(
mes§ge
->
bufãr
 =ğ
NULL
) {

51 cÚ¡ *
bufãr
 = (cÚ¡ *)(
mes§ge
 + 1);

52 
sz
 -ğ(*
mes§ge
);

53 cÚ¡ * 
eŞ
 = 
	`memchr
(
bufãr
, '\0', 
sz
);

54 ià(
eŞ
) {

55 
sz
 = 
eŞ
 - 
bufãr
;

57 
	`årštf
(
f
, "[%*s]", ()
sz
, (cÚ¡ *)
bufãr
);

59 
sz
 = 
mes§ge
->
ud
;

60 
	`log_blob
(
f
, 
mes§ge
->
bufãr
, 
sz
);

62 
	`årštf
(
f
, "\n");

63 
	`fæush
(
f
);

64 
	}
}

67 
	$skyÃt_log_ouut
(
FILE
 *
f
, 
ušt32_t
 
sourû
, 
ty³
, 
£ssiÚ
, * 
bufãr
, 
size_t
 
sz
) {

68 ià(
ty³
 =ğ
PTYPE_SOCKET
) {

69 
	`log_sock‘
(
f
, 
bufãr
, 
sz
);

71 
ušt32_t
 
ti
 = (ušt32_t)
	`skyÃt_now
();

72 
	`årštf
(
f
, ":%08x %d %d %u ", 
sourû
, 
ty³
, 
£ssiÚ
, 
ti
);

73 
	`log_blob
(
f
, 
bufãr
, 
sz
);

74 
	`årštf
(
f
,"\n");

75 
	`fæush
(
f
);

77 
	}
}

	@skynet-src/skynet_log.h

1 #iâdeà
skyÃt_log_h


2 
	#skyÃt_log_h


	)

4 
	~"skyÃt_’v.h
"

5 
	~"skyÃt.h
"

7 
	~<¡dio.h
>

8 
	~<¡dšt.h
>

10 
FILE
 * 
skyÃt_log_İ’
(
skyÃt_cÚ‹xt
 * 
ùx
, 
ušt32_t
 
hªdË
);

11 
skyÃt_log_şo£
(
skyÃt_cÚ‹xt
 * 
ùx
, 
FILE
 *
f
, 
ušt32_t
 
hªdË
);

12 
skyÃt_log_ouut
(
FILE
 *
f
, 
ušt32_t
 
sourû
, 
ty³
, 
£ssiÚ
, * 
bufãr
, 
size_t
 
sz
);

	@skynet-src/skynet_main.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_imp.h
"

4 
	~"skyÃt_’v.h
"

5 
	~"skyÃt_£rv”.h
"

6 
	~"luash¹bl.h
"

8 
	~<¡dio.h
>

9 
	~<¡dlib.h
>

10 
	~<¡ršg.h
>

11 
	~<lua.h
>

12 
	~<lu®ib.h
>

13 
	~<Ïuxlib.h
>

14 
	~<sigÇl.h
>

15 
	~<as£¹.h
>

18 
	$İtšt
(cÚ¡ *
key
, 
İt
) {

19 cÚ¡ * 
¡r
 = 
	`skyÃt_g‘’v
(
key
);

20 ià(
¡r
 =ğ
NULL
) {

21 
tmp
[20];

22 
	`¥rštf
(
tmp
,"%d",
İt
);

23 
	`skyÃt_£‹nv
(
key
, 
tmp
);

24  
İt
;

26  
	`¡¹Ş
(
¡r
, 
NULL
, 10);

27 
	}
}

30 
	$İtboŞ—n
(cÚ¡ *
key
, 
İt
) {

31 cÚ¡ * 
¡r
 = 
	`skyÃt_g‘’v
(
key
);

32 ià(
¡r
 =ğ
NULL
) {

33 
	`skyÃt_£‹nv
(
key
, 
İt
 ? "true" : "false");

34  
İt
;

36  
	`¡rcmp
(
¡r
,"true")==0;

37 
	}
}

40 
	$İt¡ršg
(cÚ¡ *
key
,cÚ¡ * 
İt
) {

41 cÚ¡ * 
¡r
 = 
	`skyÃt_g‘’v
(
key
);

42 ià(
¡r
 =ğ
NULL
) {

43 ià(
İt
) {

44 
	`skyÃt_£‹nv
(
key
, 
İt
);

45 
İt
 = 
	`skyÃt_g‘’v
(
key
);

47  
İt
;

49  
¡r
;

50 
	}
}

53 
	$_š™_’v
(
lua_S‹
 *
L
) {

54 
	`lua_pushn
(
L
);

55 
	`lua_Ãxt
(
L
, -2) != 0) {

56 
keyt
 = 
	`lua_ty³
(
L
, -2);

57 ià(
keyt
 !ğ
LUA_TSTRING
) {

58 
	`årštf
(
¡d”r
, "Invalid configable\n");

59 
	`ex™
(1);

61 cÚ¡ * 
key
 = 
	`lua_to¡ršg
(
L
,-2);

62 ià(
	`lua_ty³
(
L
,-1è=ğ
LUA_TBOOLEAN
) {

63 
b
 = 
	`lua_toboŞ—n
(
L
,-1);

64 
	`skyÃt_£‹nv
(
key
,
b
 ? "true" : "false" );

66 cÚ¡ * 
v®ue
 = 
	`lua_to¡ršg
(
L
,-1);

67 ià(
v®ue
 =ğ
NULL
) {

68 
	`årštf
(
¡d”r
, "Inv®id cÚfigabË key = %s\n", 
key
);

69 
	`ex™
(1);

71 
	`skyÃt_£‹nv
(
key
,
v®ue
);

73 
	`lua_pİ
(
L
,1);

75 
	`lua_pİ
(
L
,1);

76 
	}
}

78 
	$sigign
() {

79 
sigaùiÚ
 
§
;

80 
§
.
§_hªdËr
 = 
SIG_IGN
;

81 
	`sigaùiÚ
(
SIGPIPE
, &
§
, 0);

83 
	}
}

85 cÚ¡ * 
	glßd_cÚfig
 = "\
„esult = {}\n\
 function getenv(name)„eturn‡ssert(os.getenv(name), [[os.getenv() failed: ]] ..‚ame)ƒnd\n\
 sep =…ackage.config:sub(1,1)\n\
 current_path = [[.]]..sep\n\
 function include(filename)\n\
†ast_path = current_path\n\
…ath,‚ame = filename:match([[(.*]]..sep..[[)(.*)$]])\n\
…athhen\n\
…ath:sub(1,1) == sephen --„oot\n\
_path =…ath\n\
\n\
_path = current_path ..…ath\n\
\n\
\n\
 = filename\n\
\n\
 f =‡ssert(io.open(current_path ..‚ame))\n\
 code =‡ssert(f:read [[*a]])\n\
 = string.gsub(code, [[%$([%w_%d]+)]], getenv)\n\
:close()\n\
(load(code,[[@]]..filename,[[t]],result))()\n\
_path =†ast_path\n\
\n\
(result, { __index = { include = include } })\n\
 config_name = ...\n\
(config_name)\n\
(result,‚il)\n\
„esult\n\
";

117 
	$maš
(
¬gc
, *
¬gv
[]) {

118 cÚ¡ * 
cÚfig_fe
 = 
NULL
 ;

119 ià(
¬gc
 > 1) {

120 
cÚfig_fe
 = 
¬gv
[1];

122 
	`årštf
(
¡d”r
, "Need‡ config file. Please„ead skynet wiki : https://github.com/cloudwu/skynet/wiki/Config\n"

127 
	`luaS_š™shr
();

128 
	`skyÃt_glob®š™
();

129 
	`skyÃt_’v_š™
();

131 
	`sigign
();

133 
skyÃt_cÚfig
 
cÚfig
;

135 
lua_S‹
 *
L
 = 
	`luaL_Ãw¡©e
();

136 
	`luaL_İ’libs
(
L
);

138 
”r
 = 
	`luaL_lßdbufãrx
(
L
, 
lßd_cÚfig
, 
	`¡¾’
(load_config), "=[skynet config]", "t");

139 
	`as£¹
(
”r
 =ğ
LUA_OK
);

140 
	`lua_push¡ršg
(
L
, 
cÚfig_fe
);

142 
”r
 = 
	`lua_pÿÎ
(
L
, 1, 1, 0);

143 ià(
”r
) {

144 
	`årštf
(
¡d”r
,"%s\n",
	`lua_to¡ršg
(
L
,-1));

145 
	`lua_şo£
(
L
);

148 
	`_š™_’v
(
L
);

150 
cÚfig
.
th»ad
 = 
	`İtšt
("thread",8);

151 
cÚfig
.
moduË_·th
 = 
	`İt¡ršg
("cpath","./cservice/?.so");

152 
cÚfig
.
h¬bÜ
 = 
	`İtšt
("harbor", 1);

153 
cÚfig
.
boÙ¡¿p
 = 
	`İt¡ršg
("bootstrap","snlua bootstrap");

154 
cÚfig
.
d«mÚ
 = 
	`İt¡ršg
("d«mÚ", 
NULL
);

155 
cÚfig
.
logg”
 = 
	`İt¡ršg
("logg”", 
NULL
);

156 
cÚfig
.
log£rviû
 = 
	`İt¡ršg
("logservice", "logger");

157 
cÚfig
.
´ofe
 = 
	`İtboŞ—n
("profile", 1);

159 
	`lua_şo£
(
L
);

161 
	`skyÃt_¡¬t
(&
cÚfig
);

162 
	`skyÃt_glob®ex™
();

163 
	`luaS_ex™shr
();

166 
	}
}

	@skynet-src/skynet_malloc.h

1 #iâdeà
skyÃt_m®loc_h


2 
	#skyÃt_m®loc_h


	)

4 
	~<¡ddef.h
>

6 
	#skyÃt_m®loc
 
m®loc


	)

7 
	#skyÃt_ÿÎoc
 
ÿÎoc


	)

8 
	#skyÃt_»®loc
 
»®loc


	)

9 
	#skyÃt_ä“
 
ä“


	)

10 
	#skyÃt_mem®ign
 
mem®ign


	)

12 * 
skyÃt_m®loc
(
size_t
 
sz
);

13 * 
skyÃt_ÿÎoc
(
size_t
 
nmemb
,size_ˆ
size
);

14 * 
skyÃt_»®loc
(*
±r
, 
size_t
 
size
);

15 
skyÃt_ä“
(*
±r
);

16 * 
skyÃt_¡rdup
(cÚ¡ *
¡r
);

17 * 
skyÃt_ÏÎoc
(*
±r
, 
size_t
 
osize
, size_ˆ
nsize
);

18 * 
skyÃt_mem®ign
(
size_t
 
®ignm’t
, size_ˆ
size
);

	@skynet-src/skynet_module.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_moduË.h
"

4 
	~"¥šlock.h
"

6 
	~<as£¹.h
>

7 
	~<¡ršg.h
>

8 
	~<dlfú.h
>

9 
	~<¡dlib.h
>

10 
	~<¡dšt.h
>

11 
	~<¡dio.h
>

13 
	#MAX_MODULE_TYPE
 32

	)

15 
	smoduËs
 {

16 
	mcouÁ
;

17 
¥šlock
 
	mlock
;

18 cÚ¡ * 
	m·th
;

19 
skyÃt_moduË
 
	mm
[
MAX_MODULE_TYPE
];

22 
moduËs
 * 
	gM
 = 
NULL
;

25 
	$_Œy_İ’
(
moduËs
 *
m
, cÚ¡ * 
Çme
) {

26 cÚ¡ *
l
;

27 cÚ¡ * 
·th
 = 
m
->path;

28 
size_t
 
·th_size
 = 
	`¡¾’
(
·th
);

29 
size_t
 
Çme_size
 = 
	`¡¾’
(
Çme
);

31 
sz
 = 
·th_size
 + 
Çme_size
;

33 * 
dl
 = 
NULL
;

34 
tmp
[
sz
];

37 
	`mem£t
(
tmp
,0,
sz
);

38 *
·th
 == ';')…ath++;

39 ià(*
·th
 == '\0') ;

40 
l
 = 
	`¡rchr
(
·th
, ';');

41 ià(
l
 =ğ
NULL
èÈğ
·th
 + 
	`¡¾’
(path);

42 
Ën
 = 
l
 - 
·th
;

43 
i
;

44 
i
=0;
·th
[i]!='?' && i < 
Ën
 ;i++) {

45 
tmp
[
i
] = 
·th
[i];

47 
	`memıy
(
tmp
+
i
,
Çme
,
Çme_size
);

48 ià(
·th
[
i
] == '?') {

49 
	`¡ºıy
(
tmp
+
i
+
Çme_size
,
·th
+i+1,
Ën
 - i - 1);

51 
	`årštf
(
¡d”r
,"Invalid C service…ath\n");

52 
	`ex™
(1);

54 
dl
 = 
	`dlİ’
(
tmp
, 
RTLD_NOW
 | 
RTLD_GLOBAL
);

55 
·th
 = 
l
;

56 }
dl
 =ğ
NULL
);

58 ià(
dl
 =ğ
NULL
) {

59 
	`årštf
(
¡d”r
, "Œy o³À% çed : %s\n",
Çme
,
	`dË¼Ü
());

62  
dl
;

63 
	}
}

65 
skyÃt_moduË
 *

66 
	$_qu”y
(cÚ¡ * 
Çme
) {

67 
i
;

68 
i
=0;i<
M
->
couÁ
;i++) {

69 ià(
	`¡rcmp
(
M
->
m
[
i
].
Çme
,name)==0) {

70  &
M
->
m
[
i
];

73  
NULL
;

74 
	}
}

77 
	$g‘_­i
(
skyÃt_moduË
 *
mod
, cÚ¡ *
­i_Çme
) {

78 
size_t
 
Çme_size
 = 
	`¡¾’
(
mod
->
Çme
);

79 
size_t
 
­i_size
 = 
	`¡¾’
(
­i_Çme
);

80 
tmp
[
Çme_size
 + 
­i_size
 + 1];

81 
	`memıy
(
tmp
, 
mod
->
Çme
, 
Çme_size
);

82 
	`memıy
(
tmp
+
Çme_size
, 
­i_Çme
, 
­i_size
+1);

83 *
±r
 = 
	`¡¼chr
(
tmp
, '.');

84 ià(
±r
 =ğ
NULL
) {

85 
±r
 = 
tmp
;

87 
±r
 =…tr + 1;

89  
	`dlsym
(
mod
->
moduË
, 
±r
);

90 
	}
}

93 
	$İ’_sym
(
skyÃt_moduË
 *
mod
) {

94 
mod
->
ü—‹
 = 
	`g‘_­i
(mod, "_create");

95 
mod
->
š™
 = 
	`g‘_­i
(mod, "_init");

96 
mod
->
»Ëa£
 = 
	`g‘_­i
(mod, "_release");

97 
mod
->
sigÇl
 = 
	`g‘_­i
(mod, "_signal");

99  
mod
->
š™
 =ğ
NULL
;

100 
	}
}

102 
skyÃt_moduË
 *

103 
	$skyÃt_moduË_qu”y
(cÚ¡ * 
Çme
) {

104 
skyÃt_moduË
 * 
»suÉ
 = 
	`_qu”y
(
Çme
);

105 ià(
»suÉ
)

106  
»suÉ
;

108 
	`SPIN_LOCK
(
M
)

110 
»suÉ
 = 
	`_qu”y
(
Çme
);

112 ià(
»suÉ
 =ğ
NULL
 && 
M
->
couÁ
 < 
MAX_MODULE_TYPE
) {

113 
šdex
 = 
M
->
couÁ
;

114 * 
dl
 = 
	`_Œy_İ’
(
M
,
Çme
);

115 ià(
dl
) {

116 
M
->
m
[
šdex
].
Çme
 =‚ame;

117 
M
->
m
[
šdex
].
moduË
 = 
dl
;

119 ià(
	`İ’_sym
(&
M
->
m
[
šdex
]) == 0) {

120 
M
->
m
[
šdex
].
Çme
 = 
	`skyÃt_¡rdup
(name);

121 
M
->
couÁ
 ++;

122 
»suÉ
 = &
M
->
m
[
šdex
];

127 
	`SPIN_UNLOCK
(
M
)

129  
»suÉ
;

130 
	}
}

133 
	$skyÃt_moduË_š£¹
(
skyÃt_moduË
 *
mod
) {

134 
	`SPIN_LOCK
(
M
)

136 
skyÃt_moduË
 * 
m
 = 
	`_qu”y
(
mod
->
Çme
);

137 
	`as£¹
(
m
 =ğ
NULL
 && 
M
->
couÁ
 < 
MAX_MODULE_TYPE
);

138 
šdex
 = 
M
->
couÁ
;

139 
M
->
m
[
šdex
] = *
mod
;

140 ++
M
->
couÁ
;

142 
	`SPIN_UNLOCK
(
M
)

143 
	}
}

146 
	$skyÃt_moduË_š¡ªû_ü—‹
(
skyÃt_moduË
 *
m
) {

147 ià(
m
->
ü—‹
) {

148  
m
->
	`ü—‹
();

150  (*)(
šŒ_t
)(~0);

152 
	}
}

155 
	$skyÃt_moduË_š¡ªû_š™
(
skyÃt_moduË
 *
m
, * 
š¡
, 
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
·rm
) {

156  
m
->
	`š™
(
š¡
, 
ùx
, 
·rm
);

157 
	}
}

160 
	$skyÃt_moduË_š¡ªû_»Ëa£
(
skyÃt_moduË
 *
m
, *
š¡
) {

161 ià(
m
->
»Ëa£
) {

162 
m
->
	`»Ëa£
(
š¡
);

164 
	}
}

167 
	$skyÃt_moduË_š¡ªû_sigÇl
(
skyÃt_moduË
 *
m
, *
š¡
, 
sigÇl
) {

168 ià(
m
->
sigÇl
) {

169 
m
->
	`sigÇl
(
š¡
, 
sigÇl
);

171 
	}
}

174 
	$skyÃt_moduË_š™
(cÚ¡ *
·th
) {

175 
moduËs
 *
m
 = 
	`skyÃt_m®loc
((*m));

176 
m
->
couÁ
 = 0;

177 
m
->
·th
 = 
	`skyÃt_¡rdup
(path);

179 
	`SPIN_INIT
(
m
)

181 
M
 = 
m
;

182 
	}
}

	@skynet-src/skynet_module.h

1 #iâdeà
SKYNET_MODULE_H


2 
	#SKYNET_MODULE_H


	)

4 
	gskyÃt_cÚ‹xt
;

6 * (*
	tskyÃt_dl_ü—‹
)();

7 (*
	tskyÃt_dl_š™
)(* 
	tš¡
, 
	tskyÃt_cÚ‹xt
 *, cÚ¡ * 
	t·rm
);

8 (*
	tskyÃt_dl_»Ëa£
)(* 
	tš¡
);

9 (*
	tskyÃt_dl_sigÇl
)(* 
	tš¡
, 
	tsigÇl
);

11 
	sskyÃt_moduË
 {

12 cÚ¡ * 
Çme
;

13 * 
moduË
;

14 
skyÃt_dl_ü—‹
 
ü—‹
;

15 
skyÃt_dl_š™
 
š™
;

16 
skyÃt_dl_»Ëa£
 
»Ëa£
;

17 
skyÃt_dl_sigÇl
 
sigÇl
;

20 
	`skyÃt_moduË_š£¹
(
skyÃt_moduË
 *
mod
);

21 
skyÃt_moduË
 * 
	`skyÃt_moduË_qu”y
(cÚ¡ * 
Çme
);

22 * 
	`skyÃt_moduË_š¡ªû_ü—‹
(
skyÃt_moduË
 *);

23 
	`skyÃt_moduË_š¡ªû_š™
(
skyÃt_moduË
 *, * 
š¡
, 
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
·rm
);

24 
	`skyÃt_moduË_š¡ªû_»Ëa£
(
skyÃt_moduË
 *, *
š¡
);

25 
	`skyÃt_moduË_š¡ªû_sigÇl
(
skyÃt_moduË
 *, *
š¡
, 
sigÇl
);

27 
	`skyÃt_moduË_š™
(cÚ¡ *
·th
);

	@skynet-src/skynet_monitor.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_mÚ™Ü.h
"

4 
	~"skyÃt_£rv”.h
"

5 
	~"skyÃt.h
"

6 
	~"©omic.h
"

8 
	~<¡dlib.h
>

9 
	~<¡ršg.h
>

11 
	sskyÃt_mÚ™Ü
 {

12 
	mv”siÚ
;

13 
	mcheck_v”siÚ
;

14 
ušt32_t
 
	msourû
;

15 
ušt32_t
 
	mde¡š©iÚ
;

18 
skyÃt_mÚ™Ü
 *

19 
	$skyÃt_mÚ™Ü_Ãw
() {

20 
skyÃt_mÚ™Ü
 * 
»t
 = 
	`skyÃt_m®loc
((*ret));

21 
	`mem£t
(
»t
, 0, (*ret));

22  
»t
;

23 
	}
}

26 
	$skyÃt_mÚ™Ü_d–‘e
(
skyÃt_mÚ™Ü
 *
sm
) {

27 
	`skyÃt_ä“
(
sm
);

28 
	}
}

31 
	$skyÃt_mÚ™Ü_Œigg”
(
skyÃt_mÚ™Ü
 *
sm
, 
ušt32_t
 
sourû
, ušt32_ˆ
de¡š©iÚ
) {

32 
sm
->
sourû
 = source;

33 
sm
->
de¡š©iÚ
 = destination;

34 
	`ATOM_INC
(&
sm
->
v”siÚ
);

35 
	}
}

38 
	$skyÃt_mÚ™Ü_check
(
skyÃt_mÚ™Ü
 *
sm
) {

39 ià(
sm
->
v”siÚ
 =ğsm->
check_v”siÚ
) {

40 ià(
sm
->
de¡š©iÚ
) {

41 
	`skyÃt_cÚ‹xt_’dËss
(
sm
->
de¡š©iÚ
);

42 
	`skyÃt_”rÜ
(
NULL
, "A mes§gäom [ :%08x ]Ø[ :%08x ] maybš‡À’dËs loİ (v”siÚ = %d)", 
sm
->
sourû
 , sm->
de¡š©iÚ
, sm->
v”siÚ
);

45 
sm
->
check_v”siÚ
 = sm->
v”siÚ
;

47 
	}
}

	@skynet-src/skynet_monitor.h

1 #iâdeà
SKYNET_MONITOR_H


2 
	#SKYNET_MONITOR_H


	)

4 
	~<¡dšt.h
>

6 
	gskyÃt_mÚ™Ü
;

8 
skyÃt_mÚ™Ü
 * 
skyÃt_mÚ™Ü_Ãw
();

9 
skyÃt_mÚ™Ü_d–‘e
(
skyÃt_mÚ™Ü
 *);

10 
skyÃt_mÚ™Ü_Œigg”
(
skyÃt_mÚ™Ü
 *, 
ušt32_t
 
sourû
, ušt32_ˆ
de¡š©iÚ
);

11 
skyÃt_mÚ™Ü_check
(
skyÃt_mÚ™Ü
 *);

	@skynet-src/skynet_mq.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_mq.h
"

3 
	~"skyÃt_hªdË.h
"

4 
	~"¥šlock.h
"

6 
	~<¡dio.h
>

7 
	~<¡dlib.h
>

8 
	~<¡ršg.h
>

9 
	~<as£¹.h
>

10 
	~<¡dboŞ.h
>

12 
	#DEFAULT_QUEUE_SIZE
 64

	)

13 
	#MAX_GLOBAL_MQ
 0x10000

	)

18 
	#MQ_IN_GLOBAL
 1

	)

19 
	#MQ_OVERLOAD
 1024

	)

21 
	smes§ge_queue
 {

22 
¥šlock
 
	mlock
;

23 
ušt32_t
 
	mhªdË
;

24 
	mÿp
;

25 
	mh—d
;

26 
	m
;

27 
	m»Ëa£
;

28 
	mš_glob®
;

29 
	mov”lßd
;

30 
	mov”lßd_th»shŞd
;

31 
skyÃt_mes§ge
 *
	mqueue
;

32 
mes§ge_queue
 *
	mÃxt
;

35 
	sglob®_queue
 {

36 
mes§ge_queue
 *
	mh—d
;

37 
mes§ge_queue
 *
	m
;

38 
¥šlock
 
	mlock
;

41 
glob®_queue
 *
	gQ
 = 
NULL
;

44 
	$skyÃt_glob®mq_push
(
mes§ge_queue
 * 
queue
) {

45 
glob®_queue
 *
q
ğ
Q
;

47 
	`SPIN_LOCK
(
q
)

48 
	`as£¹
(
queue
->
Ãxt
 =ğ
NULL
);

49 if(
q
->

) {

50 
q
->

->
Ãxt
 = 
queue
;

51 
q
->

 = 
queue
;

53 
q
->
h—d
 = q->

 = 
queue
;

55 
	`SPIN_UNLOCK
(
q
)

56 
	}
}

58 
mes§ge_queue
 *

59 
	$skyÃt_glob®mq_pİ
() {

60 
glob®_queue
 *
q
 = 
Q
;

62 
	`SPIN_LOCK
(
q
)

63 
mes§ge_queue
 *
mq
 = 
q
->
h—d
;

64 if(
mq
) {

65 
q
->
h—d
 = 
mq
->
Ãxt
;

66 if(
q
->
h—d
 =ğ
NULL
) {

67 
	`as£¹
(
mq
 =ğ
q
->

);

68 
q
->

 = 
NULL
;

70 
mq
->
Ãxt
 = 
NULL
;

72 
	`SPIN_UNLOCK
(
q
)

74  
mq
;

75 
	}
}

77 
mes§ge_queue
 *

78 
	$skyÃt_mq_ü—‹
(
ušt32_t
 
hªdË
) {

79 
mes§ge_queue
 *
q
 = 
	`skyÃt_m®loc
((*q));

80 
q
->
hªdË
 = handle;

81 
q
->
ÿp
 = 
DEFAULT_QUEUE_SIZE
;

82 
q
->
h—d
 = 0;

83 
q
->

 = 0;

84 
	`SPIN_INIT
(
q
)

88 
q
->
š_glob®
 = 
MQ_IN_GLOBAL
;

89 
q
->
»Ëa£
 = 0;

90 
q
->
ov”lßd
 = 0;

91 
q
->
ov”lßd_th»shŞd
 = 
MQ_OVERLOAD
;

92 
q
->
queue
 = 
	`skyÃt_m®loc
((
skyÃt_mes§ge
è* q->
ÿp
);

93 
q
->
Ãxt
 = 
NULL
;

95  
q
;

96 
	}
}

99 
	$_»Ëa£
(
mes§ge_queue
 *
q
) {

100 
	`as£¹
(
q
->
Ãxt
 =ğ
NULL
);

101 
	`SPIN_DESTROY
(
q
)

102 
	`skyÃt_ä“
(
q
->
queue
);

103 
	`skyÃt_ä“
(
q
);

104 
	}
}

106 
ušt32_t


107 
	$skyÃt_mq_hªdË
(
mes§ge_queue
 *
q
) {

108  
q
->
hªdË
;

109 
	}
}

112 
	$skyÃt_mq_Ëngth
(
mes§ge_queue
 *
q
) {

113 
h—d
, 

,
ÿp
;

115 
	`SPIN_LOCK
(
q
)

116 
h—d
 = 
q
->head;

117 

 = 
q
->tail;

118 
ÿp
 = 
q
->cap;

119 
	`SPIN_UNLOCK
(
q
)

121 ià(
h—d
 <ğ

) {

122  

 - 
h—d
;

124  

 + 
ÿp
 - 
h—d
;

125 
	}
}

128 
	$skyÃt_mq_ov”lßd
(
mes§ge_queue
 *
q
) {

129 ià(
q
->
ov”lßd
) {

130 
ov”lßd
 = 
q
->overload;

131 
q
->
ov”lßd
 = 0;

132  
ov”lßd
;

135 
	}
}

138 
	$skyÃt_mq_pİ
(
mes§ge_queue
 *
q
, 
skyÃt_mes§ge
 *
mes§ge
) {

139 
»t
 = 1;

140 
	`SPIN_LOCK
(
q
)

142 ià(
q
->
h—d
 !ğq->

) {

143 *
mes§ge
 = 
q
->
queue
[q->
h—d
++];

144 
»t
 = 0;

145 
h—d
 = 
q
->head;

146 

 = 
q
->tail;

147 
ÿp
 = 
q
->cap;

149 ià(
h—d
 >ğ
ÿp
) {

150 
q
->
h—d
 = head = 0;

152 
Ëngth
 = 

 - 
h—d
;

153 ià(
Ëngth
 < 0) {

154 
Ëngth
 +ğ
ÿp
;

156 
Ëngth
 > 
q
->
ov”lßd_th»shŞd
) {

157 
q
->
ov”lßd
 = 
Ëngth
;

158 
q
->
ov”lßd_th»shŞd
 *= 2;

162 
q
->
ov”lßd_th»shŞd
 = 
MQ_OVERLOAD
;

165 ià(
»t
) {

166 
q
->
š_glob®
 = 0;

169 
	`SPIN_UNLOCK
(
q
)

171  
»t
;

172 
	}
}

175 
	$ex·nd_queue
(
mes§ge_queue
 *
q
) {

176 
skyÃt_mes§ge
 *
Ãw_queue
 = 
	`skyÃt_m®loc
((skyÃt_mes§geè* 
q
->
ÿp
 * 2);

177 
i
;

178 
i
=0;i<
q
->
ÿp
;i++) {

179 
Ãw_queue
[
i
] = 
q
->
queue
[(q->
h—d
 + iè% q->
ÿp
];

181 
q
->
h—d
 = 0;

182 
q
->

 = q->
ÿp
;

183 
q
->
ÿp
 *= 2;

185 
	`skyÃt_ä“
(
q
->
queue
);

186 
q
->
queue
 = 
Ãw_queue
;

187 
	}
}

190 
	$skyÃt_mq_push
(
mes§ge_queue
 *
q
, 
skyÃt_mes§ge
 *
mes§ge
) {

191 
	`as£¹
(
mes§ge
);

192 
	`SPIN_LOCK
(
q
)

194 
q
->
queue
[q->

] = *
mes§ge
;

195 ià(++ 
q
->

 >ğq->
ÿp
) {

196 
q
->

 = 0;

199 ià(
q
->
h—d
 =ğq->

) {

200 
	`ex·nd_queue
(
q
);

203 ià(
q
->
š_glob®
 == 0) {

204 
q
->
š_glob®
 = 
MQ_IN_GLOBAL
;

205 
	`skyÃt_glob®mq_push
(
q
);

208 
	`SPIN_UNLOCK
(
q
)

209 
	}
}

212 
	$skyÃt_mq_š™
() {

213 
glob®_queue
 *
q
 = 
	`skyÃt_m®loc
((*q));

214 
	`mem£t
(
q
,0,(*q));

215 
	`SPIN_INIT
(
q
);

216 
Q
=
q
;

217 
	}
}

220 
	$skyÃt_mq_m¬k_»Ëa£
(
mes§ge_queue
 *
q
) {

221 
	`SPIN_LOCK
(
q
)

222 
	`as£¹
(
q
->
»Ëa£
 == 0);

223 
q
->
»Ëa£
 = 1;

224 ià(
q
->
š_glob®
 !ğ
MQ_IN_GLOBAL
) {

225 
	`skyÃt_glob®mq_push
(
q
);

227 
	`SPIN_UNLOCK
(
q
)

228 
	}
}

231 
	$_drİ_queue
(
mes§ge_queue
 *
q
, 
mes§ge_drİ
 
drİ_func
, *
ud
) {

232 
skyÃt_mes§ge
 
msg
;

233 !
	`skyÃt_mq_pİ
(
q
, &
msg
)) {

234 
	`drİ_func
(&
msg
, 
ud
);

236 
	`_»Ëa£
(
q
);

237 
	}
}

240 
	$skyÃt_mq_»Ëa£
(
mes§ge_queue
 *
q
, 
mes§ge_drİ
 
drİ_func
, *
ud
) {

241 
	`SPIN_LOCK
(
q
)

243 ià(
q
->
»Ëa£
) {

244 
	`SPIN_UNLOCK
(
q
)

245 
	`_drİ_queue
(
q
, 
drİ_func
, 
ud
);

247 
	`skyÃt_glob®mq_push
(
q
);

248 
	`SPIN_UNLOCK
(
q
)

250 
	}
}

	@skynet-src/skynet_mq.h

1 #iâdeà
SKYNET_MESSAGE_QUEUE_H


2 
	#SKYNET_MESSAGE_QUEUE_H


	)

4 
	~<¡dlib.h
>

5 
	~<¡dšt.h
>

7 
	sskyÃt_mes§ge
 {

8 
ušt32_t
 
	msourû
;

9 
	m£ssiÚ
;

10 * 
	md©a
;

11 
size_t
 
	msz
;

15 
	#MESSAGE_TYPE_MASK
 (
SIZE_MAX
 >> 8)

	)

16 
	#MESSAGE_TYPE_SHIFT
 (((
size_t
)-1è* 8)

	)

18 
	gmes§ge_queue
;

20 
skyÃt_glob®mq_push
(
mes§ge_queue
 * 
queue
);

21 
mes§ge_queue
 * 
skyÃt_glob®mq_pİ
();

23 
mes§ge_queue
 * 
skyÃt_mq_ü—‹
(
ušt32_t
 
hªdË
);

24 
skyÃt_mq_m¬k_»Ëa£
(
mes§ge_queue
 *
q
);

26 (*
	tmes§ge_drİ
)(
	tskyÃt_mes§ge
 *, *);

28 
	`skyÃt_mq_»Ëa£
(
mes§ge_queue
 *
q
, 
mes§ge_drİ
 
drİ_func
, *
ud
);

29 
ušt32_t
 
	`skyÃt_mq_hªdË
(
mes§ge_queue
 *);

32 
	`skyÃt_mq_pİ
(
mes§ge_queue
 *
q
, 
skyÃt_mes§ge
 *
mes§ge
);

33 
	`skyÃt_mq_push
(
mes§ge_queue
 *
q
, 
skyÃt_mes§ge
 *
mes§ge
);

36 
	`skyÃt_mq_Ëngth
(
mes§ge_queue
 *
q
);

37 
	`skyÃt_mq_ov”lßd
(
mes§ge_queue
 *
q
);

39 
	`skyÃt_mq_š™
();

	@skynet-src/skynet_server.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_£rv”.h
"

4 
	~"skyÃt_moduË.h
"

5 
	~"skyÃt_hªdË.h
"

6 
	~"skyÃt_mq.h
"

7 
	~"skyÃt_tim”.h
"

8 
	~"skyÃt_h¬bÜ.h
"

9 
	~"skyÃt_’v.h
"

10 
	~"skyÃt_mÚ™Ü.h
"

11 
	~"skyÃt_imp.h
"

12 
	~"skyÃt_log.h
"

13 
	~"skyÃt_tim”.h
"

14 
	~"¥šlock.h
"

15 
	~"©omic.h
"

17 
	~<±h»ad.h
>

19 
	~<¡ršg.h
>

20 
	~<as£¹.h
>

21 
	~<¡dšt.h
>

22 
	~<¡dio.h
>

23 
	~<¡dboŞ.h
>

25 #ifdeà
CALLING_CHECK


27 
	#CHECKCALLING_BEGIN
(
ùx
èià(!(
	`¥šlock_Œylock
(&ùx->
ÿÎšg
))è{ 
	`as£¹
(0); }

	)

28 
	#CHECKCALLING_END
(
ùx
è
	`¥šlock_uÆock
(&ùx->
ÿÎšg
);

	)

29 
	#CHECKCALLING_INIT
(
ùx
è
	`¥šlock_š™
(&ùx->
ÿÎšg
);

	)

30 
	#CHECKCALLING_DESTROY
(
ùx
è
	`¥šlock_de¡roy
(&ùx->
ÿÎšg
);

	)

31 
	#CHECKCALLING_DECL
 
¥šlock
 
ÿÎšg
;

	)

35 
	#CHECKCALLING_BEGIN
(
ùx
)

	)

36 
	#CHECKCALLING_END
(
ùx
)

	)

37 
	#CHECKCALLING_INIT
(
ùx
)

	)

38 
	#CHECKCALLING_DESTROY
(
ùx
)

	)

39 
	#CHECKCALLING_DECL


	)

43 
	sskyÃt_cÚ‹xt
 {

44 * 
	mš¡ªû
;

45 
skyÃt_moduË
 * 
	mmod
;

46 * 
	mcb_ud
;

47 
skyÃt_cb
 
	mcb
;

48 
mes§ge_queue
 *
	mqueue
;

49 
FILE
 * 
	mlogfe
;

50 
ušt64_t
 
	mıu_co¡
;

51 
ušt64_t
 
	mıu_¡¬t
;

52 
	m»suÉ
[32];

53 
ušt32_t
 
	mhªdË
;

54 
	m£ssiÚ_id
;

55 
	m»f
;

56 
	mmes§ge_couÁ
;

57 
boŞ
 
	mš™
;

58 
boŞ
 
	m’dËss
;

59 
boŞ
 
	m´ofe
;

61 
	mCHECKCALLING_DECL


64 
	sskyÃt_node
 {

65 
	mtÙ®
;

66 
	mš™
;

67 
ušt32_t
 
	mmÚ™Ü_ex™
;

68 
±h»ad_key_t
 
	mhªdË_key
;

69 
boŞ
 
	m´ofe
;

72 
skyÃt_node
 
	gG_NODE
;

75 
	$skyÃt_cÚ‹xt_tÙ®
() {

76  
G_NODE
.
tÙ®
;

77 
	}
}

80 
	$cÚ‹xt_šc
() {

81 
	`ATOM_INC
(&
G_NODE
.
tÙ®
);

82 
	}
}

85 
	$cÚ‹xt_dec
() {

86 
	`ATOM_DEC
(&
G_NODE
.
tÙ®
);

87 
	}
}

89 
ušt32_t


90 
	$skyÃt_cu¼’t_hªdË
() {

91 ià(
G_NODE
.
š™
) {

92 * 
hªdË
 = 
	`±h»ad_g‘¥ecific
(
G_NODE
.
hªdË_key
);

93  (
ušt32_t
)(
ušŒ_t
)
hªdË
;

95 
ušt32_t
 
v
 = (ušt32_t)(-
THREAD_MAIN
);

96  
v
;

98 
	}
}

101 
	$id_to_hex
(* 
¡r
, 
ušt32_t
 
id
) {

102 
i
;

103 
hex
[16] = { '0','1','2','3','4','5','6','7','8','9','A','B','C','D','E','F' };

104 
¡r
[0] = ':';

105 
i
=0;i<8;i++) {

106 
¡r
[
i
+1] = 
hex
[(
id
 >> ((7-i) * 4))&0xf];

108 
¡r
[9] = '\0';

109 
	}
}

111 
	sdrİ_t
 {

112 
ušt32_t
 
	mhªdË
;

116 
	$drİ_mes§ge
(
skyÃt_mes§ge
 *
msg
, *
ud
) {

117 
drİ_t
 *
d
 = 
ud
;

118 
	`skyÃt_ä“
(
msg
->
d©a
);

119 
ušt32_t
 
sourû
 = 
d
->
hªdË
;

120 
	`as£¹
(
sourû
);

122 
	`skyÃt_£nd
(
NULL
, 
sourû
, 
msg
->sourû, 
PTYPE_ERROR
, 0, NULL, 0);

123 
	}
}

125 
skyÃt_cÚ‹xt
 *

126 
	$skyÃt_cÚ‹xt_Ãw
(cÚ¡ * 
Çme
, cÚ¡ *
·¿m
) {

127 
skyÃt_moduË
 * 
mod
 = 
	`skyÃt_moduË_qu”y
(
Çme
);

129 ià(
mod
 =ğ
NULL
)

130  
NULL
;

132 *
š¡
 = 
	`skyÃt_moduË_š¡ªû_ü—‹
(
mod
);

133 ià(
š¡
 =ğ
NULL
)

134  
NULL
;

135 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_m®loc
((*ctx));

136 
	`CHECKCALLING_INIT
(
ùx
)

138 
ùx
->
mod
 = mod;

139 
ùx
->
š¡ªû
 = 
š¡
;

140 
ùx
->
»f
 = 2;

141 
ùx
->
cb
 = 
NULL
;

142 
ùx
->
cb_ud
 = 
NULL
;

143 
ùx
->
£ssiÚ_id
 = 0;

144 
ùx
->
logfe
 = 
NULL
;

146 
ùx
->
š™
 = 
çl£
;

147 
ùx
->
’dËss
 = 
çl£
;

149 
ùx
->
ıu_co¡
 = 0;

150 
ùx
->
ıu_¡¬t
 = 0;

151 
ùx
->
mes§ge_couÁ
 = 0;

152 
ùx
->
´ofe
 = 
G_NODE
.profile;

154 
ùx
->
hªdË
 = 0;

155 
ùx
->
hªdË
 = 
	`skyÃt_hªdË_»gi¡”
(ctx);

156 
mes§ge_queue
 * 
queue
 = 
ùx
->queuğ
	`skyÃt_mq_ü—‹
(ùx->
hªdË
);

158 
	`cÚ‹xt_šc
();

160 
	`CHECKCALLING_BEGIN
(
ùx
)

161 
r
 = 
	`skyÃt_moduË_š¡ªû_š™
(
mod
, 
š¡
, 
ùx
, 
·¿m
);

162 
	`CHECKCALLING_END
(
ùx
)

163 ià(
r
 == 0) {

164 
skyÃt_cÚ‹xt
 * 
»t
 = 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

165 ià(
»t
) {

166 
ùx
->
š™
 = 
Œue
;

168 
	`skyÃt_glob®mq_push
(
queue
);

169 ià(
»t
) {

170 
	`skyÃt_”rÜ
(
»t
, "LAUNCH % %s", 
Çme
, 
·¿m
 ?…aram : "");

172  
»t
;

174 
	`skyÃt_”rÜ
(
ùx
, "FAILED†aunch %s", 
Çme
);

175 
ušt32_t
 
hªdË
 = 
ùx
->handle;

176 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

177 
	`skyÃt_hªdË_»tœe
(
hªdË
);

178 
drİ_t
 
d
 = { 
hªdË
 };

179 
	`skyÃt_mq_»Ëa£
(
queue
, 
drİ_mes§ge
, &
d
);

180  
NULL
;

182 
	}
}

185 
	$skyÃt_cÚ‹xt_Ãw£ssiÚ
(
skyÃt_cÚ‹xt
 *
ùx
) {

187 
£ssiÚ
 = ++
ùx
->
£ssiÚ_id
;

188 ià(
£ssiÚ
 <= 0) {

189 
ùx
->
£ssiÚ_id
 = 1;

192  
£ssiÚ
;

193 
	}
}

196 
	$skyÃt_cÚ‹xt_g¿b
(
skyÃt_cÚ‹xt
 *
ùx
) {

197 
	`ATOM_INC
(&
ùx
->
»f
);

198 
	}
}

201 
	$skyÃt_cÚ‹xt_»£rve
(
skyÃt_cÚ‹xt
 *
ùx
) {

202 
	`skyÃt_cÚ‹xt_g¿b
(
ùx
);

205 
	`cÚ‹xt_dec
();

206 
	}
}

209 
	$d–‘e_cÚ‹xt
(
skyÃt_cÚ‹xt
 *
ùx
) {

210 ià(
ùx
->
logfe
) {

211 
	`fşo£
(
ùx
->
logfe
);

213 
	`skyÃt_moduË_š¡ªû_»Ëa£
(
ùx
->
mod
, ctx->
š¡ªû
);

214 
	`skyÃt_mq_m¬k_»Ëa£
(
ùx
->
queue
);

215 
	`CHECKCALLING_DESTROY
(
ùx
)

216 
	`skyÃt_ä“
(
ùx
);

217 
	`cÚ‹xt_dec
();

218 
	}
}

220 
skyÃt_cÚ‹xt
 *

221 
	$skyÃt_cÚ‹xt_»Ëa£
(
skyÃt_cÚ‹xt
 *
ùx
) {

222 ià(
	`ATOM_DEC
(&
ùx
->
»f
) == 0) {

223 
	`d–‘e_cÚ‹xt
(
ùx
);

224  
NULL
;

226  
ùx
;

227 
	}
}

230 
	$skyÃt_cÚ‹xt_push
(
ušt32_t
 
hªdË
, 
skyÃt_mes§ge
 *
mes§ge
) {

231 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_hªdË_g¿b
(
hªdË
);

232 ià(
ùx
 =ğ
NULL
) {

235 
	`skyÃt_mq_push
(
ùx
->
queue
, 
mes§ge
);

236 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

239 
	}
}

242 
	$skyÃt_cÚ‹xt_’dËss
(
ušt32_t
 
hªdË
) {

243 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_hªdË_g¿b
(
hªdË
);

244 ià(
ùx
 =ğ
NULL
) {

247 
ùx
->
’dËss
 = 
Œue
;

248 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

249 
	}
}

252 
	$skyÃt_i¤emÙe
(
skyÃt_cÚ‹xt
 * 
ùx
, 
ušt32_t
 
hªdË
, * 
h¬bÜ
) {

253 
»t
 = 
	`skyÃt_h¬bÜ_mes§ge_i¤emÙe
(
hªdË
);

254 ià(
h¬bÜ
) {

255 *
h¬bÜ
 = ()(
hªdË
 >> 
HANDLE_REMOTE_SHIFT
);

257  
»t
;

258 
	}
}

261 
	$di¥©ch_mes§ge
(
skyÃt_cÚ‹xt
 *
ùx
, 
skyÃt_mes§ge
 *
msg
) {

262 
	`as£¹
(
ùx
->
š™
);

263 
	`CHECKCALLING_BEGIN
(
ùx
)

264 
	`±h»ad_£t¥ecific
(
G_NODE
.
hªdË_key
, (*)(
ušŒ_t
)(
ùx
->
hªdË
));

265 
ty³
 = 
msg
->
sz
 >> 
MESSAGE_TYPE_SHIFT
;

266 
size_t
 
sz
 = 
msg
->sz & 
MESSAGE_TYPE_MASK
;

267 ià(
ùx
->
logfe
) {

268 
	`skyÃt_log_ouut
(
ùx
->
logfe
, 
msg
->
sourû
, 
ty³
, msg->
£ssiÚ
, msg->
d©a
, 
sz
);

270 ++
ùx
->
mes§ge_couÁ
;

271 
»£rve_msg
;

272 ià(
ùx
->
´ofe
) {

273 
ùx
->
ıu_¡¬t
 = 
	`skyÃt_th»ad_time
();

274 
»£rve_msg
 = 
ùx
->
	`cb
(ùx, ctx->
cb_ud
, 
ty³
, 
msg
->
£ssiÚ
, msg->
sourû
, msg->
d©a
, 
sz
);

275 
ušt64_t
 
co¡_time
 = 
	`skyÃt_th»ad_time
(è- 
ùx
->
ıu_¡¬t
;

276 
ùx
->
ıu_co¡
 +ğ
co¡_time
;

278 
»£rve_msg
 = 
ùx
->
	`cb
(ùx, ctx->
cb_ud
, 
ty³
, 
msg
->
£ssiÚ
, msg->
sourû
, msg->
d©a
, 
sz
);

280 ià(!
»£rve_msg
) {

281 
	`skyÃt_ä“
(
msg
->
d©a
);

283 
	`CHECKCALLING_END
(
ùx
)

284 
	}
}

287 
	$skyÃt_cÚ‹xt_di¥©ch®l
(
skyÃt_cÚ‹xt
 * 
ùx
) {

289 
skyÃt_mes§ge
 
msg
;

290 
mes§ge_queue
 *
q
 = 
ùx
->
queue
;

291 !
	`skyÃt_mq_pİ
(
q
,&
msg
)) {

292 
	`di¥©ch_mes§ge
(
ùx
, &
msg
);

294 
	}
}

296 
mes§ge_queue
 *

297 
	$skyÃt_cÚ‹xt_mes§ge_di¥©ch
(
skyÃt_mÚ™Ü
 *
sm
, 
mes§ge_queue
 *
q
, 
weight
) {

298 ià(
q
 =ğ
NULL
) {

299 
q
 = 
	`skyÃt_glob®mq_pİ
();

300 ià(
q
==
NULL
)

301  
NULL
;

304 
ušt32_t
 
hªdË
 = 
	`skyÃt_mq_hªdË
(
q
);

306 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_hªdË_g¿b
(
hªdË
);

307 ià(
ùx
 =ğ
NULL
) {

308 
drİ_t
 
d
 = { 
hªdË
 };

309 
	`skyÃt_mq_»Ëa£
(
q
, 
drİ_mes§ge
, &
d
);

310  
	`skyÃt_glob®mq_pİ
();

313 
i
,
n
=1;

314 
skyÃt_mes§ge
 
msg
;

316 
i
=0;i<
n
;i++) {

317 ià(
	`skyÃt_mq_pİ
(
q
,&
msg
)) {

318 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

319  
	`skyÃt_glob®mq_pİ
();

320 } ià(
i
==0 && 
weight
 >= 0) {

321 
n
 = 
	`skyÃt_mq_Ëngth
(
q
);

322 
n
 >>ğ
weight
;

324 
ov”lßd
 = 
	`skyÃt_mq_ov”lßd
(
q
);

325 ià(
ov”lßd
) {

326 
	`skyÃt_”rÜ
(
ùx
, "May ov”lßd, mes§gqueuËngth = %d", 
ov”lßd
);

329 
	`skyÃt_mÚ™Ü_Œigg”
(
sm
, 
msg
.
sourû
 , 
hªdË
);

331 ià(
ùx
->
cb
 =ğ
NULL
) {

332 
	`skyÃt_ä“
(
msg
.
d©a
);

334 
	`di¥©ch_mes§ge
(
ùx
, &
msg
);

337 
	`skyÃt_mÚ™Ü_Œigg”
(
sm
, 0,0);

340 
	`as£¹
(
q
 =ğ
ùx
->
queue
);

341 
mes§ge_queue
 *
nq
 = 
	`skyÃt_glob®mq_pİ
();

342 ià(
nq
) {

345 
	`skyÃt_glob®mq_push
(
q
);

346 
q
 = 
nq
;

348 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

350  
q
;

351 
	}
}

354 
	$cİy_Çme
(
Çme
[
GLOBALNAME_LENGTH
], cÚ¡ * 
addr
) {

355 
i
;

356 
i
=0;i<
GLOBALNAME_LENGTH
 && 
addr
[i];i++) {

357 
Çme
[
i
] = 
addr
[i];

359 ;
i
<
GLOBALNAME_LENGTH
;i++) {

360 
Çme
[
i
] = '\0';

362 
	}
}

364 
ušt32_t


365 
	$skyÃt_qu”yÇme
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
Çme
) {

366 
Çme
[0]) {

368  
	`¡¹oul
(
Çme
+1,
NULL
,16);

370  
	`skyÃt_hªdË_fšdÇme
(
Çme
 + 1);

372 
	`skyÃt_”rÜ
(
cÚ‹xt
, "DÚ'ˆsuµÜˆqu”y glob®‚am%s",
Çme
);

374 
	}
}

377 
	$hªdË_ex™
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, 
ušt32_t
 
hªdË
) {

378 ià(
hªdË
 == 0) {

379 
hªdË
 = 
cÚ‹xt
->handle;

380 
	`skyÃt_”rÜ
(
cÚ‹xt
, "KILL self");

382 
	`skyÃt_”rÜ
(
cÚ‹xt
, "KILL :%0x", 
hªdË
);

384 ià(
G_NODE
.
mÚ™Ü_ex™
) {

385 
	`skyÃt_£nd
(
cÚ‹xt
, 
hªdË
, 
G_NODE
.
mÚ™Ü_ex™
, 
PTYPE_CLIENT
, 0, 
NULL
, 0);

387 
	`skyÃt_hªdË_»tœe
(
hªdË
);

388 
	}
}

392 
	scommªd_func
 {

393 cÚ¡ *
	mÇme
;

394 cÚ¡ * (*
	mfunc
)(
skyÃt_cÚ‹xt
 * 
	mcÚ‹xt
, cÚ¡ * 
	m·¿m
);

398 
	$cmd_timeout
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

399 * 
£ssiÚ_±r
 = 
NULL
;

400 
ti
 = 
	`¡¹Ş
(
·¿m
, &
£ssiÚ_±r
, 10);

401 
£ssiÚ
 = 
	`skyÃt_cÚ‹xt_Ãw£ssiÚ
(
cÚ‹xt
);

402 
	`skyÃt_timeout
(
cÚ‹xt
->
hªdË
, 
ti
, 
£ssiÚ
);

403 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, "%d", 
£ssiÚ
);

404  
cÚ‹xt
->
»suÉ
;

405 
	}
}

408 
	$cmd_»g
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

409 ià(
·¿m
 =ğ
NULL
 ||…aram[0] == '\0') {

410 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, ":%x", cÚ‹xt->
hªdË
);

411  
cÚ‹xt
->
»suÉ
;

412 } ià(
·¿m
[0] == '.') {

413  
	`skyÃt_hªdË_ÇmehªdË
(
cÚ‹xt
->
hªdË
, 
·¿m
 + 1);

415 
	`skyÃt_”rÜ
(
cÚ‹xt
, "Cª'ˆ»gi¡” glob®‚am% š C", 
·¿m
);

416  
NULL
;

418 
	}
}

421 
	$cmd_qu”y
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

422 ià(
·¿m
[0] == '.') {

423 
ušt32_t
 
hªdË
 = 
	`skyÃt_hªdË_fšdÇme
(
·¿m
+1);

424 ià(
hªdË
) {

425 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, ":%x", 
hªdË
);

426  
cÚ‹xt
->
»suÉ
;

429  
NULL
;

430 
	}
}

433 
	$cmd_Çme
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

434 
size
 = 
	`¡¾’
(
·¿m
);

435 
Çme
[
size
+1];

436 
hªdË
[
size
+1];

437 
	`ssÿnf
(
·¿m
,"% %s",
Çme
,
hªdË
);

438 ià(
hªdË
[0] != ':') {

439  
NULL
;

441 
ušt32_t
 
hªdË_id
 = 
	`¡¹oul
(
hªdË
+1, 
NULL
, 16);

442 ià(
hªdË_id
 == 0) {

443  
NULL
;

445 ià(
Çme
[0] == '.') {

446  
	`skyÃt_hªdË_ÇmehªdË
(
hªdË_id
, 
Çme
 + 1);

448 
	`skyÃt_”rÜ
(
cÚ‹xt
, "Cª'ˆ£ˆglob®‚am% š C", 
Çme
);

450  
NULL
;

451 
	}
}

454 
	$cmd_ex™
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

455 
	`hªdË_ex™
(
cÚ‹xt
, 0);

456  
NULL
;

457 
	}
}

459 
ušt32_t


460 
	$tohªdË
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

461 
ušt32_t
 
hªdË
 = 0;

462 ià(
·¿m
[0] == ':') {

463 
hªdË
 = 
	`¡¹oul
(
·¿m
+1, 
NULL
, 16);

464 } ià(
·¿m
[0] == '.') {

465 
hªdË
 = 
	`skyÃt_hªdË_fšdÇme
(
·¿m
+1);

467 
	`skyÃt_”rÜ
(
cÚ‹xt
, "Cª'ˆcÚv”ˆ% tØhªdË",
·¿m
);

470  
hªdË
;

471 
	}
}

474 
	$cmd_kl
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

475 
ušt32_t
 
hªdË
 = 
	`tohªdË
(
cÚ‹xt
, 
·¿m
);

476 ià(
hªdË
) {

477 
	`hªdË_ex™
(
cÚ‹xt
, 
hªdË
);

479  
NULL
;

480 
	}
}

483 
	$cmd_Ïunch
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

484 
size_t
 
sz
 = 
	`¡¾’
(
·¿m
);

485 
tmp
[
sz
+1];

486 
	`¡rıy
(
tmp
,
·¿m
);

487 * 
¬gs
 = 
tmp
;

488 * 
mod
 = 
	`¡r£p
(&
¬gs
, " \t\r\n");

489 
¬gs
 = 
	`¡r£p
(&args, "\r\n");

490 
skyÃt_cÚ‹xt
 * 
š¡
 = 
	`skyÃt_cÚ‹xt_Ãw
(
mod
,
¬gs
);

491 ià(
š¡
 =ğ
NULL
) {

492  
NULL
;

494 
	`id_to_hex
(
cÚ‹xt
->
»suÉ
, 
š¡
->
hªdË
);

495  
cÚ‹xt
->
»suÉ
;

497 
	}
}

500 
	$cmd_g‘’v
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

501  
	`skyÃt_g‘’v
(
·¿m
);

502 
	}
}

505 
	$cmd_£‹nv
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

506 
size_t
 
sz
 = 
	`¡¾’
(
·¿m
);

507 
key
[
sz
+1];

508 
i
;

509 
i
=0;
·¿m
[i] != ' ' &&…aram[i];i++) {

510 
key
[
i
] = 
·¿m
[i];

512 ià(
·¿m
[
i
] == '\0')

513  
NULL
;

515 
key
[
i
] = '\0';

516 
·¿m
 +ğ
i
+1;

518 
	`skyÃt_£‹nv
(
key
,
·¿m
);

519  
NULL
;

520 
	}
}

523 
	$cmd_¡¬‰ime
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

524 
ušt32_t
 
£c
 = 
	`skyÃt_¡¬‰ime
();

525 
	`¥rštf
(
cÚ‹xt
->
»suÉ
,"%u",
£c
);

526  
cÚ‹xt
->
»suÉ
;

527 
	}
}

530 
	$cmd_abÜt
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

531 
	`skyÃt_hªdË_»tœ—Î
();

532  
NULL
;

533 
	}
}

536 
	$cmd_mÚ™Ü
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

537 
ušt32_t
 
hªdË
=0;

538 ià(
·¿m
 =ğ
NULL
 ||…aram[0] == '\0') {

539 ià(
G_NODE
.
mÚ™Ü_ex™
) {

541 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, ":%x", 
G_NODE
.
mÚ™Ü_ex™
);

542  
cÚ‹xt
->
»suÉ
;

544  
NULL
;

546 
hªdË
 = 
	`tohªdË
(
cÚ‹xt
, 
·¿m
);

548 
G_NODE
.
mÚ™Ü_ex™
 = 
hªdË
;

549  
NULL
;

550 
	}
}

553 
	$cmd_¡©
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

554 ià(
	`¡rcmp
(
·¿m
, "mqlen") == 0) {

555 
Ën
 = 
	`skyÃt_mq_Ëngth
(
cÚ‹xt
->
queue
);

556 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, "%d", 
Ën
);

557 } ià(
	`¡rcmp
(
·¿m
, "endless") == 0) {

558 ià(
cÚ‹xt
->
’dËss
) {

559 
	`¡rıy
(
cÚ‹xt
->
»suÉ
, "1");

560 
cÚ‹xt
->
’dËss
 = 
çl£
;

562 
	`¡rıy
(
cÚ‹xt
->
»suÉ
, "0");

564 } ià(
	`¡rcmp
(
·¿m
, "cpu") == 0) {

565 
t
 = ()
cÚ‹xt
->
ıu_co¡
 / 1000000.0;

566 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, "%lf", 
t
);

567 } ià(
	`¡rcmp
(
·¿m
, "time") == 0) {

568 ià(
cÚ‹xt
->
´ofe
) {

569 
ušt64_t
 
ti
 = 
	`skyÃt_th»ad_time
(è- 
cÚ‹xt
->
ıu_¡¬t
;

570 
t
 = ()
ti
 / 1000000.0;

571 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, "%lf", 
t
);

573 
	`¡rıy
(
cÚ‹xt
->
»suÉ
, "0");

575 } ià(
	`¡rcmp
(
·¿m
, "message") == 0) {

576 
	`¥rštf
(
cÚ‹xt
->
»suÉ
, "%d", cÚ‹xt->
mes§ge_couÁ
);

578 
cÚ‹xt
->
»suÉ
[0] = '\0';

580  
cÚ‹xt
->
»suÉ
;

581 
	}
}

584 
	$cmd_logÚ
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

585 
ušt32_t
 
hªdË
 = 
	`tohªdË
(
cÚ‹xt
, 
·¿m
);

586 ià(
hªdË
 == 0)

587  
NULL
;

588 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_hªdË_g¿b
(
hªdË
);

589 ià(
ùx
 =ğ
NULL
)

590  
NULL
;

591 
FILE
 *
f
 = 
NULL
;

592 
FILE
 * 
Ï¡f
 = 
ùx
->
logfe
;

593 ià(
Ï¡f
 =ğ
NULL
) {

594 
f
 = 
	`skyÃt_log_İ’
(
cÚ‹xt
, 
hªdË
);

595 ià(
f
) {

596 ià(!
	`ATOM_CAS_POINTER
(&
ùx
->
logfe
, 
NULL
, 
f
)) {

598 
	`fşo£
(
f
);

602 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

603  
NULL
;

604 
	}
}

607 
	$cmd_logoff
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

608 
ušt32_t
 
hªdË
 = 
	`tohªdË
(
cÚ‹xt
, 
·¿m
);

609 ià(
hªdË
 == 0)

610  
NULL
;

611 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_hªdË_g¿b
(
hªdË
);

612 ià(
ùx
 =ğ
NULL
)

613  
NULL
;

614 
FILE
 * 
f
 = 
ùx
->
logfe
;

615 ià(
f
) {

617 ià(
	`ATOM_CAS_POINTER
(&
ùx
->
logfe
, 
f
, 
NULL
)) {

618 
	`skyÃt_log_şo£
(
cÚ‹xt
, 
f
, 
hªdË
);

621 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

622  
NULL
;

623 
	}
}

626 
	$cmd_sigÇl
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
·¿m
) {

627 
ušt32_t
 
hªdË
 = 
	`tohªdË
(
cÚ‹xt
, 
·¿m
);

628 ià(
hªdË
 == 0)

629  
NULL
;

630 
skyÃt_cÚ‹xt
 * 
ùx
 = 
	`skyÃt_hªdË_g¿b
(
hªdË
);

631 ià(
ùx
 =ğ
NULL
)

632  
NULL
;

633 
·¿m
 = 
	`¡rchr
(param, ' ');

634 
sig
 = 0;

635 ià(
·¿m
) {

636 
sig
 = 
	`¡¹Ş
(
·¿m
, 
NULL
, 0);

639 
	`skyÃt_moduË_š¡ªû_sigÇl
(
ùx
->
mod
, ctx->
š¡ªû
, 
sig
);

641 
	`skyÃt_cÚ‹xt_»Ëa£
(
ùx
);

642  
NULL
;

643 
	}
}

645 
commªd_func
 
	gcmd_funcs
[] = {

646 { "TIMEOUT", 
cmd_timeout
 },

647 { "REG", 
cmd_»g
 },

648 { "QUERY", 
cmd_qu”y
 },

649 { "NAME", 
cmd_Çme
 },

650 { "EXIT", 
cmd_ex™
 },

651 { "KILL", 
cmd_kl
 },

652 { "LAUNCH", 
cmd_Ïunch
 },

653 { "GETENV", 
cmd_g‘’v
 },

654 { "SETENV", 
cmd_£‹nv
 },

655 { "STARTTIME", 
cmd_¡¬‰ime
 },

656 { "ABORT", 
cmd_abÜt
 },

657 { "MONITOR", 
cmd_mÚ™Ü
 },

658 { "STAT", 
cmd_¡©
 },

659 { "LOGON", 
cmd_logÚ
 },

660 { "LOGOFF", 
cmd_logoff
 },

661 { "SIGNAL", 
cmd_sigÇl
 },

662 { 
NULL
, NULL },

666 
	$skyÃt_commªd
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, cÚ¡ * 
cmd
 , cÚ¡ * 
·¿m
) {

667 
commªd_func
 * 
m‘hod
 = &
cmd_funcs
[0];

668 
m‘hod
->
Çme
) {

669 ià(
	`¡rcmp
(
cmd
, 
m‘hod
->
Çme
) == 0) {

670  
m‘hod
->
	`func
(
cÚ‹xt
, 
·¿m
);

672 ++
m‘hod
;

675  
NULL
;

676 
	}
}

679 
	$_f‹r_¬gs
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, 
ty³
, *
£ssiÚ
, ** 
d©a
, 
size_t
 * 
sz
) {

680 
Ãedcİy
 = !(
ty³
 & 
PTYPE_TAG_DONTCOPY
);

681 
®loc£ssiÚ
 = 
ty³
 & 
PTYPE_TAG_ALLOCSESSION
;

682 
ty³
 &= 0xff;

684 ià(
®loc£ssiÚ
) {

685 
	`as£¹
(*
£ssiÚ
 == 0);

686 *
£ssiÚ
 = 
	`skyÃt_cÚ‹xt_Ãw£ssiÚ
(
cÚ‹xt
);

689 ià(
Ãedcİy
 && *
d©a
) {

690 * 
msg
 = 
	`skyÃt_m®loc
(*
sz
+1);

691 
	`memıy
(
msg
, *
d©a
, *
sz
);

692 
msg
[*
sz
] = '\0';

693 *
d©a
 = 
msg
;

696 *
sz
 |ğ(
size_t
)
ty³
 << 
MESSAGE_TYPE_SHIFT
;

697 
	}
}

700 
	$skyÃt_£nd
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, 
ušt32_t
 
sourû
, ušt32_ˆ
de¡š©iÚ
 , 
ty³
, 
£ssiÚ
, * 
d©a
, 
size_t
 
sz
) {

701 ià((
sz
 & 
MESSAGE_TYPE_MASK
) != sz) {

702 
	`skyÃt_”rÜ
(
cÚ‹xt
, "Thmes§gtØ%x i toØÏrge", 
de¡š©iÚ
);

703 ià(
ty³
 & 
PTYPE_TAG_DONTCOPY
) {

704 
	`skyÃt_ä“
(
d©a
);

708 
	`_f‹r_¬gs
(
cÚ‹xt
, 
ty³
, &
£ssiÚ
, (**)&
d©a
, &
sz
);

710 ià(
sourû
 == 0) {

711 
sourû
 = 
cÚ‹xt
->
hªdË
;

714 ià(
de¡š©iÚ
 == 0) {

715  
£ssiÚ
;

717 ià(
	`skyÃt_h¬bÜ_mes§ge_i¤emÙe
(
de¡š©iÚ
)) {

718 
»mÙe_mes§ge
 * 
rmsg
 = 
	`skyÃt_m®loc
((*rmsg));

719 
rmsg
->
de¡š©iÚ
.
hªdË
 = destination;

720 
rmsg
->
mes§ge
 = 
d©a
;

721 
rmsg
->
sz
 = sz;

722 
	`skyÃt_h¬bÜ_£nd
(
rmsg
, 
sourû
, 
£ssiÚ
);

724 
skyÃt_mes§ge
 
smsg
;

725 
smsg
.
sourû
 = source;

726 
smsg
.
£ssiÚ
 = session;

727 
smsg
.
d©a
 = data;

728 
smsg
.
sz
 = sz;

730 ià(
	`skyÃt_cÚ‹xt_push
(
de¡š©iÚ
, &
smsg
)) {

731 
	`skyÃt_ä“
(
d©a
);

735  
£ssiÚ
;

736 
	}
}

739 
	$skyÃt_£ndÇme
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, 
ušt32_t
 
sourû
, cÚ¡ * 
addr
 , 
ty³
, 
£ssiÚ
, * 
d©a
, 
size_t
 
sz
) {

740 ià(
sourû
 == 0) {

741 
sourû
 = 
cÚ‹xt
->
hªdË
;

743 
ušt32_t
 
des
 = 0;

744 ià(
addr
[0] == ':') {

745 
des
 = 
	`¡¹oul
(
addr
+1, 
NULL
, 16);

746 } ià(
addr
[0] == '.') {

747 
des
 = 
	`skyÃt_hªdË_fšdÇme
(
addr
 + 1);

748 ià(
des
 == 0) {

749 ià(
ty³
 & 
PTYPE_TAG_DONTCOPY
) {

750 
	`skyÃt_ä“
(
d©a
);

755 
	`_f‹r_¬gs
(
cÚ‹xt
, 
ty³
, &
£ssiÚ
, (**)&
d©a
, &
sz
);

757 
»mÙe_mes§ge
 * 
rmsg
 = 
	`skyÃt_m®loc
((*rmsg));

758 
	`cİy_Çme
(
rmsg
->
de¡š©iÚ
.
Çme
, 
addr
);

759 
rmsg
->
de¡š©iÚ
.
hªdË
 = 0;

760 
rmsg
->
mes§ge
 = 
d©a
;

761 
rmsg
->
sz
 = sz;

763 
	`skyÃt_h¬bÜ_£nd
(
rmsg
, 
sourû
, 
£ssiÚ
);

764  
£ssiÚ
;

767  
	`skyÃt_£nd
(
cÚ‹xt
, 
sourû
, 
des
, 
ty³
, 
£ssiÚ
, 
d©a
, 
sz
);

768 
	}
}

770 
ušt32_t


771 
	$skyÃt_cÚ‹xt_hªdË
(
skyÃt_cÚ‹xt
 *
ùx
) {

772  
ùx
->
hªdË
;

773 
	}
}

776 
	$skyÃt_ÿÎback
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, *
ud
, 
skyÃt_cb
 
cb
) {

777 
cÚ‹xt
->
cb
 = cb;

778 
cÚ‹xt
->
cb_ud
 = 
ud
;

779 
	}
}

782 
	$skyÃt_cÚ‹xt_£nd
(
skyÃt_cÚ‹xt
 * 
ùx
, * 
msg
, 
size_t
 
sz
, 
ušt32_t
 
sourû
, 
ty³
, 
£ssiÚ
) {

783 
skyÃt_mes§ge
 
smsg
;

784 
smsg
.
sourû
 = source;

785 
smsg
.
£ssiÚ
 = session;

786 
smsg
.
d©a
 = 
msg
;

787 
smsg
.
sz
 = sz | (
size_t
)
ty³
 << 
MESSAGE_TYPE_SHIFT
;

789 
	`skyÃt_mq_push
(
ùx
->
queue
, &
smsg
);

790 
	}
}

793 
	$skyÃt_glob®š™
() {

794 
G_NODE
.
tÙ®
 = 0;

795 
G_NODE
.
mÚ™Ü_ex™
 = 0;

796 
G_NODE
.
š™
 = 1;

797 ià(
	`±h»ad_key_ü—‹
(&
G_NODE
.
hªdË_key
, 
NULL
)) {

798 
	`årštf
(
¡d”r
, "pthread_key_create failed");

799 
	`ex™
(1);

802 
	`skyÃt_š™th»ad
(
THREAD_MAIN
);

803 
	}
}

806 
	$skyÃt_glob®ex™
() {

807 
	`±h»ad_key_d–‘e
(
G_NODE
.
hªdË_key
);

808 
	}
}

811 
	$skyÃt_š™th»ad
(
m
) {

812 
ušŒ_t
 
v
 = (
ušt32_t
)(-
m
);

813 
	`±h»ad_£t¥ecific
(
G_NODE
.
hªdË_key
, (*)
v
);

814 
	}
}

817 
	$skyÃt_´ofe_’abË
(
’abË
) {

818 
G_NODE
.
´ofe
 = (
boŞ
)
’abË
;

819 
	}
}

	@skynet-src/skynet_server.h

1 #iâdeà
SKYNET_SERVER_H


2 
	#SKYNET_SERVER_H


	)

4 
	~<¡dšt.h
>

5 
	~<¡dlib.h
>

7 
	gskyÃt_cÚ‹xt
;

8 
	gskyÃt_mes§ge
;

9 
	gskyÃt_mÚ™Ü
;

11 
skyÃt_cÚ‹xt
 * 
skyÃt_cÚ‹xt_Ãw
(cÚ¡ * 
Çme
, cÚ¡ * 
·rm
);

12 
skyÃt_cÚ‹xt_g¿b
(
skyÃt_cÚ‹xt
 *);

13 
skyÃt_cÚ‹xt_»£rve
(
skyÃt_cÚ‹xt
 *
ùx
);

14 
skyÃt_cÚ‹xt
 * 
skyÃt_cÚ‹xt_»Ëa£
(skynet_context *);

15 
ušt32_t
 
skyÃt_cÚ‹xt_hªdË
(
skyÃt_cÚ‹xt
 *);

16 
skyÃt_cÚ‹xt_push
(
ušt32_t
 
hªdË
, 
skyÃt_mes§ge
 *
mes§ge
);

17 
skyÃt_cÚ‹xt_£nd
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
, * 
msg
, 
size_t
 
sz
, 
ušt32_t
 
sourû
, 
ty³
, 
£ssiÚ
);

18 
skyÃt_cÚ‹xt_Ãw£ssiÚ
(
skyÃt_cÚ‹xt
 *);

19 
mes§ge_queue
 * 
skyÃt_cÚ‹xt_mes§ge_di¥©ch
(
skyÃt_mÚ™Ü
 *, mes§ge_queu*, 
weight
);

20 
skyÃt_cÚ‹xt_tÙ®
();

21 
skyÃt_cÚ‹xt_di¥©ch®l
(
skyÃt_cÚ‹xt
 * 
cÚ‹xt
);

23 
skyÃt_cÚ‹xt_’dËss
(
ušt32_t
 
hªdË
);

25 
skyÃt_glob®š™
();

26 
skyÃt_glob®ex™
();

27 
skyÃt_š™th»ad
(
m
);

29 
skyÃt_´ofe_’abË
(
’abË
);

	@skynet-src/skynet_socket.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_sock‘.h
"

4 
	~"sock‘_£rv”.h
"

5 
	~"skyÃt_£rv”.h
"

6 
	~"skyÃt_mq.h
"

7 
	~"skyÃt_h¬bÜ.h
"

9 
	~<as£¹.h
>

10 
	~<¡dlib.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dboŞ.h
>

14 
sock‘_£rv”
 * 
	gSOCKET_SERVER
 = 
NULL
;

17 
	$skyÃt_sock‘_š™
() {

18 
SOCKET_SERVER
 = 
	`sock‘_£rv”_ü—‹
();

19 
	}
}

22 
	$skyÃt_sock‘_ex™
() {

23 
	`sock‘_£rv”_ex™
(
SOCKET_SERVER
);

24 
	}
}

27 
	$skyÃt_sock‘_ä“
() {

28 
	`sock‘_£rv”_»Ëa£
(
SOCKET_SERVER
);

29 
SOCKET_SERVER
 = 
NULL
;

30 
	}
}

34 
	$fÜw¬d_mes§ge
(
ty³
, 
boŞ
 
·ddšg
, 
sock‘_mes§ge
 * 
»suÉ
) {

35 
skyÃt_sock‘_mes§ge
 *
sm
;

36 
size_t
 
sz
 = (*
sm
);

37 ià(
·ddšg
) {

38 ià(
»suÉ
->
d©a
) {

39 
size_t
 
msg_sz
 = 
	`¡¾’
(
»suÉ
->
d©a
);

40 ià(
msg_sz
 > 128) {

41 
msg_sz
 = 128;

43 
sz
 +ğ
msg_sz
;

45 
»suÉ
->
d©a
 = "";

48 
sm
 = (
skyÃt_sock‘_mes§ge
 *)
	`skyÃt_m®loc
(
sz
);

49 
sm
->
ty³
 =ype;

50 
sm
->
id
 = 
»suÉ
->id;

51 
sm
->
ud
 = 
»suÉ
->ud;

52 ià(
·ddšg
) {

53 
sm
->
bufãr
 = 
NULL
;

54 
	`memıy
(
sm
+1, 
»suÉ
->
d©a
, 
sz
 - (*sm));

56 
sm
->
bufãr
 = 
»suÉ
->
d©a
;

59 
skyÃt_mes§ge
 
mes§ge
;

60 
mes§ge
.
sourû
 = 0;

61 
mes§ge
.
£ssiÚ
 = 0;

62 
mes§ge
.
d©a
 = 
sm
;

63 
mes§ge
.
sz
 = sz | ((
size_t
)
PTYPE_SOCKET
 << 
MESSAGE_TYPE_SHIFT
);

65 ià(
	`skyÃt_cÚ‹xt_push
((
ušt32_t
)
»suÉ
->
İaque
, &
mes§ge
)) {

68 
	`skyÃt_ä“
(
sm
->
bufãr
);

69 
	`skyÃt_ä“
(
sm
);

71 
	}
}

74 
	$skyÃt_sock‘_pŞl
() {

75 
sock‘_£rv”
 *
ss
 = 
SOCKET_SERVER
;

76 
	`as£¹
(
ss
);

77 
sock‘_mes§ge
 
»suÉ
;

78 
mÜe
 = 1;

79 
ty³
 = 
	`sock‘_£rv”_pŞl
(
ss
, &
»suÉ
, &
mÜe
);

80 
ty³
) {

81 
SOCKET_EXIT
:

83 
SOCKET_DATA
:

84 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_DATA
, 
çl£
, &
»suÉ
);

86 
SOCKET_CLOSE
:

87 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_CLOSE
, 
çl£
, &
»suÉ
);

89 
SOCKET_OPEN
:

90 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_CONNECT
, 
Œue
, &
»suÉ
);

92 
SOCKET_ERR
:

93 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_ERROR
, 
Œue
, &
»suÉ
);

95 
SOCKET_ACCEPT
:

96 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_ACCEPT
, 
Œue
, &
»suÉ
);

98 
SOCKET_UDP
:

99 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_UDP
, 
çl£
, &
»suÉ
);

101 
SOCKET_WARNING
:

102 
	`fÜw¬d_mes§ge
(
SKYNET_SOCKET_TYPE_WARNING
, 
çl£
, &
»suÉ
);

105 
	`skyÃt_”rÜ
(
NULL
, "UnknowÀsock‘ mes§gty³ %d.",
ty³
);

108 ià(
mÜe
) {

112 
	}
}

115 
	$skyÃt_sock‘_£nd
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, *
bufãr
, 
sz
) {

116  
	`sock‘_£rv”_£nd
(
SOCKET_SERVER
, 
id
, 
bufãr
, 
sz
);

117 
	}
}

120 
	$skyÃt_sock‘_£nd_low´iÜ™y
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, *
bufãr
, 
sz
) {

121  
	`sock‘_£rv”_£nd_low´iÜ™y
(
SOCKET_SERVER
, 
id
, 
bufãr
, 
sz
);

122 
	}
}

125 
	$skyÃt_sock‘_li¡’
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ *
ho¡
, 
pÜt
, 
backlog
) {

126 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

127  
	`sock‘_£rv”_li¡’
(
SOCKET_SERVER
, 
sourû
, 
ho¡
, 
pÜt
, 
backlog
);

128 
	}
}

131 
	$skyÃt_sock‘_cÚÃù
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ *
ho¡
, 
pÜt
) {

132 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

133  
	`sock‘_£rv”_cÚÃù
(
SOCKET_SERVER
, 
sourû
, 
ho¡
, 
pÜt
);

134 
	}
}

137 
	$skyÃt_sock‘_bšd
(
skyÃt_cÚ‹xt
 *
ùx
, 
fd
) {

138 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

139  
	`sock‘_£rv”_bšd
(
SOCKET_SERVER
, 
sourû
, 
fd
);

140 
	}
}

143 
	$skyÃt_sock‘_şo£
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
) {

144 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

145 
	`sock‘_£rv”_şo£
(
SOCKET_SERVER
, 
sourû
, 
id
);

146 
	}
}

149 
	$skyÃt_sock‘_shutdown
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
) {

150 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

151 
	`sock‘_£rv”_shutdown
(
SOCKET_SERVER
, 
sourû
, 
id
);

152 
	}
}

155 
	$skyÃt_sock‘_¡¬t
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
) {

156 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

157 
	`sock‘_£rv”_¡¬t
(
SOCKET_SERVER
, 
sourû
, 
id
);

158 
	}
}

161 
	$skyÃt_sock‘_nod–ay
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
) {

162 
	`sock‘_£rv”_nod–ay
(
SOCKET_SERVER
, 
id
);

163 
	}
}

166 
	$skyÃt_sock‘_udp
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
addr
, 
pÜt
) {

167 
ušt32_t
 
sourû
 = 
	`skyÃt_cÚ‹xt_hªdË
(
ùx
);

168  
	`sock‘_£rv”_udp
(
SOCKET_SERVER
, 
sourû
, 
addr
, 
pÜt
);

169 
	}
}

172 
	$skyÃt_sock‘_udp_cÚÃù
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, cÚ¡ * 
addr
, 
pÜt
) {

173  
	`sock‘_£rv”_udp_cÚÃù
(
SOCKET_SERVER
, 
id
, 
addr
, 
pÜt
);

174 
	}
}

177 
	$skyÃt_sock‘_udp_£nd
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, cÚ¡ * 
add»ss
, cÚ¡ *
bufãr
, 
sz
) {

178  
	`sock‘_£rv”_udp_£nd
(
SOCKET_SERVER
, 
id
, (cÚ¡ 
sock‘_udp_add»ss
 *)
add»ss
, 
bufãr
, 
sz
);

179 
	}
}

182 
	$skyÃt_sock‘_udp_add»ss
(
skyÃt_sock‘_mes§ge
 *
msg
, *
addrsz
) {

183 ià(
msg
->
ty³
 !ğ
SKYNET_SOCKET_TYPE_UDP
) {

184  
NULL
;

186 
sock‘_mes§ge
 
sm
;

187 
sm
.
id
 = 
msg
->id;

188 
sm
.
İaque
 = 0;

189 
sm
.
ud
 = 
msg
->ud;

190 
sm
.
d©a
 = 
msg
->
bufãr
;

191  (cÚ¡ *)
	`sock‘_£rv”_udp_add»ss
(
SOCKET_SERVER
, &
sm
, 
addrsz
);

192 
	}
}

	@skynet-src/skynet_socket.h

1 #iâdeà
skyÃt_sock‘_h


2 
	#skyÃt_sock‘_h


	)

4 
	gskyÃt_cÚ‹xt
;

6 
	#SKYNET_SOCKET_TYPE_DATA
 1

	)

7 
	#SKYNET_SOCKET_TYPE_CONNECT
 2

	)

8 
	#SKYNET_SOCKET_TYPE_CLOSE
 3

	)

9 
	#SKYNET_SOCKET_TYPE_ACCEPT
 4

	)

10 
	#SKYNET_SOCKET_TYPE_ERROR
 5

	)

11 
	#SKYNET_SOCKET_TYPE_UDP
 6

	)

12 
	#SKYNET_SOCKET_TYPE_WARNING
 7

	)

14 
	sskyÃt_sock‘_mes§ge
 {

15 
	mty³
;

16 
	mid
;

17 
	mud
;

18 * 
	mbufãr
;

21 
skyÃt_sock‘_š™
();

22 
skyÃt_sock‘_ex™
();

23 
skyÃt_sock‘_ä“
();

24 
skyÃt_sock‘_pŞl
();

26 
skyÃt_sock‘_£nd
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, *
bufãr
, 
sz
);

27 
skyÃt_sock‘_£nd_low´iÜ™y
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, *
bufãr
, 
sz
);

28 
skyÃt_sock‘_li¡’
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ *
ho¡
, 
pÜt
, 
backlog
);

29 
skyÃt_sock‘_cÚÃù
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ *
ho¡
, 
pÜt
);

30 
skyÃt_sock‘_bšd
(
skyÃt_cÚ‹xt
 *
ùx
, 
fd
);

31 
skyÃt_sock‘_şo£
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
);

32 
skyÃt_sock‘_shutdown
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
);

33 
skyÃt_sock‘_¡¬t
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
);

34 
skyÃt_sock‘_nod–ay
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
);

36 
skyÃt_sock‘_udp
(
skyÃt_cÚ‹xt
 *
ùx
, cÚ¡ * 
addr
, 
pÜt
);

37 
skyÃt_sock‘_udp_cÚÃù
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, cÚ¡ * 
addr
, 
pÜt
);

38 
skyÃt_sock‘_udp_£nd
(
skyÃt_cÚ‹xt
 *
ùx
, 
id
, cÚ¡ * 
add»ss
, cÚ¡ *
bufãr
, 
sz
);

39 cÚ¡ * 
skyÃt_sock‘_udp_add»ss
(
skyÃt_sock‘_mes§ge
 *, *
addrsz
);

	@skynet-src/skynet_start.c

1 
	~"skyÃt.h
"

2 
	~"skyÃt_£rv”.h
"

3 
	~"skyÃt_imp.h
"

4 
	~"skyÃt_mq.h
"

5 
	~"skyÃt_hªdË.h
"

6 
	~"skyÃt_moduË.h
"

7 
	~"skyÃt_tim”.h
"

8 
	~"skyÃt_mÚ™Ü.h
"

9 
	~"skyÃt_sock‘.h
"

10 
	~"skyÃt_d«mÚ.h
"

11 
	~"skyÃt_h¬bÜ.h
"

13 
	~<±h»ad.h
>

14 
	~<uni¡d.h
>

15 
	~<as£¹.h
>

16 
	~<¡dio.h
>

17 
	~<¡dlib.h
>

18 
	~<¡ršg.h
>

19 
	~<sigÇl.h
>

21 
	smÚ™Ü
 {

22 
	mcouÁ
;

23 
skyÃt_mÚ™Ü
 ** 
	mm
;

24 
±h»ad_cÚd_t
 
	mcÚd
;

25 
±h»ad_mu‹x_t
 
	mmu‹x
;

26 
	m¦“p
;

27 
	mqu™
;

30 
	swÜk”_·rm
 {

31 
mÚ™Ü
 *
	mm
;

32 
	mid
;

33 
	mweight
;

36 
	gSIG
 = 0;

39 
	$hªdË_hup
(
sigÇl
) {

40 ià(
sigÇl
 =ğ
SIGHUP
) {

41 
SIG
 = 1;

43 
	}
}

45 
	#CHECK_ABORT
 ià(
	`skyÃt_cÚ‹xt_tÙ®
()==0è;

	)

48 
	$ü—‹_th»ad
(
±h»ad_t
 *
th»ad
, *(*
¡¬t_routše
è(*), *
¬g
) {

49 ià(
	`±h»ad_ü—‹
(
th»ad
,
NULL
, 
¡¬t_routše
, 
¬g
)) {

50 
	`årštf
(
¡d”r
, "Createhread failed");

51 
	`ex™
(1);

53 
	}
}

56 
	$wakeup
(
mÚ™Ü
 *
m
, 
busy
) {

57 ià(
m
->
¦“p
 >ğm->
couÁ
 - 
busy
) {

59 
	`±h»ad_cÚd_sigÇl
(&
m
->
cÚd
);

61 
	}
}

64 
	$th»ad_sock‘
(*
p
) {

65 
mÚ™Ü
 * 
m
 = 
p
;

66 
	`skyÃt_š™th»ad
(
THREAD_SOCKET
);

68 
r
 = 
	`skyÃt_sock‘_pŞl
();

69 ià(
r
==0)

71 ià(
r
<0) {

72 
CHECK_ABORT


75 
	`wakeup
(
m
,0);

77  
NULL
;

78 
	}
}

81 
	$ä“_mÚ™Ü
(
mÚ™Ü
 *
m
) {

82 
i
;

83 
n
 = 
m
->
couÁ
;

84 
i
=0;i<
n
;i++) {

85 
	`skyÃt_mÚ™Ü_d–‘e
(
m
->m[
i
]);

87 
	`±h»ad_mu‹x_de¡roy
(&
m
->
mu‹x
);

88 
	`±h»ad_cÚd_de¡roy
(&
m
->
cÚd
);

89 
	`skyÃt_ä“
(
m
->m);

90 
	`skyÃt_ä“
(
m
);

91 
	}
}

94 
	$th»ad_mÚ™Ü
(*
p
) {

95 
mÚ™Ü
 * 
m
 = 
p
;

96 
i
;

97 
n
 = 
m
->
couÁ
;

98 
	`skyÃt_š™th»ad
(
THREAD_MONITOR
);

100 
CHECK_ABORT


101 
i
=0;i<
n
;i++) {

102 
	`skyÃt_mÚ™Ü_check
(
m
->m[
i
]);

104 
i
=0;i<5;i++) {

105 
CHECK_ABORT


106 
	`¦“p
(1);

110  
NULL
;

111 
	}
}

114 
	$sigÇl_hup
() {

117 
skyÃt_mes§ge
 
smsg
;

118 
smsg
.
sourû
 = 0;

119 
smsg
.
£ssiÚ
 = 0;

120 
smsg
.
d©a
 = 
NULL
;

121 
smsg
.
sz
 = (
size_t
)
PTYPE_SYSTEM
 << 
MESSAGE_TYPE_SHIFT
;

122 
ušt32_t
 
logg”
 = 
	`skyÃt_hªdË_fšdÇme
("logger");

123 ià(
logg”
) {

124 
	`skyÃt_cÚ‹xt_push
(
logg”
, &
smsg
);

126 
	}
}

129 
	$th»ad_tim”
(*
p
) {

130 
mÚ™Ü
 * 
m
 = 
p
;

131 
	`skyÃt_š™th»ad
(
THREAD_TIMER
);

133 
	`skyÃt_upd©‘ime
();

134 
CHECK_ABORT


135 
	`wakeup
(
m
,m->
couÁ
-1);

136 
	`u¦“p
(2500);

137 ià(
SIG
) {

138 
	`sigÇl_hup
();

139 
SIG
 = 0;

143 
	`skyÃt_sock‘_ex™
();

145 
	`±h»ad_mu‹x_lock
(&
m
->
mu‹x
);

146 
m
->
qu™
 = 1;

147 
	`±h»ad_cÚd_brßdÿ¡
(&
m
->
cÚd
);

148 
	`±h»ad_mu‹x_uÆock
(&
m
->
mu‹x
);

149  
NULL
;

150 
	}
}

153 
	$th»ad_wÜk”
(*
p
) {

154 
wÜk”_·rm
 *
wp
 = 
p
;

155 
id
 = 
wp
->id;

156 
weight
 = 
wp
->weight;

157 
mÚ™Ü
 *
m
 = 
wp
->m;

158 
skyÃt_mÚ™Ü
 *
sm
 = 
m
->m[
id
];

159 
	`skyÃt_š™th»ad
(
THREAD_WORKER
);

160 
mes§ge_queue
 * 
q
 = 
NULL
;

161 !
m
->
qu™
) {

162 
q
 = 
	`skyÃt_cÚ‹xt_mes§ge_di¥©ch
(
sm
, q, 
weight
);

163 ià(
q
 =ğ
NULL
) {

164 ià(
	`±h»ad_mu‹x_lock
(&
m
->
mu‹x
) == 0) {

165 ++ 
m
->
¦“p
;

168 ià(!
m
->
qu™
)

169 
	`±h»ad_cÚd_wa™
(&
m
->
cÚd
, &m->
mu‹x
);

170 -- 
m
->
¦“p
;

171 ià(
	`±h»ad_mu‹x_uÆock
(&
m
->
mu‹x
)) {

172 
	`årštf
(
¡d”r
, "unlock mutexƒrror");

173 
	`ex™
(1);

178  
NULL
;

179 
	}
}

182 
	$¡¬t
(
th»ad
) {

183 
±h»ad_t
 
pid
[
th»ad
+3];

185 
mÚ™Ü
 *
m
 = 
	`skyÃt_m®loc
((*m));

186 
	`mem£t
(
m
, 0, (*m));

187 
m
->
couÁ
 = 
th»ad
;

188 
m
->
¦“p
 = 0;

190 
m
->m = 
	`skyÃt_m®loc
(
th»ad
 * (
skyÃt_mÚ™Ü
 *));

191 
i
;

192 
i
=0;i<
th»ad
;i++) {

193 
m
->m[
i
] = 
	`skyÃt_mÚ™Ü_Ãw
();

195 ià(
	`±h»ad_mu‹x_š™
(&
m
->
mu‹x
, 
NULL
)) {

196 
	`årštf
(
¡d”r
, "Init mutexƒrror");

197 
	`ex™
(1);

199 ià(
	`±h»ad_cÚd_š™
(&
m
->
cÚd
, 
NULL
)) {

200 
	`årštf
(
¡d”r
, "Init condƒrror");

201 
	`ex™
(1);

204 
	`ü—‹_th»ad
(&
pid
[0], 
th»ad_mÚ™Ü
, 
m
);

205 
	`ü—‹_th»ad
(&
pid
[1], 
th»ad_tim”
, 
m
);

206 
	`ü—‹_th»ad
(&
pid
[2], 
th»ad_sock‘
, 
m
);

208 
weight
[] = {

213 
wÜk”_·rm
 
wp
[
th»ad
];

214 
i
=0;i<
th»ad
;i++) {

215 
wp
[
i
].
m
 = m;

216 
wp
[
i
].
id
 = i;

217 ià(
i
 < (
weight
)/(weight[0])) {

218 
wp
[
i
].
weight
= weight[i];

220 
wp
[
i
].
weight
 = 0;

222 
	`ü—‹_th»ad
(&
pid
[
i
+3], 
th»ad_wÜk”
, &
wp
[i]);

225 
i
=0;i<
th»ad
+3;i++) {

226 
	`±h»ad_još
(
pid
[
i
], 
NULL
);

229 
	`ä“_mÚ™Ü
(
m
);

230 
	}
}

233 
	$boÙ¡¿p
(
skyÃt_cÚ‹xt
 * 
logg”
, cÚ¡ * 
cmdlše
) {

234 
sz
 = 
	`¡¾’
(
cmdlše
);

235 
Çme
[
sz
+1];

236 
¬gs
[
sz
+1];

237 
	`ssÿnf
(
cmdlše
, "% %s", 
Çme
, 
¬gs
);

238 
skyÃt_cÚ‹xt
 *
ùx
 = 
	`skyÃt_cÚ‹xt_Ãw
(
Çme
, 
¬gs
);

239 ià(
ùx
 =ğ
NULL
) {

240 
	`skyÃt_”rÜ
(
NULL
, "BoÙ¡¿°”rÜ : %s\n", 
cmdlše
);

241 
	`skyÃt_cÚ‹xt_di¥©ch®l
(
logg”
);

242 
	`ex™
(1);

244 
	}
}

247 
	$skyÃt_¡¬t
(
skyÃt_cÚfig
 * 
cÚfig
) {

249 
sigaùiÚ
 
§
;

250 
§
.
§_hªdËr
 = &
hªdË_hup
;

251 
§
.
§_æags
 = 
SA_RESTART
;

252 
	`sigfl£t
(&
§
.
§_mask
);

253 
	`sigaùiÚ
(
SIGHUP
, &
§
, 
NULL
);

255 ià(
cÚfig
->
d«mÚ
) {

256 ià(
	`d«mÚ_š™
(
cÚfig
->
d«mÚ
)) {

257 
	`ex™
(1);

260 
	`skyÃt_h¬bÜ_š™
(
cÚfig
->
h¬bÜ
);

261 
	`skyÃt_hªdË_š™
(
cÚfig
->
h¬bÜ
);

262 
	`skyÃt_mq_š™
();

263 
	`skyÃt_moduË_š™
(
cÚfig
->
moduË_·th
);

264 
	`skyÃt_tim”_š™
();

265 
	`skyÃt_sock‘_š™
();

266 
	`skyÃt_´ofe_’abË
(
cÚfig
->
´ofe
);

268 
skyÃt_cÚ‹xt
 *
ùx
 = 
	`skyÃt_cÚ‹xt_Ãw
(
cÚfig
->
log£rviû
, cÚfig->
logg”
);

269 ià(
ùx
 =ğ
NULL
) {

270 
	`årštf
(
¡d”r
, "Cª'ˆÏunch % £rviû\n", 
cÚfig
->
log£rviû
);

271 
	`ex™
(1);

274 
	`boÙ¡¿p
(
ùx
, 
cÚfig
->
boÙ¡¿p
);

276 
	`¡¬t
(
cÚfig
->
th»ad
);

279 
	`skyÃt_h¬bÜ_ex™
();

280 
	`skyÃt_sock‘_ä“
();

281 ià(
cÚfig
->
d«mÚ
) {

282 
	`d«mÚ_ex™
(
cÚfig
->
d«mÚ
);

284 
	}
}

	@skynet-src/skynet_timer.c

1 
	~"skyÃt.h
"

3 
	~"skyÃt_tim”.h
"

4 
	~"skyÃt_mq.h
"

5 
	~"skyÃt_£rv”.h
"

6 
	~"skyÃt_hªdË.h
"

7 
	~"¥šlock.h
"

9 
	~<time.h
>

10 
	~<as£¹.h
>

11 
	~<¡ršg.h
>

12 
	~<¡dlib.h
>

13 
	~<¡dšt.h
>

15 #ià
defšed
(
__APPLE__
)

16 
	~<sys/time.h
>

17 
	~<mach/sk.h
>

18 
	~<mach/mach.h
>

21 (*
	ttim”_execu‹_func
)(*
	tud
,*
	t¬g
);

23 
	#TIME_NEAR_SHIFT
 8

	)

24 
	#TIME_NEAR
 (1 << 
TIME_NEAR_SHIFT
)

	)

25 
	#TIME_LEVEL_SHIFT
 6

	)

26 
	#TIME_LEVEL
 (1 << 
TIME_LEVEL_SHIFT
)

	)

27 
	#TIME_NEAR_MASK
 (
TIME_NEAR
-1)

	)

28 
	#TIME_LEVEL_MASK
 (
TIME_LEVEL
-1)

	)

30 
	stim”_ev’t
 {

31 
ušt32_t
 
hªdË
;

32 
£ssiÚ
;

35 
	stim”_node
 {

36 
tim”_node
 *
Ãxt
;

37 
ušt32_t
 
expœe
;

40 
	slšk_li¡
 {

41 
tim”_node
 
h—d
;

42 
tim”_node
 *

;

45 
	stim”
 {

46 
lšk_li¡
 
Ã¬
[
TIME_NEAR
];

47 
lšk_li¡
 
t
[4][
TIME_LEVEL
];

48 
¥šlock
 
lock
;

49 
ušt32_t
 
time
;

50 
ušt32_t
 
¡¬‰ime
;

51 
ušt64_t
 
cu¼’t
;

52 
ušt64_t
 
cu¼’t_pošt
;

55 
tim”
 * 
TI
 = 
NULL
;

57 
šlše
 
tim”_node
 *

58 
	$lšk_ş—r
(
lšk_li¡
 *
li¡
) {

59 
tim”_node
 * 
»t
 = 
li¡
->
h—d
.
Ãxt
;

60 
li¡
->
h—d
.
Ãxt
 = 0;

61 
li¡
->

 = &Öi¡->
h—d
);

63  
»t
;

64 
	}
}

66 
šlše
 

67 
	$lšk
(
lšk_li¡
 *
li¡
,
tim”_node
 *
node
) {

68 
li¡
->

->
Ãxt
 = 
node
;

69 
li¡
->

 = 
node
;

70 
node
->
Ãxt
=0;

71 
	}
}

74 
	$add_node
(
tim”
 *
T
,
tim”_node
 *
node
) {

75 
ušt32_t
 
time
=
node
->
expœe
;

76 
ušt32_t
 
cu¼’t_time
=
T
->
time
;

78 ià((
time
|
TIME_NEAR_MASK
)==(
cu¼’t_time
|TIME_NEAR_MASK)) {

79 
	`lšk
(&
T
->
Ã¬
[
time
&
TIME_NEAR_MASK
],
node
);

81 
i
;

82 
ušt32_t
 
mask
=
TIME_NEAR
 << 
TIME_LEVEL_SHIFT
;

83 
i
=0;i<3;i++) {

84 ià((
time
|(
mask
-1))==(
cu¼’t_time
|(mask-1))) {

87 
mask
 <<ğ
TIME_LEVEL_SHIFT
;

90 
	`lšk
(&
T
->
t
[
i
][((
time
>>(
TIME_NEAR_SHIFT
 + i*
TIME_LEVEL_SHIFT
)è& 
TIME_LEVEL_MASK
)],
node
);

92 
	}
}

95 
	$tim”_add
(
tim”
 *
T
,*
¬g
,
size_t
 
sz
,
time
) {

96 
tim”_node
 *
node
 = (tim”_nod*)
	`skyÃt_m®loc
((*node)+
sz
);

97 
	`memıy
(
node
+1,
¬g
,
sz
);

99 
	`SPIN_LOCK
(
T
);

101 
node
->
expœe
=
time
+
T
->time;

102 
	`add_node
(
T
,
node
);

104 
	`SPIN_UNLOCK
(
T
);

105 
	}
}

108 
	$move_li¡
(
tim”
 *
T
, 
Ëv–
, 
idx
) {

109 
tim”_node
 *
cu¼’t
 = 
	`lšk_ş—r
(&
T
->
t
[
Ëv–
][
idx
]);

110 
cu¼’t
) {

111 
tim”_node
 *
‹mp
=
cu¼’t
->
Ãxt
;

112 
	`add_node
(
T
,
cu¼’t
);

113 
cu¼’t
=
‹mp
;

115 
	}
}

118 
	$tim”_shiá
(
tim”
 *
T
) {

119 
mask
 = 
TIME_NEAR
;

120 
ušt32_t
 
ù
 = ++
T
->
time
;

121 ià(
ù
 == 0) {

122 
	`move_li¡
(
T
, 3, 0);

124 
ušt32_t
 
time
 = 
ù
 >> 
TIME_NEAR_SHIFT
;

125 
i
=0;

127 (
ù
 & (
mask
-1))==0) {

128 
idx
=
time
 & 
TIME_LEVEL_MASK
;

129 ià(
idx
!=0) {

130 
	`move_li¡
(
T
, 
i
, 
idx
);

133 
mask
 <<ğ
TIME_LEVEL_SHIFT
;

134 
time
 >>ğ
TIME_LEVEL_SHIFT
;

135 ++
i
;

138 
	}
}

140 
šlše
 

141 
	$di¥©ch_li¡
(
tim”_node
 *
cu¼’t
) {

143 
tim”_ev’t
 * 
ev’t
 = (tim”_ev’ˆ*)(
cu¼’t
+1);

144 
skyÃt_mes§ge
 
mes§ge
;

145 
mes§ge
.
sourû
 = 0;

146 
mes§ge
.
£ssiÚ
 = 
ev’t
->session;

147 
mes§ge
.
d©a
 = 
NULL
;

148 
mes§ge
.
sz
 = (
size_t
)
PTYPE_RESPONSE
 << 
MESSAGE_TYPE_SHIFT
;

150 
	`skyÃt_cÚ‹xt_push
(
ev’t
->
hªdË
, &
mes§ge
);

152 
tim”_node
 * 
‹mp
 = 
cu¼’t
;

153 
cu¼’t
=cu¼’t->
Ãxt
;

154 
	`skyÃt_ä“
(
‹mp
);

155 } 
cu¼’t
);

156 
	}
}

158 
šlše
 

159 
	$tim”_execu‹
(
tim”
 *
T
) {

160 
idx
 = 
T
->
time
 & 
TIME_NEAR_MASK
;

162 
T
->
Ã¬
[
idx
].
h—d
.
Ãxt
) {

163 
tim”_node
 *
cu¼’t
 = 
	`lšk_ş—r
(&
T
->
Ã¬
[
idx
]);

164 
	`SPIN_UNLOCK
(
T
);

166 
	`di¥©ch_li¡
(
cu¼’t
);

167 
	`SPIN_LOCK
(
T
);

169 
	}
}

172 
	$tim”_upd©e
(
tim”
 *
T
) {

173 
	`SPIN_LOCK
(
T
);

176 
	`tim”_execu‹
(
T
);

179 
	`tim”_shiá
(
T
);

181 
	`tim”_execu‹
(
T
);

183 
	`SPIN_UNLOCK
(
T
);

184 
	}
}

186 
tim”
 *

187 
	$tim”_ü—‹_tim”
() {

188 
tim”
 *
r
=(tim” *)
	`skyÃt_m®loc
((timer));

189 
	`mem£t
(
r
,0,(*r));

191 
i
,
j
;

193 
i
=0;i<
TIME_NEAR
;i++) {

194 
	`lšk_ş—r
(&
r
->
Ã¬
[
i
]);

197 
i
=0;i<4;i++) {

198 
j
=0;j<
TIME_LEVEL
;j++) {

199 
	`lšk_ş—r
(&
r
->
t
[
i
][
j
]);

203 
	`SPIN_INIT
(
r
)

205 
r
->
cu¼’t
 = 0;

207  
r
;

208 
	}
}

211 
	$skyÃt_timeout
(
ušt32_t
 
hªdË
, 
time
, 
£ssiÚ
) {

212 ià(
time
 <= 0) {

213 
skyÃt_mes§ge
 
mes§ge
;

214 
mes§ge
.
sourû
 = 0;

215 
mes§ge
.
£ssiÚ
 = session;

216 
mes§ge
.
d©a
 = 
NULL
;

217 
mes§ge
.
sz
 = (
size_t
)
PTYPE_RESPONSE
 << 
MESSAGE_TYPE_SHIFT
;

219 ià(
	`skyÃt_cÚ‹xt_push
(
hªdË
, &
mes§ge
)) {

223 
tim”_ev’t
 
ev’t
;

224 
ev’t
.
hªdË
 = handle;

225 
ev’t
.
£ssiÚ
 = session;

226 
	`tim”_add
(
TI
, &
ev’t
, Óv’t), 
time
);

229  
£ssiÚ
;

230 
	}
}

234 
	$sy¡ime
(
ušt32_t
 *
£c
, ušt32_ˆ*
cs
) {

235 #ià!
	`defšed
(
__APPLE__
)

236 
time¥ec
 
ti
;

237 
	`şock_g‘time
(
CLOCK_REALTIME
, &
ti
);

238 *
£c
 = (
ušt32_t
)
ti
.
tv_£c
;

239 *
cs
 = (
ušt32_t
)(
ti
.
tv_n£c
 / 10000000);

241 
timev®
 
tv
;

242 
	`g‘timeofday
(&
tv
, 
NULL
);

243 *
£c
 = 
tv
.
tv_£c
;

244 *
cs
 = 
tv
.
tv_u£c
 / 10000;

246 
	}
}

248 
ušt64_t


249 
	$g‘time
() {

250 
ušt64_t
 
t
;

251 #ià!
	`defšed
(
__APPLE__
)

252 
time¥ec
 
ti
;

253 
	`şock_g‘time
(
CLOCK_MONOTONIC
, &
ti
);

254 
t
 = (
ušt64_t
)
ti
.
tv_£c
 * 100;

255 
t
 +ğ
ti
.
tv_n£c
 / 10000000;

257 
timev®
 
tv
;

258 
	`g‘timeofday
(&
tv
, 
NULL
);

259 
t
 = (
ušt64_t
)
tv
.
tv_£c
 * 100;

260 
t
 +ğ
tv
.
tv_u£c
 / 10000;

262  
t
;

263 
	}
}

266 
	$skyÃt_upd©‘ime
() {

267 
ušt64_t
 
ı
 = 
	`g‘time
();

268 if(
ı
 < 
TI
->
cu¼’t_pošt
) {

269 
	`skyÃt_”rÜ
(
NULL
, "timdifà”rÜ: chªgäom %ÎdØ%Îd", 
ı
, 
TI
->
cu¼’t_pošt
);

270 
TI
->
cu¼’t_pošt
 = 
ı
;

271 } ià(
ı
 !ğ
TI
->
cu¼’t_pošt
) {

272 
ušt32_t
 
diff
 = (ušt32_t)(
ı
 - 
TI
->
cu¼’t_pošt
);

273 
TI
->
cu¼’t_pošt
 = 
ı
;

274 
TI
->
cu¼’t
 +ğ
diff
;

275 
i
;

276 
i
=0;i<
diff
;i++) {

277 
	`tim”_upd©e
(
TI
);

280 
	}
}

282 
ušt32_t


283 
	$skyÃt_¡¬‰ime
() {

284  
TI
->
¡¬‰ime
;

285 
	}
}

287 
ušt64_t


288 
	$skyÃt_now
() {

289  
TI
->
cu¼’t
;

290 
	}
}

293 
	$skyÃt_tim”_š™
() {

294 
TI
 = 
	`tim”_ü—‹_tim”
();

295 
ušt32_t
 
cu¼’t
 = 0;

296 
	`sy¡ime
(&
TI
->
¡¬‰ime
, &
cu¼’t
);

297 
TI
->
cu¼’t
 = current;

298 
TI
->
cu¼’t_pošt
 = 
	`g‘time
();

299 
	}
}

303 
	#NANOSEC
 1000000000

	)

304 
	#MICROSEC
 1000000

	)

306 
ušt64_t


307 
	$skyÃt_th»ad_time
() {

308 #ià !
	`defšed
(
__APPLE__
)

309 
time¥ec
 
ti
;

310 
	`şock_g‘time
(
CLOCK_THREAD_CPUTIME_ID
, &
ti
);

312  (
ušt64_t
)
ti
.
tv_£c
 * 
MICROSEC
 + (ušt64_téi.
tv_n£c
 / (
NANOSEC
 / MICROSEC);

314 
sk_th»ad_times_šfo
 
aTaskInfo
;

315 
mach_msg_ty³_numb”_t
 
aTaskInfoCouÁ
 = 
TASK_THREAD_TIMES_INFO_COUNT
;

316 ià(
KERN_SUCCESS
 !ğ
	`sk_šfo
(
	`mach_sk_£lf
(), 
TASK_THREAD_TIMES_INFO
, (
sk_šfo_t
 )&
aTaskInfo
, &
aTaskInfoCouÁ
)) {

320  (
ušt64_t
)(
aTaskInfo
.
u£r_time
.
£cÚds
è+ (ušt64_tïTaskInfo.u£r_time.
miüo£cÚds
;

322 
	}
}

	@skynet-src/skynet_timer.h

1 #iâdeà
SKYNET_TIMER_H


2 
	#SKYNET_TIMER_H


	)

4 
	~<¡dšt.h
>

6 
skyÃt_timeout
(
ušt32_t
 
hªdË
, 
time
, 
£ssiÚ
);

7 
skyÃt_upd©‘ime
();

8 
ušt32_t
 
skyÃt_¡¬‰ime
();

9 
ušt64_t
 
skyÃt_th»ad_time
();

11 
skyÃt_tim”_š™
();

	@skynet-src/socket_epoll.h

1 #iâdeà
pŞl_sock‘_•Şl_h


2 
	#pŞl_sock‘_•Şl_h


	)

4 
	~<Ãtdb.h
>

5 
	~<uni¡d.h
>

6 
	~<sys/•Şl.h
>

7 
	~<sys/ty³s.h
>

8 
	~<sys/sock‘.h
>

9 
	~<Ãtš‘/š.h
>

10 
	~<¬·/š‘.h
>

11 
	~<fú.h
>

13 
boŞ


14 
	$¥_šv®id
(
efd
) {

15  
efd
 == -1;

16 
	}
}

19 
	$¥_ü—‹
() {

20  
	`•Şl_ü—‹
(1024);

21 
	}
}

24 
	$¥_»Ëa£
(
efd
) {

25 
	`şo£
(
efd
);

26 
	}
}

29 
	$¥_add
(
efd
, 
sock
, *
ud
) {

30 
•Şl_ev’t
 
ev
;

31 
ev
.
ev’ts
 = 
EPOLLIN
;

32 
ev
.
d©a
.
±r
 = 
ud
;

33 ià(
	`•Şl_ùl
(
efd
, 
EPOLL_CTL_ADD
, 
sock
, &
ev
) == -1) {

37 
	}
}

40 
	$¥_d–
(
efd
, 
sock
) {

41 
	`•Şl_ùl
(
efd
, 
EPOLL_CTL_DEL
, 
sock
 , 
NULL
);

42 
	}
}

45 
	$¥_wr™e
(
efd
, 
sock
, *
ud
, 
boŞ
 
’abË
) {

46 
•Şl_ev’t
 
ev
;

47 
ev
.
ev’ts
 = 
EPOLLIN
 | (
’abË
 ? 
EPOLLOUT
 : 0);

48 
ev
.
d©a
.
±r
 = 
ud
;

49 
	`•Şl_ùl
(
efd
, 
EPOLL_CTL_MOD
, 
sock
, &
ev
);

50 
	}
}

53 
	$¥_wa™
(
efd
, 
ev’t
 *
e
, 
max
) {

54 
•Şl_ev’t
 
ev
[
max
];

55 
n
 = 
	`•Şl_wa™
(
efd
 , 
ev
, 
max
, -1);

56 
i
;

57 
i
=0;i<
n
;i++) {

58 
e
[
i
].
s
 = 
ev
[i].
d©a
.
±r
;

59 
æag
 = 
ev
[
i
].
ev’ts
;

60 
e
[
i
].
wr™e
 = (
æag
 & 
EPOLLOUT
) != 0;

61 
e
[
i
].
»ad
 = (
æag
 & (
EPOLLIN
 | 
EPOLLHUP
)) != 0;

62 
e
[
i
].
”rÜ
 = (
æag
 & 
EPOLLERR
) != 0;

65  
n
;

66 
	}
}

69 
	$¥_nÚblockšg
(
fd
) {

70 
æag
 = 
	`fú
(
fd
, 
F_GETFL
, 0);

71 iàĞ-1 =ğ
æag
 ) {

75 
	`fú
(
fd
, 
F_SETFL
, 
æag
 | 
O_NONBLOCK
);

76 
	}
}

	@skynet-src/socket_kqueue.h

1 #iâdeà
pŞl_sock‘_kqueue_h


2 
	#pŞl_sock‘_kqueue_h


	)

4 
	~<Ãtdb.h
>

5 
	~<uni¡d.h
>

6 
	~<fú.h
>

7 
	~<sys/ev’t.h
>

8 
	~<sys/ty³s.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/š.h
>

11 
	~<¬·/š‘.h
>

13 
boŞ


14 
	$¥_šv®id
(
kfd
) {

15  
kfd
 == -1;

16 
	}
}

19 
	$¥_ü—‹
() {

20  
	`kqueue
();

21 
	}
}

24 
	$¥_»Ëa£
(
kfd
) {

25 
	`şo£
(
kfd
);

26 
	}
}

29 
	$¥_d–
(
kfd
, 
sock
) {

30 
kev’t
 
ke
;

31 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

32 
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULL);

33 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_WRITE
, 
EV_DELETE
, 0, 0, 
NULL
);

34 
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULL);

35 
	}
}

38 
	$¥_add
(
kfd
, 
sock
, *
ud
) {

39 
kev’t
 
ke
;

40 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_READ
, 
EV_ADD
, 0, 0, 
ud
);

41 ià(
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULLè=ğ-1 || ke.
æags
 & 
EV_ERROR
) {

44 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_WRITE
, 
EV_ADD
, 0, 0, 
ud
);

45 ià(
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULLè=ğ-1 || ke.
æags
 & 
EV_ERROR
) {

46 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_READ
, 
EV_DELETE
, 0, 0, 
NULL
);

47 
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULL);

50 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_WRITE
, 
EV_DISABLE
, 0, 0, 
ud
);

51 ià(
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULLè=ğ-1 || ke.
æags
 & 
EV_ERROR
) {

52 
	`¥_d–
(
kfd
, 
sock
);

56 
	}
}

59 
	$¥_wr™e
(
kfd
, 
sock
, *
ud
, 
boŞ
 
’abË
) {

60 
kev’t
 
ke
;

61 
	`EV_SET
(&
ke
, 
sock
, 
EVFILT_WRITE
, 
’abË
 ? 
EV_ENABLE
 : 
EV_DISABLE
, 0, 0, 
ud
);

62 ià(
	`kev’t
(
kfd
, &
ke
, 1, 
NULL
, 0, NULLè=ğ-1 || ke.
æags
 & 
EV_ERROR
) {

65 
	}
}

68 
	$¥_wa™
(
kfd
, 
ev’t
 *
e
, 
max
) {

69 
kev’t
 
ev
[
max
];

70 
n
 = 
	`kev’t
(
kfd
, 
NULL
, 0, 
ev
, 
max
, NULL);

72 
i
;

73 
i
=0;i<
n
;i++) {

74 
e
[
i
].
s
 = 
ev
[i].
ud©a
;

75 
f‹r
 = 
ev
[
i
].filter;

76 
e
[
i
].
wr™e
 = (
f‹r
 =ğ
EVFILT_WRITE
);

77 
e
[
i
].
»ad
 = (
f‹r
 =ğ
EVFILT_READ
);

78 
e
[
i
].
”rÜ
 = 
çl£
;

81  
n
;

82 
	}
}

85 
	$¥_nÚblockšg
(
fd
) {

86 
æag
 = 
	`fú
(
fd
, 
F_GETFL
, 0);

87 iàĞ-1 =ğ
æag
 ) {

91 
	`fú
(
fd
, 
F_SETFL
, 
æag
 | 
O_NONBLOCK
);

92 
	}
}

	@skynet-src/socket_poll.h

1 #iâdeà
sock‘_pŞl_h


2 
	#sock‘_pŞl_h


	)

4 
	~<¡dboŞ.h
>

6 
	tpŞl_fd
;

8 
	sev’t
 {

9 * 
	ms
;

10 
boŞ
 
	m»ad
;

11 
boŞ
 
	mwr™e
;

12 
boŞ
 
	m”rÜ
;

15 
boŞ
 
¥_šv®id
(
pŞl_fd
 
fd
);

16 
pŞl_fd
 
¥_ü—‹
();

17 
¥_»Ëa£
(
pŞl_fd
 
fd
);

18 
¥_add
(
pŞl_fd
 
fd
, 
sock
, *
ud
);

19 
¥_d–
(
pŞl_fd
 
fd
, 
sock
);

20 
¥_wr™e
(
pŞl_fd
, 
sock
, *
ud
, 
boŞ
 
’abË
);

21 
¥_wa™
(
pŞl_fd
, 
ev’t
 *
e
, 
max
);

22 
¥_nÚblockšg
(
sock
);

24 #ifdeà
__lšux__


25 
	~"sock‘_•Şl.h
"

28 #ià
defšed
(
__APPLE__
è|| defšed(
__F»eBSD__
è|| defšed(
__O³nBSD__
è|| defšed (
__N‘BSD__
)

29 
	~"sock‘_kqueue.h
"

	@skynet-src/socket_server.c

1 
	~"skyÃt.h
"

3 
	~"sock‘_£rv”.h
"

4 
	~"sock‘_pŞl.h
"

5 
	~"©omic.h
"

6 
	~"¥šlock.h
"

8 
	~<sys/ty³s.h
>

9 
	~<sys/sock‘.h
>

10 
	~<Ãtš‘/tı.h
>

11 
	~<uni¡d.h
>

12 
	~<”ºo.h
>

13 
	~<¡dlib.h
>

14 
	~<¡dboŞ.h
>

15 
	~<¡dio.h
>

16 
	~<¡dšt.h
>

17 
	~<as£¹.h
>

18 
	~<¡ršg.h
>

20 
	#MAX_INFO
 128

	)

22 
	#MAX_SOCKET_P
 16

	)

23 
	#MAX_EVENT
 64

	)

24 
	#MIN_READ_BUFFER
 64

	)

25 
	#SOCKET_TYPE_INVALID
 0

	)

26 
	#SOCKET_TYPE_RESERVE
 1

	)

27 
	#SOCKET_TYPE_PLISTEN
 2

	)

28 
	#SOCKET_TYPE_LISTEN
 3

	)

29 
	#SOCKET_TYPE_CONNECTING
 4

	)

30 
	#SOCKET_TYPE_CONNECTED
 5

	)

31 
	#SOCKET_TYPE_HALFCLOSE
 6

	)

32 
	#SOCKET_TYPE_PACCEPT
 7

	)

33 
	#SOCKET_TYPE_BIND
 8

	)

35 
	#MAX_SOCKET
 (1<<
MAX_SOCKET_P
)

	)

37 
	#PRIORITY_HIGH
 0

	)

38 
	#PRIORITY_LOW
 1

	)

40 
	#HASH_ID
(
id
è((()idè% 
MAX_SOCKET
)

	)

42 
	#PROTOCOL_TCP
 0

	)

43 
	#PROTOCOL_UDP
 1

	)

44 
	#PROTOCOL_UDPv6
 2

	)

46 
	#UDP_ADDRESS_SIZE
 19

47 

	)

48 
	#MAX_UDP_PACKAGE
 65535

	)

51 #ià(
EAGAIN
 !ğ
EWOULDBLOCK
)

52 
	#AGAIN_WOULDBLOCK
 
EAGAIN
 : 
EWOULDBLOCK


	)

54 
	#AGAIN_WOULDBLOCK
 
EAGAIN


	)

57 
	#WARNING_SIZE
 (1024*1024)

	)

59 
	swr™e_bufãr
 {

60 
wr™e_bufãr
 * 
	mÃxt
;

61 *
	mbufãr
;

62 *
	m±r
;

63 
	msz
;

64 
boŞ
 
	mu£robjeù
;

65 
ušt8_t
 
	mudp_add»ss
[
UDP_ADDRESS_SIZE
];

68 
	#SIZEOF_TCPBUFFER
 (
	`off£tof
(
wr™e_bufãr
, 
udp_add»ss
[0]))

	)

69 
	#SIZEOF_UDPBUFFER
 ((
wr™e_bufãr
))

	)

71 
	swb_li¡
 {

72 
wr™e_bufãr
 * 
	mh—d
;

73 
wr™e_bufãr
 * 
	m
;

76 
	ssock‘
 {

77 
ušŒ_t
 
	mİaque
;

78 
wb_li¡
 
	mhigh
;

79 
wb_li¡
 
	mlow
;

80 
št64_t
 
	mwb_size
;

81 
	mfd
;

82 
	mid
;

83 
ušt8_t
 
	m´ÙocŞ
;

84 
ušt8_t
 
	mty³
;

85 
ušt16_t
 
	mudpcÚÃùšg
;

86 
št64_t
 
	mw¬n_size
;

88 
	msize
;

89 
ušt8_t
 
	mudp_add»ss
[
UDP_ADDRESS_SIZE
];

90 } 
	mp
;

91 
¥šlock
 
	mdw_lock
;

92 
	mdw_off£t
;

93 cÚ¡ * 
	mdw_bufãr
;

94 
size_t
 
	mdw_size
;

97 
	ssock‘_£rv”
 {

98 
	m»cvù¾_fd
;

99 
	m£ndù¾_fd
;

100 
	mcheckù¾
;

101 
pŞl_fd
 
	mev’t_fd
;

102 
	m®loc_id
;

103 
	mev’t_n
;

104 
	mev’t_šdex
;

105 
sock‘_objeù_š‹rçû
 
	msoi
;

106 
ev’t
 
	mev
[
MAX_EVENT
];

107 
sock‘
 
	m¦Ù
[
MAX_SOCKET
];

108 
	mbufãr
[
MAX_INFO
];

109 
ušt8_t
 
	mudpbufãr
[
MAX_UDP_PACKAGE
];

110 
fd_£t
 
	mrfds
;

113 
	s»que¡_İ’
 {

114 
	mid
;

115 
	mpÜt
;

116 
ušŒ_t
 
	mİaque
;

117 
	mho¡
[1];

120 
	s»que¡_£nd
 {

121 
	mid
;

122 
	msz
;

123 * 
	mbufãr
;

126 
	s»que¡_£nd_udp
 {

127 
»que¡_£nd
 
	m£nd
;

128 
ušt8_t
 
	madd»ss
[
UDP_ADDRESS_SIZE
];

131 
	s»que¡_£tudp
 {

132 
	mid
;

133 
ušt8_t
 
	madd»ss
[
UDP_ADDRESS_SIZE
];

136 
	s»que¡_şo£
 {

137 
	mid
;

138 
	mshutdown
;

139 
ušŒ_t
 
	mİaque
;

142 
	s»que¡_li¡’
 {

143 
	mid
;

144 
	mfd
;

145 
ušŒ_t
 
	mİaque
;

146 
	mho¡
[1];

149 
	s»que¡_bšd
 {

150 
	mid
;

151 
	mfd
;

152 
ušŒ_t
 
	mİaque
;

155 
	s»que¡_¡¬t
 {

156 
	mid
;

157 
ušŒ_t
 
	mİaque
;

160 
	s»que¡_£tİt
 {

161 
	mid
;

162 
	mwh©
;

163 
	mv®ue
;

166 
	s»que¡_udp
 {

167 
	mid
;

168 
	mfd
;

169 
	mçmy
;

170 
ušŒ_t
 
	mİaque
;

190 
	s»que¡_·ckage
 {

191 
ušt8_t
 
	mh—d”
[8];

193 
	mbufãr
[256];

194 
»que¡_İ’
 
	mİ’
;

195 
»que¡_£nd
 
	m£nd
;

196 
»que¡_£nd_udp
 
	m£nd_udp
;

197 
»que¡_şo£
 
	mşo£
;

198 
»que¡_li¡’
 
	mli¡’
;

199 
»que¡_bšd
 
	mbšd
;

200 
»que¡_¡¬t
 
	m¡¬t
;

201 
»que¡_£tİt
 
	m£tİt
;

202 
»que¡_udp
 
	mudp
;

203 
»que¡_£tudp
 
	m£t_udp
;

204 } 
	mu
;

205 
ušt8_t
 
	mdummy
[256];

208 
	usockaddr_®l
 {

209 
sockaddr
 
	ms
;

210 
sockaddr_š
 
	mv4
;

211 
sockaddr_š6
 
	mv6
;

214 
	s£nd_objeù
 {

215 * 
	mbufãr
;

216 
	msz
;

217 (*
	mä“_func
)(*);

220 
	#MALLOC
 
skyÃt_m®loc


	)

221 
	#FREE
 
skyÃt_ä“


	)

223 
	ssock‘_lock
 {

224 
¥šlock
 *
	mlock
;

225 
	mcouÁ
;

228 
šlše
 

229 
	$sock‘_lock_š™
(
sock‘
 *
s
, 
sock‘_lock
 *
¦
) {

230 
¦
->
lock
 = &
s
->
dw_lock
;

231 
¦
->
couÁ
 = 0;

232 
	}
}

234 
šlše
 

235 
	$sock‘_lock
(
sock‘_lock
 *
¦
) {

236 ià(
¦
->
couÁ
 == 0) {

237 
	`¥šlock_lock
(
¦
->
lock
);

239 ++
¦
->
couÁ
;

240 
	}
}

242 
šlše
 

243 
	$sock‘_Œylock
(
sock‘_lock
 *
¦
) {

244 ià(
¦
->
couÁ
 == 0) {

245 ià(!
	`¥šlock_Œylock
(
¦
->
lock
))

248 ++
¦
->
couÁ
;

250 
	}
}

252 
šlše
 

253 
	$sock‘_uÆock
(
sock‘_lock
 *
¦
) {

254 --
¦
->
couÁ
;

255 ià(
¦
->
couÁ
 <= 0) {

256 
	`as£¹
(
¦
->
couÁ
 == 0);

257 
	`¥šlock_uÆock
(
¦
->
lock
);

259 
	}
}

261 
šlše
 
boŞ


262 
	$£nd_objeù_š™
(
sock‘_£rv”
 *
ss
, 
£nd_objeù
 *
so
, *
objeù
, 
sz
) {

263 ià(
sz
 < 0) {

264 
so
->
bufãr
 = 
ss
->
soi
.
	`bufãr
(
objeù
);

265 
so
->
sz
 = 
ss
->
soi
.
	`size
(
objeù
);

266 
so
->
ä“_func
 = 
ss
->
soi
.
ä“
;

267  
Œue
;

269 
so
->
bufãr
 = 
objeù
;

270 
so
->
sz
 = sz;

271 
so
->
ä“_func
 = 
FREE
;

272  
çl£
;

274 
	}
}

276 
šlše
 

277 
	$wr™e_bufãr_ä“
(
sock‘_£rv”
 *
ss
, 
wr™e_bufãr
 *
wb
) {

278 ià(
wb
->
u£robjeù
) {

279 
ss
->
soi
.
	`ä“
(
wb
->
bufãr
);

281 
	`FREE
(
wb
->
bufãr
);

283 
	`FREE
(
wb
);

284 
	}
}

287 
	$sock‘_k“·live
(
fd
) {

288 
k“·live
 = 1;

289 
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
, (*)&
k“·live
 , (keepalive));

290 
	}
}

293 
	$»£rve_id
(
sock‘_£rv”
 *
ss
) {

294 
i
;

295 
i
=0;i<
MAX_SOCKET
;i++) {

296 
id
 = 
	`ATOM_INC
(&(
ss
->
®loc_id
));

297 ià(
id
 < 0) {

298 
id
 = 
	`ATOM_AND
(&(
ss
->
®loc_id
), 0x7fffffff);

300 
sock‘
 *
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

301 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

302 ià(
	`ATOM_CAS
(&
s
->
ty³
, 
SOCKET_TYPE_INVALID
, 
SOCKET_TYPE_RESERVE
)) {

303 
s
->
id
 = id;

306 
s
->
udpcÚÃùšg
 = 0;

307 
s
->
fd
 = -1;

308  
id
;

311 --
i
;

316 
	}
}

318 
šlše
 

319 
	$ş—r_wb_li¡
(
wb_li¡
 *
li¡
) {

320 
li¡
->
h—d
 = 
NULL
;

321 
li¡
->

 = 
NULL
;

322 
	}
}

324 
sock‘_£rv”
 *

325 
	$sock‘_£rv”_ü—‹
() {

326 
i
;

327 
fd
[2];

328 
pŞl_fd
 
efd
 = 
	`¥_ü—‹
();

329 ià(
	`¥_šv®id
(
efd
)) {

330 
	`årštf
(
¡d”r
, "socket-server: createƒvent…ool failed.\n");

331  
NULL
;

333 ià(
	`pe
(
fd
)) {

334 
	`¥_»Ëa£
(
efd
);

335 
	`årštf
(
¡d”r
, "socket-server: create socket…air failed.\n");

336  
NULL
;

338 ià(
	`¥_add
(
efd
, 
fd
[0], 
NULL
)) {

340 
	`årštf
(
¡d”r
, "socket-server: can't‡dd server fdoƒvent…ool.\n");

341 
	`şo£
(
fd
[0]);

342 
	`şo£
(
fd
[1]);

343 
	`¥_»Ëa£
(
efd
);

344  
NULL
;

347 
sock‘_£rv”
 *
ss
 = 
	`MALLOC
((*ss));

348 
ss
->
ev’t_fd
 = 
efd
;

349 
ss
->
»cvù¾_fd
 = 
fd
[0];

350 
ss
->
£ndù¾_fd
 = 
fd
[1];

351 
ss
->
checkù¾
 = 1;

353 
i
=0;i<
MAX_SOCKET
;i++) {

354 
sock‘
 *
s
 = &
ss
->
¦Ù
[
i
];

355 
s
->
ty³
 = 
SOCKET_TYPE_INVALID
;

356 
	`ş—r_wb_li¡
(&
s
->
high
);

357 
	`ş—r_wb_li¡
(&
s
->
low
);

359 
ss
->
®loc_id
 = 0;

360 
ss
->
ev’t_n
 = 0;

361 
ss
->
ev’t_šdex
 = 0;

362 
	`mem£t
(&
ss
->
soi
, 0, (ss->soi));

363 
	`FD_ZERO
(&
ss
->
rfds
);

364 
	`as£¹
(
ss
->
»cvù¾_fd
 < 
FD_SETSIZE
);

366  
ss
;

367 
	}
}

370 
	$ä“_wb_li¡
(
sock‘_£rv”
 *
ss
, 
wb_li¡
 *
li¡
) {

371 
wr™e_bufãr
 *
wb
 = 
li¡
->
h—d
;

372 
wb
) {

373 
wr™e_bufãr
 *
tmp
 = 
wb
;

374 
wb
 = wb->
Ãxt
;

375 
	`wr™e_bufãr_ä“
(
ss
, 
tmp
);

377 
li¡
->
h—d
 = 
NULL
;

378 
li¡
->

 = 
NULL
;

379 
	}
}

382 
	$ä“_bufãr
(
sock‘_£rv”
 *
ss
, cÚ¡ * 
bufãr
, 
sz
) {

383 
£nd_objeù
 
so
;

384 
	`£nd_objeù_š™
(
ss
, &
so
, (*)
bufãr
, 
sz
);

385 
so
.
	`ä“_func
((*)
bufãr
);

386 
	}
}

389 
	$fÜû_şo£
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 *
»suÉ
) {

390 
»suÉ
->
id
 = 
s
->id;

391 
»suÉ
->
ud
 = 0;

392 
»suÉ
->
d©a
 = 
NULL
;

393 
»suÉ
->
İaque
 = 
s
->opaque;

394 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

397 
	`as£¹
(
s
->
ty³
 !ğ
SOCKET_TYPE_RESERVE
);

398 
	`ä“_wb_li¡
(
ss
,&
s
->
high
);

399 
	`ä“_wb_li¡
(
ss
,&
s
->
low
);

400 ià(
s
->
ty³
 !ğ
SOCKET_TYPE_PACCEPT
 && s->ty³ !ğ
SOCKET_TYPE_PLISTEN
) {

401 
	`¥_d–
(
ss
->
ev’t_fd
, 
s
->
fd
);

403 
	`sock‘_lock
(
l
);

404 ià(
s
->
ty³
 !ğ
SOCKET_TYPE_BIND
) {

405 ià(
	`şo£
(
s
->
fd
) < 0) {

406 
	`³¼Ü
("close socket:");

409 
s
->
ty³
 = 
SOCKET_TYPE_INVALID
;

410 ià(
s
->
dw_bufãr
) {

411 
	`ä“_bufãr
(
ss
, 
s
->
dw_bufãr
, s->
dw_size
);

412 
s
->
dw_bufãr
 = 
NULL
;

414 
	`sock‘_uÆock
(
l
);

415 
	}
}

418 
	$sock‘_£rv”_»Ëa£
(
sock‘_£rv”
 *
ss
) {

419 
i
;

420 
sock‘_mes§ge
 
dummy
;

421 
i
=0;i<
MAX_SOCKET
;i++) {

422 
sock‘
 *
s
 = &
ss
->
¦Ù
[
i
];

423 
sock‘_lock
 
l
;

424 
	`sock‘_lock_š™
(
s
, &
l
);

425 ià(
s
->
ty³
 !ğ
SOCKET_TYPE_RESERVE
) {

426 
	`fÜû_şo£
(
ss
, 
s
, &
l
, &
dummy
);

429 
	`şo£
(
ss
->
£ndù¾_fd
);

430 
	`şo£
(
ss
->
»cvù¾_fd
);

431 
	`¥_»Ëa£
(
ss
->
ev’t_fd
);

432 
	`FREE
(
ss
);

433 
	}
}

435 
šlše
 

436 
	$check_wb_li¡
(
wb_li¡
 *
s
) {

437 
	`as£¹
(
s
->
h—d
 =ğ
NULL
);

438 
	`as£¹
(
s
->

 =ğ
NULL
);

439 
	}
}

441 
sock‘
 *

442 
	$Ãw_fd
(
sock‘_£rv”
 *
ss
, 
id
, 
fd
, 
´ÙocŞ
, 
ušŒ_t
 
İaque
, 
boŞ
 
add
) {

443 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

444 
	`as£¹
(
s
->
ty³
 =ğ
SOCKET_TYPE_RESERVE
);

446 ià(
add
) {

447 ià(
	`¥_add
(
ss
->
ev’t_fd
, 
fd
, 
s
)) {

448 
s
->
ty³
 = 
SOCKET_TYPE_INVALID
;

449  
NULL
;

453 
s
->
id
 = id;

454 
s
->
fd
 = fd;

455 
s
->
´ÙocŞ
 =…rotocol;

456 
s
->
p
.
size
 = 
MIN_READ_BUFFER
;

457 
s
->
İaque
 = opaque;

458 
s
->
wb_size
 = 0;

459 
s
->
w¬n_size
 = 0;

460 
	`check_wb_li¡
(&
s
->
high
);

461 
	`check_wb_li¡
(&
s
->
low
);

462 
	`¥šlock_š™
(&
s
->
dw_lock
);

463 
s
->
dw_bufãr
 = 
NULL
;

464 
s
->
dw_size
 = 0;

465  
s
;

466 
	}
}

470 
	$İ’_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_İ’
 * 
»que¡
, 
sock‘_mes§ge
 *
»suÉ
) {

471 
id
 = 
»que¡
->id;

472 
»suÉ
->
İaque
 = 
»que¡
->opaque;

473 
»suÉ
->
id
 = id;

474 
»suÉ
->
ud
 = 0;

475 
»suÉ
->
d©a
 = 
NULL
;

476 
sock‘
 *
ns
;

477 
¡©us
;

478 
addršfo
 
ai_hšts
;

479 
addršfo
 *
ai_li¡
 = 
NULL
;

480 
addršfo
 *
ai_±r
 = 
NULL
;

481 
pÜt
[16];

482 
	`¥rštf
(
pÜt
, "%d", 
»que¡
->port);

483 
	`mem£t
(&
ai_hšts
, 0, (‡i_hints ) );

484 
ai_hšts
.
ai_çmy
 = 
AF_UNSPEC
;

485 
ai_hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

486 
ai_hšts
.
ai_´ÙocŞ
 = 
IPPROTO_TCP
;

488 
¡©us
 = 
	`g‘addršfo
Ğ
»que¡
->
ho¡
, 
pÜt
, &
ai_hšts
, &
ai_li¡
 );

489 iàĞ
¡©us
 != 0 ) {

490 
»suÉ
->
d©a
 = (*)
	`gai_¡»¼Ü
(
¡©us
);

491 
_çed
;

493 
sock
= -1;

494 
ai_±r
 = 
ai_li¡
;‡i_±¸!ğ
NULL
;‡i_±¸ğai_±r->
ai_Ãxt
 ) {

495 
sock
 = 
	`sock‘
Ğ
ai_±r
->
ai_çmy
,‡i_±r->
ai_sockty³
,‡i_±r->
ai_´ÙocŞ
 );

496 iàĞ
sock
 < 0 ) {

499 
	`sock‘_k“·live
(
sock
);

500 
	`¥_nÚblockšg
(
sock
);

501 
¡©us
 = 
	`cÚÃù
Ğ
sock
, 
ai_±r
->
ai_addr
,‡i_±r->
ai_add¾’
);

502 iàĞ
¡©us
 !ğ0 && 
”ºo
 !ğ
EINPROGRESS
) {

503 
	`şo£
(
sock
);

504 
sock
 = -1;

510 ià(
sock
 < 0) {

511 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”ºo
);

512 
_çed
;

515 
ns
 = 
	`Ãw_fd
(
ss
, 
id
, 
sock
, 
PROTOCOL_TCP
, 
»que¡
->
İaque
, 
Œue
);

516 ià(
ns
 =ğ
NULL
) {

517 
	`şo£
(
sock
);

518 
»suÉ
->
d©a
 = "reach skynet socket‚umber†imit";

519 
_çed
;

522 if(
¡©us
 == 0) {

523 
ns
->
ty³
 = 
SOCKET_TYPE_CONNECTED
;

524 
sockaddr
 * 
addr
 = 
ai_±r
->
ai_addr
;

525 * 
sš_addr
 = (
ai_±r
->
ai_çmy
 =ğ
AF_INET
è? (*)&((
sockaddr_š
 *)
addr
)->sš_add¸: (*)&((
sockaddr_š6
 *ïddr)->
sš6_addr
;

526 ià(
	`š‘_Áİ
(
ai_±r
->
ai_çmy
, 
sš_addr
, 
ss
->
bufãr
, (ss->buffer))) {

527 
»suÉ
->
d©a
 = 
ss
->
bufãr
;

529 
	`ä“addršfo
Ğ
ai_li¡
 );

530  
SOCKET_OPEN
;

532 
ns
->
ty³
 = 
SOCKET_TYPE_CONNECTING
;

533 
	`¥_wr™e
(
ss
->
ev’t_fd
, 
ns
->
fd
,‚s, 
Œue
);

536 
	`ä“addršfo
Ğ
ai_li¡
 );

538 
_çed
:

539 
	`ä“addršfo
Ğ
ai_li¡
 );

540 
ss
->
¦Ù
[
	`HASH_ID
(
id
)].
ty³
 = 
SOCKET_TYPE_INVALID
;

541  
SOCKET_ERR
;

542 
	}
}

545 
	$£nd_li¡_tı
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
wb_li¡
 *
li¡
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 *
»suÉ
) {

546 
li¡
->
h—d
) {

547 
wr™e_bufãr
 * 
tmp
 = 
li¡
->
h—d
;

549 
ssize_t
 
sz
 = 
	`wr™e
(
s
->
fd
, 
tmp
->
±r
,mp->sz);

550 ià(
sz
 < 0) {

551 
”ºo
) {

552 
EINTR
:

554 
AGAIN_WOULDBLOCK
:

557 
	`fÜû_şo£
(
ss
,
s
,
l
,
»suÉ
);

558  
SOCKET_CLOSE
;

560 
s
->
wb_size
 -ğ
sz
;

561 ià(
sz
 !ğ
tmp
->sz) {

562 
tmp
->
±r
 +ğ
sz
;

563 
tmp
->
sz
 -= sz;

568 
li¡
->
h—d
 = 
tmp
->
Ãxt
;

569 
	`wr™e_bufãr_ä“
(
ss
,
tmp
);

571 
li¡
->

 = 
NULL
;

574 
	}
}

576 
sockËn_t


577 
	$udp_sock‘_add»ss
(
sock‘
 *
s
, cÚ¡ 
ušt8_t
 
udp_add»ss
[
UDP_ADDRESS_SIZE
], 
sockaddr_®l
 *
§
) {

578 
ty³
 = (
ušt8_t
)
udp_add»ss
[0];

579 ià(
ty³
 !ğ
s
->
´ÙocŞ
)

581 
ušt16_t
 
pÜt
 = 0;

582 
	`memıy
(&
pÜt
, 
udp_add»ss
+1, (
ušt16_t
));

583 
s
->
´ÙocŞ
) {

584 
PROTOCOL_UDP
:

585 
	`mem£t
(&
§
->
v4
, 0, (sa->v4));

586 
§
->
s
.
§_çmy
 = 
AF_INET
;

587 
§
->
v4
.
sš_pÜt
 = 
pÜt
;

588 
	`memıy
(&
§
->
v4
.
sš_addr
, 
udp_add»ss
 + 1 + (
ušt16_t
), (sa->v4.sin_addr));

589  (
§
->
v4
);

590 
PROTOCOL_UDPv6
:

591 
	`mem£t
(&
§
->
v6
, 0, (sa->v6));

592 
§
->
s
.
§_çmy
 = 
AF_INET6
;

593 
§
->
v6
.
sš6_pÜt
 = 
pÜt
;

594 
	`memıy
(&
§
->
v6
.
sš6_addr
, 
udp_add»ss
 + 1 + (
ušt16_t
), (sa->v6.sin6_addr));

595  (
§
->
v6
);

598 
	}
}

601 
	$£nd_li¡_udp
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
wb_li¡
 *
li¡
, 
sock‘_mes§ge
 *
»suÉ
) {

602 
li¡
->
h—d
) {

603 
wr™e_bufãr
 * 
tmp
 = 
li¡
->
h—d
;

604 
sockaddr_®l
 
§
;

605 
sockËn_t
 
§sz
 = 
	`udp_sock‘_add»ss
(
s
, 
tmp
->
udp_add»ss
, &
§
);

606 
”r
 = 
	`£ndto
(
s
->
fd
, 
tmp
->
±r
,mp->
sz
, 0, &
§
.s, 
§sz
);

607 ià(
”r
 < 0) {

608 
”ºo
) {

609 
EINTR
:

610 
AGAIN_WOULDBLOCK
:

613 
	`årštf
(
¡d”r
, "sock‘-£rv” : ud°(%dè£ndtØ”rÜ %s.\n",
s
->
id
, 
	`¡»¼Ü
(
”ºo
));

626 
s
->
wb_size
 -ğ
tmp
->
sz
;

627 
li¡
->
h—d
 = 
tmp
->
Ãxt
;

628 
	`wr™e_bufãr_ä“
(
ss
,
tmp
);

630 
li¡
->

 = 
NULL
;

633 
	}
}

636 
	$£nd_li¡
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
wb_li¡
 *
li¡
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 *
»suÉ
) {

637 ià(
s
->
´ÙocŞ
 =ğ
PROTOCOL_TCP
) {

638  
	`£nd_li¡_tı
(
ss
, 
s
, 
li¡
, 
l
, 
»suÉ
);

640  
	`£nd_li¡_udp
(
ss
, 
s
, 
li¡
, 
»suÉ
);

642 
	}
}

644 
šlše
 

645 
	$li¡_uncom¶‘e
(
wb_li¡
 *
s
) {

646 
wr™e_bufãr
 *
wb
 = 
s
->
h—d
;

647 ià(
wb
 =ğ
NULL
)

650  (*)
wb
->
±r
 !ğwb->
bufãr
;

651 
	}
}

654 
	$¿i£_uncom¶‘e
(
sock‘
 * 
s
) {

655 
wb_li¡
 *
low
 = &
s
->low;

656 
wr™e_bufãr
 *
tmp
 = 
low
->
h—d
;

657 
low
->
h—d
 = 
tmp
->
Ãxt
;

658 ià(
low
->
h—d
 =ğ
NULL
) {

659 
low
->

 = 
NULL
;

663 
wb_li¡
 *
high
 = &
s
->high;

664 
	`as£¹
(
high
->
h—d
 =ğ
NULL
);

666 
tmp
->
Ãxt
 = 
NULL
;

667 
high
->
h—d
 = high->

 = 
tmp
;

668 
	}
}

670 
šlše
 

671 
	$£nd_bufãr_em±y
(
sock‘
 *
s
) {

672  (
s
->
high
.
h—d
 =ğ
NULL
 && s->
low
.head == NULL);

673 
	}
}

684 
	$£nd_bufãr_
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 *
»suÉ
) {

685 
	`as£¹
(!
	`li¡_uncom¶‘e
(&
s
->
low
));

687 ià(
	`£nd_li¡
(
ss
,
s
,&s->
high
,
l
,
»suÉ
è=ğ
SOCKET_CLOSE
) {

688  
SOCKET_CLOSE
;

690 ià(
s
->
high
.
h—d
 =ğ
NULL
) {

692 ià(
s
->
low
.
h—d
 !ğ
NULL
) {

693 ià(
	`£nd_li¡
(
ss
,
s
,&s->
low
,
l
,
»suÉ
è=ğ
SOCKET_CLOSE
) {

694  
SOCKET_CLOSE
;

697 ià(
	`li¡_uncom¶‘e
(&
s
->
low
)) {

698 
	`¿i£_uncom¶‘e
(
s
);

703 
	`as£¹
(
	`£nd_bufãr_em±y
(
s
è&& s->
wb_size
 == 0);

704 
	`¥_wr™e
(
ss
->
ev’t_fd
, 
s
->
fd
, s, 
çl£
);

706 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_HALFCLOSE
) {

707 
	`fÜû_şo£
(
ss
, 
s
, 
l
, 
»suÉ
);

708  
SOCKET_CLOSE
;

710 if(
s
->
w¬n_size
 > 0){

711 
s
->
w¬n_size
 = 0;

712 
»suÉ
->
İaque
 = 
s
->opaque;

713 
»suÉ
->
id
 = 
s
->id;

714 
»suÉ
->
ud
 = 0;

715 
»suÉ
->
d©a
 = 
NULL
;

716  
SOCKET_WARNING
;

721 
	}
}

724 
	$£nd_bufãr
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 *
»suÉ
) {

725 ià(!
	`sock‘_Œylock
(
l
))

727 ià(
s
->
dw_bufãr
) {

729 
wr™e_bufãr
 * 
buf
 = 
	`MALLOC
(
SIZEOF_TCPBUFFER
);

730 
£nd_objeù
 
so
;

731 
buf
->
u£robjeù
 = 
	`£nd_objeù_š™
(
ss
, &
so
, (*)
s
->
dw_bufãr
, s->
dw_size
);

732 
buf
->
±r
 = (*)
so
.
bufãr
+
s
->
dw_off£t
;

733 
buf
->
sz
 = 
so
.sz - 
s
->
dw_off£t
;

734 
buf
->
bufãr
 = (*)
s
->
dw_bufãr
;

735 
s
->
wb_size
+=
buf
->
sz
;

736 ià(
s
->
high
.
h—d
 =ğ
NULL
) {

737 
s
->
high
.
h—d
 = s->high.

 = 
buf
;

738 
buf
->
Ãxt
 = 
NULL
;

740 
buf
->
Ãxt
 = 
s
->
high
.
h—d
;

741 
s
->
high
.
h—d
 = 
buf
;

743 
s
->
dw_bufãr
 = 
NULL
;

745 
r
 = 
	`£nd_bufãr_
(
ss
,
s
,
l
,
»suÉ
);

746 
	`sock‘_uÆock
(
l
);

748  
r
;

749 
	}
}

751 
wr™e_bufãr
 *

752 
	$­³nd_£ndbufãr_
(
sock‘_£rv”
 *
ss
, 
wb_li¡
 *
s
, 
»que¡_£nd
 * 
»que¡
, 
size
) {

753 
wr™e_bufãr
 * 
buf
 = 
	`MALLOC
(
size
);

754 
£nd_objeù
 
so
;

755 
buf
->
u£robjeù
 = 
	`£nd_objeù_š™
(
ss
, &
so
, 
»que¡
->
bufãr
,„eque¡->
sz
);

756 
buf
->
±r
 = (*)
so
.
bufãr
;

757 
buf
->
sz
 = 
so
.sz;

758 
buf
->
bufãr
 = 
»que¡
->buffer;

759 
buf
->
Ãxt
 = 
NULL
;

760 ià(
s
->
h—d
 =ğ
NULL
) {

761 
s
->
h—d
 = s->

 = 
buf
;

763 
	`as£¹
(
s
->

 !ğ
NULL
);

764 
	`as£¹
(
s
->

->
Ãxt
 =ğ
NULL
);

765 
s
->

->
Ãxt
 = 
buf
;

766 
s
->

 = 
buf
;

768  
buf
;

769 
	}
}

771 
šlše
 

772 
	$­³nd_£ndbufãr_udp
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
´iÜ™y
, 
»que¡_£nd
 * 
»que¡
, cÚ¡ 
ušt8_t
 
udp_add»ss
[
UDP_ADDRESS_SIZE
]) {

773 
wb_li¡
 *
wl
 = (
´iÜ™y
 =ğ
PRIORITY_HIGH
è? &
s
->
high
 : &s->
low
;

774 
wr™e_bufãr
 *
buf
 = 
	`­³nd_£ndbufãr_
(
ss
, 
wl
, 
»que¡
, 
SIZEOF_UDPBUFFER
);

775 
	`memıy
(
buf
->
udp_add»ss
, udp_add»ss, 
UDP_ADDRESS_SIZE
);

776 
s
->
wb_size
 +ğ
buf
->
sz
;

777 
	}
}

779 
šlše
 

780 
	$­³nd_£ndbufãr
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
»que¡_£nd
 * 
»que¡
) {

781 
wr™e_bufãr
 *
buf
 = 
	`­³nd_£ndbufãr_
(
ss
, &
s
->
high
, 
»que¡
, 
SIZEOF_TCPBUFFER
);

782 
s
->
wb_size
 +ğ
buf
->
sz
;

783 
	}
}

785 
šlše
 

786 
	$­³nd_£ndbufãr_low
(
sock‘_£rv”
 *
ss
,
sock‘
 *
s
, 
»que¡_£nd
 * 
»que¡
) {

787 
wr™e_bufãr
 *
buf
 = 
	`­³nd_£ndbufãr_
(
ss
, &
s
->
low
, 
»que¡
, 
SIZEOF_TCPBUFFER
);

788 
s
->
wb_size
 +ğ
buf
->
sz
;

789 
	}
}

800 
	$£nd_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_£nd
 * 
»que¡
, 
sock‘_mes§ge
 *
»suÉ
, 
´iÜ™y
, cÚ¡ 
ušt8_t
 *
udp_add»ss
) {

801 
id
 = 
»que¡
->id;

802 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

803 
£nd_objeù
 
so
;

804 
	`£nd_objeù_š™
(
ss
, &
so
, 
»que¡
->
bufãr
,„eque¡->
sz
);

805 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
 || s->
id
 != id

806 || 
s
->
ty³
 =ğ
SOCKET_TYPE_HALFCLOSE


807 || 
s
->
ty³
 =ğ
SOCKET_TYPE_PACCEPT
) {

808 
so
.
	`ä“_func
(
»que¡
->
bufãr
);

811 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_PLISTEN
 || s->ty³ =ğ
SOCKET_TYPE_LISTEN
) {

812 
	`årštf
(
¡d”r
, "sock‘-£rv”: wr™tØli¡’ fd %d.\n", 
id
);

813 
so
.
	`ä“_func
(
»que¡
->
bufãr
);

816 ià(
	`£nd_bufãr_em±y
(
s
è&& s->
ty³
 =ğ
SOCKET_TYPE_CONNECTED
) {

817 ià(
s
->
´ÙocŞ
 =ğ
PROTOCOL_TCP
) {

818 
	`­³nd_£ndbufãr
(
ss
, 
s
, 
»que¡
);

821 ià(
udp_add»ss
 =ğ
NULL
) {

822 
udp_add»ss
 = 
s
->
p
.udp_address;

824 
sockaddr_®l
 
§
;

825 
sockËn_t
 
§sz
 = 
	`udp_sock‘_add»ss
(
s
, 
udp_add»ss
, &
§
);

826 
n
 = 
	`£ndto
(
s
->
fd
, 
so
.
bufãr
, so.
sz
, 0, &
§
.s, 
§sz
);

827 ià(
n
 !ğ
so
.
sz
) {

828 
	`­³nd_£ndbufãr_udp
(
ss
,
s
,
´iÜ™y
,
»que¡
,
udp_add»ss
);

830 
so
.
	`ä“_func
(
»que¡
->
bufãr
);

834 
	`¥_wr™e
(
ss
->
ev’t_fd
, 
s
->
fd
, s, 
Œue
);

836 ià(
s
->
´ÙocŞ
 =ğ
PROTOCOL_TCP
) {

837 ià(
´iÜ™y
 =ğ
PRIORITY_LOW
) {

838 
	`­³nd_£ndbufãr_low
(
ss
, 
s
, 
»que¡
);

840 
	`­³nd_£ndbufãr
(
ss
, 
s
, 
»que¡
);

843 ià(
udp_add»ss
 =ğ
NULL
) {

844 
udp_add»ss
 = 
s
->
p
.udp_address;

846 
	`­³nd_£ndbufãr_udp
(
ss
,
s
,
´iÜ™y
,
»que¡
,
udp_add»ss
);

849 ià(
s
->
wb_size
 >ğ
WARNING_SIZE
 && s->wb_siz>ğs->
w¬n_size
) {

850 
s
->
w¬n_size
 = s->w¬n_siz=ğ0 ? 
WARNING_SIZE
 *2 : s->warn_size*2;

851 
»suÉ
->
İaque
 = 
s
->opaque;

852 
»suÉ
->
id
 = 
s
->id;

853 
»suÉ
->
ud
 = 
s
->
wb_size
%1024 == 0 ? s->wb_size/1024 : s->wb_size/1024 + 1;

854 
»suÉ
->
d©a
 = 
NULL
;

855  
SOCKET_WARNING
;

858 
	}
}

861 
	$li¡’_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_li¡’
 * 
»que¡
, 
sock‘_mes§ge
 *
»suÉ
) {

862 
id
 = 
»que¡
->id;

863 
li¡’_fd
 = 
»que¡
->
fd
;

864 
sock‘
 *
s
 = 
	`Ãw_fd
(
ss
, 
id
, 
li¡’_fd
, 
PROTOCOL_TCP
, 
»que¡
->
İaque
, 
çl£
);

865 ià(
s
 =ğ
NULL
) {

866 
_çed
;

868 
s
->
ty³
 = 
SOCKET_TYPE_PLISTEN
;

870 
_çed
:

871 
	`şo£
(
li¡’_fd
);

872 
»suÉ
->
İaque
 = 
»que¡
->opaque;

873 
»suÉ
->
id
 = id;

874 
»suÉ
->
ud
 = 0;

875 
»suÉ
->
d©a
 = "reach skynet socket‚umber†imit";

876 
ss
->
¦Ù
[
	`HASH_ID
(
id
)].
ty³
 = 
SOCKET_TYPE_INVALID
;

878  
SOCKET_ERR
;

879 
	}
}

882 
	$şo£_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_şo£
 *
»que¡
, 
sock‘_mes§ge
 *
»suÉ
) {

883 
id
 = 
»que¡
->id;

884 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

885 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
 || s->
id
 != id) {

886 
»suÉ
->
id
 = id;

887 
»suÉ
->
İaque
 = 
»que¡
->opaque;

888 
»suÉ
->
ud
 = 0;

889 
»suÉ
->
d©a
 = 
NULL
;

890  
SOCKET_CLOSE
;

892 
sock‘_lock
 
l
;

893 
	`sock‘_lock_š™
(
s
, &
l
);

894 ià(!
	`£nd_bufãr_em±y
(
s
)) {

895 
ty³
 = 
	`£nd_bufãr
(
ss
,
s
,&
l
,
»suÉ
);

897 ià(
ty³
 !ğ-1 &&y³ !ğ
SOCKET_WARNING
)

898  
ty³
;

900 ià(
»que¡
->
shutdown
 || 
	`£nd_bufãr_em±y
(
s
)) {

901 
	`fÜû_şo£
(
ss
,
s
,&
l
,
»suÉ
);

902 
»suÉ
->
id
 = id;

903 
»suÉ
->
İaque
 = 
»que¡
->opaque;

904  
SOCKET_CLOSE
;

906 
s
->
ty³
 = 
SOCKET_TYPE_HALFCLOSE
;

909 
	}
}

912 
	$bšd_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_bšd
 *
»que¡
, 
sock‘_mes§ge
 *
»suÉ
) {

913 
id
 = 
»que¡
->id;

914 
»suÉ
->
id
 = id;

915 
»suÉ
->
İaque
 = 
»que¡
->opaque;

916 
»suÉ
->
ud
 = 0;

917 
sock‘
 *
s
 = 
	`Ãw_fd
(
ss
, 
id
, 
»que¡
->
fd
, 
PROTOCOL_TCP
,„eque¡->
İaque
, 
Œue
);

918 ià(
s
 =ğ
NULL
) {

919 
»suÉ
->
d©a
 = "reach skynet socket‚umber†imit";

920  
SOCKET_ERR
;

922 
	`¥_nÚblockšg
(
»que¡
->
fd
);

923 
s
->
ty³
 = 
SOCKET_TYPE_BIND
;

924 
»suÉ
->
d©a
 = "binding";

925  
SOCKET_OPEN
;

926 
	}
}

929 
	$¡¬t_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_¡¬t
 *
»que¡
, 
sock‘_mes§ge
 *
»suÉ
) {

930 
id
 = 
»que¡
->id;

931 
»suÉ
->
id
 = id;

932 
»suÉ
->
İaque
 = 
»que¡
->opaque;

933 
»suÉ
->
ud
 = 0;

934 
»suÉ
->
d©a
 = 
NULL
;

935 
sock‘
 *
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

936 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
 || s->
id
 !=id) {

937 
»suÉ
->
d©a
 = "invalid socket";

938  
SOCKET_ERR
;

940 
sock‘_lock
 
l
;

941 
	`sock‘_lock_š™
(
s
, &
l
);

942 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_PACCEPT
 || s->ty³ =ğ
SOCKET_TYPE_PLISTEN
) {

943 ià(
	`¥_add
(
ss
->
ev’t_fd
, 
s
->
fd
, s)) {

944 
	`fÜû_şo£
(
ss
, 
s
, &
l
, 
»suÉ
);

945 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”ºo
);

946  
SOCKET_ERR
;

948 
s
->
ty³
 = (s->ty³ =ğ
SOCKET_TYPE_PACCEPT
è? 
SOCKET_TYPE_CONNECTED
 : 
SOCKET_TYPE_LISTEN
;

949 
s
->
İaque
 = 
»que¡
->opaque;

950 
»suÉ
->
d©a
 = "start";

951  
SOCKET_OPEN
;

952 } ià(
s
->
ty³
 =ğ
SOCKET_TYPE_CONNECTED
) {

954 
s
->
İaque
 = 
»que¡
->opaque;

955 
»suÉ
->
d©a
 = "transfer";

956  
SOCKET_OPEN
;

960 
	}
}

963 
	$£tİt_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_£tİt
 *
»que¡
) {

964 
id
 = 
»que¡
->id;

965 
sock‘
 *
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

966 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
 || s->
id
 !=id) {

969 
v
 = 
»que¡
->
v®ue
;

970 
	`£tsockİt
(
s
->
fd
, 
IPPROTO_TCP
, 
»que¡
->
wh©
, &
v
, (v));

971 
	}
}

974 
	$block_»adpe
(
pefd
, *
bufãr
, 
sz
) {

976 
n
 = 
	`»ad
(
pefd
, 
bufãr
, 
sz
);

977 ià(
n
<0) {

978 ià(
”ºo
 =ğ
EINTR
)

980 
	`årštf
(
¡d”r
, "sock‘-£rv” :„—d…”rÜ %s.\n",
	`¡»¼Ü
(
”ºo
));

984 
	`as£¹
(
n
 =ğ
sz
);

987 
	}
}

990 
	$has_cmd
(
sock‘_£rv”
 *
ss
) {

991 
timev®
 
tv
 = {0,0};

992 
»tv®
;

994 
	`FD_SET
(
ss
->
»cvù¾_fd
, &ss->
rfds
);

996 
»tv®
 = 
	`£Ëù
(
ss
->
»cvù¾_fd
+1, &ss->
rfds
, 
NULL
, NULL, &
tv
);

997 ià(
»tv®
 == 1) {

1001 
	}
}

1004 
	$add_udp_sock‘
(
sock‘_£rv”
 *
ss
, 
»que¡_udp
 *
udp
) {

1005 
id
 = 
udp
->id;

1006 
´ÙocŞ
;

1007 ià(
udp
->
çmy
 =ğ
AF_INET6
) {

1008 
´ÙocŞ
 = 
PROTOCOL_UDPv6
;

1010 
´ÙocŞ
 = 
PROTOCOL_UDP
;

1012 
sock‘
 *
ns
 = 
	`Ãw_fd
(
ss
, 
id
, 
udp
->
fd
, 
´ÙocŞ
, udp->
İaque
, 
Œue
);

1013 ià(
ns
 =ğ
NULL
) {

1014 
	`şo£
(
udp
->
fd
);

1015 
ss
->
¦Ù
[
	`HASH_ID
(
id
)].
ty³
 = 
SOCKET_TYPE_INVALID
;

1018 
ns
->
ty³
 = 
SOCKET_TYPE_CONNECTED
;

1019 
	`mem£t
(
ns
->
p
.
udp_add»ss
, 0, (ns->p.udp_address));

1020 
	}
}

1023 
	$£t_udp_add»ss
(
sock‘_£rv”
 *
ss
, 
»que¡_£tudp
 *
»que¡
, 
sock‘_mes§ge
 *
»suÉ
) {

1024 
id
 = 
»que¡
->id;

1025 
sock‘
 *
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

1026 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
 || s->
id
 !=id) {

1029 
ty³
 = 
»que¡
->
add»ss
[0];

1030 ià(
ty³
 !ğ
s
->
´ÙocŞ
) {

1032 
»suÉ
->
İaque
 = 
s
->opaque;

1033 
»suÉ
->
id
 = 
s
->id;

1034 
»suÉ
->
ud
 = 0;

1035 
»suÉ
->
d©a
 = "protocol mismatch";

1037  
SOCKET_ERR
;

1039 ià(
ty³
 =ğ
PROTOCOL_UDP
) {

1040 
	`memıy
(
s
->
p
.
udp_add»ss
, 
»que¡
->
add»ss
, 1+2+4);

1042 
	`memıy
(
s
->
p
.
udp_add»ss
, 
»que¡
->
add»ss
, 1+2+16);

1044 
	`ATOM_DEC
(&
s
->
udpcÚÃùšg
);

1046 
	}
}

1050 
	$ù¾_cmd
(
sock‘_£rv”
 *
ss
, 
sock‘_mes§ge
 *
»suÉ
) {

1051 
fd
 = 
ss
->
»cvù¾_fd
;

1053 
ušt8_t
 
bufãr
[256];

1054 
ušt8_t
 
h—d”
[2];

1055 
	`block_»adpe
(
fd
, 
h—d”
, (header));

1056 
ty³
 = 
h—d”
[0];

1057 
Ën
 = 
h—d”
[1];

1058 
	`block_»adpe
(
fd
, 
bufãr
, 
Ën
);

1060 
ty³
) {

1062  
	`¡¬t_sock‘
(
ss
,(
»que¡_¡¬t
 *)
bufãr
, 
»suÉ
);

1064  
	`bšd_sock‘
(
ss
,(
»que¡_bšd
 *)
bufãr
, 
»suÉ
);

1066  
	`li¡’_sock‘
(
ss
,(
»que¡_li¡’
 *)
bufãr
, 
»suÉ
);

1068  
	`şo£_sock‘
(
ss
,(
»que¡_şo£
 *)
bufãr
, 
»suÉ
);

1070  
	`İ’_sock‘
(
ss
, (
»que¡_İ’
 *)
bufãr
, 
»suÉ
);

1072 
»suÉ
->
İaque
 = 0;

1073 
»suÉ
->
id
 = 0;

1074 
»suÉ
->
ud
 = 0;

1075 
»suÉ
->
d©a
 = 
NULL
;

1076  
SOCKET_EXIT
;

1078  
	`£nd_sock‘
(
ss
, (
»que¡_£nd
 *)
bufãr
, 
»suÉ
, 
PRIORITY_HIGH
, 
NULL
);

1080  
	`£nd_sock‘
(
ss
, (
»que¡_£nd
 *)
bufãr
, 
»suÉ
, 
PRIORITY_LOW
, 
NULL
);

1082 
»que¡_£nd_udp
 * 
rsu
 = (»que¡_£nd_ud°*)
bufãr
;

1083  
	`£nd_sock‘
(
ss
, &
rsu
->
£nd
, 
»suÉ
, 
PRIORITY_HIGH
,„su->
add»ss
);

1086  
	`£t_udp_add»ss
(
ss
, (
»que¡_£tudp
 *)
bufãr
, 
»suÉ
);

1088 
	`£tİt_sock‘
(
ss
, (
»que¡_£tİt
 *)
bufãr
);

1091 
	`add_udp_sock‘
(
ss
, (
»que¡_udp
 *)
bufãr
);

1094 
	`årštf
(
¡d”r
, "sock‘-£rv”: UnknowÀù¾ %c.\n",
ty³
);

1099 
	}
}

1103 
	$fÜw¬d_mes§ge_tı
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 * 
»suÉ
) {

1104 
sz
 = 
s
->
p
.
size
;

1105 * 
bufãr
 = 
	`MALLOC
(
sz
);

1106 
n
 = ()
	`»ad
(
s
->
fd
, 
bufãr
, 
sz
);

1107 ià(
n
<0) {

1108 
	`FREE
(
bufãr
);

1109 
”ºo
) {

1110 
EINTR
:

1112 
AGAIN_WOULDBLOCK
:

1113 
	`årštf
(
¡d”r
, "socket-server: EAGAIN capture.\n");

1117 
	`fÜû_şo£
(
ss
, 
s
, 
l
, 
»suÉ
);

1118 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”ºo
);

1119  
SOCKET_ERR
;

1123 ià(
n
==0) {

1124 
	`FREE
(
bufãr
);

1125 
	`fÜû_şo£
(
ss
, 
s
, 
l
, 
»suÉ
);

1126  
SOCKET_CLOSE
;

1129 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_HALFCLOSE
) {

1131 
	`FREE
(
bufãr
);

1135 ià(
n
 =ğ
sz
) {

1136 
s
->
p
.
size
 *= 2;

1137 } ià(
sz
 > 
MIN_READ_BUFFER
 && 
n
*2 < sz) {

1138 
s
->
p
.
size
 /= 2;

1141 
»suÉ
->
İaque
 = 
s
->opaque;

1142 
»suÉ
->
id
 = 
s
->id;

1143 
»suÉ
->
ud
 = 
n
;

1144 
»suÉ
->
d©a
 = 
bufãr
;

1145  
SOCKET_DATA
;

1146 
	}
}

1149 
	$g’_udp_add»ss
(
´ÙocŞ
, 
sockaddr_®l
 *
§
, 
ušt8_t
 * 
udp_add»ss
) {

1150 
addrsz
 = 1;

1151 
udp_add»ss
[0] = (
ušt8_t
)
´ÙocŞ
;

1152 ià(
´ÙocŞ
 =ğ
PROTOCOL_UDP
) {

1153 
	`memıy
(
udp_add»ss
+
addrsz
, &
§
->
v4
.
sš_pÜt
, (sa->v4.sin_port));

1154 
addrsz
 +ğ(
§
->
v4
.
sš_pÜt
);

1155 
	`memıy
(
udp_add»ss
+
addrsz
, &
§
->
v4
.
sš_addr
, (sa->v4.sin_addr));

1156 
addrsz
 +ğ(
§
->
v4
.
sš_addr
);

1158 
	`memıy
(
udp_add»ss
+
addrsz
, &
§
->
v6
.
sš6_pÜt
, (sa->v6.sin6_port));

1159 
addrsz
 +ğ(
§
->
v6
.
sš6_pÜt
);

1160 
	`memıy
(
udp_add»ss
+
addrsz
, &
§
->
v6
.
sš6_addr
, (sa->v6.sin6_addr));

1161 
addrsz
 +ğ(
§
->
v6
.
sš6_addr
);

1163  
addrsz
;

1164 
	}
}

1167 
	$fÜw¬d_mes§ge_udp
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 * 
»suÉ
) {

1168 
sockaddr_®l
 
§
;

1169 
sockËn_t
 
¦’
 = (
§
);

1170 
n
 = 
	`»cväom
(
s
->
fd
, 
ss
->
udpbufãr
,
MAX_UDP_PACKAGE
,0,&
§
.s,&
¦’
);

1171 ià(
n
<0) {

1172 
”ºo
) {

1173 
EINTR
:

1174 
AGAIN_WOULDBLOCK
:

1178 
	`fÜû_şo£
(
ss
, 
s
, 
l
, 
»suÉ
);

1179 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”ºo
);

1180  
SOCKET_ERR
;

1184 
ušt8_t
 * 
d©a
;

1185 ià(
¦’
 =ğ(
§
.
v4
)) {

1186 ià(
s
->
´ÙocŞ
 !ğ
PROTOCOL_UDP
)

1188 
d©a
 = 
	`MALLOC
(
n
 + 1 + 2 + 4);

1189 
	`g’_udp_add»ss
(
PROTOCOL_UDP
, &
§
, 
d©a
 + 
n
);

1191 ià(
s
->
´ÙocŞ
 !ğ
PROTOCOL_UDPv6
)

1193 
d©a
 = 
	`MALLOC
(
n
 + 1 + 2 + 16);

1194 
	`g’_udp_add»ss
(
PROTOCOL_UDPv6
, &
§
, 
d©a
 + 
n
);

1196 
	`memıy
(
d©a
, 
ss
->
udpbufãr
, 
n
);

1198 
»suÉ
->
İaque
 = 
s
->opaque;

1199 
»suÉ
->
id
 = 
s
->id;

1200 
»suÉ
->
ud
 = 
n
;

1201 
»suÉ
->
d©a
 = (*)data;

1203  
SOCKET_UDP
;

1204 
	}
}

1207 
	$»pÜt_cÚÃù
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_lock
 *
l
, 
sock‘_mes§ge
 *
»suÉ
) {

1208 
”rÜ
;

1209 
sockËn_t
 
Ën
 = (
”rÜ
);

1210 
code
 = 
	`g‘sockİt
(
s
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”rÜ
, &
Ën
);

1211 ià(
code
 < 0 || 
”rÜ
) {

1212 
	`fÜû_şo£
(
ss
,
s
,
l
, 
»suÉ
);

1213 ià(
code
 >= 0)

1214 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”rÜ
);

1216 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”ºo
);

1217  
SOCKET_ERR
;

1219 
s
->
ty³
 = 
SOCKET_TYPE_CONNECTED
;

1220 
»suÉ
->
İaque
 = 
s
->opaque;

1221 
»suÉ
->
id
 = 
s
->id;

1222 
»suÉ
->
ud
 = 0;

1223 ià(
	`£nd_bufãr_em±y
(
s
)) {

1224 
	`¥_wr™e
(
ss
->
ev’t_fd
, 
s
->
fd
, s, 
çl£
);

1226 
sockaddr_®l
 
u
;

1227 
sockËn_t
 
¦’
 = (
u
);

1228 ià(
	`g‘³”Çme
(
s
->
fd
, &
u
.s, &
¦’
) == 0) {

1229 * 
sš_addr
 = (
u
.
s
.
§_çmy
 =ğ
AF_INET
è? (*)&u.
v4
.sš_add¸: (*)&u.
v6
.
sš6_addr
;

1230 ià(
	`š‘_Áİ
(
u
.
s
.
§_çmy
, 
sš_addr
, 
ss
->
bufãr
, (ss->buffer))) {

1231 
»suÉ
->
d©a
 = 
ss
->
bufãr
;

1232  
SOCKET_OPEN
;

1235 
»suÉ
->
d©a
 = 
NULL
;

1236  
SOCKET_OPEN
;

1238 
	}
}

1242 
	$»pÜt_acû±
(
sock‘_£rv”
 *
ss
, 
sock‘
 *
s
, 
sock‘_mes§ge
 *
»suÉ
) {

1243 
sockaddr_®l
 
u
;

1244 
sockËn_t
 
Ën
 = (
u
);

1245 
ş›Á_fd
 = 
	`acû±
(
s
->
fd
, &
u
.s, &
Ën
);

1246 ià(
ş›Á_fd
 < 0) {

1247 ià(
”ºo
 =ğ
EMFILE
 ||ƒ¼nØ=ğ
ENFILE
) {

1248 
»suÉ
->
İaque
 = 
s
->opaque;

1249 
»suÉ
->
id
 = 
s
->id;

1250 
»suÉ
->
ud
 = 0;

1251 
»suÉ
->
d©a
 = 
	`¡»¼Ü
(
”ºo
);

1257 
id
 = 
	`»£rve_id
(
ss
);

1258 ià(
id
 < 0) {

1259 
	`şo£
(
ş›Á_fd
);

1262 
	`sock‘_k“·live
(
ş›Á_fd
);

1263 
	`¥_nÚblockšg
(
ş›Á_fd
);

1264 
sock‘
 *
ns
 = 
	`Ãw_fd
(
ss
, 
id
, 
ş›Á_fd
, 
PROTOCOL_TCP
, 
s
->
İaque
, 
çl£
);

1265 ià(
ns
 =ğ
NULL
) {

1266 
	`şo£
(
ş›Á_fd
);

1269 
ns
->
ty³
 = 
SOCKET_TYPE_PACCEPT
;

1270 
»suÉ
->
İaque
 = 
s
->opaque;

1271 
»suÉ
->
id
 = 
s
->id;

1272 
»suÉ
->
ud
 = 
id
;

1273 
»suÉ
->
d©a
 = 
NULL
;

1275 * 
sš_addr
 = (
u
.
s
.
§_çmy
 =ğ
AF_INET
è? (*)&u.
v4
.sš_add¸: (*)&u.
v6
.
sš6_addr
;

1276 
sš_pÜt
 = 
	`Áohs
((
u
.
s
.
§_çmy
 =ğ
AF_INET
è? u.
v4
.sš_pÜˆ: u.
v6
.
sš6_pÜt
);

1277 
tmp
[
INET6_ADDRSTRLEN
];

1278 ià(
	`š‘_Áİ
(
u
.
s
.
§_çmy
, 
sš_addr
, 
tmp
, (tmp))) {

1279 
	`¢´štf
(
ss
->
bufãr
, (ss->bufãr), "%s:%d", 
tmp
, 
sš_pÜt
);

1280 
»suÉ
->
d©a
 = 
ss
->
bufãr
;

1284 
	}
}

1286 
šlše
 

1287 
	$ş—r_şo£d_ev’t
(
sock‘_£rv”
 *
ss
, 
sock‘_mes§ge
 * 
»suÉ
, 
ty³
) {

1288 ià(
ty³
 =ğ
SOCKET_CLOSE
 ||y³ =ğ
SOCKET_ERR
) {

1289 
id
 = 
»suÉ
->id;

1290 
i
;

1291 
i
=
ss
->
ev’t_šdex
; i<ss->
ev’t_n
; i++) {

1292 
ev’t
 *
e
 = &
ss
->
ev
[
i
];

1293 
sock‘
 *
s
 = 
e
->s;

1294 ià(
s
) {

1295 ià(
s
->
ty³
 =ğ
SOCKET_TYPE_INVALID
 && s->
id
 == id) {

1296 
e
->
s
 = 
NULL
;

1302 
	}
}

1306 
	$sock‘_£rv”_pŞl
(
sock‘_£rv”
 *
ss
, 
sock‘_mes§ge
 * 
»suÉ
, * 
mÜe
) {

1308 ià(
ss
->
checkù¾
) {

1309 ià(
	`has_cmd
(
ss
)) {

1310 
ty³
 = 
	`ù¾_cmd
(
ss
, 
»suÉ
);

1311 ià(
ty³
 != -1) {

1312 
	`ş—r_şo£d_ev’t
(
ss
, 
»suÉ
, 
ty³
);

1313  
ty³
;

1317 
ss
->
checkù¾
 = 0;

1320 ià(
ss
->
ev’t_šdex
 =ğss->
ev’t_n
) {

1321 
ss
->
ev’t_n
 = 
	`¥_wa™
(ss->
ev’t_fd
, ss->
ev
, 
MAX_EVENT
);

1322 
ss
->
checkù¾
 = 1;

1323 ià(
mÜe
) {

1324 *
mÜe
 = 0;

1326 
ss
->
ev’t_šdex
 = 0;

1327 ià(
ss
->
ev’t_n
 <= 0) {

1328 
ss
->
ev’t_n
 = 0;

1329 ià(
”ºo
 =ğ
EINTR
) {

1335 
ev’t
 *
e
 = &
ss
->
ev
[ss->
ev’t_šdex
++];

1336 
sock‘
 *
s
 = 
e
->s;

1337 ià(
s
 =ğ
NULL
) {

1341 
sock‘_lock
 
l
;

1342 
	`sock‘_lock_š™
(
s
, &
l
);

1343 
s
->
ty³
) {

1344 
SOCKET_TYPE_CONNECTING
:

1345  
	`»pÜt_cÚÃù
(
ss
, 
s
, &
l
, 
»suÉ
);

1346 
SOCKET_TYPE_LISTEN
: {

1347 
ok
 = 
	`»pÜt_acû±
(
ss
, 
s
, 
»suÉ
);

1348 ià(
ok
 > 0) {

1349  
SOCKET_ACCEPT
;

1350 } ià(
ok
 < 0 ) {

1351  
SOCKET_ERR
;

1356 
SOCKET_TYPE_INVALID
:

1357 
	`årštf
(
¡d”r
, "socket-server: invalid socket\n");

1360 ià(
e
->
»ad
) {

1361 
ty³
;

1362 ià(
s
->
´ÙocŞ
 =ğ
PROTOCOL_TCP
) {

1363 
ty³
 = 
	`fÜw¬d_mes§ge_tı
(
ss
, 
s
, &
l
, 
»suÉ
);

1365 
ty³
 = 
	`fÜw¬d_mes§ge_udp
(
ss
, 
s
, &
l
, 
»suÉ
);

1366 ià(
ty³
 =ğ
SOCKET_UDP
) {

1368 --
ss
->
ev’t_šdex
;

1369  
SOCKET_UDP
;

1372 ià(
e
->
wr™e
 && 
ty³
 !ğ
SOCKET_CLOSE
 &&y³ !ğ
SOCKET_ERR
) {

1374 
e
->
»ad
 = 
çl£
;

1375 --
ss
->
ev’t_šdex
;

1377 ià(
ty³
 == -1)

1379  
ty³
;

1381 ià(
e
->
wr™e
) {

1382 
ty³
 = 
	`£nd_bufãr
(
ss
, 
s
, &
l
, 
»suÉ
);

1383 ià(
ty³
 == -1)

1385  
ty³
;

1387 ià(
e
->
”rÜ
) {

1389 
”rÜ
;

1390 
sockËn_t
 
Ën
 = (
”rÜ
);

1391 
code
 = 
	`g‘sockİt
(
s
->
fd
, 
SOL_SOCKET
, 
SO_ERROR
, &
”rÜ
, &
Ën
);

1392 cÚ¡ * 
”r
 = 
NULL
;

1393 ià(
code
 < 0) {

1394 
”r
 = 
	`¡»¼Ü
(
”ºo
);

1395 } ià(
”rÜ
 != 0) {

1396 
”r
 = 
	`¡»¼Ü
(
”rÜ
);

1398 
”r
 = "Unknownƒrror";

1400 
	`fÜû_şo£
(
ss
, 
s
, &
l
, 
»suÉ
);

1401 
»suÉ
->
d©a
 = (*)
”r
;

1402  
SOCKET_ERR
;

1407 
	}
}

1410 
	$£nd_»que¡
(
sock‘_£rv”
 *
ss
, 
»que¡_·ckage
 *
»que¡
, 
ty³
, 
Ën
) {

1411 
»que¡
->
h—d”
[6] = (
ušt8_t
)
ty³
;

1412 
»que¡
->
h—d”
[7] = (
ušt8_t
)
Ën
;

1414 
ssize_t
 
n
 = 
	`wr™e
(
ss
->
£ndù¾_fd
, &
»que¡
->
h—d”
[6], 
Ën
+2);

1415 ià(
n
<0) {

1416 ià(
”ºo
 !ğ
EINTR
) {

1417 
	`årštf
(
¡d”r
, "sock‘-£rv” : s’d cŒÈcommªdƒ¼Ü %s.\n", 
	`¡»¼Ü
(
”ºo
));

1421 
	`as£¹
(
n
 =ğ
Ën
+2);

1424 
	}
}

1427 
	$İ’_»que¡
(
sock‘_£rv”
 *
ss
, 
»que¡_·ckage
 *
»q
, 
ušŒ_t
 
İaque
, cÚ¡ *
addr
, 
pÜt
) {

1428 
Ën
 = 
	`¡¾’
(
addr
);

1429 ià(
Ën
 + (
»q
->
u
.
İ’
) >= 256) {

1430 
	`årštf
(
¡d”r
, "sock‘-£rv” : Inv®id‡dd¸%s.\n",
addr
);

1433 
id
 = 
	`»£rve_id
(
ss
);

1434 ià(
id
 < 0)

1436 
»q
->
u
.
İ’
.
İaque
 = opaque;

1437 
»q
->
u
.
İ’
.
id
 = id;

1438 
»q
->
u
.
İ’
.
pÜt
 =…ort;

1439 
	`memıy
(
»q
->
u
.
İ’
.
ho¡
, 
addr
, 
Ën
);

1440 
»q
->
u
.
İ’
.
ho¡
[
Ën
] = '\0';

1442  
Ën
;

1443 
	}
}

1446 
	$sock‘_£rv”_cÚÃù
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, cÚ¡ * 
addr
, 
pÜt
) {

1447 
»que¡_·ckage
 
»que¡
;

1448 
Ën
 = 
	`İ’_»que¡
(
ss
, &
»que¡
, 
İaque
, 
addr
, 
pÜt
);

1449 ià(
Ën
 < 0)

1451 
	`£nd_»que¡
(
ss
, &
»que¡
, 'O', Ôeque¡.
u
.
İ’
è+ 
Ën
);

1452  
»que¡
.
u
.
İ’
.
id
;

1453 
	}
}

1455 
šlše
 

1456 
	$ÿn_dœeù_wr™e
(
sock‘
 *
s
, 
id
) {

1457  
s
->
id
 =ğid && 
	`£nd_bufãr_em±y
(sè&& s->
ty³
 =ğ
SOCKET_TYPE_CONNECTED
 && s->
dw_bufãr
 =ğ
NULL
 && s->
udpcÚÃùšg
 == 0;

1458 
	}
}

1462 
	$sock‘_£rv”_£nd
(
sock‘_£rv”
 *
ss
, 
id
, cÚ¡ * 
bufãr
, 
sz
) {

1463 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

1464 ià(
s
->
id
 !ğid || s->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

1465 
	`ä“_bufãr
(
ss
, 
bufãr
, 
sz
);

1469 
sock‘_lock
 
l
;

1470 
	`sock‘_lock_š™
(
s
, &
l
);

1472 ià(
	`ÿn_dœeù_wr™e
(
s
,
id
è&& 
	`sock‘_Œylock
(&
l
)) {

1474 ià(
	`ÿn_dœeù_wr™e
(
s
,
id
)) {

1476 
£nd_objeù
 
so
;

1477 
	`£nd_objeù_š™
(
ss
, &
so
, (*)
bufãr
, 
sz
);

1478 
ssize_t
 
n
;

1479 ià(
s
->
´ÙocŞ
 =ğ
PROTOCOL_TCP
) {

1480 
n
 = 
	`wr™e
(
s
->
fd
, 
so
.
bufãr
, so.
sz
);

1482 
sockaddr_®l
 
§
;

1483 
sockËn_t
 
§sz
 = 
	`udp_sock‘_add»ss
(
s
, s->
p
.
udp_add»ss
, &
§
);

1484 
n
 = 
	`£ndto
(
s
->
fd
, 
so
.
bufãr
, so.
sz
, 0, &
§
.s, 
§sz
);

1486 ià(
n
<0) {

1488 
n
 = 0;

1490 ià(
n
 =ğ
so
.
sz
) {

1492 
	`sock‘_uÆock
(&
l
);

1493 
so
.
	`ä“_func
((*)
bufãr
);

1497 
s
->
dw_bufãr
 = 
bufãr
;

1498 
s
->
dw_size
 = 
sz
;

1499 
s
->
dw_off£t
 = 
n
;

1501 
	`¥_wr™e
(
ss
->
ev’t_fd
, 
s
->
fd
, s, 
Œue
);

1503 
	`sock‘_uÆock
(&
l
);

1506 
	`sock‘_uÆock
(&
l
);

1509 
»que¡_·ckage
 
»que¡
;

1510 
»que¡
.
u
.
£nd
.
id
 = id;

1511 
»que¡
.
u
.
£nd
.
sz
 = sz;

1512 
»que¡
.
u
.
£nd
.
bufãr
 = (*)buffer;

1514 
	`£nd_»que¡
(
ss
, &
»que¡
, 'D', Ôeque¡.
u
.
£nd
));

1516 
	}
}

1520 
	$sock‘_£rv”_£nd_low´iÜ™y
(
sock‘_£rv”
 *
ss
, 
id
, cÚ¡ * 
bufãr
, 
sz
) {

1521 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

1522 ià(
s
->
id
 !ğid || s->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

1523 
	`ä“_bufãr
(
ss
, 
bufãr
, 
sz
);

1527 
»que¡_·ckage
 
»que¡
;

1528 
»que¡
.
u
.
£nd
.
id
 = id;

1529 
»que¡
.
u
.
£nd
.
sz
 = sz;

1530 
»que¡
.
u
.
£nd
.
bufãr
 = (*)buffer;

1532 
	`£nd_»que¡
(
ss
, &
»que¡
, 'P', Ôeque¡.
u
.
£nd
));

1534 
	}
}

1537 
	$sock‘_£rv”_ex™
(
sock‘_£rv”
 *
ss
) {

1538 
»que¡_·ckage
 
»que¡
;

1539 
	`£nd_»que¡
(
ss
, &
»que¡
, 'X', 0);

1540 
	}
}

1543 
	$sock‘_£rv”_şo£
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, 
id
) {

1544 
»que¡_·ckage
 
»que¡
;

1545 
»que¡
.
u
.
şo£
.
id
 = id;

1546 
»que¡
.
u
.
şo£
.
shutdown
 = 0;

1547 
»que¡
.
u
.
şo£
.
İaque
 = opaque;

1548 
	`£nd_»que¡
(
ss
, &
»que¡
, 'K', Ôeque¡.
u
.
şo£
));

1549 
	}
}

1553 
	$sock‘_£rv”_shutdown
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, 
id
) {

1554 
»que¡_·ckage
 
»que¡
;

1555 
»que¡
.
u
.
şo£
.
id
 = id;

1556 
»que¡
.
u
.
şo£
.
shutdown
 = 1;

1557 
»que¡
.
u
.
şo£
.
İaque
 = opaque;

1558 
	`£nd_»que¡
(
ss
, &
»que¡
, 'K', Ôeque¡.
u
.
şo£
));

1559 
	}
}

1564 
	$do_bšd
(cÚ¡ *
ho¡
, 
pÜt
, 
´ÙocŞ
, *
çmy
) {

1565 
fd
;

1566 
¡©us
;

1567 
»u£
 = 1;

1568 
addršfo
 
ai_hšts
;

1569 
addršfo
 *
ai_li¡
 = 
NULL
;

1570 
pÜt¡r
[16];

1571 ià(
ho¡
 =ğ
NULL
 || host[0] == 0) {

1572 
ho¡
 = "0.0.0.0";

1574 
	`¥rštf
(
pÜt¡r
, "%d", 
pÜt
);

1575 
	`mem£t
Ğ&
ai_hšts
, 0, (‡i_hints ) );

1576 
ai_hšts
.
ai_çmy
 = 
AF_UNSPEC
;

1577 ià(
´ÙocŞ
 =ğ
IPPROTO_TCP
) {

1578 
ai_hšts
.
ai_sockty³
 = 
SOCK_STREAM
;

1580 
	`as£¹
(
´ÙocŞ
 =ğ
IPPROTO_UDP
);

1581 
ai_hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

1583 
ai_hšts
.
ai_´ÙocŞ
 = 
´ÙocŞ
;

1585 
¡©us
 = 
	`g‘addršfo
Ğ
ho¡
, 
pÜt¡r
, &
ai_hšts
, &
ai_li¡
 );

1586 iàĞ
¡©us
 != 0 ) {

1589 *
çmy
 = 
ai_li¡
->
ai_çmy
;

1590 
fd
 = 
	`sock‘
(*
çmy
, 
ai_li¡
->
ai_sockty³
, 0);

1591 ià(
fd
 < 0) {

1592 
_çed_fd
;

1594 ià(
	`£tsockİt
(
fd
, 
SOL_SOCKET
, 
SO_REUSEADDR
, (*)&
»u£
, ())==-1) {

1595 
_çed
;

1597 
¡©us
 = 
	`bšd
(
fd
, (
sockaddr
 *)
ai_li¡
->
ai_addr
,‡i_li¡->
ai_add¾’
);

1598 ià(
¡©us
 != 0)

1599 
_çed
;

1601 
	`ä“addršfo
Ğ
ai_li¡
 );

1602  
fd
;

1603 
_çed
:

1604 
	`şo£
(
fd
);

1605 
_çed_fd
:

1606 
	`ä“addršfo
Ğ
ai_li¡
 );

1608 
	}
}

1611 
	$do_li¡’
(cÚ¡ * 
ho¡
, 
pÜt
, 
backlog
) {

1612 
çmy
 = 0;

1613 
li¡’_fd
 = 
	`do_bšd
(
ho¡
, 
pÜt
, 
IPPROTO_TCP
, &
çmy
);

1614 ià(
li¡’_fd
 < 0) {

1617 ià(
	`li¡’
(
li¡’_fd
, 
backlog
) == -1) {

1618 
	`şo£
(
li¡’_fd
);

1621  
li¡’_fd
;

1622 
	}
}

1625 
	$sock‘_£rv”_li¡’
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, cÚ¡ * 
addr
, 
pÜt
, 
backlog
) {

1626 
fd
 = 
	`do_li¡’
(
addr
, 
pÜt
, 
backlog
);

1627 ià(
fd
 < 0) {

1630 
»que¡_·ckage
 
»que¡
;

1631 
id
 = 
	`»£rve_id
(
ss
);

1632 ià(
id
 < 0) {

1633 
	`şo£
(
fd
);

1634  
id
;

1636 
»que¡
.
u
.
li¡’
.
İaque
 = opaque;

1637 
»que¡
.
u
.
li¡’
.
id
 = id;

1638 
»que¡
.
u
.
li¡’
.
fd
 = fd;

1639 
	`£nd_»que¡
(
ss
, &
»que¡
, 'L', Ôeque¡.
u
.
li¡’
));

1640  
id
;

1641 
	}
}

1644 
	$sock‘_£rv”_bšd
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, 
fd
) {

1645 
»que¡_·ckage
 
»que¡
;

1646 
id
 = 
	`»£rve_id
(
ss
);

1647 ià(
id
 < 0)

1649 
»que¡
.
u
.
bšd
.
İaque
 = opaque;

1650 
»que¡
.
u
.
bšd
.
id
 = id;

1651 
»que¡
.
u
.
bšd
.
fd
 = fd;

1652 
	`£nd_»que¡
(
ss
, &
»que¡
, 'B', Ôeque¡.
u
.
bšd
));

1653  
id
;

1654 
	}
}

1657 
	$sock‘_£rv”_¡¬t
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, 
id
) {

1658 
»que¡_·ckage
 
»que¡
;

1659 
»que¡
.
u
.
¡¬t
.
id
 = id;

1660 
»que¡
.
u
.
¡¬t
.
İaque
 = opaque;

1661 
	`£nd_»que¡
(
ss
, &
»que¡
, 'S', Ôeque¡.
u
.
¡¬t
));

1662 
	}
}

1665 
	$sock‘_£rv”_nod–ay
(
sock‘_£rv”
 *
ss
, 
id
) {

1666 
»que¡_·ckage
 
»que¡
;

1667 
»que¡
.
u
.
£tİt
.
id
 = id;

1668 
»que¡
.
u
.
£tİt
.
wh©
 = 
TCP_NODELAY
;

1669 
»que¡
.
u
.
£tİt
.
v®ue
 = 1;

1670 
	`£nd_»que¡
(
ss
, &
»que¡
, 'T', Ôeque¡.
u
.
£tİt
));

1671 
	}
}

1674 
	$sock‘_£rv”_u£robjeù
(
sock‘_£rv”
 *
ss
, 
sock‘_objeù_š‹rçû
 *
soi
) {

1675 
ss
->
soi
 = *soi;

1676 
	}
}

1681 
	$sock‘_£rv”_udp
(
sock‘_£rv”
 *
ss
, 
ušŒ_t
 
İaque
, cÚ¡ * 
addr
, 
pÜt
) {

1682 
fd
;

1683 
çmy
;

1684 ià(
pÜt
 !ğ0 || 
addr
 !ğ
NULL
) {

1686 
fd
 = 
	`do_bšd
(
addr
, 
pÜt
, 
IPPROTO_UDP
, &
çmy
);

1687 ià(
fd
 < 0) {

1691 
çmy
 = 
AF_INET
;

1692 
fd
 = 
	`sock‘
(
çmy
, 
SOCK_DGRAM
, 0);

1693 ià(
fd
 < 0) {

1697 
	`¥_nÚblockšg
(
fd
);

1699 
id
 = 
	`»£rve_id
(
ss
);

1700 ià(
id
 < 0) {

1701 
	`şo£
(
fd
);

1704 
»que¡_·ckage
 
»que¡
;

1705 
»que¡
.
u
.
udp
.
id
 = id;

1706 
»que¡
.
u
.
udp
.
fd
 = fd;

1707 
»que¡
.
u
.
udp
.
İaque
 = opaque;

1708 
»que¡
.
u
.
udp
.
çmy
 = family;

1710 
	`£nd_»que¡
(
ss
, &
»que¡
, 'U', Ôeque¡.
u
.
udp
));

1711  
id
;

1712 
	}
}

1715 
	$sock‘_£rv”_udp_£nd
(
sock‘_£rv”
 *
ss
, 
id
, cÚ¡ 
sock‘_udp_add»ss
 *
addr
, cÚ¡ *
bufãr
, 
sz
) {

1716 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

1717 ià(
s
->
id
 !ğid || s->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

1718 
	`ä“_bufãr
(
ss
, 
bufãr
, 
sz
);

1722 cÚ¡ 
ušt8_t
 *
udp_add»ss
 = (cÚ¡ ušt8_ˆ*)
addr
;

1723 
addrsz
;

1724 
udp_add»ss
[0]) {

1725 
PROTOCOL_UDP
:

1726 
addrsz
 = 1+2+4;

1728 
PROTOCOL_UDPv6
:

1729 
addrsz
 = 1+2+16;

1732 
	`ä“_bufãr
(
ss
, 
bufãr
, 
sz
);

1736 
sock‘_lock
 
l
;

1737 
	`sock‘_lock_š™
(
s
, &
l
);

1739 ià(
	`ÿn_dœeù_wr™e
(
s
,
id
è&& 
	`sock‘_Œylock
(&
l
)) {

1741 ià(
	`ÿn_dœeù_wr™e
(
s
,
id
)) {

1743 
£nd_objeù
 
so
;

1744 
	`£nd_objeù_š™
(
ss
, &
so
, (*)
bufãr
, 
sz
);

1745 
sockaddr_®l
 
§
;

1746 
sockËn_t
 
§sz
 = 
	`udp_sock‘_add»ss
(
s
, 
udp_add»ss
, &
§
);

1747 
n
 = 
	`£ndto
(
s
->
fd
, 
so
.
bufãr
, so.
sz
, 0, &
§
.s, 
§sz
);

1748 ià(
n
 >= 0) {

1750 
	`sock‘_uÆock
(&
l
);

1751 
so
.
	`ä“_func
((*)
bufãr
);

1755 
	`sock‘_uÆock
(&
l
);

1759 
»que¡_·ckage
 
»que¡
;

1760 
»que¡
.
u
.
£nd_udp
.
£nd
.
id
 = id;

1761 
»que¡
.
u
.
£nd_udp
.
£nd
.
sz
 = sz;

1762 
»que¡
.
u
.
£nd_udp
.
£nd
.
bufãr
 = (*)buffer;

1764 
	`memıy
(
»que¡
.
u
.
£nd_udp
.
add»ss
, 
udp_add»ss
, 
addrsz
);

1766 
	`£nd_»que¡
(
ss
, &
»que¡
, 'A', Ôeque¡.
u
.
£nd_udp
.
£nd
)+
addrsz
);

1768 
	}
}

1771 
	$sock‘_£rv”_udp_cÚÃù
(
sock‘_£rv”
 *
ss
, 
id
, cÚ¡ * 
addr
, 
pÜt
) {

1772 
sock‘
 * 
s
 = &
ss
->
¦Ù
[
	`HASH_ID
(
id
)];

1773 ià(
s
->
id
 !ğid || s->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

1776 
sock‘_lock
 
l
;

1777 
	`sock‘_lock_š™
(
s
, &
l
);

1778 
	`sock‘_lock
(&
l
);

1779 ià(
s
->
id
 !ğid || s->
ty³
 =ğ
SOCKET_TYPE_INVALID
) {

1780 
	`sock‘_uÆock
(&
l
);

1783 
	`ATOM_INC
(&
s
->
udpcÚÃùšg
);

1784 
	`sock‘_uÆock
(&
l
);

1786 
¡©us
;

1787 
addršfo
 
ai_hšts
;

1788 
addršfo
 *
ai_li¡
 = 
NULL
;

1789 
pÜt¡r
[16];

1790 
	`¥rštf
(
pÜt¡r
, "%d", 
pÜt
);

1791 
	`mem£t
Ğ&
ai_hšts
, 0, (‡i_hints ) );

1792 
ai_hšts
.
ai_çmy
 = 
AF_UNSPEC
;

1793 
ai_hšts
.
ai_sockty³
 = 
SOCK_DGRAM
;

1794 
ai_hšts
.
ai_´ÙocŞ
 = 
IPPROTO_UDP
;

1796 
¡©us
 = 
	`g‘addršfo
(
addr
, 
pÜt¡r
, &
ai_hšts
, &
ai_li¡
 );

1797 iàĞ
¡©us
 != 0 ) {

1800 
»que¡_·ckage
 
»que¡
;

1801 
»que¡
.
u
.
£t_udp
.
id
 = id;

1802 
´ÙocŞ
;

1804 ià(
ai_li¡
->
ai_çmy
 =ğ
AF_INET
) {

1805 
´ÙocŞ
 = 
PROTOCOL_UDP
;

1806 } ià(
ai_li¡
->
ai_çmy
 =ğ
AF_INET6
) {

1807 
´ÙocŞ
 = 
PROTOCOL_UDPv6
;

1809 
	`ä“addršfo
Ğ
ai_li¡
 );

1813 
addrsz
 = 
	`g’_udp_add»ss
(
´ÙocŞ
, (
sockaddr_®l
 *)
ai_li¡
->
ai_addr
, 
»que¡
.
u
.
£t_udp
.
add»ss
);

1815 
	`ä“addršfo
Ğ
ai_li¡
 );

1817 
	`£nd_»que¡
(
ss
, &
»que¡
, 'C', Ôeque¡.
u
.
£t_udp
è- Ôeque¡.u.£t_udp.
add»ss
è+
addrsz
);

1820 
	}
}

1822 cÚ¡ 
sock‘_udp_add»ss
 *

1823 
	$sock‘_£rv”_udp_add»ss
(
sock‘_£rv”
 *
ss
, 
sock‘_mes§ge
 *
msg
, *
addrsz
) {

1824 
ušt8_t
 * 
add»ss
 = (ušt8_ˆ*)(
msg
->
d©a
 + msg->
ud
);

1825 
ty³
 = 
add»ss
[0];

1826 
ty³
) {

1827 
PROTOCOL_UDP
:

1828 *
addrsz
 = 1+2+4;

1830 
PROTOCOL_UDPv6
:

1831 *
addrsz
 = 1+2+16;

1834  
NULL
;

1836  (cÚ¡ 
sock‘_udp_add»ss
 *)
add»ss
;

1837 
	}
}

	@skynet-src/socket_server.h

1 #iâdeà
skyÃt_sock‘_£rv”_h


2 
	#skyÃt_sock‘_£rv”_h


	)

4 
	~<¡dšt.h
>

6 
	#SOCKET_DATA
 0

	)

7 
	#SOCKET_CLOSE
 1

	)

8 
	#SOCKET_OPEN
 2

	)

9 
	#SOCKET_ACCEPT
 3

	)

10 
	#SOCKET_ERR
 4

	)

11 
	#SOCKET_EXIT
 5

	)

12 
	#SOCKET_UDP
 6

	)

13 
	#SOCKET_WARNING
 7

	)

15 
	gsock‘_£rv”
;

17 
	ssock‘_mes§ge
 {

18 
	mid
;

19 
ušŒ_t
 
	mİaque
;

20 
	mud
;

21 * 
	md©a
;

24 
sock‘_£rv”
 * 
sock‘_£rv”_ü—‹
();

25 
sock‘_£rv”_»Ëa£
(
sock‘_£rv”
 *);

26 
sock‘_£rv”_pŞl
(
sock‘_£rv”
 *, 
sock‘_mes§ge
 *
»suÉ
, *
mÜe
);

28 
sock‘_£rv”_ex™
(
sock‘_£rv”
 *);

29 
sock‘_£rv”_şo£
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, 
id
);

30 
sock‘_£rv”_shutdown
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, 
id
);

31 
sock‘_£rv”_¡¬t
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, 
id
);

34 
sock‘_£rv”_£nd
(
sock‘_£rv”
 *, 
id
, cÚ¡ * 
bufãr
, 
sz
);

35 
sock‘_£rv”_£nd_low´iÜ™y
(
sock‘_£rv”
 *, 
id
, cÚ¡ * 
bufãr
, 
sz
);

38 
sock‘_£rv”_li¡’
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, cÚ¡ * 
addr
, 
pÜt
, 
backlog
);

39 
sock‘_£rv”_cÚÃù
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, cÚ¡ * 
addr
, 
pÜt
);

40 
sock‘_£rv”_bšd
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, 
fd
);

43 
sock‘_£rv”_nod–ay
(
sock‘_£rv”
 *, 
id
);

45 
	gsock‘_udp_add»ss
;

49 
sock‘_£rv”_udp
(
sock‘_£rv”
 *, 
ušŒ_t
 
İaque
, cÚ¡ * 
addr
, 
pÜt
);

51 
sock‘_£rv”_udp_cÚÃù
(
sock‘_£rv”
 *, 
id
, cÚ¡ * 
addr
, 
pÜt
);

54 
sock‘_£rv”_udp_£nd
(
sock‘_£rv”
 *, 
id
, cÚ¡ 
sock‘_udp_add»ss
 *, cÚ¡ *
bufãr
, 
sz
);

56 cÚ¡ 
sock‘_udp_add»ss
 * 
sock‘_£rv”_udp_add»ss
(
sock‘_£rv”
 *, 
sock‘_mes§ge
 *, *
addrsz
);

58 
	ssock‘_objeù_š‹rçû
 {

59 * (*
	mbufãr
)(*);

60 (*
	msize
)(*);

61 (*
	mä“
)(*);

65 
sock‘_£rv”_u£robjeù
(
sock‘_£rv”
 *, 
sock‘_objeù_š‹rçû
 *
soi
);

	@skynet-src/spinlock.h

1 #iâdeà
SKYNET_SPINLOCK_H


2 
	#SKYNET_SPINLOCK_H


	)

4 
	#SPIN_INIT
(
q
è
	`¥šlock_š™
(&(q)->
lock
);

	)

5 
	#SPIN_LOCK
(
q
è
	`¥šlock_lock
(&(q)->
lock
);

	)

6 
	#SPIN_UNLOCK
(
q
è
	`¥šlock_uÆock
(&(q)->
lock
);

	)

7 
	#SPIN_DESTROY
(
q
è
	`¥šlock_de¡roy
(&(q)->
lock
);

	)

9 #iâdeà
USE_PTHREAD_LOCK


11 
	s¥šlock
 {

12 
	mlock
;

15 
šlše
 

16 
	$¥šlock_š™
(
¥šlock
 *
lock
) {

17 
lock
->lock = 0;

18 
	}
}

20 
šlše
 

21 
	$¥šlock_lock
(
¥šlock
 *
lock
) {

22 
	`__sync_lock_‹¡_ªd_£t
(&
lock
->lock,1)) {}

23 
	}
}

25 
šlše
 

26 
	$¥šlock_Œylock
(
¥šlock
 *
lock
) {

27  
	`__sync_lock_‹¡_ªd_£t
(&
lock
->lock,1) == 0;

28 
	}
}

30 
šlše
 

31 
	$¥šlock_uÆock
(
¥šlock
 *
lock
) {

32 
	`__sync_lock_»Ëa£
(&
lock
->lock);

33 
	}
}

35 
šlše
 

36 
	$¥šlock_de¡roy
(
¥šlock
 *
lock
) {

37 (è
lock
;

38 
	}
}

42 
	~<±h»ad.h
>

47 
	s¥šlock
 {

48 
±h»ad_mu‹x_t
 
	mlock
;

51 
šlše
 

52 
	$¥šlock_š™
(
¥šlock
 *
lock
) {

53 
	`±h»ad_mu‹x_š™
(&
lock
->lock, 
NULL
);

54 
	}
}

56 
šlše
 

57 
	$¥šlock_lock
(
¥šlock
 *
lock
) {

58 
	`±h»ad_mu‹x_lock
(&
lock
->lock);

59 
	}
}

61 
šlše
 

62 
	$¥šlock_Œylock
(
¥šlock
 *
lock
) {

63  
	`±h»ad_mu‹x_Œylock
(&
lock
->lock) == 0;

64 
	}
}

66 
šlše
 

67 
	$¥šlock_uÆock
(
¥šlock
 *
lock
) {

68 
	`±h»ad_mu‹x_uÆock
(&
lock
->lock);

69 
	}
}

71 
šlše
 

72 
	$¥šlock_de¡roy
(
¥šlock
 *
lock
) {

73 
	`±h»ad_mu‹x_de¡roy
(&
lock
->lock);

74 
	}
}

	@/usr/include/arpa/inet.h

18 #iâdeà
_ARPA_INET_H


19 
	#_ARPA_INET_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<Ãtš‘/š.h
>

25 #iâdeà
__sockËn_t_defšed


26 
__sockËn_t
 
	tsockËn_t
;

27 
	#__sockËn_t_defšed


	)

30 
__BEGIN_DECLS


34 
š_addr_t
 
	$š‘_addr
 (cÚ¡ *
__ı
è
__THROW
;

37 
š_addr_t
 
	$š‘_Êaof
 (
š_addr
 
__š
è
__THROW
;

41 
š_addr
 
	$š‘_mak—ddr
 (
š_addr_t
 
__Ãt
, in_addr_ˆ
__ho¡
)

42 
__THROW
;

45 
š_addr_t
 
	$š‘_Ãtof
 (
š_addr
 
__š
è
__THROW
;

49 
š_addr_t
 
	$š‘_ÃtwÜk
 (cÚ¡ *
__ı
è
__THROW
;

53 *
	$š‘_Áß
 (
š_addr
 
__š
è
__THROW
;

58 
	$š‘_±Ú
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

59 *
__»¡riù
 
__buf
è
__THROW
;

64 cÚ¡ *
	$š‘_Áİ
 (
__af
, cÚ¡ *
__»¡riù
 
__ı
,

65 *
__»¡riù
 
__buf
, 
sockËn_t
 
__Ën
)

66 
__THROW
;

70 #ifdeà
__USE_MISC


73 
	$š‘_©Ú
 (cÚ¡ *
__ı
, 
š_addr
 *
__šp
è
__THROW
;

77 *
	$š‘_Ã
 (
š_addr_t
 
__Ãt
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

82 *
	$š‘_Ãt_Áİ
 (
__af
, cÚ¡ *
__ı
, 
__b™s
,

83 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

88 
	$š‘_Ãt_±Ú
 (
__af
, cÚ¡ *
__ı
,

89 *
__buf
, 
size_t
 
__Ën
è
__THROW
;

94 
	$š‘_n§p_addr
 (cÚ¡ *
__ı
,

95 *
__buf
, 
__Ën
è
__THROW
;

99 *
	$š‘_n§p_Áß
 (
__Ën
, cÚ¡ *
__ı
,

100 *
__buf
è
__THROW
;

103 
__END_DECLS


	@/usr/include/assert.h

22 #ifdef 
_ASSERT_H


24 #undeà
_ASSERT_H


25 #undeà
as£¹


26 #undeà
__ASSERT_VOID_CAST


28 #ifdef 
__USE_GNU


29 #undeà
as£¹_³¼Ü


34 
	#_ASSERT_H
 1

	)

35 
	~<ã©u»s.h
>

37 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (2,95)

38 
	#__ASSERT_VOID_CAST
 
¡©ic_ÿ¡
<>

	)

40 
	#__ASSERT_VOID_CAST
 ()

	)

48 #ifdef 
NDEBUG


50 
	#as£¹
(
ex´
è(
	`__ASSERT_VOID_CAST
 (0))

	)

58 #ifdef 
__USE_GNU


59 
	#as£¹_³¼Ü
(
”ºum
è(
	`__ASSERT_VOID_CAST
 (0))

	)

64 #iâdeà
_ASSERT_H_DECLS


65 
	#_ASSERT_H_DECLS


	)

66 
__BEGIN_DECLS


69 
	$__as£¹_ç
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
,

70 
__lše
, cÚ¡ *
__funùiÚ
)

71 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

74 
	$__as£¹_³¼Ü_ç
 (
__”ºum
, cÚ¡ *
__fe
,

75 
__lše
, cÚ¡ *
__funùiÚ
)

76 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

81 
	$__as£¹
 (cÚ¡ *
__as£¹iÚ
, cÚ¡ *
__fe
, 
__lše
)

82 
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

85 
__END_DECLS


91 #ià
defšed
 
__ılu¥lus


92 
	#as£¹
(
ex´
) \

93 (
¡©ic_ÿ¡
 <
boŞ
> (
ex´
) \

95 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

96 #–ià!
defšed
 
__GNUC__
 || defšed 
__STRICT_ANSI__


97 
	#as£¹
(
ex´
) \

98 ((
ex´
) \

99 ? 
	`__ASSERT_VOID_CAST
 (0) \

100 : 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

107 
	#as£¹
(
ex´
) \

108 ((è ((
ex´
è? 1 : 0), 
	`__ex‹nsiÚ__
 ({ \

109 ià(
ex´
) \

112 
	`__as£¹_ç
 (#ex´, 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
); \

113 
	}
}))

	)

116 #ifdef 
__USE_GNU


117 
	#as£¹_³¼Ü
(
”ºum
) \

118 (!(
”ºum
) \

119 ? 
	`__ASSERT_VOID_CAST
 (0) \

120 : 
	`__as£¹_³¼Ü_ç
 ((
”ºum
), 
__FILE__
, 
__LINE__
, 
__ASSERT_FUNCTION
))

	)

128 #ià
defšed
 
__ılu¥lus
 ? 
__GNUC_PREREQ
 (2, 6) : __GNUC_PREREQ (2, 4)

129 
	#__ASSERT_FUNCTION
 
__ex‹nsiÚ__
 
__PRETTY_FUNCTION__


	)

131 #ià
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L

132 
	#__ASSERT_FUNCTION
 
__func__


	)

134 
	#__ASSERT_FUNCTION
 ((cÚ¡ *è0)

	)

141 #ià
defšed
 
__USE_ISOC11
 && !defšed 
__ılu¥lus


142 #undeà
¡©ic_as£¹


143 
	#¡©ic_as£¹
 
_Stic_as£¹


	)

	@/usr/include/ctype.h

22 #iâdef 
_CTYPE_H


23 
	#_CTYPE_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s.h
>

28 
	g__BEGIN_DECLS


30 #iâdeà
_ISb™


39 
	~<’dŸn.h
>

40 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


41 
	#_ISb™
(
b™
è(1 << (b™))

	)

43 
	#_ISb™
(
b™
è((b™è< 8 ? ((1 << (b™)è<< 8è: ((1 << (b™)è>> 8))

	)

48 
	m_ISuµ”
 = 
_ISb™
 (0),

49 
	m_ISlow”
 = 
_ISb™
 (1),

50 
	m_IS®pha
 = 
_ISb™
 (2),

51 
	m_ISdig™
 = 
_ISb™
 (3),

52 
	m_ISxdig™
 = 
_ISb™
 (4),

53 
	m_IS¥aû
 = 
_ISb™
 (5),

54 
	m_IS´št
 = 
_ISb™
 (6),

55 
	m_ISg¿ph
 = 
_ISb™
 (7),

56 
	m_ISbÏnk
 = 
_ISb™
 (8),

57 
	m_ISúŒl
 = 
_ISb™
 (9),

58 
	m_ISpunù
 = 
_ISb™
 (10),

59 
	m_IS®num
 = 
_ISb™
 (11)

79 cÚ¡ **
	$__ùy³_b_loc
 ()

80 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

81 cÚ¡ 
__št32_t
 **
	$__ùy³_tŞow”_loc
 ()

82 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

83 cÚ¡ 
__št32_t
 **
	$__ùy³_touµ”_loc
 ()

84 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

87 #iâdeà
__ılu¥lus


88 
	#__isùy³
(
c
, 
ty³
) \

89 ((*
	`__ùy³_b_loc
 ())[(è(
c
)] & (è
ty³
)

	)

90 #–ià
defšed
 
__USE_EXTERN_INLINES


91 
	#__isùy³_f
(
ty³
) \

92 
__ex‹º_šlše
 \

93 
is
##
	`ty³
 (
__c
è
__THROW
 \

95  (*
	`__ùy³_b_loc
 ())[(è(
__c
)] & (è
_IS
##
ty³
; \

96 
	}

	)
}

99 
	#__i§scii
(
c
è(((cè& ~0x7fè=ğ0è

	)

100 
	#__tßscii
(
c
è((cè& 0x7fè

	)

102 
	#__exùy³
(
Çme
è
	`Çme
 (è
__THROW


	)

108 
__exùy³
 (
i§Êum
);

109 
__exùy³
 (
i§Íha
);

110 
__exùy³
 (
isúŒl
);

111 
__exùy³
 (
isdig™
);

112 
__exùy³
 (
i¦ow”
);

113 
__exùy³
 (
isg¿ph
);

114 
__exùy³
 (
i¥ršt
);

115 
__exùy³
 (
i¥unù
);

116 
__exùy³
 (
is¥aû
);

117 
__exùy³
 (
isuµ”
);

118 
__exùy³
 (
isxdig™
);

122 
	$tŞow”
 (
__c
è
__THROW
;

125 
	$touµ”
 (
__c
è
__THROW
;

129 #ifdef 
__USE_ISOC99


130 
	`__exùy³
 (
isbÏnk
);

133 #ifdeà
__USE_GNU


135 
	$isùy³
 (
__c
, 
__mask
è
__THROW
;

138 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


142 
	$i§scii
 (
__c
è
__THROW
;

146 
	$tßscii
 (
__c
è
__THROW
;

150 
	`__exùy³
 (
_touµ”
);

151 
	`__exùy³
 (
_tŞow”
);

155 
	#__tobody
(
c
, 
f
, 
a
, 
¬gs
) \

156 (
__ex‹nsiÚ__
 \

157 ({ 
__»s
; \

158 ià( (
c
) > 1) \

160 ià(
	`__butš_cÚ¡ªt_p
 (
c
)) \

162 
__c
 = (
c
); \

163 
__»s
 = 
__c
 < -128 || __ø> 255 ? __ø: (
a
)[__c]; \

166 
__»s
 = 
f
 
¬gs
; \

169 
__»s
 = (
a
)[(è(
c
)]; \

170 
__»s
; 
	}
}))

	)

172 #ià!
defšed
 
__NO_CTYPE


173 #ifdeà
__isùy³_f


174 
	$__isùy³_f
 (
®num
)

175 
	$__isùy³_f
 (
®pha
)

176 
	$__isùy³_f
 (
úŒl
)

177 
	$__isùy³_f
 (
dig™
)

178 
	$__isùy³_f
 (
low”
)

179 
	$__isùy³_f
 (
g¿ph
)

180 
	$__isùy³_f
 (
´št
)

181 
	$__isùy³_f
 (
punù
)

182 
	$__isùy³_f
 (
¥aû
)

183 
	$__isùy³_f
 (
uµ”
)

184 
	$__isùy³_f
 (
xdig™
)

185 #ifdeà
__USE_ISOC99


186 
	$__isùy³_f
 (
bÏnk
)

188 #–ià
defšed
 
__isùy³


189 
	#i§Êum
(
c
è
	`__isùy³
((c), 
_IS®num
)

	)

190 
	#i§Íha
(
c
è
	`__isùy³
((c), 
_IS®pha
)

	)

191 
	#isúŒl
(
c
è
	`__isùy³
((c), 
_ISúŒl
)

	)

192 
	#isdig™
(
c
è
	`__isùy³
((c), 
_ISdig™
)

	)

193 
	#i¦ow”
(
c
è
	`__isùy³
((c), 
_ISlow”
)

	)

194 
	#isg¿ph
(
c
è
	`__isùy³
((c), 
_ISg¿ph
)

	)

195 
	#i¥ršt
(
c
è
	`__isùy³
((c), 
_IS´št
)

	)

196 
	#i¥unù
(
c
è
	`__isùy³
((c), 
_ISpunù
)

	)

197 
	#is¥aû
(
c
è
	`__isùy³
((c), 
_IS¥aû
)

	)

198 
	#isuµ”
(
c
è
	`__isùy³
((c), 
_ISuµ”
)

	)

199 
	#isxdig™
(
c
è
	`__isùy³
((c), 
_ISxdig™
)

	)

200 #ifdeà
__USE_ISOC99


201 
	#isbÏnk
(
c
è
	`__isùy³
((c), 
_ISbÏnk
)

	)

205 #ifdeà
__USE_EXTERN_INLINES


206 
__ex‹º_šlše
 

207 
	`__NTH
 (
	$tŞow”
 (
__c
))

209  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_tŞow”_loc
 ())[__c] : __c;

210 
	}
}

212 
__ex‹º_šlše
 

213 
__NTH
 (
	$touµ”
 (
__c
))

215  
__c
 >ğ-128 && __ø< 256 ? (*
	`__ùy³_touµ”_loc
 ())[__c] : __c;

216 
	}
}

219 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


220 
	#tŞow”
(
c
è
	`__tobody
 (c, 
tŞow”
, *
	`__ùy³_tŞow”_loc
 (), (c))

	)

221 
	#touµ”
(
c
è
	`__tobody
 (c, 
touµ”
, *
	`__ùy³_touµ”_loc
 (), (c))

	)

224 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


225 
	#i§scii
(
c
è
	`__i§scii
 (c)

	)

226 
	#tßscii
(
c
è
	`__tßscii
 (c)

	)

228 
	#_tŞow”
(
c
è((è(*
	`__ùy³_tŞow”_loc
 ())[(è(c)])

	)

229 
	#_touµ”
(
c
è((è(*
	`__ùy³_touµ”_loc
 ())[(è(c)])

	)

235 #ifdeà
__USE_XOPEN2K8


237 
	~<b™s/ty³s/loÿË_t.h
>

241 
	#__isùy³_l
(
c
, 
ty³
, 
loÿË
) \

242 ((
loÿË
)->
__ùy³_b
[(è(
c
)] & (è
ty³
)

	)

244 
	#__exùy³_l
(
Çme
) \

245 
	`Çme
 (, 
loÿË_t
è
__THROW


	)

251 
__exùy³_l
 (
i§Êum_l
);

252 
__exùy³_l
 (
i§Íha_l
);

253 
__exùy³_l
 (
isúŒl_l
);

254 
__exùy³_l
 (
isdig™_l
);

255 
__exùy³_l
 (
i¦ow”_l
);

256 
__exùy³_l
 (
isg¿ph_l
);

257 
__exùy³_l
 (
i¥ršt_l
);

258 
__exùy³_l
 (
i¥unù_l
);

259 
__exùy³_l
 (
is¥aû_l
);

260 
__exùy³_l
 (
isuµ”_l
);

261 
__exùy³_l
 (
isxdig™_l
);

263 
__exùy³_l
 (
isbÏnk_l
);

267 
	$__tŞow”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

268 
	$tŞow”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

271 
	$__touµ”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

272 
	$touµ”_l
 (
__c
, 
loÿË_t
 
__l
è
__THROW
;

274 #ià
__GNUC__
 >ğ2 && 
defšed
 
__OPTIMIZE__
 && !defšed 
__ılu¥lus


275 
	#__tŞow”_l
(
c
, 
loÿË
) \

276 
	`__tobody
 (
c
, 
__tŞow”_l
, (
loÿË
)->
__ùy³_tŞow”
, (c,†oÿË))

	)

277 
	#__touµ”_l
(
c
, 
loÿË
) \

278 
	`__tobody
 (
c
, 
__touµ”_l
, (
loÿË
)->
__ùy³_touµ”
, (c,†oÿË))

	)

279 
	#tŞow”_l
(
c
, 
loÿË
è
	`__tŞow”_l
 ((c), (loÿË))

	)

280 
	#touµ”_l
(
c
, 
loÿË
è
	`__touµ”_l
 ((c), (loÿË))

	)

284 #iâdeà
__NO_CTYPE


285 
	#__i§Êum_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®num
, (l))

	)

286 
	#__i§Íha_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS®pha
, (l))

	)

287 
	#__isúŒl_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISúŒl
, (l))

	)

288 
	#__isdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISdig™
, (l))

	)

289 
	#__i¦ow”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISlow”
, (l))

	)

290 
	#__isg¿ph_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISg¿ph
, (l))

	)

291 
	#__i¥ršt_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS´št
, (l))

	)

292 
	#__i¥unù_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISpunù
, (l))

	)

293 
	#__is¥aû_l
(
c
,
l
è
	`__isùy³_l
((c), 
_IS¥aû
, (l))

	)

294 
	#__isuµ”_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISuµ”
, (l))

	)

295 
	#__isxdig™_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISxdig™
, (l))

	)

297 
	#__isbÏnk_l
(
c
,
l
è
	`__isùy³_l
((c), 
_ISbÏnk
, (l))

	)

299 #ifdeà
__USE_MISC


300 
	#__i§scii_l
(
c
,
l
è(Ö), 
	`__i§scii
 (c))

	)

301 
	#__tßscii_l
(
c
,
l
è(Ö), 
	`__tßscii
 (c))

	)

304 
	#i§Êum_l
(
c
,
l
è
	`__i§Êum_l
 ((c), (l))

	)

305 
	#i§Íha_l
(
c
,
l
è
	`__i§Íha_l
 ((c), (l))

	)

306 
	#isúŒl_l
(
c
,
l
è
	`__isúŒl_l
 ((c), (l))

	)

307 
	#isdig™_l
(
c
,
l
è
	`__isdig™_l
 ((c), (l))

	)

308 
	#i¦ow”_l
(
c
,
l
è
	`__i¦ow”_l
 ((c), (l))

	)

309 
	#isg¿ph_l
(
c
,
l
è
	`__isg¿ph_l
 ((c), (l))

	)

310 
	#i¥ršt_l
(
c
,
l
è
	`__i¥ršt_l
 ((c), (l))

	)

311 
	#i¥unù_l
(
c
,
l
è
	`__i¥unù_l
 ((c), (l))

	)

312 
	#is¥aû_l
(
c
,
l
è
	`__is¥aû_l
 ((c), (l))

	)

313 
	#isuµ”_l
(
c
,
l
è
	`__isuµ”_l
 ((c), (l))

	)

314 
	#isxdig™_l
(
c
,
l
è
	`__isxdig™_l
 ((c), (l))

	)

316 
	#isbÏnk_l
(
c
,
l
è
	`__isbÏnk_l
 ((c), (l))

	)

318 #ifdeà
__USE_MISC


319 
	#i§scii_l
(
c
,
l
è
	`__i§scii_l
 ((c), (l))

	)

320 
	#tßscii_l
(
c
,
l
è
	`__tßscii_l
 ((c), (l))

	)

327 
__END_DECLS


	@/usr/include/dlfcn.h

19 #iâdef 
_DLFCN_H


20 
	#_DLFCN_H
 1

	)

22 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

27 
	~<b™s/dlfú.h
>

30 #ifdeà
__USE_GNU


35 
	#RTLD_NEXT
 ((*è-1l)

	)

40 
	#RTLD_DEFAULT
 ((*è0)

	)

44 
	tLmid_t
;

47 
	#LM_ID_BASE
 0

	)

48 
	#LM_ID_NEWLM
 -1

	)

52 
__BEGIN_DECLS


56 *
	$dlİ’
 (cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

60 
	$dlşo£
 (*
__hªdË
è
__THROWNL
 
	`__nÚnuÎ
 ((1));

64 *
	$dlsym
 (*
__»¡riù
 
__hªdË
,

65 cÚ¡ *
__»¡riù
 
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((2));

67 #ifdeà
__USE_GNU


69 *
	$dlmİ’
 (
Lmid_t
 
__nsid
, cÚ¡ *
__fe
, 
__mode
è
__THROWNL
;

73 *
	$dlvsym
 (*
__»¡riù
 
__hªdË
,

74 cÚ¡ *
__»¡riù
 
__Çme
,

75 cÚ¡ *
__»¡riù
 
__v”siÚ
)

76 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

82 *
	$dË¼Ü
 (è
__THROW
;

85 #ifdeà
__USE_GNU


90 cÚ¡ *
dli_âame
;

91 *
dli_fba£
;

92 cÚ¡ *
dli_¢ame
;

93 *
dli_§ddr
;

94 } 
	tDl_šfo
;

98 
	$dÏddr
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
)

99 
__THROW
 
	`__nÚnuÎ
 ((2));

102 
	$dÏddr1
 (cÚ¡ *
__add»ss
, 
Dl_šfo
 *
__šfo
,

103 **
__exŒa_šfo
, 
__æags
è
__THROW
 
	`__nÚnuÎ
 ((2));

111 
RTLD_DL_SYMENT
 = 1,

114 
RTLD_DL_LINKMAP
 = 2

123 
	$dlšfo
 (*
__»¡riù
 
__hªdË
,

124 
__»que¡
, *
__»¡riù
 
__¬g
)

125 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

131 
RTLD_DI_LMID
 = 1,

135 
RTLD_DI_LINKMAP
 = 2,

137 
RTLD_DI_CONFIGADDR
 = 3,

144 
RTLD_DI_SERINFO
 = 4,

145 
RTLD_DI_SERINFOSIZE
 = 5,

149 
RTLD_DI_ORIGIN
 = 6,

151 
RTLD_DI_PROFILENAME
 = 7,

152 
RTLD_DI_PROFILEOUT
 = 8,

157 
RTLD_DI_TLS_MODID
 = 9,

163 
RTLD_DI_TLS_DATA
 = 10,

165 
RTLD_DI_MAX
 = 10

173 *
dls_Çme
;

174 
dls_æags
;

175 } 
	tDl_£½©h
;

181 
size_t
 
dls_size
;

182 
dls_út
;

183 
Dl_£½©h
 
dls_£½©h
[1];

184 } 
	tDl_£ršfo
;

188 
__END_DECLS


	@/usr/include/errno.h

22 #iâdef 
_ERRNO_H


23 
	#_ERRNO_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	~<b™s/”ºo.h
>

32 #iâdeà
__ASSEMBLER__


34 
__BEGIN_DECLS


37 *
	$__”ºo_loÿtiÚ
 (è
__THROW
 
__©Œibu‹_cÚ¡__
;

38 
	#”ºo
 (*
	`__”ºo_loÿtiÚ
 ())

	)

40 #ifdeà
__USE_GNU


45 *
´og¿m_švoÿtiÚ_Çme
;

46 *
´og¿m_švoÿtiÚ_shÜt_Çme
;

50 #iâdeà
__”rÜ_t_defšed


51 
	#__”rÜ_t_defšed
 1

	)

52 
	t”rÜ_t
;

57 
__END_DECLS


	@/usr/include/fcntl.h

22 #iâdef 
_FCNTL_H


23 
	#_FCNTL_H
 1

	)

25 
	~<ã©u»s.h
>

28 
	g__BEGIN_DECLS


31 
	~<b™s/ty³s.h
>

35 
	~<b™s/fú.h
>

39 #ifdeà
__O_TMPFILE


40 
	#__OPEN_NEEDS_MODE
(
oæag
) \

41 (((
oæag
è& 
O_CREAT
è!ğ0 || ((oæagè& 
__O_TMPFILE
è=ğ__O_TMPFILE)

	)

43 
	#__OPEN_NEEDS_MODE
(
oæag
è(((oæagè& 
O_CREAT
è!ğ0)

	)

49 #iâdeà
__mode_t_defšed


50 
__mode_t
 
	tmode_t
;

51 
	#__mode_t_defšed


	)

54 #iâdeà
__off_t_defšed


55 #iâdeà
__USE_FILE_OFFSET64


56 
__off_t
 
	toff_t
;

58 
__off64_t
 
	toff_t
;

60 
	#__off_t_defšed


	)

63 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


64 
__off64_t
 
	toff64_t
;

65 
	#__off64_t_defšed


	)

68 #iâdeà
__pid_t_defšed


69 
__pid_t
 
	tpid_t
;

70 
	#__pid_t_defšed


	)

74 #ifdeà
__USE_XOPEN2K8


75 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

77 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


78 
	~<b™s/¡©.h
>

80 
	#S_IFMT
 
__S_IFMT


	)

81 
	#S_IFDIR
 
__S_IFDIR


	)

82 
	#S_IFCHR
 
__S_IFCHR


	)

83 
	#S_IFBLK
 
__S_IFBLK


	)

84 
	#S_IFREG
 
__S_IFREG


	)

85 #ifdeà
__S_IFIFO


86 
	#S_IFIFO
 
__S_IFIFO


	)

88 #ifdeà
__S_IFLNK


89 
	#S_IFLNK
 
__S_IFLNK


	)

91 #ià(
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8
è&& defšed 
__S_IFSOCK


92 
	#S_IFSOCK
 
__S_IFSOCK


	)

97 
	#S_ISUID
 
__S_ISUID


	)

98 
	#S_ISGID
 
__S_ISGID


	)

100 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


102 
	#S_ISVTX
 
__S_ISVTX


	)

105 
	#S_IRUSR
 
__S_IREAD


	)

106 
	#S_IWUSR
 
__S_IWRITE


	)

107 
	#S_IXUSR
 
__S_IEXEC


	)

109 
	#S_IRWXU
 (
__S_IREAD
|
__S_IWRITE
|
__S_IEXEC
)

	)

111 
	#S_IRGRP
 (
S_IRUSR
 >> 3è

	)

112 
	#S_IWGRP
 (
S_IWUSR
 >> 3è

	)

113 
	#S_IXGRP
 (
S_IXUSR
 >> 3è

	)

115 
	#S_IRWXG
 (
S_IRWXU
 >> 3)

	)

117 
	#S_IROTH
 (
S_IRGRP
 >> 3è

	)

118 
	#S_IWOTH
 (
S_IWGRP
 >> 3è

	)

119 
	#S_IXOTH
 (
S_IXGRP
 >> 3è

	)

121 
	#S_IRWXO
 (
S_IRWXG
 >> 3)

	)

124 #ifdef 
__USE_MISC


125 #iâdeà
R_OK


128 
	#R_OK
 4

	)

129 
	#W_OK
 2

	)

130 
	#X_OK
 1

	)

131 
	#F_OK
 0

	)

136 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


137 
	#SEEK_SET
 0

	)

138 
	#SEEK_CUR
 1

	)

139 
	#SEEK_END
 2

	)

147 
fú
 (
__fd
, 
__cmd
, ...);

156 #iâdeà
__USE_FILE_OFFSET64


157 
	$İ’
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

159 #ifdeà
__REDIRECT


160 
	`__REDIRECT
 (
İ’
, (cÚ¡ *
__fe
, 
__oæag
, ...), 
İ’64
)

161 
	`__nÚnuÎ
 ((1));

163 
	#İ’
 
İ’64


	)

166 #ifdeà
__USE_LARGEFILE64


167 
	$İ’64
 (cÚ¡ *
__fe
, 
__oæag
, ...è
	`__nÚnuÎ
 ((1));

170 #ifdeà
__USE_ATFILE


180 #iâdeà
__USE_FILE_OFFSET64


181 
	$İ’©
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

182 
	`__nÚnuÎ
 ((2));

184 #ifdeà
__REDIRECT


185 
	`__REDIRECT
 (
İ’©
, (
__fd
, cÚ¡ *
__fe
, 
__oæag
,

186 ...), 
İ’©64
è
	`__nÚnuÎ
 ((2));

188 
	#İ’©
 
İ’©64


	)

191 #ifdeà
__USE_LARGEFILE64


192 
	$İ’©64
 (
__fd
, cÚ¡ *
__fe
, 
__oæag
, ...)

193 
	`__nÚnuÎ
 ((2));

202 #iâdeà
__USE_FILE_OFFSET64


203 
	$ü—t
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

205 #ifdeà
__REDIRECT


206 
	`__REDIRECT
 (
ü—t
, (cÚ¡ *
__fe
, 
mode_t
 
__mode
),

207 
ü—t64
è
	`__nÚnuÎ
 ((1));

209 
	#ü—t
 
ü—t64


	)

212 #ifdeà
__USE_LARGEFILE64


213 
	$ü—t64
 (cÚ¡ *
__fe
, 
mode_t
 
__mode
è
	`__nÚnuÎ
 ((1));

216 #ià!
defšed
 
F_LOCK
 && (defšed 
__USE_MISC
 || (defšed 
__USE_XOPEN_EXTENDED
 \

217 && !
defšed
 
__USE_POSIX
))

226 
	#F_ULOCK
 0

	)

227 
	#F_LOCK
 1

	)

228 
	#F_TLOCK
 2

	)

229 
	#F_TEST
 3

	)

231 #iâdeà
__USE_FILE_OFFSET64


232 
	`lockf
 (
__fd
, 
__cmd
, 
off_t
 
__Ën
);

234 #ifdeà
__REDIRECT


235 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
), 
lockf64
);

237 
	#lockf
 
lockf64


	)

240 #ifdeà
__USE_LARGEFILE64


241 
	`lockf64
 (
__fd
, 
__cmd
, 
off64_t
 
__Ën
);

245 #ifdeà
__USE_XOPEN2K


248 #iâdeà
__USE_FILE_OFFSET64


249 
	$posix_çdvi£
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
,

250 
__advi£
è
__THROW
;

252 #ifdeà
__REDIRECT_NTH


253 
	`__REDIRECT_NTH
 (
posix_çdvi£
, (
__fd
, 
__off64_t
 
__off£t
,

254 
__off64_t
 
__Ën
, 
__advi£
),

255 
posix_çdvi£64
);

257 
	#posix_çdvi£
 
posix_çdvi£64


	)

260 #ifdeà
__USE_LARGEFILE64


261 
	$posix_çdvi£64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
,

262 
__advi£
è
__THROW
;

270 #iâdeà
__USE_FILE_OFFSET64


271 
	`posix_çÎoÿ‹
 (
__fd
, 
off_t
 
__off£t
, off_ˆ
__Ën
);

273 #ifdeà
__REDIRECT


274 
	`__REDIRECT
 (
posix_çÎoÿ‹
, (
__fd
, 
__off64_t
 
__off£t
,

275 
__off64_t
 
__Ën
),

276 
posix_çÎoÿ‹64
);

278 
	#posix_çÎoÿ‹
 
posix_çÎoÿ‹64


	)

281 #ifdeà
__USE_LARGEFILE64


282 
	`posix_çÎoÿ‹64
 (
__fd
, 
off64_t
 
__off£t
, off64_ˆ
__Ën
);

288 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ
 \

289 && 
defšed
 
__va_¬g_·ck_Ën


290 
	~<b™s/fú2.h
>

293 
__END_DECLS


	@/usr/include/limits.h

22 #iâdeà
_LIBC_LIMITS_H_


23 
	#_LIBC_LIMITS_H_
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

32 
	#MB_LEN_MAX
 16

	)

37 #ià!
defšed
 
__GNUC__
 || __GNUC__ < 2

42 #iâdeà
_LIMITS_H


43 
	#_LIMITS_H
 1

	)

45 
	~<b™s/wÜdsize.h
>

54 
	#CHAR_BIT
 8

	)

57 
	#SCHAR_MIN
 (-128)

	)

58 
	#SCHAR_MAX
 127

	)

61 
	#UCHAR_MAX
 255

	)

64 #ifdeà
__CHAR_UNSIGNED__


65 
	#CHAR_MIN
 0

	)

66 
	#CHAR_MAX
 
UCHAR_MAX


	)

68 
	#CHAR_MIN
 
SCHAR_MIN


	)

69 
	#CHAR_MAX
 
SCHAR_MAX


	)

73 
	#SHRT_MIN
 (-32768)

	)

74 
	#SHRT_MAX
 32767

	)

77 
	#USHRT_MAX
 65535

	)

80 
	#INT_MIN
 (-
INT_MAX
 - 1)

	)

81 
	#INT_MAX
 2147483647

	)

84 
	#UINT_MAX
 4294967295U

	)

87 #ià
__WORDSIZE
 == 64

88 
	#LONG_MAX
 9223372036854775807L

	)

90 
	#LONG_MAX
 2147483647L

	)

92 
	#LONG_MIN
 (-
LONG_MAX
 - 1L)

	)

95 #ià
__WORDSIZE
 == 64

96 
	#ULONG_MAX
 18446744073709551615UL

	)

98 
	#ULONG_MAX
 4294967295UL

	)

101 #ifdeà
__USE_ISOC99


104 
	#LLONG_MAX
 9223372036854775807LL

	)

105 
	#LLONG_MIN
 (-
LLONG_MAX
 - 1LL)

	)

108 
	#ULLONG_MAX
 18446744073709551615ULL

	)

122 #ià
defšed
 
__GNUC__
 && !defšed 
_GCC_LIMITS_H_


124 #šşude_Ãxˆ<
lim™s
.
h
>

130 #ià
defšed
 
__USE_ISOC99
 && defšed 
__GNUC__


131 #iâdeà
LLONG_MIN


132 
	#LLONG_MIN
 (-
LLONG_MAX
-1)

	)

134 #iâdeà
LLONG_MAX


135 
	#LLONG_MAX
 
__LONG_LONG_MAX__


	)

137 #iâdeà
ULLONG_MAX


138 
	#ULLONG_MAX
 (
LLONG_MAX
 * 2ULL + 1)

	)

145 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

146 #iâdeà
CHAR_WIDTH


147 
	#CHAR_WIDTH
 8

	)

149 #iâdeà
SCHAR_WIDTH


150 
	#SCHAR_WIDTH
 8

	)

152 #iâdeà
UCHAR_WIDTH


153 
	#UCHAR_WIDTH
 8

	)

155 #iâdeà
SHRT_WIDTH


156 
	#SHRT_WIDTH
 16

	)

158 #iâdeà
USHRT_WIDTH


159 
	#USHRT_WIDTH
 16

	)

161 #iâdeà
INT_WIDTH


162 
	#INT_WIDTH
 32

	)

164 #iâdeà
UINT_WIDTH


165 
	#UINT_WIDTH
 32

	)

167 #iâdeà
LONG_WIDTH


168 
	#LONG_WIDTH
 
__WORDSIZE


	)

170 #iâdeà
ULONG_WIDTH


171 
	#ULONG_WIDTH
 
__WORDSIZE


	)

173 #iâdeà
LLONG_WIDTH


174 
	#LLONG_WIDTH
 64

	)

176 #iâdeà
ULLONG_WIDTH


177 
	#ULLONG_WIDTH
 64

	)

181 #ifdef 
__USE_POSIX


183 
	~<b™s/posix1_lim.h
>

186 #ifdef 
__USE_POSIX2


187 
	~<b™s/posix2_lim.h
>

190 #ifdef 
__USE_XOPEN


191 
	~<b™s/xİ’_lim.h
>

	@/usr/include/locale.h

22 #iâdef 
_LOCALE_H


23 
	#_LOCALE_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	#__Ãed_NULL


	)

28 
	~<¡ddef.h
>

29 
	~<b™s/loÿË.h
>

31 
	g__BEGIN_DECLS


35 
	#LC_CTYPE
 
__LC_CTYPE


	)

36 
	#LC_NUMERIC
 
__LC_NUMERIC


	)

37 
	#LC_TIME
 
__LC_TIME


	)

38 
	#LC_COLLATE
 
__LC_COLLATE


	)

39 
	#LC_MONETARY
 
__LC_MONETARY


	)

40 
	#LC_MESSAGES
 
__LC_MESSAGES


	)

41 
	#LC_ALL
 
__LC_ALL


	)

42 
	#LC_PAPER
 
__LC_PAPER


	)

43 
	#LC_NAME
 
__LC_NAME


	)

44 
	#LC_ADDRESS
 
__LC_ADDRESS


	)

45 
	#LC_TELEPHONE
 
__LC_TELEPHONE


	)

46 
	#LC_MEASUREMENT
 
__LC_MEASUREMENT


	)

47 
	#LC_IDENTIFICATION
 
__LC_IDENTIFICATION


	)

51 
	slcÚv


55 *
	mdecim®_pošt
;

56 *
	mthou§nds_£p
;

62 *
	mgroupšg
;

68 *
	mšt_cu¼_symbŞ
;

69 *
	mcu¼’cy_symbŞ
;

70 *
	mmÚ_decim®_pošt
;

71 *
	mmÚ_thou§nds_£p
;

72 *
	mmÚ_groupšg
;

73 *
	mpos™ive_sign
;

74 *
	mÃg©ive_sign
;

75 
	mšt_äac_dig™s
;

76 
	mäac_dig™s
;

78 
	mp_cs_´eûdes
;

80 
	mp_£p_by_¥aû
;

82 
	mn_cs_´eûdes
;

84 
	mn_£p_by_¥aû
;

91 
	mp_sign_po¢
;

92 
	mn_sign_po¢
;

93 #ifdeà
__USE_ISOC99


95 
	mšt_p_cs_´eûdes
;

97 
	mšt_p_£p_by_¥aû
;

99 
	mšt_n_cs_´eûdes
;

101 
	mšt_n_£p_by_¥aû
;

108 
	mšt_p_sign_po¢
;

109 
	mšt_n_sign_po¢
;

111 
	m__št_p_cs_´eûdes
;

112 
	m__št_p_£p_by_¥aû
;

113 
	m__št_n_cs_´eûdes
;

114 
	m__št_n_£p_by_¥aû
;

115 
	m__št_p_sign_po¢
;

116 
	m__št_n_sign_po¢
;

122 *
	$£oÿË
 (
__ÿ‹gÜy
, cÚ¡ *
__loÿË
è
__THROW
;

125 
lcÚv
 *
	$loÿËcÚv
 (è
__THROW
;

128 #ifdef 
__USE_XOPEN2K8


135 
	~<b™s/ty³s/loÿË_t.h
>

141 
loÿË_t
 
	$ÃwloÿË
 (
__ÿ‹gÜy_mask
, cÚ¡ *
__loÿË
,

142 
loÿË_t
 
__ba£
è
__THROW
;

148 
	#LC_CTYPE_MASK
 (1 << 
__LC_CTYPE
)

	)

149 
	#LC_NUMERIC_MASK
 (1 << 
__LC_NUMERIC
)

	)

150 
	#LC_TIME_MASK
 (1 << 
__LC_TIME
)

	)

151 
	#LC_COLLATE_MASK
 (1 << 
__LC_COLLATE
)

	)

152 
	#LC_MONETARY_MASK
 (1 << 
__LC_MONETARY
)

	)

153 
	#LC_MESSAGES_MASK
 (1 << 
__LC_MESSAGES
)

	)

154 
	#LC_PAPER_MASK
 (1 << 
__LC_PAPER
)

	)

155 
	#LC_NAME_MASK
 (1 << 
__LC_NAME
)

	)

156 
	#LC_ADDRESS_MASK
 (1 << 
__LC_ADDRESS
)

	)

157 
	#LC_TELEPHONE_MASK
 (1 << 
__LC_TELEPHONE
)

	)

158 
	#LC_MEASUREMENT_MASK
 (1 << 
__LC_MEASUREMENT
)

	)

159 
	#LC_IDENTIFICATION_MASK
 (1 << 
__LC_IDENTIFICATION
)

	)

160 
	#LC_ALL_MASK
 (
LC_CTYPE_MASK
 \

161 | 
LC_NUMERIC_MASK
 \

162 | 
LC_TIME_MASK
 \

163 | 
LC_COLLATE_MASK
 \

164 | 
LC_MONETARY_MASK
 \

165 | 
LC_MESSAGES_MASK
 \

166 | 
LC_PAPER_MASK
 \

167 | 
LC_NAME_MASK
 \

168 | 
LC_ADDRESS_MASK
 \

169 | 
LC_TELEPHONE_MASK
 \

170 | 
LC_MEASUREMENT_MASK
 \

171 | 
LC_IDENTIFICATION_MASK
 \

172 )

	)

176 
loÿË_t
 
	$du¶oÿË
 (
loÿË_t
 
__d©a£t
è
__THROW
;

180 
	$ä“loÿË
 (
loÿË_t
 
__d©a£t
è
__THROW
;

187 
loÿË_t
 
	$u£loÿË
 (
loÿË_t
 
__d©a£t
è
__THROW
;

191 
	#LC_GLOBAL_LOCALE
 ((
loÿË_t
è-1L)

	)

195 
__END_DECLS


	@/usr/include/math.h

23 #iâdef 
_MATH_H


24 
	#_MATH_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<b™s/libc-h—d”-¡¬t.h
>

29 
	g__BEGIN_DECLS


32 
	~<b™s/ty³s.h
>

35 
	~<b™s/m©h-veùÜ.h
>

38 
	~<b™s/æßŠ.h
>

42 
	~<b™s/huge_v®.h
>

44 #ià
__HAVE_FLOAT128
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

45 
	~<b™s/huge_v®_æt128.h
>

48 #ifdeà
__USE_ISOC99


49 
	~<b™s/huge_v®f.h
>

50 
	~<b™s/huge_v®l.h
>

53 
	~<b™s/šf.h
>

56 
	~<b™s/Çn.h
>

59 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

61 #ià
__GNUC_PREREQ
 (3, 3)

62 
	#SNANF
 (
	`__butš_Çnsf
 (""))

	)

63 
	#SNAN
 (
	`__butš_Çns
 (""))

	)

64 
	#SNANL
 (
	`__butš_Çn¦
 (""))

	)

67 #ià
__HAVE_FLOAT128
 && 
__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

68 
	#SNANF128
 (
	`__butš_Çnsf128
 (""))

	)

72 
	~<b™s/æt-ev®-m‘hod.h
>

74 #ifdeà
__USE_ISOC99


82 #ià
__GLIBC_FLT_EVAL_METHOD
 == 0 || __GLIBC_FLT_EVAL_METHOD == 16

83 
	tæßt_t
;

84 
	tdoubË_t
;

85 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 1

86 
	tæßt_t
;

87 
	tdoubË_t
;

88 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 2

89 
	tæßt_t
;

90 
	tdoubË_t
;

91 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 32

92 
_Flßt32
 
	tæßt_t
;

93 
	tdoubË_t
;

94 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 33

95 
_Flßt32x
 
	tæßt_t
;

96 
_Flßt32x
 
	tdoubË_t
;

97 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 64

98 
_Flßt64
 
	tæßt_t
;

99 
_Flßt64
 
	tdoubË_t
;

100 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 65

101 
_Flßt64x
 
	tæßt_t
;

102 
_Flßt64x
 
	tdoubË_t
;

103 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 128

104 
_Flßt128
 
	tæßt_t
;

105 
_Flßt128
 
	tdoubË_t
;

106 #–ià
__GLIBC_FLT_EVAL_METHOD
 == 129

107 
_Flßt128x
 
	tæßt_t
;

108 
_Flßt128x
 
	tdoubË_t
;

124 
	~<b™s/å-logb.h
>

125 #ifdeà
__USE_ISOC99


126 #ià
__FP_LOGB0_IS_MIN


127 
	#FP_ILOGB0
 (-2147483647 - 1)

	)

129 
	#FP_ILOGB0
 (-2147483647)

	)

131 #ià
__FP_LOGBNAN_IS_MIN


132 
	#FP_ILOGBNAN
 (-2147483647 - 1)

	)

134 
	#FP_ILOGBNAN
 2147483647

	)

137 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

138 #ià
__WORDSIZE
 == 32

139 
	#__FP_LONG_MAX
 0x7fffffffL

	)

141 
	#__FP_LONG_MAX
 0x7fffffffffffffffL

	)

143 #ià
__FP_LOGB0_IS_MIN


144 
	#FP_LLOGB0
 (-
__FP_LONG_MAX
 - 1)

	)

146 
	#FP_LLOGB0
 (-
__FP_LONG_MAX
)

	)

148 #ià
__FP_LOGBNAN_IS_MIN


149 
	#FP_LLOGBNAN
 (-
__FP_LONG_MAX
 - 1)

	)

151 
	#FP_LLOGBNAN
 
__FP_LONG_MAX


	)

167 
	~<b™s/å-ç¡.h
>

169 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

173 
	mFP_INT_UPWARD
 =

174 
	#FP_INT_UPWARD
 0

	)

175 
FP_INT_UPWARD
,

176 
	mFP_INT_DOWNWARD
 =

177 
	#FP_INT_DOWNWARD
 1

	)

178 
FP_INT_DOWNWARD
,

179 
	mFP_INT_TOWARDZERO
 =

180 
	#FP_INT_TOWARDZERO
 2

	)

181 
FP_INT_TOWARDZERO
,

182 
	mFP_INT_TONEARESTFROMZERO
 =

183 
	#FP_INT_TONEARESTFROMZERO
 3

	)

184 
FP_INT_TONEARESTFROMZERO
,

185 
	mFP_INT_TONEAREST
 =

186 
	#FP_INT_TONEAREST
 4

	)

187 
FP_INT_TONEAREST
,

196 
	#__SIMD_DECL
(
funùiÚ
è
	`__CONCAT
 (
__DECL_SIMD_
, funùiÚ)

	)

198 
	#__MATHCALL_VEC
(
funùiÚ
, 
suffix
, 
¬gs
) \

199 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

200 
	`__MATHCALL
 (
funùiÚ
, 
suffix
, 
¬gs
)

	)

202 
	#__MATHDECL_VEC
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

203 
	`__SIMD_DECL
 (
	`__MATH_PRECNAME
 (
funùiÚ
, 
suffix
)) \

204 
	`__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
)

	)

206 
	#__MATHCALL
(
funùiÚ
,
suffix
, 
¬gs
) \

207 
	`__MATHDECL
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
)

	)

208 
	#__MATHDECL
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

209 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
); \

210 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
)

	)

211 
	#__MATHCALLX
(
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

212 
	`__MATHDECLX
 (
_MdoubË_
,
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
)

	)

213 
	#__MATHDECLX
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
©Œib
) \

214 
	`__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
); \

215 
	`__MATHDECL_1
(
ty³
, 
	`__CONCAT
(
__
,
funùiÚ
),
suffix
, 
¬gs
è
	`__©Œibu‹__
 (
©Œib
)

	)

216 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

217 
ty³
 
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
è
¬gs
 
__THROW


	)

219 
	#_MdoubË_
 

	)

220 
	#__MATH_PRECNAME
(
Çme
,
r
è
	`__CONCAT
Òame,r)

	)

221 
	#__MATH_DECLARING_DOUBLE
 1

	)

222 
	#__MATH_DECLARING_FLOATN
 0

	)

223 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

224 
	~<b™s/m©hÿÎs.h
>

225 #undeà
_MdoubË_


226 #undeà
__MATH_PRECNAME


227 #undeà
__MATH_DECLARING_DOUBLE


228 #undeà
__MATH_DECLARING_FLOATN


230 #ifdeà
__USE_ISOC99


236 #iâdeà
_Mæßt_


237 
	#_Mæßt_
 

	)

239 
	#_MdoubË_
 
_Mæßt_


	)

240 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f
##
	)
r

241 
	#__MATH_DECLARING_DOUBLE
 0

	)

242 
	#__MATH_DECLARING_FLOATN
 0

	)

243 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

244 
	~<b™s/m©hÿÎs.h
>

245 #undeà
_MdoubË_


246 #undeà
__MATH_PRECNAME


247 #undeà
__MATH_DECLARING_DOUBLE


248 #undeà
__MATH_DECLARING_FLOATN


250 #ià!(
defšed
 
__NO_LONG_DOUBLE_MATH
 && defšed 
_LIBC
) \

251 || 
defšed
 
__LDBL_COMPAT
 \

252 || 
defšed
 
_LIBC_TEST


253 #ifdeà
__LDBL_COMPAT


255 #ifdeà
__USE_ISOC99


256 
	$__Ædbl_Ãx‰ow¬df
 (
__x
, 
__y
)

257 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

258 #ifdeà
__REDIRECT_NTH


259 
	`__REDIRECT_NTH
 (
Ãx‰ow¬df
, (
__x
, 
__y
),

260 
__Ædbl_Ãx‰ow¬df
)

261 
	`__©Œibu‹__
 ((
__cÚ¡__
));

262 
	`__REDIRECT_NTH
 (
Ãx‰ow¬d
, (
__x
, 
__y
),

263 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

264 
	`__REDIRECT_NTH
 (
Ãx‰ow¬dl
,

265 (
__x
, 
__y
),

266 
Ãxá”
è
	`__©Œibu‹__
 ((
__cÚ¡__
));

270 #undeà
__MATHDECL_1


271 
	#__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
®Ÿs
) \

272 
ty³
 
	`__REDIRECT_NTH
(
	`__MATH_PRECNAME
(
funùiÚ
,
suffix
), \

273 
¬gs
, 
®Ÿs
)

	)

274 
	#__MATHDECL_1
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
) \

275 
	`__MATHDECL_2
(
ty³
, 
funùiÚ
,
suffix
, 
¬gs
, 
	`__CONCAT
(funùiÚ,suffix))

	)

281 #iâdeà
_MlÚg_doubË_


282 
	#_MlÚg_doubË_
 

	)

284 
	#_MdoubË_
 
_MlÚg_doubË_


	)

285 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
l
##
	)
r

286 
	#__MATH_DECLARING_DOUBLE
 0

	)

287 
	#__MATH_DECLARING_FLOATN
 0

	)

288 
	#__MATH_DECLARE_LDOUBLE
 1

	)

289 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

290 
	~<b™s/m©hÿÎs.h
>

291 #undeà
_MdoubË_


292 #undeà
__MATH_PRECNAME


293 #undeà
__MATH_DECLARING_DOUBLE


294 #undeà
__MATH_DECLARING_FLOATN


303 #ià
__HAVE_DISTINCT_FLOAT128
 || (
__HAVE_FLOAT128
 && !
defšed
 
_LIBC
)

304 #iâdeà
_Mæßt128_


305 
	#_Mæßt128_
 
_Flßt128


	)

307 
	#_MdoubË_
 
_Mæßt128_


	)

308 
	#__MATH_PRECNAME
(
Çme
,
r
èÇme##
f128
##
	)
r

309 
	#__MATH_DECLARING_DOUBLE
 0

	)

310 
	#__MATH_DECLARING_FLOATN
 1

	)

311 #ià
__HAVE_DISTINCT_FLOAT128


312 
	~<b™s/m©hÿÎs-h–³r-funùiÚs.h
>

314 #ià
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

315 
	~<b™s/m©hÿÎs.h
>

317 #undeà
_MdoubË_


318 #undeà
__MATH_PRECNAME


319 #undeà
__MATH_DECLARING_DOUBLE


320 #undeà
__MATH_DECLARING_FLOATN


323 #undeà
__MATHDECL_1


324 #undeà
__MATHDECL


325 #undeà
__MATHCALL


328 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


330 
signgam
;

343 #ifdeà
__NO_LONG_DOUBLE_MATH


344 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

345 ( (
TG_ARG
è=ğ (è? 
FUNC
 ## 
f
 
ARGS
 : FUNC ARGS)

	)

346 #–ià
__HAVE_DISTINCT_FLOAT128


347 #ià
__HAVE_GENERIC_SELECTION


348 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

349 
	`_G’”ic
 ((
TG_ARG
), \

350 : 
FUNC
 ## 
f
 
ARGS
, \

351 : 
FUNC
 
ARGS
, \

352 : 
FUNC
 ## 
l
 
ARGS
, \

353 
_Flßt128
: 
FUNC
 ## 
f128
 
ARGS
)

	)

355 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

356 
__butš_choo£_ex´
 \

357 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
TG_ARG
), ), \

358 
FUNC
 ## 
f
 
ARGS
, \

359 
__butš_choo£_ex´
 \

360 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
TG_ARG
), ), \

361 
FUNC
 
ARGS
, \

362 
__butš_choo£_ex´
 \

363 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
TG_ARG
), ), \

364 
FUNC
 ## 
l
 
ARGS
, \

365 
FUNC
 ## 
f128
 
ARGS
)))

	)

368 
	#__MATH_TG
(
TG_ARG
, 
FUNC
, 
ARGS
) \

369 ( (
TG_ARG
) ==  () \

370 ? 
FUNC
 ## 
f
 
ARGS
 \

371 :  (
TG_ARG
) ==  () \

372 ? 
FUNC
 
ARGS
 \

373 : 
FUNC
 ## 
l
 
ARGS
)

	)

377 #ifdeà
__USE_ISOC99


382 
FP_NAN
 =

383 
	#FP_NAN
 0

	)

384 
FP_NAN
,

385 
FP_INFINITE
 =

386 
	#FP_INFINITE
 1

	)

387 
FP_INFINITE
,

388 
FP_ZERO
 =

389 
	#FP_ZERO
 2

	)

390 
FP_ZERO
,

391 
FP_SUBNORMAL
 =

392 
	#FP_SUBNORMAL
 3

	)

393 
FP_SUBNORMAL
,

394 
FP_NORMAL
 =

395 
	#FP_NORMAL
 4

	)

396 
FP_NORMAL


404 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__
 \

405 && (!
defšed
 
__OPTIMIZE_SIZE__
 || defšed 
__ılu¥lus
)

412 
	#åşassify
(
x
è
	`__butš_åşassify
 (
FP_NAN
, 
FP_INFINITE
, \

413 
FP_NORMAL
, 
FP_SUBNORMAL
, 
FP_ZERO
, 
x
)

	)

415 
	#åşassify
(
x
è
	`__MATH_TG
 ((x), 
__åşassify
, (x))

	)

419 #ià
	`__GNUC_PREREQ
 (6,0)

420 
	#signb™
(
x
è
	`__butš_signb™
 (x)

	)

421 #–ià
	`__GNUC_PREREQ
 (4,0)

422 
	#signb™
(
x
è
	`__MATH_TG
 ((x), 
__butš_signb™
, (x))

	)

424 
	#signb™
(
x
è
	`__MATH_TG
 ((x), 
__signb™
, (x))

	)

428 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


429 
	#isfš™e
(
x
è
	`__butš_isfš™e
 (x)

	)

431 
	#isfš™e
(
x
è
	`__MATH_TG
 ((x), 
__fš™e
, (x))

	)

435 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


436 
	#i¢Üm®
(
x
è
	`__butš_i¢Üm®
 (x)

	)

438 
	#i¢Üm®
(
x
è(
	`åşassify
 (xè=ğ
FP_NORMAL
)

	)

443 #ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


444 
	#i¢ª
(
x
è
	`__butš_i¢ª
 (x)

	)

446 
	#i¢ª
(
x
è
	`__MATH_TG
 ((x), 
__i¢ª
, (x))

	)

450 #ià
__HAVE_DISTINCT_FLOAT128
 && !
	`__GNUC_PREREQ
 (7,0) \

451 && !
defšed
 
__SUPPORT_SNAN__
 && !defšed 
__ılu¥lus


457 
	#isšf
(
x
) \

458 (
	`__butš_ty³s_com·tibË_p
 (
	`__ty³of
 (
x
), 
_Flßt128
) \

459 ? 
	`__isšff128
 (
x
è: 
	`__butš_isšf_sign
 (x))

	)

460 #–ià
	`__GNUC_PREREQ
 (4,4è&& !
defšed
 
__SUPPORT_SNAN__


461 
	#isšf
(
x
è
	`__butš_isšf_sign
 (x)

	)

463 
	#isšf
(
x
è
	`__MATH_TG
 ((x), 
__isšf
, (x))

	)

467 
	#MATH_ERRNO
 1

	)

468 
	#MATH_ERREXCEPT
 2

	)

473 #iâdeà
__FAST_MATH__


474 
	#m©h_”rhªdlšg
 (
MATH_ERRNO
 | 
MATH_ERREXCEPT
)

	)

479 #ià
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

480 
	~<b™s/isÿnÚiÿl.h
>

483 #iâdeà
__ılu¥lus


484 
	#issigÇlšg
(
x
è
	`__MATH_TG
 ((x), 
__issigÇlšg
, (x))

	)

493 
šlše
 
	`issigÇlšg
 (
__v®
è{  
	`__issigÇlšgf
 (__val); }

494 
šlše
 
	`issigÇlšg
 (
__v®
è{  
	`__issigÇlšg
 (__val); }

495 
šlše
 

496 
	`issigÇlšg
 (
__v®
)

498 #ifdeà
__NO_LONG_DOUBLE_MATH


499  
	`__issigÇlšg
 (
__v®
);

501  
	`__issigÇlšgl
 (
__v®
);

504 #ià
__HAVE_DISTINCT_FLOAT128


505 
šlše
 
	`issigÇlšg
 (
_Flßt128
 
__v®
è{  
	`__issigÇlšgf128
 (__val); }

507 
	}
}

511 
	#issubnÜm®
(
x
è(
	`åşassify
 (xè=ğ
FP_SUBNORMAL
)

	)

514 #iâdeà
__ılu¥lus


515 #ifdeà
__SUPPORT_SNAN__


516 
	#isz”o
(
x
è(
	`åşassify
 (xè=ğ
FP_ZERO
)

	)

518 
	#isz”o
(
x
è(((
	`__ty³of
 (x)è(x)è=ğ0)

	)

522 #ifdeà
__SUPPORT_SNAN__


523 
šlše
 

524 
isz”o
 (
__v®
)

526  
__åşassifyf
 (
__v®
è=ğ
FP_ZERO
;

528 
šlše
 

529 
isz”o
 (
__v®
)

531  
__åşassify
 (
__v®
è=ğ
FP_ZERO
;

533 
šlše
 

534 
isz”o
 (
__v®
)

536 #ifdeà
__NO_LONG_DOUBLE_MATH


537  
__åşassify
 (
__v®
è=ğ
FP_ZERO
;

539  
__åşassifyl
 (
__v®
è=ğ
FP_ZERO
;

542 #ià
__HAVE_DISTINCT_FLOAT128


543 
šlše
 

544 
isz”o
 (
_Flßt128
 
__v®
)

546  
__åşassifyf128
 (
__v®
è=ğ
FP_ZERO
;

550 
‹m¶©e
 <
şass
 
__T
> 
šlše
 
boŞ


551 
isz”o
 (
__T
 
__v®
)

553  
__v®
 == 0;

560 #ifdef 
__USE_MISC


564 
_IEEE_
 = -1,

565 
_SVID_
,

566 
_XOPEN_
,

567 
_POSIX_
,

568 
_ISOC_


569 } 
	t_LIB_VERSION_TYPE
;

574 
_LIB_VERSION_TYPE
 
_LIB_VERSION
;

578 #ifdeà
__USE_MISC


584 #ifdeà
__ılu¥lus


585 
	g__exû±iÚ


587 
	gexû±iÚ


590 
	gty³
;

591 *
	gÇme
;

592 
	g¬g1
;

593 
	g¬g2
;

594 
	g»tv®
;

597 #ifdeà
__ılu¥lus


598 
	$m©h”r
 (
__exû±iÚ
 *
__exc
è
	`throw
 ();

600 
	`m©h”r
 (
exû±iÚ
 *
__exc
);

603 
	#X_TLOSS
 1.41484755040568800000e+16

	)

606 
	#DOMAIN
 1

	)

607 
	#SING
 2

	)

608 
	#OVERFLOW
 3

	)

609 
	#UNDERFLOW
 4

	)

610 
	#TLOSS
 5

	)

611 
	#PLOSS
 6

	)

614 
	#HUGE
 3.40282347e+38F

	)

618 #ifdeà
__USE_XOPEN


620 
	#MAXFLOAT
 3.40282347e+38F

	)

627 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


628 
	#M_E
 2.7182818284590452354

	)

629 
	#M_LOG2E
 1.4426950408889634074

	)

630 
	#M_LOG10E
 0.43429448190325182765

	)

631 
	#M_LN2
 0.69314718055994530942

	)

632 
	#M_LN10
 2.30258509299404568402

	)

633 
	#M_PI
 3.14159265358979323846

	)

634 
	#M_PI_2
 1.57079632679489661923

	)

635 
	#M_PI_4
 0.78539816339744830962

	)

636 
	#M_1_PI
 0.31830988618379067154

	)

637 
	#M_2_PI
 0.63661977236758134308

	)

638 
	#M_2_SQRTPI
 1.12837916709551257390

	)

639 
	#M_SQRT2
 1.41421356237309504880

	)

640 
	#M_SQRT1_2
 0.70710678118654752440

	)

646 #ifdeà
__USE_GNU


647 
	#M_El
 2.718281828459045235360287471352662498L

	)

648 
	#M_LOG2El
 1.442695040888963407359924681001892137L

	)

649 
	#M_LOG10El
 0.434294481903251827651128918916605082L

	)

650 
	#M_LN2l
 0.693147180559945309417232121458176568L

	)

651 
	#M_LN10l
 2.302585092994045684017991454684364208L

	)

652 
	#M_PIl
 3.141592653589793238462643383279502884L

	)

653 
	#M_PI_2l
 1.570796326794896619231321691639751442L

	)

654 
	#M_PI_4l
 0.785398163397448309615660845819875721L

	)

655 
	#M_1_PIl
 0.318309886183790671537767526745028724L

	)

656 
	#M_2_PIl
 0.636619772367581343075535053490057448L

	)

657 
	#M_2_SQRTPIl
 1.128379167095512573896158903121545172L

	)

658 
	#M_SQRT2l
 1.414213562373095048801688724209698079L

	)

659 
	#M_SQRT1_2l
 0.707106781186547524400844362104849039L

	)

662 #ià
__HAVE_FLOAT128
 && 
defšed
 
__USE_GNU


663 
	#M_Ef128
 
	`__f128
 (2.718281828459045235360287471352662498è

	)

664 
	#M_LOG2Ef128
 
	`__f128
 (1.442695040888963407359924681001892137è

	)

665 
	#M_LOG10Ef128
 
	`__f128
 (0.434294481903251827651128918916605082è

	)

666 
	#M_LN2f128
 
	`__f128
 (0.693147180559945309417232121458176568è

	)

667 
	#M_LN10f128
 
	`__f128
 (2.302585092994045684017991454684364208è

	)

668 
	#M_PIf128
 
	`__f128
 (3.141592653589793238462643383279502884è

	)

669 
	#M_PI_2f128
 
	`__f128
 (1.570796326794896619231321691639751442è

	)

670 
	#M_PI_4f128
 
	`__f128
 (0.785398163397448309615660845819875721è

	)

671 
	#M_1_PIf128
 
	`__f128
 (0.318309886183790671537767526745028724è

	)

672 
	#M_2_PIf128
 
	`__f128
 (0.636619772367581343075535053490057448è

	)

673 
	#M_2_SQRTPIf128
 
	`__f128
 (1.128379167095512573896158903121545172è

	)

674 
	#M_SQRT2f128
 
	`__f128
 (1.414213562373095048801688724209698079è

	)

675 
	#M_SQRT1_2f128
 
	`__f128
 (0.707106781186547524400844362104849039è

	)

681 #ià
defšed
 
__STRICT_ANSI__
 && !defšed 
__NO_MATH_INLINES


682 
	#__NO_MATH_INLINES
 1

	)

685 #ià
defšed
 
__USE_ISOC99
 && 
	`__GNUC_PREREQ
(2,97)

692 
	#isg»©”
(
x
, 
y
è
	`__butš_isg»©”
(x, y)

	)

693 
	#isg»©”equ®
(
x
, 
y
è
	`__butš_isg»©”equ®
(x, y)

	)

694 
	#i¦ess
(
x
, 
y
è
	`__butš_i¦ess
(x, y)

	)

695 
	#i¦es£qu®
(
x
, 
y
è
	`__butš_i¦es£qu®
(x, y)

	)

696 
	#i¦essg»©”
(
x
, 
y
è
	`__butš_i¦essg»©”
(x, y)

	)

697 
	#isunÜd”ed
(
u
, 
v
è
	`__butš_isunÜd”ed
(u, v)

	)

701 #ifdeà
__USE_EXTERN_INLINES


702 
	~<b™s/m©hšlše.h
>

707 #ià
defšed
 
__FINITE_MATH_ONLY__
 && __FINITE_MATH_ONLY__ > 0

710 
	#_MdoubË_
 

	)

711 
	#__MATH_DECLARING_DOUBLE
 1

	)

712 
	#__MATH_DECLARING_LDOUBLE
 0

	)

713 
	#__MATH_DECLARING_FLOATN
 0

	)

714 
	#_MSUF_


	)

715 
	~<b™s/m©h-fš™e.h
>

716 #undeà
_MdoubË_


717 #undeà
__MATH_DECLARING_DOUBLE


718 #undeà
__MATH_DECLARING_LDOUBLE


719 #undeà
__MATH_DECLARING_FLOATN


720 #undeà
_MSUF_


724 #ifdeà
__USE_ISOC99


727 
	#_MdoubË_
 

	)

728 
	#__MATH_DECLARING_DOUBLE
 0

	)

729 
	#__MATH_DECLARING_LDOUBLE
 0

	)

730 
	#__MATH_DECLARING_FLOATN
 0

	)

731 
	#_MSUF_
 
f


	)

732 
	~<b™s/m©h-fš™e.h
>

733 #undeà
_MdoubË_


734 #undeà
__MATH_DECLARING_DOUBLE


735 #undeà
__MATH_DECLARING_LDOUBLE


736 #undeà
__MATH_DECLARING_FLOATN


737 #undeà
_MSUF_


740 #ifdeà
__MATH_DECLARE_LDOUBLE


741 
	#_MdoubË_
 

	)

742 
	#__MATH_DECLARING_DOUBLE
 0

	)

743 
	#__MATH_DECLARING_LDOUBLE
 1

	)

744 
	#__MATH_DECLARING_FLOATN
 0

	)

745 
	#_MSUF_
 
l


	)

746 
	~<b™s/m©h-fš™e.h
>

747 #undeà
_MdoubË_


748 #undeà
__MATH_DECLARING_DOUBLE


749 #undeà
__MATH_DECLARING_LDOUBLE


750 #undeà
__MATH_DECLARING_FLOATN


751 #undeà
_MSUF_


757 #ià(
__HAVE_DISTINCT_FLOAT128
 || (
__HAVE_FLOAT128
 && !
defšed
 
_LIBC
)) \

758 && 
	$__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

759 
	#_MdoubË_
 
_Flßt128


	)

760 
	#__MATH_DECLARING_DOUBLE
 0

	)

761 
	#__MATH_DECLARING_LDOUBLE
 0

	)

762 
	#__MATH_DECLARING_FLOATN
 1

	)

763 
	#_MSUF_
 
f128


	)

764 
	~<b™s/m©h-fš™e.h
>

765 #undeà
_MdoubË_


766 #undeà
__MATH_DECLARING_DOUBLE


767 #undeà
__MATH_DECLARING_LDOUBLE


768 #undeà
__MATH_DECLARING_FLOATN


769 #undeà
_MSUF_


773 #ifdeà
__USE_ISOC99


777 #iâdeà
isg»©”


778 
	#isg»©”
(
x
, 
y
) \

779 (
__ex‹nsiÚ__
 \

780 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

781 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x > __y; 
	}
}))

	)

785 #iâdeà
isg»©”equ®


786 
	#isg»©”equ®
(
x
, 
y
) \

787 (
__ex‹nsiÚ__
 \

788 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

789 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x >ğ__y; }))

	)

793 #iâdeà
i¦ess


794 
	#i¦ess
(
x
, 
y
) \

795 (
__ex‹nsiÚ__
 \

796 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

797 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x < __y; }))

	)

801 #iâdeà
i¦es£qu®


802 
	#i¦es£qu®
(
x
, 
y
) \

803 (
__ex‹nsiÚ__
 \

804 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

805 !
	`isunÜd”ed
 (
__x
, 
__y
è&& __x <ğ__y; }))

	)

809 #iâdeà
i¦essg»©”


810 
	#i¦essg»©”
(
x
, 
y
) \

811 (
__ex‹nsiÚ__
 \

812 ({ 
	`__ty³of__
(
x
è
__x
 = (x); __ty³of__(
y
è
__y
 = (y); \

813 !
	`isunÜd”ed
 (
__x
, 
__y
è&& (__x < __y || __y < __x); }))

	)

817 #iâdeà
isunÜd”ed


818 
	#isunÜd”ed
(
u
, 
v
) \

819 (
__ex‹nsiÚ__
 \

820 ({ 
	`__ty³of__
(
u
è
__u
 = (u); __ty³of__(
v
è
__v
 = (v); \

821 
	`åşassify
 (
__u
è=ğ
FP_NAN
 || fpşassify (
__v
è=ğFP_NAN; }))

	)

826 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

829 #ià
__FLT_EVAL_METHOD__
 == 2 || __FLT_EVAL_METHOD__ > 64

830 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (yè+ 0.0L)

	)

831 #–ià
__FLT_EVAL_METHOD__
 == 1 || __FLT_EVAL_METHOD__ > 32

832 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (yè+ 0.0)

	)

834 
	#__MATH_EVAL_FMT2
(
x
, 
y
è((xè+ (y))

	)

839 
	#i£qsig
(
x
, 
y
) \

840 
	`__MATH_TG
 (
	`__MATH_EVAL_FMT2
 (
x
, 
y
), 
__i£qsig
, ((x), (y)))

	)

843 
	g__END_DECLS


	@/usr/include/netdb.h

22 #iâdef 
_NETDB_H


23 
	#_NETDB_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	~<Ãtš‘/š.h
>

28 
	~<b™s/¡dšt-ušŠ.h
>

29 #ifdeà
__USE_MISC


32 
	~<½c/Ãtdb.h
>

35 #ifdeà
__USE_GNU


36 
	~<b™s/ty³s/sigev’t_t.h
>

37 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

40 
	~<b™s/Ãtdb.h
>

43 
	#_PATH_HEQUIV
 "/‘c/ho¡s.equiv"

	)

44 
	#_PATH_HOSTS
 "/‘c/ho¡s"

	)

45 
	#_PATH_NETWORKS
 "/‘c/ÃtwÜks"

	)

46 
	#_PATH_NSSWITCH_CONF
 "/‘c/nssw™ch.cÚf"

	)

47 
	#_PATH_PROTOCOLS
 "/‘c/´ÙocŞs"

	)

48 
	#_PATH_SERVICES
 "/‘c/£rviûs"

	)

51 
	g__BEGIN_DECLS


53 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


56 
	#h_”ºo
 (*
	`__h_”ºo_loÿtiÚ
 ())

	)

59 *
	$__h_”ºo_loÿtiÚ
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

63 
	#HOST_NOT_FOUND
 1

	)

64 
	#TRY_AGAIN
 2

	)

66 
	#NO_RECOVERY
 3

	)

68 
	#NO_DATA
 4

	)

71 #ifdeà
__USE_MISC


72 
	#NETDB_INTERNAL
 -1

	)

73 
	#NETDB_SUCCESS
 0

	)

74 
	#NO_ADDRESS
 
NO_DATA


	)

77 #ià
defšed
 
__USE_XOPEN2K
 || defšed 
__USE_XOPEN_EXTENDED


79 
	#IPPORT_RESERVED
 1024

	)

82 #ifdeà
__USE_GNU


84 
	#SCOPE_DELIMITER
 '%'

	)

87 #ifdeà
__USE_MISC


90 
	$h”rÜ
 (cÚ¡ *
__¡r
è
__THROW
;

93 cÚ¡ *
	$h¡»¼Ü
 (
__”r_num
è
__THROW
;

98 
	sho¡’t


100 *
h_Çme
;

101 **
h_®Ÿ£s
;

102 
h_add¹y³
;

103 
h_Ëngth
;

104 **
h_addr_li¡
;

105 #ifdeà
__USE_MISC


106 
	#h_addr
 
h_addr_li¡
[0]

	)

115 
	`£tho¡’t
 (
__¡ay_İ’
);

121 
	`’dho¡’t
 ();

128 
ho¡’t
 *
	`g‘ho¡’t
 ();

135 
ho¡’t
 *
	`g‘ho¡byaddr
 (cÚ¡ *
__addr
, 
__sockËn_t
 
__Ën
,

136 
__ty³
);

142 
ho¡’t
 *
	`g‘ho¡byÇme
 (cÚ¡ *
__Çme
);

144 #ifdeà
__USE_MISC


153 
ho¡’t
 *
	`g‘ho¡byÇme2
 (cÚ¡ *
__Çme
, 
__af
);

165 
	`g‘ho¡’t_r
 (
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

166 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

167 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

168 *
__»¡riù
 
__h_”ºİ
);

170 
	`g‘ho¡byaddr_r
 (cÚ¡ *
__»¡riù
 
__addr
, 
__sockËn_t
 
__Ën
,

171 
__ty³
,

172 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

173 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

174 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

175 *
__»¡riù
 
__h_”ºİ
);

177 
	`g‘ho¡byÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

178 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

179 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

180 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

181 *
__»¡riù
 
__h_”ºİ
);

183 
	`g‘ho¡byÇme2_r
 (cÚ¡ *
__»¡riù
 
__Çme
, 
__af
,

184 
ho¡’t
 *
__»¡riù
 
__»suÉ_buf
,

185 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

186 
ho¡’t
 **
__»¡riù
 
__»suÉ
,

187 *
__»¡riù
 
__h_”ºİ
);

196 
	`£Š‘’t
 (
__¡ay_İ’
);

202 
	`’dÃ‹Á
 ();

209 
Ã‹Á
 *
	`g‘Ã‹Á
 ();

216 
Ã‹Á
 *
	`g‘Ãtbyaddr
 (
ušt32_t
 
__Ãt
, 
__ty³
);

222 
Ã‹Á
 *
	`g‘ÃtbyÇme
 (cÚ¡ *
__Çme
);

224 #ifdef 
__USE_MISC


235 
	`g‘Ã‹Á_r
 (
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

236 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

237 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

238 *
__»¡riù
 
__h_”ºİ
);

240 
	`g‘Ãtbyaddr_r
 (
ušt32_t
 
__Ãt
, 
__ty³
,

241 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

242 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

243 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

244 *
__»¡riù
 
__h_”ºİ
);

246 
	`g‘ÃtbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

247 
Ã‹Á
 *
__»¡riù
 
__»suÉ_buf
,

248 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

249 
Ã‹Á
 **
__»¡riù
 
__»suÉ
,

250 *
__»¡riù
 
__h_”ºİ
);

255 
	s£rv’t


257 *
s_Çme
;

258 **
s_®Ÿ£s
;

259 
s_pÜt
;

260 *
s_´Ùo
;

268 
	`£t£rv’t
 (
__¡ay_İ’
);

274 
	`’d£rv’t
 ();

281 
£rv’t
 *
	`g‘£rv’t
 ();

288 
£rv’t
 *
	`g‘£rvbyÇme
 (cÚ¡ *
__Çme
, cÚ¡ *
__´Ùo
);

295 
£rv’t
 *
	`g‘£rvbypÜt
 (
__pÜt
, cÚ¡ *
__´Ùo
);

298 #ifdef 
__USE_MISC


306 
	`g‘£rv’t_r
 (
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

307 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

308 
£rv’t
 **
__»¡riù
 
__»suÉ
);

310 
	`g‘£rvbyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

311 cÚ¡ *
__»¡riù
 
__´Ùo
,

312 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

313 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

314 
£rv’t
 **
__»¡riù
 
__»suÉ
);

316 
	`g‘£rvbypÜt_r
 (
__pÜt
, cÚ¡ *
__»¡riù
 
__´Ùo
,

317 
£rv’t
 *
__»¡riù
 
__»suÉ_buf
,

318 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

319 
£rv’t
 **
__»¡riù
 
__»suÉ
);

324 
	s´ÙÛÁ


326 *
p_Çme
;

327 **
p_®Ÿ£s
;

328 
p_´Ùo
;

336 
	`£rÙÛÁ
 (
__¡ay_İ’
);

342 
	`’d´ÙÛÁ
 ();

349 
´ÙÛÁ
 *
	`g‘´ÙÛÁ
 ();

355 
´ÙÛÁ
 *
	`g‘´ÙobyÇme
 (cÚ¡ *
__Çme
);

361 
´ÙÛÁ
 *
	`g‘´Ùobynumb”
 (
__´Ùo
);

364 #ifdef 
__USE_MISC


372 
	`g‘´ÙÛÁ_r
 (
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

373 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

374 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

376 
	`g‘´ÙobyÇme_r
 (cÚ¡ *
__»¡riù
 
__Çme
,

377 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

378 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

379 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

381 
	`g‘´Ùobynumb”_r
 (
__´Ùo
,

382 
´ÙÛÁ
 *
__»¡riù
 
__»suÉ_buf
,

383 *
__»¡riù
 
__buf
, 
size_t
 
__buæ’
,

384 
´ÙÛÁ
 **
__»¡riù
 
__»suÉ
);

393 
	`£Š‘g»Á
 (cÚ¡ *
__Ãtgroup
);

401 
	`’dÃtg»Á
 ();

410 
	`g‘Ãtg»Á
 (**
__»¡riù
 
__ho¡p
,

411 **
__»¡riù
 
__u£½
,

412 **
__»¡riù
 
__domašp
);

421 
	`šÃtgr
 (cÚ¡ *
__Ãtgroup
, cÚ¡ *
__ho¡
,

422 cÚ¡ *
__u£r
, cÚ¡ *
__domaš
);

430 
	`g‘Ãtg»Á_r
 (**
__»¡riù
 
__ho¡p
,

431 **
__»¡riù
 
__u£½
,

432 **
__»¡riù
 
__domašp
,

433 *
__»¡riù
 
__bufãr
, 
size_t
 
__buæ’
);

437 #ifdeà
__USE_MISC


449 
	`rcmd
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

450 cÚ¡ *
__»¡riù
 
__locu£r
,

451 cÚ¡ *
__»¡riù
 
__»mu£r
,

452 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

461 
	`rcmd_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

462 cÚ¡ *
__»¡riù
 
__locu£r
,

463 cÚ¡ *
__»¡riù
 
__»mu£r
,

464 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

465 
§_çmy_t
 
__af
);

477 
	`»xec
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

478 cÚ¡ *
__»¡riù
 
__Çme
,

479 cÚ¡ *
__»¡riù
 
__·ss
,

480 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
);

489 
	`»xec_af
 (**
__»¡riù
 
__aho¡
, 
__½Üt
,

490 cÚ¡ *
__»¡riù
 
__Çme
,

491 cÚ¡ *
__»¡riù
 
__·ss
,

492 cÚ¡ *
__»¡riù
 
__cmd
, *__»¡riù 
__fd2p
,

493 
§_çmy_t
 
__af
);

503 
	`ru£rok
 (cÚ¡ *
__rho¡
, 
__su£r
,

504 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

513 
	`ru£rok_af
 (cÚ¡ *
__rho¡
, 
__su£r
,

514 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

515 
§_çmy_t
 
__af
);

526 
	`œu£rok
 (
ušt32_t
 
__¿ddr
, 
__su£r
,

527 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
);

537 
	`œu£rok_af
 (cÚ¡ *
__¿ddr
, 
__su£r
,

538 cÚ¡ *
__»mu£r
, cÚ¡ *
__locu£r
,

539 
§_çmy_t
 
__af
);

549 
	`¼esvpÜt
 (*
__®pÜt
);

558 
	`¼esvpÜt_af
 (*
__®pÜt
, 
§_çmy_t
 
__af
);

563 #ifdeà
__USE_XOPEN2K


565 
	saddršfo


567 
ai_æags
;

568 
ai_çmy
;

569 
ai_sockty³
;

570 
ai_´ÙocŞ
;

571 
sockËn_t
 
ai_add¾’
;

572 
sockaddr
 *
ai_addr
;

573 *
ai_ÿnÚÇme
;

574 
addršfo
 *
ai_Ãxt
;

577 #ifdeà
__USE_GNU


579 
	sgaicb


581 cÚ¡ *
¬_Çme
;

582 cÚ¡ *
¬_£rviû
;

583 cÚ¡ 
addršfo
 *
¬_»que¡
;

584 
addršfo
 *
¬_»suÉ
;

586 
__»tuº
;

587 
__glibc_»£rved
[5];

591 
	#GAI_WAIT
 0

	)

592 
	#GAI_NOWAIT
 1

	)

596 
	#AI_PASSIVE
 0x0001

	)

597 
	#AI_CANONNAME
 0x0002

	)

598 
	#AI_NUMERICHOST
 0x0004

	)

599 
	#AI_V4MAPPED
 0x0008

	)

600 
	#AI_ALL
 0x0010

	)

601 
	#AI_ADDRCONFIG
 0x0020

	)

603 #ifdeà
__USE_GNU


604 
	#AI_IDN
 0x0040

	)

607 
	#AI_CANONIDN
 0x0080

	)

608 
	#AI_IDN_ALLOW_UNASSIGNED
 0x0100

	)

610 
	#AI_IDN_USE_STD3_ASCII_RULES
 0x0200

	)

613 
	#AI_NUMERICSERV
 0x0400

	)

616 
	#EAI_BADFLAGS
 -1

	)

617 
	#EAI_NONAME
 -2

	)

618 
	#EAI_AGAIN
 -3

	)

619 
	#EAI_FAIL
 -4

	)

620 
	#EAI_FAMILY
 -6

	)

621 
	#EAI_SOCKTYPE
 -7

	)

622 
	#EAI_SERVICE
 -8

	)

623 
	#EAI_MEMORY
 -10

	)

624 
	#EAI_SYSTEM
 -11

	)

625 
	#EAI_OVERFLOW
 -12

	)

626 #ifdeà
__USE_GNU


627 
	#EAI_NODATA
 -5

	)

628 
	#EAI_ADDRFAMILY
 -9

	)

629 
	#EAI_INPROGRESS
 -100

	)

630 
	#EAI_CANCELED
 -101

	)

631 
	#EAI_NOTCANCELED
 -102

	)

632 
	#EAI_ALLDONE
 -103

	)

633 
	#EAI_INTR
 -104

	)

634 
	#EAI_IDN_ENCODE
 -105

	)

637 #ifdeà
__USE_MISC


638 
	#NI_MAXHOST
 1025

	)

639 
	#NI_MAXSERV
 32

	)

642 
	#NI_NUMERICHOST
 1

	)

643 
	#NI_NUMERICSERV
 2

	)

644 
	#NI_NOFQDN
 4

	)

645 
	#NI_NAMEREQD
 8

	)

646 
	#NI_DGRAM
 16

	)

647 #ifdeà
__USE_GNU


648 
	#NI_IDN
 32

	)

649 
	#NI_IDN_ALLOW_UNASSIGNED
 64

	)

651 
	#NI_IDN_USE_STD3_ASCII_RULES
 128

	)

660 
	`g‘addršfo
 (cÚ¡ *
__»¡riù
 
__Çme
,

661 cÚ¡ *
__»¡riù
 
__£rviû
,

662 cÚ¡ 
addršfo
 *
__»¡riù
 
__»q
,

663 
addršfo
 **
__»¡riù
 
__·i
);

666 
	$ä“addršfo
 (
addršfo
 *
__ai
è
__THROW
;

669 cÚ¡ *
	$gai_¡»¼Ü
 (
__ecode
è
__THROW
;

675 
	`g‘Çmešfo
 (cÚ¡ 
sockaddr
 *
__»¡riù
 
__§
,

676 
sockËn_t
 
__§Ën
, *
__»¡riù
 
__ho¡
,

677 
sockËn_t
 
__ho¡Ën
, *
__»¡riù
 
__£rv
,

678 
sockËn_t
 
__£rvËn
, 
__æags
);

681 #ifdeà
__USE_GNU


690 
	`g‘addršfo_a
 (
__mode
, 
gaicb
 *
__li¡
[
__»¡riù_¬r
],

691 
__’t
, 
sigev’t
 *
__»¡riù
 
__sig
);

701 
	`gai_su¥’d
 (cÚ¡ 
gaicb
 *cÚ¡ 
__li¡
[], 
__’t
,

702 cÚ¡ 
time¥ec
 *
__timeout
);

705 
	$gai_”rÜ
 (
gaicb
 *
__»q
è
__THROW
;

708 
	$gai_ÿnûl
 (
gaicb
 *
__gaicbp
è
__THROW
;

711 
__END_DECLS


	@/usr/include/netinet/in.h

18 #iâdef 
_NETINET_IN_H


19 
	#_NETINET_IN_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<b™s/¡dšt-ušŠ.h
>

23 
	~<sys/sock‘.h
>

24 
	~<b™s/ty³s.h
>

27 
__BEGIN_DECLS


30 
ušt32_t
 
	tš_addr_t
;

31 
	sš_addr


33 
š_addr_t
 
	ms_addr
;

37 
	~<b™s/š.h
>

42 
	mIPPROTO_IP
 = 0,

43 
	#IPPROTO_IP
 
IPPROTO_IP


	)

44 
	mIPPROTO_ICMP
 = 1,

45 
	#IPPROTO_ICMP
 
IPPROTO_ICMP


	)

46 
	mIPPROTO_IGMP
 = 2,

47 
	#IPPROTO_IGMP
 
IPPROTO_IGMP


	)

48 
	mIPPROTO_IPIP
 = 4,

49 
	#IPPROTO_IPIP
 
IPPROTO_IPIP


	)

50 
	mIPPROTO_TCP
 = 6,

51 
	#IPPROTO_TCP
 
IPPROTO_TCP


	)

52 
	mIPPROTO_EGP
 = 8,

53 
	#IPPROTO_EGP
 
IPPROTO_EGP


	)

54 
	mIPPROTO_PUP
 = 12,

55 
	#IPPROTO_PUP
 
IPPROTO_PUP


	)

56 
	mIPPROTO_UDP
 = 17,

57 
	#IPPROTO_UDP
 
IPPROTO_UDP


	)

58 
	mIPPROTO_IDP
 = 22,

59 
	#IPPROTO_IDP
 
IPPROTO_IDP


	)

60 
	mIPPROTO_TP
 = 29,

61 
	#IPPROTO_TP
 
IPPROTO_TP


	)

62 
	mIPPROTO_DCCP
 = 33,

63 
	#IPPROTO_DCCP
 
IPPROTO_DCCP


	)

64 
	mIPPROTO_IPV6
 = 41,

65 
	#IPPROTO_IPV6
 
IPPROTO_IPV6


	)

66 
	mIPPROTO_RSVP
 = 46,

67 
	#IPPROTO_RSVP
 
IPPROTO_RSVP


	)

68 
	mIPPROTO_GRE
 = 47,

69 
	#IPPROTO_GRE
 
IPPROTO_GRE


	)

70 
	mIPPROTO_ESP
 = 50,

71 
	#IPPROTO_ESP
 
IPPROTO_ESP


	)

72 
	mIPPROTO_AH
 = 51,

73 
	#IPPROTO_AH
 
IPPROTO_AH


	)

74 
	mIPPROTO_MTP
 = 92,

75 
	#IPPROTO_MTP
 
IPPROTO_MTP


	)

76 
	mIPPROTO_BEETPH
 = 94,

77 
	#IPPROTO_BEETPH
 
IPPROTO_BEETPH


	)

78 
	mIPPROTO_ENCAP
 = 98,

79 
	#IPPROTO_ENCAP
 
IPPROTO_ENCAP


	)

80 
	mIPPROTO_PIM
 = 103,

81 
	#IPPROTO_PIM
 
IPPROTO_PIM


	)

82 
	mIPPROTO_COMP
 = 108,

83 
	#IPPROTO_COMP
 
IPPROTO_COMP


	)

84 
	mIPPROTO_SCTP
 = 132,

85 
	#IPPROTO_SCTP
 
IPPROTO_SCTP


	)

86 
	mIPPROTO_UDPLITE
 = 136,

87 
	#IPPROTO_UDPLITE
 
IPPROTO_UDPLITE


	)

88 
	mIPPROTO_MPLS
 = 137,

89 
	#IPPROTO_MPLS
 
IPPROTO_MPLS


	)

90 
	mIPPROTO_RAW
 = 255,

91 
	#IPPROTO_RAW
 
IPPROTO_RAW


	)

92 
	mIPPROTO_MAX


98 #ià!
__USE_KERNEL_IPV6_DEFS


101 
	mIPPROTO_HOPOPTS
 = 0,

102 
	#IPPROTO_HOPOPTS
 
IPPROTO_HOPOPTS


	)

103 
	mIPPROTO_ROUTING
 = 43,

104 
	#IPPROTO_ROUTING
 
IPPROTO_ROUTING


	)

105 
	mIPPROTO_FRAGMENT
 = 44,

106 
	#IPPROTO_FRAGMENT
 
IPPROTO_FRAGMENT


	)

107 
	mIPPROTO_ICMPV6
 = 58,

108 
	#IPPROTO_ICMPV6
 
IPPROTO_ICMPV6


	)

109 
	mIPPROTO_NONE
 = 59,

110 
	#IPPROTO_NONE
 
IPPROTO_NONE


	)

111 
	mIPPROTO_DSTOPTS
 = 60,

112 
	#IPPROTO_DSTOPTS
 
IPPROTO_DSTOPTS


	)

113 
	mIPPROTO_MH
 = 135

114 
	#IPPROTO_MH
 
IPPROTO_MH


	)

119 
ušt16_t
 
	tš_pÜt_t
;

124 
	mIPPORT_ECHO
 = 7,

125 
	mIPPORT_DISCARD
 = 9,

126 
	mIPPORT_SYSTAT
 = 11,

127 
	mIPPORT_DAYTIME
 = 13,

128 
	mIPPORT_NETSTAT
 = 15,

129 
	mIPPORT_FTP
 = 21,

130 
	mIPPORT_TELNET
 = 23,

131 
	mIPPORT_SMTP
 = 25,

132 
	mIPPORT_TIMESERVER
 = 37,

133 
	mIPPORT_NAMESERVER
 = 42,

134 
	mIPPORT_WHOIS
 = 43,

135 
	mIPPORT_MTP
 = 57,

137 
	mIPPORT_TFTP
 = 69,

138 
	mIPPORT_RJE
 = 77,

139 
	mIPPORT_FINGER
 = 79,

140 
	mIPPORT_TTYLINK
 = 87,

141 
	mIPPORT_SUPDUP
 = 95,

144 
	mIPPORT_EXECSERVER
 = 512,

145 
	mIPPORT_LOGINSERVER
 = 513,

146 
	mIPPORT_CMDSERVER
 = 514,

147 
	mIPPORT_EFSSERVER
 = 520,

150 
	mIPPORT_BIFFUDP
 = 512,

151 
	mIPPORT_WHOSERVER
 = 513,

152 
	mIPPORT_ROUTESERVER
 = 520,

155 
	mIPPORT_RESERVED
 = 1024,

158 
	mIPPORT_USERRESERVED
 = 5000

166 
	#IN_CLASSA
(
a
è((((
š_addr_t
)×)è& 0x80000000è=ğ0)

	)

167 
	#IN_CLASSA_NET
 0xff000000

	)

168 
	#IN_CLASSA_NSHIFT
 24

	)

169 
	#IN_CLASSA_HOST
 (0xfffffffà& ~
IN_CLASSA_NET
)

	)

170 
	#IN_CLASSA_MAX
 128

	)

172 
	#IN_CLASSB
(
a
è((((
š_addr_t
)×)è& 0xc0000000è=ğ0x80000000)

	)

173 
	#IN_CLASSB_NET
 0xffff0000

	)

174 
	#IN_CLASSB_NSHIFT
 16

	)

175 
	#IN_CLASSB_HOST
 (0xfffffffà& ~
IN_CLASSB_NET
)

	)

176 
	#IN_CLASSB_MAX
 65536

	)

178 
	#IN_CLASSC
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xc0000000)

	)

179 
	#IN_CLASSC_NET
 0xffffff00

	)

180 
	#IN_CLASSC_NSHIFT
 8

	)

181 
	#IN_CLASSC_HOST
 (0xfffffffà& ~
IN_CLASSC_NET
)

	)

183 
	#IN_CLASSD
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xe0000000)

	)

184 
	#IN_MULTICAST
(
a
è
	`IN_CLASSD
×)

	)

186 
	#IN_EXPERIMENTAL
(
a
è((((
š_addr_t
)×)è& 0xe0000000è=ğ0xe0000000)

	)

187 
	#IN_BADCLASS
(
a
è((((
š_addr_t
)×)è& 0xf0000000è=ğ0xf0000000)

	)

190 
	#INADDR_ANY
 ((
š_addr_t
è0x00000000)

	)

192 
	#INADDR_BROADCAST
 ((
š_addr_t
è0xffffffff)

	)

194 
	#INADDR_NONE
 ((
š_addr_t
è0xffffffff)

	)

197 
	#IN_LOOPBACKNET
 127

	)

199 #iâdeà
INADDR_LOOPBACK


200 
	#INADDR_LOOPBACK
 ((
š_addr_t
è0x7f000001è

	)

204 
	#INADDR_UNSPEC_GROUP
 ((
š_addr_t
è0xe0000000è

	)

205 
	#INADDR_ALLHOSTS_GROUP
 ((
š_addr_t
è0xe0000001è

	)

206 
	#INADDR_ALLRTRS_GROUP
 ((
š_addr_t
è0xe0000002è

	)

207 
	#INADDR_MAX_LOCAL_GROUP
 ((
š_addr_t
è0xe00000ffè

	)

209 #ià!
__USE_KERNEL_IPV6_DEFS


211 
	sš6_addr


215 
ušt8_t
 
	m__u6_addr8
[16];

216 
ušt16_t
 
	m__u6_addr16
[8];

217 
ušt32_t
 
	m__u6_addr32
[4];

218 } 
	m__š6_u
;

219 
	#s6_addr
 
__š6_u
.
__u6_addr8


	)

220 #ifdeà
__USE_MISC


221 
	#s6_addr16
 
__š6_u
.
__u6_addr16


	)

222 
	#s6_addr32
 
__š6_u
.
__u6_addr32


	)

227 cÚ¡ 
š6_addr
 
š6addr_ªy
;

228 cÚ¡ 
š6_addr
 
š6addr_loİback
;

229 
	#IN6ADDR_ANY_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0 } } }

	)

230 
	#IN6ADDR_LOOPBACK_INIT
 { { { 0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1 } } }

	)

232 
	#INET_ADDRSTRLEN
 16

	)

233 
	#INET6_ADDRSTRLEN
 46

	)

237 
	ssockaddr_š


239 
__SOCKADDR_COMMON
 (
sš_
);

240 
š_pÜt_t
 
	msš_pÜt
;

241 
š_addr
 
	msš_addr
;

244 
	msš_z”o
[ (
sockaddr
) -

245 
__SOCKADDR_COMMON_SIZE
 -

246  (
š_pÜt_t
) -

247  (
š_addr
)];

250 #ià!
__USE_KERNEL_IPV6_DEFS


252 
	ssockaddr_š6


254 
__SOCKADDR_COMMON
 (
sš6_
);

255 
š_pÜt_t
 
	msš6_pÜt
;

256 
ušt32_t
 
	msš6_æowšfo
;

257 
š6_addr
 
	msš6_addr
;

258 
ušt32_t
 
	msš6_scİe_id
;

262 #ifdeà
__USE_MISC


264 
	s_m»q


267 
š_addr
 
	mimr_muÉŸddr
;

270 
š_addr
 
	mimr_š‹rçû
;

273 
	s_m»q_sourû


276 
š_addr
 
	mimr_muÉŸddr
;

279 
š_addr
 
	mimr_š‹rçû
;

282 
š_addr
 
	mimr_sourûaddr
;

286 #ià!
__USE_KERNEL_IPV6_DEFS


288 
	sv6_m»q


291 
š6_addr
 
	mv6mr_muÉŸddr
;

294 
	mv6mr_š‹rçû
;

298 #ifdeà
__USE_MISC


300 
	sgroup_»q


303 
ušt32_t
 
	mgr_š‹rçû
;

306 
sockaddr_¡Üage
 
	mgr_group
;

309 
	sgroup_sourû_»q


312 
ušt32_t
 
	mg¤_š‹rçû
;

315 
sockaddr_¡Üage
 
	mg¤_group
;

318 
sockaddr_¡Üage
 
	mg¤_sourû
;

323 
	s_msf‹r


326 
š_addr
 
	mimsf_muÉŸddr
;

329 
š_addr
 
	mimsf_š‹rçû
;

332 
ušt32_t
 
	mimsf_fmode
;

335 
ušt32_t
 
	mimsf_num¤c
;

337 
š_addr
 
	mimsf_¦i¡
[1];

340 
	#IP_MSFILTER_SIZE
(
num¤c
è( (
_msf‹r
) \

341 -  (
š_addr
) \

342 + (
num¤c
è*  (
š_addr
))

	)

344 
	sgroup_f‹r


347 
ušt32_t
 
	mgf_š‹rçû
;

350 
sockaddr_¡Üage
 
	mgf_group
;

353 
ušt32_t
 
	mgf_fmode
;

356 
ušt32_t
 
	mgf_num¤c
;

358 
sockaddr_¡Üage
 
	mgf_¦i¡
[1];

361 
	#GROUP_FILTER_SIZE
(
num¤c
è( (
group_f‹r
) \

362 -  (
sockaddr_¡Üage
) \

363 + ((
num¤c
) \

364 *  (
sockaddr_¡Üage
)))

	)

374 
ušt32_t
 
	$Áohl
 (
ušt32_t
 
__ÃÚg
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

375 
ušt16_t
 
	$Áohs
 (
ušt16_t
 
__ÃtshÜt
)

376 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

377 
ušt32_t
 
	$htÚl
 (
ušt32_t
 
__ho¡lÚg
)

378 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

379 
ušt16_t
 
	$htÚs
 (
ušt16_t
 
__ho¡shÜt
)

380 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

382 
	~<’dŸn.h
>

385 
	~<b™s/by‹sw­.h
>

386 
	~<b™s/ušŠ-id’t™y.h
>

388 #ifdeà
__OPTIMIZE__


392 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


395 
	#Áohl
(
x
è
	`__ušt32_id’t™y
 (x)

	)

396 
	#Áohs
(
x
è
	`__ušt16_id’t™y
 (x)

	)

397 
	#htÚl
(
x
è
	`__ušt32_id’t™y
 (x)

	)

398 
	#htÚs
(
x
è
	`__ušt16_id’t™y
 (x)

	)

400 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


401 
	#Áohl
(
x
è
	`__bsw­_32
 (x)

	)

402 
	#Áohs
(
x
è
	`__bsw­_16
 (x)

	)

403 
	#htÚl
(
x
è
	`__bsw­_32
 (x)

	)

404 
	#htÚs
(
x
è
	`__bsw­_16
 (x)

	)

409 #ifdeà
__GNUC__


410 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

411 (
__ex‹nsiÚ__
 \

412 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

413 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

414 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

415 && 
__a
->
__š6_u
.
__u6_addr32
[2] == 0 \

416 && 
__a
->
__š6_u
.
__u6_addr32
[3] =ğ0; 
	}
}))

	)

418 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

419 (
__ex‹nsiÚ__
 \

420 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

421 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

422 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

423 && 
__a
->
__š6_u
.
__u6_addr32
[2] == 0 \

424 && 
__a
->
__š6_u
.
__u6_addr32
[3] =ğ
	`htÚl
 (1); }))

	)

426 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

427 (
__ex‹nsiÚ__
 \

428 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

429 (
__a
->
__š6_u
.
__u6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xã800000); }))

	)

431 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

432 (
__ex‹nsiÚ__
 \

433 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

434 (
__a
->
__š6_u
.
__u6_addr32
[0] & 
	`htÚl
 (0xffc00000)è=ğhtÚÈ(0xãc00000); }))

	)

436 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

437 (
__ex‹nsiÚ__
 \

438 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

439 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

440 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

441 && 
__a
->
__š6_u
.
__u6_addr32
[2] =ğ
	`htÚl
 (0xffff); }))

	)

443 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

444 (
__ex‹nsiÚ__
 \

445 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

446 
__a
->
__š6_u
.
__u6_addr32
[0] == 0 \

447 && 
__a
->
__š6_u
.
__u6_addr32
[1] == 0 \

448 && 
__a
->
__š6_u
.
__u6_addr32
[2] == 0 \

449 && 
	`Áohl
 (
__a
->
__š6_u
.
__u6_addr32
[3]è> 1; }))

	)

451 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

452 (
__ex‹nsiÚ__
 \

453 ({ cÚ¡ 
š6_addr
 *
__a
 = (cÚ¡ š6_add¸*è(
a
); \

454 cÚ¡ 
š6_addr
 *
__b
 = (cÚ¡ š6_add¸*è(
b
); \

455 
__a
->
__š6_u
.
__u6_addr32
[0] =ğ
__b
->__in6_u.__u6_addr32[0] \

456 && 
__a
->
__š6_u
.
__u6_addr32
[1] =ğ
__b
->__in6_u.__u6_addr32[1] \

457 && 
__a
->
__š6_u
.
__u6_addr32
[2] =ğ
__b
->__in6_u.__u6_addr32[2] \

458 && 
__a
->
__š6_u
.
__u6_addr32
[3] =ğ
__b
->__š6_u.__u6_addr32[3]; }))

	)

460 
	#IN6_IS_ADDR_UNSPECIFIED
(
a
) \

461 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

462 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

463 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

464 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ0)

	)

466 
	#IN6_IS_ADDR_LOOPBACK
(
a
) \

467 (((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0 \

468 && ((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0 \

469 && ((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0 \

470 && ((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ
	`htÚl
 (1))

	)

472 
	#IN6_IS_ADDR_LINKLOCAL
(
a
) \

473 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

474 =ğ
	`htÚl
 (0xã800000))

	)

476 
	#IN6_IS_ADDR_SITELOCAL
(
a
) \

477 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] & 
	`htÚl
 (0xffc00000)) \

478 =ğ
	`htÚl
 (0xãc00000))

	)

480 
	#IN6_IS_ADDR_V4MAPPED
(
a
) \

481 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

482 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

483 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ
	`htÚl
 (0xffff)))

	)

485 
	#IN6_IS_ADDR_V4COMPAT
(
a
) \

486 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] == 0) \

487 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] == 0) \

488 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] == 0) \

489 && (
	`Áohl
 (((cÚ¡ 
ušt32_t
 *è(
a
))[3]è> 1))

	)

491 
	#IN6_ARE_ADDR_EQUAL
(
a
,
b
) \

492 ((((cÚ¡ 
ušt32_t
 *è(
a
))[0] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[0]) \

493 && (((cÚ¡ 
ušt32_t
 *è(
a
))[1] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[1]) \

494 && (((cÚ¡ 
ušt32_t
 *è(
a
))[2] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[2]) \

495 && (((cÚ¡ 
ušt32_t
 *è(
a
))[3] =ğ((cÚ¡ ušt32_ˆ*è(
b
))[3]))

	)

498 
	#IN6_IS_ADDR_MULTICAST
(
a
è(((cÚ¡ 
ušt8_t
 *è×))[0] =ğ0xff)

	)

500 #ifdeà
__USE_MISC


502 
	$bšd»svpÜt
 (
__sockfd
, 
sockaddr_š
 *
__sock_š
è
__THROW
;

505 
	$bšd»svpÜt6
 (
__sockfd
, 
sockaddr_š6
 *
__sock_š
)

506 
__THROW
;

510 
	#IN6_IS_ADDR_MC_NODELOCAL
(
a
) \

511 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

512 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x1))

	)

514 
	#IN6_IS_ADDR_MC_LINKLOCAL
(
a
) \

515 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

516 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x2))

	)

518 
	#IN6_IS_ADDR_MC_SITELOCAL
(
a
) \

519 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

520 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x5))

	)

522 
	#IN6_IS_ADDR_MC_ORGLOCAL
(
a
) \

523 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

524 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0x8))

	)

526 
	#IN6_IS_ADDR_MC_GLOBAL
(
a
) \

527 (
	`IN6_IS_ADDR_MULTICAST
(
a
) \

528 && ((((cÚ¡ 
ušt8_t
 *è(
a
))[1] & 0xfè=ğ0xe))

	)

531 #ifdeà
__USE_GNU


532 
cmsghdr
;

534 #ià!
__USE_KERNEL_IPV6_DEFS


536 
	sš6_pktšfo


538 
š6_addr
 
i6_addr
;

539 
i6_ifšdex
;

543 
	s6_mtušfo


545 
sockaddr_š6
 
6m_addr
;

546 
ušt32_t
 
6m_mtu
;

551 
	$š‘6_İtiÚ_¥aû
 (
__nby‹s
)

552 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

553 
	$š‘6_İtiÚ_š™
 (*
__bp
, 
cmsghdr
 **
__cmsgp
,

554 
__ty³
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

555 
	$š‘6_İtiÚ_­³nd
 (
cmsghdr
 *
__cmsg
,

556 cÚ¡ 
ušt8_t
 *
__ty³p
, 
__muÉx
,

557 
__¶usy
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

558 
ušt8_t
 *
	$š‘6_İtiÚ_®loc
 (
cmsghdr
 *
__cmsg
, 
__d©®’
,

559 
__muÉx
, 
__¶usy
)

560 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

561 
	$š‘6_İtiÚ_Ãxt
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

562 
ušt8_t
 **
__Œp
)

563 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

564 
	$š‘6_İtiÚ_fšd
 (cÚ¡ 
cmsghdr
 *
__cmsg
,

565 
ušt8_t
 **
__Œp
, 
__ty³
)

566 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

570 
	$š‘6_İt_š™
 (*
__extbuf
, 
sockËn_t
 
__ex’
è
__THROW
;

571 
	$š‘6_İt_­³nd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

572 
ušt8_t
 
__ty³
, 
sockËn_t
 
__Ën
, ušt8_ˆ
__®ign
,

573 **
__d©abuå
è
__THROW
;

574 
	$š‘6_İt_fšish
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
)

575 
__THROW
;

576 
	$š‘6_İt_£t_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

577 
sockËn_t
 
__v®Ën
è
__THROW
;

578 
	$š‘6_İt_Ãxt
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

579 
ušt8_t
 *
__ty³p
, 
sockËn_t
 *
__ËÅ
,

580 **
__d©abuå
è
__THROW
;

581 
	$š‘6_İt_fšd
 (*
__extbuf
, 
sockËn_t
 
__ex’
, 
__off£t
,

582 
ušt8_t
 
__ty³
, 
sockËn_t
 *
__ËÅ
,

583 **
__d©abuå
è
__THROW
;

584 
	$š‘6_İt_g‘_v®
 (*
__d©abuf
, 
__off£t
, *
__v®
,

585 
sockËn_t
 
__v®Ën
è
__THROW
;

589 
sockËn_t
 
	$š‘6_¹h_¥aû
 (
__ty³
, 
__£gm’ts
è
__THROW
;

590 *
	$š‘6_¹h_š™
 (*
__bp
, 
sockËn_t
 
__bp_Ën
, 
__ty³
,

591 
__£gm’ts
è
__THROW
;

592 
	$š‘6_¹h_add
 (*
__bp
, cÚ¡ 
š6_addr
 *
__addr
è
__THROW
;

593 
	$š‘6_¹h_»v”£
 (cÚ¡ *
__š
, *
__out
è
__THROW
;

594 
	$š‘6_¹h_£gm’ts
 (cÚ¡ *
__bp
è
__THROW
;

595 
š6_addr
 *
	$š‘6_¹h_g‘addr
 (cÚ¡ *
__bp
, 
__šdex
)

596 
__THROW
;

602 
	$g‘v4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

603 
š_addr
 
__group
, 
ušt32_t
 *
__fmode
,

604 
ušt32_t
 *
__num¤c
, 
š_addr
 *
__¦i¡
)

605 
__THROW
;

608 
	$£tv4sourûf‹r
 (
__s
, 
š_addr
 
__š‹rçû_addr
,

609 
š_addr
 
__group
, 
ušt32_t
 
__fmode
,

610 
ušt32_t
 
__num¤c
,

611 cÚ¡ 
š_addr
 *
__¦i¡
)

612 
__THROW
;

616 
	$g‘sourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

617 cÚ¡ 
sockaddr
 *
__group
,

618 
sockËn_t
 
__grou¶’
, 
ušt32_t
 *
__fmode
,

619 
ušt32_t
 *
__num¤c
,

620 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

623 
	$£tsourûf‹r
 (
__s
, 
ušt32_t
 
__š‹rçû_addr
,

624 cÚ¡ 
sockaddr
 *
__group
,

625 
sockËn_t
 
__grou¶’
, 
ušt32_t
 
__fmode
,

626 
ušt32_t
 
__num¤c
,

627 cÚ¡ 
sockaddr_¡Üage
 *
__¦i¡
è
__THROW
;

630 
__END_DECLS


	@/usr/include/netinet/tcp.h

32 #iâdeà
_NETINET_TCP_H


33 
	#_NETINET_TCP_H
 1

	)

35 
	~<ã©u»s.h
>

40 
	#TCP_NODELAY
 1

	)

41 
	#TCP_MAXSEG
 2

	)

42 
	#TCP_CORK
 3

	)

43 
	#TCP_KEEPIDLE
 4

	)

44 
	#TCP_KEEPINTVL
 5

	)

45 
	#TCP_KEEPCNT
 6

	)

46 
	#TCP_SYNCNT
 7

	)

47 
	#TCP_LINGER2
 8

	)

48 
	#TCP_DEFER_ACCEPT
 9

	)

49 
	#TCP_WINDOW_CLAMP
 10

	)

50 
	#TCP_INFO
 11

	)

51 
	#TCP_QUICKACK
 12

	)

52 
	#TCP_CONGESTION
 13

	)

53 
	#TCP_MD5SIG
 14

	)

54 
	#TCP_COOKIE_TRANSACTIONS
 15

	)

55 
	#TCP_THIN_LINEAR_TIMEOUTS
 16

	)

56 
	#TCP_THIN_DUPACK
 17

	)

57 
	#TCP_USER_TIMEOUT
 18

	)

58 
	#TCP_REPAIR
 19

	)

59 
	#TCP_REPAIR_QUEUE
 20

	)

60 
	#TCP_QUEUE_SEQ
 21

	)

61 
	#TCP_REPAIR_OPTIONS
 22

	)

62 
	#TCP_FASTOPEN
 23

	)

63 
	#TCP_TIMESTAMP
 24

	)

64 
	#TCP_NOTSENT_LOWAT
 25

	)

66 
	#TCP_CC_INFO
 26

	)

68 
	#TCP_SAVE_SYN
 27

	)

70 
	#TCP_SAVED_SYN
 28

	)

72 
	#TCP_REPAIR_WINDOW
 29

	)

73 
	#TCP_FASTOPEN_CONNECT
 30

	)

75 #ifdeà
__USE_MISC


76 
	~<sys/ty³s.h
>

77 
	~<sys/sock‘.h
>

78 
	~<¡dšt.h
>

80 
ušt32_t
 
	ttı_£q
;

85 
	stıhdr


87 
__ex‹nsiÚ__
 union

91 
ušt16_t
 
	mth_¥Üt
;

92 
ušt16_t
 
	mth_dpÜt
;

93 
tı_£q
 
	mth_£q
;

94 
tı_£q
 
	mth_ack
;

95 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


96 
ušt8_t
 
	mth_x2
:4;

97 
ušt8_t
 
	mth_off
:4;

99 #ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


100 
ušt8_t
 
	mth_off
:4;

101 
ušt8_t
 
	mth_x2
:4;

103 
ušt8_t
 
	mth_æags
;

104 
	#TH_FIN
 0x01

	)

105 
	#TH_SYN
 0x02

	)

106 
	#TH_RST
 0x04

	)

107 
	#TH_PUSH
 0x08

	)

108 
	#TH_ACK
 0x10

	)

109 
	#TH_URG
 0x20

	)

110 
ušt16_t
 
	mth_wš
;

111 
ušt16_t
 
	mth_sum
;

112 
ušt16_t
 
	mth_u½
;

116 
ušt16_t
 
	msourû
;

117 
ušt16_t
 
	mde¡
;

118 
ušt32_t
 
	m£q
;

119 
ušt32_t
 
	mack_£q
;

120 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


121 
ušt16_t
 
	m»s1
:4;

122 
ušt16_t
 
	mdoff
:4;

123 
ušt16_t
 
	mfš
:1;

124 
ušt16_t
 
	msyn
:1;

125 
ušt16_t
 
	mr¡
:1;

126 
ušt16_t
 
	mpsh
:1;

127 
ušt16_t
 
	mack
:1;

128 
ušt16_t
 
	murg
:1;

129 
ušt16_t
 
	m»s2
:2;

130 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


131 
ušt16_t
 
	mdoff
:4;

132 
ušt16_t
 
	m»s1
:4;

133 
ušt16_t
 
	m»s2
:2;

134 
ušt16_t
 
	murg
:1;

135 
ušt16_t
 
	mack
:1;

136 
ušt16_t
 
	mpsh
:1;

137 
ušt16_t
 
	mr¡
:1;

138 
ušt16_t
 
	msyn
:1;

139 
ušt16_t
 
	mfš
:1;

143 
ušt16_t
 
	mwšdow
;

144 
ušt16_t
 
	mcheck
;

145 
ušt16_t
 
	murg_±r
;

152 
	mTCP_ESTABLISHED
 = 1,

153 
	mTCP_SYN_SENT
,

154 
	mTCP_SYN_RECV
,

155 
	mTCP_FIN_WAIT1
,

156 
	mTCP_FIN_WAIT2
,

157 
	mTCP_TIME_WAIT
,

158 
	mTCP_CLOSE
,

159 
	mTCP_CLOSE_WAIT
,

160 
	mTCP_LAST_ACK
,

161 
	mTCP_LISTEN
,

162 
	mTCP_CLOSING


165 
	#TCPOPT_EOL
 0

	)

166 
	#TCPOPT_NOP
 1

	)

167 
	#TCPOPT_MAXSEG
 2

	)

168 
	#TCPOLEN_MAXSEG
 4

	)

169 
	#TCPOPT_WINDOW
 3

	)

170 
	#TCPOLEN_WINDOW
 3

	)

171 
	#TCPOPT_SACK_PERMITTED
 4

	)

172 
	#TCPOLEN_SACK_PERMITTED
 2

	)

173 
	#TCPOPT_SACK
 5

	)

174 
	#TCPOPT_TIMESTAMP
 8

	)

175 
	#TCPOLEN_TIMESTAMP
 10

	)

176 
	#TCPOLEN_TSTAMP_APPA
 (
TCPOLEN_TIMESTAMP
+2è

	)

178 
	#TCPOPT_TSTAMP_HDR
 \

179 (
TCPOPT_NOP
<<24|TCPOPT_NOP<<16|
TCPOPT_TIMESTAMP
<<8|
TCPOLEN_TIMESTAMP
)

	)

187 
	#TCP_MSS
 512

	)

189 
	#TCP_MAXWIN
 65535

	)

191 
	#TCP_MAX_WINSHIFT
 14

	)

193 
	#SOL_TCP
 6

	)

196 
	#TCPI_OPT_TIMESTAMPS
 1

	)

197 
	#TCPI_OPT_SACK
 2

	)

198 
	#TCPI_OPT_WSCALE
 4

	)

199 
	#TCPI_OPT_ECN
 8

	)

200 
	#TCPI_OPT_ECN_SEEN
 16

	)

201 
	#TCPI_OPT_SYN_DATA
 32

	)

204 
	etı_ÿ_¡©e


206 
	mTCP_CA_O³n
 = 0,

207 
	mTCP_CA_DisÜd”
 = 1,

208 
	mTCP_CA_CWR
 = 2,

209 
	mTCP_CA_Recov”y
 = 3,

210 
	mTCP_CA_Loss
 = 4

213 
	stı_šfo


215 
ušt8_t
 
	mtıi_¡©e
;

216 
ušt8_t
 
	mtıi_ÿ_¡©e
;

217 
ušt8_t
 
	mtıi_»Œªsm™s
;

218 
ušt8_t
 
	mtıi_´obes
;

219 
ušt8_t
 
	mtıi_backoff
;

220 
ušt8_t
 
	mtıi_İtiÚs
;

221 
ušt8_t
 
	mtıi_¢d_wsÿË
 : 4, 
	mtıi_rcv_wsÿË
 : 4;

223 
ušt32_t
 
	mtıi_¹o
;

224 
ušt32_t
 
	mtıi_©o
;

225 
ušt32_t
 
	mtıi_¢d_mss
;

226 
ušt32_t
 
	mtıi_rcv_mss
;

228 
ušt32_t
 
	mtıi_uÇcked
;

229 
ušt32_t
 
	mtıi_§cked
;

230 
ušt32_t
 
	mtıi_lo¡
;

231 
ušt32_t
 
	mtıi_»Œªs
;

232 
ušt32_t
 
	mtıi_çck‘s
;

235 
ušt32_t
 
	mtıi_Ï¡_d©a_£Á
;

236 
ušt32_t
 
	mtıi_Ï¡_ack_£Á
;

237 
ušt32_t
 
	mtıi_Ï¡_d©a_»cv
;

238 
ušt32_t
 
	mtıi_Ï¡_ack_»cv
;

241 
ušt32_t
 
	mtıi_pmtu
;

242 
ušt32_t
 
	mtıi_rcv_s¡h»sh
;

243 
ušt32_t
 
	mtıi_¹t
;

244 
ušt32_t
 
	mtıi_¹tv¬
;

245 
ušt32_t
 
	mtıi_¢d_s¡h»sh
;

246 
ušt32_t
 
	mtıi_¢d_cwnd
;

247 
ušt32_t
 
	mtıi_advmss
;

248 
ušt32_t
 
	mtıi_»Üd”šg
;

250 
ušt32_t
 
	mtıi_rcv_¹t
;

251 
ušt32_t
 
	mtıi_rcv_¥aû
;

253 
ušt32_t
 
	mtıi_tÙ®_»Œªs
;

258 
	#TCP_MD5SIG_MAXKEYLEN
 80

	)

260 
	stı_md5sig


262 
sockaddr_¡Üage
 
	mtım_addr
;

263 
ušt16_t
 
	m__tım_·d1
;

264 
ušt16_t
 
	mtım_keyËn
;

265 
ušt32_t
 
	m__tım_·d2
;

266 
ušt8_t
 
	mtım_key
[
TCP_MD5SIG_MAXKEYLEN
];

270 
	stı_»·œ_İt


272 
ušt32_t
 
	mİt_code
;

273 
ušt32_t
 
	mİt_v®
;

279 
	mTCP_NO_QUEUE
,

280 
	mTCP_RECV_QUEUE
,

281 
	mTCP_SEND_QUEUE
,

282 
	mTCP_QUEUES_NR
,

286 
	#TCP_COOKIE_MIN
 8

	)

287 
	#TCP_COOKIE_MAX
 16

	)

288 
	#TCP_COOKIE_PAIR_SIZE
 (2*
TCP_COOKIE_MAX
)

	)

291 
	#TCP_COOKIE_IN_ALWAYS
 (1 << 0è

	)

292 
	#TCP_COOKIE_OUT_NEVER
 (1 << 1è

	)

296 
	#TCP_S_DATA_IN
 (1 << 2è

	)

297 
	#TCP_S_DATA_OUT
 (1 << 3è

	)

299 
	#TCP_MSS_DEFAULT
 536U

	)

300 
	#TCP_MSS_DESIRED
 1220U

	)

302 
	stı_cook›_Œª§ùiÚs


304 
ušt16_t
 
	mtıù_æags
;

305 
ušt8_t
 
	m__tıù_·d1
;

306 
ušt8_t
 
	mtıù_cook›_desœed
;

307 
ušt16_t
 
	mtıù_s_d©a_desœed
;

308 
ušt16_t
 
	mtıù_u£d
;

309 
ušt8_t
 
	mtıù_v®ue
[
TCP_MSS_DEFAULT
];

313 
	stı_»·œ_wšdow


315 
ušt32_t
 
	m¢d_wl1
;

316 
ušt32_t
 
	m¢d_wnd
;

317 
ušt32_t
 
	mmax_wšdow
;

318 
ušt32_t
 
	mrcv_wnd
;

319 
ušt32_t
 
	mrcv_wup
;

	@/usr/include/pthread.h

18 #iâdeà
_PTHREAD_H


19 
	#_PTHREAD_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	~<’dŸn.h
>

23 
	~<sched.h
>

24 
	~<time.h
>

26 
	~<b™s/±h»adty³s.h
>

27 
	~<b™s/£tjmp.h
>

28 
	~<b™s/wÜdsize.h
>

29 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

35 
	mPTHREAD_CREATE_JOINABLE
,

36 
	#PTHREAD_CREATE_JOINABLE
 
PTHREAD_CREATE_JOINABLE


	)

37 
	mPTHREAD_CREATE_DETACHED


38 
	#PTHREAD_CREATE_DETACHED
 
PTHREAD_CREATE_DETACHED


	)

45 
	mPTHREAD_MUTEX_TIMED_NP
,

46 
	mPTHREAD_MUTEX_RECURSIVE_NP
,

47 
	mPTHREAD_MUTEX_ERRORCHECK_NP
,

48 
	mPTHREAD_MUTEX_ADAPTIVE_NP


49 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


51 
	mPTHREAD_MUTEX_NORMAL
 = 
PTHREAD_MUTEX_TIMED_NP
,

52 
	mPTHREAD_MUTEX_RECURSIVE
 = 
PTHREAD_MUTEX_RECURSIVE_NP
,

53 
	mPTHREAD_MUTEX_ERRORCHECK
 = 
PTHREAD_MUTEX_ERRORCHECK_NP
,

54 
	mPTHREAD_MUTEX_DEFAULT
 = 
PTHREAD_MUTEX_NORMAL


56 #ifdeà
__USE_GNU


58 , 
	mPTHREAD_MUTEX_FAST_NP
 = 
PTHREAD_MUTEX_TIMED_NP


63 #ifdeà
__USE_XOPEN2K


67 
	mPTHREAD_MUTEX_STALLED
,

68 
	mPTHREAD_MUTEX_STALLED_NP
 = 
PTHREAD_MUTEX_STALLED
,

69 
	mPTHREAD_MUTEX_ROBUST
,

70 
	mPTHREAD_MUTEX_ROBUST_NP
 = 
PTHREAD_MUTEX_ROBUST


75 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


79 
	mPTHREAD_PRIO_NONE
,

80 
	mPTHREAD_PRIO_INHERIT
,

81 
	mPTHREAD_PRIO_PROTECT


86 #ifdeà
__PTHREAD_MUTEX_HAVE_PREV


87 
	#PTHREAD_MUTEX_INITIALIZER
 \

88 { { 0, 0, 0, 0, 0, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

89 #ifdeà
__USE_GNU


90 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

91 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

92 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

93 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

94 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

95 { { 0, 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 
__PTHREAD_SPINS
, { 0, 0 } } }

	)

99 
	#PTHREAD_MUTEX_INITIALIZER
 \

100 { { 0, 0, 0, 0, 0, { 
__PTHREAD_SPINS
 } } }

	)

101 #ifdeà
__USE_GNU


102 
	#PTHREAD_RECURSIVE_MUTEX_INITIALIZER_NP
 \

103 { { 0, 0, 0, 
PTHREAD_MUTEX_RECURSIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

104 
	#PTHREAD_ERRORCHECK_MUTEX_INITIALIZER_NP
 \

105 { { 0, 0, 0, 
PTHREAD_MUTEX_ERRORCHECK_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

106 
	#PTHREAD_ADAPTIVE_MUTEX_INITIALIZER_NP
 \

107 { { 0, 0, 0, 
PTHREAD_MUTEX_ADAPTIVE_NP
, 0, { 
__PTHREAD_SPINS
 } } }

	)

114 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


117 
	mPTHREAD_RWLOCK_PREFER_READER_NP
,

118 
	mPTHREAD_RWLOCK_PREFER_WRITER_NP
,

119 
	mPTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,

120 
	mPTHREAD_RWLOCK_DEFAULT_NP
 = 
PTHREAD_RWLOCK_PREFER_READER_NP


126 #iâdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


127 #ià
__WORDSIZE
 == 64

128 
	#__PTHREAD_RWLOCK_INT_FLAGS_SHARED
 1

	)

133 
	#PTHREAD_RWLOCK_INITIALIZER
 \

134 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

135 #ifdeà
__USE_GNU


136 #ifdeà
__PTHREAD_RWLOCK_INT_FLAGS_SHARED


137 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

138 { { 0, 0, 0, 0, 0, 0, 0, 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, \

139 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
 } }

	)

141 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


142 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

143 { { 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
, \

144 0, 
__PTHREAD_RWLOCK_ELISION_EXTRA
, 0, 0 } }

	)

146 
	#PTHREAD_RWLOCK_WRITER_NONRECURSIVE_INITIALIZER_NP
 \

147 { { 0, 0, 0, 0, 0, 0, 0, 0, 0, 
PTHREAD_RWLOCK_PREFER_WRITER_NONRECURSIVE_NP
,\

148 0 } }

	)

158 
	mPTHREAD_INHERIT_SCHED
,

159 
	#PTHREAD_INHERIT_SCHED
 
PTHREAD_INHERIT_SCHED


	)

160 
	mPTHREAD_EXPLICIT_SCHED


161 
	#PTHREAD_EXPLICIT_SCHED
 
PTHREAD_EXPLICIT_SCHED


	)

168 
	mPTHREAD_SCOPE_SYSTEM
,

169 
	#PTHREAD_SCOPE_SYSTEM
 
PTHREAD_SCOPE_SYSTEM


	)

170 
	mPTHREAD_SCOPE_PROCESS


171 
	#PTHREAD_SCOPE_PROCESS
 
PTHREAD_SCOPE_PROCESS


	)

178 
	mPTHREAD_PROCESS_PRIVATE
,

179 
	#PTHREAD_PROCESS_PRIVATE
 
PTHREAD_PROCESS_PRIVATE


	)

180 
	mPTHREAD_PROCESS_SHARED


181 
	#PTHREAD_PROCESS_SHARED
 
PTHREAD_PROCESS_SHARED


	)

187 
	#PTHREAD_COND_INITIALIZER
 { { {0}, {0}, {0, 0}, {0, 0}, 0, 0, {0, 0} } }

	)

191 
	s_±h»ad_ş—nup_bufãr


193 (*
	m__routše
) (*);

194 *
	m__¬g
;

195 
	m__ÿnûÉy³
;

196 
_±h»ad_ş—nup_bufãr
 *
	m__´ev
;

202 
	mPTHREAD_CANCEL_ENABLE
,

203 
	#PTHREAD_CANCEL_ENABLE
 
PTHREAD_CANCEL_ENABLE


	)

204 
	mPTHREAD_CANCEL_DISABLE


205 
	#PTHREAD_CANCEL_DISABLE
 
PTHREAD_CANCEL_DISABLE


	)

209 
	mPTHREAD_CANCEL_DEFERRED
,

210 
	#PTHREAD_CANCEL_DEFERRED
 
PTHREAD_CANCEL_DEFERRED


	)

211 
	mPTHREAD_CANCEL_ASYNCHRONOUS


212 
	#PTHREAD_CANCEL_ASYNCHRONOUS
 
PTHREAD_CANCEL_ASYNCHRONOUS


	)

214 
	#PTHREAD_CANCELED
 ((*è-1)

	)

218 
	#PTHREAD_ONCE_INIT
 0

	)

221 #ifdeà
__USE_XOPEN2K


225 
	#PTHREAD_BARRIER_SERIAL_THREAD
 -1

	)

229 
__BEGIN_DECLS


234 
	$±h»ad_ü—‹
 (
±h»ad_t
 *
__»¡riù
 
__Ãwth»ad
,

235 cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

236 *(*
__¡¬t_routše
) (*),

237 *
__»¡riù
 
__¬g
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 3));

243 
	$±h»ad_ex™
 (*
__»tv®
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

251 
	`±h»ad_još
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
);

253 #ifdeà
__USE_GNU


256 
	$±h»ad_Œyjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
è
__THROW
;

264 
	`±h»ad_timedjoš_Å
 (
±h»ad_t
 
__th
, **
__th»ad_»tuº
,

265 cÚ¡ 
time¥ec
 *
__ab¡ime
);

272 
	$±h»ad_d‘ach
 (
±h»ad_t
 
__th
è
__THROW
;

276 
±h»ad_t
 
	$±h»ad_£lf
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

279 
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
)

280 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

288 
	$±h»ad_©Œ_š™
 (
±h»ad_©Œ_t
 *
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

291 
	$±h»ad_©Œ_de¡roy
 (
±h»ad_©Œ_t
 *
__©Œ
)

292 
__THROW
 
	`__nÚnuÎ
 ((1));

295 
	$±h»ad_©Œ_g‘d‘ach¡©e
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

296 *
__d‘ach¡©e
)

297 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

300 
	$±h»ad_©Œ_£td‘ach¡©e
 (
±h»ad_©Œ_t
 *
__©Œ
,

301 
__d‘ach¡©e
)

302 
__THROW
 
	`__nÚnuÎ
 ((1));

306 
	$±h»ad_©Œ_g‘gu¬dsize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

307 
size_t
 *
__gu¬dsize
)

308 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

311 
	$±h»ad_©Œ_£tgu¬dsize
 (
±h»ad_©Œ_t
 *
__©Œ
,

312 
size_t
 
__gu¬dsize
)

313 
__THROW
 
	`__nÚnuÎ
 ((1));

317 
	$±h»ad_©Œ_g‘sched·¿m
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

318 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

319 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

322 
	$±h»ad_©Œ_£tsched·¿m
 (
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

323 cÚ¡ 
sched_·¿m
 *
__»¡riù


324 
__·¿m
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

327 
	$±h»ad_©Œ_g‘schedpŞicy
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


328 
__©Œ
, *
__»¡riù
 
__pŞicy
)

329 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

332 
	$±h»ad_©Œ_£tschedpŞicy
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__pŞicy
)

333 
__THROW
 
	`__nÚnuÎ
 ((1));

336 
	$±h»ad_©Œ_g‘šh”™sched
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


337 
__©Œ
, *
__»¡riù
 
__šh”™
)

338 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

341 
	$±h»ad_©Œ_£tšh”™sched
 (
±h»ad_©Œ_t
 *
__©Œ
,

342 
__šh”™
)

343 
__THROW
 
	`__nÚnuÎ
 ((1));

347 
	$±h»ad_©Œ_g‘scİe
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

348 *
__»¡riù
 
__scİe
)

349 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

352 
	$±h»ad_©Œ_£tscİe
 (
±h»ad_©Œ_t
 *
__©Œ
, 
__scİe
)

353 
__THROW
 
	`__nÚnuÎ
 ((1));

356 
	$±h»ad_©Œ_g‘¡ackaddr
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


357 
__©Œ
, **
__»¡riù
 
__¡ackaddr
)

358 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__©Œibu‹_d•»ÿ‹d__
;

364 
	$±h»ad_©Œ_£t¡ackaddr
 (
±h»ad_©Œ_t
 *
__©Œ
,

365 *
__¡ackaddr
)

366 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
;

369 
	$±h»ad_©Œ_g‘¡acksize
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù


370 
__©Œ
, 
size_t
 *
__»¡riù
 
__¡acksize
)

371 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

376 
	$±h»ad_©Œ_£t¡acksize
 (
±h»ad_©Œ_t
 *
__©Œ
,

377 
size_t
 
__¡acksize
)

378 
__THROW
 
	`__nÚnuÎ
 ((1));

380 #ifdeà
__USE_XOPEN2K


382 
	$±h»ad_©Œ_g‘¡ack
 (cÚ¡ 
±h»ad_©Œ_t
 *
__»¡riù
 
__©Œ
,

383 **
__»¡riù
 
__¡ackaddr
,

384 
size_t
 *
__»¡riù
 
__¡acksize
)

385 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

390 
	$±h»ad_©Œ_£t¡ack
 (
±h»ad_©Œ_t
 *
__©Œ
, *
__¡ackaddr
,

391 
size_t
 
__¡acksize
è
__THROW
 
	`__nÚnuÎ
 ((1));

394 #ifdeà
__USE_GNU


397 
	$±h»ad_©Œ_£ffš™y_Å
 (
±h»ad_©Œ_t
 *
__©Œ
,

398 
size_t
 
__ıu£tsize
,

399 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

400 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

404 
	$±h»ad_©Œ_g‘affš™y_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
,

405 
size_t
 
__ıu£tsize
,

406 
ıu_£t_t
 *
__ıu£t
)

407 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

410 
	$±h»ad_g‘©Œ_deçuÉ_Å
 (
±h»ad_©Œ_t
 *
__©Œ
)

411 
__THROW
 
	`__nÚnuÎ
 ((1));

415 
	$±h»ad_£‰r_deçuÉ_Å
 (cÚ¡ 
±h»ad_©Œ_t
 *
__©Œ
)

416 
__THROW
 
	`__nÚnuÎ
 ((1));

421 
	$±h»ad_g‘©Œ_Å
 (
±h»ad_t
 
__th
, 
±h»ad_©Œ_t
 *
__©Œ
)

422 
__THROW
 
	`__nÚnuÎ
 ((2));

430 
	$±h»ad_£tsched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
, 
__pŞicy
,

431 cÚ¡ 
sched_·¿m
 *
__·¿m
)

432 
__THROW
 
	`__nÚnuÎ
 ((3));

435 
	$±h»ad_g‘sched·¿m
 (
±h»ad_t
 
__rg‘_th»ad
,

436 *
__»¡riù
 
__pŞicy
,

437 
sched_·¿m
 *
__»¡riù
 
__·¿m
)

438 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

441 
	$±h»ad_£tsched´io
 (
±h»ad_t
 
__rg‘_th»ad
, 
__´io
)

442 
__THROW
;

445 #ifdeà
__USE_GNU


447 
	$±h»ad_g‘Çme_Å
 (
±h»ad_t
 
__rg‘_th»ad
, *
__buf
,

448 
size_t
 
__buæ’
)

449 
__THROW
 
	`__nÚnuÎ
 ((2));

452 
	$±h»ad_£Šame_Å
 (
±h»ad_t
 
__rg‘_th»ad
, cÚ¡ *
__Çme
)

453 
__THROW
 
	`__nÚnuÎ
 ((2));

457 #ifdeà
__USE_UNIX98


459 
	$±h»ad_g‘cÚcu¼’cy
 (è
__THROW
;

462 
	$±h»ad_£tcÚcu¼’cy
 (
__Ëv–
è
__THROW
;

465 #ifdeà
__USE_GNU


470 
	$±h»ad_y›ld
 (è
__THROW
;

475 
	$±h»ad_£ffš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

476 cÚ¡ 
ıu_£t_t
 *
__ıu£t
)

477 
__THROW
 
	`__nÚnuÎ
 ((3));

480 
	$±h»ad_g‘affš™y_Å
 (
±h»ad_t
 
__th
, 
size_t
 
__ıu£tsize
,

481 
ıu_£t_t
 *
__ıu£t
)

482 
__THROW
 
	`__nÚnuÎ
 ((3));

495 
	$±h»ad_Úû
 (
±h»ad_Úû_t
 *
__Úû_cÚŒŞ
,

496 (*
__š™_routše
è()è
	`__nÚnuÎ
 ((1, 2));

507 
	`±h»ad_£tÿnûl¡©e
 (
__¡©e
, *
__Şd¡©e
);

511 
	`±h»ad_£tÿnûÉy³
 (
__ty³
, *
__Şdty³
);

514 
	`±h»ad_ÿnûl
 (
±h»ad_t
 
__th
);

519 
	`±h»ad_‹¡ÿnûl
 ();

528 
__jmp_buf
 
__ÿnûl_jmp_buf
;

529 
__mask_was_§ved
;

530 } 
__ÿnûl_jmp_buf
[1];

531 *
__·d
[4];

532 } 
	t__±h»ad_unwšd_buf_t
 
	t__©Œibu‹__
 ((
	t__®igÃd__
));

535 #iâdeà
__ş—nup_fù_©Œibu‹


536 
	#__ş—nup_fù_©Œibu‹


	)

541 
	s__±h»ad_ş—nup_äame


543 (*
__ÿnûl_routše
) (*);

544 *
__ÿnûl_¬g
;

545 
__do_™
;

546 
__ÿnûl_ty³
;

549 #ià
defšed
 
__GNUC__
 && defšed 
__EXCEPTIONS


550 #ifdeà
__ılu¥lus


552 şas 
	c__±h»ad_ş—nup_şass


554 (*
__ÿnûl_routše
) (*);

555 *
__ÿnûl_¬g
;

556 
__do_™
;

557 
__ÿnûl_ty³
;

559 
public
:

560 
	$__±h»ad_ş—nup_şass
 ((*
__fù
è(*), *
__¬g
)

561 : 
	`__ÿnûl_routše
 (
__fù
), 
	`__ÿnûl_¬g
 (
__¬g
), 
	$__do_™
 (1) { }

562 ~
	$__±h»ad_ş—nup_şass
 (è{ ià(
__do_™
è
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); 
	}
}

563 
	$__£tdo™
 (
__Ãwv®
è{ 
__do_™
 = __Ãwv®; 
	}
}

564 
	$__deãr
 (è{ 
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
,

565 &
__ÿnûl_ty³
); 
	}
}

566 
	$__»¡Üe
 (ècÚ¡ { 
	`±h»ad_£tÿnûÉy³
 (
__ÿnûl_ty³
, 0); 
	}
}

576 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

578 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
)

	)

582 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

583 
__şäame
.
	`__£tdo™
 (
execu‹
); \

584 } 0)

	)

586 #ifdeà
__USE_GNU


590 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

592 
__±h»ad_ş—nup_şass
 
	`__şäame
 (
routše
, 
¬g
); \

593 
__şäame
.
	`__deãr
 ()

	)

598 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

599 
__şäame
.
	`__»¡Üe
 (); \

600 
__şäame
.
	`__£tdo™
 (
execu‹
); \

601 } 0)

	)

608 
__ex‹º_šlše
 

609 
	$__±h»ad_ş—nup_routše
 (
__±h»ad_ş—nup_äame
 *
__äame
)

611 ià(
__äame
->
__do_™
)

612 
__äame
->
	`__ÿnûl_routše
 (__äame->
__ÿnûl_¬g
);

613 
	}
}

622 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

624 
__±h»ad_ş—nup_äame
 
__şäame
 \

625 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

626 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

627 .
__do_™
 = 1 };

	)

631 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

632 
__şäame
.
__do_™
 = (
execu‹
); \

633 } 0)

	)

635 #ifdeà
__USE_GNU


639 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

641 
__±h»ad_ş—nup_äame
 
__şäame
 \

642 
	`__©Œibu‹__
 ((
	`__ş—nup__
 (
__±h»ad_ş—nup_routše
))) \

643 ğ{ .
__ÿnûl_routše
 = (
routše
), .
__ÿnûl_¬g
 = (
¬g
), \

644 .
__do_™
 = 1 }; \

645 (è
	`±h»ad_£tÿnûÉy³
 (
PTHREAD_CANCEL_DEFERRED
, \

646 &
__şäame
.
__ÿnûl_ty³
)

	)

651 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

652 (è
	`±h»ad_£tÿnûÉy³
 (
__şäame
.
__ÿnûl_ty³
, 
NULL
); \

653 
__şäame
.
__do_™
 = (
execu‹
); \

654 } 0)

	)

665 
	#±h»ad_ş—nup_push
(
routše
, 
¬g
) \

667 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

668 (*
__ÿnûl_routše
è(*èğ(
routše
); \

669 *
__ÿnûl_¬g
 = (
¬g
); \

670 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

671 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

672 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

674 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

675 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

679 
	`__±h»ad_»gi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

680 dØ{

	)

681 
__±h»ad_»gi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

682 
__ş—nup_fù_©Œibu‹
;

686 
	#±h»ad_ş—nup_pİ
(
execu‹
) \

689 
	`__±h»ad_uÄegi¡”_ÿnûl
 (&
__ÿnûl_buf
); \

690 ià(
execu‹
) \

691 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

692 } 0)

	)

693 
	$__±h»ad_uÄegi¡”_ÿnûl
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

694 
__ş—nup_fù_©Œibu‹
;

696 #ifdeà
__USE_GNU


700 
	#±h»ad_ş—nup_push_deãr_Å
(
routše
, 
¬g
) \

702 
__±h»ad_unwšd_buf_t
 
__ÿnûl_buf
; \

703 (*
__ÿnûl_routše
è(*èğ(
routše
); \

704 *
__ÿnûl_¬g
 = (
¬g
); \

705 
__nÙ_fœ¡_ÿÎ
 = 
	`__sig£tjmp
 ((
__jmp_buf_g
 *) (*) \

706 
__ÿnûl_buf
.
__ÿnûl_jmp_buf
, 0); \

707 ià(
	`__glibc_uÆik–y
 (
__nÙ_fœ¡_ÿÎ
)) \

709 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

710 
	`__±h»ad_unwšd_Ãxt
 (&
__ÿnûl_buf
); \

714 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (&
__ÿnûl_buf
); \

715 dØ{

	)

716 
	`__±h»ad_»gi¡”_ÿnûl_deãr
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

717 
__ş—nup_fù_©Œibu‹
;

722 
	#±h»ad_ş—nup_pİ_»¡Üe_Å
(
execu‹
) \

725 
	`__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (&
__ÿnûl_buf
); \

726 ià(
execu‹
) \

727 
	`__ÿnûl_routše
 (
__ÿnûl_¬g
); \

728 
	}
} 0)

	)

729 
	$__±h»ad_uÄegi¡”_ÿnûl_»¡Üe
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

730 
__ş—nup_fù_©Œibu‹
;

734 
	$__±h»ad_unwšd_Ãxt
 (
__±h»ad_unwšd_buf_t
 *
__buf
)

735 
__ş—nup_fù_©Œibu‹
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
))

736 #iâdeà
SHARED


737 
	`__©Œibu‹__
 ((
__w—k__
))

743 
__jmp_buf_g
;

744 
	$__sig£tjmp
 (
__jmp_buf_g
 *
__’v
, 
__§vemask
è
__THROWNL
;

750 
	$±h»ad_mu‹x_š™
 (
±h»ad_mu‹x_t
 *
__mu‹x
,

751 cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__mu‹x©Œ
)

752 
__THROW
 
	`__nÚnuÎ
 ((1));

755 
	$±h»ad_mu‹x_de¡roy
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

756 
__THROW
 
	`__nÚnuÎ
 ((1));

759 
	$±h»ad_mu‹x_Œylock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

760 
__THROWNL
 
	`__nÚnuÎ
 ((1));

763 
	$±h»ad_mu‹x_lock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

764 
__THROWNL
 
	`__nÚnuÎ
 ((1));

766 #ifdeà
__USE_XOPEN2K


768 
	$±h»ad_mu‹x_timedlock
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

769 cÚ¡ 
time¥ec
 *
__»¡riù


770 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

774 
	$±h»ad_mu‹x_uÆock
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

775 
__THROWNL
 
	`__nÚnuÎ
 ((1));

779 
	$±h»ad_mu‹x_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x_t
 *

780 
__»¡riù
 
__mu‹x
,

781 *
__»¡riù
 
__´ioûšg
)

782 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

786 
	$±h»ad_mu‹x_£rioûšg
 (
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

787 
__´ioûšg
,

788 *
__»¡riù
 
__Şd_ûšg
)

789 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

792 #ifdeà
__USE_XOPEN2K8


794 
	$±h»ad_mu‹x_cÚsi¡’t
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

795 
__THROW
 
	`__nÚnuÎ
 ((1));

796 #ifdeà
__USE_GNU


797 
	$±h»ad_mu‹x_cÚsi¡’t_Å
 (
±h»ad_mu‹x_t
 *
__mu‹x
)

798 
__THROW
 
	`__nÚnuÎ
 ((1));

807 
	$±h»ad_mu‹x©Œ_š™
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

808 
__THROW
 
	`__nÚnuÎ
 ((1));

811 
	$±h»ad_mu‹x©Œ_de¡roy
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
)

812 
__THROW
 
	`__nÚnuÎ
 ((1));

815 
	$±h»ad_mu‹x©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

816 
__»¡riù
 
__©Œ
,

817 *
__»¡riù
 
__psh¬ed
)

818 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

821 
	$±h»ad_mu‹x©Œ_£sh¬ed
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

822 
__psh¬ed
)

823 
__THROW
 
	`__nÚnuÎ
 ((1));

825 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


827 
	$±h»ad_mu‹x©Œ_g‘ty³
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__»¡riù


828 
__©Œ
, *
__»¡riù
 
__kšd
)

829 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

834 
	$±h»ad_mu‹x©Œ_£‰y³
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
, 
__kšd
)

835 
__THROW
 
	`__nÚnuÎ
 ((1));

839 
	$±h»ad_mu‹x©Œ_g‘´ÙocŞ
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

840 
__»¡riù
 
__©Œ
,

841 *
__»¡riù
 
__´ÙocŞ
)

842 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

846 
	$±h»ad_mu‹x©Œ_£rÙocŞ
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

847 
__´ÙocŞ
)

848 
__THROW
 
	`__nÚnuÎ
 ((1));

851 
	$±h»ad_mu‹x©Œ_g‘´ioûšg
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *

852 
__»¡riù
 
__©Œ
,

853 *
__»¡riù
 
__´ioûšg
)

854 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

857 
	$±h»ad_mu‹x©Œ_£rioûšg
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

858 
__´ioûšg
)

859 
__THROW
 
	`__nÚnuÎ
 ((1));

861 #ifdeà
__USE_XOPEN2K


863 
	$±h»ad_mu‹x©Œ_g‘robu¡
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

864 *
__robu¡Ãss
)

865 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

866 #ifdeà
__USE_GNU


867 
	$±h»ad_mu‹x©Œ_g‘robu¡_Å
 (cÚ¡ 
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

868 *
__robu¡Ãss
)

869 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

873 
	$±h»ad_mu‹x©Œ_£Œobu¡
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

874 
__robu¡Ãss
)

875 
__THROW
 
	`__nÚnuÎ
 ((1));

876 #ifdeà
__USE_GNU


877 
	$±h»ad_mu‹x©Œ_£Œobu¡_Å
 (
±h»ad_mu‹x©Œ_t
 *
__©Œ
,

878 
__robu¡Ãss
)

879 
__THROW
 
	`__nÚnuÎ
 ((1));

884 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


889 
	$±h»ad_rwlock_š™
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

890 cÚ¡ 
±h»ad_rwlock©Œ_t
 *
__»¡riù


891 
__©Œ
è
__THROW
 
	`__nÚnuÎ
 ((1));

894 
	$±h»ad_rwlock_de¡roy
 (
±h»ad_rwlock_t
 *
__rwlock
)

895 
__THROW
 
	`__nÚnuÎ
 ((1));

898 
	$±h»ad_rwlock_rdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

899 
__THROWNL
 
	`__nÚnuÎ
 ((1));

902 
	$±h»ad_rwlock_Œyrdlock
 (
±h»ad_rwlock_t
 *
__rwlock
)

903 
__THROWNL
 
	`__nÚnuÎ
 ((1));

905 #ifdeà
__USE_XOPEN2K


907 
	$±h»ad_rwlock_timedrdlock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

908 cÚ¡ 
time¥ec
 *
__»¡riù


909 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

913 
	$±h»ad_rwlock_w¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

914 
__THROWNL
 
	`__nÚnuÎ
 ((1));

917 
	$±h»ad_rwlock_Œyw¾ock
 (
±h»ad_rwlock_t
 *
__rwlock
)

918 
__THROWNL
 
	`__nÚnuÎ
 ((1));

920 #ifdeà
__USE_XOPEN2K


922 
	$±h»ad_rwlock_timedw¾ock
 (
±h»ad_rwlock_t
 *
__»¡riù
 
__rwlock
,

923 cÚ¡ 
time¥ec
 *
__»¡riù


924 
__ab¡ime
è
__THROWNL
 
	`__nÚnuÎ
 ((1, 2));

928 
	$±h»ad_rwlock_uÆock
 (
±h»ad_rwlock_t
 *
__rwlock
)

929 
__THROWNL
 
	`__nÚnuÎ
 ((1));

935 
	$±h»ad_rwlock©Œ_š™
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

936 
__THROW
 
	`__nÚnuÎ
 ((1));

939 
	$±h»ad_rwlock©Œ_de¡roy
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
)

940 
__THROW
 
	`__nÚnuÎ
 ((1));

943 
	$±h»ad_rwlock©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

944 
__»¡riù
 
__©Œ
,

945 *
__»¡riù
 
__psh¬ed
)

946 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

949 
	$±h»ad_rwlock©Œ_£sh¬ed
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

950 
__psh¬ed
)

951 
__THROW
 
	`__nÚnuÎ
 ((1));

954 
	$±h»ad_rwlock©Œ_g‘kšd_Å
 (cÚ¡ 
±h»ad_rwlock©Œ_t
 *

955 
__»¡riù
 
__©Œ
,

956 *
__»¡riù
 
__´ef
)

957 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

960 
	$±h»ad_rwlock©Œ_£tkšd_Å
 (
±h»ad_rwlock©Œ_t
 *
__©Œ
,

961 
__´ef
è
__THROW
 
	`__nÚnuÎ
 ((1));

969 
	$±h»ad_cÚd_š™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

970 cÚ¡ 
±h»ad_cÚd©Œ_t
 *
__»¡riù
 
__cÚd_©Œ
)

971 
__THROW
 
	`__nÚnuÎ
 ((1));

974 
	$±h»ad_cÚd_de¡roy
 (
±h»ad_cÚd_t
 *
__cÚd
)

975 
__THROW
 
	`__nÚnuÎ
 ((1));

978 
	$±h»ad_cÚd_sigÇl
 (
±h»ad_cÚd_t
 *
__cÚd
)

979 
__THROWNL
 
	`__nÚnuÎ
 ((1));

982 
	$±h»ad_cÚd_brßdÿ¡
 (
±h»ad_cÚd_t
 *
__cÚd
)

983 
__THROWNL
 
	`__nÚnuÎ
 ((1));

990 
	$±h»ad_cÚd_wa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

991 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
)

992 
	`__nÚnuÎ
 ((1, 2));

1001 
	$±h»ad_cÚd_timedwa™
 (
±h»ad_cÚd_t
 *
__»¡riù
 
__cÚd
,

1002 
±h»ad_mu‹x_t
 *
__»¡riù
 
__mu‹x
,

1003 cÚ¡ 
time¥ec
 *
__»¡riù
 
__ab¡ime
)

1004 
	`__nÚnuÎ
 ((1, 2, 3));

1009 
	$±h»ad_cÚd©Œ_š™
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1010 
__THROW
 
	`__nÚnuÎ
 ((1));

1013 
	$±h»ad_cÚd©Œ_de¡roy
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
)

1014 
__THROW
 
	`__nÚnuÎ
 ((1));

1017 
	$±h»ad_cÚd©Œ_g‘psh¬ed
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1018 
__»¡riù
 
__©Œ
,

1019 *
__»¡riù
 
__psh¬ed
)

1020 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1023 
	$±h»ad_cÚd©Œ_£sh¬ed
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1024 
__psh¬ed
è
__THROW
 
	`__nÚnuÎ
 ((1));

1026 #ifdeà
__USE_XOPEN2K


1028 
	$±h»ad_cÚd©Œ_g‘şock
 (cÚ¡ 
±h»ad_cÚd©Œ_t
 *

1029 
__»¡riù
 
__©Œ
,

1030 
__şockid_t
 *
__»¡riù
 
__şock_id
)

1031 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1034 
	$±h»ad_cÚd©Œ_£tşock
 (
±h»ad_cÚd©Œ_t
 *
__©Œ
,

1035 
__şockid_t
 
__şock_id
)

1036 
__THROW
 
	`__nÚnuÎ
 ((1));

1040 #ifdeà
__USE_XOPEN2K


1045 
	$±h»ad_¥š_š™
 (
±h»ad_¥šlock_t
 *
__lock
, 
__psh¬ed
)

1046 
__THROW
 
	`__nÚnuÎ
 ((1));

1049 
	$±h»ad_¥š_de¡roy
 (
±h»ad_¥šlock_t
 *
__lock
)

1050 
__THROW
 
	`__nÚnuÎ
 ((1));

1053 
	$±h»ad_¥š_lock
 (
±h»ad_¥šlock_t
 *
__lock
)

1054 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1057 
	$±h»ad_¥š_Œylock
 (
±h»ad_¥šlock_t
 *
__lock
)

1058 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1061 
	$±h»ad_¥š_uÆock
 (
±h»ad_¥šlock_t
 *
__lock
)

1062 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1069 
	$±h»ad_b¬r›r_š™
 (
±h»ad_b¬r›r_t
 *
__»¡riù
 
__b¬r›r
,

1070 cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *
__»¡riù


1071 
__©Œ
, 
__couÁ
)

1072 
__THROW
 
	`__nÚnuÎ
 ((1));

1075 
	$±h»ad_b¬r›r_de¡roy
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1076 
__THROW
 
	`__nÚnuÎ
 ((1));

1079 
	$±h»ad_b¬r›r_wa™
 (
±h»ad_b¬r›r_t
 *
__b¬r›r
)

1080 
__THROWNL
 
	`__nÚnuÎ
 ((1));

1084 
	$±h»ad_b¬r›¿‰r_š™
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1085 
__THROW
 
	`__nÚnuÎ
 ((1));

1088 
	$±h»ad_b¬r›¿‰r_de¡roy
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
)

1089 
__THROW
 
	`__nÚnuÎ
 ((1));

1092 
	$±h»ad_b¬r›¿‰r_g‘psh¬ed
 (cÚ¡ 
±h»ad_b¬r›¿‰r_t
 *

1093 
__»¡riù
 
__©Œ
,

1094 *
__»¡riù
 
__psh¬ed
)

1095 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1098 
	$±h»ad_b¬r›¿‰r_£sh¬ed
 (
±h»ad_b¬r›¿‰r_t
 *
__©Œ
,

1099 
__psh¬ed
)

1100 
__THROW
 
	`__nÚnuÎ
 ((1));

1112 
	$±h»ad_key_ü—‹
 (
±h»ad_key_t
 *
__key
,

1113 (*
__de¡r_funùiÚ
) (*))

1114 
__THROW
 
	`__nÚnuÎ
 ((1));

1117 
	$±h»ad_key_d–‘e
 (
±h»ad_key_t
 
__key
è
__THROW
;

1120 *
	$±h»ad_g‘¥ecific
 (
±h»ad_key_t
 
__key
è
__THROW
;

1123 
	$±h»ad_£t¥ecific
 (
±h»ad_key_t
 
__key
,

1124 cÚ¡ *
__poš‹r
è
__THROW
 ;

1127 #ifdeà
__USE_XOPEN2K


1129 
	$±h»ad_g‘ıuşockid
 (
±h»ad_t
 
__th»ad_id
,

1130 
__şockid_t
 *
__şock_id
)

1131 
__THROW
 
	`__nÚnuÎ
 ((2));

1146 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1147 (*
__·»Á
) (),

1148 (*
__chd
è()è
__THROW
;

1151 #ifdeà
__USE_EXTERN_INLINES


1153 
__ex‹º_šlše
 

1154 
	`__NTH
 (
	$±h»ad_equ®
 (
±h»ad_t
 
__th»ad1
,…th»ad_ˆ
__th»ad2
))

1156  
__th»ad1
 =ğ
__th»ad2
;

1157 
	}
}

1160 
	g__END_DECLS


	@/usr/include/readline/history.h

22 #iâdeà
_HISTORY_H_


23 
	#_HISTORY_H_


	)

25 #ifdeà
__ılu¥lus


29 
	~<time.h
>

31 #ià
defšed
 
READLINE_LIBRARY


32 
	~"¾¡dc.h
"

33 
	~"¾ty³defs.h
"

35 
	~<¡dio.h
>

36 
	~<»adlše/¾¡dc.h
>

37 
	~<»adlše/¾ty³defs.h
>

40 #ifdeà
__STDC__


41 *
	thi¡d©a_t
;

43 *
	thi¡d©a_t
;

47 
	s_hi¡_’Œy
 {

48 *
lše
;

49 *
time¡amp
;

50 
hi¡d©a_t
 
d©a
;

51 } 
	tHIST_ENTRY
;

54 
	#HISTENT_BYTES
(
hs
è(
	`¡¾’
 ((hs)->
lše
è+ sŒËÀ((hs)->
time¡amp
))

	)

57 
	s_hi¡_¡©e
 {

58 
HIST_ENTRY
 **
’Œ›s
;

59 
off£t
;

60 
Ëngth
;

61 
size
;

62 
æags
;

63 } 
	tHISTORY_STATE
;

66 
	#HS_STIFLED
 0x01

	)

72 
usšg_hi¡Üy
 
PARAMS
(());

75 
HISTORY_STATE
 *
hi¡Üy_g‘_hi¡Üy_¡©e
 
PARAMS
(());

78 
hi¡Üy_£t_hi¡Üy_¡©e
 
PARAMS
((
HISTORY_STATE
 *));

84 
add_hi¡Üy
 
PARAMS
((const *));

88 
add_hi¡Üy_time
 
PARAMS
((const *));

93 
HIST_ENTRY
 *
»move_hi¡Üy
 
PARAMS
(());

97 
HIST_ENTRY
 *
®loc_hi¡Üy_’Œy
 
PARAMS
((*, *));

100 
HIST_ENTRY
 *
cİy_hi¡Üy_’Œy
 
PARAMS
((HIST_ENTRY *));

104 
hi¡d©a_t
 
ä“_hi¡Üy_’Œy
 
PARAMS
((
HIST_ENTRY
 *));

109 
HIST_ENTRY
 *
»¶aû_hi¡Üy_’Œy
 
PARAMS
((, cÚ¡ *, 
hi¡d©a_t
));

112 
ş—r_hi¡Üy
 
PARAMS
(());

115 
¡iæe_hi¡Üy
 
PARAMS
(());

120 
un¡iæe_hi¡Üy
 
PARAMS
(());

123 
hi¡Üy_is_¡iæed
 
PARAMS
(());

130 
HIST_ENTRY
 **
hi¡Üy_li¡
 
PARAMS
(());

134 
wh”e_hi¡Üy
 
PARAMS
(());

138 
HIST_ENTRY
 *
cu¼’t_hi¡Üy
 
PARAMS
(());

142 
HIST_ENTRY
 *
hi¡Üy_g‘
 
PARAMS
(());

146 
time_t
 
hi¡Üy_g‘_time
 
PARAMS
((
HIST_ENTRY
 *));

150 
hi¡Üy_tÙ®_by‹s
 
PARAMS
(());

155 
hi¡Üy_£t_pos
 
PARAMS
(());

160 
HIST_ENTRY
 *
´evious_hi¡Üy
 
PARAMS
(());

165 
HIST_ENTRY
 *
Ãxt_hi¡Üy
 
PARAMS
(());

175 
hi¡Üy_£¬ch
 
PARAMS
((const *, ));

180 
hi¡Üy_£¬ch_´efix
 
PARAMS
((const *, ));

187 
hi¡Üy_£¬ch_pos
 
PARAMS
((const *, , ));

194 
»ad_hi¡Üy
 
PARAMS
((const *));

201 
»ad_hi¡Üy_¿nge
 
PARAMS
((const *, , ));

206 
wr™e_hi¡Üy
 
PARAMS
((const *));

210 
­³nd_hi¡Üy
 
PARAMS
((, const *));

213 
hi¡Üy_Œunÿ‹_fe
 
PARAMS
((const *, ));

229 
hi¡Üy_ex·nd
 
PARAMS
((*, **));

234 *
hi¡Üy_¬g_exŒaù
 
PARAMS
((, , const *));

242 *
g‘_hi¡Üy_ev’t
 
PARAMS
((const *, *, ));

246 **
hi¡Üy_tok’ize
 
PARAMS
((const *));

249 
hi¡Üy_ba£
;

250 
hi¡Üy_Ëngth
;

251 
hi¡Üy_max_’Œ›s
;

252 
hi¡Üy_off£t
;

254 
hi¡Üy_lšes_»ad_äom_fe
;

255 
hi¡Üy_lšes_wr™‹n_to_fe
;

257 
hi¡Üy_ex·nsiÚ_ch¬
;

258 
hi¡Üy_sub¡_ch¬
;

259 *
hi¡Üy_wÜd_d–im™”s
;

260 
hi¡Üy_comm’t_ch¬
;

261 *
hi¡Üy_no_ex·nd_ch¬s
;

262 *
hi¡Üy_£¬ch_d–im™”_ch¬s
;

263 
hi¡Üy_quÙes_šhib™_ex·nsiÚ
;

265 
hi¡Üy_wr™e_time¡amps
;

268 
hi¡Üy_muÉše_’Œ›s
;

269 
hi¡Üy_fe_v”siÚ
;

272 
max_šput_hi¡Üy
;

277 
¾_lšebuf_func_t
 *
hi¡Üy_šhib™_ex·nsiÚ_funùiÚ
;

279 #ifdeà
__ılu¥lus


	@/usr/include/readline/readline.h

22 #ià!
defšed
 (
_READLINE_H_
)

23 
	#_READLINE_H_


	)

25 #ifdeà
__ılu¥lus


29 #ià
defšed
 (
READLINE_LIBRARY
)

30 
	~"¾¡dc.h
"

31 
	~"¾ty³defs.h
"

32 
	~"keym­s.h
"

33 
	~"tde.h
"

35 
	~<¡dio.h
>

36 
	~<»adlše/¾¡dc.h
>

37 
	~<»adlše/¾ty³defs.h
>

38 
	~<»adlše/keym­s.h
>

39 
	~<»adlše/tde.h
>

43 
	#RL_READLINE_VERSION
 0x0700

	)

44 
	#RL_VERSION_MAJOR
 7

	)

45 
	#RL_VERSION_MINOR
 0

	)

55 
	eundo_code
 { 
UNDO_DELETE
, 
UNDO_INSERT
, 
UNDO_BEGIN
, 
UNDO_END
 };

58 
	sundo_li¡
 {

59 
undo_li¡
 *
Ãxt
;

60 
¡¬t
, 
’d
;

61 *
‹xt
;

62 
undo_code
 
wh©
;

63 } 
	tUNDO_LIST
;

66 
UNDO_LIST
 *
¾_undo_li¡
;

69 
	s_funm­
 {

70 cÚ¡ *
	gÇme
;

71 
¾_commªd_func_t
 *
	gfunùiÚ
;

72 } 
	tFUNMAP
;

74 
FUNMAP
 **
funm­
;

83 
¾_dig™_¬gum’t
 
PARAMS
((, ));

84 
¾_univ”§l_¬gum’t
 
PARAMS
((, ));

87 
¾_fÜw¬d_by‹
 
PARAMS
((, ));

88 
¾_fÜw¬d_ch¬
 
PARAMS
((, ));

89 
¾_fÜw¬d
 
PARAMS
((, ));

90 
¾_backw¬d_by‹
 
PARAMS
((, ));

91 
¾_backw¬d_ch¬
 
PARAMS
((, ));

92 
¾_backw¬d
 
PARAMS
((, ));

93 
¾_beg_of_lše
 
PARAMS
((, ));

94 
¾_’d_of_lše
 
PARAMS
((, ));

95 
¾_fÜw¬d_wÜd
 
PARAMS
((, ));

96 
¾_backw¬d_wÜd
 
PARAMS
((, ));

97 
¾_»äesh_lše
 
PARAMS
((, ));

98 
¾_ş—r_sü“n
 
PARAMS
((, ));

99 
¾_sk_csi_£qu’û
 
PARAMS
((, ));

100 
¾_¬row_keys
 
PARAMS
((, ));

103 
¾_š£¹
 
PARAMS
((, ));

104 
¾_quÙed_š£¹
 
PARAMS
((, ));

105 
¾_b_š£¹
 
PARAMS
((, ));

106 
¾_Ãwlše
 
PARAMS
((, ));

107 
¾_do_low”ÿ£_v”siÚ
 
PARAMS
((, ));

108 
¾_rubout
 
PARAMS
((, ));

109 
¾_d–‘e
 
PARAMS
((, ));

110 
¾_rubout_Ü_d–‘e
 
PARAMS
((, ));

111 
¾_d–‘e_hÜizÚl_¥aû
 
PARAMS
((, ));

112 
¾_d–‘e_Ü_show_com¶‘iÚs
 
PARAMS
((, ));

113 
¾_š£¹_comm’t
 
PARAMS
((, ));

116 
¾_upÿ£_wÜd
 
PARAMS
((, ));

117 
¾_downÿ£_wÜd
 
PARAMS
((, ));

118 
¾_ÿp™®ize_wÜd
 
PARAMS
((, ));

121 
¾_Œª¥o£_wÜds
 
PARAMS
((, ));

122 
¾_Œª¥o£_ch¬s
 
PARAMS
((, ));

125 
¾_ch¬_£¬ch
 
PARAMS
((, ));

126 
¾_backw¬d_ch¬_£¬ch
 
PARAMS
((, ));

129 
¾_begšnšg_of_hi¡Üy
 
PARAMS
((, ));

130 
¾_’d_of_hi¡Üy
 
PARAMS
((, ));

131 
¾_g‘_Ãxt_hi¡Üy
 
PARAMS
((, ));

132 
¾_g‘_´evious_hi¡Üy
 
PARAMS
((, ));

135 
¾_£t_m¬k
 
PARAMS
((, ));

136 
¾_exchªge_pošt_ªd_m¬k
 
PARAMS
((, ));

139 
¾_vi_ed™šg_mode
 
PARAMS
((, ));

140 
¾_emacs_ed™šg_mode
 
PARAMS
((, ));

143 
¾_ov”wr™e_mode
 
PARAMS
((, ));

146 
¾_»_»ad_š™_fe
 
PARAMS
((, ));

147 
¾_dump_funùiÚs
 
PARAMS
((, ));

148 
¾_dump_maüos
 
PARAMS
((, ));

149 
¾_dump_v¬ŸbËs
 
PARAMS
((, ));

152 
¾_com¶‘e
 
PARAMS
((, ));

153 
¾_possibË_com¶‘iÚs
 
PARAMS
((, ));

154 
¾_š£¹_com¶‘iÚs
 
PARAMS
((, ));

155 
¾_Şd_m’u_com¶‘e
 
PARAMS
((, ));

156 
¾_m’u_com¶‘e
 
PARAMS
((, ));

157 
¾_backw¬d_m’u_com¶‘e
 
PARAMS
((, ));

160 
¾_kl_wÜd
 
PARAMS
((, ));

161 
¾_backw¬d_kl_wÜd
 
PARAMS
((, ));

162 
¾_kl_lše
 
PARAMS
((, ));

163 
¾_backw¬d_kl_lše
 
PARAMS
((, ));

164 
¾_kl_fuÎ_lše
 
PARAMS
((, ));

165 
¾_unix_wÜd_rubout
 
PARAMS
((, ));

166 
¾_unix_f’ame_rubout
 
PARAMS
((, ));

167 
¾_unix_lše_disÿrd
 
PARAMS
((, ));

168 
¾_cİy_»giÚ_to_kl
 
PARAMS
((, ));

169 
¾_kl_»giÚ
 
PARAMS
((, ));

170 
¾_cİy_fÜw¬d_wÜd
 
PARAMS
((, ));

171 
¾_cİy_backw¬d_wÜd
 
PARAMS
((, ));

172 
¾_yªk
 
PARAMS
((, ));

173 
¾_yªk_pİ
 
PARAMS
((, ));

174 
¾_yªk_Áh_¬g
 
PARAMS
((, ));

175 
¾_yªk_Ï¡_¬g
 
PARAMS
((, ));

176 
¾_b¿ck‘ed_·¡e_begš
 
PARAMS
((, ));

178 #ià
defšed
 (
_WIN32
)

179 
¾_·¡e_äom_şbßrd
 
PARAMS
((, ));

183 
¾_»v”£_£¬ch_hi¡Üy
 
PARAMS
((, ));

184 
¾_fÜw¬d_£¬ch_hi¡Üy
 
PARAMS
((, ));

187 
¾_¡¬t_kbd_maüo
 
PARAMS
((, ));

188 
¾_’d_kbd_maüo
 
PARAMS
((, ));

189 
¾_ÿÎ_Ï¡_kbd_maüo
 
PARAMS
((, ));

190 
¾_´št_Ï¡_kbd_maüo
 
PARAMS
((, ));

193 
¾_»v”t_lše
 
PARAMS
((, ));

194 
¾_undo_commªd
 
PARAMS
((, ));

197 
¾_tde_ex·nd
 
PARAMS
((, ));

200 
¾_»¡¬t_ouut
 
PARAMS
((, ));

201 
¾_¡İ_ouut
 
PARAMS
((, ));

204 
¾_abÜt
 
PARAMS
((, ));

205 
¾_‰y_¡©us
 
PARAMS
((, ));

208 
¾_hi¡Üy_£¬ch_fÜw¬d
 
PARAMS
((, ));

209 
¾_hi¡Üy_£¬ch_backw¬d
 
PARAMS
((, ));

210 
¾_hi¡Üy_sub¡r_£¬ch_fÜw¬d
 
PARAMS
((, ));

211 
¾_hi¡Üy_sub¡r_£¬ch_backw¬d
 
PARAMS
((, ));

212 
¾_nÚšc_fÜw¬d_£¬ch
 
PARAMS
((, ));

213 
¾_nÚšc_»v”£_£¬ch
 
PARAMS
((, ));

214 
¾_nÚšc_fÜw¬d_£¬ch_agaš
 
PARAMS
((, ));

215 
¾_nÚšc_»v”£_£¬ch_agaš
 
PARAMS
((, ));

218 
¾_š£¹_şo£
 
PARAMS
((, ));

221 
¾_ÿÎback_hªdËr_š¡®l
 
PARAMS
((cÚ¡ *, 
¾_vıfunc_t
 *));

222 
¾_ÿÎback_»ad_ch¬
 
PARAMS
(());

223 
¾_ÿÎback_hªdËr_»move
 
PARAMS
(());

224 
¾_ÿÎback_sigş—nup
 
PARAMS
(());

228 
¾_vi_»do
 
PARAMS
((, ));

229 
¾_vi_undo
 
PARAMS
((, ));

230 
¾_vi_yªk_¬g
 
PARAMS
((, ));

231 
¾_vi_ãtch_hi¡Üy
 
PARAMS
((, ));

232 
¾_vi_£¬ch_agaš
 
PARAMS
((, ));

233 
¾_vi_£¬ch
 
PARAMS
((, ));

234 
¾_vi_com¶‘e
 
PARAMS
((, ));

235 
¾_vi_tde_ex·nd
 
PARAMS
((, ));

236 
¾_vi_´ev_wÜd
 
PARAMS
((, ));

237 
¾_vi_Ãxt_wÜd
 
PARAMS
((, ));

238 
¾_vi_’d_wÜd
 
PARAMS
((, ));

239 
¾_vi_š£¹_beg
 
PARAMS
((, ));

240 
¾_vi_­³nd_mode
 
PARAMS
((, ));

241 
¾_vi_­³nd_eŞ
 
PARAMS
((, ));

242 
¾_vi_eof_maybe
 
PARAMS
((, ));

243 
¾_vi_š£¹iÚ_mode
 
PARAMS
((, ));

244 
¾_vi_š£¹_mode
 
PARAMS
((, ));

245 
¾_vi_movem’t_mode
 
PARAMS
((, ));

246 
¾_vi_¬g_dig™
 
PARAMS
((, ));

247 
¾_vi_chªge_ÿ£
 
PARAMS
((, ));

248 
¾_vi_put
 
PARAMS
((, ));

249 
¾_vi_cŞumn
 
PARAMS
((, ));

250 
¾_vi_d–‘e_to
 
PARAMS
((, ));

251 
¾_vi_chªge_to
 
PARAMS
((, ));

252 
¾_vi_yªk_to
 
PARAMS
((, ));

253 
¾_vi_yªk_pİ
 
PARAMS
((, ));

254 
¾_vi_rubout
 
PARAMS
((, ));

255 
¾_vi_d–‘e
 
PARAMS
((, ));

256 
¾_vi_back_to_šd’t
 
PARAMS
((, ));

257 
¾_vi_unix_wÜd_rubout
 
PARAMS
((, ));

258 
¾_vi_fœ¡_´št
 
PARAMS
((, ));

259 
¾_vi_ch¬_£¬ch
 
PARAMS
((, ));

260 
¾_vi_m©ch
 
PARAMS
((, ));

261 
¾_vi_chªge_ch¬
 
PARAMS
((, ));

262 
¾_vi_sub¡
 
PARAMS
((, ));

263 
¾_vi_ov”¡rike
 
PARAMS
((, ));

264 
¾_vi_ov”¡rike_d–‘e
 
PARAMS
((, ));

265 
¾_vi_»¶aû
 
PARAMS
((, ));

266 
¾_vi_£t_m¬k
 
PARAMS
((, ));

267 
¾_vi_gÙo_m¬k
 
PARAMS
((, ));

270 
¾_vi_check
 
PARAMS
(());

271 
¾_vi_domove
 
PARAMS
((, *));

272 
¾_vi_b¿ckty³
 
PARAMS
(());

274 
¾_vi_¡¬t_š£¹šg
 
PARAMS
((, , ));

277 
¾_vi_fWÜd
 
PARAMS
((, ));

278 
¾_vi_bWÜd
 
PARAMS
((, ));

279 
¾_vi_eWÜd
 
PARAMS
((, ));

280 
¾_vi_fwÜd
 
PARAMS
((, ));

281 
¾_vi_bwÜd
 
PARAMS
((, ));

282 
¾_vi_ewÜd
 
PARAMS
((, ));

292 *
»adlše
 
PARAMS
((const *));

294 
¾_£t_´om±
 
PARAMS
((const *));

295 
¾_ex·nd_´om±
 
PARAMS
((*));

297 
¾_š™Ÿlize
 
PARAMS
(());

300 
¾_disÿrd_¬gum’t
 
PARAMS
(());

303 
¾_add_defun
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *, ));

304 
¾_bšd_key
 
PARAMS
((, 
¾_commªd_func_t
 *));

305 
¾_bšd_key_š_m­
 
PARAMS
((, 
¾_commªd_func_t
 *, 
Keym­
));

306 
¾_unbšd_key
 
PARAMS
(());

307 
¾_unbšd_key_š_m­
 
PARAMS
((, 
Keym­
));

308 
¾_bšd_key_if_unbound
 
PARAMS
((, 
¾_commªd_func_t
 *));

309 
¾_bšd_key_if_unbound_š_m­
 
PARAMS
((, 
¾_commªd_func_t
 *, 
Keym­
));

310 
¾_unbšd_funùiÚ_š_m­
 
PARAMS
((
¾_commªd_func_t
 *, 
Keym­
));

311 
¾_unbšd_commªd_š_m­
 
PARAMS
((cÚ¡ *, 
Keym­
));

312 
¾_bšd_key£q
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *));

313 
¾_bšd_key£q_š_m­
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *, 
Keym­
));

314 
¾_bšd_key£q_if_unbound
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *));

315 
¾_bšd_key£q_if_unbound_š_m­
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *, 
Keym­
));

316 
¾_g’”ic_bšd
 
PARAMS
((, cÚ¡ *, *, 
Keym­
));

318 *
¾_v¬ŸbË_v®ue
 
PARAMS
((const *));

319 
¾_v¬ŸbË_bšd
 
PARAMS
((const *, const *));

322 
¾_£t_key
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *, 
Keym­
));

325 
¾_maüo_bšd
 
PARAMS
((cÚ¡ *, cÚ¡ *, 
Keym­
));

328 
¾_Œª¦©e_key£q
 
PARAMS
((const *, *, *));

329 *
¾_uÁ¿n¦©e_key£q
 
PARAMS
(());

331 
¾_commªd_func_t
 *
¾_Çmed_funùiÚ
 
PARAMS
((const *));

332 
¾_commªd_func_t
 *
¾_funùiÚ_of_key£q
 
PARAMS
((cÚ¡ *, 
Keym­
, *));

334 
¾_li¡_funm­_Çmes
 
PARAMS
(());

335 **
¾_švokšg_key£qs_š_m­
 
PARAMS
((
¾_commªd_func_t
 *, 
Keym­
));

336 **
¾_švokšg_key£qs
 
PARAMS
((
¾_commªd_func_t
 *));

338 
¾_funùiÚ_dum³r
 
PARAMS
(());

339 
¾_maüo_dum³r
 
PARAMS
(());

340 
¾_v¬ŸbË_dum³r
 
PARAMS
(());

342 
¾_»ad_š™_fe
 
PARAMS
((const *));

343 
¾_·r£_ªd_bšd
 
PARAMS
((*));

346 
Keym­
 
¾_make_b¬e_keym­
 
PARAMS
(());

347 
Keym­
 
¾_cİy_keym­
 
PARAMS
((Keymap));

348 
Keym­
 
¾_make_keym­
 
PARAMS
(());

349 
¾_disÿrd_keym­
 
PARAMS
((
Keym­
));

350 
¾_ä“_keym­
 
PARAMS
((
Keym­
));

352 
Keym­
 
¾_g‘_keym­_by_Çme
 
PARAMS
((const *));

353 *
¾_g‘_keym­_Çme
 
PARAMS
((
Keym­
));

354 
¾_£t_keym­
 
PARAMS
((
Keym­
));

355 
Keym­
 
¾_g‘_keym­
 
PARAMS
(());

357 
¾_£t_keym­_äom_ed™_mode
 
PARAMS
(());

358 *
¾_g‘_keym­_Çme_äom_ed™_mode
 
PARAMS
(());

361 
¾_add_funm­_’Œy
 
PARAMS
((cÚ¡ *, 
¾_commªd_func_t
 *));

362 cÚ¡ **
¾_funm­_Çmes
 
PARAMS
(());

365 
¾_š™Ÿlize_funm­
 
PARAMS
(());

368 
¾_push_maüo_šput
 
PARAMS
((*));

371 
¾_add_undo
 
PARAMS
((
undo_code
, , , *));

372 
¾_ä“_undo_li¡
 
PARAMS
(());

373 
¾_do_undo
 
PARAMS
(());

374 
¾_begš_undo_group
 
PARAMS
(());

375 
¾_’d_undo_group
 
PARAMS
(());

376 
¾_modifyšg
 
PARAMS
((, ));

379 
¾_»di¥Ïy
 
PARAMS
(());

380 
¾_Ú_Ãw_lše
 
PARAMS
(());

381 
¾_Ú_Ãw_lše_w™h_´om±
 
PARAMS
(());

382 
¾_fÜûd_upd©e_di¥Ïy
 
PARAMS
(());

383 
¾_ş—r_visibË_lše
 
PARAMS
(());

384 
¾_ş—r_mes§ge
 
PARAMS
(());

385 
¾_»£t_lše_¡©e
 
PARAMS
(());

386 
¾_ülf
 
PARAMS
(());

388 #ià
defšed
 (
USE_VARARGS
è&& defšed (
PREFER_STDARG
)

389 
¾_mes§ge
 (cÚ¡ *, ...è
__¾_©Œibu‹__
((
__fÜm©__
 (
´štf
, 1, 2)));

391 
¾_mes§ge
 ();

394 
¾_show_ch¬
 
PARAMS
(());

397 
¾_ch¬aù”_Ën
 
PARAMS
((, ));

398 
¾_»d¿w_´om±_Ï¡_lše
 
PARAMS
(());

401 
¾_§ve_´om±
 
PARAMS
(());

402 
¾_»¡Üe_´om±
 
PARAMS
(());

405 
¾_»¶aû_lše
 
PARAMS
((const *, ));

406 
¾_š£¹_‹xt
 
PARAMS
((const *));

407 
¾_d–‘e_‹xt
 
PARAMS
((, ));

408 
¾_kl_‹xt
 
PARAMS
((, ));

409 *
¾_cİy_‹xt
 
PARAMS
((, ));

412 
¾_´•_‹rmš®
 
PARAMS
(());

413 
¾_d•»p_‹rmš®
 
PARAMS
(());

414 
¾_‰y_£t_deçuÉ_bšdšgs
 
PARAMS
((
Keym­
));

415 
¾_‰y_un£t_deçuÉ_bšdšgs
 
PARAMS
((
Keym­
));

417 
¾_»£t_‹rmš®
 
PARAMS
((const *));

418 
¾_»size_‹rmš®
 
PARAMS
(());

419 
¾_£t_sü“n_size
 
PARAMS
((, ));

420 
¾_g‘_sü“n_size
 
PARAMS
((*, *));

421 
¾_»£t_sü“n_size
 
PARAMS
(());

423 *
¾_g‘_‹rmÿp
 
PARAMS
((const *));

426 
¾_¡uff_ch¬
 
PARAMS
(());

427 
¾_execu‹_Ãxt
 
PARAMS
(());

428 
¾_ş—r_³ndšg_šput
 
PARAMS
(());

429 
¾_»ad_key
 
PARAMS
(());

430 
¾_g‘c
 
PARAMS
((
FILE
 *));

431 
¾_£t_keybßrd_šput_timeout
 
PARAMS
(());

434 
¾_ex‹nd_lše_bufãr
 
PARAMS
(());

435 
¾_dšg
 
PARAMS
(());

436 
¾_®phab‘ic
 
PARAMS
(());

437 
¾_ä“
 
PARAMS
((*));

440 
¾_£t_sigÇls
 
PARAMS
(());

441 
¾_ş—r_sigÇls
 
PARAMS
(());

442 
¾_ş—nup_aá”_sigÇl
 
PARAMS
(());

443 
¾_»£t_aá”_sigÇl
 
PARAMS
(());

444 
¾_ä“_lše_¡©e
 
PARAMS
(());

446 
¾_³ndšg_sigÇl
 
PARAMS
(());

448 
¾_echo_sigÇl_ch¬
 
PARAMS
(());

450 
¾_£t_·»n_blšk_timeout
 
PARAMS
(());

454 
¾_ş—r_hi¡Üy
 
PARAMS
(());

457 
¾_maybe_§ve_lše
 
PARAMS
(());

458 
¾_maybe_un§ve_lše
 
PARAMS
(());

459 
¾_maybe_»¶aû_lše
 
PARAMS
(());

462 
¾_com¶‘e_š‹º®
 
PARAMS
(());

463 
¾_di¥Ïy_m©ch_li¡
 
PARAMS
((**, , ));

465 **
¾_com¶‘iÚ_m©ches
 
PARAMS
((cÚ¡ *, 
¾_com³Áry_func_t
 *));

466 *
¾_u£ºame_com¶‘iÚ_funùiÚ
 
PARAMS
((const *, ));

467 *
¾_f’ame_com¶‘iÚ_funùiÚ
 
PARAMS
((const *, ));

469 
¾_com¶‘iÚ_mode
 
PARAMS
((
¾_commªd_func_t
 *));

473 
ä“_undo_li¡
 
PARAMS
(());

474 
maybe_§ve_lše
 
PARAMS
(());

475 
maybe_un§ve_lše
 
PARAMS
(());

476 
maybe_»¶aû_lše
 
PARAMS
(());

478 
dšg
 
PARAMS
(());

479 
®phab‘ic
 
PARAMS
(());

480 
ülf
 
PARAMS
(());

482 **
com¶‘iÚ_m©ches
 
PARAMS
((*, 
¾_com³Áry_func_t
 *));

483 *
u£ºame_com¶‘iÚ_funùiÚ
 
PARAMS
((const *, ));

484 *
f’ame_com¶‘iÚ_funùiÚ
 
PARAMS
((const *, ));

494 cÚ¡ *
¾_lib¿ry_v”siÚ
;

495 
¾_»adlše_v”siÚ
;

498 
¾_gnu_»adlše_p
;

501 
¾_»adlše_¡©e
;

505 
¾_ed™šg_mode
;

509 
¾_š£¹_mode
;

513 cÚ¡ *
¾_»adlše_Çme
;

517 *
¾_´om±
;

521 *
¾_di¥Ïy_´om±
;

524 *
¾_lše_bufãr
;

527 
¾_pošt
;

528 
¾_’d
;

531 
¾_m¬k
;

535 
¾_dÚe
;

538 
¾_³ndšg_šput
;

543 
¾_di¥©chšg
;

547 
¾_ex¶ic™_¬g
;

550 
¾_num”ic_¬g
;

553 
¾_commªd_func_t
 *
¾_Ï¡_func
;

556 cÚ¡ *
¾_‹rmš®_Çme
;

559 
FILE
 *
¾_š¡»am
;

560 
FILE
 *
¾_out¡»am
;

565 
¾_´eãr_’v_wšsize
;

569 
¾_hook_func_t
 *
¾_¡¬tup_hook
;

574 
¾_hook_func_t
 *
¾_´e_šput_hook
;

578 
¾_hook_func_t
 *
¾_ev’t_hook
;

581 
¾_hook_func_t
 *
¾_sigÇl_ev’t_hook
;

585 
¾_hook_func_t
 *
¾_šput_avaabË_hook
;

589 
¾_g‘c_func_t
 *
¾_g‘c_funùiÚ
;

591 
¾_voidfunc_t
 *
¾_»di¥Ïy_funùiÚ
;

593 
¾_vštfunc_t
 *
¾_´•_‹rm_funùiÚ
;

594 
¾_voidfunc_t
 *
¾_d•»p_‹rm_funùiÚ
;

597 
Keym­
 
¾_executšg_keym­
;

598 
Keym­
 
¾_bšdšg_keym­
;

600 
¾_executšg_key
;

601 *
¾_executšg_key£q
;

602 
¾_key_£qu’û_Ëngth
;

608 
¾_”a£_em±y_lše
;

613 
¾_®»ady_´om±ed
;

617 
¾_num_ch¬s_to_»ad
;

620 *
¾_executšg_maüo
;

625 
¾_ÿtch_sigÇls
;

632 
¾_ÿtch_sigwšch
;

636 
¾_chªge_’vœÚm’t
;

642 
¾_com³Áry_func_t
 *
¾_com¶‘iÚ_’Œy_funùiÚ
;

646 
¾_com³Áry_func_t
 *
¾_m’u_com¶‘iÚ_’Œy_funùiÚ
;

654 
¾_compignÜe_func_t
 *
¾_ignÜe_some_com¶‘iÚs_funùiÚ
;

663 
¾_com¶‘iÚ_func_t
 *
¾_©‹m±ed_com¶‘iÚ_funùiÚ
;

668 cÚ¡ *
¾_basic_wÜd_b»ak_ch¬aù”s
;

673 *
¾_com¶‘”_wÜd_b»ak_ch¬aù”s
;

678 
¾_ıvfunc_t
 *
¾_com¶‘iÚ_wÜd_b»ak_hook
;

684 cÚ¡ *
¾_com¶‘”_quÙe_ch¬aù”s
;

687 cÚ¡ *
¾_basic_quÙe_ch¬aù”s
;

690 cÚ¡ *
¾_f’ame_quÙe_ch¬aù”s
;

695 cÚ¡ *
¾_¥ecŸl_´efixes
;

706 
¾_iıpfunc_t
 *
¾_dœeùÜy_com¶‘iÚ_hook
;

719 
¾_iıpfunc_t
 *
¾_dœeùÜy_»wr™e_hook
;

726 
¾_iıpfunc_t
 *
¾_f’ame_¡©_hook
;

737 
¾_dequÙe_func_t
 *
¾_f’ame_»wr™e_hook
;

740 
	#¾_symbŞic_lšk_hook
 
¾_dœeùÜy_com¶‘iÚ_hook


	)

749 
¾_compdi¥_func_t
 *
¾_com¶‘iÚ_di¥Ïy_m©ches_hook
;

754 
¾_f’ame_com¶‘iÚ_desœed
;

761 
¾_f’ame_quÙšg_desœed
;

767 
¾_quÙe_func_t
 *
¾_f’ame_quÙšg_funùiÚ
;

772 
¾_dequÙe_func_t
 *
¾_f’ame_dequÙšg_funùiÚ
;

777 
¾_lšebuf_func_t
 *
¾_ch¬_is_quÙed_p
;

781 
¾_©‹m±ed_com¶‘iÚ_ov”
;

786 
¾_com¶‘iÚ_ty³
;

789 
¾_com¶‘iÚ_švokšg_key
;

794 
¾_com¶‘iÚ_qu”y_™ems
;

798 
¾_com¶‘iÚ_­³nd_ch¬aù”
;

802 
¾_com¶‘iÚ_suµ»ss_­³nd
;

806 
¾_com¶‘iÚ_quÙe_ch¬aù”
;

810 
¾_com¶‘iÚ_found_quÙe
;

815 
¾_com¶‘iÚ_suµ»ss_quÙe
;

818 
¾_sÜt_com¶‘iÚ_m©ches
;

829 
¾_com¶‘iÚ_m¬k_symlšk_dœs
;

832 
¾_ignÜe_com¶‘iÚ_du¶iÿ‹s
;

836 
¾_šhib™_com¶‘iÚ
;

844 
¾_³rsi¡’t_sigÇl_hªdËrs
;

848 
	#READERR
 (-2)

	)

851 
	#RL_PROMPT_START_IGNORE
 '\001'

	)

852 
	#RL_PROMPT_END_IGNORE
 '\002'

	)

856 
	#NO_MATCH
 0

	)

857 
	#SINGLE_MATCH
 1

	)

858 
	#MULT_MATCH
 2

	)

861 
	#RL_STATE_NONE
 0x000000

	)

863 
	#RL_STATE_INITIALIZING
 0x0000001

	)

864 
	#RL_STATE_INITIALIZED
 0x0000002

	)

865 
	#RL_STATE_TERMPREPPED
 0x0000004

	)

866 
	#RL_STATE_READCMD
 0x0000008

	)

867 
	#RL_STATE_METANEXT
 0x0000010

	)

868 
	#RL_STATE_DISPATCHING
 0x0000020

	)

869 
	#RL_STATE_MOREINPUT
 0x0000040

	)

870 
	#RL_STATE_ISEARCH
 0x0000080

	)

871 
	#RL_STATE_NSEARCH
 0x0000100

	)

872 
	#RL_STATE_SEARCH
 0x0000200

	)

873 
	#RL_STATE_NUMERICARG
 0x0000400

	)

874 
	#RL_STATE_MACROINPUT
 0x0000800

	)

875 
	#RL_STATE_MACRODEF
 0x0001000

	)

876 
	#RL_STATE_OVERWRITE
 0x0002000

	)

877 
	#RL_STATE_COMPLETING
 0x0004000

	)

878 
	#RL_STATE_SIGHANDLER
 0x0008000

	)

879 
	#RL_STATE_UNDOING
 0x0010000

	)

880 
	#RL_STATE_INPUTPENDING
 0x0020000

	)

881 
	#RL_STATE_TTYCSAVED
 0x0040000

	)

882 
	#RL_STATE_CALLBACK
 0x0080000

	)

883 
	#RL_STATE_VIMOTION
 0x0100000

	)

884 
	#RL_STATE_MULTIKEY
 0x0200000

	)

885 
	#RL_STATE_VICMDONCE
 0x0400000

	)

886 
	#RL_STATE_CHARSEARCH
 0x0800000

	)

887 
	#RL_STATE_REDISPLAYING
 0x1000000

	)

889 
	#RL_STATE_DONE
 0x2000000

	)

891 
	#RL_SETSTATE
(
x
è(
¾_»adlše_¡©e
 |ğ(x))

	)

892 
	#RL_UNSETSTATE
(
x
è(
¾_»adlše_¡©e
 &ğ~(x))

	)

893 
	#RL_ISSTATE
(
x
è(
¾_»adlše_¡©e
 & (x))

	)

895 
	s»adlše_¡©e
 {

897 
	gpošt
;

898 
	g’d
;

899 
	gm¬k
;

900 
	gbuæ’
;

901 *
	gbufãr
;

902 
UNDO_LIST
 *
	gul
;

903 *
	g´om±
;

906 
	g¾¡©e
;

907 
	gdÚe
;

908 
Keym­
 
	gkm­
;

911 
¾_commªd_func_t
 *
	gÏ¡func
;

912 
	gšsmode
;

913 
	gedmode
;

914 *
	gk£q
;

915 
	gk£qËn
;

917 
	g³ndšgš
;

918 
FILE
 *
	gšf
;

919 
FILE
 *
	goutf
;

920 *
	gmaüo
;

923 
	gÿtchsigs
;

924 
	gÿtchsigwšch
;

929 
¾_com³Áry_func_t
 *
	g’Œyfunc
;

930 
¾_com³Áry_func_t
 *
	gm’u’Œyfunc
;

931 
¾_compignÜe_func_t
 *
	gignÜefunc
;

932 
¾_com¶‘iÚ_func_t
 *
	g©‹m±func
;

933 *
	gwÜdb»akch¬s
;

940 
	g»£rved
[64];

943 
¾_§ve_¡©e
 
PARAMS
((
»adlše_¡©e
 *));

944 
¾_»¡Üe_¡©e
 
PARAMS
((
»adlše_¡©e
 *));

946 #ifdeà
__ılu¥lus


	@/usr/include/setjmp.h

22 #iâdef 
_SETJMP_H


23 
	#_SETJMP_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/£tjmp.h
>

30 
	~<b™s/ty³s/__sig£t_t.h
>

33 
	s__jmp_buf_g


39 
__jmp_buf
 
	m__jmpbuf
;

40 
	m__mask_was_§ved
;

41 
__sig£t_t
 
	m__§ved_mask
;

45 
__jmp_buf_g
 
	tjmp_buf
[1];

49 
	$£tjmp
 (
jmp_buf
 
__’v
è
__THROWNL
;

54 
	$__sig£tjmp
 (
__jmp_buf_g
 
__’v
[1], 
__§vemask
è
__THROWNL
;

58 
	$_£tjmp
 (
__jmp_buf_g
 
__’v
[1]è
__THROWNL
;

62 
	#£tjmp
(
’v
è
	`_£tjmp
 (’v)

	)

67 
	$lÚgjmp
 (
__jmp_buf_g
 
__’v
[1], 
__v®
)

68 
__THROWNL
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

70 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


74 
	$_lÚgjmp
 (
__jmp_buf_g
 
__’v
[1], 
__v®
)

75 
__THROWNL
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

79 #ifdef 
__USE_POSIX


83 
__jmp_buf_g
 
	tsigjmp_buf
[1];

87 
	#sig£tjmp
(
’v
, 
§vemask
è
	`__sig£tjmp
 (’v, savemask)

	)

93 
	$siglÚgjmp
 (
sigjmp_buf
 
__’v
, 
__v®
)

94 
__THROWNL
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

99 #ià
__USE_FORTIFY_LEVEL
 > 0

100 
	~<b™s/£tjmp2.h
>

103 
__END_DECLS


	@/usr/include/signal.h

22 #iâdef 
_SIGNAL_H


23 
	#_SIGNAL_H


	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


29 
	~<b™s/ty³s.h
>

30 
	~<b™s/signum.h
>

32 
	~<b™s/ty³s/sig_©omic_t.h
>

34 #ià
defšed
 
__USE_POSIX


35 
	~<b™s/ty³s/sig£t_t.h
>

38 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


39 #iâdeà
__pid_t_defšed


40 
__pid_t
 
	tpid_t
;

41 
	#__pid_t_defšed


	)

43 #ifdeà
__USE_XOPEN


45 #iâdeà
__uid_t_defšed


46 
__uid_t
 
	tuid_t
;

47 
	#__uid_t_defšed


	)

51 #ifdeà
__USE_POSIX199309


53 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

56 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_XOPEN_EXTENDED


57 
	~<b™s/ty³s/sigšfo_t.h
>

58 
	~<b™s/sigšfo-cÚ¡s.h
>

61 #ifdeà
__USE_POSIX199309


62 
	~<b™s/ty³s/sigev’t_t.h
>

63 
	~<b™s/sigev’t-cÚ¡s.h
>

68 (*
	t__sighªdËr_t
) ();

73 
__sighªdËr_t
 
	$__sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

74 
__THROW
;

75 #ifdeà
__USE_GNU


76 
__sighªdËr_t
 
	$sysv_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

77 
__THROW
;

83 #ifdeà
__USE_MISC


84 
__sighªdËr_t
 
	$sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

85 
__THROW
;

88 #ifdeà
__REDIRECT_NTH


89 
__sighªdËr_t
 
	`__REDIRECT_NTH
 (
sigÇl
,

90 (
__sig
, 
__sighªdËr_t
 
__hªdËr
),

91 
__sysv_sigÇl
);

93 
	#sigÇl
 
__sysv_sigÇl


	)

97 #ià
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8


100 
__sighªdËr_t
 
	$bsd_sigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

101 
__THROW
;

107 #ifdeà
__USE_POSIX


108 
	$kl
 (
__pid_t
 
__pid
, 
__sig
è
__THROW
;

111 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


115 
	$kÍg
 (
__pid_t
 
__pg½
, 
__sig
è
__THROW
;

119 
	$¿i£
 (
__sig
è
__THROW
;

121 #ifdeà
__USE_MISC


123 
__sighªdËr_t
 
	$ssigÇl
 (
__sig
, 
__sighªdËr_t
 
__hªdËr
)

124 
__THROW
;

125 
	$gsigÇl
 (
__sig
è
__THROW
;

128 #ifdeà
__USE_XOPEN2K8


130 
	`psigÇl
 (
__sig
, cÚ¡ *
__s
);

133 
	`psigšfo
 (cÚ¡ 
sigšfo_t
 *
__pšfo
, cÚ¡ *
__s
);

145 #ifdeà
__USE_XOPEN_EXTENDED


146 #ifdeà
__GNUC__


147 
	$sig·u£
 (
__sig
è
	`__asm__
 ("__xpg_sigpause");

149 
	`__sig·u£
 (
__sig_Ü_mask
, 
__is_sig
);

151 
	#sig·u£
(
sig
è
	`__sig·u£
 ((sig), 1)

	)

156 #ifdeà
__USE_MISC


163 
	#sigmask
(
sig
è(()(1u << ((sigè- 1)))

	)

166 
	$sigblock
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

169 
	$sig£tmask
 (
__mask
è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

172 
	$sigg‘mask
 (è
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

176 #ifdeà
__USE_MISC


177 
	#NSIG
 
_NSIG


	)

180 #ifdeà
__USE_GNU


181 
__sighªdËr_t
 
	tsighªdËr_t
;

185 #ifdeà
__USE_MISC


186 
__sighªdËr_t
 
	tsig_t
;

189 #ifdeà
__USE_POSIX


192 
	$sigem±y£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

195 
	$sigfl£t
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

198 
	$sigadd£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

201 
	$sigd–£t
 (
sig£t_t
 *
__£t
, 
__signo
è
__THROW
 
	`__nÚnuÎ
 ((1));

204 
	$sigismemb”
 (cÚ¡ 
sig£t_t
 *
__£t
, 
__signo
)

205 
__THROW
 
	`__nÚnuÎ
 ((1));

207 #ifdeà
__USE_GNU


209 
	$sigi£m±y£t
 (cÚ¡ 
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

212 
	$sigªd£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

213 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

216 
	$sigÜ£t
 (
sig£t_t
 *
__£t
, cÚ¡ sig£t_ˆ*
__Ëá
,

217 cÚ¡ 
sig£t_t
 *
__right
è
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3));

222 
	~<b™s/sigaùiÚ.h
>

225 
	$sig´ocmask
 (
__how
, cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

226 
sig£t_t
 *
__»¡riù
 
__o£t
è
__THROW
;

233 
	$sigsu¥’d
 (cÚ¡ 
sig£t_t
 *
__£t
è
	`__nÚnuÎ
 ((1));

236 
	$sigaùiÚ
 (
__sig
, cÚ¡ 
sigaùiÚ
 *
__»¡riù
 
__aù
,

237 
sigaùiÚ
 *
__»¡riù
 
__ßù
è
__THROW
;

240 
	$sig³ndšg
 (
sig£t_t
 *
__£t
è
__THROW
 
	`__nÚnuÎ
 ((1));

243 #ifdeà
__USE_POSIX199506


248 
	$sigwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
, *__»¡riù 
__sig
)

249 
	`__nÚnuÎ
 ((1, 2));

252 #ifdeà
__USE_POSIX199309


257 
	$sigwa™šfo
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

258 
sigšfo_t
 *
__»¡riù
 
__šfo
è
	`__nÚnuÎ
 ((1));

265 
	$sigtimedwa™
 (cÚ¡ 
sig£t_t
 *
__»¡riù
 
__£t
,

266 
sigšfo_t
 *
__»¡riù
 
__šfo
,

267 cÚ¡ 
time¥ec
 *
__»¡riù
 
__timeout
)

268 
	`__nÚnuÎ
 ((1));

272 
	$sigqueue
 (
__pid_t
 
__pid
, 
__sig
, cÚ¡ 
sigv®
 
__v®
)

273 
__THROW
;

278 #ifdeà
__USE_MISC


282 cÚ¡ *cÚ¡ 
_sys_sigli¡
[
_NSIG
];

283 cÚ¡ *cÚ¡ 
sys_sigli¡
[
_NSIG
];

287 
	~<b™s/sigcÚ‹xt.h
>

290 
	$sig»tuº
 (
sigcÚ‹xt
 *
__sı
è
__THROW
;

295 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


296 
	#__Ãed_size_t


	)

297 
	~<¡ddef.h
>

299 
	~<b™s/ty³s/¡ack_t.h
>

300 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


302 
	~<sys/ucÚ‹xt.h
>

306 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_MISC


310 
	$sigš‹¼u±
 (
__sig
, 
__š‹¼u±
è
__THROW
;

312 
	~<b™s/sig¡ack.h
>

313 
	~<b™s/ss_æags.h
>

317 
	$sig®t¡ack
 (cÚ¡ 
¡ack_t
 *
__»¡riù
 
__ss
,

318 
¡ack_t
 *
__»¡riù
 
__oss
è
__THROW
;

321 #ià((
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

322 || 
defšed
 
__USE_MISC
)

323 
	~<b™s/ty³s/¡ruù_sig¡ack.h
>

326 #ià((
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

327 || 
defšed
 
__USE_MISC
)

331 
	$sig¡ack
 (
sig¡ack
 *
__ss
, sig¡ack *
__oss
)

332 
__THROW
 
__©Œibu‹_d•»ÿ‹d__
;

335 #ifdeà
__USE_XOPEN_EXTENDED


339 
	$sighŞd
 (
__sig
è
__THROW
;

342 
	$sig»l£
 (
__sig
è
__THROW
;

345 
	$sigignÜe
 (
__sig
è
__THROW
;

348 
__sighªdËr_t
 
	$sig£t
 (
__sig
, 
__sighªdËr_t
 
__di¥
è
__THROW
;

351 #ià
defšed
 
__USE_POSIX199506
 || defšed 
__USE_UNIX98


354 
	~<b™s/±h»adty³s.h
>

355 
	~<b™s/sigth»ad.h
>

362 
	$__libc_cu¼’t_sig¹mš
 (è
__THROW
;

364 
	$__libc_cu¼’t_sig¹max
 (è
__THROW
;

366 
	#SIGRTMIN
 (
	`__libc_cu¼’t_sig¹mš
 ())

	)

367 
	#SIGRTMAX
 (
	`__libc_cu¼’t_sig¹max
 ())

	)

369 
__END_DECLS


	@/usr/include/stdint.h

22 #iâdeà
_STDINT_H


23 
	#_STDINT_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

27 
	~<b™s/ty³s.h
>

28 
	~<b™s/wch¬.h
>

29 
	~<b™s/wÜdsize.h
>

34 
	~<b™s/¡dšt-šŠ.h
>

37 
	~<b™s/¡dšt-ušŠ.h
>

43 sigÃd 
	tšt_Ëa¡8_t
;

44 
	tšt_Ëa¡16_t
;

45 
	tšt_Ëa¡32_t
;

46 #ià
__WORDSIZE
 == 64

47 
	tšt_Ëa¡64_t
;

49 
__ex‹nsiÚ__


50 
	tšt_Ëa¡64_t
;

54 
	tušt_Ëa¡8_t
;

55 
	tušt_Ëa¡16_t
;

56 
	tušt_Ëa¡32_t
;

57 #ià
__WORDSIZE
 == 64

58 
	tušt_Ëa¡64_t
;

60 
__ex‹nsiÚ__


61 
	tušt_Ëa¡64_t
;

68 sigÃd 
	tšt_ç¡8_t
;

69 #ià
__WORDSIZE
 == 64

70 
	tšt_ç¡16_t
;

71 
	tšt_ç¡32_t
;

72 
	tšt_ç¡64_t
;

74 
	tšt_ç¡16_t
;

75 
	tšt_ç¡32_t
;

76 
__ex‹nsiÚ__


77 
	tšt_ç¡64_t
;

81 
	tušt_ç¡8_t
;

82 #ià
__WORDSIZE
 == 64

83 
	tušt_ç¡16_t
;

84 
	tušt_ç¡32_t
;

85 
	tušt_ç¡64_t
;

87 
	tušt_ç¡16_t
;

88 
	tušt_ç¡32_t
;

89 
__ex‹nsiÚ__


90 
	tušt_ç¡64_t
;

95 #ià
__WORDSIZE
 == 64

96 #iâdeà
__šŒ_t_defšed


97 
	tšŒ_t
;

98 
	#__šŒ_t_defšed


	)

100 
	tušŒ_t
;

102 #iâdeà
__šŒ_t_defšed


103 
	tšŒ_t
;

104 
	#__šŒ_t_defšed


	)

106 
	tušŒ_t
;

111 
__štmax_t
 
	tštmax_t
;

112 
__uštmax_t
 
	tuštmax_t
;

115 #ià
__WORDSIZE
 == 64

116 
	#__INT64_C
(
c
èø## 
L


	)

117 
	#__UINT64_C
(
c
èø## 
UL


	)

119 
	#__INT64_C
(
c
èø## 
LL


	)

120 
	#__UINT64_C
(
c
èø## 
ULL


	)

126 
	#INT8_MIN
 (-128)

	)

127 
	#INT16_MIN
 (-32767-1)

	)

128 
	#INT32_MIN
 (-2147483647-1)

	)

129 
	#INT64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

131 
	#INT8_MAX
 (127)

	)

132 
	#INT16_MAX
 (32767)

	)

133 
	#INT32_MAX
 (2147483647)

	)

134 
	#INT64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

137 
	#UINT8_MAX
 (255)

	)

138 
	#UINT16_MAX
 (65535)

	)

139 
	#UINT32_MAX
 (4294967295U)

	)

140 
	#UINT64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

144 
	#INT_LEAST8_MIN
 (-128)

	)

145 
	#INT_LEAST16_MIN
 (-32767-1)

	)

146 
	#INT_LEAST32_MIN
 (-2147483647-1)

	)

147 
	#INT_LEAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

149 
	#INT_LEAST8_MAX
 (127)

	)

150 
	#INT_LEAST16_MAX
 (32767)

	)

151 
	#INT_LEAST32_MAX
 (2147483647)

	)

152 
	#INT_LEAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

155 
	#UINT_LEAST8_MAX
 (255)

	)

156 
	#UINT_LEAST16_MAX
 (65535)

	)

157 
	#UINT_LEAST32_MAX
 (4294967295U)

	)

158 
	#UINT_LEAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

162 
	#INT_FAST8_MIN
 (-128)

	)

163 #ià
__WORDSIZE
 == 64

164 
	#INT_FAST16_MIN
 (-9223372036854775807L-1)

	)

165 
	#INT_FAST32_MIN
 (-9223372036854775807L-1)

	)

167 
	#INT_FAST16_MIN
 (-2147483647-1)

	)

168 
	#INT_FAST32_MIN
 (-2147483647-1)

	)

170 
	#INT_FAST64_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

172 
	#INT_FAST8_MAX
 (127)

	)

173 #ià
__WORDSIZE
 == 64

174 
	#INT_FAST16_MAX
 (9223372036854775807L)

	)

175 
	#INT_FAST32_MAX
 (9223372036854775807L)

	)

177 
	#INT_FAST16_MAX
 (2147483647)

	)

178 
	#INT_FAST32_MAX
 (2147483647)

	)

180 
	#INT_FAST64_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

183 
	#UINT_FAST8_MAX
 (255)

	)

184 #ià
__WORDSIZE
 == 64

185 
	#UINT_FAST16_MAX
 (18446744073709551615UL)

	)

186 
	#UINT_FAST32_MAX
 (18446744073709551615UL)

	)

188 
	#UINT_FAST16_MAX
 (4294967295U)

	)

189 
	#UINT_FAST32_MAX
 (4294967295U)

	)

191 
	#UINT_FAST64_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

195 #ià
__WORDSIZE
 == 64

196 
	#INTPTR_MIN
 (-9223372036854775807L-1)

	)

197 
	#INTPTR_MAX
 (9223372036854775807L)

	)

198 
	#UINTPTR_MAX
 (18446744073709551615UL)

	)

200 
	#INTPTR_MIN
 (-2147483647-1)

	)

201 
	#INTPTR_MAX
 (2147483647)

	)

202 
	#UINTPTR_MAX
 (4294967295U)

	)

207 
	#INTMAX_MIN
 (-
	`__INT64_C
(9223372036854775807)-1)

	)

209 
	#INTMAX_MAX
 (
	`__INT64_C
(9223372036854775807))

	)

212 
	#UINTMAX_MAX
 (
	`__UINT64_C
(18446744073709551615))

	)

218 #ià
__WORDSIZE
 == 64

219 
	#PTRDIFF_MIN
 (-9223372036854775807L-1)

	)

220 
	#PTRDIFF_MAX
 (9223372036854775807L)

	)

222 #ià
__WORDSIZE32_PTRDIFF_LONG


223 
	#PTRDIFF_MIN
 (-2147483647L-1)

	)

224 
	#PTRDIFF_MAX
 (2147483647L)

	)

226 
	#PTRDIFF_MIN
 (-2147483647-1)

	)

227 
	#PTRDIFF_MAX
 (2147483647)

	)

232 
	#SIG_ATOMIC_MIN
 (-2147483647-1)

	)

233 
	#SIG_ATOMIC_MAX
 (2147483647)

	)

236 #ià
__WORDSIZE
 == 64

237 
	#SIZE_MAX
 (18446744073709551615UL)

	)

239 #ià
__WORDSIZE32_SIZE_ULONG


240 
	#SIZE_MAX
 (4294967295UL)

	)

242 
	#SIZE_MAX
 (4294967295U)

	)

247 #iâdeà
WCHAR_MIN


249 
	#WCHAR_MIN
 
__WCHAR_MIN


	)

250 
	#WCHAR_MAX
 
__WCHAR_MAX


	)

254 
	#WINT_MIN
 (0u)

	)

255 
	#WINT_MAX
 (4294967295u)

	)

258 
	#INT8_C
(
c
è
	)
c

259 
	#INT16_C
(
c
è
	)
c

260 
	#INT32_C
(
c
è
	)
c

261 #ià
__WORDSIZE
 == 64

262 
	#INT64_C
(
c
èø## 
L


	)

264 
	#INT64_C
(
c
èø## 
LL


	)

268 
	#UINT8_C
(
c
è
	)
c

269 
	#UINT16_C
(
c
è
	)
c

270 
	#UINT32_C
(
c
èø## 
U


	)

271 #ià
__WORDSIZE
 == 64

272 
	#UINT64_C
(
c
èø## 
UL


	)

274 
	#UINT64_C
(
c
èø## 
ULL


	)

278 #ià
__WORDSIZE
 == 64

279 
	#INTMAX_C
(
c
èø## 
L


	)

280 
	#UINTMAX_C
(
c
èø## 
UL


	)

282 
	#INTMAX_C
(
c
èø## 
LL


	)

283 
	#UINTMAX_C
(
c
èø## 
ULL


	)

286 #ià
__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

288 
	#INT8_WIDTH
 8

	)

289 
	#UINT8_WIDTH
 8

	)

290 
	#INT16_WIDTH
 16

	)

291 
	#UINT16_WIDTH
 16

	)

292 
	#INT32_WIDTH
 32

	)

293 
	#UINT32_WIDTH
 32

	)

294 
	#INT64_WIDTH
 64

	)

295 
	#UINT64_WIDTH
 64

	)

297 
	#INT_LEAST8_WIDTH
 8

	)

298 
	#UINT_LEAST8_WIDTH
 8

	)

299 
	#INT_LEAST16_WIDTH
 16

	)

300 
	#UINT_LEAST16_WIDTH
 16

	)

301 
	#INT_LEAST32_WIDTH
 32

	)

302 
	#UINT_LEAST32_WIDTH
 32

	)

303 
	#INT_LEAST64_WIDTH
 64

	)

304 
	#UINT_LEAST64_WIDTH
 64

	)

306 
	#INT_FAST8_WIDTH
 8

	)

307 
	#UINT_FAST8_WIDTH
 8

	)

308 
	#INT_FAST16_WIDTH
 
__WORDSIZE


	)

309 
	#UINT_FAST16_WIDTH
 
__WORDSIZE


	)

310 
	#INT_FAST32_WIDTH
 
__WORDSIZE


	)

311 
	#UINT_FAST32_WIDTH
 
__WORDSIZE


	)

312 
	#INT_FAST64_WIDTH
 64

	)

313 
	#UINT_FAST64_WIDTH
 64

	)

315 
	#INTPTR_WIDTH
 
__WORDSIZE


	)

316 
	#UINTPTR_WIDTH
 
__WORDSIZE


	)

318 
	#INTMAX_WIDTH
 64

	)

319 
	#UINTMAX_WIDTH
 64

	)

321 
	#PTRDIFF_WIDTH
 
__WORDSIZE


	)

322 
	#SIG_ATOMIC_WIDTH
 32

	)

323 
	#SIZE_WIDTH
 
__WORDSIZE


	)

324 
	#WCHAR_WIDTH
 32

	)

325 
	#WINT_WIDTH
 32

	)

	@/usr/include/stdio.h

23 #iâdeà
_STDIO_H


24 
	#_STDIO_H
 1

	)

26 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

27 
	~<b™s/libc-h—d”-¡¬t.h
>

29 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

35 
	~<b™s/ty³s.h
>

36 
	~<b™s/ty³s/__FILE.h
>

37 
	~<b™s/ty³s/FILE.h
>

39 
	#_STDIO_USES_IOSTREAM


	)

41 
	~<libio.h
>

43 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8


44 #ifdeà
__GNUC__


45 #iâdeà
_VA_LIST_DEFINED


46 
_G_va_li¡
 
	tva_li¡
;

47 
	#_VA_LIST_DEFINED


	)

50 
	~<¡d¬g.h
>

54 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


55 #iâdeà
__off_t_defšed


56 #iâdeà
__USE_FILE_OFFSET64


57 
__off_t
 
	toff_t
;

59 
__off64_t
 
	toff_t
;

61 
	#__off_t_defšed


	)

63 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


64 
__off64_t
 
	toff64_t
;

65 
	#__off64_t_defšed


	)

69 #ifdeà
__USE_XOPEN2K8


70 #iâdeà
__ssize_t_defšed


71 
__ssize_t
 
	tssize_t
;

72 
	#__ssize_t_defšed


	)

77 #iâdeà
__USE_FILE_OFFSET64


78 
_G_åos_t
 
	tåos_t
;

80 
_G_åos64_t
 
	tåos_t
;

82 #ifdeà
__USE_LARGEFILE64


83 
_G_åos64_t
 
	tåos64_t
;

87 
	#_IOFBF
 0

	)

88 
	#_IOLBF
 1

	)

89 
	#_IONBF
 2

	)

93 #iâdeà
BUFSIZ


94 
	#BUFSIZ
 
_IO_BUFSIZ


	)

100 #iâdeà
EOF


101 
	#EOF
 (-1)

	)

107 
	#SEEK_SET
 0

	)

108 
	#SEEK_CUR
 1

	)

109 
	#SEEK_END
 2

	)

110 #ifdeà
__USE_GNU


111 
	#SEEK_DATA
 3

	)

112 
	#SEEK_HOLE
 4

	)

116 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


118 
	#P_tmpdœ
 "/tmp"

	)

131 
	~<b™s/¡dio_lim.h
>

135 
_IO_FILE
 *
¡dš
;

136 
_IO_FILE
 *
¡dout
;

137 
_IO_FILE
 *
¡d”r
;

139 
	#¡dš
 
¡dš


	)

140 
	#¡dout
 
¡dout


	)

141 
	#¡d”r
 
¡d”r


	)

144 
	$»move
 (cÚ¡ *
__f’ame
è
__THROW
;

146 
	$»Çme
 (cÚ¡ *
__Şd
, cÚ¡ *
__Ãw
è
__THROW
;

148 #ifdeà
__USE_ATFILE


150 
	$»Çm—t
 (
__Şdfd
, cÚ¡ *
__Şd
, 
__Ãwfd
,

151 cÚ¡ *
__Ãw
è
__THROW
;

158 #iâdeà
__USE_FILE_OFFSET64


159 
FILE
 *
	$tmpfe
 (è
__wur
;

161 #ifdeà
__REDIRECT


162 
FILE
 *
	`__REDIRECT
 (
tmpfe
, (), 
tmpfe64
è
__wur
;

164 
	#tmpfe
 
tmpfe64


	)

168 #ifdeà
__USE_LARGEFILE64


169 
FILE
 *
	$tmpfe64
 (è
__wur
;

173 *
	$tm²am
 (*
__s
è
__THROW
 
__wur
;

175 #ifdeà
__USE_MISC


178 *
	$tm²am_r
 (*
__s
è
__THROW
 
__wur
;

182 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


190 *
	$‹m²am
 (cÚ¡ *
__dœ
, cÚ¡ *
__pfx
)

191 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

199 
	`fşo£
 (
FILE
 *
__¡»am
);

204 
	`fæush
 (
FILE
 *
__¡»am
);

206 #ifdeà
__USE_MISC


213 
	`fæush_uÆocked
 (
FILE
 *
__¡»am
);

216 #ifdeà
__USE_GNU


223 
	`fşo£®l
 ();

227 #iâdeà
__USE_FILE_OFFSET64


232 
FILE
 *
	$fİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

233 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

238 
FILE
 *
	$äeİ’
 (cÚ¡ *
__»¡riù
 
__f’ame
,

239 cÚ¡ *
__»¡riù
 
__modes
,

240 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

242 #ifdeà
__REDIRECT


243 
FILE
 *
	`__REDIRECT
 (
fİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

244 cÚ¡ *
__»¡riù
 
__modes
), 
fİ’64
)

245 
__wur
;

246 
FILE
 *
	`__REDIRECT
 (
äeİ’
, (cÚ¡ *
__»¡riù
 
__f’ame
,

247 cÚ¡ *
__»¡riù
 
__modes
,

248 
FILE
 *
__»¡riù
 
__¡»am
), 
äeİ’64
)

249 
__wur
;

251 
	#fİ’
 
fİ’64


	)

252 
	#äeİ’
 
äeİ’64


	)

255 #ifdeà
__USE_LARGEFILE64


256 
FILE
 *
	$fİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

257 cÚ¡ *
__»¡riù
 
__modes
è
__wur
;

258 
FILE
 *
	$äeİ’64
 (cÚ¡ *
__»¡riù
 
__f’ame
,

259 cÚ¡ *
__»¡riù
 
__modes
,

260 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

263 #ifdef 
__USE_POSIX


265 
FILE
 *
	$fdİ’
 (
__fd
, cÚ¡ *
__modes
è
__THROW
 
__wur
;

268 #ifdef 
__USE_GNU


271 
FILE
 *
	$fİ’cook›
 (*
__»¡riù
 
__magic_cook›
,

272 cÚ¡ *
__»¡riù
 
__modes
,

273 
_IO_cook›_io_funùiÚs_t
 
__io_funcs
è
__THROW
 
__wur
;

276 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

278 
FILE
 *
	$fmemİ’
 (*
__s
, 
size_t
 
__Ën
, cÚ¡ *
__modes
)

279 
__THROW
 
__wur
;

284 
FILE
 *
	$İ’_mem¡»am
 (**
__buæoc
, 
size_t
 *
__siz–oc
è
__THROW
 
__wur
;

290 
	$£tbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
è
__THROW
;

294 
	$£tvbuf
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

295 
__modes
, 
size_t
 
__n
è
__THROW
;

297 #ifdef 
__USE_MISC


300 
	$£tbufãr
 (
FILE
 *
__»¡riù
 
__¡»am
, *__»¡riù 
__buf
,

301 
size_t
 
__size
è
__THROW
;

304 
	$£šebuf
 (
FILE
 *
__¡»am
è
__THROW
;

312 
	`årštf
 (
FILE
 *
__»¡riù
 
__¡»am
,

313 cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

318 
	`´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...);

320 
	$¥rštf
 (*
__»¡riù
 
__s
,

321 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROWNL
;

327 
	`vårštf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

328 
_G_va_li¡
 
__¬g
);

333 
	`v´štf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
);

335 
	$v¥rštf
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

336 
_G_va_li¡
 
__¬g
è
__THROWNL
;

338 #ià
defšed
 
__USE_ISOC99
 || defšed 
__USE_UNIX98


340 
	$¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

341 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

342 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 4)));

344 
	$v¢´štf
 (*
__»¡riù
 
__s
, 
size_t
 
__maxËn
,

345 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

346 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 3, 0)));

349 #ià
	`__GLIBC_USE
 (
LIB_EXT2
)

352 
	$va¥rštf
 (**
__»¡riù
 
__±r
, cÚ¡ *__»¡riù 
__f
,

353 
_G_va_li¡
 
__¬g
)

354 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 0))è
__wur
;

355 
	$__a¥rštf
 (**
__»¡riù
 
__±r
,

356 cÚ¡ *
__»¡riù
 
__fmt
, ...)

357 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

358 
	$a¥rštf
 (**
__»¡riù
 
__±r
,

359 cÚ¡ *
__»¡riù
 
__fmt
, ...)

360 
__THROWNL
 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__´štf__
, 2, 3))è
__wur
;

363 #ifdeà
__USE_XOPEN2K8


365 
	$vd´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
,

366 
_G_va_li¡
 
__¬g
)

367 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

368 
	$d´štf
 (
__fd
, cÚ¡ *
__»¡riù
 
__fmt
, ...)

369 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

377 
	$fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

378 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

383 
	$sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

385 
	$ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

386 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

388 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__USE_GNU
 \

389 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

390 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

391 #ifdeà
__REDIRECT


395 
	`__REDIRECT
 (
fsÿnf
, (
FILE
 *
__»¡riù
 
__¡»am
,

396 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

397 
__isoc99_fsÿnf
è
__wur
;

398 
	`__REDIRECT
 (
sÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

399 
__isoc99_sÿnf
è
__wur
;

400 
	`__REDIRECT_NTH
 (
ssÿnf
, (cÚ¡ *
__»¡riù
 
__s
,

401 cÚ¡ *
__»¡riù
 
__fÜm©
, ...),

402 
__isoc99_ssÿnf
);

404 
	$__isoc99_fsÿnf
 (
FILE
 *
__»¡riù
 
__¡»am
,

405 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

406 
	$__isoc99_sÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__wur
;

407 
	$__isoc99_ssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

408 cÚ¡ *
__»¡riù
 
__fÜm©
, ...è
__THROW
;

409 
	#fsÿnf
 
__isoc99_fsÿnf


	)

410 
	#sÿnf
 
__isoc99_sÿnf


	)

411 
	#ssÿnf
 
__isoc99_ssÿnf


	)

415 #ifdef 
__USE_ISOC99


420 
	$vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__fÜm©
,

421 
_G_va_li¡
 
__¬g
)

422 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

428 
	$vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

429 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

432 
	$vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

433 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
)

434 
__THROW
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

436 #ià!
defšed
 
__USE_GNU
 \

437 && (!
defšed
 
__LDBL_COMPAT
 || !defšed 
__REDIRECT
) \

438 && (
defšed
 
__STRICT_ANSI__
 || defšed 
__USE_XOPEN2K
)

439 #ifdeà
__REDIRECT


443 
	`__REDIRECT
 (
vfsÿnf
,

444 (
FILE
 *
__»¡riù
 
__s
,

445 cÚ¡ *
__»¡riù
 
__fÜm©
, 
_G_va_li¡
 
__¬g
),

446 
__isoc99_vfsÿnf
)

447 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 2, 0))è
__wur
;

448 
	`__REDIRECT
 (
vsÿnf
, (cÚ¡ *
__»¡riù
 
__fÜm©
,

449 
_G_va_li¡
 
__¬g
), 
__isoc99_vsÿnf
)

450 
	`__©Œibu‹__
 ((
	$__fÜm©__
 (
__sÿnf__
, 1, 0))è
__wur
;

451 
	`__REDIRECT_NTH
 (
vssÿnf
,

452 (cÚ¡ *
__»¡riù
 
__s
,

453 cÚ¡ *
__»¡riù
 
__fÜm©
,

454 
_G_va_li¡
 
__¬g
), 
__isoc99_vssÿnf
)

455 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__sÿnf__
, 2, 0)));

457 
	$__isoc99_vfsÿnf
 (
FILE
 *
__»¡riù
 
__s
,

458 cÚ¡ *
__»¡riù
 
__fÜm©
,

459 
_G_va_li¡
 
__¬g
è
__wur
;

460 
	$__isoc99_vsÿnf
 (cÚ¡ *
__»¡riù
 
__fÜm©
,

461 
_G_va_li¡
 
__¬g
è
__wur
;

462 
	$__isoc99_vssÿnf
 (cÚ¡ *
__»¡riù
 
__s
,

463 cÚ¡ *
__»¡riù
 
__fÜm©
,

464 
_G_va_li¡
 
__¬g
è
__THROW
;

465 
	#vfsÿnf
 
__isoc99_vfsÿnf


	)

466 
	#vsÿnf
 
__isoc99_vsÿnf


	)

467 
	#vssÿnf
 
__isoc99_vssÿnf


	)

477 
	`fg‘c
 (
FILE
 *
__¡»am
);

478 
	`g‘c
 (
FILE
 *
__¡»am
);

484 
	`g‘ch¬
 ();

488 
	#g‘c
(
_å
è
	`_IO_g‘c
 (_å)

	)

490 #ifdeà
__USE_POSIX199506


495 
	`g‘c_uÆocked
 (
FILE
 *
__¡»am
);

496 
	`g‘ch¬_uÆocked
 ();

499 #ifdeà
__USE_MISC


506 
	`fg‘c_uÆocked
 (
FILE
 *
__¡»am
);

517 
	`åutc
 (
__c
, 
FILE
 *
__¡»am
);

518 
	`putc
 (
__c
, 
FILE
 *
__¡»am
);

524 
	`putch¬
 (
__c
);

528 
	#putc
(
_ch
, 
_å
è
	`_IO_putc
 (_ch, _å)

	)

530 #ifdeà
__USE_MISC


537 
	`åutc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

540 #ifdeà
__USE_POSIX199506


545 
	`putc_uÆocked
 (
__c
, 
FILE
 *
__¡»am
);

546 
	`putch¬_uÆocked
 (
__c
);

550 #ià
defšed
 
__USE_MISC
 \

551 || (
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

553 
	`g‘w
 (
FILE
 *
__¡»am
);

556 
	`putw
 (
__w
, 
FILE
 *
__¡»am
);

564 *
	$fg‘s
 (*
__»¡riù
 
__s
, 
__n
, 
FILE
 *__»¡riù 
__¡»am
)

565 
__wur
;

567 #ià
	`__GLIBC_USE
 (
DEPRECATED_GETS
)

577 *
	$g‘s
 (*
__s
è
__wur
 
__©Œibu‹_d•»ÿ‹d__
;

580 #ifdeà
__USE_GNU


587 *
	$fg‘s_uÆocked
 (*
__»¡riù
 
__s
, 
__n
,

588 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

592 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

603 
_IO_ssize_t
 
	$__g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

604 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

605 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

606 
_IO_ssize_t
 
	$g‘d–im
 (**
__»¡riù
 
__lš•Œ
,

607 
size_t
 *
__»¡riù
 
__n
, 
__d–im™”
,

608 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

616 
_IO_ssize_t
 
	$g‘lše
 (**
__»¡riù
 
__lš•Œ
,

617 
size_t
 *
__»¡riù
 
__n
,

618 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

626 
	`åuts
 (cÚ¡ *
__»¡riù
 
__s
, 
FILE
 *__»¡riù 
__¡»am
);

632 
	`puts
 (cÚ¡ *
__s
);

639 
	`ung‘c
 (
__c
, 
FILE
 *
__¡»am
);

646 
size_t
 
	$ä—d
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

647 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

652 
size_t
 
	`fwr™e
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

653 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__s
);

655 #ifdeà
__USE_GNU


662 
	`åuts_uÆocked
 (cÚ¡ *
__»¡riù
 
__s
,

663 
FILE
 *
__»¡riù
 
__¡»am
);

666 #ifdeà
__USE_MISC


673 
size_t
 
	$ä—d_uÆocked
 (*
__»¡riù
 
__±r
, 
size_t
 
__size
,

674 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
è
__wur
;

675 
size_t
 
	`fwr™e_uÆocked
 (cÚ¡ *
__»¡riù
 
__±r
, size_ˆ
__size
,

676 
size_t
 
__n
, 
FILE
 *
__»¡riù
 
__¡»am
);

684 
	`f£ek
 (
FILE
 *
__¡»am
, 
__off
, 
__wh’û
);

689 
	$á–l
 (
FILE
 *
__¡»am
è
__wur
;

694 
	`»wšd
 (
FILE
 *
__¡»am
);

701 #ià
defšed
 
__USE_LARGEFILE
 || defšed 
__USE_XOPEN2K


702 #iâdeà
__USE_FILE_OFFSET64


707 
	`f£eko
 (
FILE
 *
__¡»am
, 
__off_t
 
__off
, 
__wh’û
);

712 
__off_t
 
	$á–lo
 (
FILE
 *
__¡»am
è
__wur
;

714 #ifdeà
__REDIRECT


715 
	`__REDIRECT
 (
f£eko
,

716 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
),

717 
f£eko64
);

718 
__off64_t
 
	`__REDIRECT
 (
á–lo
, (
FILE
 *
__¡»am
), 
á–lo64
);

720 
	#f£eko
 
f£eko64


	)

721 
	#á–lo
 
á–lo64


	)

726 #iâdeà
__USE_FILE_OFFSET64


731 
	`fg‘pos
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos_t
 *__»¡riù 
__pos
);

736 
	`f£os
 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
);

738 #ifdeà
__REDIRECT


739 
	`__REDIRECT
 (
fg‘pos
, (
FILE
 *
__»¡riù
 
__¡»am
,

740 
åos_t
 *
__»¡riù
 
__pos
), 
fg‘pos64
);

741 
	`__REDIRECT
 (
f£os
,

742 (
FILE
 *
__¡»am
, cÚ¡ 
åos_t
 *
__pos
), 
f£os64
);

744 
	#fg‘pos
 
fg‘pos64


	)

745 
	#f£os
 
f£os64


	)

749 #ifdeà
__USE_LARGEFILE64


750 
	`f£eko64
 (
FILE
 *
__¡»am
, 
__off64_t
 
__off
, 
__wh’û
);

751 
__off64_t
 
	$á–lo64
 (
FILE
 *
__¡»am
è
__wur
;

752 
	`fg‘pos64
 (
FILE
 *
__»¡riù
 
__¡»am
, 
åos64_t
 *__»¡riù 
__pos
);

753 
	`f£os64
 (
FILE
 *
__¡»am
, cÚ¡ 
åos64_t
 *
__pos
);

757 
	$ş—»¼
 (
FILE
 *
__¡»am
è
__THROW
;

759 
	$ãof
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

761 
	$ã¼Ü
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

763 #ifdeà
__USE_MISC


765 
	$ş—»¼_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
;

766 
	$ãof_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

767 
	$ã¼Ü_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

775 
	`³¼Ü
 (cÚ¡ *
__s
);

781 
	~<b™s/sys_”¾i¡.h
>

784 #ifdef 
__USE_POSIX


786 
	$f’o
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

789 #ifdeà
__USE_MISC


791 
	$f’o_uÆocked
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

795 #ifdeà
__USE_POSIX2


800 
FILE
 *
	$pİ’
 (cÚ¡ *
__commªd
, cÚ¡ *
__modes
è
__wur
;

806 
	`pşo£
 (
FILE
 *
__¡»am
);

810 #ifdef 
__USE_POSIX


812 *
	$ù”mid
 (*
__s
è
__THROW
;

816 #ià(
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
è|| defšed 
__USE_GNU


818 *
	`cu£rid
 (*
__s
);

822 #ifdef 
__USE_GNU


823 
ob¡ack
;

826 
	$ob¡ack_´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

827 cÚ¡ *
__»¡riù
 
__fÜm©
, ...)

828 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 3)));

829 
	$ob¡ack_v´štf
 (
ob¡ack
 *
__»¡riù
 
__ob¡ack
,

830 cÚ¡ *
__»¡riù
 
__fÜm©
,

831 
_G_va_li¡
 
__¬gs
)

832 
__THROWNL
 
	`__©Œibu‹__
 ((
	`__fÜm©__
 (
__´štf__
, 2, 0)));

836 #ifdeà
__USE_POSIX199506


840 
	$æockfe
 (
FILE
 *
__¡»am
è
__THROW
;

844 
	$árylockfe
 (
FILE
 *
__¡»am
è
__THROW
 
__wur
;

847 
	$fuÆockfe
 (
FILE
 *
__¡»am
è
__THROW
;

850 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


853 
	~<b™s/g‘İt_posix.h
>

858 #ifdeà
__USE_EXTERN_INLINES


859 
	~<b™s/¡dio.h
>

861 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


862 
	~<b™s/¡dio2.h
>

864 #ifdeà
__LDBL_COMPAT


865 
	~<b™s/¡dio-ldbl.h
>

868 
__END_DECLS


	@/usr/include/stdlib.h

22 #iâdef 
_STDLIB_H


24 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

25 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	#__Ãed_size_t


	)

29 
	#__Ãed_wch¬_t


	)

30 
	#__Ãed_NULL


	)

31 
	~<¡ddef.h
>

33 
	g__BEGIN_DECLS


35 
	#_STDLIB_H
 1

	)

37 #ià(
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K8
è&& !defšed 
_SYS_WAIT_H


39 
	~<b™s/wa™æags.h
>

40 
	~<b™s/wa™¡©us.h
>

43 
	#WEXITSTATUS
(
¡©us
è
	`__WEXITSTATUS
 (¡©us)

	)

44 
	#WTERMSIG
(
¡©us
è
	`__WTERMSIG
 (¡©us)

	)

45 
	#WSTOPSIG
(
¡©us
è
	`__WSTOPSIG
 (¡©us)

	)

46 
	#WIFEXITED
(
¡©us
è
	`__WIFEXITED
 (¡©us)

	)

47 
	#WIFSIGNALED
(
¡©us
è
	`__WIFSIGNALED
 (¡©us)

	)

48 
	#WIFSTOPPED
(
¡©us
è
	`__WIFSTOPPED
 (¡©us)

	)

49 #ifdeà
__WIFCONTINUED


50 
	#WIFCONTINUED
(
¡©us
è
	`__WIFCONTINUED
 (¡©us)

	)

55 
	~<b™s/æßŠ.h
>

60 
	mquÙ
;

61 
	m»m
;

62 } 
	tdiv_t
;

65 #iâdeà
__ldiv_t_defšed


68 
	mquÙ
;

69 
	m»m
;

70 } 
	tldiv_t
;

71 
	#__ldiv_t_defšed
 1

	)

74 #ià
defšed
 
__USE_ISOC99
 && !defšed 
__Îdiv_t_defšed


76 
__ex‹nsiÚ__
 struct

78 
	mquÙ
;

79 
	m»m
;

80 } 
	tÎdiv_t
;

81 
	#__Îdiv_t_defšed
 1

	)

86 
	#RAND_MAX
 2147483647

	)

91 
	#EXIT_FAILURE
 1

	)

92 
	#EXIT_SUCCESS
 0

	)

96 
	#MB_CUR_MAX
 (
	`__ùy³_g‘_mb_cur_max
 ())

	)

97 
size_t
 
	$__ùy³_g‘_mb_cur_max
 (è
__THROW
 
__wur
;

101 
	$©of
 (cÚ¡ *
__ÅŒ
)

102 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

104 
	$©oi
 (cÚ¡ *
__ÅŒ
)

105 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

107 
	$©Ş
 (cÚ¡ *
__ÅŒ
)

108 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

110 #ifdeà
__USE_ISOC99


112 
__ex‹nsiÚ__
 
	$©Şl
 (cÚ¡ *
__ÅŒ
)

113 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

117 
	$¡¹od
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

118 **
__»¡riù
 
__’d±r
)

119 
__THROW
 
	`__nÚnuÎ
 ((1));

121 #ifdef 
__USE_ISOC99


123 
	$¡¹of
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

124 **
__»¡riù
 
__’d±r
è
__THROW
 
	`__nÚnuÎ
 ((1));

126 
	$¡¹Şd
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

127 **
__»¡riù
 
__’d±r
)

128 
__THROW
 
	`__nÚnuÎ
 ((1));

131 #ià
__HAVE_FLOAT128
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

133 
_Flßt128
 
	$¡¹of128
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

134 **
__»¡riù
 
__’d±r
)

135 
__THROW
 
	`__nÚnuÎ
 ((1));

139 
	$¡¹Ş
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

140 **
__»¡riù
 
__’d±r
, 
__ba£
)

141 
__THROW
 
	`__nÚnuÎ
 ((1));

143 
	$¡¹oul
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

144 **
__»¡riù
 
__’d±r
, 
__ba£
)

145 
__THROW
 
	`__nÚnuÎ
 ((1));

147 #ifdeà
__USE_MISC


149 
__ex‹nsiÚ__


150 
	$¡¹oq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

151 **
__»¡riù
 
__’d±r
, 
__ba£
)

152 
__THROW
 
	`__nÚnuÎ
 ((1));

154 
__ex‹nsiÚ__


155 
	$¡¹ouq
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

156 **
__»¡riù
 
__’d±r
, 
__ba£
)

157 
__THROW
 
	`__nÚnuÎ
 ((1));

160 #ifdeà
__USE_ISOC99


162 
__ex‹nsiÚ__


163 
	$¡¹Şl
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

164 **
__»¡riù
 
__’d±r
, 
__ba£
)

165 
__THROW
 
	`__nÚnuÎ
 ((1));

167 
__ex‹nsiÚ__


168 
	$¡¹ouÎ
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

169 **
__»¡riù
 
__’d±r
, 
__ba£
)

170 
__THROW
 
	`__nÚnuÎ
 ((1));

174 #ià
	`__GLIBC_USE
 (
IEC_60559_BFP_EXT
)

175 
	$¡räomd
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ *
__fÜm©
,

176 
__f
)

177 
__THROW
 
	`__nÚnuÎ
 ((3));

179 
	$¡räomf
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ *
__fÜm©
,

180 
__f
)

181 
__THROW
 
	`__nÚnuÎ
 ((3));

183 
	$¡räoml
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ *
__fÜm©
,

184 
__f
)

185 
__THROW
 
	`__nÚnuÎ
 ((3));

188 #ià
__HAVE_FLOAT128
 && 
	`__GLIBC_USE
 (
IEC_60559_TYPES_EXT
)

189 
	$¡räomf128
 (*
__de¡
, 
size_t
 
__size
, cÚ¡ * 
__fÜm©
,

190 
_Flßt128
 
__f
)

191 
__THROW
 
	`__nÚnuÎ
 ((3));

195 #ifdeà
__USE_GNU


199 
	~<b™s/ty³s/loÿË_t.h
>

201 
	$¡¹Ş_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

202 **
__»¡riù
 
__’d±r
, 
__ba£
,

203 
loÿË_t
 
__loc
è
__THROW
 
	`__nÚnuÎ
 ((1, 4));

205 
	$¡¹oul_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

206 **
__»¡riù
 
__’d±r
,

207 
__ba£
, 
loÿË_t
 
__loc
)

208 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

210 
__ex‹nsiÚ__


211 
	$¡¹Şl_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

212 **
__»¡riù
 
__’d±r
, 
__ba£
,

213 
loÿË_t
 
__loc
)

214 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

216 
__ex‹nsiÚ__


217 
	$¡¹ouÎ_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

218 **
__»¡riù
 
__’d±r
,

219 
__ba£
, 
loÿË_t
 
__loc
)

220 
__THROW
 
	`__nÚnuÎ
 ((1, 4));

222 
	$¡¹od_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

223 **
__»¡riù
 
__’d±r
, 
loÿË_t
 
__loc
)

224 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

226 
	$¡¹of_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

227 **
__»¡riù
 
__’d±r
, 
loÿË_t
 
__loc
)

228 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

230 
	$¡¹Şd_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

231 **
__»¡riù
 
__’d±r
,

232 
loÿË_t
 
__loc
)

233 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

235 #ià
__HAVE_FLOAT128


236 
_Flßt128
 
	$¡¹of128_l
 (cÚ¡ *
__»¡riù
 
__ÅŒ
,

237 **
__»¡riù
 
__’d±r
,

238 
loÿË_t
 
__loc
)

239 
__THROW
 
	`__nÚnuÎ
 ((1, 3));

244 #ifdeà
__USE_EXTERN_INLINES


245 
__ex‹º_šlše
 

246 
	`__NTH
 (
	$©oi
 (cÚ¡ *
__ÅŒ
))

248  (è
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

249 
	}
}

250 
__ex‹º_šlše
 

251 
__NTH
 (
	$©Ş
 (cÚ¡ *
__ÅŒ
))

253  
	`¡¹Ş
 (
__ÅŒ
, (**è
NULL
, 10);

254 
	}
}

256 #ifdeà
__USE_ISOC99


257 
__ex‹nsiÚ__
 
__ex‹º_šlše
 

258 
__NTH
 (
	$©Şl
 (cÚ¡ *
__ÅŒ
))

260  
	`¡¹Şl
 (
__ÅŒ
, (**è
NULL
, 10);

261 
	}
}

266 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


270 *
	$l64a
 (
__n
è
__THROW
 
__wur
;

273 
	$a64l
 (cÚ¡ *
__s
)

274 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1)è
__wur
;

278 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


279 
	~<sys/ty³s.h
>

286 
	$¿ndom
 (è
__THROW
;

289 
	$¤ªdom
 (
__£ed
è
__THROW
;

295 *
	$š™¡©e
 (
__£ed
, *
__¡©ebuf
,

296 
size_t
 
__¡©–’
è
__THROW
 
	`__nÚnuÎ
 ((2));

300 *
	$£t¡©e
 (*
__¡©ebuf
è
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_MISC


308 
	s¿ndom_d©a


310 
št32_t
 *
åŒ
;

311 
št32_t
 *
½Œ
;

312 
št32_t
 *
¡©e
;

313 
¿nd_ty³
;

314 
¿nd_deg
;

315 
¿nd_£p
;

316 
št32_t
 *
’d_±r
;

319 
	$¿ndom_r
 (
¿ndom_d©a
 *
__»¡riù
 
__buf
,

320 
št32_t
 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

322 
	$¤ªdom_r
 (
__£ed
, 
¿ndom_d©a
 *
__buf
)

323 
__THROW
 
	`__nÚnuÎ
 ((2));

325 
	$š™¡©e_r
 (
__£ed
, *
__»¡riù
 
__¡©ebuf
,

326 
size_t
 
__¡©–’
,

327 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

328 
__THROW
 
	`__nÚnuÎ
 ((2, 4));

330 
	$£t¡©e_r
 (*
__»¡riù
 
__¡©ebuf
,

331 
¿ndom_d©a
 *
__»¡riù
 
__buf
)

332 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

338 
	$¿nd
 (è
__THROW
;

340 
	$¤ªd
 (
__£ed
è
__THROW
;

342 #ifdeà
__USE_POSIX199506


344 
	$¿nd_r
 (*
__£ed
è
__THROW
;

348 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


352 
	$d¿nd48
 (è
__THROW
;

353 
	$”ªd48
 (
__xsubi
[3]è
__THROW
 
	`__nÚnuÎ
 ((1));

356 
	$Ìªd48
 (è
__THROW
;

357 
	$Äªd48
 (
__xsubi
[3])

358 
__THROW
 
	`__nÚnuÎ
 ((1));

361 
	$m¿nd48
 (è
__THROW
;

362 
	$j¿nd48
 (
__xsubi
[3])

363 
__THROW
 
	`__nÚnuÎ
 ((1));

366 
	$¤ªd48
 (
__£edv®
è
__THROW
;

367 *
	$£ed48
 (
__£ed16v
[3])

368 
__THROW
 
	`__nÚnuÎ
 ((1));

369 
	$lcÚg48
 (
__·¿m
[7]è
__THROW
 
	`__nÚnuÎ
 ((1));

371 #ifdeà
__USE_MISC


375 
	sd¿nd48_d©a


377 
__x
[3];

378 
__Şd_x
[3];

379 
__c
;

380 
__š™
;

381 
__ex‹nsiÚ__
 
__a
;

386 
	$d¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

387 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

388 
	$”ªd48_r
 (
__xsubi
[3],

389 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

390 *
__»¡riù
 
__»suÉ
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

393 
	$Ìªd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

394 *
__»¡riù
 
__»suÉ
)

395 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

396 
	$Äªd48_r
 (
__xsubi
[3],

397 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

398 *
__»¡riù
 
__»suÉ
)

399 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

402 
	$m¿nd48_r
 (
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

403 *
__»¡riù
 
__»suÉ
)

404 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

405 
	$j¿nd48_r
 (
__xsubi
[3],

406 
d¿nd48_d©a
 *
__»¡riù
 
__bufãr
,

407 *
__»¡riù
 
__»suÉ
)

408 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

411 
	$¤ªd48_r
 (
__£edv®
, 
d¿nd48_d©a
 *
__bufãr
)

412 
__THROW
 
	`__nÚnuÎ
 ((2));

414 
	$£ed48_r
 (
__£ed16v
[3],

415 
d¿nd48_d©a
 *
__bufãr
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

417 
	$lcÚg48_r
 (
__·¿m
[7],

418 
d¿nd48_d©a
 *
__bufãr
)

419 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

424 *
	$m®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

426 *
	$ÿÎoc
 (
size_t
 
__nmemb
, size_ˆ
__size
)

427 
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

434 *
	$»®loc
 (*
__±r
, 
size_t
 
__size
)

435 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

437 #ifdeà
__USE_GNU


443 *
	$»®loÿ¼ay
 (*
__±r
, 
size_t
 
__nmemb
, size_ˆ
__size
)

444 
__THROW
 
__©Œibu‹_w¬n_unu£d_»suÉ__
;

448 
	$ä“
 (*
__±r
è
__THROW
;

450 #ifdeà
__USE_MISC


451 
	~<®loÿ.h
>

454 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

455 || 
defšed
 
__USE_MISC


457 *
	$v®loc
 (
size_t
 
__size
è
__THROW
 
__©Œibu‹_m®loc__
 
__wur
;

460 #ifdeà
__USE_XOPEN2K


462 
	$posix_mem®ign
 (**
__mem±r
, 
size_t
 
__®ignm’t
, size_ˆ
__size
)

463 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

466 #ifdeà
__USE_ISOC11


468 *
	$®igÃd_®loc
 (
size_t
 
__®ignm’t
, size_ˆ
__size
)

469 
__THROW
 
__©Œibu‹_m®loc__
 
	`__©Œibu‹_®loc_size__
 ((2)è
__wur
;

473 
	$abÜt
 (è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

477 
	$©ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

479 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


481 #ifdeà
__ılu¥lus


482 "C++" 
	$©_quick_ex™
 ((*
__func
) ())

483 
__THROW
 
	`__asm
 ("©_quick_ex™"è
	`__nÚnuÎ
 ((1));

485 
	$©_quick_ex™
 ((*
__func
è()è
__THROW
 
	`__nÚnuÎ
 ((1));

489 #ifdef 
__USE_MISC


492 
	$Ú_ex™
 ((*
__func
è(
__¡©us
, *
__¬g
), *__arg)

493 
__THROW
 
	`__nÚnuÎ
 ((1));

499 
	$ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

501 #ià
defšed
 
__USE_ISOC11
 || defšed 
__USE_ISOCXX11


505 
	$quick_ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

508 #ifdeà
__USE_ISOC99


511 
	$_Ex™
 (
__¡©us
è
__THROW
 
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

516 *
	$g‘’v
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

518 #ifdeà
__USE_GNU


521 *
	$£cu»_g‘’v
 (cÚ¡ *
__Çme
)

522 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

525 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


529 
	$pu‹nv
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

532 #ifdeà
__USE_XOPEN2K


535 
	$£‹nv
 (cÚ¡ *
__Çme
, cÚ¡ *
__v®ue
, 
__»¶aû
)

536 
__THROW
 
	`__nÚnuÎ
 ((2));

539 
	$un£‹nv
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

542 #ifdef 
__USE_MISC


546 
	$ş—»nv
 (è
__THROW
;

550 #ià
defšed
 
__USE_MISC
 \

551 || (
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
)

557 *
	$mk‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1));

560 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


569 #iâdeà
__USE_FILE_OFFSET64


570 
	$mk¡emp
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

572 #ifdeà
__REDIRECT


573 
	`__REDIRECT
 (
mk¡emp
, (*
__‹m¶©e
), 
mk¡emp64
)

574 
	`__nÚnuÎ
 ((1)è
__wur
;

576 
	#mk¡emp
 
mk¡emp64


	)

579 #ifdeà
__USE_LARGEFILE64


580 
	$mk¡emp64
 (*
__‹m¶©e
è
	`__nÚnuÎ
 ((1)è
__wur
;

584 #ifdeà
__USE_MISC


591 #iâdeà
__USE_FILE_OFFSET64


592 
	$mk¡emps
 (*
__‹m¶©e
, 
__suffixËn
è
	`__nÚnuÎ
 ((1)è
__wur
;

594 #ifdeà
__REDIRECT


595 
	`__REDIRECT
 (
mk¡emps
, (*
__‹m¶©e
, 
__suffixËn
),

596 
mk¡emps64
è
	`__nÚnuÎ
 ((1)è
__wur
;

598 
	#mk¡emps
 
mk¡emps64


	)

601 #ifdeà
__USE_LARGEFILE64


602 
	$mk¡emps64
 (*
__‹m¶©e
, 
__suffixËn
)

603 
	`__nÚnuÎ
 ((1)è
__wur
;

607 #ifdeà
__USE_XOPEN2K8


613 *
	$mkd‹mp
 (*
__‹m¶©e
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

616 #ifdeà
__USE_GNU


623 #iâdeà
__USE_FILE_OFFSET64


624 
	$mko¡emp
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

626 #ifdeà
__REDIRECT


627 
	`__REDIRECT
 (
mko¡emp
, (*
__‹m¶©e
, 
__æags
), 
mko¡emp64
)

628 
	`__nÚnuÎ
 ((1)è
__wur
;

630 
	#mko¡emp
 
mko¡emp64


	)

633 #ifdeà
__USE_LARGEFILE64


634 
	$mko¡emp64
 (*
__‹m¶©e
, 
__æags
è
	`__nÚnuÎ
 ((1)è
__wur
;

643 #iâdeà
__USE_FILE_OFFSET64


644 
	$mko¡emps
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

645 
	`__nÚnuÎ
 ((1)è
__wur
;

647 #ifdeà
__REDIRECT


648 
	`__REDIRECT
 (
mko¡emps
, (*
__‹m¶©e
, 
__suffixËn
,

649 
__æags
), 
mko¡emps64
)

650 
	`__nÚnuÎ
 ((1)è
__wur
;

652 
	#mko¡emps
 
mko¡emps64


	)

655 #ifdeà
__USE_LARGEFILE64


656 
	$mko¡emps64
 (*
__‹m¶©e
, 
__suffixËn
, 
__æags
)

657 
	`__nÚnuÎ
 ((1)è
__wur
;

666 
	$sy¡em
 (cÚ¡ *
__commªd
è
__wur
;

669 #ifdef 
__USE_GNU


672 *
	$ÿnÚiÿlize_fe_Çme
 (cÚ¡ *
__Çme
)

673 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

676 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


682 *
	$»®·th
 (cÚ¡ *
__»¡riù
 
__Çme
,

683 *
__»¡riù
 
__»sŞved
è
__THROW
 
__wur
;

688 #iâdeà
__COMPAR_FN_T


689 
	#__COMPAR_FN_T


	)

690 (*
	t__com·r_â_t
) (const *, const *);

692 #ifdef 
__USE_GNU


693 
__com·r_â_t
 
	tcom·risÚ_â_t
;

696 #ifdeà
__USE_GNU


697 (*
	t__com·r_d_â_t
) (const *, const *, *);

702 *
	$b£¬ch
 (cÚ¡ *
__key
, cÚ¡ *
__ba£
,

703 
size_t
 
__nmemb
, size_ˆ
__size
, 
__com·r_â_t
 
__com·r
)

704 
	`__nÚnuÎ
 ((1, 2, 5)è
__wur
;

706 #ifdeà
__USE_EXTERN_INLINES


707 
	~<b™s/¡dlib-b£¬ch.h
>

712 
	$qsÜt
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

713 
__com·r_â_t
 
__com·r
è
	`__nÚnuÎ
 ((1, 4));

714 #ifdeà
__USE_GNU


715 
	$qsÜt_r
 (*
__ba£
, 
size_t
 
__nmemb
, size_ˆ
__size
,

716 
__com·r_d_â_t
 
__com·r
, *
__¬g
)

717 
	`__nÚnuÎ
 ((1, 4));

722 
	$abs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

723 
	$Ïbs
 (
__x
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

725 #ifdeà
__USE_ISOC99


726 
__ex‹nsiÚ__
 
	$Îabs
 (
__x
)

727 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

734 
div_t
 
	$div
 (
__num”
, 
__d’om
)

735 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

736 
ldiv_t
 
	$ldiv
 (
__num”
, 
__d’om
)

737 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

739 #ifdeà
__USE_ISOC99


740 
__ex‹nsiÚ__
 
Îdiv_t
 
	$Îdiv
 (
__num”
,

741 
__d’om
)

742 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
)è
__wur
;

746 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

747 || 
defšed
 
__USE_MISC


754 *
	$ecvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

755 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

760 *
	$fcvt
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

761 *
__»¡riù
 
__sign
è
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

766 *
	$gcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

767 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

770 #ifdeà
__USE_MISC


772 *
	$qecvt
 (
__v®ue
, 
__ndig™
,

773 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

774 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

775 *
	$qfcvt
 (
__v®ue
, 
__ndig™
,

776 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
)

777 
__THROW
 
	`__nÚnuÎ
 ((3, 4)è
__wur
;

778 *
	$qgcvt
 (
__v®ue
, 
__ndig™
, *
__buf
)

779 
__THROW
 
	`__nÚnuÎ
 ((3)è
__wur
;

784 
	$ecvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

785 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

786 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

787 
	$fcvt_r
 (
__v®ue
, 
__ndig™
, *
__»¡riù
 
__deıt
,

788 *
__»¡riù
 
__sign
, *__»¡riù 
__buf
,

789 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

791 
	$qecvt_r
 (
__v®ue
, 
__ndig™
,

792 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

793 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

794 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

795 
	$qfcvt_r
 (
__v®ue
, 
__ndig™
,

796 *
__»¡riù
 
__deıt
, *__»¡riù 
__sign
,

797 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

798 
__THROW
 
	`__nÚnuÎ
 ((3, 4, 5));

804 
	$mbËn
 (cÚ¡ *
__s
, 
size_t
 
__n
è
__THROW
;

807 
	$mbtowc
 (
wch¬_t
 *
__»¡riù
 
__pwc
,

808 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

811 
	$wùomb
 (*
__s
, 
wch¬_t
 
__wch¬
è
__THROW
;

815 
size_t
 
	$mb¡owcs
 (
wch¬_t
 *
__»¡riù
 
__pwcs
,

816 cÚ¡ *
__»¡riù
 
__s
, 
size_t
 
__n
è
__THROW
;

818 
size_t
 
	$wc¡ombs
 (*
__»¡riù
 
__s
,

819 cÚ¡ 
wch¬_t
 *
__»¡riù
 
__pwcs
, 
size_t
 
__n
)

820 
__THROW
;

823 #ifdeà
__USE_MISC


828 
	$½m©ch
 (cÚ¡ *
__»¥Ú£
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

832 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


839 
	$g‘subİt
 (**
__»¡riù
 
__İtiÚp
,

840 *cÚ¡ *
__»¡riù
 
__tok’s
,

841 **
__»¡riù
 
__v®u•
)

842 
__THROW
 
	`__nÚnuÎ
 ((1, 2, 3)è
__wur
;

846 #ifdeà
__USE_XOPEN


848 
	$£tkey
 (cÚ¡ *
__key
è
__THROW
 
	`__nÚnuÎ
 ((1));

854 #ifdeà
__USE_XOPEN2KXSI


856 
	$posix_İ’±
 (
__oæag
è
__wur
;

859 #ifdeà
__USE_XOPEN_EXTENDED


864 
	$g¿Á±
 (
__fd
è
__THROW
;

868 
	$uÆock±
 (
__fd
è
__THROW
;

873 *
	$±¢ame
 (
__fd
è
__THROW
 
__wur
;

876 #ifdeà
__USE_GNU


880 
	$±¢ame_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

881 
__THROW
 
	`__nÚnuÎ
 ((2));

884 
	`g‘±
 ();

887 #ifdeà
__USE_MISC


891 
	$g‘lßdavg
 (
__lßdavg
[], 
__ÃËm
)

892 
__THROW
 
	`__nÚnuÎ
 ((1));

895 #ià
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K


898 
	$‰y¦Ù
 (è
__THROW
;

901 
	~<b™s/¡dlib-æßt.h
>

904 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


905 
	~<b™s/¡dlib.h
>

907 #ifdeà
__LDBL_COMPAT


908 
	~<b™s/¡dlib-ldbl.h
>

911 
__END_DECLS


	@/usr/include/string.h

22 #iâdef 
_STRING_H


23 
	#_STRING_H
 1

	)

25 
	#__GLIBC_INTERNAL_STARTING_HEADER_IMPLEMENTATION


	)

26 
	~<b™s/libc-h—d”-¡¬t.h
>

28 
	g__BEGIN_DECLS


31 
	#__Ãed_size_t


	)

32 
	#__Ãed_NULL


	)

33 
	~<¡ddef.h
>

36 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

37 
	#__CORRECT_ISO_CPP_STRING_H_PROTO


	)

42 *
	$memıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

43 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

46 *
	$memmove
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
)

47 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

52 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


53 *
	$memcıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

54 
__c
, 
size_t
 
__n
)

55 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

60 *
	$mem£t
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

63 
	$memcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

64 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

67 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


70 *
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

71 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

72 cÚ¡ *
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

73 
__THROW
 
	`__asm
 ("memchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

75 #ifdeà
__OPTIMIZE__


76 
__ex‹º_®ways_šlše
 *

77 
	`memchr
 (*
__s
, 
__c
, 
size_t
 
__n
è
__THROW


79  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

82 
__ex‹º_®ways_šlše
 const *

83 
	`memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
è
__THROW


85  
	`__butš_memchr
 (
__s
, 
__c
, 
__n
);

88 
	}
}

90 *
	$memchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

91 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

94 #ifdeà
__USE_GNU


97 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


98 "C++" *
	$¿wmemchr
 (*
__s
, 
__c
)

99 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

100 "C++" cÚ¡ *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

101 
__THROW
 
	`__asm
 ("¿wmemchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

103 *
	$¿wmemchr
 (cÚ¡ *
__s
, 
__c
)

104 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

108 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


109 "C++" *
	$memrchr
 (*
__s
, 
__c
, 
size_t
 
__n
)

110 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

111 "C++" cÚ¡ *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

112 
__THROW
 
	`__asm
 ("memrchr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

114 *
	$memrchr
 (cÚ¡ *
__s
, 
__c
, 
size_t
 
__n
)

115 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

121 *
	$¡rıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

122 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

124 *
	$¡ºıy
 (*
__»¡riù
 
__de¡
,

125 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

126 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

129 *
	$¡rÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

130 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

132 *
	$¡ºÿt
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
,

133 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

136 
	$¡rcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

137 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

139 
	$¡ºcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

140 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

143 
	$¡rcŞl
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

144 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

146 
size_t
 
	$¡rxäm
 (*
__»¡riù
 
__de¡
,

147 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

148 
__THROW
 
	`__nÚnuÎ
 ((2));

150 #ifdeà
__USE_XOPEN2K8


152 
	~<b™s/ty³s/loÿË_t.h
>

155 
	$¡rcŞl_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__l
)

156 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

159 
size_t
 
	$¡rxäm_l
 (*
__de¡
, cÚ¡ *
__¤c
, 
size_t
 
__n
,

160 
loÿË_t
 
__l
è
__THROW
 
	`__nÚnuÎ
 ((2, 4));

163 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8
 \

164 || 
	$__GLIBC_USE
 (
LIB_EXT2
))

166 *
	$¡rdup
 (cÚ¡ *
__s
)

167 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

173 #ià
defšed
 
__USE_XOPEN2K8
 || 
	`__GLIBC_USE
 (
LIB_EXT2
)

174 *
	$¡ºdup
 (cÚ¡ *
__¡ršg
, 
size_t
 
__n
)

175 
__THROW
 
__©Œibu‹_m®loc__
 
	`__nÚnuÎ
 ((1));

178 #ià
defšed
 
__USE_GNU
 && defšed 
__GNUC__


180 
	#¡rdu·
(
s
) \

181 (
__ex‹nsiÚ__
 \

183 cÚ¡ *
__Şd
 = (
s
); \

184 
size_t
 
__Ën
 = 
	`¡¾’
 (
__Şd
) + 1; \

185 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
); \

186 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

187 
	}
}))

	)

190 
	#¡ºdu·
(
s
, 
n
) \

191 (
__ex‹nsiÚ__
 \

193 cÚ¡ *
__Şd
 = (
s
); \

194 
size_t
 
__Ën
 = 
	`¡ºËn
 (
__Şd
, (
n
)); \

195 *
__Ãw
 = (*è
	`__butš_®loÿ
 (
__Ën
 + 1); \

196 
__Ãw
[
__Ën
] = '\0'; \

197 (*è
	`memıy
 (
__Ãw
, 
__Şd
, 
__Ën
); \

198 }))

	)

202 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


205 *
¡rchr
 (*
__s
, 
__c
)

206 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

207 cÚ¡ *
¡rchr
 (cÚ¡ *
__s
, 
__c
)

208 
__THROW
 
__asm
 ("¡rchr"è
__©Œibu‹_pu»__
 
__nÚnuÎ
 ((1));

210 #ifdeà
__OPTIMIZE__


211 
__ex‹º_®ways_šlše
 *

212 
¡rchr
 (*
__s
, 
__c
è
	g__THROW


214  
__butš_¡rchr
 (
__s
, 
__c
);

217 
__ex‹º_®ways_šlše
 const *

218 
¡rchr
 (cÚ¡ *
__s
, 
__c
è
	g__THROW


220  
__butš_¡rchr
 (
__s
, 
__c
);

225 *
	$¡rchr
 (cÚ¡ *
__s
, 
__c
)

226 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

229 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


232 *
	`¡¼chr
 (*
__s
, 
__c
)

233 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

234 cÚ¡ *
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
)

235 
__THROW
 
	`__asm
 ("¡¼chr"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

237 #ifdeà
__OPTIMIZE__


238 
__ex‹º_®ways_šlše
 *

239 
	`¡¼chr
 (*
__s
, 
__c
è
__THROW


241  
	`__butš_¡¼chr
 (
__s
, 
__c
);

244 
__ex‹º_®ways_šlše
 const *

245 
	`¡¼chr
 (cÚ¡ *
__s
, 
__c
è
__THROW


247  
	`__butš_¡¼chr
 (
__s
, 
__c
);

250 
	}
}

252 *
	$¡¼chr
 (cÚ¡ *
__s
, 
__c
)

253 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

256 #ifdeà
__USE_GNU


259 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


260 "C++" *
	$¡rchºul
 (*
__s
, 
__c
)

261 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

262 "C++" cÚ¡ *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

263 
__THROW
 
	`__asm
 ("¡rchºul"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

265 *
	$¡rchºul
 (cÚ¡ *
__s
, 
__c
)

266 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

272 
size_t
 
	$¡rc¥n
 (cÚ¡ *
__s
, cÚ¡ *
__»jeù
)

273 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

276 
size_t
 
	$¡r¥n
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

277 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

279 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


282 *
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
)

283 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

284 cÚ¡ *
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

285 
__THROW
 
	`__asm
 ("¡½brk"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

287 #ifdeà
__OPTIMIZE__


288 
__ex‹º_®ways_šlše
 *

289 
	`¡½brk
 (*
__s
, cÚ¡ *
__acû±
è
__THROW


291  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

294 
__ex‹º_®ways_šlše
 const *

295 
	`¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
è
__THROW


297  
	`__butš_¡½brk
 (
__s
, 
__acû±
);

300 
	}
}

302 *
	$¡½brk
 (cÚ¡ *
__s
, cÚ¡ *
__acû±
)

303 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

306 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


309 *
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

310 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

311 cÚ¡ *
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

312 
__THROW
 
	`__asm
 ("¡r¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

314 #ifdeà
__OPTIMIZE__


315 
__ex‹º_®ways_šlše
 *

316 
	`¡r¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


318  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

321 
__ex‹º_®ways_šlše
 const *

322 
	`¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
è
__THROW


324  
	`__butš_¡r¡r
 (
__hay¡ack
, 
__ÃedË
);

327 
	}
}

329 *
	$¡r¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

330 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

335 *
	$¡¹ok
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
)

336 
__THROW
 
	`__nÚnuÎ
 ((2));

340 *
	$__¡¹ok_r
 (*
__»¡riù
 
__s
,

341 cÚ¡ *
__»¡riù
 
__d–im
,

342 **
__»¡riù
 
__§ve_±r
)

343 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

344 #ifdeà
__USE_POSIX


345 *
	$¡¹ok_r
 (*
__»¡riù
 
__s
, cÚ¡ *__»¡riù 
__d–im
,

346 **
__»¡riù
 
__§ve_±r
)

347 
__THROW
 
	`__nÚnuÎ
 ((2, 3));

350 #ifdeà
__USE_GNU


352 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


353 "C++" *
	$¡rÿ£¡r
 (*
__hay¡ack
, cÚ¡ *
__ÃedË
)

354 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

355 "C++" cÚ¡ *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
,

356 cÚ¡ *
__ÃedË
)

357 
__THROW
 
	`__asm
 ("¡rÿ£¡r"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

359 *
	$¡rÿ£¡r
 (cÚ¡ *
__hay¡ack
, cÚ¡ *
__ÃedË
)

360 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

364 #ifdeà
__USE_GNU


368 *
	$memmem
 (cÚ¡ *
__hay¡ack
, 
size_t
 
__hay¡ackËn
,

369 cÚ¡ *
__ÃedË
, 
size_t
 
__ÃedËËn
)

370 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 3));

374 *
	$__mempıy
 (*
__»¡riù
 
__de¡
,

375 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

376 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

377 *
	$mempıy
 (*
__»¡riù
 
__de¡
,

378 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

379 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

384 
size_t
 
	$¡¾’
 (cÚ¡ *
__s
)

385 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

387 #ifdef 
__USE_XOPEN2K8


390 
size_t
 
	$¡ºËn
 (cÚ¡ *
__¡ršg
, 
size_t
 
__maxËn
)

391 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

396 *
	$¡»¼Ü
 (
__”ºum
è
__THROW
;

397 #ifdeà
__USE_XOPEN2K


405 #ià
defšed
 
__USE_XOPEN2K
 && !defšed 
__USE_GNU


408 #ifdeà
__REDIRECT_NTH


409 
	`__REDIRECT_NTH
 (
¡»¼Ü_r
,

410 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
),

411 
__xpg_¡»¼Ü_r
è
	`__nÚnuÎ
 ((2));

413 
	$__xpg_¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

414 
__THROW
 
	`__nÚnuÎ
 ((2));

415 
	#¡»¼Ü_r
 
__xpg_¡»¼Ü_r


	)

420 *
	$¡»¼Ü_r
 (
__”ºum
, *
__buf
, 
size_t
 
__buæ’
)

421 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

425 #ifdeà
__USE_XOPEN2K8


427 *
	$¡»¼Ü_l
 (
__”ºum
, 
loÿË_t
 
__l
è
__THROW
;

430 #ifdeà
__USE_MISC


431 
	~<¡ršgs.h
>

435 
	$ex¶ic™_bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

439 *
	$¡r£p
 (**
__»¡riù
 
__¡ršgp
,

440 cÚ¡ *
__»¡riù
 
__d–im
)

441 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

444 #ifdef 
__USE_XOPEN2K8


446 *
	$¡rsigÇl
 (
__sig
è
__THROW
;

449 *
	$__¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

450 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

451 *
	$¡pıy
 (*
__»¡riù
 
__de¡
, cÚ¡ *__»¡riù 
__¤c
)

452 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

456 *
	$__¡²ıy
 (*
__»¡riù
 
__de¡
,

457 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

458 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

459 *
	$¡²ıy
 (*
__»¡riù
 
__de¡
,

460 cÚ¡ *
__»¡riù
 
__¤c
, 
size_t
 
__n
)

461 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

464 #ifdef 
__USE_GNU


466 
	$¡rv”scmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

467 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

470 *
	$¡räy
 (*
__¡ršg
è
__THROW
 
	`__nÚnuÎ
 ((1));

473 *
	$memäob
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

475 #iâdeà
ba£Çme


480 #ifdeà
__CORRECT_ISO_CPP_STRING_H_PROTO


481 "C++" *
	$ba£Çme
 (*
__f’ame
)

482 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

483 "C++" cÚ¡ *
	$ba£Çme
 (cÚ¡ *
__f’ame
)

484 
__THROW
 
	`__asm
 ("ba£Çme"è
	`__nÚnuÎ
 ((1));

486 *
	$ba£Çme
 (cÚ¡ *
__f’ame
è
__THROW
 
	`__nÚnuÎ
 ((1));

491 #ià
	`__GNUC_PREREQ
 (3,4)

492 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


494 
	~<b™s/¡ršg_fÜtif›d.h
>

498 
__END_DECLS


	@/usr/include/time.h

22 #iâdef 
_TIME_H


23 
	#_TIME_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	#__Ãed_size_t


	)

28 
	#__Ãed_NULL


	)

29 
	~<¡ddef.h
>

33 
	~<b™s/time.h
>

37 
	~<b™s/ty³s/şock_t.h
>

38 
	~<b™s/ty³s/time_t.h
>

39 
	~<b™s/ty³s/¡ruù_tm.h
>

41 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_ISOC11


42 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

45 #ifdeà
__USE_POSIX199309


46 
	~<b™s/ty³s/şockid_t.h
>

47 
	~<b™s/ty³s/tim”_t.h
>

48 
	~<b™s/ty³s/¡ruù_™im”¥ec.h
>

49 
	gsigev’t
;

52 #ifdeà
__USE_XOPEN2K


53 #iâdeà
__pid_t_defšed


54 
__pid_t
 
	tpid_t
;

55 
	#__pid_t_defšed


	)

59 #ifdeà
__USE_XOPEN2K8


60 
	~<b™s/ty³s/loÿË_t.h
>

63 #ifdeà
__USE_ISOC11


65 
	#TIME_UTC
 1

	)

68 
__BEGIN_DECLS


72 
şock_t
 
	$şock
 (è
__THROW
;

75 
time_t
 
	$time
 (
time_t
 *
__tim”
è
__THROW
;

78 
	$difáime
 (
time_t
 
__time1
,ime_ˆ
__time0
)

79 
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

82 
time_t
 
	$mktime
 (
tm
 *
__
è
__THROW
;

88 
size_t
 
	$¡ráime
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

89 cÚ¡ *
__»¡riù
 
__fÜm©
,

90 cÚ¡ 
tm
 *
__»¡riù
 
__
è
__THROW
;

92 #ifdeà
__USE_XOPEN


95 *
	$¡½time
 (cÚ¡ *
__»¡riù
 
__s
,

96 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
)

97 
__THROW
;

100 #ifdeà
__USE_XOPEN2K8


104 
size_t
 
	$¡ráime_l
 (*
__»¡riù
 
__s
, 
size_t
 
__maxsize
,

105 cÚ¡ *
__»¡riù
 
__fÜm©
,

106 cÚ¡ 
tm
 *
__»¡riù
 
__
,

107 
loÿË_t
 
__loc
è
__THROW
;

110 #ifdeà
__USE_GNU


111 *
	$¡½time_l
 (cÚ¡ *
__»¡riù
 
__s
,

112 cÚ¡ *
__»¡riù
 
__fmt
, 
tm
 *
__
,

113 
loÿË_t
 
__loc
è
__THROW
;

119 
tm
 *
	$gmtime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

123 
tm
 *
	$loÿÉime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

125 #ifdeà
__USE_POSIX


128 
tm
 *
	$gmtime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

129 
tm
 *
__»¡riù
 
__
è
__THROW
;

133 
tm
 *
	$loÿÉime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

134 
tm
 *
__»¡riù
 
__
è
__THROW
;

139 *
	$asùime
 (cÚ¡ 
tm
 *
__
è
__THROW
;

142 *
	$ùime
 (cÚ¡ 
time_t
 *
__tim”
è
__THROW
;

144 #ifdeà
__USE_POSIX


149 *
	$asùime_r
 (cÚ¡ 
tm
 *
__»¡riù
 
__
,

150 *
__»¡riù
 
__buf
è
__THROW
;

153 *
	$ùime_r
 (cÚ¡ 
time_t
 *
__»¡riù
 
__tim”
,

154 *
__»¡riù
 
__buf
è
__THROW
;

159 *
__tzÇme
[2];

160 
__daylight
;

161 
__timezÚe
;

164 #ifdef 
__USE_POSIX


166 *
tzÇme
[2];

170 
	$tz£t
 (è
__THROW
;

173 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


174 
daylight
;

175 
timezÚe
;

178 #ifdeà
__USE_MISC


181 
	$¡ime
 (cÚ¡ 
time_t
 *
__wh’
è
__THROW
;

187 
	#__i¦—p
(
y—r
) \

188 ((
y—r
è% 4 =ğ0 && ((y—rè% 100 !ğ0 || (y—rè% 400 =ğ0))

	)

191 #ifdeà
__USE_MISC


196 
time_t
 
	$timegm
 (
tm
 *
__
è
__THROW
;

199 
time_t
 
	$tim–oÿl
 (
tm
 *
__
è
__THROW
;

202 
	$dysize
 (
__y—r
è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

206 #ifdeà
__USE_POSIX199309


211 
	`Çno¦“p
 (cÚ¡ 
time¥ec
 *
__»que¡ed_time
,

212 
time¥ec
 *
__»maššg
);

216 
	$şock_g‘»s
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__»s
è
__THROW
;

219 
	$şock_g‘time
 (
şockid_t
 
__şock_id
, 
time¥ec
 *
__
è
__THROW
;

222 
	$şock_£‰ime
 (
şockid_t
 
__şock_id
, cÚ¡ 
time¥ec
 *
__
)

223 
__THROW
;

225 #ifdeà
__USE_XOPEN2K


230 
	`şock_Çno¦“p
 (
şockid_t
 
__şock_id
, 
__æags
,

231 cÚ¡ 
time¥ec
 *
__»q
,

232 
time¥ec
 *
__»m
);

235 
	$şock_g‘ıuşockid
 (
pid_t
 
__pid
, 
şockid_t
 *
__şock_id
è
__THROW
;

240 
	$tim”_ü—‹
 (
şockid_t
 
__şock_id
,

241 
sigev’t
 *
__»¡riù
 
__evp
,

242 
tim”_t
 *
__»¡riù
 
__tim”id
è
__THROW
;

245 
	$tim”_d–‘e
 (
tim”_t
 
__tim”id
è
__THROW
;

248 
	$tim”_£‰ime
 (
tim”_t
 
__tim”id
, 
__æags
,

249 cÚ¡ 
™im”¥ec
 *
__»¡riù
 
__v®ue
,

250 
™im”¥ec
 *
__»¡riù
 
__ov®ue
è
__THROW
;

253 
	$tim”_g‘time
 (
tim”_t
 
__tim”id
, 
™im”¥ec
 *
__v®ue
)

254 
__THROW
;

257 
	$tim”_g‘ov”run
 (
tim”_t
 
__tim”id
è
__THROW
;

261 #ifdeà
__USE_ISOC11


263 
	$time¥ec_g‘
 (
time¥ec
 *
__ts
, 
__ba£
)

264 
__THROW
 
	`__nÚnuÎ
 ((1));

268 #ifdeà
__USE_XOPEN_EXTENDED


280 
g‘d©e_”r
;

289 
tm
 *
	`g‘d©e
 (cÚ¡ *
__¡ršg
);

292 #ifdeà
__USE_GNU


303 
	`g‘d©e_r
 (cÚ¡ *
__»¡riù
 
__¡ršg
,

304 
tm
 *
__»¡riù
 
__»sbuå
);

307 
__END_DECLS


	@/usr/include/unistd.h

22 #iâdef 
_UNISTD_H


23 
	#_UNISTD_H
 1

	)

25 
	~<ã©u»s.h
>

27 
	g__BEGIN_DECLS


32 #ifdeà
__USE_XOPEN2K8


34 
	#_POSIX_VERSION
 200809L

	)

35 #–ià
defšed
 
__USE_XOPEN2K


37 
	#_POSIX_VERSION
 200112L

	)

38 #–ià
defšed
 
__USE_POSIX199506


40 
	#_POSIX_VERSION
 199506L

	)

41 #–ià
defšed
 
__USE_POSIX199309


43 
	#_POSIX_VERSION
 199309L

	)

46 
	#_POSIX_VERSION
 199009L

	)

52 #ifdeà
__USE_XOPEN2K8


53 
	#__POSIX2_THIS_VERSION
 200809L

	)

55 #–ià
defšed
 
__USE_XOPEN2K


57 
	#__POSIX2_THIS_VERSION
 200112L

	)

58 #–ià
defšed
 
__USE_POSIX199506


60 
	#__POSIX2_THIS_VERSION
 199506L

	)

63 
	#__POSIX2_THIS_VERSION
 199209L

	)

67 
	#_POSIX2_VERSION
 
__POSIX2_THIS_VERSION


	)

70 
	#_POSIX2_C_VERSION
 
__POSIX2_THIS_VERSION


	)

74 
	#_POSIX2_C_BIND
 
__POSIX2_THIS_VERSION


	)

78 
	#_POSIX2_C_DEV
 
__POSIX2_THIS_VERSION


	)

82 
	#_POSIX2_SW_DEV
 
__POSIX2_THIS_VERSION


	)

86 
	#_POSIX2_LOCALEDEF
 
__POSIX2_THIS_VERSION


	)

89 #ifdeà
__USE_XOPEN2K8


90 
	#_XOPEN_VERSION
 700

	)

91 #–ià
defšed
 
__USE_XOPEN2K


92 
	#_XOPEN_VERSION
 600

	)

93 #–ià
defšed
 
__USE_UNIX98


94 
	#_XOPEN_VERSION
 500

	)

96 
	#_XOPEN_VERSION
 4

	)

100 
	#_XOPEN_XCU_VERSION
 4

	)

103 
	#_XOPEN_XPG2
 1

	)

104 
	#_XOPEN_XPG3
 1

	)

105 
	#_XOPEN_XPG4
 1

	)

108 
	#_XOPEN_UNIX
 1

	)

111 
	#_XOPEN_CRYPT
 1

	)

115 
	#_XOPEN_ENH_I18N
 1

	)

118 
	#_XOPEN_LEGACY
 1

	)

205 
	~<b™s/posix_İt.h
>

208 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K


209 
	~<b™s/’vœÚm’ts.h
>

213 
	#STDIN_FILENO
 0

	)

214 
	#STDOUT_FILENO
 1

	)

215 
	#STDERR_FILENO
 2

	)

220 
	~<b™s/ty³s.h
>

222 #iâdef 
__ssize_t_defšed


223 
__ssize_t
 
	tssize_t
;

224 
	#__ssize_t_defšed


	)

227 
	#__Ãed_size_t


	)

228 
	#__Ãed_NULL


	)

229 
	~<¡ddef.h
>

231 #ià
defšed
 
__USE_XOPEN
 || defšed 
__USE_XOPEN2K


234 #iâdeà
__gid_t_defšed


235 
__gid_t
 
	tgid_t
;

236 
	#__gid_t_defšed


	)

239 #iâdeà
__uid_t_defšed


240 
__uid_t
 
	tuid_t
;

241 
	#__uid_t_defšed


	)

244 #iâdeà
__off_t_defšed


245 #iâdeà
__USE_FILE_OFFSET64


246 
__off_t
 
	toff_t
;

248 
__off64_t
 
	toff_t
;

250 
	#__off_t_defšed


	)

252 #ià
defšed
 
__USE_LARGEFILE64
 && !defšed 
__off64_t_defšed


253 
__off64_t
 
	toff64_t
;

254 
	#__off64_t_defšed


	)

257 #iâdeà
__u£cÚds_t_defšed


258 
__u£cÚds_t
 
	tu£cÚds_t
;

259 
	#__u£cÚds_t_defšed


	)

262 #iâdeà
__pid_t_defšed


263 
__pid_t
 
	tpid_t
;

264 
	#__pid_t_defšed


	)

268 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


269 #iâdeà
__šŒ_t_defšed


270 
__šŒ_t
 
	tšŒ_t
;

271 
	#__šŒ_t_defšed


	)

275 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


276 #iâdeà
__sockËn_t_defšed


277 
__sockËn_t
 
	tsockËn_t
;

278 
	#__sockËn_t_defšed


	)

284 
	#R_OK
 4

	)

285 
	#W_OK
 2

	)

286 
	#X_OK
 1

	)

287 
	#F_OK
 0

	)

290 
	$acûss
 (cÚ¡ *
__Çme
, 
__ty³
è
__THROW
 
	`__nÚnuÎ
 ((1));

292 #ifdeà
__USE_GNU


295 
	$euidacûss
 (cÚ¡ *
__Çme
, 
__ty³
)

296 
__THROW
 
	`__nÚnuÎ
 ((1));

299 
	$—cûss
 (cÚ¡ *
__Çme
, 
__ty³
)

300 
__THROW
 
	`__nÚnuÎ
 ((1));

303 #ifdeà
__USE_ATFILE


307 
	$çcûs§t
 (
__fd
, cÚ¡ *
__fe
, 
__ty³
, 
__æag
)

308 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

313 #iâdef 
_STDIO_H


314 
	#SEEK_SET
 0

	)

315 
	#SEEK_CUR
 1

	)

316 
	#SEEK_END
 2

	)

317 #ifdeà
__USE_GNU


318 
	#SEEK_DATA
 3

	)

319 
	#SEEK_HOLE
 4

	)

323 #ià
defšed
 
__USE_MISC
 && !defšed 
L_SET


325 
	#L_SET
 
SEEK_SET


	)

326 
	#L_INCR
 
SEEK_CUR


	)

327 
	#L_XTND
 
SEEK_END


	)

336 #iâdeà
__USE_FILE_OFFSET64


337 
__off_t
 
	$l£ek
 (
__fd
, 
__off_t
 
__off£t
, 
__wh’û
è
__THROW
;

339 #ifdeà
__REDIRECT_NTH


340 
__off64_t
 
	`__REDIRECT_NTH
 (
l£ek
,

341 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
),

342 
l£ek64
);

344 
	#l£ek
 
l£ek64


	)

347 #ifdeà
__USE_LARGEFILE64


348 
__off64_t
 
	$l£ek64
 (
__fd
, 
__off64_t
 
__off£t
, 
__wh’û
)

349 
__THROW
;

356 
	`şo£
 (
__fd
);

363 
ssize_t
 
	$»ad
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
è
__wur
;

369 
ssize_t
 
	$wr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
è
__wur
;

371 #ià
defšed
 
__USE_UNIX98
 || defšed 
__USE_XOPEN2K8


372 #iâdeà
__USE_FILE_OFFSET64


379 
ssize_t
 
	$´—d
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

380 
__off_t
 
__off£t
è
__wur
;

387 
ssize_t
 
	$pwr™e
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

388 
__off_t
 
__off£t
è
__wur
;

390 #ifdeà
__REDIRECT


391 
ssize_t
 
	`__REDIRECT
 (
´—d
, (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

392 
__off64_t
 
__off£t
),

393 
´—d64
è
__wur
;

394 
ssize_t
 
	`__REDIRECT
 (
pwr™e
, (
__fd
, cÚ¡ *
__buf
,

395 
size_t
 
__nby‹s
, 
__off64_t
 
__off£t
),

396 
pwr™e64
è
__wur
;

398 
	#´—d
 
´—d64


	)

399 
	#pwr™e
 
pwr™e64


	)

403 #ifdeà
__USE_LARGEFILE64


407 
ssize_t
 
	$´—d64
 (
__fd
, *
__buf
, 
size_t
 
__nby‹s
,

408 
__off64_t
 
__off£t
è
__wur
;

411 
ssize_t
 
	$pwr™e64
 (
__fd
, cÚ¡ *
__buf
, 
size_t
 
__n
,

412 
__off64_t
 
__off£t
è
__wur
;

420 
	$pe
 (
__pedes
[2]è
__THROW
 
__wur
;

422 #ifdeà
__USE_GNU


425 
	$pe2
 (
__pedes
[2], 
__æags
è
__THROW
 
__wur
;

435 
	$®¬m
 (
__£cÚds
è
__THROW
;

447 
	`¦“p
 (
__£cÚds
);

449 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

450 || 
defšed
 
__USE_MISC


455 
__u£cÚds_t
 
	$u®¬m
 (
__u£cÚds_t
 
__v®ue
, __u£cÚds_ˆ
__š‹rv®
)

456 
__THROW
;

463 
	`u¦“p
 (
__u£cÚds_t
 
__u£cÚds
);

472 
	`·u£
 ();

476 
	$chown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

477 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

479 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


481 
	$fchown
 (
__fd
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
è
__THROW
 
__wur
;

486 
	$lchown
 (cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
, 
__gid_t
 
__group
)

487 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

491 #ifdeà
__USE_ATFILE


494 
	$fchowÇt
 (
__fd
, cÚ¡ *
__fe
, 
__uid_t
 
__owÃr
,

495 
__gid_t
 
__group
, 
__æag
)

496 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

500 
	$chdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

502 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


504 
	$fchdœ
 (
__fd
è
__THROW
 
__wur
;

514 *
	$g‘cwd
 (*
__buf
, 
size_t
 
__size
è
__THROW
 
__wur
;

516 #ifdef 
__USE_GNU


520 *
	$g‘_cu¼’t_dœ_Çme
 (è
__THROW
;

523 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

524 || 
defšed
 
__USE_MISC


528 *
	$g‘wd
 (*
__buf
)

529 
__THROW
 
	`__nÚnuÎ
 ((1)è
__©Œibu‹_d•»ÿ‹d__
 
__wur
;

534 
	$dup
 (
__fd
è
__THROW
 
__wur
;

537 
	$dup2
 (
__fd
, 
__fd2
è
__THROW
;

539 #ifdeà
__USE_GNU


542 
	$dup3
 (
__fd
, 
__fd2
, 
__æags
è
__THROW
;

546 **
__’vœÚ
;

547 #ifdeà
__USE_GNU


548 **
’vœÚ
;

554 
	$execve
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[],

555 *cÚ¡ 
__’vp
[]è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

557 #ifdeà
__USE_XOPEN2K8


560 
	$ãxecve
 (
__fd
, *cÚ¡ 
__¬gv
[], *cÚ¡ 
__’vp
[])

561 
__THROW
 
	`__nÚnuÎ
 ((2));

566 
	$execv
 (cÚ¡ *
__·th
, *cÚ¡ 
__¬gv
[])

567 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

571 
	$exeşe
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

572 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

576 
	$exeş
 (cÚ¡ *
__·th
, cÚ¡ *
__¬g
, ...)

577 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

581 
	$execvp
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[])

582 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

587 
	$exeşp
 (cÚ¡ *
__fe
, cÚ¡ *
__¬g
, ...)

588 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

590 #ifdeà
__USE_GNU


593 
	$execv³
 (cÚ¡ *
__fe
, *cÚ¡ 
__¬gv
[],

594 *cÚ¡ 
__’vp
[])

595 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

599 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN


601 
	$niû
 (
__šc
è
__THROW
 
__wur
;

606 
	$_ex™
 (
__¡©us
è
	`__©Œibu‹__
 ((
__nÜ‘uº__
));

612 
	~<b™s/cÚâame.h
>

615 
	$·thcÚf
 (cÚ¡ *
__·th
, 
__Çme
)

616 
__THROW
 
	`__nÚnuÎ
 ((1));

619 
	$å©hcÚf
 (
__fd
, 
__Çme
è
__THROW
;

622 
	$syscÚf
 (
__Çme
è
__THROW
;

624 #ifdef 
__USE_POSIX2


626 
size_t
 
	$cÚf¡r
 (
__Çme
, *
__buf
, 
size_t
 
__Ën
è
__THROW
;

631 
__pid_t
 
	$g‘pid
 (è
__THROW
;

634 
__pid_t
 
	$g‘µid
 (è
__THROW
;

637 
__pid_t
 
	$g‘pg½
 (è
__THROW
;

640 
__pid_t
 
	$__g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

641 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


642 
__pid_t
 
	$g‘pgid
 (
__pid_t
 
__pid
è
__THROW
;

649 
	$£gid
 (
__pid_t
 
__pid
, __pid_ˆ
__pgid
è
__THROW
;

651 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


663 
	$£g½
 (è
__THROW
;

670 
__pid_t
 
	$£tsid
 (è
__THROW
;

672 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


674 
__pid_t
 
	$g‘sid
 (
__pid_t
 
__pid
è
__THROW
;

678 
__uid_t
 
	$g‘uid
 (è
__THROW
;

681 
__uid_t
 
	$g‘euid
 (è
__THROW
;

684 
__gid_t
 
	$g‘gid
 (è
__THROW
;

687 
__gid_t
 
	$g‘egid
 (è
__THROW
;

692 
	$g‘groups
 (
__size
, 
__gid_t
 
__li¡
[]è
__THROW
 
__wur
;

694 #ifdef 
__USE_GNU


696 
	$group_memb”
 (
__gid_t
 
__gid
è
__THROW
;

703 
	$£tuid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

705 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


708 
	$£Œeuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
è
__THROW
 
__wur
;

711 #ifdeà
__USE_XOPEN2K


713 
	$£‹uid
 (
__uid_t
 
__uid
è
__THROW
 
__wur
;

720 
	$£tgid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

722 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


725 
	$£Œegid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
è
__THROW
 
__wur
;

728 #ifdeà
__USE_XOPEN2K


730 
	$£‹gid
 (
__gid_t
 
__gid
è
__THROW
 
__wur
;

733 #ifdeà
__USE_GNU


736 
	$g‘»suid
 (
__uid_t
 *
__ruid
, __uid_ˆ*
__euid
, __uid_ˆ*
__suid
)

737 
__THROW
;

741 
	$g‘»sgid
 (
__gid_t
 *
__rgid
, __gid_ˆ*
__egid
, __gid_ˆ*
__sgid
)

742 
__THROW
;

746 
	$£Œesuid
 (
__uid_t
 
__ruid
, __uid_ˆ
__euid
, __uid_ˆ
__suid
)

747 
__THROW
 
__wur
;

751 
	$£Œesgid
 (
__gid_t
 
__rgid
, __gid_ˆ
__egid
, __gid_ˆ
__sgid
)

752 
__THROW
 
__wur
;

759 
__pid_t
 
	$fÜk
 (è
__THROWNL
;

761 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K8
) \

762 || 
defšed
 
__USE_MISC


767 
__pid_t
 
	$vfÜk
 (è
__THROW
;

773 *
	$‰yÇme
 (
__fd
è
__THROW
;

777 
	$‰yÇme_r
 (
__fd
, *
__buf
, 
size_t
 
__buæ’
)

778 
__THROW
 
	`__nÚnuÎ
 ((2)è
__wur
;

782 
	$i§‰y
 (
__fd
è
__THROW
;

784 #ifdeà
__USE_MISC


787 
	$‰y¦Ù
 (è
__THROW
;

792 
	$lšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

793 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

795 #ifdeà
__USE_ATFILE


798 
	$lšk©
 (
__äomfd
, cÚ¡ *
__äom
, 
__tofd
,

799 cÚ¡ *
__to
, 
__æags
)

800 
__THROW
 
	`__nÚnuÎ
 ((2, 4)è
__wur
;

803 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


805 
	$symlšk
 (cÚ¡ *
__äom
, cÚ¡ *
__to
)

806 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

811 
ssize_t
 
	$»adlšk
 (cÚ¡ *
__»¡riù
 
__·th
,

812 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

813 
__THROW
 
	`__nÚnuÎ
 ((1, 2)è
__wur
;

816 #ifdeà
__USE_ATFILE


818 
	$symlšk©
 (cÚ¡ *
__äom
, 
__tofd
,

819 cÚ¡ *
__to
è
__THROW
 
	`__nÚnuÎ
 ((1, 3)è
__wur
;

822 
ssize_t
 
	$»adlšk©
 (
__fd
, cÚ¡ *
__»¡riù
 
__·th
,

823 *
__»¡riù
 
__buf
, 
size_t
 
__Ën
)

824 
__THROW
 
	`__nÚnuÎ
 ((2, 3)è
__wur
;

828 
	$uÆšk
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

830 #ifdeà
__USE_ATFILE


832 
	$uÆšk©
 (
__fd
, cÚ¡ *
__Çme
, 
__æag
)

833 
__THROW
 
	`__nÚnuÎ
 ((2));

837 
	$rmdœ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1));

841 
__pid_t
 
	$tcg‘pg½
 (
__fd
è
__THROW
;

844 
	$tc£g½
 (
__fd
, 
__pid_t
 
__pg½_id
è
__THROW
;

851 *
	`g‘logš
 ();

852 #ifdeà
__USE_POSIX199506


859 
	$g‘logš_r
 (*
__Çme
, 
size_t
 
__Çme_Ën
è
	`__nÚnuÎ
 ((1));

862 #ifdef 
__USE_MISC


864 
	$£ogš
 (cÚ¡ *
__Çme
è
__THROW
 
	`__nÚnuÎ
 ((1));

868 #ifdef 
__USE_POSIX2


872 
	~<b™s/g‘İt_posix.h
>

876 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


880 
	$g‘ho¡Çme
 (*
__Çme
, 
size_t
 
__Ën
è
__THROW
 
	`__nÚnuÎ
 ((1));

884 #ià
defšed
 
__USE_MISC


887 
	$£tho¡Çme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

888 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

892 
	$£tho¡id
 (
__id
è
__THROW
 
__wur
;

898 
	$g‘domašÇme
 (*
__Çme
, 
size_t
 
__Ën
)

899 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

900 
	$£tdomašÇme
 (cÚ¡ *
__Çme
, 
size_t
 
__Ën
)

901 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

907 
	$vhªgup
 (è
__THROW
;

910 
	$»voke
 (cÚ¡ *
__fe
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

918 
	$´of
 (*
__§m¶e_bufãr
, 
size_t
 
__size
,

919 
size_t
 
__off£t
, 
__sÿË
)

920 
__THROW
 
	`__nÚnuÎ
 ((1));

926 
	$acù
 (cÚ¡ *
__Çme
è
__THROW
;

930 *
	$g‘u£rsh–l
 (è
__THROW
;

931 
	$’du£rsh–l
 (è
__THROW
;

932 
	$£tu£rsh–l
 (è
__THROW
;

938 
	$d«mÚ
 (
__nochdœ
, 
__noşo£
è
__THROW
 
__wur
;

942 #ià
defšed
 
__USE_MISC
 || (defšed 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K
)

945 
	$chroÙ
 (cÚ¡ *
__·th
è
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

949 *
	$g‘·ss
 (cÚ¡ *
__´om±
è
	`__nÚnuÎ
 ((1));

957 
	`fsync
 (
__fd
);

960 #ifdeà
__USE_GNU


963 
	$syncfs
 (
__fd
è
__THROW
;

967 #ià
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED


970 
	`g‘ho¡id
 ();

973 
	$sync
 (è
__THROW
;

976 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K


979 
	$g‘·gesize
 (è
__THROW
 
	`__©Œibu‹__
 ((
__cÚ¡__
));

984 
	$g‘dbËsize
 (è
__THROW
;

990 #ià
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K8


993 #iâdeà
__USE_FILE_OFFSET64


994 
	$Œunÿ‹
 (cÚ¡ *
__fe
, 
__off_t
 
__Ëngth
)

995 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

997 #ifdeà
__REDIRECT_NTH


998 
	`__REDIRECT_NTH
 (
Œunÿ‹
,

999 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
),

1000 
Œunÿ‹64
è
	`__nÚnuÎ
 ((1)è
__wur
;

1002 
	#Œunÿ‹
 
Œunÿ‹64


	)

1005 #ifdeà
__USE_LARGEFILE64


1006 
	$Œunÿ‹64
 (cÚ¡ *
__fe
, 
__off64_t
 
__Ëngth
)

1007 
__THROW
 
	`__nÚnuÎ
 ((1)è
__wur
;

1012 #ià
defšed
 
__USE_POSIX199309
 \

1013 || 
defšed
 
__USE_XOPEN_EXTENDED
 || defšed 
__USE_XOPEN2K


1016 #iâdeà
__USE_FILE_OFFSET64


1017 
	$árunÿ‹
 (
__fd
, 
__off_t
 
__Ëngth
è
__THROW
 
__wur
;

1019 #ifdeà
__REDIRECT_NTH


1020 
	`__REDIRECT_NTH
 (
árunÿ‹
, (
__fd
, 
__off64_t
 
__Ëngth
),

1021 
árunÿ‹64
è
__wur
;

1023 
	#árunÿ‹
 
árunÿ‹64


	)

1026 #ifdeà
__USE_LARGEFILE64


1027 
	$árunÿ‹64
 (
__fd
, 
__off64_t
 
__Ëngth
è
__THROW
 
__wur
;

1033 #ià(
defšed
 
__USE_XOPEN_EXTENDED
 && !defšed 
__USE_XOPEN2K
) \

1034 || 
defšed
 
__USE_MISC


1038 
	$brk
 (*
__addr
è
__THROW
 
__wur
;

1044 *
	$sbrk
 (
šŒ_t
 
__d–
è
__THROW
;

1048 #ifdeà
__USE_MISC


1059 
	$sysÿÎ
 (
__sy¢o
, ...è
__THROW
;

1064 #ià(
defšed
 
__USE_MISC
 || defšed 
__USE_XOPEN_EXTENDED
è&& !defšed 
F_LOCK


1076 
	#F_ULOCK
 0

	)

1077 
	#F_LOCK
 1

	)

1078 
	#F_TLOCK
 2

	)

1079 
	#F_TEST
 3

	)

1081 #iâdeà
__USE_FILE_OFFSET64


1082 
	$lockf
 (
__fd
, 
__cmd
, 
__off_t
 
__Ën
è
__wur
;

1084 #ifdeà
__REDIRECT


1085 
	`__REDIRECT
 (
lockf
, (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
),

1086 
lockf64
è
__wur
;

1088 
	#lockf
 
lockf64


	)

1091 #ifdeà
__USE_LARGEFILE64


1092 
	$lockf64
 (
__fd
, 
__cmd
, 
__off64_t
 
__Ën
è
__wur
;

1097 #ifdeà
__USE_GNU


1102 
	#TEMP_FAILURE_RETRY
(
ex´essiÚ
) \

1103 (
__ex‹nsiÚ__
 \

1104 ({ 
__»suÉ
; \

1105 dØ
__»suÉ
 = (è(
ex´essiÚ
); \

1106 
__»suÉ
 =ğ-1L && 
”ºo
 =ğ
EINTR
); \

1107 
__»suÉ
; 
	}
}))

	)

1110 #ià
defšed
 
__USE_POSIX199309
 || defšed 
__USE_UNIX98


1113 
fd©async
 (
__fdes
);

1119 #ifdef 
__USE_XOPEN


1121 *
	$üy±
 (cÚ¡ *
__key
, cÚ¡ *
__§É
)

1122 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1126 
	$’üy±
 (*
__glibc_block
, 
__edæag
)

1127 
__THROW
 
	`__nÚnuÎ
 ((1));

1134 
	$swab
 (cÚ¡ *
__»¡riù
 
__äom
, *__»¡riù 
__to
,

1135 
ssize_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1, 2));

1142 #ià
defšed
 
__USE_XOPEN
 && !defšed 
__USE_XOPEN2K


1144 *
	$ù”mid
 (*
__s
è
__THROW
;

1147 *
	`cu£rid
 (*
__s
);

1153 #ià
defšed
 
__USE_UNIX98
 && !defšed 
__USE_XOPEN2K


1154 
	$±h»ad_©fÜk
 ((*
__´•¬e
) (),

1155 (*
__·»Á
) (),

1156 (*
__chd
è()è
__THROW
;

1159 #ifdeà
__USE_MISC


1162 
	$g‘’Œİy
 (*
__bufãr
, 
size_t
 
__Ëngth
è
__wur
;

1166 #ià
__USE_FORTIFY_LEVEL
 > 0 && 
defšed
 
__fÜtify_funùiÚ


1167 
	~<b™s/uni¡d.h
>

1170 
__END_DECLS


	@/usr/include/alloca.h

18 #iâdef 
_ALLOCA_H


19 
	#_ALLOCA_H
 1

	)

21 
	~<ã©u»s.h
>

23 
	#__Ãed_size_t


	)

24 
	~<¡ddef.h
>

26 
	g__BEGIN_DECLS


29 #undeà
®loÿ


32 *
	$®loÿ
 (
size_t
 
__size
è
__THROW
;

34 #ifdef 
__GNUC__


35 
	#®loÿ
(
size
è
	`__butš_®loÿ
 (size)

	)

38 
__END_DECLS


	@/usr/include/endian.h

18 #iâdef 
_ENDIAN_H


19 
	#_ENDIAN_H
 1

	)

21 
	~<ã©u»s.h
>

31 
	#__LITTLE_ENDIAN
 1234

	)

32 
	#__BIG_ENDIAN
 4321

	)

33 
	#__PDP_ENDIAN
 3412

	)

36 
	~<b™s/’dŸn.h
>

40 #iâdeà
__FLOAT_WORD_ORDER


41 
	#__FLOAT_WORD_ORDER
 
__BYTE_ORDER


	)

44 #ifdef 
__USE_MISC


45 
	#LITTLE_ENDIAN
 
__LITTLE_ENDIAN


	)

46 
	#BIG_ENDIAN
 
__BIG_ENDIAN


	)

47 
	#PDP_ENDIAN
 
__PDP_ENDIAN


	)

48 
	#BYTE_ORDER
 
__BYTE_ORDER


	)

51 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


52 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èLO, 
	)
HI

53 #–ià
__BYTE_ORDER
 =ğ
__BIG_ENDIAN


54 
	#__LONG_LONG_PAIR
(
HI
, 
LO
èHI, 
	)
LO

58 #ià
defšed
 
__USE_MISC
 && !defšed 
__ASSEMBLER__


60 
	~<b™s/by‹sw­.h
>

61 
	~<b™s/ušŠ-id’t™y.h
>

63 #ià
__BYTE_ORDER
 =ğ
__LITTLE_ENDIAN


64 
	#htobe16
(
x
è
	`__bsw­_16
 (x)

	)

65 
	#htŞe16
(
x
è
	`__ušt16_id’t™y
 (x)

	)

66 
	#be16toh
(
x
è
	`__bsw­_16
 (x)

	)

67 
	#Ë16toh
(
x
è
	`__ušt16_id’t™y
 (x)

	)

69 
	#htobe32
(
x
è
	`__bsw­_32
 (x)

	)

70 
	#htŞe32
(
x
è
	`__ušt32_id’t™y
 (x)

	)

71 
	#be32toh
(
x
è
	`__bsw­_32
 (x)

	)

72 
	#Ë32toh
(
x
è
	`__ušt32_id’t™y
 (x)

	)

74 
	#htobe64
(
x
è
	`__bsw­_64
 (x)

	)

75 
	#htŞe64
(
x
è
	`__ušt64_id’t™y
 (x)

	)

76 
	#be64toh
(
x
è
	`__bsw­_64
 (x)

	)

77 
	#Ë64toh
(
x
è
	`__ušt64_id’t™y
 (x)

	)

80 
	#htobe16
(
x
è
	`__ušt16_id’t™y
 (x)

	)

81 
	#htŞe16
(
x
è
	`__bsw­_16
 (x)

	)

82 
	#be16toh
(
x
è
	`__ušt16_id’t™y
 (x)

	)

83 
	#Ë16toh
(
x
è
	`__bsw­_16
 (x)

	)

85 
	#htobe32
(
x
è
	`__ušt32_id’t™y
 (x)

	)

86 
	#htŞe32
(
x
è
	`__bsw­_32
 (x)

	)

87 
	#be32toh
(
x
è
	`__ušt32_id’t™y
 (x)

	)

88 
	#Ë32toh
(
x
è
	`__bsw­_32
 (x)

	)

90 
	#htobe64
(
x
è
	`__ušt64_id’t™y
 (x)

	)

91 
	#htŞe64
(
x
è
	`__bsw­_64
 (x)

	)

92 
	#be64toh
(
x
è
	`__ušt64_id’t™y
 (x)

	)

93 
	#Ë64toh
(
x
è
	`__bsw­_64
 (x)

	)

	@/usr/include/features.h

18 #iâdef 
_FEATURES_H


19 
	#_FEATURES_H
 1

	)

118 #undeà
__USE_ISOC11


119 #undeà
__USE_ISOC99


120 #undeà
__USE_ISOC95


121 #undeà
__USE_ISOCXX11


122 #undeà
__USE_POSIX


123 #undeà
__USE_POSIX2


124 #undeà
__USE_POSIX199309


125 #undeà
__USE_POSIX199506


126 #undeà
__USE_XOPEN


127 #undeà
__USE_XOPEN_EXTENDED


128 #undeà
__USE_UNIX98


129 #undeà
__USE_XOPEN2K


130 #undeà
__USE_XOPEN2KXSI


131 #undeà
__USE_XOPEN2K8


132 #undeà
__USE_XOPEN2K8XSI


133 #undeà
__USE_LARGEFILE


134 #undeà
__USE_LARGEFILE64


135 #undeà
__USE_FILE_OFFSET64


136 #undeà
__USE_MISC


137 #undeà
__USE_ATFILE


138 #undeà
__USE_GNU


139 #undeà
__USE_FORTIFY_LEVEL


140 #undeà
__KERNEL_STRICT_NAMES


141 #undeà
__GLIBC_USE_DEPRECATED_GETS


145 #iâdeà
_LOOSE_KERNEL_NAMES


146 
	#__KERNEL_STRICT_NAMES


	)

156 #ià
defšed
 
__GNUC__
 && defšed 
__GNUC_MINOR__


157 
	#__GNUC_PREREQ
(
maj
, 
mš
) \

158 ((
__GNUC__
 << 16è+ 
__GNUC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

160 
	#__GNUC_PREREQ
(
maj
, 
mš
è0

	)

167 #ià
defšed
 
__şªg_majÜ__
 && defšed 
__şªg_mšÜ__


168 
	#__glibc_şªg_´”eq
(
maj
, 
mš
) \

169 ((
__şªg_majÜ__
 << 16è+ 
__şªg_mšÜ__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

171 
	#__glibc_şªg_´”eq
(
maj
, 
mš
è0

	)

175 
	#__GLIBC_USE
(
F
è
__GLIBC_USE_
 ## 
	)
F

181 #ià(
defšed
 
_BSD_SOURCE
 || defšed 
_SVID_SOURCE
) \

182 && !
defšed
 
	g_DEFAULT_SOURCE


184 #undeà
_DEFAULT_SOURCE


185 
	#_DEFAULT_SOURCE
 1

	)

189 #ifdeà
_GNU_SOURCE


190 #undeà
_ISOC95_SOURCE


191 
	#_ISOC95_SOURCE
 1

	)

192 #undeà
_ISOC99_SOURCE


193 
	#_ISOC99_SOURCE
 1

	)

194 #undeà
_ISOC11_SOURCE


195 
	#_ISOC11_SOURCE
 1

	)

196 #undeà
_POSIX_SOURCE


197 
	#_POSIX_SOURCE
 1

	)

198 #undeà
_POSIX_C_SOURCE


199 
	#_POSIX_C_SOURCE
 200809L

	)

200 #undeà
_XOPEN_SOURCE


201 
	#_XOPEN_SOURCE
 700

	)

202 #undeà
_XOPEN_SOURCE_EXTENDED


203 
	#_XOPEN_SOURCE_EXTENDED
 1

	)

204 #undeà
_LARGEFILE64_SOURCE


205 
	#_LARGEFILE64_SOURCE
 1

	)

206 #undeà
_DEFAULT_SOURCE


207 
	#_DEFAULT_SOURCE
 1

	)

208 #undeà
_ATFILE_SOURCE


209 
	#_ATFILE_SOURCE
 1

	)

214 #ià(
defšed
 
_DEFAULT_SOURCE
 \

215 || (!
defšed
 
	g__STRICT_ANSI__
 \

216 && !
defšed
 
	g_ISOC99_SOURCE
 \

217 && !
defšed
 
	g_POSIX_SOURCE
 && !defšed 
	g_POSIX_C_SOURCE
 \

218 && !
defšed
 
	g_XOPEN_SOURCE
))

219 #undeà
_DEFAULT_SOURCE


220 
	#_DEFAULT_SOURCE
 1

	)

224 #ià(
defšed
 
_ISOC11_SOURCE
 \

225 || (
defšed
 
	g__STDC_VERSION__
 && __STDC_VERSION__ >= 201112L))

226 
	#__USE_ISOC11
 1

	)

230 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

231 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199901L))

232 
	#__USE_ISOC99
 1

	)

236 #ià(
defšed
 
_ISOC99_SOURCE
 || defšed 
_ISOC11_SOURCE
 \

237 || (
defšed
 
__STDC_VERSION__
 && __STDC_VERSION__ >= 199409L))

238 
	#__USE_ISOC95
 1

	)

245 #ià((
defšed
 
__ılu¥lus
 && __cplusplus >= 201103L) \

246 || 
defšed
 
__GXX_EXPERIMENTAL_CXX0X__
)

247 
	#__USE_ISOCXX11
 1

	)

253 #ifdeà
_DEFAULT_SOURCE


254 #ià!
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE


255 
	#__USE_POSIX_IMPLICITLY
 1

	)

257 #undeà
_POSIX_SOURCE


258 
	#_POSIX_SOURCE
 1

	)

259 #undeà
_POSIX_C_SOURCE


260 
	#_POSIX_C_SOURCE
 200809L

	)

263 #ià((!
defšed
 
__STRICT_ANSI__
 \

264 || (
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) >= 500)) \

265 && !
defšed
 
_POSIX_SOURCE
 && !defšed 
_POSIX_C_SOURCE
)

266 
	#_POSIX_SOURCE
 1

	)

267 #ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 500

268 
	#_POSIX_C_SOURCE
 2

	)

269 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 600

270 
	#_POSIX_C_SOURCE
 199506L

	)

271 #–ià
defšed
 
_XOPEN_SOURCE
 && (_XOPEN_SOURCE - 0) < 700

272 
	#_POSIX_C_SOURCE
 200112L

	)

274 
	#_POSIX_C_SOURCE
 200809L

	)

276 
	#__USE_POSIX_IMPLICITLY
 1

	)

285 #ià((!
defšed
 
_POSIX_C_SOURCE
 || (_POSIX_C_SOURCE - 0) < 199506L) \

286 && (
defšed
 
_REENTRANT
 || defšed 
_THREAD_SAFE
))

287 
	#_POSIX_SOURCE
 1

	)

288 #undeà
_POSIX_C_SOURCE


289 
	#_POSIX_C_SOURCE
 199506L

	)

292 #ià(
defšed
 
_POSIX_SOURCE
 \

293 || (
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >= 1) \

294 || 
defšed
 
_XOPEN_SOURCE
)

295 
	#__USE_POSIX
 1

	)

298 #ià
defšed
 
_POSIX_C_SOURCE
 && _POSIX_C_SOURCE >ğ2 || defšed 
_XOPEN_SOURCE


299 
	#__USE_POSIX2
 1

	)

302 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199309L

303 
	#__USE_POSIX199309
 1

	)

306 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 199506L

307 
	#__USE_POSIX199506
 1

	)

310 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200112L

311 
	#__USE_XOPEN2K
 1

	)

312 #undeà
__USE_ISOC95


313 
	#__USE_ISOC95
 1

	)

314 #undeà
__USE_ISOC99


315 
	#__USE_ISOC99
 1

	)

318 #ià
defšed
 
_POSIX_C_SOURCE
 && (_POSIX_C_SOURCE - 0) >= 200809L

319 
	#__USE_XOPEN2K8
 1

	)

320 #undeà
_ATFILE_SOURCE


321 
	#_ATFILE_SOURCE
 1

	)

324 #ifdef 
_XOPEN_SOURCE


325 
	#__USE_XOPEN
 1

	)

326 #ià(
_XOPEN_SOURCE
 - 0) >= 500

327 
	#__USE_XOPEN_EXTENDED
 1

	)

328 
	#__USE_UNIX98
 1

	)

329 #undeà
_LARGEFILE_SOURCE


330 
	#_LARGEFILE_SOURCE
 1

	)

331 #ià(
_XOPEN_SOURCE
 - 0) >= 600

332 #ià(
_XOPEN_SOURCE
 - 0) >= 700

333 
	#__USE_XOPEN2K8
 1

	)

334 
	#__USE_XOPEN2K8XSI
 1

	)

336 
	#__USE_XOPEN2K
 1

	)

337 
	#__USE_XOPEN2KXSI
 1

	)

338 #undeà
__USE_ISOC95


339 
	#__USE_ISOC95
 1

	)

340 #undeà
__USE_ISOC99


341 
	#__USE_ISOC99
 1

	)

344 #ifdeà
_XOPEN_SOURCE_EXTENDED


345 
	#__USE_XOPEN_EXTENDED
 1

	)

350 #ifdeà
_LARGEFILE_SOURCE


351 
	#__USE_LARGEFILE
 1

	)

354 #ifdeà
_LARGEFILE64_SOURCE


355 
	#__USE_LARGEFILE64
 1

	)

358 #ià
defšed
 
_FILE_OFFSET_BITS
 && _FILE_OFFSET_BITS == 64

359 
	#__USE_FILE_OFFSET64
 1

	)

362 #ià
defšed
 
_DEFAULT_SOURCE


363 
	#__USE_MISC
 1

	)

366 #ifdef 
_ATFILE_SOURCE


367 
	#__USE_ATFILE
 1

	)

370 #ifdef 
_GNU_SOURCE


371 
	#__USE_GNU
 1

	)

374 #ià
defšed
 
_FORTIFY_SOURCE
 && _FORTIFY_SOURCE > 0 \

375 && 
__GNUC_PREREQ
 (4, 1è&& 
defšed
 
	g__OPTIMIZE__
 && __OPTIMIZE__ > 0

376 #ià
_FORTIFY_SOURCE
 > 1

377 
	#__USE_FORTIFY_LEVEL
 2

	)

379 
	#__USE_FORTIFY_LEVEL
 1

	)

382 
	#__USE_FORTIFY_LEVEL
 0

	)

389 #ià
defšed
 
__ılu¥lus
 ? __ılu¥lu >ğ201402L : defšed 
__USE_ISOC11


390 
	#__GLIBC_USE_DEPRECATED_GETS
 0

	)

392 
	#__GLIBC_USE_DEPRECATED_GETS
 1

	)

397 
	~<¡dc-´edef.h
>

405 #undeà
__GNU_LIBRARY__


406 
	#__GNU_LIBRARY__
 6

	)

410 
	#__GLIBC__
 2

	)

411 
	#__GLIBC_MINOR__
 26

	)

413 
	#__GLIBC_PREREQ
(
maj
, 
mš
) \

414 ((
__GLIBC__
 << 16è+ 
__GLIBC_MINOR__
 >ğ((
maj
è<< 16è+ (
mš
))

	)

417 #iâdeà
__ASSEMBLER__


418 #iâdeà
_SYS_CDEFS_H


419 
	~<sys/cdefs.h
>

424 #ià
defšed
 
__USE_FILE_OFFSET64
 && !defšed 
__REDIRECT


425 
	#__USE_LARGEFILE
 1

	)

426 
	#__USE_LARGEFILE64
 1

	)

432 #ià
__GNUC_PREREQ
 (2, 7è&& 
defšed
 
__OPTIMIZE__
 \

433 && !
defšed
 
	g__OPTIMIZE_SIZE__
 && !defšed 
	g__NO_INLINE__
 \

434 && 
defšed
 
	g__ex‹º_šlše


435 
	#__USE_EXTERN_INLINES
 1

	)

443 
	~<gnu/¡ubs.h
>

	@/usr/include/libio.h

28 #iâdeà
_IO_STDIO_H


29 
	#_IO_STDIO_H


	)

31 
	~<_G_cÚfig.h
>

33 
	#_IO_åos_t
 
_G_åos_t


	)

34 
	#_IO_åos64_t
 
_G_åos64_t


	)

35 
	#_IO_size_t
 
size_t


	)

36 
	#_IO_ssize_t
 
__ssize_t


	)

37 
	#_IO_off_t
 
__off_t


	)

38 
	#_IO_off64_t
 
__off64_t


	)

39 
	#_IO_pid_t
 
__pid_t


	)

40 
	#_IO_uid_t
 
__uid_t


	)

41 
	#_IO_icÚv_t
 
_G_icÚv_t


	)

42 
	#_IO_HAVE_ST_BLKSIZE
 
_G_HAVE_ST_BLKSIZE


	)

43 
	#_IO_BUFSIZ
 
_G_BUFSIZ


	)

44 
	#_IO_va_li¡
 
_G_va_li¡


	)

45 
	#_IO_wšt_t
 
wšt_t


	)

48 
	#__Ãed___va_li¡


	)

49 
	~<¡d¬g.h
>

50 #ifdeà
__GNUC_VA_LIST


51 #undeà
_IO_va_li¡


52 
	#_IO_va_li¡
 
__gnuc_va_li¡


	)

55 #iâdeà
__P


56 
	~<sys/cdefs.h
>

59 
	#_IO_UNIFIED_JUMPTABLES
 1

	)

61 #iâdeà
EOF


62 
	#EOF
 (-1)

	)

64 #iâdeà
NULL


65 #ià
defšed
 
__GNUG__
 && \

66 (
	g__GNUC__
 > 2 || (__GNUC__ =ğ2 && 
__GNUC_MINOR__
 >= 8))

67 
	#NULL
 (
__nuÎ
)

	)

69 #ià!
defšed
(
__ılu¥lus
)

70 
	#NULL
 ((*)0)

	)

72 
	#NULL
 (0)

	)

77 
	#_IOS_INPUT
 1

	)

78 
	#_IOS_OUTPUT
 2

	)

79 
	#_IOS_ATEND
 4

	)

80 
	#_IOS_APPEND
 8

	)

81 
	#_IOS_TRUNC
 16

	)

82 
	#_IOS_NOCREATE
 32

	)

83 
	#_IOS_NOREPLACE
 64

	)

84 
	#_IOS_BIN
 128

	)

92 
	#_IO_MAGIC
 0xFBAD0000

	)

93 
	#_OLD_STDIO_MAGIC
 0xFABC0000

	)

94 
	#_IO_MAGIC_MASK
 0xFFFF0000

	)

95 
	#_IO_USER_BUF
 1

	)

96 
	#_IO_UNBUFFERED
 2

	)

97 
	#_IO_NO_READS
 4

	)

98 
	#_IO_NO_WRITES
 8

	)

99 
	#_IO_EOF_SEEN
 0x10

	)

100 
	#_IO_ERR_SEEN
 0x20

	)

101 
	#_IO_DELETE_DONT_CLOSE
 0x40

	)

102 
	#_IO_LINKED
 0x80

	)

103 
	#_IO_IN_BACKUP
 0x100

	)

104 
	#_IO_LINE_BUF
 0x200

	)

105 
	#_IO_TIED_PUT_GET
 0x400

	)

106 
	#_IO_CURRENTLY_PUTTING
 0x800

	)

107 
	#_IO_IS_APPENDING
 0x1000

	)

108 
	#_IO_IS_FILEBUF
 0x2000

	)

109 
	#_IO_BAD_SEEN
 0x4000

	)

110 
	#_IO_USER_LOCK
 0x8000

	)

112 
	#_IO_FLAGS2_MMAP
 1

	)

113 
	#_IO_FLAGS2_NOTCANCEL
 2

	)

114 #ifdeà
_LIBC


115 
	#_IO_FLAGS2_FORTIFY
 4

	)

117 
	#_IO_FLAGS2_USER_WBUF
 8

	)

118 #ifdeà
_LIBC


119 
	#_IO_FLAGS2_SCANF_STD
 16

	)

120 
	#_IO_FLAGS2_NOCLOSE
 32

	)

121 
	#_IO_FLAGS2_CLOEXEC
 64

	)

122 
	#_IO_FLAGS2_NEED_LOCK
 128

	)

126 
	#_IO_SKIPWS
 01

	)

127 
	#_IO_LEFT
 02

	)

128 
	#_IO_RIGHT
 04

	)

129 
	#_IO_INTERNAL
 010

	)

130 
	#_IO_DEC
 020

	)

131 
	#_IO_OCT
 040

	)

132 
	#_IO_HEX
 0100

	)

133 
	#_IO_SHOWBASE
 0200

	)

134 
	#_IO_SHOWPOINT
 0400

	)

135 
	#_IO_UPPERCASE
 01000

	)

136 
	#_IO_SHOWPOS
 02000

	)

137 
	#_IO_SCIENTIFIC
 04000

	)

138 
	#_IO_FIXED
 010000

	)

139 
	#_IO_UNITBUF
 020000

	)

140 
	#_IO_STDIO
 040000

	)

141 
	#_IO_DONT_CLOSE
 0100000

	)

142 
	#_IO_BOOLALPHA
 0200000

	)

145 
_IO_jump_t
; 
	g_IO_FILE
;

149 #iâdeà
_IO_lock_t_defšed


150 
	t_IO_lock_t
;

156 
	s_IO_m¬k”
 {

157 
_IO_m¬k”
 *
	m_Ãxt
;

158 
_IO_FILE
 *
	m_sbuf
;

162 
	m_pos
;

164 
£t_¡»ampos
(
¡»ampos
 
¥
è{ 
	m_¥os
 = sp; }

165 
£t_off£t
(
off£t
è{ 
	m_pos
 = off£t; 
	m_¥os
 = (
¡»ampos
)(-2); }

166 
	mpublic
:

167 
¡»amm¬k”
(
¡»ambuf
 *
sb
);

168 ~
¡»amm¬k”
();

169 
§všg
(è{  
	m_¥os
 == -2; }

170 
d–
(
¡»amm¬k”
&);

171 
d–
();

176 
	e__codecvt_»suÉ


178 
	m__codecvt_ok
,

179 
	m__codecvt_·¹Ÿl
,

180 
	m__codecvt_”rÜ
,

181 
	m__codecvt_nocÚv


184 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


187 
	s_IO_codecvt


189 (*
	m__codecvt_de¡r
è(
	m_IO_codecvt
 *);

190 
__codecvt_»suÉ
 (*
__codecvt_do_out
è(
	m_IO_codecvt
 *,

191 
	m__mb¡©e_t
 *,

192 cÚ¡ 
	mwch¬_t
 *,

193 cÚ¡ 
	mwch¬_t
 *,

194 cÚ¡ 
	mwch¬_t
 **, *,

196 
__codecvt_»suÉ
 (*
__codecvt_do_unshiá
è(
	m_IO_codecvt
 *,

197 
	m__mb¡©e_t
 *, *,

199 
__codecvt_»suÉ
 (*
__codecvt_do_š
è(
	m_IO_codecvt
 *,

200 
	m__mb¡©e_t
 *,

202 cÚ¡ **, 
	mwch¬_t
 *,

203 
	mwch¬_t
 *, wchar_t **);

204 (*
	m__codecvt_do_’codšg
è(
	m_IO_codecvt
 *);

205 (*
	m__codecvt_do_®ways_nocÚv
è(
	m_IO_codecvt
 *);

206 (*
	m__codecvt_do_Ëngth
è(
	m_IO_codecvt
 *, 
	m__mb¡©e_t
 *,

207 cÚ¡ *, cÚ¡ *, 
	m_IO_size_t
);

208 (*
	m__codecvt_do_max_Ëngth
è(
	m_IO_codecvt
 *);

210 
_IO_icÚv_t
 
	m__cd_š
;

211 
_IO_icÚv_t
 
	m__cd_out
;

215 
	s_IO_wide_d©a


217 
wch¬_t
 *
	m_IO_»ad_±r
;

218 
wch¬_t
 *
	m_IO_»ad_’d
;

219 
wch¬_t
 *
	m_IO_»ad_ba£
;

220 
wch¬_t
 *
	m_IO_wr™e_ba£
;

221 
wch¬_t
 *
	m_IO_wr™e_±r
;

222 
wch¬_t
 *
	m_IO_wr™e_’d
;

223 
wch¬_t
 *
	m_IO_buf_ba£
;

224 
wch¬_t
 *
	m_IO_buf_’d
;

226 
wch¬_t
 *
	m_IO_§ve_ba£
;

227 
wch¬_t
 *
	m_IO_backup_ba£
;

229 
wch¬_t
 *
	m_IO_§ve_’d
;

231 
__mb¡©e_t
 
	m_IO_¡©e
;

232 
__mb¡©e_t
 
	m_IO_Ï¡_¡©e
;

233 
_IO_codecvt
 
	m_codecvt
;

235 
wch¬_t
 
	m_shÜtbuf
[1];

237 cÚ¡ 
_IO_jump_t
 *
	m_wide_vbË
;

241 
	s_IO_FILE
 {

242 
	m_æags
;

243 
	#_IO_fe_æags
 
_æags


	)

247 * 
	m_IO_»ad_±r
;

248 * 
	m_IO_»ad_’d
;

249 * 
	m_IO_»ad_ba£
;

250 * 
	m_IO_wr™e_ba£
;

251 * 
	m_IO_wr™e_±r
;

252 * 
	m_IO_wr™e_’d
;

253 * 
	m_IO_buf_ba£
;

254 * 
	m_IO_buf_’d
;

256 *
	m_IO_§ve_ba£
;

257 *
	m_IO_backup_ba£
;

258 *
	m_IO_§ve_’d
;

260 
_IO_m¬k”
 *
	m_m¬k”s
;

262 
_IO_FILE
 *
	m_chaš
;

264 
	m_f’o
;

266 
	m_blksize
;

268 
	m_æags2
;

270 
_IO_off_t
 
	m_Şd_off£t
;

272 
	#__HAVE_COLUMN


	)

274 
	m_cur_cŞumn
;

275 sigÃd 
	m_vbË_off£t
;

276 
	m_shÜtbuf
[1];

280 
_IO_lock_t
 *
	m_lock
;

281 #ifdeà
_IO_USE_OLD_IO_FILE


284 
	s_IO_FILE_com¶‘e


286 
_IO_FILE
 
	m_fe
;

288 #ià
defšed
 
_G_IO_IO_FILE_VERSION
 && _G_IO_IO_FILE_VERSION == 0x20001

289 
_IO_off64_t
 
	m_off£t
;

290 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


292 
_IO_codecvt
 *
	m_codecvt
;

293 
_IO_wide_d©a
 *
	m_wide_d©a
;

294 
_IO_FILE
 *
	m_ä“»s_li¡
;

295 *
	m_ä“»s_buf
;

297 *
	m__·d1
;

298 *
	m__·d2
;

299 *
	m__·d3
;

300 *
	m__·d4
;

302 
size_t
 
	m__·d5
;

303 
	m_mode
;

305 
	m_unu£d2
[15 *  (è- 4 *  (*è-  (
size_t
)];

309 #iâdeà
__ılu¥lus


310 
_IO_FILE
 
	t_IO_FILE
;

313 
	g_IO_FILE_¶us
;

315 
_IO_FILE_¶us
 
_IO_2_1_¡dš_
;

316 
_IO_FILE_¶us
 
_IO_2_1_¡dout_
;

317 
_IO_FILE_¶us
 
_IO_2_1_¡d”r_
;

318 #iâdeà
_LIBC


319 
	#_IO_¡dš
 ((
_IO_FILE
*)(&
_IO_2_1_¡dš_
))

	)

320 
	#_IO_¡dout
 ((
_IO_FILE
*)(&
_IO_2_1_¡dout_
))

	)

321 
	#_IO_¡d”r
 ((
_IO_FILE
*)(&
_IO_2_1_¡d”r_
))

	)

323 
_IO_FILE
 *
_IO_¡dš
 
©Œibu‹_hidd’
;

324 
_IO_FILE
 *
_IO_¡dout
 
©Œibu‹_hidd’
;

325 
_IO_FILE
 *
_IO_¡d”r
 
©Œibu‹_hidd’
;

333 
__ssize_t
 
	t__io_»ad_â
 (*
	t__cook›
, *
	t__buf
, 
	tsize_t
 
	t__nby‹s
);

341 
__ssize_t
 
	t__io_wr™e_â
 (*
	t__cook›
, cÚ¡ *
	t__buf
,

342 
	tsize_t
 
	t__n
);

350 
	t__io_£ek_â
 (*
	t__cook›
, 
	t_IO_off64_t
 *
	t__pos
, 
	t__w
);

353 
	t__io_şo£_â
 (*
	t__cook›
);

356 #ifdeà
__USE_GNU


358 
__io_»ad_â
 
	tcook›_»ad_funùiÚ_t
;

359 
__io_wr™e_â
 
	tcook›_wr™e_funùiÚ_t
;

360 
__io_£ek_â
 
	tcook›_£ek_funùiÚ_t
;

361 
__io_şo£_â
 
	tcook›_şo£_funùiÚ_t
;

366 
__io_»ad_â
 *
	m»ad
;

367 
__io_wr™e_â
 *
	mwr™e
;

368 
__io_£ek_â
 *
	m£ek
;

369 
__io_şo£_â
 *
	mşo£
;

370 } 
	t_IO_cook›_io_funùiÚs_t
;

371 
_IO_cook›_io_funùiÚs_t
 
	tcook›_io_funùiÚs_t
;

373 
	g_IO_cook›_fe
;

376 
_IO_cook›_š™
 (
_IO_cook›_fe
 *
__cfe
, 
__»ad_wr™e
,

377 *
__cook›
, 
_IO_cook›_io_funùiÚs_t
 
__âs
);

381 #ifdeà
__ılu¥lus


385 
__und”æow
 (
_IO_FILE
 *);

386 
__uæow
 (
_IO_FILE
 *);

387 
__ov”æow
 (
_IO_FILE
 *, );

388 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


389 
_IO_wšt_t
 
__wund”æow
 (
_IO_FILE
 *);

390 
_IO_wšt_t
 
__wuæow
 (
_IO_FILE
 *);

391 
_IO_wšt_t
 
__wov”æow
 (
_IO_FILE
 *, _IO_wint_t);

394 #ià 
__GNUC__
 >= 3

395 
	#_IO_BE
(
ex´
, 
»s
è
	`__butš_ex³ù
 (Óx´),„es)

	)

397 
	#_IO_BE
(
ex´
, 
»s
èÓx´)

	)

400 
	#_IO_g‘c_uÆocked
(
_å
) \

401 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

402 ? 
	`__uæow
 (
_å
è: *(*è(_å)->
_IO_»ad_±r
++)

	)

403 
	#_IO_³ekc_uÆocked
(
_å
) \

404 (
	`_IO_BE
 ((
_å
)->
_IO_»ad_±r
 >ğ(_å)->
_IO_»ad_’d
, 0) \

405 && 
	`__und”æow
 (
_å
è=ğ
EOF
 ? EOF \

406 : *(*è(
_å
)->
_IO_»ad_±r
)

	)

407 
	#_IO_putc_uÆocked
(
_ch
, 
_å
) \

408 (
	`_IO_BE
 ((
_å
)->
_IO_wr™e_±r
 >ğ(_å)->
_IO_wr™e_’d
, 0) \

409 ? 
	`__ov”æow
 (
_å
, (è(
_ch
)) \

410 : (è(*(
_å
)->
_IO_wr™e_±r
++ = (
_ch
)))

	)

412 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


413 
	#_IO_g‘wc_uÆocked
(
_å
) \

414 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

415 || ((
_å
)->
_wide_d©a
->
_IO_»ad_±r
 \

416 >ğ(
_å
)->
_wide_d©a
->
_IO_»ad_’d
), 0) \

417 ? 
	`__wuæow
 (
_å
è: (
_IO_wšt_t
è*(_å)->
_wide_d©a
->
_IO_»ad_±r
++)

	)

418 
	#_IO_putwc_uÆocked
(
_wch
, 
_å
) \

419 (
	`_IO_BE
 ((
_å
)->
_wide_d©a
 =ğ
NULL
 \

420 || ((
_å
)->
_wide_d©a
->
_IO_wr™e_±r
 \

421 >ğ(
_å
)->
_wide_d©a
->
_IO_wr™e_’d
), 0) \

422 ? 
	`__wov”æow
 (
_å
, 
_wch
) \

423 : (
_IO_wšt_t
è(*(
_å
)->
_wide_d©a
->
_IO_wr™e_±r
++ = (
_wch
)))

	)

426 
	#_IO_ãof_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_EOF_SEEN
è!ğ0)

	)

427 
	#_IO_ã¼Ü_uÆocked
(
__å
è(((__å)->
_æags
 & 
_IO_ERR_SEEN
è!ğ0)

	)

429 
_IO_g‘c
 (
_IO_FILE
 *
__å
);

430 
_IO_putc
 (
__c
, 
_IO_FILE
 *
__å
);

431 
_IO_ãof
 (
_IO_FILE
 *
__å
è
__THROW
;

432 
_IO_ã¼Ü
 (
_IO_FILE
 *
__å
è
__THROW
;

434 
_IO_³ekc_locked
 (
_IO_FILE
 *
__å
);

437 
	#_IO_PENDING_OUTPUT_COUNT
(
_å
) \

438 ((
_å
)->
_IO_wr™e_±r
 - (_å)->
_IO_wr™e_ba£
)

	)

440 
_IO_æockfe
 (
_IO_FILE
 *è
__THROW
;

441 
_IO_fuÆockfe
 (
_IO_FILE
 *è
__THROW
;

442 
_IO_árylockfe
 (
_IO_FILE
 *è
__THROW
;

444 
	#_IO_³ekc
(
_å
è
	`_IO_³ekc_uÆocked
 (_å)

	)

445 
	#_IO_æockfe
(
_å
è

	)

446 
	#_IO_fuÆockfe
(
_å
è

	)

447 
	#_IO_árylockfe
(
_å
è

	)

448 #iâdeà
_IO_ş—nup_»giÚ_¡¬t


449 
	#_IO_ş—nup_»giÚ_¡¬t
(
_fù
, 
_å
è

	)

451 #iâdeà
_IO_ş—nup_»giÚ_’d


452 
	#_IO_ş—nup_»giÚ_’d
(
_Do™
è

	)

455 
	#_IO_Ãed_lock
(
_å
) \

456 (((
_å
)->
_æags2
 & 
_IO_FLAGS2_NEED_LOCK
è!ğ0)

	)

458 
_IO_vfsÿnf
 (
_IO_FILE
 * 
__»¡riù
, const * __restrict,

459 
_IO_va_li¡
, *
__»¡riù
);

460 
_IO_vårštf
 (
_IO_FILE
 *
__»¡riù
, const *__restrict,

461 
_IO_va_li¡
);

462 
_IO_ssize_t
 
_IO_·dn
 (
_IO_FILE
 *, , _IO_ssize_t);

463 
_IO_size_t
 
_IO_sg‘n
 (
_IO_FILE
 *, *, _IO_size_t);

465 
_IO_off64_t
 
_IO_£ekoff
 (
_IO_FILE
 *, _IO_off64_t, , );

466 
_IO_off64_t
 
_IO_£ekpos
 (
_IO_FILE
 *, _IO_off64_t, );

468 
_IO_ä“_backup_¬—
 (
_IO_FILE
 *è
__THROW
;

470 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


471 
_IO_wšt_t
 
_IO_g‘wc
 (
_IO_FILE
 *
__å
);

472 
_IO_wšt_t
 
_IO_putwc
 (
wch¬_t
 
__wc
, 
_IO_FILE
 *
__å
);

473 
_IO_fwide
 (
_IO_FILE
 *
__å
, 
__mode
è
__THROW
;

474 #ià
__GNUC__
 >= 2

477 #ià
defšed
 
_LIBC
 && defšed 
SHARED


478 
	~<shlib-com·t.h
>

479 #ià
SHLIB_COMPAT
 (
libc
, 
GLIBC_2_0
, 
GLIBC_2_1
)

480 
	#_IO_fwide_maybe_šcom·tibË
 \

481 (
	`__butš_ex³ù
 (&
_IO_¡dš_u£d
 =ğ
NULL
, 0))

	)

482 cÚ¡ 
_IO_¡dš_u£d
;

483 
w—k_ex‹º
 (
_IO_¡dš_u£d
);

486 #iâdeà
_IO_fwide_maybe_šcom·tibË


487 
	#_IO_fwide_maybe_šcom·tibË
 (0)

	)

491 
	#_IO_fwide
(
__å
, 
__mode
) \

492 ({ 
__»suÉ
 = (
__mode
); \

493 ià(
__»suÉ
 < 0 && ! 
_IO_fwide_maybe_šcom·tibË
) \

495 ià((
__å
)->
_mode
 == 0) \

497 (
__å
)->
_mode
 = -1; \

498 
__»suÉ
 = (
__å
)->
_mode
; \

500 ià(
	`__butš_cÚ¡ªt_p
 (
__mode
) && (__mode) == 0) \

501 
__»suÉ
 = 
_IO_fwide_maybe_šcom·tibË
 ? -1 : (
__å
)->
_mode
; \

503 
__»suÉ
 = 
	`_IO_fwide
 (
__å
, __result); \

504 
__»suÉ
; })

	)

507 
_IO_vfwsÿnf
 (
_IO_FILE
 * 
__»¡riù
, cÚ¡ 
wch¬_t
 * __restrict,

508 
_IO_va_li¡
, *
__»¡riù
);

509 
_IO_vfw´štf
 (
_IO_FILE
 *
__»¡riù
, cÚ¡ 
wch¬_t
 *__restrict,

510 
_IO_va_li¡
);

511 
_IO_ssize_t
 
_IO_w·dn
 (
_IO_FILE
 *, 
wšt_t
, _IO_ssize_t);

512 
_IO_ä“_wbackup_¬—
 (
_IO_FILE
 *è
__THROW
;

515 #ifdeà
__LDBL_COMPAT


516 
	~<b™s/libio-ldbl.h
>

519 #ifdeà
__ılu¥lus


	@/usr/include/readline/keymaps.h

22 #iâdeà
_KEYMAPS_H_


23 
	#_KEYMAPS_H_


	)

25 #ifdeà
__ılu¥lus


29 #ià
defšed
 (
READLINE_LIBRARY
)

30 
	~"¾¡dc.h
"

31 
	~"ch¬defs.h
"

32 
	~"¾ty³defs.h
"

34 
	~<»adlše/¾¡dc.h
>

35 
	~<»adlše/ch¬defs.h
>

36 
	~<»adlše/¾ty³defs.h
>

44 
	s_keym­_’Œy
 {

45 
ty³
;

46 
¾_commªd_func_t
 *
funùiÚ
;

47 } 
	tKEYMAP_ENTRY
;

52 
	#KEYMAP_SIZE
 257

	)

53 
	#ANYOTHERKEY
 
KEYMAP_SIZE
-1

	)

55 
KEYMAP_ENTRY
 
	tKEYMAP_ENTRY_ARRAY
[
KEYMAP_SIZE
];

56 
KEYMAP_ENTRY
 *
	tKeym­
;

59 
	#ISFUNC
 0

	)

60 
	#ISKMAP
 1

	)

61 
	#ISMACR
 2

	)

63 
KEYMAP_ENTRY_ARRAY
 
emacs_¡ªd¬d_keym­
, 
emacs_m‘a_keym­
, 
emacs_ùlx_keym­
;

64 
KEYMAP_ENTRY_ARRAY
 
vi_š£¹iÚ_keym­
, 
vi_movem’t_keym­
;

68 
Keym­
 
¾_make_b¬e_keym­
 
PARAMS
(());

71 
Keym­
 
¾_cİy_keym­
 
PARAMS
((Keymap));

76 
Keym­
 
¾_make_keym­
 
PARAMS
(());

79 
¾_disÿrd_keym­
 
PARAMS
((
Keym­
));

85 
Keym­
 
¾_g‘_keym­_by_Çme
 
PARAMS
((const *));

88 
Keym­
 
¾_g‘_keym­
 
PARAMS
(());

91 
¾_£t_keym­
 
PARAMS
((
Keym­
));

93 #ifdeà
__ılu¥lus


	@/usr/include/readline/rlstdc.h

22 #ià!
defšed
 (
_RL_STDC_H_
)

23 
	#_RL_STDC_H_


	)

31 #ià!
defšed
 (
PARAMS
)

32 #ià
defšed
 (
__STDC__
è|| defšed (
__GNUC__
è|| defšed (
__ılu¥lus
)

33 
	#PARAMS
(
´Ùos
è
	)
protos

35 
	#PARAMS
(
´Ùos
è()

	)

39 #ià
defšed
(
__GNUC__
) && __GNUC__ >= 2

40 
	#__¾_©Œibu‹__
(
x
è
	`__©Œibu‹__
(x)

	)

42 
	#__¾_©Œibu‹__
(
x
)

	)

47 #ià
defšed
 (
__STDC__
è&& defšed (
HAVE_STDARG_H
)

48 
	#PREFER_STDARG


	)

49 
	#USE_VARARGS


	)

51 #ià
defšed
 (
HAVE_VARARGS_H
)

52 
	#PREFER_VARARGS


	)

53 
	#USE_VARARGS


	)

	@/usr/include/readline/rltypedefs.h

22 #iâdeà
_RL_TYPEDEFS_H_


23 
	#_RL_TYPEDEFS_H_


	)

25 #ifdeà
__ılu¥lus


31 #ià!
defšed
 (
_FUNCTION_DEF
)

32 
	#_FUNCTION_DEF


	)

34 #ià
defšed
(
__GNUC__
è|| defšed(
__şªg__
)

35 
	tFunùiÚ
 (è
	t__©Œibu‹__
 ((
	td•»ÿ‹d
));

36 
	tVFunùiÚ
 (è
	t__©Œibu‹__
 ((
	td•»ÿ‹d
));

37 *
	tCPFunùiÚ
 (è
	t__©Œibu‹__
 ((
	td•»ÿ‹d
));

38 **
	tCPPFunùiÚ
 (è
	t__©Œibu‹__
 ((
	td•»ÿ‹d
));

40 
	tFunùiÚ
 ();

41 
	tVFunùiÚ
 ();

42 *
	tCPFunùiÚ
 ();

43 **
	tCPPFunùiÚ
 ();

50 #ià!
	`defšed
 (
_RL_FUNCTION_TYPEDEF
)

51 
	#_RL_FUNCTION_TYPEDEF


	)

54 
	t¾_commªd_func_t
 
	tPARAMS
((, ));

57 *
	t¾_com³Áry_func_t
 
	tPARAMS
((const *, ));

58 **
	t¾_com¶‘iÚ_func_t
 
	tPARAMS
((const *, , ));

60 *
	t¾_quÙe_func_t
 
	tPARAMS
((*, , *));

61 *
	t¾_dequÙe_func_t
 
	tPARAMS
((*, ));

63 
	t¾_compignÜe_func_t
 
	tPARAMS
((**));

65 
	t¾_compdi¥_func_t
 
	tPARAMS
((**, , ));

68 
	t¾_hook_func_t
 
	tPARAMS
(());

71 
	t¾_g‘c_func_t
 
	tPARAMS
((
	tFILE
 *));

76 
	t¾_lšebuf_func_t
 
	tPARAMS
((*, ));

79 
	t¾_štfunc_t
 
	tPARAMS
(());

80 
	#¾_ivoidfunc_t
 
¾_hook_func_t


	)

81 
	t¾_iıfunc_t
 
	tPARAMS
((*));

82 
	t¾_iıpfunc_t
 
	tPARAMS
((**));

84 
	t¾_voidfunc_t
 
	tPARAMS
(());

85 
	t¾_vštfunc_t
 
	tPARAMS
(());

86 
	t¾_vıfunc_t
 
	tPARAMS
((*));

87 
	t¾_vıpfunc_t
 
	tPARAMS
((**));

89 *
	t¾_ıvfunc_t
 
	tPARAMS
(());

90 *
	t¾_ıifunc_t
 
	tPARAMS
(());

91 *
	t¾_ııfunc_t
 
	tPARAMS
((*));

92 *
	t¾_ııpfunc_t
 
	tPARAMS
((**));

96 #ifdeà
__ılu¥lus


97 
	}
}

	@/usr/include/readline/tilde.h

23 #ià!
defšed
 (
_TILDE_H_
)

24 
	#_TILDE_H_


	)

26 #ifdeà
__ılu¥lus


34 #ià!
defšed
 (
PARAMS
)

35 #ià
defšed
 (
__STDC__
è|| defšed (
__GNUC__
è|| defšed (
__ılu¥lus
)

36 
	#PARAMS
(
´Ùos
è
	)
protos

38 
	#PARAMS
(
´Ùos
è()

	)

42 *
	ttde_hook_func_t
 
	tPARAMS
((*));

48 
tde_hook_func_t
 *
tde_ex·nsiÚ_´“x·nsiÚ_hook
;

54 
tde_hook_func_t
 *
tde_ex·nsiÚ_çu»_hook
;

59 **
tde_add™iÚ®_´efixes
;

64 **
tde_add™iÚ®_suffixes
;

67 *
tde_ex·nd
 
PARAMS
((const *));

71 *
tde_ex·nd_wÜd
 
PARAMS
((const *));

74 *
tde_fšd_wÜd
 
PARAMS
((const *, , *));

76 #ifdeà
__ılu¥lus


	@/usr/include/rpc/netdb.h

36 #iâdeà
_RPC_NETDB_H


37 
	#_RPC_NETDB_H
 1

	)

39 
	~<ã©u»s.h
>

41 
	#__Ãed_size_t


	)

42 
	~<¡ddef.h
>

44 
__BEGIN_DECLS


46 
	s½ûÁ


48 *
	mr_Çme
;

49 **
	mr_®Ÿ£s
;

50 
	mr_numb”
;

53 
	$£ŒpûÁ
 (
__¡ayİ’
è
__THROW
;

54 
	$’d½ûÁ
 (è
__THROW
;

55 
½ûÁ
 *
	$g‘½cbyÇme
 (cÚ¡ *
__Çme
è
__THROW
;

56 
½ûÁ
 *
	$g‘½cbynumb”
 (
__numb”
è
__THROW
;

57 
½ûÁ
 *
	$g‘½ûÁ
 (è
__THROW
;

59 #ifdeà
__USE_MISC


60 
	$g‘½cbyÇme_r
 (cÚ¡ *
__Çme
, 
½ûÁ
 *
__»suÉ_buf
,

61 *
__bufãr
, 
size_t
 
__buæ’
,

62 
½ûÁ
 **
__»suÉ
è
__THROW
;

64 
	$g‘½cbynumb”_r
 (
__numb”
, 
½ûÁ
 *
__»suÉ_buf
,

65 *
__bufãr
, 
size_t
 
__buæ’
,

66 
½ûÁ
 **
__»suÉ
è
__THROW
;

68 
	$g‘½ûÁ_r
 (
½ûÁ
 *
__»suÉ_buf
, *
__bufãr
,

69 
size_t
 
__buæ’
, 
½ûÁ
 **
__»suÉ
è
__THROW
;

72 
__END_DECLS


	@/usr/include/sched.h

19 #iâdef 
_SCHED_H


20 
	#_SCHED_H
 1

	)

22 
	~<ã©u»s.h
>

25 
	~<b™s/ty³s.h
>

27 
	#__Ãed_size_t


	)

28 
	#__Ãed_NULL


	)

29 
	~<¡ddef.h
>

31 
	~<b™s/ty³s/time_t.h
>

32 
	~<b™s/ty³s/¡ruù_time¥ec.h
>

33 #iâdeà
__USE_XOPEN2K


34 
	~<time.h
>

37 #iâdeà
__pid_t_defšed


38 
__pid_t
 
	tpid_t
;

39 
	#__pid_t_defšed


	)

43 
	~<b™s/sched.h
>

44 
	~<b™s/ıu-£t.h
>

47 
	#sched_´iÜ™y
 
sched_´iÜ™y


	)

48 
	#__sched_´iÜ™y
 
sched_´iÜ™y


	)

51 
__BEGIN_DECLS


54 
	$sched_£¬am
 (
__pid_t
 
__pid
, cÚ¡ 
sched_·¿m
 *
__·¿m
)

55 
__THROW
;

58 
	$sched_g‘·¿m
 (
__pid_t
 
__pid
, 
sched_·¿m
 *
__·¿m
è
__THROW
;

61 
	$sched_£tscheduËr
 (
__pid_t
 
__pid
, 
__pŞicy
,

62 cÚ¡ 
sched_·¿m
 *
__·¿m
è
__THROW
;

65 
	$sched_g‘scheduËr
 (
__pid_t
 
__pid
è
__THROW
;

68 
	$sched_y›ld
 (è
__THROW
;

71 
	$sched_g‘_´iÜ™y_max
 (
__®gÜ™hm
è
__THROW
;

74 
	$sched_g‘_´iÜ™y_mš
 (
__®gÜ™hm
è
__THROW
;

77 
	$sched_¼_g‘_š‹rv®
 (
__pid_t
 
__pid
, 
time¥ec
 *
__t
è
__THROW
;

80 #ifdeà
__USE_GNU


82 
	#CPU_SETSIZE
 
__CPU_SETSIZE


	)

83 
	#CPU_SET
(
ıu
, 
ıu£
è
	`__CPU_SET_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

84 
	#CPU_CLR
(
ıu
, 
ıu£
è
	`__CPU_CLR_S
 (ıu,  (
ıu_£t_t
), cpu£)

	)

85 
	#CPU_ISSET
(
ıu
, 
ıu£
è
	`__CPU_ISSET_S
 (ıu,  (
ıu_£t_t
), \

86 
ıu£
)

	)

87 
	#CPU_ZERO
(
ıu£
è
	`__CPU_ZERO_S
 ( (
ıu_£t_t
), cpu£)

	)

88 
	#CPU_COUNT
(
ıu£
è
	`__CPU_COUNT_S
 ( (
ıu_£t_t
), cpu£)

	)

90 
	#CPU_SET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_SET_S
 (ıu, s‘size, cpu£)

	)

91 
	#CPU_CLR_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_CLR_S
 (ıu, s‘size, cpu£)

	)

92 
	#CPU_ISSET_S
(
ıu
, 
£tsize
, 
ıu£
è
	`__CPU_ISSET_S
 (cpu, setsize, \

93 
ıu£
)

	)

94 
	#CPU_ZERO_S
(
£tsize
, 
ıu£
è
	`__CPU_ZERO_S
 (£tsize, cpu£)

	)

95 
	#CPU_COUNT_S
(
£tsize
, 
ıu£
è
	`__CPU_COUNT_S
 (£tsize, cpu£)

	)

97 
	#CPU_EQUAL
(
ıu£1
, 
ıu£2
) \

98 
	`__CPU_EQUAL_S
 ( (
ıu_£t_t
), 
ıu£1
, 
ıu£2
)

	)

99 
	#CPU_EQUAL_S
(
£tsize
, 
ıu£1
, 
ıu£2
) \

100 
	`__CPU_EQUAL_S
 (
£tsize
, 
ıu£1
, 
ıu£2
)

	)

102 
	#CPU_AND
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

103 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

104 
	#CPU_OR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

105 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

106 
	#CPU_XOR
(
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

107 
	`__CPU_OP_S
 ( (
ıu_£t_t
), 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

108 
	#CPU_AND_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

109 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, &)

	)

110 
	#CPU_OR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

111 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, |)

	)

112 
	#CPU_XOR_S
(
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
) \

113 
	`__CPU_OP_S
 (
£tsize
, 
de¡£t
, 
¤c£t1
, 
¤c£t2
, ^)

	)

115 
	#CPU_ALLOC_SIZE
(
couÁ
è
	`__CPU_ALLOC_SIZE
 (couÁ)

	)

116 
	#CPU_ALLOC
(
couÁ
è
	`__CPU_ALLOC
 (couÁ)

	)

117 
	#CPU_FREE
(
ıu£t
è
	`__CPU_FREE
 (ıu£t)

	)

121 
	$sched_£ffš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

122 cÚ¡ 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

125 
	$sched_g‘affš™y
 (
__pid_t
 
__pid
, 
size_t
 
__ıu£tsize
,

126 
ıu_£t_t
 *
__ıu£t
è
__THROW
;

129 
__END_DECLS


	@/usr/include/strings.h

18 #iâdef 
_STRINGS_H


19 
	#_STRINGS_H
 1

	)

21 
	~<ã©u»s.h
>

22 
	#__Ãed_size_t


	)

23 
	~<¡ddef.h
>

26 #ià
defšed
 
__ılu¥lus
 && 
__GNUC_PREREQ
 (4, 4)

27 
	#__CORRECT_ISO_CPP_STRINGS_H_PROTO


	)

30 
	g__BEGIN_DECLS


32 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


34 
	$bcmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

35 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

38 
	$bcİy
 (cÚ¡ *
__¤c
, *
__de¡
, 
size_t
 
__n
)

39 
__THROW
 
	`__nÚnuÎ
 ((1, 2));

42 
	$bz”o
 (*
__s
, 
size_t
 
__n
è
__THROW
 
	`__nÚnuÎ
 ((1));

45 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


48 *
	`šdex
 (*
__s
, 
__c
)

49 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

50 cÚ¡ *
	`šdex
 (cÚ¡ *
__s
, 
__c
)

51 
__THROW
 
	`__asm
 ("šdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

53 #ià
defšed
 
__OPTIMIZE__


54 
__ex‹º_®ways_šlše
 *

55 
	`šdex
 (*
__s
, 
__c
è
__THROW


57  
	`__butš_šdex
 (
__s
, 
__c
);

60 
__ex‹º_®ways_šlše
 const *

61 
	`šdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


63  
	`__butš_šdex
 (
__s
, 
__c
);

66 
	}
}

68 *
	$šdex
 (cÚ¡ *
__s
, 
__c
)

69 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

73 #ifdeà
__CORRECT_ISO_CPP_STRINGS_H_PROTO


76 *
	`ršdex
 (*
__s
, 
__c
)

77 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

78 cÚ¡ *
	`ršdex
 (cÚ¡ *
__s
, 
__c
)

79 
__THROW
 
	`__asm
 ("ršdex"è
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

81 #ià
defšed
 
__OPTIMIZE__


82 
__ex‹º_®ways_šlše
 *

83 
	`ršdex
 (*
__s
, 
__c
è
__THROW


85  
	`__butš_ršdex
 (
__s
, 
__c
);

88 
__ex‹º_®ways_šlše
 const *

89 
	`ršdex
 (cÚ¡ *
__s
, 
__c
è
__THROW


91  
	`__butš_ršdex
 (
__s
, 
__c
);

94 
	}
}

96 *
	$ršdex
 (cÚ¡ *
__s
, 
__c
)

97 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1));

101 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8
 || defšed 
__USE_XOPEN2K8XSI


104 
	$ffs
 (
__i
è
__THROW
 
__©Œibu‹_cÚ¡__
;

109 #ifdef 
__USE_GNU


110 
	$ff¦
 (
__l
è
__THROW
 
__©Œibu‹_cÚ¡__
;

111 
__ex‹nsiÚ__
 
	$ff¦l
 (
__Î
)

112 
__THROW
 
__©Œibu‹_cÚ¡__
;

116 
	$¡rÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
)

117 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

120 
	$¡ºÿ£cmp
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
size_t
 
__n
)

121 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2));

123 #ifdef 
__USE_XOPEN2K8


125 
	~<b™s/ty³s/loÿË_t.h
>

128 
	$¡rÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
, 
loÿË_t
 
__loc
)

129 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 3));

133 
	$¡ºÿ£cmp_l
 (cÚ¡ *
__s1
, cÚ¡ *
__s2
,

134 
size_t
 
__n
, 
loÿË_t
 
__loc
)

135 
__THROW
 
__©Œibu‹_pu»__
 
	`__nÚnuÎ
 ((1, 2, 4));

138 
__END_DECLS


140 #ià
	`__GNUC_PREREQ
 (3,4è&& 
__USE_FORTIFY_LEVEL
 > 0 \

141 && 
defšed
 
__fÜtify_funùiÚ


143 #ià
defšed
 
__USE_MISC
 || !defšed 
__USE_XOPEN2K8


144 
	~<b™s/¡ršgs_fÜtif›d.h
>

	@/usr/include/_G_config.h

4 #iâdeà
_G_cÚfig_h


5 
	#_G_cÚfig_h
 1

	)

9 
	~<b™s/ty³s.h
>

10 
	#__Ãed_size_t


	)

11 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


12 
	#__Ãed_wch¬_t


	)

14 
	#__Ãed_NULL


	)

15 
	~<¡ddef.h
>

17 
	~<b™s/ty³s/__mb¡©e_t.h
>

18 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


19 
	~<b™s/ty³s/wšt_t.h
>

24 
__off_t
 
	m__pos
;

25 
__mb¡©e_t
 
	m__¡©e
;

26 } 
	t_G_åos_t
;

29 
__off64_t
 
	m__pos
;

30 
__mb¡©e_t
 
	m__¡©e
;

31 } 
	t_G_åos64_t
;

32 #ià
defšed
 
_LIBC
 || defšed 
_GLIBCPP_USE_WCHAR_T


33 
	~<gcÚv.h
>

36 
__gcÚv_šfo
 
	m__cd
;

39 
__gcÚv_šfo
 
	m__cd
;

40 
__gcÚv_¡•_d©a
 
	m__d©a
;

41 } 
	m__combšed
;

42 } 
	t_G_icÚv_t
;

47 
	#_G_va_li¡
 
__gnuc_va_li¡


	)

49 
	#_G_HAVE_MMAP
 1

	)

50 
	#_G_HAVE_MREMAP
 1

	)

52 
	#_G_IO_IO_FILE_VERSION
 0x20001

	)

55 
	#_G_HAVE_ST_BLKSIZE
 
	`defšed
 (
_STATBUF_ST_BLKSIZE
)

	)

57 
	#_G_BUFSIZ
 8192

	)

	@/usr/include/readline/chardefs.h

22 #iâdeà
_CHARDEFS_H_


23 
	#_CHARDEFS_H_


	)

25 
	~<ùy³.h
>

27 
	~<¡ršg.h
>

29 #iâdeà
wh™e¥aû


30 
	#wh™e¥aû
(
c
è(((cè=ğ' 'è|| ((cè=ğ'\t'))

	)

33 #ifdeà
CTRL


34 #undeà
CTRL


36 #ifdeà
UNCTRL


37 #undeà
UNCTRL


41 
	#cÚŒŞ_ch¬aù”_th»shŞd
 0x020

	)

42 
	#cÚŒŞ_ch¬aù”_mask
 0x1à

	)

43 
	#m‘a_ch¬aù”_th»shŞd
 0x07à

	)

44 
	#cÚŒŞ_ch¬aù”_b™
 0x40

	)

45 
	#m‘a_ch¬aù”_b™
 0x080

	)

46 
	#Ïrge¡_ch¬
 255

	)

48 
	#CTRL_CHAR
(
c
è((cè< 
cÚŒŞ_ch¬aù”_th»shŞd
 && (((cè& 0x80è=ğ0))

	)

49 
	#META_CHAR
(
c
è((cè> 
m‘a_ch¬aù”_th»shŞd
 && (cè<ğ
Ïrge¡_ch¬
)

	)

51 
	#CTRL
(
c
è((cè& 
cÚŒŞ_ch¬aù”_mask
)

	)

52 
	#META
(
c
è((cè| 
m‘a_ch¬aù”_b™
)

	)

54 
	#UNMETA
(
c
è((cè& (~
m‘a_ch¬aù”_b™
))

	)

55 
	#UNCTRL
(
c
è
	`_¾_to_uµ”
(((c)|
cÚŒŞ_ch¬aù”_b™
))

	)

57 #ià
defšed
 
STDC_HEADERS
 || (!defšed (
i§scii
è&& !defšed (
HAVE_ISASCII
))

58 
	#IN_CTYPE_DOMAIN
(
c
è1

	)

60 
	#IN_CTYPE_DOMAIN
(
c
è
	`i§scii
(c)

	)

63 #ià!
defšed
 (
isxdig™
è&& !defšed (
HAVE_ISXDIGIT
è&& !defšed (
__ılu¥lus
)

64 
	#isxdig™
(
c
è(
	`isdig™
(()(c)è|| ((cè>ğ'a' && (cè<ğ'f'è|| ((cè>ğ'A' && (cè<ğ'F'))

	)

67 #ià
defšed
 (
CTYPE_NON_ASCII
)

68 
	#NON_NEGATIVE
(
c
è1

	)

70 
	#NON_NEGATIVE
(
c
è(()(cè=ğ(c))

	)

74 #undeà
ISPRINT


78 
	#ISALNUM
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`i§Êum
 (()c))

	)

79 
	#ISALPHA
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`i§Íha
 (()c))

	)

80 
	#ISDIGIT
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`isdig™
 (()c))

	)

81 
	#ISLOWER
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`i¦ow”
 (()c))

	)

82 
	#ISPRINT
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`i¥ršt
 (()c))

	)

83 
	#ISUPPER
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`isuµ”
 (()c))

	)

84 
	#ISXDIGIT
(
c
è(
	`IN_CTYPE_DOMAIN
 (cè&& 
	`isxdig™
 (()c))

	)

86 
	#_¾_low”ÿ£_p
(
c
è(
	`NON_NEGATIVE
(cè&& 
	`ISLOWER
(c))

	)

87 
	#_¾_uµ”ÿ£_p
(
c
è(
	`NON_NEGATIVE
(cè&& 
	`ISUPPER
(c))

	)

88 
	#_¾_dig™_p
(
c
è((cè>ğ'0' && (cè<ğ'9')

	)

90 
	#_¾_pu»_®phab‘ic
(
c
è(
	`NON_NEGATIVE
(cè&& 
	`ISALPHA
(c))

	)

91 
	#ALPHABETIC
(
c
è(
	`NON_NEGATIVE
(cè&& 
	`ISALNUM
(c))

	)

93 #iâdeà
_¾_to_uµ”


94 
	#_¾_to_uµ”
(
c
è(
	`_¾_low”ÿ£_p
(cè? 
	`touµ”
(()cè: (c))

	)

95 
	#_¾_to_low”
(
c
è(
	`_¾_uµ”ÿ£_p
(cè? 
	`tŞow”
(()cè: (c))

	)

98 #iâdeà
_¾_dig™_v®ue


99 
	#_¾_dig™_v®ue
(
x
è((xè- '0')

	)

102 #iâdeà
_¾_isid’t


103 
	#_¾_isid’t
(
c
è(
	`ISALNUM
(cè|| (cè=ğ'_')

	)

106 #iâdeà
ISOCTAL


107 
	#ISOCTAL
(
c
è((cè>ğ'0' && (cè<ğ'7')

	)

109 
	#OCTVALUE
(
c
è((cè- '0')

	)

111 
	#HEXVALUE
(
c
) \

112 (((
c
) >= 'a' && (c) <= 'f') \

113 ? (
c
)-'a'+10 \

114 : (
c
è>ğ'A' && (cè<ğ'F' ? (c)-'A'+10 : (c)-'0')

	)

116 #iâdeà
NEWLINE


117 
	#NEWLINE
 '\n'

	)

120 #iâdeà
RETURN


121 
	#RETURN
 
	`CTRL
('M')

	)

124 #iâdeà
RUBOUT


125 
	#RUBOUT
 0x7f

	)

128 #iâdeà
TAB


129 
	#TAB
 '\t'

	)

132 #ifdeà
ABORT_CHAR


133 #undeà
ABORT_CHAR


135 
	#ABORT_CHAR
 
	`CTRL
('G')

	)

137 #ifdeà
PAGE


138 #undeà
PAGE


140 
	#PAGE
 
	`CTRL
('L')

	)

142 #ifdeà
SPACE


143 #undeà
SPACE


145 
	#SPACE
 ' '

	)

147 #ifdeà
ESC


148 #undeà
ESC


150 
	#ESC
 
	`CTRL
('[')

	)

	@/usr/include/stdc-predef.h

18 #iâdef 
_STDC_PREDEF_H


19 
	#_STDC_PREDEF_H
 1

	)

36 #ifdeà
__GCC_IEC_559


37 #ià
__GCC_IEC_559
 > 0

38 
	#__STDC_IEC_559__
 1

	)

41 
	#__STDC_IEC_559__
 1

	)

44 #ifdeà
__GCC_IEC_559_COMPLEX


45 #ià
__GCC_IEC_559_COMPLEX
 > 0

46 
	#__STDC_IEC_559_COMPLEX__
 1

	)

49 
	#__STDC_IEC_559_COMPLEX__
 1

	)

58 
	#__STDC_ISO_10646__
 201706L

	)

61 
	#__STDC_NO_THREADS__
 1

	)

	@/usr/include/gconv.h

22 #iâdeà
_GCONV_H


23 
	#_GCONV_H
 1

	)

25 
	~<ã©u»s.h
>

26 
	~<b™s/ty³s/__mb¡©e_t.h
>

27 
	~<b™s/ty³s/wšt_t.h
>

29 
	#__Ãed_size_t


	)

30 
	#__Ãed_wch¬_t


	)

31 
	~<¡ddef.h
>

34 
	#__UNKNOWN_10646_CHAR
 ((
wch¬_t
è0xfffd)

	)

39 
	m__GCONV_OK
 = 0,

40 
	m__GCONV_NOCONV
,

41 
	m__GCONV_NODB
,

42 
	m__GCONV_NOMEM
,

44 
	m__GCONV_EMPTY_INPUT
,

45 
	m__GCONV_FULL_OUTPUT
,

46 
	m__GCONV_ILLEGAL_INPUT
,

47 
	m__GCONV_INCOMPLETE_INPUT
,

49 
	m__GCONV_ILLEGAL_DESCRIPTOR
,

50 
	m__GCONV_INTERNAL_ERROR


57 
	m__GCONV_IS_LAST
 = 0x0001,

58 
	m__GCONV_IGNORE_ERRORS
 = 0x0002,

59 
	m__GCONV_SWAP
 = 0x0004,

60 
	m__GCONV_TRANSLIT
 = 0x0008

65 
	g__gcÚv_¡•
;

66 
	g__gcÚv_¡•_d©a
;

67 
	g__gcÚv_lßded_objeù
;

71 (*
	t__gcÚv_fù
è(
	t__gcÚv_¡•
 *, 
	t__gcÚv_¡•_d©a
 *,

73 **, 
	tsize_t
 *, , );

76 
	$wšt_t
 (*
	t__gcÚv_btowc_fù
è(
	t__gcÚv_¡•
 *, );

79 (*
	t__gcÚv_š™_fù
è(
	t__gcÚv_¡•
 *);

80 (*
	t__gcÚv_’d_fù
è(
	t__gcÚv_¡•
 *);

84 
	s__gcÚv_¡•


86 
__gcÚv_lßded_objeù
 *
__shlib_hªdË
;

87 cÚ¡ *
__modÇme
;

89 
__couÁ”
;

91 *
__äom_Çme
;

92 *
__to_Çme
;

94 
__gcÚv_fù
 
__fù
;

95 
__gcÚv_btowc_fù
 
__btowc_fù
;

96 
__gcÚv_š™_fù
 
__š™_fù
;

97 
__gcÚv_’d_fù
 
__’d_fù
;

101 
__mš_Ãeded_äom
;

102 
__max_Ãeded_äom
;

103 
__mš_Ãeded_to
;

104 
__max_Ãeded_to
;

107 
__¡©eful
;

109 *
__d©a
;

114 
	s__gcÚv_¡•_d©a


116 *
__outbuf
;

117 *
__outbuãnd
;

121 
__æags
;

125 
__švoÿtiÚ_couÁ”
;

129 
__š‹º®_u£
;

131 
__mb¡©e_t
 *
__¡©•
;

132 
__mb¡©e_t
 
__¡©e
;

138 
	s__gcÚv_šfo


140 
size_t
 
__n¡•s
;

141 
__gcÚv_¡•
 *
__¡•s
;

142 
__ex‹nsiÚ__
 
__gcÚv_¡•_d©a
 
__d©a
[0];

143 } *
	t__gcÚv_t
;

146 
	`__gcÚv_Œª¦™”©e
 (
__gcÚv_¡•
 *
¡•
,

147 
__gcÚv_¡•_d©a
 *
¡•_d©a
,

148 cÚ¡ *
šbuf¡¬t
,

149 cÚ¡ **
šbuå
,

150 cÚ¡ *
šbuãnd
,

151 **
outbuf¡¬t
,

152 
size_t
 *
œ»v”sibË
);

	@
1
.
1
/usr/include
191
4174
3rd/lpeg/lpcap.c
3rd/lpeg/lpcap.h
3rd/lpeg/lpcode.c
3rd/lpeg/lpcode.h
3rd/lpeg/lpprint.c
3rd/lpeg/lpprint.h
3rd/lpeg/lptree.c
3rd/lpeg/lptree.h
3rd/lpeg/lptypes.h
3rd/lpeg/lpvm.c
3rd/lpeg/lpvm.h
3rd/lua-md5/compat-5.2.c
3rd/lua-md5/compat-5.2.h
3rd/lua-md5/md5.c
3rd/lua-md5/md5.h
3rd/lua-md5/md5lib.c
3rd/lua/lapi.c
3rd/lua/lapi.h
3rd/lua/lauxlib.c
3rd/lua/lauxlib.h
3rd/lua/lbaselib.c
3rd/lua/lbitlib.c
3rd/lua/lcode.c
3rd/lua/lcode.h
3rd/lua/lcorolib.c
3rd/lua/lctype.c
3rd/lua/lctype.h
3rd/lua/ldblib.c
3rd/lua/ldebug.c
3rd/lua/ldebug.h
3rd/lua/ldo.c
3rd/lua/ldo.h
3rd/lua/ldump.c
3rd/lua/lfunc.c
3rd/lua/lfunc.h
3rd/lua/lgc.c
3rd/lua/lgc.h
3rd/lua/linit.c
3rd/lua/liolib.c
3rd/lua/llex.c
3rd/lua/llex.h
3rd/lua/llimits.h
3rd/lua/lmathlib.c
3rd/lua/lmem.c
3rd/lua/lmem.h
3rd/lua/loadlib.c
3rd/lua/lobject.c
3rd/lua/lobject.h
3rd/lua/lopcodes.c
3rd/lua/lopcodes.h
3rd/lua/loslib.c
3rd/lua/lparser.c
3rd/lua/lparser.h
3rd/lua/lprefix.h
3rd/lua/lstate.c
3rd/lua/lstate.h
3rd/lua/lstring.c
3rd/lua/lstring.h
3rd/lua/lstrlib.c
3rd/lua/ltable.c
3rd/lua/ltable.h
3rd/lua/ltablib.c
3rd/lua/ltm.c
3rd/lua/ltm.h
3rd/lua/lua.c
3rd/lua/lua.h
3rd/lua/lua.hpp
3rd/lua/luac.c
3rd/lua/luaconf.h
3rd/lua/lualib.h
3rd/lua/lundump.c
3rd/lua/lundump.h
3rd/lua/lutf8lib.c
3rd/lua/lvm.c
3rd/lua/lvm.h
3rd/lua/lzio.c
3rd/lua/lzio.h
lualib-src/boy/crc32.c
lualib-src/boy/crc32.h
lualib-src/boy/lboy.c
lualib-src/lsha1.c
lualib-src/lua-bson.c
lualib-src/lua-clientsocket.c
lualib-src/lua-cluster.c
lualib-src/lua-crypt.c
lualib-src/lua-datasheet.c
lualib-src/lua-debugchannel.c
lualib-src/lua-memory.c
lualib-src/lua-mongo.c
lualib-src/lua-multicast.c
lualib-src/lua-mysqlaux.c
lualib-src/lua-netpack.c
lualib-src/lua-profile.c
lualib-src/lua-randseq.c
lualib-src/lua-seri.c
lualib-src/lua-seri.h
lualib-src/lua-sharedata.c
lualib-src/lua-skynet.c
lualib-src/lua-socket.c
lualib-src/lua-stm.c
lualib-src/lua_a_star.c
lualib-src/lua_a_star.h
lualib-src/sproto/lsproto.c
lualib-src/sproto/msvcint.h
lualib-src/sproto/sproto.c
lualib-src/sproto/sproto.h
lualib-src/wordfilterCpp/wordfilter.cpp
service-src/databuffer.h
service-src/hashid.h
service-src/service_gate.c
service-src/service_harbor.c
service-src/service_logger.c
service-src/service_logger_test.c
service-src/service_snlua.c
skynet-src/atomic.h
skynet-src/luashrtbl.h
skynet-src/malloc_hook.c
skynet-src/malloc_hook.h
skynet-src/rwlock.h
skynet-src/skynet.h
skynet-src/skynet_daemon.c
skynet-src/skynet_daemon.h
skynet-src/skynet_env.c
skynet-src/skynet_env.h
skynet-src/skynet_error.c
skynet-src/skynet_handle.c
skynet-src/skynet_handle.h
skynet-src/skynet_harbor.c
skynet-src/skynet_harbor.h
skynet-src/skynet_imp.h
skynet-src/skynet_log.c
skynet-src/skynet_log.h
skynet-src/skynet_main.c
skynet-src/skynet_malloc.h
skynet-src/skynet_module.c
skynet-src/skynet_module.h
skynet-src/skynet_monitor.c
skynet-src/skynet_monitor.h
skynet-src/skynet_mq.c
skynet-src/skynet_mq.h
skynet-src/skynet_server.c
skynet-src/skynet_server.h
skynet-src/skynet_socket.c
skynet-src/skynet_socket.h
skynet-src/skynet_start.c
skynet-src/skynet_timer.c
skynet-src/skynet_timer.h
skynet-src/socket_epoll.h
skynet-src/socket_kqueue.h
skynet-src/socket_poll.h
skynet-src/socket_server.c
skynet-src/socket_server.h
skynet-src/spinlock.h
/usr/include/arpa/inet.h
/usr/include/assert.h
/usr/include/ctype.h
/usr/include/dlfcn.h
/usr/include/errno.h
/usr/include/fcntl.h
/usr/include/limits.h
/usr/include/locale.h
/usr/include/math.h
/usr/include/netdb.h
/usr/include/netinet/in.h
/usr/include/netinet/tcp.h
/usr/include/pthread.h
/usr/include/readline/history.h
/usr/include/readline/readline.h
/usr/include/setjmp.h
/usr/include/signal.h
/usr/include/stdint.h
/usr/include/stdio.h
/usr/include/stdlib.h
/usr/include/string.h
/usr/include/time.h
/usr/include/unistd.h
/usr/include/alloca.h
/usr/include/endian.h
/usr/include/features.h
/usr/include/libio.h
/usr/include/readline/keymaps.h
/usr/include/readline/rlstdc.h
/usr/include/readline/rltypedefs.h
/usr/include/readline/tilde.h
/usr/include/rpc/netdb.h
/usr/include/sched.h
/usr/include/strings.h
/usr/include/_G_config.h
/usr/include/readline/chardefs.h
/usr/include/stdc-predef.h
/usr/include/gconv.h
